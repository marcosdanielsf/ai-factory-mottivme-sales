# Implementacao: Grupos e Comunidades WhatsApp

> Plano para adicionar ferramentas de grupos/comunidades ao AI Factory
> Criado em: 2026-02-01
> Baseado em: Stevo API + Guia Reducao No-Show Mottivme

---

## VISAO GERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AI FACTORY WORKFLOW                               â”‚
â”‚              (https://cliente-a1.mentorfy.io/workflow/...)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      AI AGENT (Gemini/Groq)                       â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚   prompt_template â†â”€â”€â”€â”€ Supabase (agent_templates)               â”‚   â”‚
â”‚  â”‚   tools â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Nodes conectados ao agente             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                          â”‚
â”‚                    Tools disponiveis:                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ [EXISTENTES]                  â”‚ [NOVAS - GRUPOS]                  â”‚  â”‚
â”‚   â”‚ - Adicionar_tag_perdido       â”‚ - Criar_grupo_whatsapp           â”‚  â”‚
â”‚   â”‚ - Atualizar_contato           â”‚ - Adicionar_participante_grupo   â”‚  â”‚
â”‚   â”‚ - Enviar_mensagem             â”‚ - Convidar_comunidade            â”‚  â”‚
â”‚   â”‚ - Listar_arquivos             â”‚ - Fazer_chamada_whatsapp (Z-API) â”‚  â”‚
â”‚   â”‚ - Agendar_followup            â”‚ - Enviar_mensagem_grupo          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GATEWAY WHATSAPP                                  â”‚
â”‚                   (Socialfy Nexus / Stevo / GHL)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /group/create        â”‚ POST /community/create                      â”‚
â”‚ POST /group/participant   â”‚ POST /send-call (Z-API)                    â”‚
â”‚ POST /send-text (grupo)   â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CASO DE USO 1: REDUCAO DE NO-SHOW

### Fluxo Atual (Manual)
```
1. SDR qualifica lead
2. SDR agenda call com Closer
3. SDR cria grupo manualmente "Consultoria 18h - Nome"
4. SDR adiciona Lead + Closer ao grupo
5. SDR envia materiais de nutricao
6. SDR faz reminder D-1 e D0
```

### Fluxo Automatizado (Com Tools)
```
1. SDR qualifica lead
2. SDR agenda call com Closer
3. IA detecta agendamento â†’ usa tool Criar_grupo_whatsapp
4. IA â†’ usa tool Adicionar_participante_grupo (Lead + Closer)
5. IA envia mensagem de apresentacao no grupo
6. IA envia materiais de nutricao
7. IA programa reminders D-1 e D0
8. Se no-show â†’ IA tenta ligacao via Fazer_chamada_whatsapp
```

---

## CASO DE USO 2: COMUNIDADE DE NUTRICAO

### Fluxo
```
1. Lead frio (nao qualificado ou sem interesse agora)
2. IA oferece: "Posso te adicionar em nossa comunidade exclusiva?"
3. Se aceitar â†’ usa tool Convidar_comunidade
4. Lead recebe conteudo gratuito automatico
5. Todo mes: IA convida para webinario ao vivo
6. Lead reengajado â†’ volta pro funil de qualificacao
```

---

## NOVAS TOOLS (Nodes n8n)

### 1. Criar_grupo_whatsapp

```json
{
  "parameters": {
    "toolDescription": "Cria grupo de WhatsApp para handoff SDRâ†’Closer. Use SEMPRE que agendar uma call de apresentacao. O nome do grupo deve seguir o padrao: 'Consultoria {horario} - {nome_lead}'",
    "method": "POST",
    "url": "={{$env.WHATSAPP_GATEWAY_URL}}/group/create",
    "sendHeaders": true,
    "parametersHeaders": {
      "values": [
        {
          "name": "Authorization",
          "valueProvider": "fieldValue",
          "value": "=Bearer {{$env.WHATSAPP_GATEWAY_TOKEN}}"
        },
        {
          "name": "Content-Type",
          "valueProvider": "fieldValue",
          "value": "application/json"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={\n  \"groupName\": \"{group_name}\",\n  \"participants\": [\"{lead_phone}\", \"{closer_phone}\"]\n}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "group_name",
          "description": "Nome do grupo no formato 'Consultoria 18h - Nome'",
          "type": "string"
        },
        {
          "name": "lead_phone",
          "description": "Telefone do lead com DDI (ex: 5511999999999)",
          "type": "string"
        },
        {
          "name": "closer_phone",
          "description": "Telefone do closer com DDI",
          "type": "string"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1.1,
  "name": "Criar_grupo_whatsapp"
}
```

### 2. Adicionar_participante_grupo

```json
{
  "parameters": {
    "toolDescription": "Adiciona um participante a um grupo WhatsApp existente. Use para adicionar o Closer ou outros participantes ao grupo da call.",
    "method": "POST",
    "url": "={{$env.WHATSAPP_GATEWAY_URL}}/group/participant",
    "sendHeaders": true,
    "parametersHeaders": {
      "values": [
        {
          "name": "Authorization",
          "valueProvider": "fieldValue",
          "value": "=Bearer {{$env.WHATSAPP_GATEWAY_TOKEN}}"
        },
        {
          "name": "Content-Type",
          "valueProvider": "fieldValue",
          "value": "application/json"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={\n  \"groupJid\": \"{group_jid}\",\n  \"participants\": [\"{phone}\"],\n  \"action\": \"add\"\n}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "group_jid",
          "description": "JID do grupo (retornado ao criar o grupo)",
          "type": "string"
        },
        {
          "name": "phone",
          "description": "Telefone do participante com DDI",
          "type": "string"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1.1,
  "name": "Adicionar_participante_grupo"
}
```

### 3. Enviar_mensagem_grupo

```json
{
  "parameters": {
    "toolDescription": "Envia mensagem para um grupo WhatsApp. Use para enviar apresentacoes, materiais de nutricao, lembretes D-1 e D0.",
    "method": "POST",
    "url": "={{$env.WHATSAPP_GATEWAY_URL}}/send/text",
    "sendHeaders": true,
    "parametersHeaders": {
      "values": [
        {
          "name": "Authorization",
          "valueProvider": "fieldValue",
          "value": "=Bearer {{$env.WHATSAPP_GATEWAY_TOKEN}}"
        },
        {
          "name": "Content-Type",
          "valueProvider": "fieldValue",
          "value": "application/json"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={\n  \"to\": \"{group_jid}\",\n  \"text\": \"{message}\"\n}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "group_jid",
          "description": "JID do grupo (formato: 120363xxx@g.us)",
          "type": "string"
        },
        {
          "name": "message",
          "description": "Mensagem a ser enviada",
          "type": "string"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1.1,
  "name": "Enviar_mensagem_grupo"
}
```

### 4. Convidar_comunidade

```json
{
  "parameters": {
    "toolDescription": "Envia convite para a comunidade de nutricao. Use quando o lead nao estiver pronto para comprar agora mas demonstrar interesse em conteudo gratuito.",
    "method": "POST",
    "url": "={{$env.WHATSAPP_GATEWAY_URL}}/send/text",
    "sendHeaders": true,
    "parametersHeaders": {
      "values": [
        {
          "name": "Authorization",
          "valueProvider": "fieldValue",
          "value": "=Bearer {{$env.WHATSAPP_GATEWAY_TOKEN}}"
        },
        {
          "name": "Content-Type",
          "valueProvider": "fieldValue",
          "value": "application/json"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={\n  \"to\": \"{lead_phone}\",\n  \"text\": \"{{$env.COMMUNITY_INVITE_MESSAGE}}\\n\\n{{$env.COMMUNITY_LINK}}\"\n}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "lead_phone",
          "description": "Telefone do lead com DDI",
          "type": "string"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1.1,
  "name": "Convidar_comunidade"
}
```

### 5. Fazer_chamada_whatsapp (Z-API)

```json
{
  "parameters": {
    "toolDescription": "Faz ligacao WhatsApp para o lead. Use em situacoes URGENTES: no-show na call, confirmacao de agendamento, ou quando o lead pediu ligacao. A ligacao toca por 10 segundos.",
    "method": "POST",
    "url": "=https://api.z-api.io/instances/{{$env.ZAPI_INSTANCE}}/token/{{$env.ZAPI_TOKEN}}/send-call",
    "sendHeaders": true,
    "parametersHeaders": {
      "values": [
        {
          "name": "Client-Token",
          "valueProvider": "fieldValue",
          "value": "={{$env.ZAPI_CLIENT_TOKEN}}"
        },
        {
          "name": "Content-Type",
          "valueProvider": "fieldValue",
          "value": "application/json"
        }
      ]
    },
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={\n  \"phone\": \"{phone}\",\n  \"callDuration\": 10\n}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "phone",
          "description": "Telefone do lead com DDI (ex: 5511999999999)",
          "type": "string"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1.1,
  "name": "Fazer_chamada_whatsapp"
}
```

---

## ATUALIZACAO DO PROMPT: SCHEDULER

Adicionar ao prompt do modo `scheduler` em `agent_templates`:

```markdown
## PROCESSO DE REDUCAO DE NO-SHOW

### Ao Agendar Call:
1. Confirmar horario com lead
2. Validar email do lead
3. Perguntar: "Existe algo que possa te impedir de participar nesse horario?"
4. USAR TOOL: Criar_grupo_whatsapp
   - Nome: "Consultoria {horario} - {nome_lead}"
   - Participantes: Lead + Closer configurado

### Mensagem de Apresentacao no Grupo:
> Ola {nome_lead}! Criei este grupo para facilitar nossa comunicacao.
> O {nome_closer} sera seu consultor na apresentacao de amanha.
> Confirmado: {data}, {horario} (Brasilia)
> Qualquer duvida, estamos aqui!

### Envio de Materiais (Apos criar grupo):
> Vou compartilhar alguns materiais rapidos para voce chegar ainda mais preparado:
> - [Link Case 1]
> - [Link Case 2]
> - [Link Historia]

### Reminder D-1 (Dia anterior):
> Fala {nome_lead}! Passando para lembrar nossa consultoria amanha, {horario}.
> Tudo certo por ai?

### Reminder D0 (Dia da call, pela manha):
> Bom dia {nome_lead}! Hoje as {horario} e nossa conversa.
> O {nome_closer} vai mandar o link aqui no grupo.

### Sem Resposta (Falta de confirmacao):
> {nome_lead}, tentamos contato para confirmar mas nao tivemos retorno.
> Para respeitar nossa fila, vou liberar seu horario.
> Prefere confirmar para o slot das {horario} ou reagendamos mais adiante?

### No-Show (Lead nao aparece):
1. Closer manda mensagem no grupo: "Ja estou na sala. Link aqui"
2. Apos 3 minutos sem lead: USAR TOOL Fazer_chamada_whatsapp (3 tentativas)
3. Se nao atender: Mensagem de reagendamento
```

---

## NOVO MODO: COMMUNITY_NURTURE

Criar novo template em `agent_templates`:

```sql
INSERT INTO agent_templates (
  mode_name,
  display_name,
  category,
  priority,
  description,
  prompt_template,
  tools_template,
  target_metrics
) VALUES (
  'community_nurture',
  'Community Nurture',
  'nurture',
  'P1',
  'Nutre leads frios atraves de comunidade WhatsApp com conteudo gratuito e lancamentos mensais',
  '# MODO: COMMUNITY NURTURE

<Role>
Voce e {{agent_name}}, especialista em nutricao de comunidade.
Tom: Amigavel, educativo, sem pressao de venda
Proposito: Manter leads engajados ate estarem prontos para comprar
</Role>

<Constraints>
- NUNCA pressionar para venda
- Maximo 1 contato por semana fora da comunidade
- Conteudo deve ser genuinamente util
- Respeitar se lead pedir para sair
</Constraints>

<Instructions>
1. Quando lead nao esta pronto â†’ USAR TOOL: Convidar_comunidade
2. Na comunidade, enviar conteudo semanalmente
3. Mensalmente, fazer convite para webinario ao vivo
4. Se lead engajar forte â†’ oferecer call com especialista
5. Monitorar sinais de compra e requalificar
</Instructions>

<Tools_Available>
- Convidar_comunidade: Envia link de convite
- Enviar_mensagem_grupo: Posta conteudo na comunidade
- Agendar_followup: Programa proximo contato
</Tools_Available>

<Webinar_Script>
> ðŸ”´ WEBINARIO AO VIVO AMANHA!
>
> {{nome_lead}}, amanha {{data}} as {{horario}} vou revelar ao vivo:
> - [Topico 1]
> - [Topico 2]
> - [Topico 3]
>
> E voce ainda pode tirar suas duvidas em tempo real.
>
> Quer garantir sua vaga? Responde "QUERO" aqui!
</Webinar_Script>

<Conclusions>
- Objetivo: esquentar lead ate estar pronto
- Metricas: engajamento, presenca webinario, requalificacao
</Conclusions>',
  '{"tools": ["Convidar_comunidade", "Enviar_mensagem_grupo", "Agendar_followup"]}',
  '{"taxa_entrada_comunidade": "60%+", "taxa_presenca_webinario": "30%+", "taxa_requalificacao": "20%+"}'
);
```

---

## VARIAVEIS DE AMBIENTE NECESSARIAS

```bash
# Gateway WhatsApp (Stevo/Baileys/Socialfy Nexus)
WHATSAPP_GATEWAY_URL=https://seu-gateway.railway.app
WHATSAPP_GATEWAY_TOKEN=seu-token

# Z-API (para chamadas)
ZAPI_INSTANCE=seu-instance-id
ZAPI_TOKEN=seu-token
ZAPI_CLIENT_TOKEN=seu-client-token

# Comunidade
COMMUNITY_LINK=https://chat.whatsapp.com/xxx
COMMUNITY_INVITE_MESSAGE=Participe da nossa comunidade exclusiva com conteudo gratuito toda semana!

# Closers disponiveis (JSON)
CLOSERS_CONFIG={"default": {"nome": "Marcos", "phone": "5511999999999"}}
```

---

## MIGRATION SQL

```sql
-- 019_whatsapp_groups_tools.sql
-- Adiciona suporte a grupos e comunidades WhatsApp

-- 1. Tabela para rastrear grupos criados
CREATE TABLE IF NOT EXISTS whatsapp_groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  location_id TEXT NOT NULL,
  group_jid TEXT UNIQUE NOT NULL,
  group_name TEXT NOT NULL,
  purpose TEXT NOT NULL, -- 'call_handoff', 'community', 'support'
  lead_id TEXT,
  closer_id TEXT,
  appointment_id TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  archived_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'
);

-- 2. Tabela para membros da comunidade
CREATE TABLE IF NOT EXISTS community_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  location_id TEXT NOT NULL,
  lead_id TEXT NOT NULL,
  community_jid TEXT NOT NULL,
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  source TEXT, -- 'nurture', 'webinar', 'follow_up'
  status TEXT DEFAULT 'active', -- 'active', 'left', 'removed'
  engagement_score INTEGER DEFAULT 0,
  last_webinar_attended TIMESTAMPTZ,
  UNIQUE(lead_id, community_jid)
);

-- 3. Tabela para log de chamadas WhatsApp
CREATE TABLE IF NOT EXISTS whatsapp_call_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  location_id TEXT NOT NULL,
  lead_id TEXT NOT NULL,
  phone TEXT NOT NULL,
  direction TEXT NOT NULL, -- 'outbound', 'inbound'
  purpose TEXT, -- 'no_show', 'confirmation', 'follow_up'
  provider TEXT DEFAULT 'zapi', -- 'zapi', 'twilio'
  status TEXT, -- 'initiated', 'answered', 'missed', 'failed'
  call_id TEXT,
  duration_seconds INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'
);

-- 4. Indices
CREATE INDEX idx_whatsapp_groups_location ON whatsapp_groups(location_id);
CREATE INDEX idx_whatsapp_groups_lead ON whatsapp_groups(lead_id);
CREATE INDEX idx_community_members_location ON community_members(location_id);
CREATE INDEX idx_community_members_status ON community_members(status);
CREATE INDEX idx_whatsapp_call_logs_lead ON whatsapp_call_logs(lead_id);
CREATE INDEX idx_whatsapp_call_logs_created ON whatsapp_call_logs(created_at);

-- 5. Atualizar tools_template do modo scheduler
UPDATE agent_templates
SET tools_template = '{"tools": ["Verificar_disponibilidade", "Agendar_reuniao", "Enviar_lembrete", "Criar_grupo_whatsapp", "Adicionar_participante_grupo", "Enviar_mensagem_grupo", "Fazer_chamada_whatsapp"]}'
WHERE mode_name = 'scheduler';

-- 6. Funcao helper: buscar closer disponivel
CREATE OR REPLACE FUNCTION get_available_closer(p_location_id TEXT, p_datetime TIMESTAMPTZ)
RETURNS JSONB AS $$
DECLARE
  v_closer JSONB;
BEGIN
  -- Por enquanto retorna o closer padrao
  -- Futuramente: verificar agenda, rotacao, etc.
  SELECT jsonb_build_object(
    'id', u.id,
    'name', u.name,
    'phone', u.phone
  ) INTO v_closer
  FROM socialfy_users u
  WHERE u.location_id = p_location_id
    AND u.role = 'closer'
    AND u.is_active = true
  LIMIT 1;

  RETURN COALESCE(v_closer, '{"id": null, "name": "Consultor", "phone": null}'::jsonb);
END;
$$ LANGUAGE plpgsql;

-- 7. Funcao helper: registrar grupo criado
CREATE OR REPLACE FUNCTION register_whatsapp_group(
  p_location_id TEXT,
  p_group_jid TEXT,
  p_group_name TEXT,
  p_purpose TEXT,
  p_lead_id TEXT DEFAULT NULL,
  p_closer_id TEXT DEFAULT NULL,
  p_appointment_id TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  v_id UUID;
BEGIN
  INSERT INTO whatsapp_groups (
    location_id, group_jid, group_name, purpose,
    lead_id, closer_id, appointment_id
  ) VALUES (
    p_location_id, p_group_jid, p_group_name, p_purpose,
    p_lead_id, p_closer_id, p_appointment_id
  )
  RETURNING id INTO v_id;

  RETURN v_id;
END;
$$ LANGUAGE plpgsql;

COMMENT ON TABLE whatsapp_groups IS 'Grupos WhatsApp criados para handoff SDRâ†’Closer';
COMMENT ON TABLE community_members IS 'Membros das comunidades de nutricao';
COMMENT ON TABLE whatsapp_call_logs IS 'Log de chamadas WhatsApp via Z-API';
```

---

## CHECKLIST DE IMPLEMENTACAO

### Fase 1: Infraestrutura (1 dia)
- [ ] Executar migration SQL no Supabase
- [ ] Configurar variaveis de ambiente no n8n
- [ ] Testar conexao com gateway WhatsApp

### Fase 2: Tools (1 dia)
- [ ] Importar nodes de tools no workflow principal
- [ ] Conectar tools ao AI Agent
- [ ] Testar cada tool individualmente

### Fase 3: Prompts (0.5 dia)
- [ ] Atualizar prompt do modo `scheduler`
- [ ] Inserir novo modo `community_nurture`
- [ ] Testar fluxo completo de agendamento

### Fase 4: Z-API (0.5 dia)
- [ ] Criar conta Z-API (trial 2 dias)
- [ ] Configurar credenciais
- [ ] Testar chamada outbound

### Fase 5: Testes E2E (1 dia)
- [ ] Testar criacao de grupo ao agendar
- [ ] Testar envio de materiais no grupo
- [ ] Testar reminder D-1 e D0
- [ ] Testar chamada no-show

**TOTAL: ~4 dias de desenvolvimento**

---

## PROXIMOS PASSOS

1. Validar arquitetura com Marcos
2. Escolher gateway WhatsApp (Stevo vs Baileys vs outro)
3. Criar conta Z-API para chamadas
4. Implementar fase por fase

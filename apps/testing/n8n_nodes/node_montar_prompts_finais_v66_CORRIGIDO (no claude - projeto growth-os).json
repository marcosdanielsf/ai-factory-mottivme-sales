{
  "parameters": {
    "mode": "runOnceForEachItem",
    "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// MONTAR PROMPTS FINAIS v6.6 - VERSÃO SUPABASE (CORRIGIDO)\n// Pega prompts modulares do campo prompts_by_mode do Supabase\n// CORREÇÃO: Removido \"Isabella\" hardcoded - usa agent_name dinâmico\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FUNÇÃO PARA SUBSTITUIR VARIÁVEIS MUSTACHE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction replaceVars(template, vars) {\n  if (!template) return '';\n  let result = template;\n\n  for (const [key, value] of Object.entries(vars)) {\n    const pattern = new RegExp(`\\\\{\\\\{\\\\s*${key}\\\\s*\\\\}\\\\}`, 'g');\n    result = result.replace(pattern, value || '');\n  }\n\n  return result;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// VARIÁVEIS PARA SUBSTITUIÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nconst variaveis = {\n  modo_agente: prev.agent_type || 'sdr_inbound',\n  source: prev.source || 'instagram',\n  full_name: prev.full_name || 'Visitante',\n  timezone: 'America/Sao_Paulo',\n  agente: prev.agent_name || 'Agente',\n  data_hora: prev.data_hora,\n  status_pagamento: prev.status_pagamento || 'nenhum',\n  preferencia_audio_texto: prev.preferencia_audio_texto || 'texto'\n};\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETECTAR MODO ATIVO (agente_ia)\n// ─────────────────────────────────────────────────────────────────────────────\nconst modoAtivo = prev.agente_ia || prev.agent_type || 'sdr_inbound';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PEGAR PROMPTS DO SUPABASE (prompts_by_mode)\n// ─────────────────────────────────────────────────────────────────────────────\nconst promptsDoAgente = prev.prompts_by_mode || {};\n\n// Normalizar o modo para encontrar no JSON\nfunction normalizarModo(modo) {\n  const modoLower = (modo || '').toLowerCase().trim();\n\n  // Mapeamento de aliases\n  const aliases = {\n    'sdr': 'sdr_inbound',\n    'inbound': 'sdr_inbound',\n    'social_seller': 'social_seller_instagram',\n    'instagram': 'social_seller_instagram',\n    'agendamento': 'scheduler',\n    'followup': 'followuper',\n    'objecao': 'objection_handler',\n    'objecoes': 'objection_handler',\n    'reativador': 'reativador_base'\n  };\n\n  return aliases[modoLower] || modoLower;\n}\n\nconst modoNormalizado = normalizarModo(modoAtivo);\n\n// Pegar o prompt do modo ativo (ou fallback para sdr_inbound)\nconst promptModoAtivo = promptsDoAgente[modoNormalizado]\n  || promptsDoAgente['sdr_inbound']\n  || '';\n\n// Prompt base vem do system_prompt do agente\nconst promptBase = prev.system_prompt || '';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR SYSTEM PROMPT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nlet systemPrompt = promptBase + '\\n\\n' + promptModoAtivo;\n\n// Substituir variáveis\nsystemPrompt = replaceVars(systemPrompt, variaveis);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// REGRA DINÂMICA DE SAUDAÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nlet regraSaudacao = '';\nconst hora = prev.hora_numero;\nconst historicoExiste = prev.historico_existe;\n\nif (!historicoExiste) {\n  if (hora >= 5 && hora < 12) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \\\"Bom dia\\\" de forma calorosa.\\n</regra_saudacao>';\n  } else if (hora >= 12 && hora < 18) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \\\"Boa tarde\\\" de forma calorosa.\\n</regra_saudacao>';\n  } else {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \\\"Boa noite\\\" de forma calorosa.\\n</regra_saudacao>';\n  }\n} else {\n  regraSaudacao = '\\n\\n<regra_saudacao>\\nConversa já iniciada. NÃO repita saudação. Continue naturalmente.\\n</regra_saudacao>';\n}\n\nsystemPrompt += regraSaudacao;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR BLOCO DE RESPOSTAS DO FORMULÁRIO DE TRÁFEGO\n// ─────────────────────────────────────────────────────────────────────────────\nlet blocoFormularioTrafego = '';\nconst form = prev.formulario_trafego || {};\nconst isLeadTrafego = prev.is_lead_trafego || false;\n\nif (isLeadTrafego) {\n  const linhas = [];\n  if (form.origem_campanha) linhas.push(`VEIO POR CAMPANHA: ${form.origem_campanha}`);\n  if (form.procurou_ajuda) linhas.push(`PROCUROU AJUDA ANTES: ${form.procurou_ajuda}`);\n  if (form.sintomas_atuais) linhas.push(`SINTOMAS ATUAIS: ${form.sintomas_atuais}`);\n  if (form.mudanca_corpo) linhas.push(`MUDANÇA NO CORPO: ${form.mudanca_corpo}`);\n  if (form.preferencia_consulta) linhas.push(`PREFERÊNCIA CONSULTA: ${form.preferencia_consulta}`);\n  if (form.pronto_investir) linhas.push(`PRONTO PRA INVESTIR: ${form.pronto_investir}`);\n\n  if (linhas.length > 0) {\n    blocoFormularioTrafego = `\\n<respostas_formulario_trafego>\\n${linhas.join('\\n')}\\n</respostas_formulario_trafego>\\n`;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR USER PROMPT\n// ─────────────────────────────────────────────────────────────────────────────\nconst etiquetasStr = Array.isArray(prev.etiquetas)\n  ? prev.etiquetas.join(', ')\n  : (prev.etiquetas || 'nenhuma');\n\nlet userPrompt = `\\n<contexto_conversa>\\nLEAD: ${prev.full_name}\\nCANAL: ${prev.source}\\nDDD: ${prev.ddd || 'não identificado'}\\nDATA/HORA: ${prev.data_hora}\\nETIQUETAS: ${etiquetasStr}\\nSTATUS PAGAMENTO: ${prev.status_pagamento}\\nMODO ATIVO: ${modoAtivo}\\n</contexto_conversa>\\n`;\n\nif (blocoFormularioTrafego) {\n  userPrompt += blocoFormularioTrafego;\n}\n\nuserPrompt += `\\n<hiperpersonalizacao>\\n${prev.contexto_hiperpersonalizado}\\n</hiperpersonalizacao>\\n\\n<calendarios_disponiveis>\\n${prev.calendarios_formatados}\\n\\n${prev.agendamento_info}\\n</calendarios_disponiveis>\\n`;\n\nif (prev.historico_formatado) {\n  userPrompt += `\\n<historico_conversa>\\n${prev.historico_formatado}\\n</historico_conversa>\\n`;\n}\n\nuserPrompt += `\\n<mensagem_atual>\\nLEAD: ${prev.message}\\n</mensagem_atual>\\n\\nResponda à mensagem acima como ${variaveis.agente}, seguindo as instruções do MODO ATIVO: ${modoAtivo}.`;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n\n    // Metadados para debug\n    _meta: {\n      agent_name: prev.agent_name || 'Agente',\n      agent_version: prev.version || 'v6.6',\n      modo_ativo: modoAtivo,\n      modo_normalizado: modoNormalizado,\n      prompt_modo_encontrado: !!promptsDoAgente[modoNormalizado],\n      contact_id: prev.contact_id,\n      conversation_id: prev.conversation_id,\n      historico_mensagens: prev.historico_existe ? 'sim' : 'não',\n      hora_execucao: prev.data_hora,\n      is_lead_trafego: isLeadTrafego,\n      prompt_size: systemPrompt.length,\n      modos_disponiveis: Object.keys(promptsDoAgente)\n    }\n  }\n};"
  },
  "id": "73fc7017-720e-4955-876e-a50909952266",
  "name": "Montar Prompts Finais1",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    37520,
    27776
  ]
}

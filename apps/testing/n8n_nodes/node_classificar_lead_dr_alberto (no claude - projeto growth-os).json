{
  "parameters": {
    "mode": "runOnceForEachItem",
    "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// CLASSIFICADOR DE LEAD - DR. ALBERTO CORREIA\n// Detecta se é MÉDICO (B2B) ou PACIENTE (B2C) e seta o modo correto\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS DO LEAD\n// ─────────────────────────────────────────────────────────────────────────────\nconst mensagem = (prev.message || prev.body?.message || '').toLowerCase();\nconst nome = (prev.full_name || prev.body?.full_name || '').toLowerCase();\nconst email = (prev.email || prev.body?.email || '').toLowerCase();\nconst bio = (prev.bio || prev.body?.customData?.bio || '').toLowerCase();\nconst tags = prev.tags || prev.body?.tags || [];\nconst source = (prev.source || prev.body?.source || '').toLowerCase();\nconst customData = prev.body?.customData || prev.customData || {};\n\n// Modo atual (pode vir do GHL ou ser vazio)\nconst modoAtual = customData.agente_ia || customData.agente_IA || '';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// INDICADORES DE MÉDICO (B2B)\n// ─────────────────────────────────────────────────────────────────────────────\nconst indicadoresMedico = [\n  // Títulos\n  'dr.', 'dr ', 'dra.', 'dra ', 'doutor', 'doutora',\n  // Especialidades\n  'médico', 'medico', 'médica', 'medica',\n  'dermatologista', 'tricologista', 'cardiologista',\n  'clínico geral', 'clinico geral', 'cirurgião', 'cirurgiao',\n  // Registros\n  'crm', 'crm-', 'crm/',\n  // Termos profissionais\n  'consultório', 'consultorio', 'atendo paciente', 'meus pacientes',\n  'minha clínica', 'minha clinica', 'sou médico', 'sou medico',\n  'trabalho com', 'atuo na área', 'atuo na area',\n  'especialização', 'especializacao', 'residência', 'residencia',\n  // Interesse em formação/mentoria\n  'mentoria', 'curso', 'formação', 'formacao', 'aprender o método',\n  'quero aprender', 'me especializar', 'migrar de área',\n  'diversificar', 'ampliar atuação', 'ampliar atuacao',\n  // Perguntas de médico\n  'como funciona o método', 'tricomind', 'trichotest',\n  'protocolo', 'interpretar teste', 'genética capilar'\n];\n\n// ─────────────────────────────────────────────────────────────────────────────\n// INDICADORES DE PACIENTE (B2C)\n// ─────────────────────────────────────────────────────────────────────────────\nconst indicadoresPaciente = [\n  // Sintomas/Problemas\n  'queda de cabelo', 'caindo cabelo', 'calvície', 'calvicie',\n  'estou perdendo cabelo', 'meu cabelo', 'minha queda',\n  'entradas', 'raleando', 'afinando',\n  // Interesse em tratamento pessoal\n  'tratamento', 'tratar', 'consulta', 'avaliação', 'avaliacao',\n  'videoconsulta', 'atende', 'agendar',\n  // Perguntas de paciente\n  'quanto custa', 'valor', 'preço', 'preco', 'convênio', 'convenio',\n  'transplante', 'minoxidil', 'finasterida',\n  'funciona pra mim', 'meu caso', 'tenho chance',\n  // Localização\n  'atende em', 'onde fica', 'presencial', 'online'\n];\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FUNÇÃO DE DETECÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nfunction detectarTipoLead() {\n  // Combinar todos os textos para análise\n  const textoCompleto = `${nome} ${email} ${bio} ${mensagem}`.toLowerCase();\n  \n  let scoreMedico = 0;\n  let scorePaciente = 0;\n  const matchesMedico = [];\n  const matchesPaciente = [];\n  \n  // Verificar indicadores de médico\n  for (const termo of indicadoresMedico) {\n    if (textoCompleto.includes(termo)) {\n      scoreMedico++;\n      matchesMedico.push(termo);\n    }\n  }\n  \n  // Verificar indicadores de paciente\n  for (const termo of indicadoresPaciente) {\n    if (textoCompleto.includes(termo)) {\n      scorePaciente++;\n      matchesPaciente.push(termo);\n    }\n  }\n  \n  // Verificar tags do GHL\n  const tagsLower = tags.map(t => t.toLowerCase());\n  if (tagsLower.some(t => t.includes('médico') || t.includes('medico') || t.includes('b2b'))) {\n    scoreMedico += 3; // Tags têm peso maior\n    matchesMedico.push('tag:médico');\n  }\n  if (tagsLower.some(t => t.includes('paciente') || t.includes('b2c') || t.includes('lead'))) {\n    scorePaciente += 3;\n    matchesPaciente.push('tag:paciente');\n  }\n  \n  // Verificar email profissional\n  if (email.includes('.med.br') || email.includes('clinica') || email.includes('consultorio')) {\n    scoreMedico += 2;\n    matchesMedico.push('email:profissional');\n  }\n  \n  // Nome com título\n  if (nome.match(/^dr\\.?\\s|^dra\\.?\\s/i)) {\n    scoreMedico += 3;\n    matchesMedico.push('nome:titulo');\n  }\n  \n  return {\n    scoreMedico,\n    scorePaciente,\n    matchesMedico,\n    matchesPaciente,\n    tipo: scoreMedico > scorePaciente ? 'medico' : 'paciente',\n    confianca: Math.abs(scoreMedico - scorePaciente) >= 2 ? 'alta' : 'baixa'\n  };\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETERMINAR MODO\n// ─────────────────────────────────────────────────────────────────────────────\nfunction determinarModo(deteccao, modoAtual, source) {\n  // Se já tem modo definido manualmente, respeitar\n  if (modoAtual && modoAtual !== '') {\n    return modoAtual;\n  }\n  \n  const tipoLead = deteccao.tipo;\n  \n  // Mapeamento baseado no tipo de lead e origem\n  if (tipoLead === 'medico') {\n    // B2B - Médicos (persona Dr. Alberto)\n    if (source.includes('instagram') || source.includes('dm')) {\n      return 'social_seller_medicos';\n    }\n    // Default para médicos\n    return 'sdr_inbound_medicos';\n  } else {\n    // B2C - Pacientes (persona Larissa)\n    if (source.includes('instagram') || source.includes('dm')) {\n      return 'atendimento_paciente';\n    }\n    // Default para pacientes\n    return 'sdr_inbound_paciente';\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// EXECUTAR DETECÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nconst deteccao = detectarTipoLead();\nconst modoDefinido = determinarModo(deteccao, modoAtual, source);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    // Passar todos os dados originais\n    ...prev,\n    \n    // Adicionar/sobrescrever campos de classificação\n    tipo_lead: deteccao.tipo,\n    agente_ia: modoDefinido,\n    \n    // Metadados de classificação\n    _classificacao: {\n      tipo: deteccao.tipo,\n      modo_definido: modoDefinido,\n      score_medico: deteccao.scoreMedico,\n      score_paciente: deteccao.scorePaciente,\n      matches_medico: deteccao.matchesMedico,\n      matches_paciente: deteccao.matchesPaciente,\n      confianca: deteccao.confianca,\n      modo_original: modoAtual || 'nenhum',\n      calendario: deteccao.tipo === 'medico' \n        ? 'Nwc3Wp6nSGMJTcXT2K3a' // Jean Pierre\n        : 'Zsns6kXBQuBMZBLwhZpC'  // Dr. Alberto\n    }\n  }\n};"
  },
  "id": "classificar-lead-dr-alberto",
  "name": "Classificar Lead (Médico/Paciente)",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [0, 0],
  "notes": "Node para classificar leads do Dr. Alberto Correia.\n\nDetecta automaticamente:\n- MÉDICO (B2B) → Modos *_medicos (persona Dr. Alberto)\n- PACIENTE (B2C) → Modos *_paciente (persona Larissa)\n\nColocar ANTES do node 'Preparar Execução'."
}

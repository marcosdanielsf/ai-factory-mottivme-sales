{
  "parameters": {
    "mode": "runOnceForEachItem",
    "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// PREPARAR EXECUÇÃO + IDENTIFICAR CONTEXTO v6.6 - VERSÃO SUPABASE\n// Passa prompts_by_mode do Supabase para o próximo nó\n// ═══════════════════════════════════════════════════════════════════════════\n\n// Pegar dados do agente (vem do node anterior - Buscar Agente Ativo)\nconst agent = $input.item.json;\n\n// Pegar dados das mensagens dos nodes Set mensagens\nconst mensagens = $('Set mensagens2').first().json;\nconst setMensagens = $('Set mensagens').first().json;\n\n// Pegar customData do webhook original\nconst customData = $('Mensagem recebida').first().json.body?.customData || {};\n\n// Pegar agente_ia direto do Info (fonte mais confiável)\nconst infoData = $('Info').first().json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSE SEGURO DE JSON\n// ─────────────────────────────────────────────────────────────────────────────\nfunction safeParseJSON(value, fallback = {}) {\n  if (!value) return fallback;\n  if (typeof value === 'object') return value;\n  try {\n    return JSON.parse(value);\n  } catch (e) {\n    console.log('Erro parsing JSON:', e.message);\n    return fallback;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// EXTRAIR DDD DO TELEFONE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction extrairDDD(telefone) {\n  if (!telefone) return null;\n  const limpo = telefone.replace(/\\D/g, '');\n\n  if (limpo.startsWith('55') && limpo.length >= 12) {\n    return limpo.substring(2, 4);\n  }\n  if (limpo.length >= 10 && limpo.length <= 11) {\n    return limpo.substring(0, 2);\n  }\n  return null;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETERMINAR PERÍODO DO DIA\n// ─────────────────────────────────────────────────────────────────────────────\nfunction getPeriodoHorario() {\n  const agora = new Date();\n  const hora = agora.getHours();\n\n  if (hora >= 5 && hora < 12) return 'manha';\n  if (hora >= 12 && hora < 18) return 'tarde';\n  return 'noite';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// GERAR CONTEXTO HIPERPERSONALIZADO\n// ─────────────────────────────────────────────────────────────────────────────\nfunction gerarContextoHiperpersonalizado(ddd, periodo, hyperConfig) {\n  const contextos = [];\n\n  if (hyperConfig.personalizacao_por_ddd && ddd) {\n    const dddConfig = hyperConfig.personalizacao_por_ddd[ddd];\n    if (dddConfig) {\n      contextos.push(`[REGIÃO ${ddd}] ${dddConfig.contexto || ''}`);\n      if (dddConfig.unidade_proxima) {\n        contextos.push(`Unidade mais próxima: ${dddConfig.unidade_proxima}`);\n      }\n    }\n  }\n\n  if (hyperConfig.saudacoes_por_horario) {\n    const saudacao = hyperConfig.saudacoes_por_horario[periodo];\n    if (saudacao) {\n      contextos.push(`Saudação recomendada: \\\"${saudacao}\\\"`);\n    }\n  }\n\n  return contextos.length > 0\n    ? contextos.join('\\n')\n    : 'Usar abordagem padrão empática e acolhedora';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSEAR CONFIGURAÇÕES DO AGENTE\n// ─────────────────────────────────────────────────────────────────────────────\nconst toolsConfig = safeParseJSON(agent.tools_config, {});\nconst businessConfig = safeParseJSON(agent.business_config, {});\nconst hyperpersonalization = safeParseJSON(agent.hyperpersonalization, {});\nconst qualificationConfig = safeParseJSON(agent.qualification_config, {});\nconst schedulingConfig = safeParseJSON(agent.scheduling_config, {});\nconst complianceConfig = safeParseJSON(agent.compliance_config, {});\nconst escalationConfig = safeParseJSON(agent.escalation_config, {});\nconst metricsConfig = safeParseJSON(agent.metrics_config, {});\nconst integrationConfig = safeParseJSON(agent.integration_config, {});\nconst knowledgeBase = safeParseJSON(agent.knowledge_base, []);\n\n// ⚠️ NOVO: Parsear prompts_by_mode do Supabase\nconst promptsByMode = safeParseJSON(agent.prompts_by_mode, {});\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS CONTEXTUAIS\n// ─────────────────────────────────────────────────────────────────────────────\nconst ddd = extrairDDD(mensagens.phone);\nconst periodo = getPeriodoHorario();\nconst agora = new Date();\nconst dataHora = agora.toLocaleString('pt-BR', {\n  timeZone: 'America/Sao_Paulo',\n  dateStyle: 'full',\n  timeStyle: 'short'\n});\n\nconst contextoHiper = gerarContextoHiperpersonalizado(ddd, periodo, hyperpersonalization);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FORMATAR HISTÓRICO\n// ─────────────────────────────────────────────────────────────────────────────\nlet historicoFormatado = '';\nif (mensagens.historico && mensagens.historico.length > 0) {\n  historicoFormatado = mensagens.historico\n    .slice(-10)\n    .map(m => `${m.role === 'user' ? 'LEAD' : 'ISABELLA'}: ${m.content}`)\n    .join('\\n');\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETECTAR MODO ATIVO (agente_ia)\n// ─────────────────────────────────────────────────────────────────────────────\n// IMPORTANTE: Pegar do Info (mais confiável), customData, ou Set mensagens\nconst agenteIA = infoData.agente_ia\n  || customData.agente_ia\n  || customData.agente_IA\n  || setMensagens.source\n  || mensagens.modo_agente\n  || agent.agent_type\n  || 'sdr_inbound';\n\nconsole.log('>>> MODO ATIVO DETECTADO:', agenteIA);\nconsole.log('>>> PROMPTS DISPONÍVEIS:', Object.keys(promptsByMode));\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    // Dados do agente\n    agent_id: agent.id,\n    agent_name: agent.agent_name || 'Isabella',\n    agent_type: agent.agent_type,\n    version: agent.version,\n    system_prompt: agent.system_prompt,\n    user_prompt_template: agent.user_prompt_template,\n    location_api_key: agent.location_api_key,\n\n    // ⚠️ NOVO: Modo ativo do agente (vem do Info.agente_ia)\n    agente_ia: agenteIA,\n\n    // ⚠️ NOVO: Prompts por modo (vem do Supabase)\n    prompts_by_mode: promptsByMode,\n\n    // Configurações parseadas\n    tools_config: toolsConfig,\n    business_config: businessConfig,\n    hyperpersonalization: hyperpersonalization,\n    qualification_config: qualificationConfig,\n    scheduling_config: schedulingConfig,\n    compliance_config: complianceConfig,\n    escalation_config: escalationConfig,\n    metrics_config: metricsConfig,\n    integration_config: integrationConfig,\n    knowledge_base: knowledgeBase,\n\n    // Contexto da conversa\n    contact_id: mensagens.contact_id,\n    phone: mensagens.phone,\n    full_name: mensagens.full_name,\n    source: mensagens.source,\n    message: mensagens.message,\n    conversation_id: mensagens.conversation_id,\n    etiquetas: mensagens.etiquetas,\n    status_pagamento: mensagens.status_pagamento,\n    preferencia_audio_texto: mensagens.preferencia_audio_texto,\n\n    // Dados calculados\n    ddd: ddd,\n    periodo: periodo,\n    data_hora: dataHora,\n    contexto_hiperpersonalizado: contextoHiper,\n    historico_formatado: historicoFormatado,\n    historico_existe: mensagens.historico && mensagens.historico.length > 0,\n    hora_numero: agora.getHours(),\n\n    // Calendários\n    calendarios_ghl: mensagens.calendarios_ghl || {},\n    ghl_api_key: mensagens.ghl_api_key || '',\n\n    // Dados do formulário de tráfego\n    formulario_trafego: mensagens.formulario_trafego || {},\n    is_lead_trafego: mensagens.is_lead_trafego || false\n  }\n};"
  },
  "id": "f7a85508-8e77-4d8a-9e6a-6f90720a1552",
  "name": "Preparar Execução + Identificar Contexto3",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    37088,
    27776
  ]
}

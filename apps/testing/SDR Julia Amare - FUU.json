{
  "name": "SDR Julia Amare - FUU",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "69c114dc-86c4-4ed0-98d4-ed5debb98b58",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        32224,
        26496
      ],
      "id": "03749039-ec28-4ca2-9897-02d5f60cf247",
      "name": "Mensagem recebida",
      "webhookId": "69c114dc-86c4-4ed0-98d4-ed5debb98b58"
    },
    {
      "parameters": {
        "content": "# Enviando resposta\nVamos verificar se nossa resposta deve ser enviada ou não caso o usuario tenha enviado alguma mensagem durante o pensamento da IA, significa que precisamos considerar a ultima mensagem antes de responder, e o processo seguinte ira receber nossa mensagem que iriamos mandar.",
        "height": 668,
        "width": 2236,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        40096,
        26128
      ],
      "id": "f54c2a63-76b2-4590-a99e-f8ba58a4854c",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## 1. Assistencia",
        "height": 80,
        "width": 540,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32896,
        26176
      ],
      "id": "31024824-4400-4972-a4d8-7151e53ea382",
      "name": "Sticky Note30"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO execution_metrics (\n  execution_id,\n  workflow_id,\n  workflow_name,\n  workflow_version,\n  n8n_version,\n  environment,\n  status,\n  started_at,\n  owner_id\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, NOW(), $8\n)\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $json.dados }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35504,
        26096
      ],
      "id": "1aacd1ae-2f6a-4baf-a683-0c30602fdd45",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a6c297c-ff22-4d5d-9f91-35eaa64b0d9a",
              "name": "=dados",
              "value": "={{ $execution.id }},{{ $workflow.id }},{{ $workflow.name }},1,1.99,{{ $execution.mode }},running,cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "f3b2358a-0eec-409b-9d61-a27ea7fbe59d",
              "name": "session",
              "value": "=etapa,{{ $('Info').first().json.etapa_funil || 'NULL' }},{{ $execution.id }},{{ $('Info').first().json.lead_id }},{{ !$('Info').first().json.n8n_ativo === false }},{{ $('Info').first().json.mensagem_id || 'NULL' }},{{ $('Info').first().json.api_key || $('Info').first().json.ghl_api_key || 'NULL' }},{{ $('Info').first().json.location_id || $json.contact.locationId || 'NULL' }},{{ $('Info').first().json.source || 'whatsapp' }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false,
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        35104,
        26096
      ],
      "id": "f5553df3-6fc1-4284-ac2e-71def3e8ae7c",
      "name": "GetInfo",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Rastreio de consumo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        34208,
        26016
      ],
      "id": "e981a597-d2af-47e5-99d7-30dd5f323578",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "304623c3-1fc3-495e-867b-8710765f00fd",
              "leftValue": "={{ $json.output.length }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        40784,
        26320
      ],
      "id": "ad693632-b13c-465f-957b-b258f9ece66e",
      "name": "Filter"
    },
    {
      "parameters": {
        "content": "## Última mensagem e Fluxo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        34656,
        26016
      ],
      "id": "46ce2058-b4e0-48f7-8534-4e9b9cd2e6af",
      "name": "Sticky Note28"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "0ddd4cab-cb95-4321-b283-6e555c39d69d",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        43632,
        26416
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {},
      "id": "9eb5d9f1-6582-412b-bc70-a7a77d9e33da",
      "name": "no.op",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        45168,
        26480
      ]
    },
    {
      "parameters": {
        "content": "## Verifica se o cliente mandou mensagem\nVerificamos se enquanto a IA está pensando, se o cliente mandou mensagem. Se sim, temos que salvar nossa mensagem para pensar novamente.",
        "height": 544,
        "width": 1200,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        38944,
        26128
      ],
      "id": "3790222f-ad20-4628-9a56-d88b7650740b",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        44496,
        26512
      ],
      "id": "92602961-da78-4698-a91a-76d3fd880496",
      "name": "Instagram",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer pit-dc0e9761-0077-4c82-9cf5-48345d87f034"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        44496,
        26320
      ],
      "id": "f41e0807-2c55-4f72-bf0f-a50f92496501",
      "name": "Whatsapp",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Info').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f5034094-22ae-449d-a556-1fc1bc216e49"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "21897a45-e463-4f12-aa85-a06b148d7ecb",
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        44272,
        26416
      ],
      "id": "cf2eb98a-01f2-4d3a-8437-c2428eb0d632",
      "name": "Canal",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "amount": 1.5
      },
      "id": "b636b096-fddd-49e0-bd06-5db752839f59",
      "name": "1.5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        44720,
        26416
      ],
      "webhookId": "9f96f182-e59e-4883-b776-641133b76865"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_response",
              "value": "={{ $('Parser Chain').item.json.output.messages.join(\"\") }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        44496,
        26128
      ],
      "id": "b3fb2dc9-5d17-4c38-b0f0-e307f2985a4d",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "toolDescription": "Adicionar tag 'perdido'. Use quando o lead se enquadrar em qualquer situação: já cadastrado, é agente, mora no Brasil, sem interesse, ou está insatisfeito. Motivo da desqualificação deve ser especificado.",
        "method": "PUT",
        "url": "https://services.leadconnectorhq.com/contacts/{contact_Id}",
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "Authorization",
              "valueProvider": "fieldValue",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "valueProvider": "fieldValue",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tags\": [\"perdido\"]\n}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "contact_Id",
              "description": "ID do contato",
              "type": "string"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        39776,
        26656
      ],
      "id": "7d9a9ccb-edc4-4f0d-876a-82f52472d89a",
      "name": "Adicionar_tag_perdido"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        39504,
        26800
      ],
      "id": "66874467-99fb-4472-b2ee-659391249ac1",
      "name": "Gemini2",
      "notesInFlow": false,
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "gpt-5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        39648,
        26656
      ],
      "id": "4bd61e74-58ad-4a9d-957a-721689c3fd18",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "description": "Buscar/consultar por horários disponíveis antes de agendar. Exemplo: startDate=1735689600000 endDate=1736294400000. calendario pode ser consultoria financeira ou carreira. E dateEndTo e dateStartFrom é a data de inicio e fim, geralmente entre hoje e 7 dias. Garanta que vai buscar slots disponíveis à partir do ano 2025",
        "workflowId": {
          "__rl": true,
          "value": "pZIcRI1PGMzbQHZZ",
          "mode": "list",
          "cachedResultUrl": "/workflow/pZIcRI1PGMzbQHZZ",
          "cachedResultName": "[ GHL ] Busca Disponibilidade"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "calendar": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar', `Buscar horários disponíveis. IMPORTANTE: O parâmetro 'calendar' deve ser o ID do calendário (ex: LvZWMISiyYnF8p7TrY7q), NÃO o nome. Consulte o CONTEXTO para obter calendarID_carreira ou calendarID_consultoria conforme work permit do lead.`, 'string') }}",
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "startDate": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startDate', `exemplo: 1735689600000`, 'string') }}",
            "endDate": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('endDate', `exemplo: 1736294400000`, 'string') }}",
            "lead_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_id', `exemplo: 23533559\n`, 'string') }}",
            "usuario_responsavel": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('usuario_responsavel', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "calendar",
              "displayName": "calendar",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startDate",
              "displayName": "startDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "endDate",
              "displayName": "endDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        39904,
        26656
      ],
      "id": "0f6a3bc0-2df5-4152-ab8b-d5d5a472b6c6",
      "name": "Busca_disponibilidade"
    },
    {
      "parameters": {
        "description": "Agendar um nova reunião. startTime segue o seguinte padrão 2021-06-23T03:30:00+05:30.",
        "workflowId": {
          "__rl": true,
          "value": "u1UsmjNNpaEiwIsp",
          "mode": "list",
          "cachedResultUrl": "/workflow/u1UsmjNNpaEiwIsp",
          "cachedResultName": "Agendar pelo GHL - ATUALIZAR KOMMO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "telefone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefone', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "calendar_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar_id', `Buscar horários disponíveis. IMPORTANTE: O parâmetro 'calendar' deve ser o ID do calendário (ex: LvZWMISiyYnF8p7TrY7q), NÃO o nome. Consulte o CONTEXTO para obter calendarID_carreira ou calendarID_consultoria conforme work permit do lead.`, 'string') }}",
            "startTime": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startTime', ``, 'string') }}",
            "firstName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('firstName', ``, 'string') }}",
            "lastName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lastName', ``, 'string') }}",
            "lead_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_id', ``, 'string') }}",
            "Carreira_Consultoria": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Carreira_Consultoria', `Especificar o tipo do agendamento`, 'string') }}",
            "usuario_responsavel": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('usuario_responsavel', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "calendar_id",
              "displayName": "calendar_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startTime",
              "displayName": "startTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "firstName",
              "displayName": "firstName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lastName",
              "displayName": "lastName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "estadoValue",
              "displayName": "estadoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "workPermitValue",
              "displayName": "workPermitValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Carreira_Consultoria",
              "displayName": "Carreira_Consultoria",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        40032,
        26656
      ],
      "id": "77c286b1-d9c9-4221-af3f-6ef64ae58b98",
      "name": "Agendar_reuniao"
    },
    {
      "parameters": {
        "description": "Atualizar a profissão/ocupação do lead (contact.profissao). Use esta tool quando o lead informar qual é sua profissão ou área de atuação atual. Valores: texto livre com a profissão (ex: Engenheiro, Médico, Empresário, Corretor de Imóveis, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "Kq3b79P6v4rTsiaH",
          "mode": "list",
          "cachedResultUrl": "/workflow/Kq3b79P6v4rTsiaH",
          "cachedResultName": "Atualizar Campo Profissão GHL (Auto-Config)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "profissaoValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('profissaoValue', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "profissaoValue",
              "displayName": "profissaoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        40160,
        26656
      ],
      "id": "0452c2c6-dccd-4225-800c-920397859df1",
      "name": "Atualizar Profissão"
    },
    {
      "parameters": {
        "description": "Atualizar o estado onde o lead mora (estado_onde_mora). Use esta tool quando o lead informar em qual estado dos EUA ele reside. Valores aceitos: nomes dos estados americanos (ex: Florida, California, Texas, New York, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "wsQQYmx8CLNBHoWq",
          "mode": "list",
          "cachedResultUrl": "/workflow/wsQQYmx8CLNBHoWq",
          "cachedResultName": "Atualizar Estado GHL (Otimizado)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "estadoValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estadoValue', ``, 'string') }}",
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "estadoValue",
              "displayName": "estadoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        40288,
        26656
      ],
      "id": "1ab26690-e6d1-4df8-9097-e51c161ea73c",
      "name": "Atualizar Estado"
    },
    {
      "parameters": {
        "jsCode": "// 1. Pega todas as mensagens disponíveis na fila\nconst todasMensagens = $('Buscar mensagens').all();\n\n// 2. CRÍTICO: Check de Fila Vazia (Race Condition)\n// Se a fila estiver vazia, significa que o workflow \"vencedor\" já acordou, \n// processou e limpou a fila enquanto este workflow estava esperando.\nif (!todasMensagens || todasMensagens.length === 0) {\n  return []; // Para o workflow imediatamente. Este workflow perdeu.\n}\n\n// 3. Ordenar as mensagens por timestamp (do mais recente para o mais antigo)\n// Adicionamos um desempate pelo ID da tabela caso dois timestamps sejam idênticos.\nconst filaOrdenada = todasMensagens.sort((a, b) => {\n  const tA = new Date(a.json.timestamp).getTime();\n  const tB = new Date(b.json.timestamp).getTime();\n  \n  // Se timestamps forem diferentes, ordena por tempo\n  if (tA !== tB) {\n    return tA - tB;\n  }\n  \n  // Se timestamps forem iguais (raro, mas possível), desempata pelo ID\n  return (a.json.id || 0) - (b.json.id || 0);\n});\n\n// 4. Identificar a mensagem \"Vencedora\" (a última da fila)\nconst mensagemVencedora = filaOrdenada[filaOrdenada.length - 1];\nconst idVencedor = mensagemVencedora.json.id_mensagem;\n\n// 5. Pegar o ID da mensagem que este workflow atual está processando\nconst idWorkflowAtual = $('Info').first().json.mensagem_id;\n\n// 6. Comparar: Eu sou o dono da última mensagem?\nif (idVencedor !== idWorkflowAtual) {\n  // NÃO sou o vencedor. A última mensagem pertence a outro workflow.\n  // Retorno array vazio para parar este fluxo imediatamente.\n  return []; \n}\n\n// 7. SIM, sou o vencedor!\n// Retorno TODA a fila ordenada para que a IA processe as mensagens agrupadas.\nreturn filaOrdenada;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        35840,
        26496
      ],
      "id": "65e90256-6503-49d9-b400-430ba142a2d4",
      "name": "Mensagem encavalada?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35344,
        26496
      ],
      "id": "131fb560-ebcc-4741-ab95-25b037f2f556",
      "name": "Buscar mensagens",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        36144,
        26496
      ],
      "id": "d8a572e0-e99f-41c2-8fb5-52402c8fcb56",
      "name": "Limpar fila de mensagens",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "content": "# Processando mensagens encavaladas\n\nEssa etapa trata a situação em que o usuário envia múltiplas mensagens seguidas. O ponto negativo é o aumento no tempo de resposta do agente. Lógica dispensa uso de soluções mais complexas, como RabbitMQ.\n\nTempo de espera recomendado de ~16s. Quando estiver testando, recomendamos reduzir um pouco para ficar mais rápido de testar.\n",
        "height": 540,
        "width": 1216,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        34032,
        26320
      ],
      "id": "d04fc3f1-3bdb-43d9-8742-73013212568d",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "amount": 16
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        35120,
        26496
      ],
      "id": "049bcc5c-f8a7-489f-838b-721600d18a83",
      "name": "Esperar",
      "webhookId": "65baf0da-1755-4c7d-a71c-6a61d51e684c"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_fila_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "mensagem": "={{ $json.mensagem }}",
            "id_mensagem": "={{ $json.mensagem_id }}",
            "timestamp": "={{ $json.datetime }}",
            "lead_id": "={{ $json.lead_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "instagram",
              "displayName": "instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        34928,
        26496
      ],
      "id": "edf76e21-9511-4faa-811a-0379f85eb619",
      "name": "Enfileirar mensagem.",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.photo_audio }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35120,
        26976
      ],
      "id": "850b6bb7-17b3-4d05-bef3-4bf9daadb256",
      "name": "Download áudio",
      "retryOnFail": true,
      "credentials": {
        "chatwootApi": {
          "id": "UmVE5jAScA8a8vNB",
          "name": "ChatWoot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        35936,
        26976
      ],
      "id": "e7ea0757-4f1a-4f32-a099-f7e8fe0c43e3",
      "name": "Transcrever audio",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        35312,
        26976
      ],
      "id": "96ed1202-1eb1-4a76-83d3-2d678542e5f1",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "={{ $json.fileName }}",
          "mimeType": "={{ $json.mimeType }}"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        35744,
        26976
      ],
      "id": "b2eb1cd9-cff4-4d50-830c-4328d117d1bb",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c3bb05a3-1c9e-4993-a20f-7d92b005cc09",
              "name": "last_db_message",
              "value": "={{ $input.last().json }}",
              "type": "string"
            },
            {
              "id": "80a47b08-9d11-4fa6-b5c0-c892bd503182",
              "name": "current_message",
              "value": "={{ $('Info').first().json.mensagem_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        35568,
        26496
      ],
      "id": "7686e6d4-4c0a-476c-93fe-c9957e526354",
      "name": "Form Mensagem"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ca54eae-15d1-49d3-af33-7a6e5d17b833",
              "leftValue": "={{ $('Info').item.json.n8n_ativo }}",
              "rightValue": "disparo realizado",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "8d1933c9-21dc-4aeb-bce7-6b20411d2801",
              "leftValue": "={{ $('Tipo de mensagem').item.json.mensagem.toLowerCase() }}",
              "rightValue": "okkk",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        36976,
        26480
      ],
      "id": "199e69b1-d224-4d26-992b-d3b9c75ab8ec",
      "name": "Permitido AI?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').item.json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        36496,
        26496
      ],
      "id": "746dc1f1-6bce-4f77-8eff-349fa7f53ea4",
      "name": "Conversa Ativa",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isEmpty() || $json.status === 'inactive' || (new Date() - new Date($json.created_at)) > 1 * 60 * 1000  }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "be5f5420-f7d0-46e7-acb7-663377e7ff88"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Iniciar Conversa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "064c4e28-0fba-45da-8ad8-15c9678b7842",
                    "leftValue": "={{ $json.retries > 10 ||  $json.waiting_process_id && $json.status === 'active' && $json.waiting_process_id !== $('Info').item.json.process_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignorar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ccd478c2-5d5c-4e0d-a6ad-3727d8fb420e",
                    "leftValue": "={{ $json.status === 'active' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Aguardar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        36736,
        26496
      ],
      "id": "43501e20-6c56-4e46-b968-e7059f288ea7",
      "name": "Ação Planejada"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        37184,
        26656
      ],
      "id": "8aea8f5c-cc66-4428-a275-573854385be0",
      "name": "Wait",
      "webhookId": "08ef019b-630a-44a7-9068-e4dc674761cc"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "waiting_process_id": "={{ $('Info').item.json.process_id }}",
            "id": "={{ $('Conversa Ativa').item.json.id }}",
            "workflow_id": "={{ $json.workflow_id }}",
            "retries": "={{ $('Conversa Ativa').item.json.retries + 1 }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        36976,
        26656
      ],
      "id": "37e52edb-157e-4471-aba2-7dc7e1d12f96",
      "name": "Salvar Espera",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "key": "a_lead_name",
              "value": "={{ $('Info').item.json.full_name }}"
            },
            {
              "key": "location_name",
              "value": "={{ $('Info').first().json.location_name }}"
            },
            {
              "key": "telefone",
              "value": "={{ $('Info').item.json.telefone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        37136,
        26480
      ],
      "id": "e50b04fd-8bc4-4d90-b454-187827dfdd62",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "O que há nessa imagem?",
        "imageUrls": "={{ $json.photo_audio }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        34928,
        26880
      ],
      "id": "1af2e6fc-ebe3-41b0-9774-66091d7f0e43",
      "name": "Analyze image",
      "credentials": {
        "anthropicApi": {
          "id": "nNkFTZpNoiBCbO1I",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fd3e8b9e-eed6-4f43-94c8-089af8417065",
              "name": "imagem",
              "value": "={{ $json.content[0].text ? \"[Imagem Recebida]: \"+ $json.content[0].text : \"\"}}",
              "type": "string"
            },
            {
              "id": "a3bc628f-18b3-4e08-b620-65c5a3a57b40",
              "name": "audio:",
              "value": "={{ $json.text ? \"[Audio Recebido]: \"+ $json.text : \"\"}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        36128,
        26816
      ],
      "id": "66a6c268-7bc0-4cf1-841e-20e4e48e8c6b",
      "name": "Imagem ou audio"
    },
    {
      "parameters": {
        "content": "# Processando áudio",
        "height": 276,
        "width": 880,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        34208,
        26880
      ],
      "id": "0408843a-05c0-4a15-b545-3cdc4f212170",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set mensagens').first().json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        41232,
        26320
      ],
      "id": "db96acc7-41d2-49f2-9b18-bd563c9d98a8",
      "name": "Tipo de mensagem1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        42384,
        26848
      ],
      "id": "130614a7-6f87-44eb-891e-8a811c2fce44",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "97df1142-b72f-499f-9053-d3b2f6500f9c",
              "leftValue": "={{ $json.waiting_process_id && $json.waiting_process_id !== $('Info').first().json.process_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        42080,
        26320
      ],
      "id": "332e6bf2-b987-441b-af4a-d967f38ad274",
      "name": "Deve enviar mensagem?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').first().json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        41456,
        26320
      ],
      "id": "d67c5877-c3c9-4145-a05a-d70822e4a012",
      "name": "Conversa ativa atualizada",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9d2eedc1-7e26-437e-a11b-bc18f563d470",
              "leftValue": "={{ $json.waiting_process_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        41680,
        26320
      ],
      "id": "82a46ed1-1ac7-4912-b2d3-dbbe22d77e98",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        42080,
        26512
      ],
      "id": "9a877e56-ed31-4d10-9dae-9dc05ef9fa85",
      "name": "Termino de resposta",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').first().json.lead_id }}",
            "lead_name": "={{ $('Info').first().json.full_name }}",
            "status": "inactive",
            "id": "={{ $('Conversa Ativa').first().json.id || $('Info').first().json.process_id }}",
            "owner_id": "={{ $('Info').first().json.owner_id }}",
            "workflow_id": "={{ $('Info').first().json.workflow_id }}",
            "output_preview": "={{ $('Tipo de mensagem1').item.json.output }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        41904,
        26320
      ],
      "id": "658cddc9-a905-499e-ad66-8517f269a651",
      "name": "Atualizar resposta IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "3e4d1de2-e54b-4a34-8d95-dcd2ea91a65b",
      "name": "Segmentos1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        43408,
        26416
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff19cb21-f08f-4c45-9e0c-bf15cc3a8c63",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"json\") }}",
              "rightValue": "json",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "6495fa85-2af7-493f-bf75-e3d46220f622",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"{\") }}",
              "rightValue": "{{",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "9862c89d-b15e-4ca9-819b-1d78ce50969e",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"output\") }}",
              "rightValue": "output",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "221b46a6-b8e2-4876-91e5-1e63c832c3ec",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"parsed\") }}",
              "rightValue": "parsed",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "dbfb7464-ce46-4d5d-9b0b-716ef05a823d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"split\") }}",
              "rightValue": "split",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "45b8f555-eada-41a5-abc8-a115b34d9e4d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"properties\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "7a3e9dac-e029-44cd-8c7c-ed187ec77bd7",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"type\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        42960,
        26416
      ],
      "id": "1668cf36-9177-4a89-9e1a-c443d58714ad",
      "name": "If1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        42384,
        26640
      ],
      "id": "8070d151-0c33-4e29-aff1-1ed40fc1d865",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "agente_ia",
              "value": "={{ $('Info').first().json.agente_ia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        43184,
        26416
      ],
      "id": "810992cc-b0f8-4651-a075-ff3ec05c4356",
      "name": "Execution Data2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ \n  ['arquivo de imagem', 'arquivo de áudio', 'mensagem de áudio', ''].includes(($json.mensagem || '').toLowerCase().trim()) \n    ? ($('Imagem ou audio').first().json['audio:'] || $('Imagem ou audio').first().json.imagem || $('Info').first().json.mensagem || '')\n    : ($json.mensagem || $('Info').first().json.mensagem || '')\n}}",
              "type": "string"
            },
            {
              "id": "09b2dd8b-c24b-49e8-bc36-918ae46a4f6b",
              "name": "output_preview",
              "value": "={{ $json.output_preview }}",
              "type": "string"
            },
            {
              "id": "562253ae-7585-480e-ba6e-4774dbfd05ae",
              "name": "mensagens_antigas",
              "value": "={{ \n  $('Mensagem anteriores').all()\n    .map(item => {\n      const prefix = item.json.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.json.message.type === \"human\" && item.json.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.json.message.content;\n      return `[${item.json.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\") \n}}",
              "type": "string"
            },
            {
              "id": "d134ff5d-a48c-44d8-9350-572093043f53",
              "name": "=location_id",
              "value": "={{ $('Info').first().json.location_id }}",
              "type": "string"
            },
            {
              "id": "47fd8213-7810-4d93-804a-c8504da12046",
              "name": "agente_versionado",
              "value": "={{ $('Info').first().json.agente_versionado }}",
              "type": "string"
            },
            {
              "id": "887cbf69-e713-47e4-b454-b9d57b1a2beb",
              "name": "agente_ia",
              "value": "={{ $('Info').first().json.agente_ia }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        38288,
        26416
      ],
      "id": "9effebbd-6b43-4065-8bc7-013d6566e890",
      "name": "Set mensagens",
      "executeOnce": true
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": \"{{ $('Parser Chain').first().json.output.messages.join(\"\") }}\",\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Memoria Lead').first().json.session_id }}",
            "location_id": "={{ $('Info').first().json.location_id }}"
          },
          "matchingColumns": [
            "session_id",
            "created_at"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        44224,
        26128
      ],
      "id": "e63153f6-c5b4-4b27-8870-452a1ba57f42",
      "name": "Memoria IA",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={{ $json.message }}",
            "session_id": "={{ $json.session_id }}",
            "location_id": "={{ $('Info').first().json.location_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        37888,
        26480
      ],
      "id": "b0023786-71c8-4245-8227-3cb7d0a68687",
      "name": "Memoria Lead",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Pega o item de entrada\nconst inputItems = $input.all();\n\n// Processa cada item\nconst outputItems = inputItems.map((inputItem, index) => {\n  // Pega os dados do nó Info\n  const infoData = $('Info').first().json;\n  \n  // ===== CRÍTICO: Com returnAll, Postgres retorna múltiplos items =====\n  // Precisamos pegar TODOS os items, não só o último\n  const allMessages = $('Mensagem anteriores').all();\n  \n  console.log(`Total de items do Postgres: ${allMessages.length}`);\n  \n  // Transforma todos os items em um array de mensagens\n  const msgArray = allMessages\n    .map(item => item.json)\n    .filter(item => {\n      return item && item.created_at && item.message && item.message.content;\n    });\n  \n  console.log(`Total de mensagens válidas: ${msgArray.length}`);\n  \n  // Adiciona a mensagem ATUAL do lead ao histórico\n  const mensagemAtual = infoData.mensagem;\n  if (mensagemAtual && mensagemAtual.trim()) {\n    msgArray.push({\n      created_at: new Date().toISOString(),\n      message: {\n        type: \"human\",\n        content: mensagemAtual\n      }\n    });\n  }\n  \n  console.log(`Total com mensagem atual: ${msgArray.length}`);\n  \n  // Deduplica por timestamp + conteúdo\n  const seen = new Map();\n  const unique = msgArray.filter(item => {\n    // Cria chave única baseada em timestamp e conteúdo\n    const timestamp = new Date(item.created_at).getTime();\n    const content = item.message?.content || '';\n    const key = `${timestamp}_${content.substring(0, 100)}`;\n    \n    // Se já viu essa chave, ignora\n    if (seen.has(key)) {\n      console.log(`Duplicata encontrada: ${content.substring(0, 50)}...`);\n      return false;\n    }\n    \n    seen.set(key, true);\n    return true;\n  });\n  \n  console.log(`Mensagens após deduplicação: ${unique.length}`);\n  \n  // Formata as mensagens em ordem cronológica\n  const mensagens_antigas = unique\n    .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))\n    .map(item => {\n      const prefix = item.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.message.type === \"human\" && item.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.message.content;\n      return `[${item.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\");\n  \n  console.log(`Histórico formatado com ${mensagens_antigas.split('\\n\\n').length} mensagens`);\n  \n  // Retorna mantendo o pairedItem\n  return {\n    json: {\n      mensagens_antigas: mensagens_antigas,\n      mensagens_count: unique.length,\n      ...inputItem.json,\n      ...infoData\n    },\n    pairedItem: inputItem.pairedItem\n  };\n});\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38032,
        26480
      ],
      "id": "f14800f4-ac58-4b1d-862e-332e531349e5",
      "name": "Deduplica Mensagens"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "created_at"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        37504,
        26480
      ],
      "id": "0e71c10c-2b4a-4967-8d30-cc32be00e9a7",
      "name": "Mensagem anteriores",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        }
      },
      "name": "Search Contact",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        34720,
        26096
      ],
      "id": "860220ed-308f-41c3-8bb4-6da7c3501280",
      "executeOnce": false,
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "notes": "Busca contato por EMAIL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.leadconnectorhq.com/locations/{{ $json.location.id }}/customFields",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"Etapa do Funil\",\n  \"fieldKey\": \"contact.etapa_funil\",\n  \"dataType\": \"SINGLE_OPTIONS\",\n  \"placeholder\": \"Selecione a etapa\",\n  \"position\": 100,\n  \"options\": [\n    \"Novo Lead\",\n    \"Primeiro Contato\",\n    \"Em Follow-Up\",\n    \"Qualificado\",\n    \"Agendamento Marcado\",\n    \"Reagendado\",\n    \"No-Show\",\n    \"Reunião Realizada\",\n    \"Proposta Enviada\",\n    \"Follow-Up Proposta\",\n    \"Contrato Enviado\",\n    \"Aguardando Pagamento\",\n    \"Cliente Ativo\",\n    \"Perdido\"\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32688,
        25152
      ],
      "id": "b65e02aa-0669-4d13-8c2e-973927505447",
      "name": "GHL - Criar Campo Etapa do Funil",
      "alwaysOutputData": true,
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Importante\n\nEssa tool cria campo no Socialfy, basta solicitar ao Claude o campo que quer criar e copiar o campo a baixo e colar no claude para dar como referencia",
        "height": 320,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32896,
        25824
      ],
      "id": "8a16bc1e-2d3b-4014-9ce4-022d0a0eaaef",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.crm_historico_mensagens\n(lead_id, mensagem, datetime, source, full_name)\nVALUES\n('{{ $json.lead_id }}', '{{ $json.mensagem }}', '{{ $json.datetime }}', '{{ $json.source }}', '{{ $json.full_name }}')\nON CONFLICT (lead_id, mensagem, datetime)\nDO NOTHING\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35088,
        25872
      ],
      "id": "cb92d8ac-6a41-464d-b6ff-dfda0967882a",
      "name": "historico_mensagens_leads",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb6433a3-a8c8-41fc-ba24-c5508055f5e7",
              "name": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}",
              "type": "string"
            },
            {
              "id": "e3c59cf4-b8fb-47bd-9201-0cde177d3f2c",
              "name": "mensagem",
              "value": "={{ $('Info').first().json.mensagem }}",
              "type": "string"
            },
            {
              "id": "551981a4-e58d-4ee7-b27f-1d1bba8fde43",
              "name": "datetime",
              "value": "={{ $('Info').first().json.datetime }}",
              "type": "string"
            },
            {
              "id": "74b98426-15c4-4a10-9978-f310ad162656",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            },
            {
              "id": "30c0f0ec-8f71-4d0d-8e88-dfad7fa31d63",
              "name": "full_name",
              "value": "={{ $('Info').item.json.full_name }}",
              "type": "string"
            },
            {
              "id": "96903a49-e8ca-4f89-ac29-404fa61b5a7e",
              "name": "api_key",
              "value": "={{ $json.api_key }}",
              "type": "string"
            },
            {
              "id": "9621f071-1ddc-4b66-8fd1-1152035f623d",
              "name": "location.id",
              "value": "={{ $json.location.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        34688,
        25872
      ],
      "id": "1748a6ec-e088-4964-86ef-8038c6ed1128",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').item.json.lead_id }}",
            "lead_name": "={{ $('Info').item.json.first_name }}",
            "status": "active",
            "id": "={{ $('Conversa Ativa').item.json.id || $('Info').item.json.process_id }}",
            "owner_id": "={{ $('Info').item.json.owner_id }}",
            "workflow_id": "={{ $('Info').item.json.workflow_id }}",
            "waiting_process_id": "={{ null }}",
            "retries": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        37312,
        26480
      ],
      "id": "81a254b8-7974-419e-814d-343a9c3998a3",
      "name": "Salvar Inicio IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO ops_schedule_tracking (\n  field, value, execution_id, unique_id, ativo, chat_id, api_key, location_id, source\n) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\nON CONFLICT (unique_id) DO UPDATE SET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id,\n  api_key = EXCLUDED.api_key,\n  location_id = EXCLUDED.location_id,\n  source = EXCLUDED.source;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35952,
        26096
      ],
      "id": "94f282f6-fd9d-4f5a-b1a2-89470d69d05b",
      "name": "Salvar registro de Atividade - marcos",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  field,\n  value,\n  execution_id,\n  unique_id,\n  ativo,\n  chat_id,\n  api_key,\n  location_id,\n  source,\n  follow_up_count\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, $8, $9, 0\n)\nON CONFLICT (unique_id) DO UPDATE\nSET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id,\n  api_key = COALESCE(EXCLUDED.api_key, n8n_schedule_tracking.api_key),\n  location_id = COALESCE(EXCLUDED.location_id, n8n_schedule_tracking.location_id),\n  source = COALESCE(EXCLUDED.source, n8n_schedule_tracking.source),\n  follow_up_count = 0;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35744,
        26096
      ],
      "id": "3b4da0cd-f0fd-4559-b5b4-f4f829b3d69d",
      "name": "Salvar registro de Atividade - alan",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "Inserir automação para disparar quando acionar a tag"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32912,
        26912
      ],
      "typeVersion": 1,
      "id": "571814fa-d09e-4654-9df0-6a628cc7451a",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "jsCode": "// Sanitiza a mensagem e constrói o objeto corretamente\nconst info = $('Info').first().json;\nconst mensagem = info.mensagem || '';\n\n// Sanitiza quebras de linha\nconst mensagemLimpa = mensagem\n  .trim()\n  .replace(/\\r\\n/g, '\\n')\n  .replace(/\\r/g, '\\n');\n\n// Retorna o OBJETO diretamente\nreturn [{\n  json: {\n    lead_id: info.lead_id,\n    session_id: info.lead_id,\n    message: {\n      type: \"human\",\n      content: mensagemLimpa,\n      tool_calls: [],\n      additional_kwargs: {},\n      response_metadata: {},\n      invalid_tool_calls: []\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37680,
        26480
      ],
      "id": "451e80fe-57de-4f61-8a9a-4f8ddadbe13c",
      "name": "Preparar Mensagem"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GWKl5KuXAdeu4BLr",
          "mode": "list",
          "cachedResultUrl": "/workflow/GWKl5KuXAdeu4BLr",
          "cachedResultName": "[TOOL] Registrar Custo IA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location_id": "={{ $('Info').first().json.location_id }}",
            "location_name": "={{ $('Info').first().json.location_name }}",
            "contact_id": "={{ $('Info').first().json.lead_id }}",
            "contact_name": "={{ $('Info').first().json.first_name }}",
            "canal": "={{ $('Info').first().json.source }}",
            "tipo_acao": "Agendar",
            "total_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_input + $('Calcular Custo LLM').first().json.custo_pro.tokens_output + $('Calcular Custo LLM').first().json.custo_flash.tokens_input + $('Calcular Custo LLM').first().json.custo_flash.tokens_output }}",
            "output_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_output + $('Calcular Custo LLM').first().json.custo_flash.tokens_output }}",
            "model": "gemini-2.5-pro+flash",
            "input_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_input + $('Calcular Custo LLM').first().json.custo_flash.tokens_input }}",
            "workflowId": "={{ $workflow.id }}",
            "executionId": "={{ $execution.id }}",
            "date": "={{ $now.format('FFFF') }}  "
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "date",
              "displayName": "date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "model",
              "displayName": "model",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "input_tokens",
              "displayName": "input_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "output_tokens",
              "displayName": "output_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "total_tokens",
              "displayName": "total_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "workflowId",
              "displayName": "workflowId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "executionId",
              "displayName": "executionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_name",
              "displayName": "contact_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "canal",
              "displayName": "canal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tipo_acao",
              "displayName": "tipo_acao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        44976,
        26128
      ],
      "id": "03cd5e5c-60fa-4c07-bf8f-f87e80eef230",
      "name": "Call Track AI Cost",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "name"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35168,
        25568
      ],
      "id": "ff1a995c-698d-4834-a9ee-1f43b7f86875",
      "name": "Limpar memória",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "name"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        36064,
        25568
      ],
      "id": "3a4d1c0b-1c20-47fc-9891-918f19db09ff",
      "name": "Limpar fila de mensagens1",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Edit Fields').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Edit Fields').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        36224,
        25568
      ],
      "id": "88574033-cc5e-4f6d-b234-1d1dce731886",
      "name": "Canal2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Memória resetada.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        36448,
        25664
      ],
      "id": "599ba83c-e0ff-4092-a73e-a1ca32677927",
      "name": "Instagram2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Memória resetada.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        36448,
        25472
      ],
      "id": "56d491aa-de98-41cc-b720-14dcb62274d4",
      "name": "Whatsapp2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        36672,
        25568
      ],
      "id": "25ad36e0-7d92-4c17-9712-6b08edf6d270"
    },
    {
      "parameters": {
        "content": "## Resetar conversa\n",
        "height": 288,
        "width": 1200,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        35056,
        25472
      ],
      "typeVersion": 1,
      "id": "5dce8d60-c8de-437a-a5e9-3d3db459b816",
      "name": "Sticky Note10",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Habilitar testes\n",
        "height": 784,
        "width": 1920,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        34512,
        24640
      ],
      "typeVersion": 1,
      "id": "e1129b71-51e5-4a42-9054-22a35321842c",
      "name": "Sticky Note21",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Enviar mensagem\n",
        "height": 372,
        "width": 724
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        36128,
        25456
      ],
      "typeVersion": 1,
      "id": "8bcb48fd-35f5-4b42-8b22-15fedc1495b8",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "jsCode": "// Extrai o ID da conversa mais recente\nconst data = $input.first().json;\n\nif (data.conversations && data.conversations.length > 0) {\n  const conversationId = data.conversations[0].id;\n  \n  return [{\n    json: {\n      conversationId: conversationId,\n      contactId: $input.first().json.body?.contact_id || data.conversations[0].contactId\n    }\n  }];\n}\n\n// Se não encontrar conversa, retorna vazio\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        34720,
        25568
      ],
      "id": "441bd737-42fd-4652-bfa6-d372eceedf70",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "99b0ce86-bc45-49c1-89cf-bbdc50e6bdd4",
              "name": "conversationId",
              "value": "={{ $json.conversationId }}",
              "type": "string"
            },
            {
              "id": "504ecb36-c7b7-4ee5-8d06-7473f9e0ff43",
              "name": "contactId",
              "value": "={{ $json.contactId }}",
              "type": "string"
            },
            {
              "id": "5ca544f2-b852-4290-83e3-fe3ab977b6d3",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        34944,
        25568
      ],
      "id": "c3cf19ed-f41f-47d0-8367-0954ce3489f9",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/conversations/search?contactId={{ $('Info').first().json.lead_id }}&limit=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34496,
        25568
      ],
      "id": "620b468b-da03-4933-8f8f-9f2f46b355bc",
      "name": "1. Buscar Conversa do Contato",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Edit Fields').item.json.contactId }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=reset"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        35616,
        25568
      ],
      "id": "4a89a9e2-abe8-4faf-94eb-a6af9f9b9d82"
    },
    {
      "parameters": {
        "jsCode": "// Coloque isso em um Code node antes do Convert to File\nconst url = $('Download áudio').first().json.photo_audio || '';\nlet extension = 'ogg'; // default para WhatsApp\n\n// Tenta extrair extensão da URL\nconst match = url.match(/\\.(\\w+)(?:\\?|$)/);\nif (match) {\n  extension = match[1];\n}\n\n// Mapeia extensões comuns\nconst mimeTypes = {\n  'ogg': 'audio/ogg',\n  'opus': 'audio/ogg',\n  'mp3': 'audio/mpeg',\n  'wav': 'audio/wav',\n  'm4a': 'audio/mp4',\n  'webm': 'audio/webm'\n};\n\nreturn {\n  json: {\n    ...$input.first().json,\n    fileName: `audio.${extension}`,\n    mimeType: mimeTypes[extension] || 'audio/ogg'\n  },\n  binary: $input.first().binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        35520,
        26976
      ],
      "id": "788e511a-86f1-4df6-bc85-d0a13f8d4a49",
      "name": "Extrair a extensão"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Extrair output\nlet outputText = '';\nif (typeof data.output === 'string') {\n  outputText = data.output;\n} else if (data.output?.messages?.[0]) {\n  outputText = data.output.messages[0];\n} else if (data.output) {\n  outputText = JSON.stringify(data.output);\n}\n\n// ========================================\n// GEMINI 2.5 PRO (Agente principal)\n// ========================================\nconst PRO_PROMPT_TOKENS = 10050;\nconst PRO_CHARS_POR_TOKEN = 3.4;\nconst PRO_PRECO_INPUT = 1.25;\nconst PRO_PRECO_OUTPUT = 5.00;\n\nconst proCompletionTokens = Math.ceil(outputText.length / PRO_CHARS_POR_TOKEN);\nconst proCustoInput = (PRO_PROMPT_TOKENS / 1000000) * PRO_PRECO_INPUT;\nconst proCustoOutput = (proCompletionTokens / 1000000) * PRO_PRECO_OUTPUT;\nconst proCustoTotal = proCustoInput + proCustoOutput;\n\n// ========================================\n// GEMINI 2.5 FLASH (Tool de chat)\n// ========================================\nconst FLASH_PROMPT_TOKENS = 553;\nconst FLASH_CHARS_POR_TOKEN = 1.6;\nconst FLASH_PRECO_INPUT = 0.15;\nconst FLASH_PRECO_OUTPUT = 0.60;\n\nconst flashCompletionTokens = Math.ceil(outputText.length / FLASH_CHARS_POR_TOKEN);\nconst flashCustoInput = (FLASH_PROMPT_TOKENS / 1000000) * FLASH_PRECO_INPUT;\nconst flashCustoOutput = (flashCompletionTokens / 1000000) * FLASH_PRECO_OUTPUT;\nconst flashCustoTotal = flashCustoInput + flashCustoOutput;\n\n// ========================================\n// TOTAL COMBINADO\n// ========================================\nconst custoTotalUSD = proCustoTotal + flashCustoTotal;\nconst custoTotalBRL = custoTotalUSD * 6;\n\nreturn {\n  json: {\n    output: outputText,\n    custo_pro: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: PRO_PROMPT_TOKENS,\n      tokens_output: proCompletionTokens,\n      custo_usd: parseFloat(proCustoTotal.toFixed(6))\n    },\n    custo_flash: {\n      modelo: 'gemini-2.5-flash',\n      tokens_input: FLASH_PROMPT_TOKENS,\n      tokens_output: flashCompletionTokens,\n      custo_usd: parseFloat(flashCustoTotal.toFixed(6))\n    },\n    custo_total: {\n      custo_usd: parseFloat(custoTotalUSD.toFixed(6)),\n      custo_brl: parseFloat(custoTotalBRL.toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44640,
        26144
      ],
      "id": "281b7ab3-2b1a-4d60-80f2-b0f7ed9be9b6",
      "name": "Calcular Custo LLM"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\n      \"id\": \"{{ $json.ativar_ia_id }}\",\n      \"value\": \"sim\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35392,
        25568
      ],
      "id": "8effe026-53a8-4b19-9804-e6ce75aae7eb",
      "name": "ativar_ia2",
      "notes": "Atualiza o campo customizado work_permit no contato"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/locations/{{ $('Info').first().json.location_id }}/customFields",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34576,
        24944
      ],
      "id": "fe9c3776-8b1b-4eb4-b3a3-36edfe941d3a",
      "name": "1️⃣ Listar campos customizados"
    },
    {
      "parameters": {
        "jsCode": "const infoNode = $('Info').first().json;\nconst inputData = $input.first().json;\n\n// ========== 1. EXTRAI CAMPOS CUSTOMIZADOS ==========\nlet customFields = [];\n\nif (inputData.customFields) {\n  customFields = inputData.customFields;\n} else if (Array.isArray(inputData) && inputData[0]?.customFields) {\n  customFields = inputData[0].customFields;\n}\n\nconst ativarIAField = customFields.find(f => f.fieldKey === \"contact.ativar_ia\");\nconst especialistaMotiveField = customFields.find(f => f.fieldKey === \"contact.contactmotive_responsavel\");\nconst objetivoLeadField = customFields.find(f => f.fieldKey === \"contact.objetivo_do_lead\");\n\n// Pega as opções válidas diretamente do picklist do GHL\nconst opcoesObjetivoValidas = (objetivoLeadField?.picklistOptions || []).filter(opt => opt !== 'x');\nconst opcoesEspecialistaValidas = especialistaMotiveField?.picklistOptions || [];\n\n// ========== 2. EXTRAI CONVERSATION ID ==========\nlet conversationId = null;\nlet contactId = infoNode.lead_id || null;\n\nif (inputData.conversations && inputData.conversations.length > 0) {\n  conversationId = inputData.conversations[0].id;\n  contactId = inputData.body?.contact_id || inputData.conversations[0].contactId || contactId;\n}\n\n// ========== 3. DETECTA OBJETIVO ==========\nfunction getString(valor) {\n  if (!valor) return '';\n  if (typeof valor === 'string') return valor;\n  if (typeof valor === 'object') {\n    return valor.text || valor.message || valor.content || '';\n  }\n  return String(valor);\n}\n\nconst mensagem = getString(infoNode.message || infoNode.body).toLowerCase();\nconst objetivoDoLead = getString(infoNode.objetivo_do_lead).toLowerCase();\nconst especialistaMotive = getString(infoNode.contactmotive_responsavel).toLowerCase();\nconst informacoesIA = getString(infoNode.informaes_para_ai).toLowerCase();\n\nconst keywordsCarreira = ['carreira', 'recrutamento', 'recrutar', 'vaga', 'emprego', 'trabalho', 'sdrcarreira', 'socialsellercarreira'];\nconst keywordsConsultoria = ['consultoria', 'consultor', 'mentor', 'mentoria', 'sdrconsultoria', 'socialsellerconsultoria'];\n\nfunction contemKeyword(texto, keywords) {\n  return keywords.some(kw => texto.includes(kw));\n}\n\nfunction detectarObjetivo(texto) {\n  if (contemKeyword(texto, keywordsCarreira)) return 'carreira';\n  if (contemKeyword(texto, keywordsConsultoria)) return 'consultoria';\n  return null;\n}\n\n// Mapeamento objetivo → especialista\nfunction getEspecialista(objetivo) {\n  if (objetivo === 'carreira') return 'sdrcarreira';\n  if (objetivo === 'consultoria') return 'sdrconsultoria';\n  return '';\n}\n\nconst textoCompleto = `${mensagem} ${objetivoDoLead} ${especialistaMotive} ${informacoesIA}`;\n\nconst regexTeste = /\\/teste\\s+(carreira|recrutamento|consultoria|consultor|mentor)/i;\nconst matchTeste = mensagem.match(regexTeste);\n\nlet resultado = 'indefinido';\nlet especialistaDefinido = '';\nlet objetivoDefinido = '';\nlet fonteDeteccao = 'nenhuma';\n\n// Prioridade 1: Comando /teste na mensagem\nif (matchTeste) {\n  const objetivoDetectado = detectarObjetivo(matchTeste[1].toLowerCase());\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'comando_teste';\n  }\n}\n\n// Prioridade 2: Campo objetivo_do_lead já preenchido COM VALOR VÁLIDO\nif (resultado === 'indefinido' && objetivoDoLead && opcoesObjetivoValidas.includes(objetivoDoLead)) {\n  resultado = objetivoDoLead;\n  especialistaDefinido = getEspecialista(objetivoDoLead);\n  objetivoDefinido = objetivoDoLead;\n  fonteDeteccao = 'campo_objetivo';\n}\n\n// Prioridade 3: Especialista já definido\nif (resultado === 'indefinido' && especialistaMotive) {\n  const objetivoDetectado = detectarObjetivo(especialistaMotive);\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'campo_especialista';\n  }\n}\n\n// Prioridade 4: Análise do texto completo\nif (resultado === 'indefinido') {\n  const objetivoDetectado = detectarObjetivo(textoCompleto);\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'analise_texto';\n  }\n}\n\n// ========== RETORNA TUDO ==========\nreturn [{\n  json: {\n    // IDs dos campos\n    ativar_ia_id: ativarIAField?.id || null,\n    especialista_motive_id: especialistaMotiveField?.id || null,\n    objetivo_lead_id: objetivoLeadField?.id || null,\n    \n    // IDs da conversa\n    conversationId: conversationId,\n    contactId: contactId,\n    \n    // Resultado da detecção\n    resultado: resultado,\n    especialista_motive: especialistaDefinido,\n    objetivo_lead: objetivoDefinido,\n    fonte_deteccao: fonteDeteccao,\n    precisa_perguntar: resultado === 'indefinido',\n    mensagem_original: mensagem,\n    \n    // Debug - opções válidas do GHL\n    opcoes_objetivo_validas: opcoesObjetivoValidas,\n    opcoes_especialista_validas: opcoesEspecialistaValidas\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        34784,
        24944
      ],
      "id": "f0ae8c91-2e74-41b9-a9ff-a1b949311fdb",
      "name": "2️⃣ Extrair IDs dos campos"
    },
    {
      "parameters": {
        "jsCode": "const infoNode = $('Info').first().json;\nconst inputData = $input.first().json;\n\n// ========== 1. EXTRAI CAMPOS CUSTOMIZADOS ==========\nlet customFields = [];\n\nif (Array.isArray(inputData)) {\n  customFields = inputData[0]?.customFields || [];\n} else if (inputData.customFields) {\n  customFields = inputData.customFields;\n}\n\nconst ativarIAField = customFields.find(f => f.fieldKey === \"contact.ativar_ia\");\nconst especialistaMotiveField = customFields.find(f => f.fieldKey === \"contact.contactmotive_responsavel\");\nconst objetivoLeadField = customFields.find(f => f.fieldKey === \"contact.objetivo_do_lead\");\n\n// Pega APENAS opções válidas do GHL (filtra 'x' e vazios)\nconst opcoesObjetivoValidas = (objetivoLeadField?.picklistOptions || []).filter(opt => opt && opt.toLowerCase() !== 'x');\nconst opcoesEspecialistaValidas = (especialistaMotiveField?.picklistOptions || []).filter(opt => opt && opt.toLowerCase() !== 'x');\n\n// ========== 2. EXTRAI CONVERSATION ID E SOURCE ==========\nlet conversationId = null;\nlet contactId = infoNode.lead_id || null;\nlet source = (infoNode.source || infoNode.channel || '').toLowerCase();\n\nif (inputData.conversations && inputData.conversations.length > 0) {\n  conversationId = inputData.conversations[0].id;\n  contactId = inputData.body?.contact_id || inputData.conversations[0].contactId || contactId;\n}\n\n// ========== 3. DETECTA OBJETIVO ==========\nfunction getString(valor) {\n  if (!valor) return '';\n  if (typeof valor === 'string') return valor;\n  if (typeof valor === 'object') {\n    return valor.text || valor.message || valor.content || '';\n  }\n  return String(valor);\n}\n\nconst mensagem = getString(infoNode.message || infoNode.body).toLowerCase();\nconst objetivoDoLead = getString(infoNode.objetivo_do_lead).toLowerCase();\nconst especialistaMotive = getString(infoNode.contactmotive_responsavel).toLowerCase();\nconst informacoesIA = getString(infoNode.informaes_para_ai).toLowerCase();\n\nconst keywordsCarreira = ['carreira', 'recrutamento', 'recrutar', 'vaga', 'emprego', 'trabalho'];\nconst keywordsConsultoria = ['consultoria', 'consultor', 'mentor', 'mentoria'];\n\nfunction contemKeyword(texto, keywords) {\n  return keywords.some(kw => texto.includes(kw));\n}\n\nfunction detectarObjetivo(texto) {\n  if (contemKeyword(texto, keywordsCarreira)) return 'carreira';\n  if (contemKeyword(texto, keywordsConsultoria)) return 'consultoria';\n  return null;\n}\n\nfunction getEspecialista(objetivo) {\n  if (objetivo === 'carreira') return 'sdrcarreira';\n  if (objetivo === 'consultoria') return 'sdrconsultoria';\n  return '';\n}\n\n// Verifica se opções válidas existem no GHL\nconst temOpcoesValidas = opcoesObjetivoValidas.length > 0;\n\nconst textoCompleto = `${mensagem} ${objetivoDoLead} ${especialistaMotive} ${informacoesIA}`;\n\nconst regexTeste = /\\/teste\\s+(carreira|recrutamento|consultoria|consultor|mentor)/i;\nconst matchTeste = mensagem.match(regexTeste);\n\nlet resultado = 'indefinido';\nlet especialistaDefinido = '';\nlet objetivoDefinido = '';\nlet fonteDeteccao = 'nenhuma';\n\n// SÓ DETECTA SE TIVER OPÇÕES VÁLIDAS NO GHL\nif (temOpcoesValidas) {\n  \n  // Prioridade 1: Comando /teste na mensagem\n  if (matchTeste) {\n    const objetivoDetectado = detectarObjetivo(matchTeste[1].toLowerCase());\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'comando_teste';\n    }\n  }\n\n  // Prioridade 2: Campo objetivo_do_lead já preenchido COM VALOR VÁLIDO\n  if (resultado === 'indefinido' && objetivoDoLead && opcoesObjetivoValidas.includes(objetivoDoLead)) {\n    resultado = objetivoDoLead;\n    especialistaDefinido = getEspecialista(objetivoDoLead);\n    objetivoDefinido = objetivoDoLead;\n    fonteDeteccao = 'campo_objetivo';\n  }\n\n  // Prioridade 3: Especialista já definido\n  if (resultado === 'indefinido' && especialistaMotive) {\n    const objetivoDetectado = detectarObjetivo(especialistaMotive);\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'campo_especialista';\n    }\n  }\n\n  // Prioridade 4: Análise do texto completo\n  if (resultado === 'indefinido') {\n    const objetivoDetectado = detectarObjetivo(textoCompleto);\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'analise_texto';\n    }\n  }\n}\n\n// ========== RETORNA TUDO ==========\nreturn [{\n  json: {\n    // IDs dos campos\n    ativar_ia_id: ativarIAField?.id || null,\n    especialista_motive_id: especialistaMotiveField?.id || null,\n    objetivo_lead_id: objetivoLeadField?.id || null,\n    \n    // IDs da conversa\n    conversationId: conversationId,\n    contactId: contactId,\n    source: source,\n    \n    // Resultado da detecção\n    resultado: resultado,\n    especialista_motive: especialistaDefinido,\n    objetivo_lead: objetivoDefinido,\n    fonte_deteccao: fonteDeteccao,\n    precisa_perguntar: resultado === 'indefinido',\n    mensagem_original: mensagem,\n    \n    // Debug\n    opcoes_ghl_validas: opcoesObjetivoValidas,\n    tem_opcoes_validas: temOpcoesValidas\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        35008,
        24944
      ],
      "id": "03d4c9ba-184b-4eae-a057-5fe039e0bfe7",
      "name": "3️⃣ Detectar Objetivo"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.resultado }}",
                    "rightValue": "carreira",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "76eef0e3-72b2-4beb-8523-04aca6b0f026"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Carreira"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.resultado }}",
                    "rightValue": "consultoria",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "68e4057a-3f5f-4b5e-990c-52b9618888a4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Consultoria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.resultado }}",
                    "rightValue": "indefinido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cb77dbef-ac1e-4b2a-a6f0-f011e353e870"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Indefinido"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        35232,
        24928
      ],
      "id": "f17e43e4-0442-41c8-9da0-6b4ffbf6c602",
      "name": "4️⃣ Switch Objetivo"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.especialista_motive_id }}\",\n      \"value\": \"sdrcarreira\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.objetivo_lead_id }}\",\n      \"value\": \"carreira\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.ativar_ia_id }}\",\n      \"value\": \"sim\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35456,
        24752
      ],
      "id": "1c7aef33-4277-43fe-ace4-076960794765",
      "name": "5️⃣ Atualizar → Carreira"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.especialista_motive_id }}\",\n      \"value\": \"sdrconsultoria\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.objetivo_lead_id }}\",\n      \"value\": \"consultoria\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.ativar_ia_id }}\",\n      \"value\": \"sim\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35456,
        24944
      ],
      "id": "e2aa88f7-f029-4e08-80d1-b3576d0ff448",
      "name": "5️⃣ Atualizar → Consultoria"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Olá! Para continuar, preciso saber seu objetivo. Por favor, responda:\\n\\n/teste carreira - para oportunidades de emprego\\n/teste consultoria - para serviços de consultoria\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35680,
        25040
      ],
      "id": "61595282-bd56-44c9-8e86-2f001575a71c",
      "name": "5️⃣ Perguntar Objetivo (SMS)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        35456,
        25136
      ],
      "id": "5396fe99-35fc-4ada-b4d4-1501bc2949ea",
      "name": "Canal4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Olá! Para continuar, preciso saber seu objetivo. Por favor, responda:\\n\\n/teste carreira - para oportunidades de emprego\\n/teste consultoria - para serviços de consultoria\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35680,
        25232
      ],
      "id": "b616168f-4e5d-4747-9506-a7c642625935",
      "name": "Instagram4",
      "retryOnFail": true
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            },
            {
              "id": "message_hash",
              "displayName": "message_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35856,
        25568
      ],
      "id": "0fc20434-a4e4-48d6-a76d-cf839a284f00",
      "name": "Resetar status atendimento",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const customData = $input.first().json.body?.customData || $input.first().json.customData || {};\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst anexo = (\n  customData.attachments || \n  customData.photo_audio || \n  body.attachments ||\n  body.photo_audio ||\n  ''\n).toLowerCase();\n\nlet tipo_mensagem_original = 'texto';\n\n// Imagens\nif (anexo.includes('.jpg') || anexo.includes('.jpeg') || anexo.includes('.png') || anexo.includes('.gif') || anexo.includes('.webp')) {\n  tipo_mensagem_original = 'imagem';\n}\n// PDF\nelse if (anexo.includes('.pdf')) {\n  tipo_mensagem_original = 'pdf';\n}\n// Planilhas e CSV\nelse if (anexo.includes('.csv') || anexo.includes('.xls') || anexo.includes('.xlsx')) {\n  tipo_mensagem_original = 'planilha';\n}\n// Áudio - AGORA INCLUI .MP4\nelse if (anexo.includes('.mp3') || anexo.includes('.ogg') || anexo.includes('.wav') || anexo.includes('.m4a') || anexo.includes('.opus') || anexo.includes('.mp4')) {\n  tipo_mensagem_original = 'audio';\n}\n// Documentos Word\nelse if (anexo.includes('.doc') || anexo.includes('.docx')) {\n  tipo_mensagem_original = 'documento_word';\n}\n\nreturn {\n  ...$input.first().json,\n  tipo_mensagem_original,\n  anexo_url: anexo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33456,
        26496
      ],
      "id": "af9100a5-1daa-4866-9cc6-7b9458f4ed88",
      "name": "Classificar Tipo Mensagem"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "reset-cmd",
                    "leftValue": "={{ $('Info').item.json.mensagem }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/reset"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "teste-cmd",
                    "leftValue": "={{ $('Info').item.json.mensagem }}",
                    "rightValue": "/teste",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/teste"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "texto-check",
                    "leftValue": "={{ $('Info').item.json.tipo_mensagem_original }}",
                    "rightValue": "texto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "msg-existe",
                    "leftValue": "={{ !!$('Info').item.json.mensagem && $('Info').item.json.mensagem.length > 0 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "imagem-check",
                    "leftValue": "={{ $('Info').item.json.tipo_mensagem_original }}",
                    "rightValue": "imagem",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "audio-check",
                    "leftValue": "={{ $('Info').item.json.tipo_mensagem_original }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Áudio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b8885ae3-133c-41d0-97e1-04b3daa9cc38",
                    "leftValue": "={{ $('Info').item.json.tipo_mensagem_original }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "empty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mensagem vazia"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34144,
        26448
      ],
      "id": "5768002f-9723-4ed5-82a4-5ab80b523665",
      "name": "Tipo de mensagem",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "734cd3ca-c411-46fe-8924-1ea800f80804",
              "name": "mensagem",
              "value": "={{ ($json.body?.message?.body || '').trim() || $json.mensagem_contexto || ($json.body?.customData?.message?.split(\"Instance Source:\")[0] ?? $json.body?.message?.content?.text ?? '').trim() }}",
              "type": "string"
            },
            {
              "id": "ccb3a74d-0336-4a28-9f43-7bdaff77b906",
              "name": "source",
              "value": "={{ \n  // Prioriza o canal da mensagem ATUAL, não a origem do lead\n  (() => {\n    const messageType = $json.body?.message?.type;\n    \n    // Type 2 = SMS - responde por SMS (usa \"whatsapp\" que no seu workflow envia SMS)\n    if (messageType === 2) return \"whatsapp\";\n    \n    // Type 15 = Instagram DM - pode responder por Instagram\n    if (messageType === 15) return \"instagram\";\n    \n    // Se não conseguir identificar pelo type, verifica a origem\n    // mas só usa Instagram se o type não for SMS\n    const origin = $json.body?.contact?.attributionSource?.medium;\n    if (origin === \"instagram\" && messageType !== 2 && messageType !== 20) return \"instagram\";\n    \n    // Default: SMS/WhatsApp (mais seguro)\n    return \"whatsapp\";\n  })().trim()\n}}",
              "type": "string"
            },
            {
              "id": "332d6a13-10c8-465f-8ddb-fa97266f9fec",
              "name": "first_name",
              "value": "={{ $json.first_name }}",
              "type": "string"
            },
            {
              "id": "60cb5031-9132-4c86-9ab7-c487a170c9e3",
              "name": "last_name",
              "value": "={{ $json.last_name }}",
              "type": "string"
            },
            {
              "id": "9d4ae7a5-635b-4dbc-93d1-9464ace3208c",
              "name": "email",
              "value": "={{ $json.body?.email }}",
              "type": "string"
            },
            {
              "id": "d6301da3-de8a-45e3-9705-32cf65c3bf1e",
              "name": "telefone",
              "value": "={{ $json.body?.customData?.phone }}",
              "type": "string"
            },
            {
              "id": "7e094af2-d305-42ba-b6d2-014b62231ebb",
              "name": "datetime",
              "value": "={{ $json.body?.date_created }}",
              "type": "string"
            },
            {
              "id": "f3471b65-9533-4f5c-a669-60aaf549b4e8",
              "name": "process_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "257ef1e2-26bb-461e-8335-3d1101d3cda6",
              "name": "owner_origin",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "1e235f54-27cf-4b91-b156-1c0a69149370",
              "name": "owner_id",
              "value": "=cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "5041121e-02b1-4993-ad9c-34131a44b08d",
              "name": "timezone_do_lead",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "367c6400-fd93-4f50-a09b-b2d56aea0bd9",
              "name": "lead_id",
              "value": "={{ $json.body?.contact_id }}",
              "type": "string"
            },
            {
              "id": "66a3f763-5dbe-4033-abd7-3079835a035a",
              "name": "mensagem_id",
              "value": "={{ $json.starttimeMs }}",
              "type": "string"
            },
            {
              "id": "110eb8f6-d0b2-4358-a002-3741abbcfeb7",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "ab843596-5dfa-41d7-8ac4-02cd1dd5b661",
              "name": "api_key",
              "value": "={{ $json.body?.customData?.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "8be8461d-83f1-4563-9e2e-46e978d3afb4",
              "name": "location_id",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "3df2e105-88b1-4d12-b957-6b5d909056be",
              "name": "tipo",
              "value": "={{ $json.body?.customData?.tipo }}",
              "type": "string"
            },
            {
              "id": "d1fa8d84-c23b-4292-86bc-2066e14c7882",
              "name": "calendarID_carreira",
              "value": "={{ $json.body?.customData?.calendar_id_carreira }}",
              "type": "string"
            },
            {
              "id": "cca7fe8b-af83-40c1-ba8b-d4de7cd21c47",
              "name": "calendarID_consultoria_financeira",
              "value": "={{ $json.body?.customData?.consultoria_financeira }}",
              "type": "string"
            },
            {
              "id": "dad6c1f3-82b2-45ea-b3be-c512a879ac98",
              "name": "origem_teste",
              "value": "Marcos Danielss",
              "type": "string"
            },
            {
              "id": "3038f1ef-1199-4aab-9354-dc9463c775de",
              "name": "etiquetas",
              "value": "={{ $json.body?.tags }}",
              "type": "string"
            },
            {
              "id": "4100931a-e49b-4b97-8a16-7a797b67899e",
              "name": "area_de_atuacao",
              "value": "={{ $json.body?.['Qual a sua área de atuação?']?.[0] }}",
              "type": "string"
            },
            {
              "id": "4ed525e0-9bb6-4663-980a-70a10db813d4",
              "name": "idade",
              "value": "={{ $json.body?.Idade }}",
              "type": "string"
            },
            {
              "id": "b14c96ea-7093-48b6-add5-dd0159af29cd",
              "name": "instagram",
              "value": "={{ $json.body?.Instagram }}",
              "type": "string"
            },
            {
              "id": "9d450e98-e0e3-48fb-bb77-41c6d701f227",
              "name": "modelo_de_atuacao",
              "value": "={{ $json.body?.['Modelo de atuação'] }}",
              "type": "string"
            },
            {
              "id": "69b88a48-6d28-42b1-8ff4-5120e516f348",
              "name": "faturamento_medio",
              "value": "={{ $json.body?.['Faturamento médio'] }}",
              "type": "string"
            },
            {
              "id": "35274cdc-7a80-4945-9296-5d74db32aff2",
              "name": "investimento",
              "value": "={{ $json.body?.Investimento }}",
              "type": "string"
            },
            {
              "id": "247f2856-13b1-4bc4-bb55-cf7842680459",
              "name": "event_chat",
              "value": "={{ $json.body?.event?.Info?.Chat }}",
              "type": "string"
            },
            {
              "id": "dda2ed54-8e91-41e2-92c9-1b2d12763e2b",
              "name": "event_is_group",
              "value": "={{ $json.body?.event?.Info?.IsGroup }}",
              "type": "boolean"
            },
            {
              "id": "b9e46b5c-3fb8-4be2-bb9e-71080728bd85",
              "name": "video_ads_url",
              "value": "={{ $json.body?.contact?.attributionSource?.videoUrl }}",
              "type": "string"
            },
            {
              "id": "16308ff3-20b3-4fd4-b126-21c34248530b",
              "name": "time_zone_do_agente",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "2566e00f-ecfd-44e8-bab2-7d68447e3b9a",
              "name": "historia_do_usuario",
              "value": "={{ $json.body?.customData?.minha_historias }}",
              "type": "string"
            },
            {
              "id": "391cb65e-46a0-475b-8c42-3629883ad983",
              "name": "usuario_responsavel",
              "value": "={{ $json.body?.user?.firstName }} {{ $json.body?.user?.lastName }}",
              "type": "string"
            },
            {
              "id": "1cd51504-1dc9-4aea-956a-9a4757db1b6c",
              "name": "photo_audio",
              "value": "={{ $json.body?.customData?.photo_audio?.split(',')[0]?.trim() }}",
              "type": "string"
            },
            {
              "id": "77c42ca4-2ef7-4a40-b1ed-2fc5e8af7292",
              "name": "fonte_do_lead_bposs",
              "value": "={{ $json.body?.customData?.fonte_do_lead_bposs }}",
              "type": "string"
            },
            {
              "id": "a976a2ec-ed9f-452b-91d1-5725631ae2d5",
              "name": "quebra_de_objecoes_geral",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_geral }}",
              "type": "string"
            },
            {
              "id": "cc085a35-fef6-47b9-ad97-e9d671a71d29",
              "name": "quebra_de_objecoes_carreira",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_carreira }}",
              "type": "string"
            },
            {
              "id": "8f3c6a4d-df4f-4de7-ad41-0177eb567ed4",
              "name": "quebra_de_objecoes_consultoria",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_consultoria }}",
              "type": "string"
            },
            {
              "id": "03c2a02f-e2c2-4d42-afe3-3d6b7bfae375",
              "name": "tipos_work_permit_permitidos",
              "value": "={{ $json.body?.customData?.estruturas_work_permit }}",
              "type": "string"
            },
            {
              "id": "2d89fd62-be99-4c63-9bf9-c2b97c0cc735",
              "name": "link_do_zoom",
              "value": "={{ $json.body?.customData?.link_do_zoom }}",
              "type": "string"
            },
            {
              "id": "939d130d-8780-41e6-9693-10b83cd9bab5",
              "name": "agendamento_duracao_minutos",
              "value": "30",
              "type": "string"
            },
            {
              "id": "c9a26bfa-ced7-4b82-a6bb-2c0aeb46f9a3",
              "name": "cobranca_valor",
              "value": "500",
              "type": "string"
            },
            {
              "id": "9290e4ff-d01b-4fca-b5f3-7605d4f74c07",
              "name": "id_conversa_alerta",
              "value": "skfa6JP6lLlAXkc8FfIp",
              "type": "string"
            },
            {
              "id": "c594a0f2-aba9-458c-92ff-81e73086416c",
              "name": "url_asaas",
              "value": "https://api-sandbox.asaas.com",
              "type": "string"
            },
            {
              "id": "103fad86-a8b6-4591-b310-2dc7069bc189",
              "name": "etapa_funil",
              "value": "={{ $json.body?.customData?.etapa_funil }}",
              "type": "string"
            },
            {
              "id": "3ae92580-436d-4dfc-a7cc-f83f8f68309e",
              "name": "full_name",
              "value": "={{ $json.nome_completo }}",
              "type": "string"
            },
            {
              "id": "5476f99e-273b-45a1-996f-b98cb86ddd25",
              "name": "work_permit",
              "value": "={{ $json.body?.customData?.work_permit }}",
              "type": "string"
            },
            {
              "id": "989fb582-9e56-4962-8883-6076627c72b5",
              "name": "state",
              "value": "={{ $json.body?.customData?.state }}",
              "type": "string"
            },
            {
              "id": "15265189-0d84-420c-b7da-6181170a6b08",
              "name": "location_name",
              "value": "={{ $json.body?.location?.name }}",
              "type": "string"
            },
            {
              "id": "5770d76c-1a0f-4515-9683-381881715eb5",
              "name": "resposta_ia",
              "value": "={{ $json.body?.['Resposta IA'] }}",
              "type": "string"
            },
            {
              "id": "b1871710-95d0-495d-9592-ff09ea8ab983",
              "name": "objetivo_do_lead",
              "value": "={{ $json.objetivo_do_lead }}",
              "type": "string"
            },
            {
              "id": "5a729725-994d-46e5-a6f1-aac7b9504a3a",
              "name": "ativar_ia",
              "value": "={{ $json.ativar_ia }}",
              "type": "string"
            },
            {
              "id": "5e293330-4c28-4ae8-92ef-e99bc9feb55e",
              "name": "utm_content",
              "value": "={{ $json.utm_content }}",
              "type": "string"
            },
            {
              "id": "7d94c551-b241-48e8-84e8-9ab152f6a526",
              "name": "agente_ia",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_ia }}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "mensagem_contexto",
              "value": "={{ $json.mensagem_contexto }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "is_primeira_mensagem",
              "value": "={{ $json.is_primeira_mensagem }}",
              "type": "boolean"
            },
            {
              "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
              "name": "tipo_lead",
              "value": "={{ $json.tipo_lead }}",
              "type": "string"
            },
            {
              "id": "301166ea-a33e-4fa8-a1ec-3a3a0fd00923",
              "name": "tipo_mensagem_original",
              "value": "={{ \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.ogg') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp3') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.opus') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp4') || \n  ($('Mensagem recebida').item.json.body.customData?.message || '').startsWith('Mensagem de Áudio') \n    ? 'audio' \n    : ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpeg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.png') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.webp') \n        ? 'imagem' \n        : 'texto' \n}}",
              "type": "string"
            },
            {
              "id": "368ffdd1-2395-4632-b738-e35ebfbe0832",
              "name": "body.customData.ghl_api_key",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "f5ad43c1-fbe7-417a-bd52-9cfa52294c74",
              "name": "agente_versionado",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_versionado }}",
              "type": "string"
            },
            {
              "id": "714f3406-1a5c-43e7-99e1-a5d853d7e38d",
              "name": "agenda_consultorio_sao_paulo",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda consultorio sao paulo'] }}",
              "type": "string"
            },
            {
              "id": "6cb38978-9095-486b-b775-58ab8839c366",
              "name": "agenda_presidente_prudente",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda presidente prudente'] }}",
              "type": "string"
            },
            {
              "id": "b28742cf-e1f5-4257-9dd4-8109c07fb7a3",
              "name": "agenda_consulta_online",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda online'] }}",
              "type": "string"
            },
            {
              "id": "e484881e-587d-4779-b712-6d8e6758456a",
              "name": "utm_campaign",
              "value": "={{ $('Mensagem recebida').item.json.body.contact.lastAttributionSource.utmSource }}",
              "type": "string"
            },
            {
              "id": "4ca80da6-382f-4ba0-8cdb-8b106528da17",
              "name": "utm_content",
              "value": "={{ $('Mensagem recebida').item.json.body.contact.lastAttributionSource.utmContent }}",
              "type": "string"
            },
            {
              "id": "1f44746f-f362-4236-83bf-410203bdb89e",
              "name": "form_procurou_ajuda_medica",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Procurou ajuda medica\"] }}",
              "type": "string"
            },
            {
              "id": "e50e0483-b8df-41dc-aa98-9fbf147d805f",
              "name": "form_sintomas_atualmente",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Sintomas atualmente\"] }}",
              "type": "string"
            },
            {
              "id": "846fa257-3db8-4d78-9f11-702bf9b19c61",
              "name": "form_acredita_em_alteração_hormonal",
              "value": "={{ $('Mensagem recebida').item.json.body[\"acredita em alteração hormonal\"] }}",
              "type": "string"
            },
            {
              "id": "1441d8fd-2d84-4a6f-9d04-c5802c5bf2a6",
              "name": "form_udança_no_corpo",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Mudança no corpo\"] }}",
              "type": "string"
            },
            {
              "id": "0a844d42-978b-4713-aae8-84a05f2359e3",
              "name": "form_tipo_de_consulta",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Tipo de consulta\"] }}",
              "type": "string"
            },
            {
              "id": "addf25d3-00f6-45e5-a6c9-3236b52cabfd",
              "name": "form_interessado_em_investir",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Interessado em investir\"] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33584,
        26496
      ],
      "id": "7ff7e910-72ce-4d6d-9970-20209d01ea26",
      "name": "Info"
    },
    {
      "parameters": {
        "jsCode": "const start = new Date();\nstart.setDate(start.getDate() + 15);\nconst starttimeISO = start.toISOString();\nconst starttimeMs = start.getTime();\n\nconst end = new Date(start);\nend.setDate(end.getDate() + 15);\nconst endtimeISO = end.toISOString();\nconst endtimeMs = end.getTime();\n\nconst inputData = $input.first().json;\n\nreturn [{\n  json: {\n    ...inputData,\n    starttimeISO,\n    starttimeMs,\n    endtimeISO,\n    endtimeMs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33312,
        26496
      ],
      "id": "aa9bae0e-f050-4c50-a117-278f7dd461aa",
      "name": "Code1"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "contact_id",
              "value": "={{ $json.body.contact_id }}"
            },
            {
              "key": "location_name",
              "value": "={{ $json.body.location.name }}"
            },
            {
              "key": "agente_ia",
              "value": "={{ $json.agente_ia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        33120,
        26496
      ],
      "id": "20548ae6-68ad-4d20-800d-e477d4511ee7",
      "name": "Execution Data5"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar dados do lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst customData = body.customData || {};\nconst tags = (body.tags || '').toLowerCase();\nconst utmContent = body.contact?.attributionSource?.utmContent || '';\n\n// === OBJETIVO DO LEAD ===\nlet objetivo_do_lead = customData.objetivodolead || '';\n\nif (!objetivo_do_lead) {\n  if (tags.includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (tags.includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else if (utmContent.toLowerCase().includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (utmContent.toLowerCase().includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else {\n    objetivo_do_lead = 'indefinido'; // ✅ Não assume mais 'carreira' como padrão\n  }\n}\n\n// === AGENTE IA ===\nlet agente_ia = customData.motive || '';\n\nif (!agente_ia) {\n  // Verifica tags específicas\n  if (tags.includes('closer')) {\n    agente_ia = 'closer';\n  } else if (tags.includes('followuper')) {\n    agente_ia = 'followuper';\n  } else if (objetivo_do_lead === 'consultoria') {\n    agente_ia = 'sdrconsultoria';\n  } else if (objetivo_do_lead === 'carreira') {\n    agente_ia = 'sdrcarreira';\n  } else {\n    agente_ia = 'indefinido'; // ✅ Leads sem classificação clara\n  }\n}\n// ✅ Se customData.motive vier com 'assistente_admin' ou 'assistente_interno', \n//    mantém o valor original\n\n// === ATIVAR IA ===\nlet ativar_ia = customData.ativar_ia || '';\n\nif (tags.includes('perdido')) {\n  ativar_ia = 'nao';\n} else if (utmContent) {\n  ativar_ia = 'sim';\n} else if (ativar_ia === 'sim' || tags.includes('ativar_ia')) {\n  ativar_ia = 'sim';\n} else {\n  ativar_ia = 'nao';\n}\n\nreturn {\n  json: {\n    ...inputData,\n    objetivo_do_lead,\n    agente_ia,\n    ativar_ia,\n    utm_content: utmContent,\n    tags_original: body.tags\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32896,
        26496
      ],
      "id": "4d1893ef-9a99-4d31-9833-ad28d1bda5b4",
      "name": "Normalizar Dados1"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar Nome do Lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\n\nlet nome = body.full_name || ((body.first_name || '') + ' ' + (body.last_name || '')).trim() || body.customData?.name || '';\nconst nomeOriginal = nome;\n\nnome = nome.replace(/\\d+/g, '').trim();\nnome = nome.replace(/[_\\-.@]/g, ' ').trim();\nnome = nome.replace(/([a-z])([A-Z])/g, '$1 $2');\n\nconst apelidosCurtos = ['lu', 'le', 'li', 'jo', 'ze', 'ma', 'mi', 'ju', 'du', 'bi', 'ca', 'ka', 'fe', 'be', 'ne', 're', 'ra', 'ro', 'vi', 'va', 'na', 'ni', 'ta', 'ti', 'la', 'lo', 'ed', 'el'];\n\nfunction separarApelidoSobrenome(str) {\n  if (str.includes(' ')) return str;\n  if (str.length <= 10) return str;\n  const lower = str.toLowerCase();\n  for (let len = 2; len <= 3; len++) {\n    const possivel = lower.slice(0, len);\n    if (apelidosCurtos.includes(possivel)) {\n      const resto = str.slice(len);\n      if (resto.length >= 4) return str.slice(0, len) + ' ' + resto;\n    }\n  }\n  return str;\n}\n\nnome = separarApelidoSobrenome(nome);\nnome = nome.replace(/\\s+/g, ' ').trim();\n\nfunction capitalizar(str) {\n  const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  return str.toLowerCase().split(' ').map((palavra, i) => {\n    if (i > 0 && preposicoes.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n}\n\nlet partes = nome.split(' ').filter(p => p.length > 0);\nlet firstName = partes[0] || nome || '';\nlet lastName = partes.slice(1).join(' ') || '';\n\nfirstName = capitalizar(firstName);\nlastName = capitalizar(lastName);\n\nconst tinhaNumero = /\\d/.test(nomeOriginal);\nconst qualidade = (firstName.length < 2 || tinhaNumero) ? 'revisar' : 'ok';\n\nreturn {\n  json: {\n    ...inputData,\n    nome_original: nomeOriginal,\n    first_name: firstName,\n    last_name: lastName,\n    nome_completo: lastName ? `${firstName} ${lastName}` : firstName,\n    qualidade_nome: qualidade\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32672,
        26496
      ],
      "id": "adbe6138-18bb-4c84-bc44-ef13121a4f78",
      "name": "Normalizar Nome1"
    },
    {
      "parameters": {
        "jsCode": "// Contexto Inicial do Lead baseado em UTM\nconst input = $input.first().json.body;\n\nconst utmContent = input.contact?.attributionSource?.utmContent || '';\nconst messageBody = (input.message?.body || '').trim();\nconst isPrimeiraMensagem = !messageBody || messageBody === '' || messageBody === ' ';\n\nconst contextoPorUTM = {\n  'CARREIRA': {\n    contexto: 'Lead interessado em CARREIRA no mercado financeiro americano',\n    interesse: 'Oportunidades de carreira como agente de seguros nos EUA',\n    abordagem: 'Falar sobre licenciamento, ganhos, estrutura de trabalho'\n  },\n  'CONSULTORIA': {\n    contexto: 'Lead interessado em CONSULTORIA financeira pessoal',\n    interesse: 'Planejamento financeiro, proteção patrimonial, seguros',\n    abordagem: 'Falar sobre benefícios, proteção familiar, investimentos'\n  },\n  'INVESTIMENTO': {\n    contexto: 'Lead interessado em INVESTIMENTOS',\n    interesse: 'Opções de investimento e crescimento patrimonial',\n    abordagem: 'Falar sobre produtos financeiros, retornos, segurança'\n  }\n};\n\nlet tipoLead = '';\nfor (const tipo of Object.keys(contextoPorUTM)) {\n  if (utmContent.toUpperCase().includes(tipo)) {\n    tipoLead = tipo;\n    break;\n  }\n}\n\nlet mensagemContexto = '';\nlet contextoObj = null;\n\nif (isPrimeiraMensagem && tipoLead) {\n  contextoObj = contextoPorUTM[tipoLead];\n  mensagemContexto = `[CONTEXTO DO LEAD]\\nTipo: ${tipoLead}\\n${contextoObj.contexto}\\nInteresse principal: ${contextoObj.interesse}\\nAbordagem sugerida: ${contextoObj.abordagem}\\n\\nWork Permit: ${input['Work Permit'] || input.customData?.work_permit || 'Não informado'}\\nEstado: ${input['Estado onde mora'] || 'Não informado'}\\n`;\n}\n\nreturn {\n  json: {\n    body: input,\n    is_primeira_mensagem: isPrimeiraMensagem,\n    tem_contexto_utm: !!tipoLead,\n    tipo_lead: tipoLead || 'NAO_IDENTIFICADO',\n    utm_content: utmContent,\n    mensagem_contexto: mensagemContexto,\n    mensagem_original: messageBody,\n    work_permit: input['Work Permit'] || input.customData?.work_permit || '',\n    estado: input['Estado onde mora'] || '',\n    contexto_para_ai: isPrimeiraMensagem && contextoObj ? contextoObj : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32448,
        26496
      ],
      "id": "8d613f43-5c5e-4ce8-aea5-72b2e4cbfdbd",
      "name": "Contexto UTM"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ativar-ia-check",
              "leftValue": "={{ $json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "80f34e52-b954-48d7-b92a-fb1c95652f9b",
              "leftValue": "={{ $json.etiquetas }}",
              "rightValue": "assistente-admin",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        33936,
        26496
      ],
      "id": "541e85bb-e65e-4a6b-8426-75c02428fd38",
      "name": "IA Ativa?"
    },
    {
      "parameters": {
        "content": "# Tratando input\n",
        "height": 540,
        "width": 1060
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32928,
        26320
      ],
      "id": "a1a6540b-8922-46c0-bf1c-0c2813e299a3",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "790a5682-0b9a-413b-9626-01f6d49c4206",
              "name": "mensagem",
              "value": "={{ $('In3fo').item.json.mensagem }}",
              "type": "string"
            },
            {
              "id": "df7207e1-10cf-4fc8-be3e-58a2cbe6768b",
              "name": "api_key",
              "value": "={{ $('Info').item.json.api_key }}",
              "type": "string"
            },
            {
              "id": "fff142a6-bb90-419c-ac87-4be400fccc5e",
              "name": "location_id",
              "value": "={{ $('Info').item.json.location_id }}",
              "type": "string"
            },
            {
              "id": "42e917b9-b94a-427f-ad56-488d1e838eb8",
              "name": "location_name",
              "value": "={{ $('Info').item.json.location_name }}",
              "type": "string"
            },
            {
              "id": "206bb985-a330-4859-9352-2205d5c23553",
              "name": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}",
              "type": "string"
            },
            {
              "id": "a0ae9724-d22a-4e0b-abd9-944d1819d289",
              "name": "photo_audio",
              "value": "={{ $('Info').item.json.photo_audio }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        34352,
        26768
      ],
      "id": "bae526d1-b244-4904-9b1f-8772bf70ad41",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst outputText = data.output || '';\n\n// ========================================\n// ESTIMATIVA DE TOKENS - CALIBRADO v2\n// ========================================\n\n// Completion: 3.4 chars por token\nconst CHARS_POR_TOKEN_OUTPUT = 3.4;\n\n// Prompt: calibrado com média dos seus dados reais\n// 9922, 9962, 10042 -> média ~9975, arredondando pra 10050\nconst PROMPT_TOKENS_BASE = 10050;\n\n// Calcular completion tokens\nconst completionTokens = Math.ceil(outputText.length / CHARS_POR_TOKEN_OUTPUT);\n\nconst promptTokens = PROMPT_TOKENS_BASE;\nconst totalTokens = promptTokens + completionTokens;\n\n// ========================================\n// CÁLCULO DE CUSTO - Gemini 2.5 Pro\n// ========================================\nconst PRECO_INPUT = 1.25;\nconst PRECO_OUTPUT = 5.00;\n\nconst custoInput = (promptTokens / 1000000) * PRECO_INPUT;\nconst custoOutput = (completionTokens / 1000000) * PRECO_OUTPUT;\nconst custoTotal = custoInput + custoOutput;\n\nreturn {\n  json: {\n    output: outputText,\n    tokenUsage: {\n      promptTokens: promptTokens,\n      completionTokens: completionTokens,\n      totalTokens: totalTokens,\n      metodo: 'estimativa'\n    },\n    custo_llm: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: promptTokens,\n      tokens_output: completionTokens,\n      tokens_total: totalTokens,\n      custo_usd: parseFloat(custoTotal.toFixed(6)),\n      custo_brl: parseFloat((custoTotal * 6).toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        41008,
        26320
      ],
      "id": "f101ab6a-46a8-4594-9f31-c2d7758a0e14",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "66bb063b-646e-4774-9415-e21a35c7e99b",
              "leftValue": "={{ $json.output }}",
              "rightValue": "<ctrl",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "50ac2eba-f7b0-4477-98e6-f19887142f51",
              "leftValue": "{{ $json.output }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        40544,
        26480
      ],
      "id": "24308672-9341-4d0f-b4c0-43b56e56c09f",
      "name": "Tudo certo?4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH agent AS (\n  SELECT id\n  FROM agent_versions\n  WHERE location_id = '{{ $('Info').first().json.location_id }}'\n    AND is_active = true\n  LIMIT 1\n)\nINSERT INTO agent_conversations (\n  agent_version_id,\n  contact_id,\n  conversation_id,\n  channel,\n  status,\n  outcome,\n  mensagens_total,\n  started_at\n)\nSELECT\n  agent.id,\n  '{{ $('Info').first().json.lead_id }}',\n  '{{ $('Info').first().json.lead_id }}',\n  '{{ $('Info').first().json.source }}',\n  'active',\n  'in_progress',\n  1,\n  NOW()\nFROM agent\nON CONFLICT (contact_id) DO UPDATE SET\n  mensagens_total = agent_conversations.mensagens_total + 1\nRETURNING *;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33760,
        26592
      ],
      "id": "d161cc73-8f89-43c0-90cd-cacfcce114d3",
      "name": "SI - Upsert Conversation",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Cria/atualiza conversa"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_conversation_messages (\n  conversation_id,\n  message_text,\n  is_from_lead,\n  created_at\n)\nSELECT\n  ac.id,\n  '{{ $json.mensagem }}',\n  true,\n  NOW()\nFROM agent_conversations ac\nWHERE ac.contact_id = '{{ $('Info').first().json.lead_id }}'\nLIMIT 1\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        38496,
        26208
      ],
      "id": "52bde644-f3dd-4c43-a380-c224fa8648db",
      "name": "SI - Insert Lead Message",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Mensagem do lead"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_conversation_messages (\n  conversation_id,\n  message_text,\n  is_from_lead,\n  created_at\n)\nSELECT\n  ac.id,\n  '{{ $('Parser Chain').first().json.output.messages.join(\"\") }}',\n  false,\n  NOW()\nFROM agent_conversations ac\nWHERE ac.contact_id = '{{ $('Info').first().json.lead_id }}'\nLIMIT 1\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        44352,
        25968
      ],
      "id": "6591490c-1a4c-4d44-86d7-a529f8373d43",
      "name": "SI - Insert AI Message",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Resposta da IA"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE agent_conversations\nSET\n  outcome = CASE\n    WHEN '{{ $json.etapa_funil }}' IN ('Agendamento Marcado', 'Reagendado') THEN 'scheduled'\n    WHEN '{{ $json.etapa_funil }}' IN ('Perdido', 'No-Show') THEN 'lost'\n    WHEN '{{ $json.etapa_funil }}' IN ('Cliente Ativo', 'Reuniao Realizada', 'Proposta Enviada') THEN 'converted'\n    WHEN '{{ $json.etapa_funil }}' IN ('Qualificado', 'Em Follow-Up') THEN 'warmed'\n    ELSE 'in_progress'\n  END,\n  status = CASE\n    WHEN '{{ $json.etapa_funil }}' IN ('Cliente Ativo', 'Perdido') THEN 'completed'\n    ELSE 'in_progress'\n  END,\n  ended_at = CASE\n    WHEN '{{ $json.etapa_funil }}' IN ('Cliente Ativo', 'Perdido') THEN NOW()\n    ELSE ended_at\n  END,\n  updated_at = NOW()\nWHERE contact_id = '{{ $('Info').first().json.lead_id }}'\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33552,
        27264
      ],
      "id": "c73541d4-a99e-46a9-a393-90899bca9c6e",
      "name": "SI - Update Outcome",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Atualiza outcome"
    },
    {
      "parameters": {
        "content": "## Self-Improving AI Integration\n\n**Como usar estes nos:**\n\n1. **SI - Upsert Conversation**\n   - Conectar APOS o no 'Info'\n   - Executar em PARALELO com o fluxo principal\n\n2. **SI - Insert Lead Message**\n   - Conectar APOS 'historico_mensagens_leads'\n   - Executar em PARALELO\n\n3. **SI - Insert AI Message**\n   - Conectar APOS 'Memoria IA'\n   - Executar em PARALELO\n\n4. **SI - Update Outcome** (Opcional)\n   - Conectar quando etapa do funil muda\n\n**IMPORTANTE:**\n- Os nos usam 'onError: continueRegularOutput' para nao quebrar o fluxo principal\n- Prefixo 'SI' = Self-Improving",
        "height": 544,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32528,
        27168
      ],
      "id": "f68a326a-4d6f-4353-bc01-052947cc1e94",
      "name": "Instrucoes de Integracao"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem do usuário a ser formatada: {{ $('Tipo de mensagem1').first().json.output }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Por favor, gere a saída no seguinte formato JSON:\n{\n  \"messages\": [\n    \"splitedMessage\",\n    \"splitedMessage\",\n    \"splitedMessage\"\n  ]\n}\n\nVocê é especialista em formatação de mensagem para WhatsApp e instagram, trabalhando somente na formatação e não alterando o conteúdo da menssagem. Responda apenas com o texto final, não comente nada e não fale 'sua mensagem formatada', apenas o texto final. Não comente e nem fale por conta própria, apenas pegue a mensagem do usuário e formate.\n\nRecomendado: ideal entre 1-2 mensagens e no max 3.\n\n- Substitua ** por *\n- Remova #\n- remova \\n e quebra de linhas\n- Substitua aspas duplas por aspas simples \" > '\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        42304,
        26416
      ],
      "id": "0efb96b4-4702-4f7a-b728-b88d5c6726cc",
      "name": "Parser Chain",
      "executeOnce": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "toolDescription": "Use essa ferramenta quando o paciente expressar preferência por receber respostas somente em áudio ou somente em texto.",
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ \n  {\n    \"customFields\": {\n      \"preferencia_audio_texto\": $fromAI('preferencia_audio_texto', 'audio | texto | ambos', 'string')\n    }\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        39760,
        26800
      ],
      "id": "e480024c-e740-4ec2-ad11-410b7cd2ad28",
      "name": "Alterar preferencia audio texto"
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para direcionar o atendimento para o gestor responsável.",
        "workflowId": {
          "__rl": true,
          "value": "0r0V3ija6EM88T6E",
          "mode": "list",
          "cachedResultUrl": "/workflow/0r0V3ija6EM88T6E",
          "cachedResultName": "05 - Escalar para humano - SOCIALFY"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api key v2": "={{ $('Info').first().json.api_key }}",
            "telefone": "={{ $('Info').first().json.telefone }}",
            "message": "={{ $('Mensagem encavalada?').first().json.mensagem }}",
            "contact_id": "={{ $('Info').first().json.id_conversa_alerta }}",
            "location.id": "={{ $('Info').first().json.location_id }}",
            "usuario_responsavel": "={{ $('Mensagem recebida').first().json.body.location.name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "api key v2",
              "displayName": "api key v2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "message",
              "displayName": "message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location.id",
              "displayName": "location.id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        39632,
        26800
      ],
      "id": "7bfafc52-8243-4313-bbba-7f034a402890",
      "name": "Escalar humano"
    },
    {
      "parameters": {
        "description": "Use essa ferramenta para refletir sobre algo. Ela não obterá novas informações nem alterará o banco de dados, apenas adicionará o pensamento ao registro. Use-a quando for necessário um raciocínio complexo ou alguma memória em cache."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        39888,
        26800
      ],
      "id": "9b6770fa-7de2-4c54-8ae9-b64bc79a538c",
      "name": "Refletir"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Utilize essa ferramenta para listar os arquivos disponíveis para envio para o usuário.",
        "resource": "fileFolder",
        "returnAll": true,
        "filter": {
          "folderId": {
            "__rl": true,
            "value": "18mSZn8rMAt_9hFpj5oITD1wRLMKHqk0s",
            "mode": "list",
            "cachedResultName": "Arquivos da Secretária v3",
            "cachedResultUrl": "https://drive.google.com/drive/folders/18mSZn8rMAt_9hFpj5oITD1wRLMKHqk0s"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTool",
      "typeVersion": 3,
      "position": [
        40016,
        26800
      ],
      "id": "2bb2567b-ce74-4dbe-a2d9-83e5d8e3056c",
      "name": "Listar arquivos",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "huUvmVlBHgVbw2p1",
          "name": "drive marcos - supabase - supercérebro"
        }
      }
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para atualizar informações no título e descrição do evento.\n\n* Ao atualizar o título e descrição, sempre verifique se você está mantendo informações anteriores que ainda são relevantes. Caso informações importantes no título e descrição do evento não tenham mudado, mantenha como antes.\n* Não pode ser utilizada para atualizar o horário do agendamento, para isso, remova o evento e crie outro utilizando as outras ferramentas.",
        "workflowId": {
          "__rl": true,
          "value": "tB6BNUcIu0SxpA9u",
          "mode": "list",
          "cachedResultUrl": "/workflow/tB6BNUcIu0SxpA9u",
          "cachedResultName": "04.1 Atualizar/Cancelar agendamento"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "telefone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefone', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "startTime": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startTime', ``, 'string') }}",
            "calendar_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar_id', ``, 'string') }}",
            "lead_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_id', ``, 'string') }}",
            "firstName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('firstName', ``, 'string') }}",
            "lastName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lastName', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "calendar_id",
              "displayName": "calendar_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startTime",
              "displayName": "startTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "firstName",
              "displayName": "firstName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lastName",
              "displayName": "lastName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        40144,
        26800
      ],
      "id": "1d942037-5caf-4ef0-bd32-4e778ef6359c",
      "name": "Atualizar agendamento"
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para enviar um arquivo do Google Drive para o usuário.\n",
        "workflowId": {
          "__rl": true,
          "value": "si0lxAyvbgKOoO0g",
          "mode": "list",
          "cachedResultUrl": "/workflow/si0lxAyvbgKOoO0g",
          "cachedResultName": "02. Baixar e enviar arquivo do Google Drive"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "file_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('file_id', ``, 'string') }}",
            "id_conversa": "={{ $('Edit Fields').first().json.conversationId }}",
            "source": "={{ $('Info').first().json.source }}",
            "contact_id": "={{ $('Edit Fields').first().json.contactId }}",
            "api_key": "={{ $('Info').first().json.api_key }}"
          },
          "matchingColumns": [
            "file_id"
          ],
          "schema": [
            {
              "id": "file_id",
              "displayName": "file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "id_conversa",
              "displayName": "id_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        40272,
        26800
      ],
      "id": "21025ec5-7824-4a65-8b9a-3d5bacc3f313",
      "name": "Enviar arquivo"
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para criar uma nova cobrança para o usuário, ou para consultar os dados de uma cobrança já existente.\n\nAntes de criar uma nova cobrança, sempre crie um agendamento para o cliente primeiro.",
        "workflowId": {
          "__rl": true,
          "value": "45POrWnyU2UR7HjQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/45POrWnyU2UR7HjQ",
          "cachedResultName": "06.1 Integração Asaas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "cobranca_valor": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cobranca_valor', `Valor exato da cobrança em reais (ex: 600.00). Consulte sempre a tabela de preços no contexto do negócio/prompt antes de preencher.`, 'number') }}",
            "cobranca_vencimento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cobranca_vencimento', `Data do vencimento no format YYYY-MM-DD. Informar como o dia do agendamento + 7 dias.`, 'string') }}",
            "telefone": "={{ $('Info').first().json.telefone }}",
            "nome": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nome', ``, 'string') }}",
            "cpf": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cpf', ``, 'string') }}",
            "id_conta": "={{ $('Info').first().json.location_id}}",
            "id_contato": "={{ $('Info').first().json.lead_id }}",
            "asaas_id_cliente": "={{ $('Info').first().json.atributos_contato.asaas_id_cliente }}",
            "asaas_id_cobranca": "={{ $('Info').first().json.atributos_contato.asaas_id_cobranca }}",
            "url_asaas": "={{ $('Info').first().json.url_asaas }}",
            "api_key": "={{ $('Info').first().json.api_key }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "cobranca_valor",
              "displayName": "cobranca_valor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "cobranca_vencimento",
              "displayName": "cobranca_vencimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "cpf",
              "displayName": "cpf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id_conta",
              "displayName": "id_conta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id_contato",
              "displayName": "id_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "asaas_id_cliente",
              "displayName": "asaas_id_cliente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "asaas_id_cobranca",
              "displayName": "asaas_id_cobranca",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "url_chatwoot",
              "displayName": "url_chatwoot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "url_asaas",
              "displayName": "url_asaas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        40400,
        26800
      ],
      "id": "787571e0-82e0-45ae-a8e2-aa3608059a84",
      "name": "Criar ou buscar cobranca"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "734cd3ca-c411-46fe-8924-1ea800f80804",
              "name": "mensagem",
              "value": "={{ ($json.body?.message?.body || '').trim() || $json.mensagem_contexto || ($json.body?.customData?.message?.split(\"Instance Source:\")[0] ?? $json.body?.message?.content?.text ?? '').trim() }}",
              "type": "string"
            },
            {
              "id": "ccb3a74d-0336-4a28-9f43-7bdaff77b906",
              "name": "source",
              "value": "={{ \n  // Prioriza o canal da mensagem ATUAL, não a origem do lead\n  (() => {\n    const messageType = $json.body?.message?.type;\n    \n    // Type 2 = SMS - responde por SMS (usa \"whatsapp\" que no seu workflow envia SMS)\n    if (messageType === 2) return \"whatsapp\";\n    \n    // Type 15 = Instagram DM - pode responder por Instagram\n    if (messageType === 15) return \"instagram\";\n    \n    // Se não conseguir identificar pelo type, verifica a origem\n    // mas só usa Instagram se o type não for SMS\n    const origin = $json.body?.contact?.attributionSource?.medium;\n    if (origin === \"instagram\" && messageType !== 2 && messageType !== 20) return \"instagram\";\n    \n    // Default: SMS/WhatsApp (mais seguro)\n    return \"whatsapp\";\n  })().trim()\n}}",
              "type": "string"
            },
            {
              "id": "332d6a13-10c8-465f-8ddb-fa97266f9fec",
              "name": "first_name",
              "value": "={{ $json.first_name }}",
              "type": "string"
            },
            {
              "id": "60cb5031-9132-4c86-9ab7-c487a170c9e3",
              "name": "last_name",
              "value": "={{ $json.last_name }}",
              "type": "string"
            },
            {
              "id": "9d4ae7a5-635b-4dbc-93d1-9464ace3208c",
              "name": "email",
              "value": "={{ $json.body?.email }}",
              "type": "string"
            },
            {
              "id": "d6301da3-de8a-45e3-9705-32cf65c3bf1e",
              "name": "telefone",
              "value": "={{ $json.body?.customData?.phone }}",
              "type": "string"
            },
            {
              "id": "7e094af2-d305-42ba-b6d2-014b62231ebb",
              "name": "datetime",
              "value": "={{ $json.body?.date_created }}",
              "type": "string"
            },
            {
              "id": "f3471b65-9533-4f5c-a669-60aaf549b4e8",
              "name": "process_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "257ef1e2-26bb-461e-8335-3d1101d3cda6",
              "name": "owner_origin",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "1e235f54-27cf-4b91-b156-1c0a69149370",
              "name": "owner_id",
              "value": "=cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "5041121e-02b1-4993-ad9c-34131a44b08d",
              "name": "timezone_do_lead",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "367c6400-fd93-4f50-a09b-b2d56aea0bd9",
              "name": "lead_id",
              "value": "={{ $json.body?.contact_id }}",
              "type": "string"
            },
            {
              "id": "66a3f763-5dbe-4033-abd7-3079835a035a",
              "name": "mensagem_id",
              "value": "={{ $json.starttimeMs }}",
              "type": "string"
            },
            {
              "id": "110eb8f6-d0b2-4358-a002-3741abbcfeb7",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "ab843596-5dfa-41d7-8ac4-02cd1dd5b661",
              "name": "api_key",
              "value": "={{ $json.body?.customData?.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "8be8461d-83f1-4563-9e2e-46e978d3afb4",
              "name": "location_id",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "3df2e105-88b1-4d12-b957-6b5d909056be",
              "name": "tipo",
              "value": "={{ $json.body?.customData?.tipo }}",
              "type": "string"
            },
            {
              "id": "d1fa8d84-c23b-4292-86bc-2066e14c7882",
              "name": "calendarID_carreira",
              "value": "={{ $json.body?.customData?.calendar_id_carreira }}",
              "type": "string"
            },
            {
              "id": "cca7fe8b-af83-40c1-ba8b-d4de7cd21c47",
              "name": "calendarID_consultoria_financeira",
              "value": "={{ $json.body?.customData?.consultoria_financeira }}",
              "type": "string"
            },
            {
              "id": "dad6c1f3-82b2-45ea-b3be-c512a879ac98",
              "name": "origem_teste",
              "value": "Marcos Danielss",
              "type": "string"
            },
            {
              "id": "3038f1ef-1199-4aab-9354-dc9463c775de",
              "name": "etiquetas",
              "value": "={{ $json.body?.tags }}",
              "type": "string"
            },
            {
              "id": "4100931a-e49b-4b97-8a16-7a797b67899e",
              "name": "area_de_atuacao",
              "value": "={{ $json.body?.['Qual a sua área de atuação?']?.[0] }}",
              "type": "string"
            },
            {
              "id": "4ed525e0-9bb6-4663-980a-70a10db813d4",
              "name": "idade",
              "value": "={{ $json.body?.Idade }}",
              "type": "string"
            },
            {
              "id": "b14c96ea-7093-48b6-add5-dd0159af29cd",
              "name": "instagram",
              "value": "={{ $json.body?.Instagram }}",
              "type": "string"
            },
            {
              "id": "9d450e98-e0e3-48fb-bb77-41c6d701f227",
              "name": "modelo_de_atuacao",
              "value": "={{ $json.body?.['Modelo de atuação'] }}",
              "type": "string"
            },
            {
              "id": "69b88a48-6d28-42b1-8ff4-5120e516f348",
              "name": "faturamento_medio",
              "value": "={{ $json.body?.['Faturamento médio'] }}",
              "type": "string"
            },
            {
              "id": "35274cdc-7a80-4945-9296-5d74db32aff2",
              "name": "investimento",
              "value": "={{ $json.body?.Investimento }}",
              "type": "string"
            },
            {
              "id": "247f2856-13b1-4bc4-bb55-cf7842680459",
              "name": "event_chat",
              "value": "={{ $json.body?.event?.Info?.Chat }}",
              "type": "string"
            },
            {
              "id": "dda2ed54-8e91-41e2-92c9-1b2d12763e2b",
              "name": "event_is_group",
              "value": "={{ $json.body?.event?.Info?.IsGroup }}",
              "type": "boolean"
            },
            {
              "id": "b9e46b5c-3fb8-4be2-bb9e-71080728bd85",
              "name": "video_ads_url",
              "value": "={{ $json.body?.contact?.attributionSource?.videoUrl }}",
              "type": "string"
            },
            {
              "id": "16308ff3-20b3-4fd4-b126-21c34248530b",
              "name": "time_zone_do_agente",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "2566e00f-ecfd-44e8-bab2-7d68447e3b9a",
              "name": "historia_do_usuario",
              "value": "={{ $json.body?.customData?.minha_historias }}",
              "type": "string"
            },
            {
              "id": "391cb65e-46a0-475b-8c42-3629883ad983",
              "name": "usuario_responsavel",
              "value": "={{ $json.body?.user?.firstName }} {{ $json.body?.user?.lastName }}",
              "type": "string"
            },
            {
              "id": "1cd51504-1dc9-4aea-956a-9a4757db1b6c",
              "name": "photo_audio",
              "value": "={{ $json.body?.customData?.photo_audio?.split(',')[0]?.trim() }}",
              "type": "string"
            },
            {
              "id": "77c42ca4-2ef7-4a40-b1ed-2fc5e8af7292",
              "name": "fonte_do_lead_bposs",
              "value": "={{ $json.body?.customData?.fonte_do_lead_bposs }}",
              "type": "string"
            },
            {
              "id": "a976a2ec-ed9f-452b-91d1-5725631ae2d5",
              "name": "quebra_de_objecoes_geral",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_geral }}",
              "type": "string"
            },
            {
              "id": "cc085a35-fef6-47b9-ad97-e9d671a71d29",
              "name": "quebra_de_objecoes_carreira",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_carreira }}",
              "type": "string"
            },
            {
              "id": "8f3c6a4d-df4f-4de7-ad41-0177eb567ed4",
              "name": "quebra_de_objecoes_consultoria",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_consultoria }}",
              "type": "string"
            },
            {
              "id": "03c2a02f-e2c2-4d42-afe3-3d6b7bfae375",
              "name": "tipos_work_permit_permitidos",
              "value": "={{ $json.body?.customData?.estruturas_work_permit }}",
              "type": "string"
            },
            {
              "id": "2d89fd62-be99-4c63-9bf9-c2b97c0cc735",
              "name": "link_do_zoom",
              "value": "={{ $json.body?.customData?.link_do_zoom }}",
              "type": "string"
            },
            {
              "id": "939d130d-8780-41e6-9693-10b83cd9bab5",
              "name": "agendamento_duracao_minutos",
              "value": "30",
              "type": "string"
            },
            {
              "id": "c9a26bfa-ced7-4b82-a6bb-2c0aeb46f9a3",
              "name": "cobranca_valor",
              "value": "500",
              "type": "string"
            },
            {
              "id": "9290e4ff-d01b-4fca-b5f3-7605d4f74c07",
              "name": "id_conversa_alerta",
              "value": "skfa6JP6lLlAXkc8FfIp",
              "type": "string"
            },
            {
              "id": "c594a0f2-aba9-458c-92ff-81e73086416c",
              "name": "url_asaas",
              "value": "https://api-sandbox.asaas.com",
              "type": "string"
            },
            {
              "id": "103fad86-a8b6-4591-b310-2dc7069bc189",
              "name": "etapa_funil",
              "value": "={{ $json.body?.customData?.etapa_funil }}",
              "type": "string"
            },
            {
              "id": "3ae92580-436d-4dfc-a7cc-f83f8f68309e",
              "name": "full_name",
              "value": "={{ $json.nome_completo }}",
              "type": "string"
            },
            {
              "id": "5476f99e-273b-45a1-996f-b98cb86ddd25",
              "name": "work_permit",
              "value": "={{ $json.body?.customData?.work_permit }}",
              "type": "string"
            },
            {
              "id": "989fb582-9e56-4962-8883-6076627c72b5",
              "name": "state",
              "value": "={{ $json.body?.customData?.state }}",
              "type": "string"
            },
            {
              "id": "15265189-0d84-420c-b7da-6181170a6b08",
              "name": "location_name",
              "value": "={{ $json.body?.location?.name }}",
              "type": "string"
            },
            {
              "id": "5770d76c-1a0f-4515-9683-381881715eb5",
              "name": "resposta_ia",
              "value": "={{ $json.body?.['Resposta IA'] }}",
              "type": "string"
            },
            {
              "id": "b1871710-95d0-495d-9592-ff09ea8ab983",
              "name": "objetivo_do_lead",
              "value": "={{ $json.objetivo_do_lead }}",
              "type": "string"
            },
            {
              "id": "5a729725-994d-46e5-a6f1-aac7b9504a3a",
              "name": "ativar_ia",
              "value": "={{ $json.ativar_ia }}",
              "type": "string"
            },
            {
              "id": "5e293330-4c28-4ae8-92ef-e99bc9feb55e",
              "name": "utm_content",
              "value": "={{ $json.utm_content }}",
              "type": "string"
            },
            {
              "id": "7d94c551-b241-48e8-84e8-9ab152f6a526",
              "name": "agente_ia",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_ia }}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "mensagem_contexto",
              "value": "={{ $json.mensagem_contexto }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "is_primeira_mensagem",
              "value": "={{ $json.is_primeira_mensagem }}",
              "type": "boolean"
            },
            {
              "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
              "name": "tipo_lead",
              "value": "={{ $json.tipo_lead }}",
              "type": "string"
            },
            {
              "id": "301166ea-a33e-4fa8-a1ec-3a3a0fd00923",
              "name": "tipo_mensagem_original",
              "value": "={{ \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.ogg') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp3') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.opus') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp4') || \n  ($('Mensagem recebida').item.json.body.customData?.message || '').startsWith('Mensagem de Áudio') \n    ? 'audio' \n    : ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpeg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.png') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.webp') \n        ? 'imagem' \n        : 'texto' \n}}",
              "type": "string"
            },
            {
              "id": "368ffdd1-2395-4632-b738-e35ebfbe0832",
              "name": "body.customData.ghl_api_key",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "f5ad43c1-fbe7-417a-bd52-9cfa52294c74",
              "name": "agente_versionado",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_versionado }}",
              "type": "string"
            },
            {
              "id": "714f3406-1a5c-43e7-99e1-a5d853d7e38d",
              "name": "agenda_consultorio_sao_paulo",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda consultorio sao paulo'] }}",
              "type": "string"
            },
            {
              "id": "6cb38978-9095-486b-b775-58ab8839c366",
              "name": "agenda_presidente_prudente",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda presidente prudente'] }}",
              "type": "string"
            },
            {
              "id": "b28742cf-e1f5-4257-9dd4-8109c07fb7a3",
              "name": "agenda_consulta_online",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda online'] }}",
              "type": "string"
            },
            {
              "id": "e484881e-587d-4779-b712-6d8e6758456a",
              "name": "utm_campaign",
              "value": "={{ $('Mensagem recebida').item.json.body.contact.lastAttributionSource.utmSource }}",
              "type": "string"
            },
            {
              "id": "4ca80da6-382f-4ba0-8cdb-8b106528da17",
              "name": "utm_content",
              "value": "={{ $('Mensagem recebida').item.json.body.contact.lastAttributionSource.utmContent }}",
              "type": "string"
            },
            {
              "id": "1f44746f-f362-4236-83bf-410203bdb89e",
              "name": "form_procurou_ajuda_medica",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Procurou ajuda medica\"] }}",
              "type": "string"
            },
            {
              "id": "e50e0483-b8df-41dc-aa98-9fbf147d805f",
              "name": "form_sintomas_atualmente",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Sintomas atualmente\"] }}",
              "type": "string"
            },
            {
              "id": "846fa257-3db8-4d78-9f11-702bf9b19c61",
              "name": "form_acredita_em_alteração_hormonal",
              "value": "={{ $('Mensagem recebida').item.json.body[\"acredita em alteração hormonal\"] }}",
              "type": "string"
            },
            {
              "id": "1441d8fd-2d84-4a6f-9d04-c5802c5bf2a6",
              "name": "form_udança_no_corpo",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Mudança no corpo\"] }}",
              "type": "string"
            },
            {
              "id": "0a844d42-978b-4713-aae8-84a05f2359e3",
              "name": "form_tipo_de_consulta",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Tipo de consulta\"] }}",
              "type": "string"
            },
            {
              "id": "addf25d3-00f6-45e5-a6c9-3236b52cabfd",
              "name": "form_interessado_em_investir",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Interessado em investir\"] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33616,
        26960
      ],
      "id": "60644eae-cd2a-4c07-b4e3-bfc83ba5dca3",
      "name": "Info1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.user_prompt }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\n\n## HISTÓRICO DE CONVERSAS ANTIGAS\n{{ $('Set mensagens').first().json.mensagens_antigas }}",
          "maxIterations": 20,
          "returnIntermediateSteps": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        39872,
        26464
      ],
      "id": "c49036ec-190e-4c07-b068-5f4dd741e34a",
      "name": "SDR1",
      "retryOnFail": true,
      "waitBetweenTries": 4000
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Set mensagens - Mapeia campos do workflow Info para formato interno\nconst input = $input.item.json;\n\n// Pegar dados do Info diretamente para garantir calendários\nconst infoData = $('Info').first().json;\n\n// Extrair source baseado no agente\nlet source = 'whatsapp';\nif (input.agente_ia === 'social_seller_instagram' || input.source === 'instagram') {\n  source = 'instagram';\n}\n\n// Extrair etiquetas (pode ser string ou array)\nlet etiquetas = [];\nif (input.etiquetas) {\n  etiquetas = typeof input.etiquetas === 'string' \n    ? input.etiquetas.split(',').map(t => t.trim()).filter(t => t) \n    : input.etiquetas;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS DO FORMULÁRIO DE TRÁFEGO (Facebook/Instagram Ads)\n// ─────────────────────────────────────────────────────────────────────────────\nconst formularioTrafego = {\n  origem_campanha: infoData.utm_campaign || input.utm_source || '',\n  sintomas_atuais: infoData.form_sintomas_atualmente || '',\n  procurou_ajuda: infoData.form_procurou_ajuda_medica || '',\n  mudanca_corpo: infoData.form_mudanca_no_corpo || '',\n  preferencia_consulta: infoData.form_tipo_de_consulta || '',\n  pronto_investir: infoData.form_interessado_em_investir || ''\n};\n\n// Verificar se é lead de tráfego (tem dados do formulário)\nconst isLeadTrafego = !!(formularioTrafego.sintomas_atuais || formularioTrafego.preferencia_consulta || formularioTrafego.origem_campanha || formularioTrafego.procurou_ajuda);\n\nreturn {\n  json: {\n    // IDs\n    location_id: infoData.location_id || input.owner_origin || '',\n    contact_id: infoData.lead_id || '',\n    conversation_id: infoData.id_conversa_alerta || infoData.lead_id || '',\n    \n    // Dados do contato\n    phone: infoData.telefone || '',\n    full_name: infoData.full_name || infoData.first_name || 'Visitante',\n    \n    // Mensagem\n    message: infoData.mensagem || input.resposta_ia || '',\n    source: source,\n    \n    // Contexto do lead\n    historico: input.historico || [],\n    etiquetas: etiquetas,\n    status_pagamento: infoData.status_cobranca || 'nenhum',\n    preferencia_audio_texto: infoData.tipo_mensagem_original || 'texto',\n    \n    // Modo do agente\n    modo_agente: infoData.agente_ia || 'sdr_inbound',\n    \n    // Calendários do GHL - AGORA PEGANDO DO INFO DIRETAMENTE\n    calendarios_ghl: {\n      sao_paulo: infoData.agenda_consultorio_sao_paulo || '',\n      presidente_prudente: infoData.agenda_presidente_prudente || '',\n      online: infoData.agenda_consulta_online || ''\n    },\n    \n    // API Key\n    ghl_api_key: infoData.api_key || '',\n    \n    // Dados extras do lead\n    objetivo: infoData.objetivo_do_lead || '',\n    is_primeira_mensagem: infoData.is_primeira_mensagem || false,\n    tipo_lead: infoData.tipo_lead || 'NAO_IDENTIFICADO',\n    \n    // Dados do formulário de tráfego\n    formulario_trafego: formularioTrafego,\n    is_lead_trafego: isLeadTrafego\n  }\n};"
      },
      "id": "f1fcf01c-71ea-4fb0-8173-7c656f3ff645",
      "name": "Set mensagens2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38480,
        26496
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT av.*, l.api_key as location_api_key\nFROM agent_versions av\nLEFT JOIN locations l ON av.location_id = l.location_id\nWHERE av.location_id = '{{ $('Set mensagens').first().json.location_id }}'\n  AND av.is_active = true\n  AND av.status = 'active'\nORDER BY av.deployed_at DESC NULLS LAST, av.created_at DESC\nLIMIT 1",
        "options": {}
      },
      "id": "e6a92a41-ba19-4883-b1cd-e82114456879",
      "name": "Buscar Agente Ativo2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        38704,
        26496
      ],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// FORMATAR CALENDÁRIOS\n// Usa calendários do GHL (customData) com fallback para scheduling_config\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\nconst schedulingConfig = prev.scheduling_config || {};\nconst calendariosGHL = prev.calendarios_ghl || {};\n\n// Mapear calendários - prioridade para GHL, fallback para config do agente\nconst calendarios = [];\n\nconst calSP = calendariosGHL.sao_paulo || schedulingConfig.agenda_consultorio_sao_paulo;\nconst calPP = calendariosGHL.presidente_prudente || schedulingConfig.agenda_presidente_prudente;\nconst calOnline = calendariosGHL.online || schedulingConfig.agenda_consulta_online;\n\nif (calSP) {\n  calendarios.push(`• Consultório São Paulo (Moema): ID ${calSP}`);\n}\n\nif (calPP) {\n  calendarios.push(`• Unidade Presidente Prudente: ID ${calPP}`);\n}\n\nif (calOnline) {\n  calendarios.push(`• Consulta Online (Telemedicina): ID ${calOnline}`);\n}\n\n// Se não houver calendários configurados\nif (calendarios.length === 0) {\n  calendarios.push('• Calendários não configurados');\n}\n\nconst calendariosFormatados = calendarios.join('\\n');\n\n// Informações de agendamento\nconst agendamentoInfo = [\n  `Horários: Segunda a Sexta, 9h-18h | Sábado 8h-12h`,\n  `Duração consulta: 1h a 1h30`,\n  `Antecedência mínima: 24 horas`,\n  `Cancelamento: Até 24h antes sem custo`\n].join('\\n');\n\nreturn {\n  json: {\n    ...prev,\n    calendarios_formatados: calendariosFormatados,\n    agendamento_info: agendamentoInfo,\n    // IDs para usar nas tools de agendamento\n    calendar_ids: {\n      sao_paulo: calSP || '',\n      presidente_prudente: calPP || '',\n      online: calOnline || ''\n    },\n    // Garantir que dados do formulário passam adiante\n    formulario_trafego: prev.formulario_trafego || {},\n    is_lead_trafego: prev.is_lead_trafego || false\n  }\n};"
      },
      "id": "ff7922b7-75d0-4ae5-ae7f-14336a8b1042",
      "name": "Formatar Calendários1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39136,
        26496
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// MONTAR PROMPTS FINAIS\n// Substitui variáveis Mustache e monta system_prompt + user_prompt\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FUNÇÃO PARA SUBSTITUIR VARIÁVEIS MUSTACHE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction replaceVars(template, vars) {\n  if (!template) return '';\n  let result = template;\n  \n  for (const [key, value] of Object.entries(vars)) {\n    // Pattern que captura {{ key }} com espaços variáveis\n    const pattern = new RegExp(`\\\\{\\\\{\\\\s*${key}\\\\s*\\\\}\\\\}`, 'g');\n    result = result.replace(pattern, value || '');\n  }\n  \n  return result;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// VARIÁVEIS PARA SUBSTITUIÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nconst variaveis = {\n  modo_agente: prev.agent_type || 'sdr',\n  source: prev.source || 'instagram',\n  full_name: prev.full_name || 'Visitante',\n  timezone: 'America/Sao_Paulo',\n  agente: prev.agent_name || 'Julia',\n  data_hora: prev.data_hora,\n  status_pagamento: prev.status_pagamento || 'nenhum',\n  preferencia_audio_texto: prev.preferencia_audio_texto || 'texto'\n};\n\n// ─────────────────────────────────────────────────────────────────────────────\n// REGRA DINÂMICA DE SAUDAÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nlet regraSaudacao = '';\nconst hora = prev.hora_numero;\nconst historicoExiste = prev.historico_existe;\n\nif (!historicoExiste) {\n  // Primeira mensagem - saudar conforme horário\n  if (hora >= 5 && hora < 12) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem do dia. Inicie com \"Bom dia\" de forma calorosa.\\n</regra_saudacao>';\n  } else if (hora >= 12 && hora < 18) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem do dia. Inicie com \"Boa tarde\" de forma calorosa.\\n</regra_saudacao>';\n  } else {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem do dia. Inicie com \"Boa noite\" de forma calorosa.\\n</regra_saudacao>';\n  }\n} else {\n  // Conversa em andamento - não repetir saudação\n  regraSaudacao = '\\n\\n<regra_saudacao>\\nConversa já iniciada. NÃO repita saudação. Continue naturalmente.\\n</regra_saudacao>';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR SYSTEM PROMPT\n// ─────────────────────────────────────────────────────────────────────────────\nlet systemPrompt = prev.system_prompt || '';\n\n// Substituir variáveis no system prompt\nsystemPrompt = replaceVars(systemPrompt, variaveis);\n\n// Adicionar regra de saudação\nsystemPrompt += regraSaudacao;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR BLOCO DE RESPOSTAS DO FORMULÁRIO DE TRÁFEGO\n// ─────────────────────────────────────────────────────────────────────────────\nlet blocoFormularioTrafego = '';\nconst form = prev.formulario_trafego || {};\nconst isLeadTrafego = prev.is_lead_trafego || false;\n\nif (isLeadTrafego) {\n  const linhas = [];\n  if (form.origem_campanha) linhas.push(`VEIO POR CAMPANHA ONLINE DO: ${form.origem_campanha}`);\n  if (form.procurou_ajuda) linhas.push(`FORM_PROCUROU AJUDA ANTES?: ${form.procurou_ajuda}`);\n  if (form.sintomas_atuais) linhas.push(`FORM_SINTOMAS ATUAIS: ${form.sintomas_atuais}`);\n  if (form.mudanca_corpo) linhas.push(`FORM_TEVE MUDANÇA NO CORPO?: ${form.mudanca_corpo}`);\n  if (form.preferencia_consulta) linhas.push(`FORM_PREFERÊNCIA_CONSULTA: ${form.preferencia_consulta}`);\n  if (form.pronto_investir) linhas.push(`JÁ ESTA PRONTO PRA INVESTIR NA SAUDE?: ${form.pronto_investir}`);\n  \n  if (linhas.length > 0) {\n    blocoFormularioTrafego = `\\n<respostas_formulario_trafego>\\n${linhas.join('\\n')}\\n</respostas_formulario_trafego>\\n`;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR USER PROMPT (Contexto + Formulário + Histórico + Mensagem)\n// ─────────────────────────────────────────────────────────────────────────────\nconst etiquetasStr = Array.isArray(prev.etiquetas) \n  ? prev.etiquetas.join(', ') \n  : (prev.etiquetas || 'nenhuma');\n\nlet userPrompt = `\n<contexto_conversa>\nLEAD: ${prev.full_name}\nCANAL: ${prev.source}\nDDD: ${prev.ddd || 'não identificado'}\nDATA/HORA: ${prev.data_hora}\nETIQUETAS: ${etiquetasStr}\nSTATUS PAGAMENTO: ${prev.status_pagamento}\nPREFERÊNCIA: ${prev.preferencia_audio_texto}\n</contexto_conversa>\n`;\n\n// ADICIONAR BLOCO DO FORMULÁRIO DE TRÁFEGO (SE EXISTIR)\nif (blocoFormularioTrafego) {\n  userPrompt += blocoFormularioTrafego;\n}\n\nuserPrompt += `\n<hiperpersonalizacao>\n${prev.contexto_hiperpersonalizado}\n</hiperpersonalizacao>\n\n<calendarios_disponiveis>\n${prev.calendarios_formatados}\n\n${prev.agendamento_info}\n</calendarios_disponiveis>\n`;\n\n// Adicionar histórico se existir\nif (prev.historico_formatado) {\n  userPrompt += `\n<historico_conversa>\n${prev.historico_formatado}\n</historico_conversa>\n`;\n}\n\n// Adicionar mensagem atual\nuserPrompt += `\n<mensagem_atual>\nLEAD: ${prev.message}\n</mensagem_atual>\n\nResponda à mensagem acima como ${prev.agent_name}, seguindo todas as instruções do system prompt.`;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    \n    // Metadados para debug\n    _meta: {\n      agent_name: prev.agent_name,\n      agent_version: prev.version,\n      contact_id: prev.contact_id,\n      conversation_id: prev.conversation_id,\n      variaveis_substituidas: Object.keys(variaveis),\n      historico_mensagens: prev.historico_existe ? 'sim' : 'não',\n      hora_execucao: prev.data_hora,\n      is_lead_trafego: isLeadTrafego\n    }\n  }\n};"
      },
      "id": "ddb89391-fbf4-4408-a9ee-d46cefaf4320",
      "name": "Montar Prompts Finais1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39360,
        26496
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// PREPARAR EXECUÇÃO + IDENTIFICAR CONTEXTO\n// Versão corrigida com hiperpersonalização dinâmica do agente\n// ═══════════════════════════════════════════════════════════════════════════\n\n// Pegar dados do agente (vem do node anterior - Buscar Agente Ativo)\nconst agent = $input.item.json;\n\n// Pegar dados das mensagens do node Set mensagens\nconst mensagens = $('Set mensagens2').first().json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSE SEGURO DE JSON\n// ─────────────────────────────────────────────────────────────────────────────\nfunction safeParseJSON(value, fallback = {}) {\n  if (!value) return fallback;\n  if (typeof value === 'object') return value;\n  try {\n    return JSON.parse(value);\n  } catch (e) {\n    console.log('Erro parsing JSON:', e.message);\n    return fallback;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// EXTRAIR DDD DO TELEFONE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction extrairDDD(telefone) {\n  if (!telefone) return null;\n  const limpo = telefone.replace(/\\D/g, '');\n  \n  // Formato: 55 + DDD + número\n  if (limpo.startsWith('55') && limpo.length >= 12) {\n    return limpo.substring(2, 4);\n  }\n  // Formato: DDD + número (sem código do país)\n  if (limpo.length >= 10 && limpo.length <= 11) {\n    return limpo.substring(0, 2);\n  }\n  return null;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETERMINAR PERÍODO DO DIA\n// ─────────────────────────────────────────────────────────────────────────────\nfunction getPeriodoHorario() {\n  const agora = new Date();\n  const hora = agora.getHours();\n  \n  if (hora >= 5 && hora < 12) return 'manha';\n  if (hora >= 12 && hora < 18) return 'tarde';\n  return 'noite';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// GERAR CONTEXTO HIPERPERSONALIZADO\n// Usa configuração DO AGENTE, não hardcoded\n// ─────────────────────────────────────────────────────────────────────────────\nfunction gerarContextoHiperpersonalizado(ddd, periodo, hyperConfig) {\n  const contextos = [];\n  \n  // 1. Personalização por DDD (região)\n  if (hyperConfig.personalizacao_por_ddd && ddd) {\n    const dddConfig = hyperConfig.personalizacao_por_ddd[ddd];\n    if (dddConfig) {\n      contextos.push(`[REGIÃO ${ddd}] ${dddConfig.contexto || ''}`);\n      if (dddConfig.unidade_proxima) {\n        contextos.push(`Unidade mais próxima: ${dddConfig.unidade_proxima}`);\n      }\n      if (dddConfig.abordagem) {\n        contextos.push(`Abordagem regional: ${dddConfig.abordagem}`);\n      }\n    }\n  }\n  \n  // 2. Saudação por período\n  if (hyperConfig.saudacoes_por_horario) {\n    const saudacao = hyperConfig.saudacoes_por_horario[periodo];\n    if (saudacao) {\n      contextos.push(`Saudação recomendada: \"${saudacao}\"`);\n    }\n  }\n  \n  // 3. Personalização por sintoma (se disponível)\n  if (hyperConfig.personalizacao_por_sintoma) {\n    contextos.push('Personalização por sintoma disponível - adaptar conforme queixa');\n  }\n  \n  // 4. Personalização por profissão (se disponível)\n  if (hyperConfig.personalizacao_por_profissao) {\n    contextos.push('Personalização por profissão disponível - adaptar linguagem conforme perfil');\n  }\n  \n  return contextos.length > 0 \n    ? contextos.join('\\n') \n    : 'Usar abordagem padrão empática e acolhedora';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSEAR TODAS AS CONFIGURAÇÕES DO AGENTE\n// ─────────────────────────────────────────────────────────────────────────────\nconst toolsConfig = safeParseJSON(agent.tools_config, {});\nconst businessConfig = safeParseJSON(agent.business_config, {});\nconst hyperpersonalization = safeParseJSON(agent.hyperpersonalization, {});\nconst qualificationConfig = safeParseJSON(agent.qualification_config, {});\nconst schedulingConfig = safeParseJSON(agent.scheduling_config, {});\nconst complianceConfig = safeParseJSON(agent.compliance_config, {});\nconst escalationConfig = safeParseJSON(agent.escalation_config, {});\nconst metricsConfig = safeParseJSON(agent.metrics_config, {});\nconst integrationConfig = safeParseJSON(agent.integration_config, {});\nconst knowledgeBase = safeParseJSON(agent.knowledge_base, []);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS CONTEXTUAIS\n// ─────────────────────────────────────────────────────────────────────────────\nconst ddd = extrairDDD(mensagens.phone);\nconst periodo = getPeriodoHorario();\nconst agora = new Date();\nconst dataHora = agora.toLocaleString('pt-BR', { \n  timeZone: 'America/Sao_Paulo',\n  dateStyle: 'full',\n  timeStyle: 'short'\n});\n\n// Gerar contexto hiperpersonalizado usando config DO AGENTE\nconst contextoHiper = gerarContextoHiperpersonalizado(ddd, periodo, hyperpersonalization);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FORMATAR HISTÓRICO\n// ─────────────────────────────────────────────────────────────────────────────\nlet historicoFormatado = '';\nif (mensagens.historico && mensagens.historico.length > 0) {\n  historicoFormatado = mensagens.historico\n    .slice(-10) // Últimas 10 mensagens\n    .map(m => `${m.role === 'user' ? 'LEAD' : 'JULIA'}: ${m.content}`)\n    .join('\\n');\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    // Dados do agente\n    agent_id: agent.id,\n    agent_name: agent.agent_name,\n    agent_type: agent.agent_type,\n    version: agent.version,\n    system_prompt: agent.system_prompt,\n    user_prompt_template: agent.user_prompt_template,\n    location_api_key: agent.location_api_key,\n    \n    // Configurações parseadas\n    tools_config: toolsConfig,\n    business_config: businessConfig,\n    hyperpersonalization: hyperpersonalization,\n    qualification_config: qualificationConfig,\n    scheduling_config: schedulingConfig,\n    compliance_config: complianceConfig,\n    escalation_config: escalationConfig,\n    metrics_config: metricsConfig,\n    integration_config: integrationConfig,\n    knowledge_base: knowledgeBase,\n    \n    // Contexto da conversa\n    contact_id: mensagens.contact_id,\n    phone: mensagens.phone,\n    full_name: mensagens.full_name,\n    source: mensagens.source,\n    message: mensagens.message,\n    conversation_id: mensagens.conversation_id,\n    etiquetas: mensagens.etiquetas,\n    status_pagamento: mensagens.status_pagamento,\n    preferencia_audio_texto: mensagens.preferencia_audio_texto,\n    \n    // Dados calculados\n    ddd: ddd,\n    periodo: periodo,\n    data_hora: dataHora,\n    contexto_hiperpersonalizado: contextoHiper,\n    historico_formatado: historicoFormatado,\n    historico_existe: mensagens.historico && mensagens.historico.length > 0,\n    hora_numero: agora.getHours(),\n    \n    // Calendários do GHL (para usar no próximo node)\n    calendarios_ghl: mensagens.calendarios_ghl || {},\n    ghl_api_key: mensagens.ghl_api_key || '',\n    \n    // Dados do formulário de tráfego\n    formulario_trafego: mensagens.formulario_trafego || {},\n    is_lead_trafego: mensagens.is_lead_trafego || false\n  }\n};"
      },
      "id": "82e77585-a6c8-4171-919f-f220f991ff8e",
      "name": "Preparar Execução + Identificar Contexto3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38928,
        26496
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/match-lead-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('Info').first().json.telefone || '' }}\",\n  \"email\": \"{{ $('Info').first().json.email || '' }}\",\n  \"ig_id\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.igSid || '' }}\",\n  \"ghl_contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"ig_handle\": \"{{ $('Info').first().json.instagram || '' }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34848,
        24160
      ],
      "id": "ce2a26c3-ac59-4e64-8cba-f0e8e94622b6",
      "name": "Match Lead Context",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.matched }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "matched-true-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Lead Já Enriquecido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.matched }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "matched-false-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Fazer Scrape"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        35072,
        24160
      ],
      "id": "5bc88945-a334-4ba8-b2ec-d6f1a213d7d8",
      "name": "Lead Prospectado?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/auto-enrich-lead",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('Info').first().json.telefone || '' }}\",\n  \"email\": \"{{ $('Info').first().json.email || '' }}\",\n  \"ig_id\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.igSid || $('Mensagem recebida').first().json.body?.contact?.attributionSource?.mediumId || '' }}\",\n  \"ig_handle\": \"{{ $('Info').first().json.instagram || '' }}\",\n  \"ghl_contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"first_name\": \"{{ $('Info').first().json.first_name || '' }}\",\n  \"source_channel\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.medium || 'ghl_webhook' }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35296,
        24448
      ],
      "id": "86646fed-efd1-4199-99e3-b871b5e2ed4b",
      "name": "Auto Enrich Lead",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Scrape automático do Instagram + salva no banco"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/webhook/classify-lead",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"username\": \"{{ $('Info').first().json.first_name || 'lead' }}\",\n  \"message\": \"{{ $('Mensagem recebida').first().json.body?.message?.body || $('Mensagem recebida').first().json.body?.lastMessage?.body || '' }}\",\n  \"tenant_id\": \"{{ $('Info').first().json.location_id || 'default' }}\",\n  \"context\": {\n    \"source\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.medium || $('Mensagem recebida').first().json.body?.contact_source || 'unknown' }}\",\n    \"phone\": \"{{ $('Info').first().json.telefone || $('Mensagem recebida').first().json.body?.phone || '' }}\",\n    \"email\": \"{{ $('Info').first().json.email || '' }}\",\n    \"tags\": \"{{ $('Mensagem recebida').first().json.body?.tags || '' }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34624,
        23936
      ],
      "id": "d19c43aa-0d23-4c5a-8173-88574169af06",
      "name": "Classificar Lead IA",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Classifica automaticamente: LEAD_HOT, LEAD_WARM, LEAD_COLD, PESSOAL, SPAM"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.classification }}",
                    "rightValue": "LEAD",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "is-lead-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "É Lead - Ativar IA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.classification }}",
                    "rightValue": "PESSOAL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "is-pessoal-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Pessoal - Mover Perdido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.classification }}",
                    "rightValue": "SPAM",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "is-spam-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Spam - Mover Perdido"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34848,
        23904
      ],
      "id": "02ee8021-9421-4a5b-b1d2-7e3c467c0db0",
      "name": "Rotear por Classificação"
    },
    {
      "parameters": {
        "requestMethod": "PATCH",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=lead-classificado-ia"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "GHL - Tag Classificado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        35296,
        23696
      ],
      "id": "f521ebc7-476d-45cd-8896-20c106f6e3ba",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer pit-3872ad13-41f7-4e76-a3ff-f2dee789f8d6"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\"key\": \"ativar_ia\", \"field_value\": \"nao\"},\n    {\"key\": \"objetivo_lead\", \"field_value\": \"{{ $('Classificar Lead IA').first().json.classification }}\"},\n    {\"key\": \"motivo_perdido\", \"field_value\": \"{{ $('Classificar Lead IA').first().json.reasoning }}\"}\n  ],\n  \"tags\": [\"perdido\"]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        35072,
        23888
      ],
      "id": "0f3c75e1-0c7a-47cc-b915-766087aab199",
      "name": "GHL - Mover Perdido",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Move lead pra perdido: PESSOAL ou SPAM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/analyze-conversation-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"current_message\": \"{{ $('Mensagem recebida').first().json.body?.message?.body || $('Mensagem recebida').first().json.body?.lastMessage?.body || '' }}\",\n  \"contact_tags\": {{ JSON.stringify(($('Mensagem recebida').first().json.body?.tags || '').split(',').filter(t => t.trim())) }},\n  \"last_message_direction\": \"{{ $('Mensagem recebida').first().json.body?.lastMessage?.direction || 'inbound' }}\",\n  \"conversation_count\": {{ $('Mensagem recebida').first().json.body?.conversationCount || 1 }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34624,
        23648
      ],
      "id": "96a48bd0-d2f6-4347-bde0-87e72290cb4c",
      "name": "Analisar Contexto Conversa",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Analisa: tags, última msg, histórico. Decide se ativa IA ou não."
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_activate_ia }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "should-activate-true"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ativar IA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_activate_ia }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "should-activate-false"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Não Ativar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34848,
        23648
      ],
      "id": "8fe7d551-0bc9-4f28-9f72-ed89fe058d75",
      "name": "Decisão de Contexto"
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=lead-prospectado-ia"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "GHL - Tag Prospectado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        35520,
        24048
      ],
      "id": "c3be5e16-825d-4f2c-ada8-cecfb466a82a",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-ativar-ia-prospectado",
              "leftValue": "={{ $('Info').first().json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        35296,
        24048
      ],
      "id": "16126ade-ef79-4957-92d6-de356fc7fb66",
      "name": "Já Ativou IA? (Prospectado)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-ativar-ia-classificado",
              "leftValue": "={{ $('Info').first().json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        35072,
        23696
      ],
      "id": "4d600ca6-1924-4437-a624-3bf6bc078f68",
      "name": "Já Ativou IA? (Classificado)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-utm",
              "leftValue": "={{ $('Contexto UTM').first().json.tem_contexto_utm }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        34624,
        24160
      ],
      "id": "68ae48b9-6f42-421b-a15a-d93e2eb50886",
      "name": "Veio de Tráfego?"
    },
    {
      "parameters": {
        "content": "## 🚦 VERIFICAÇÃO DE TRÁFEGO - 03/01/2026\n\n### Lógica:\n- **tem_contexto_utm = true** → Lead veio de TRÁFEGO (anúncio)\n  - SKIP toda classificação de IA\n  - Já tem automação própria no GHL\n  \n- **tem_contexto_utm = false** → Lead orgânico ou prospectado\n  - Continua para Match Lead Context\n  - Segue fluxo de classificação\n\n### Tags do Sistema:\n| Tag | Quando |\n|-----|--------|\n| `lead-prospectado-ia` | matched=true (AgenticOS) |\n| `lead-classificado-ia` | Lead válido (LEAD_*) |\n| `perdido` | SPAM ou PESSOAL |\n",
        "height": 492,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        33904,
        23520
      ],
      "id": "c812a132-4f75-4d46-a35c-9422f9ffafde",
      "name": "Verificação Tráfego"
    },
    {
      "parameters": {
        "content": "## 1. Assistencia",
        "height": 80,
        "width": 540,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32736,
        24096
      ],
      "id": "14b20a6e-8da6-4c06-a102-a011e9ac50c1",
      "name": "Sticky Note31"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.leadconnectorhq.com/locations/{{ $json.location.id }}/customFields",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"Etapa do Funil\",\n  \"fieldKey\": \"contact.etapa_funil\",\n  \"dataType\": \"SINGLE_OPTIONS\",\n  \"placeholder\": \"Selecione a etapa\",\n  \"position\": 100,\n  \"options\": [\n    \"Novo Lead\",\n    \"Primeiro Contato\",\n    \"Em Follow-Up\",\n    \"Qualificado\",\n    \"Agendamento Marcado\",\n    \"Reagendado\",\n    \"No-Show\",\n    \"Reunião Realizada\",\n    \"Proposta Enviada\",\n    \"Follow-Up Proposta\",\n    \"Contrato Enviado\",\n    \"Aguardando Pagamento\",\n    \"Cliente Ativo\",\n    \"Perdido\"\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32832,
        23424
      ],
      "id": "64ed6665-3ca5-421a-8f11-5869b1f84d6a",
      "name": "GHL - Criar Campo Etapa do Funil1",
      "alwaysOutputData": true,
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Importante\n\nEssa tool cria campo no Socialfy, basta solicitar ao Claude o campo que quer criar e copiar o campo a baixo e colar no claude para dar como referencia",
        "height": 320,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32400,
        23312
      ],
      "id": "0c5d258b-1a85-4353-a336-4d8df70e541c",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "fuu-cancel-1",
              "name": "fuu_contact_id",
              "value": "={{ $json.contact?.id || 'no_contact' }}",
              "type": "string"
            },
            {
              "id": "fuu-cancel-2",
              "name": "fuu_location_id",
              "value": "={{ $json.contact?.locationId || 'no_location' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32350,
        26496
      ],
      "id": "b72e9f25-5739-4f66-891e-64677e7413ec",
      "name": "FUU - Cancelar Follow-ups",
      "onError": "continueRegularOutput",
      "retryOnFail": false,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Agenda follow-up para caso lead não responda\nSELECT fuu_schedule_followup(\n  $1::varchar,\n  $2::varchar,\n  'sdr_inbound'::varchar,\n  $3::varchar,\n  $4::varchar,\n  $5::varchar,\n  $6::jsonb,\n  NOW()\n) as queue_id;",
        "options": {
          "queryReplacement": "={{ [$json.contact?.id || $('Mensagem recebida').first().json.contact.id, $json.contact?.locationId || $('Mensagem recebida').first().json.contact.locationId, $json.contact?.phone || null, $json.contact?.email || null, $json.contact?.name || $json.contact?.firstName || null, JSON.stringify({ultimo_assunto: '', etapa: 'qualificacao', source: 'whatsapp'})] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        45300,
        26480
      ],
      "id": "3cae8e85-b0cd-43c2-a267-1e20c4ff7c0d",
      "name": "FUU - Agendar Follow-up",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "retryOnFail": false,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "content": "# Integração FUU (Follow Up Universal)\n\n## Nós adicionados:\n1. **FUU - Cancelar Follow-ups**: No início, cancela follow-ups pendentes quando lead responde\n2. **FUU - Agendar Follow-up**: No final, agenda novo follow-up para caso lead não responda\n\n## Como funciona:\n- Lead manda mensagem → Cancela follow-ups pendentes\n- IA responde → Agenda novo follow-up (tipo: sdr_inbound)\n- Se lead não responder em 35min → CRON do Follow Up Eterno envia mensagem\n\n## Tabelas FUU:\n- fuu_queue: Fila de follow-ups\n- fuu_cadences: Intervalos por location\n- fuu_execution_log: Histórico\n\nPatch aplicado em: 2026-01-09 15:19",
        "height": 400,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32100,
        26100
      ],
      "id": "ba67bffa-8f8d-41b2-b4b7-6d51da5430e5",
      "name": "FUU Info"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Cancela follow-ups pendentes (executa em background)\nSELECT fuu_mark_responded(\n  '{{ $json.fuu_contact_id }}',\n  '{{ $json.fuu_location_id }}'\n) as cancelled_count;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        32400,
        26700
      ],
      "id": "26035d7f-33a4-4101-8323-a9729c569d64",
      "name": "FUU - Executar Cancelamento",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "executeOnce": true
    }
  ],
  "pinData": {
    "1️⃣ Listar campos customizados": [
      {
        "json": {
          "customFields": [
            {
              "id": "41NnWP9CM6f8ao444wAA",
              "name": "Commision",
              "model": "contact",
              "fieldKey": "contact.commision",
              "placeholder": "Commision",
              "dataType": "MONETORY",
              "position": 650,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:38.004Z",
              "standard": false
            },
            {
              "id": "44j7hoM33qQ4oXEpRlav",
              "name": "Insured Name",
              "model": "contact",
              "fieldKey": "contact.insured_name",
              "placeholder": "Insured Name",
              "dataType": "TEXT",
              "position": 450,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.988Z",
              "standard": false
            },
            {
              "id": "x",
              "name": "x",
              "model": "contact",
              "fieldKey": "contact.x",
              "placeholder": "Selecione o agente",
              "dataType": "SINGLE_OPTIONS",
              "position": 750,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-11-27T20:13:34.994Z",
              "standard": false,
              "picklistOptions": [
                "followuper",
                "customersuccess",
                "closer",
                "engagementkeeper",
                "rescheduler",
                "socialsellerconsultoria",
                "socialsellercarreira",
                "sdrcarreira",
                "sdrconsultoria"
              ]
            },
            {
              "id": "4KzXBGYsXFd5TAV0FaBB",
              "name": "Last Appointment",
              "model": "contact",
              "fieldKey": "contact.last_appointment",
              "placeholder": "",
              "dataType": "TEXT",
              "position": 500,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-12-01T19:21:45.984Z",
              "standard": false
            },
            {
              "id": "5O5PGpw4s2uPmsgVm4dJ",
              "name": "Policy Status",
              "model": "contact",
              "fieldKey": "contact.policy_status",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 500,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.993Z",
              "standard": false,
              "picklistOptions": [
                "Inforce",
                "Declined",
                "Pending",
                "Not Active",
                "Lapsed",
                "Incomplete",
                "Issued"
              ]
            },
            {
              "id": "6oUZvpESKC6lYMBVFrkW",
              "name": "Objetivo do lead",
              "model": "contact",
              "fieldKey": "contact.objetivo_do_lead",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 800,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-12-02T15:03:03.918Z",
              "standard": false,
              "picklistOptions": [
                "x",
                "x"
              ]
            },
            {
              "id": "B74QtnVtKv26woBJOyWQ",
              "name": "Work Permit",
              "model": "contact",
              "fieldKey": "contact.work_permit",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 350,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.981Z",
              "standard": false,
              "picklistOptions": [
                "Sim",
                "Não"
              ]
            },
            {
              "id": "JWxa5EEbzAYyxSHwIR1M",
              "name": "Policy Information",
              "model": "contact",
              "fieldKey": "contact.policy_information",
              "placeholder": "Policy Information",
              "dataType": "TEXT",
              "position": 400,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.992Z",
              "standard": false
            },
            {
              "id": "KyCwTVHktt5YFB0vS80i",
              "name": "agente",
              "model": "contact",
              "fieldKey": "contact.agente",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 450,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-11-14T14:18:01.986Z",
              "standard": false,
              "picklistOptions": [
                "followuper",
                "socialsellerconsultoria",
                "socialsellercarreira",
                "sdrcarreira",
                "sdrconsultoria",
                "rescheduler",
                "engagementkeeper",
                "customersuccess",
                "closer"
              ]
            },
            {
              "id": "Lv7ZJRH3FB7qfXz2zc0F",
              "name": "Antecipated Annual Premium",
              "model": "contact",
              "fieldKey": "contact.antecipated_annual_premium",
              "placeholder": "Antecipated Annual Premium",
              "dataType": "MONETORY",
              "position": 600,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.995Z",
              "standard": false
            },
            {
              "id": "Qs5Y7yd0BAnL1rWYukm3",
              "name": "Informações para AI",
              "model": "contact",
              "fieldKey": "contact.informaes_para_ai",
              "placeholder": "",
              "dataType": "LARGE_TEXT",
              "position": 350,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-19T13:49:13.762Z",
              "standard": false
            },
            {
              "id": "QscDNHLfaghT6tgXEPF8",
              "name": "Estado onde mora",
              "model": "contact",
              "fieldKey": "contact.estado_onde_mora",
              "placeholder": "Estado onde mora",
              "dataType": "TEXT",
              "position": 400,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.999Z",
              "standard": false
            },
            {
              "id": "RJ0wpy85jYkSxuhJ5n3W",
              "name": "Policy Issue Date",
              "model": "contact",
              "fieldKey": "contact.policy_issue_date",
              "placeholder": "",
              "dataType": "DATE",
              "position": 550,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:38.003Z",
              "standard": false
            },
            {
              "id": "TpoUKxaDLu5KH3ZkoTs7",
              "name": "ativar_ia",
              "model": "contact",
              "fieldKey": "contact.ativar_ia",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 850,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-12-02T15:23:57.847Z",
              "standard": false,
              "picklistOptions": [
                "x",
                "x"
              ]
            },
            {
              "id": "b1a8GRh6TphG03Xuxqzx",
              "name": "Resposta IA",
              "model": "contact",
              "fieldKey": "contact.resposta_ia",
              "placeholder": "",
              "dataType": "LARGE_TEXT",
              "position": 150,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-19T13:49:13.767Z",
              "standard": false
            },
            {
              "id": "fDcrMyGupF6DD3PvPQdW",
              "name": "FUP_counter",
              "model": "contact",
              "fieldKey": "contact.fup_counter",
              "placeholder": "",
              "dataType": "NUMERICAL",
              "position": 250,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-19T13:49:13.770Z",
              "standard": false
            }
          ],
          "traceId": "380349f6-708d-4d51-a7f9-c73d6c61545b"
        }
      }
    ],
    "Info1": [
      {
        "json": {
          "mensagem": "Olá, acabei de preencher o formulário com interesse na consulta com o Dr. Luiz",
          "source": "whatsapp",
          "first_name": "Bel",
          "last_name": "",
          "email": "belpriuli@hotmail.com",
          "telefone": null,
          "datetime": "2026-01-07T12:12:37.392Z",
          "process_id": "521392",
          "owner_origin": "sNwLyynZWP6jEtBy1ubf",
          "owner_id": "cmcprclas0000syak01gtgj80",
          "timezone_do_lead": null,
          "lead_id": "T2Pe0py0j85tN5cOHbEd",
          "mensagem_id": "1767787963237",
          "workflow_id": "HXWGWQFBY4KVfY64",
          "api_key": null,
          "location_id": "sNwLyynZWP6jEtBy1ubf",
          "tipo": null,
          "calendarID_carreira": null,
          "calendarID_consultoria_financeira": null,
          "origem_teste": "Marcos Danielss",
          "etiquetas": "lead_trafego_fb,ativar_ia",
          "area_de_atuacao": null,
          "idade": null,
          "instagram": null,
          "modelo_de_atuacao": null,
          "faturamento_medio": null,
          "investimento": null,
          "event_chat": null,
          "event_is_group": null,
          "video_ads_url": null,
          "time_zone_do_agente": null,
          "historia_do_usuario": null,
          "usuario_responsavel": " ",
          "photo_audio": null,
          "fonte_do_lead_bposs": null,
          "quebra_de_objecoes_geral": null,
          "quebra_de_objecoes_carreira": null,
          "quebra_de_objecoes_consultoria": null,
          "tipos_work_permit_permitidos": null,
          "link_do_zoom": null,
          "agendamento_duracao_minutos": "30",
          "cobranca_valor": "500",
          "id_conversa_alerta": "skfa6JP6lLlAXkc8FfIp",
          "url_asaas": "https://api-sandbox.asaas.com",
          "etapa_funil": null,
          "full_name": "Bel",
          "work_permit": null,
          "state": null,
          "location_name": "Dr. Luiz Augusto",
          "resposta_ia": "",
          "objetivo_do_lead": "indefinido",
          "ativar_ia": "sim",
          "utm_content": "Post 05 – Queda do Estradiol - 20.11.2025",
          "agente_ia": null,
          "mensagem_contexto": "",
          "is_primeira_mensagem": true,
          "tipo_lead": "NAO_IDENTIFICADO",
          "tipo_mensagem_original": "texto",
          "body": {
            "customData": {
              "ghl_api_key": null
            }
          },
          "agente_versionado": null,
          "agenda_consultorio_sao_paulo": null,
          "agenda_presidente_prudente": null,
          "agenda_consulta_online": null,
          "utm_campaign": "facebook",
          "form_procurou_ajuda_medica": "Sim, mas não tive melhora",
          "form_sintomas_atualmente\"]": "Insônia ou acorda durante a madrugada",
          "form_acredita_em_alteração_hormonal": "Sim",
          "form_udança_no_corpo": "Mudou bastante",
          "form_tipo_de_consulta": "Online",
          "form_interessado_em_investir": "Preciso entender melhor antes de decidir"
        }
      }
    ],
    "Mensagem recebida": [
      {
        "json": {
          "headers": {
            "host": "cliente-a1.mentorfy.io",
            "user-agent": "axios/1.13.2",
            "content-length": "4212",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "authorization": "Bearer pit-dc0e9761-0077-4c82-9cf5-48345d87f034",
            "content-type": "application/json",
            "traceparent": "00-1536f5e3b43044032b6a4714d18aae9d-061b6feb0256fb6d-01",
            "x-forwarded-for": "34.172.197.46",
            "x-forwarded-host": "cliente-a1.mentorfy.io",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "9e2d5292a02e",
            "x-real-ip": "34.172.197.46"
          },
          "params": {},
          "query": {},
          "body": {
            "ID cliente - Asaas": "",
            "Profissão": "",
            "Resposta IA": "Boa noite. Vi um post de vcs sobre menopausa and I am suffering a lot from it. Especially the hot flashes and insomnia at night 😩",
            "consultorio SP": "",
            "Last Appointment": "",
            "Estado onde mora": "",
            "Procurou ajuda medica": "",
            "Sintomas atualmente": "",
            "Especialista Motive": "sdr_inbound",
            "Informações para IA |socialfy|": "",
            "acredita em alteração hormonal": "",
            "Objetivo do lead": "",
            "Status Appointment": "",
            "ID cobrança - Asaas": "",
            "FUP_counter": "",
            "Status cobrança - Asaas": "",
            "Mudança no corpo": "",
            "Tratamento padrao ou personalizado": "",
            "Tipo de consulta": "",
            "Resposta IA |socialfy|": "",
            "Interessado em investir": "",
            "Permitir chamadas WhatsApp": "",
            "FUP_counter [socialfy]": "",
            "Preferência Áudio/Texto": "",
            "ativar_ia": "sim",
            "Informações para AI": "",
            "contact_id": "0GpjP6F8Q46jnZtwl0yy",
            "first_name": "Isabella",
            "last_name": ".",
            "full_name": "Isabella .",
            "email": "isabella.mottivme@gmail.com",
            "phone": "+5519989582643",
            "tags": "teste",
            "country": "BR",
            "timezone": "America/Sao_Paulo",
            "date_created": "2025-12-30T18:14:14.733Z",
            "contact_source": "Presidente Prudente - Luiz Augusto",
            "full_address": "",
            "contact_type": "lead",
            "location": {
              "name": "Dr. Luiz Augusto",
              "address": "Rua Dr Gurgel 1014, Centro",
              "city": "Pres. Prudente",
              "state": "São Paulo",
              "country": "BR",
              "postalCode": "19015-140",
              "fullAddress": "Rua Dr Gurgel 1014, Centro, Pres. Prudente São Paulo 19015-140",
              "id": "sNwLyynZWP6jEtBy1ubf"
            },
            "message": {
              "type": 20,
              "body": "Boa noite. Vi um post de vcs sobre menopausa and I am suffering a lot from it. Especially the hot flashes and insomnia at night 😩"
            },
            "workflow": {
              "id": "c1754eff-9d83-4310-982b-308ca7ab7749",
              "name": "3. AI Chat N8N - Terceiros1"
            },
            "triggerData": {},
            "contact": {
              "attributionSource": {
                "medium": "calendar",
                "adGroupId": null,
                "wbraid": null,
                "utmKeyword": null,
                "gclid": null,
                "url": "https://client.socialfy.me/widget/bookings/consulta-presidente-prudente-luiz-augustoyjo9j4",
                "gbraid": null,
                "utmMedium": null,
                "sessionSource": "Direct traffic",
                "adName": null,
                "utmSource": null,
                "ip": "187.183.36.106",
                "adId": null,
                "mediumId": "NwM2y9lck8uBAlIqr0Qi",
                "gaSessionId": null,
                "gaClientId": "GA1.2.1982658089.1765479394",
                "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
                "utmMatchtype": null,
                "utmTerm": null,
                "utmContent": null
              },
              "lastAttributionSource": {
                "referrer": null,
                "wbraid": null,
                "medium": "calendar",
                "gaClientId": "GA1.2.1982658089.1765479394",
                "utmKeyword": null,
                "adGroupId": null,
                "gclid": null,
                "utmContent": null,
                "ip": "187.183.36.106",
                "adId": null,
                "url": "https://client.socialfy.me/widget/bookings/consulta-presidente-prudente-luiz-augustoyjo9j4",
                "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
                "utmTerm": null,
                "mediumId": "NwM2y9lck8uBAlIqr0Qi",
                "utmMedium": null,
                "gbraid": null,
                "adName": null,
                "utmMatchtype": null,
                "sessionSource": "Direct traffic",
                "utmSource": null,
                "gaSessionId": null
              }
            },
            "attributionSource": {},
            "customData": {
              "ID": "0GpjP6F8Q46jnZtwl0yy",
              "message": "Boa noite. Vi um post de vcs sobre menopausa and I am suffering a lot from it. Especially the hot flashes and insomnia at night 😩",
              "name": "Isabella",
              "phone": "+5519989582643",
              "tipo": "msg",
              "ghl_api_key": "pit-dc0e9761-0077-4c82-9cf5-48345d87f034",
              "preco": "",
              "tempo": "",
              "regiao": "",
              "info": "",
              "timezone": "America/Sao_Paulo",
              "consultoria_financeira": "",
              "oportunidade": "",
              "subject": "",
              "source.url": "https://client.socialfy.me/widget/bookings/consulta-presidente-prudente-luiz-augustoyjo9j4",
              "minha_historias": "",
              "campaingn": "",
              "utm_campaign": "",
              "link_do_zoom": "",
              "photo": "",
              "pipeline_stage": "",
              "tipo_de_mensagem": "2",
              "photo_audio_nativo": "",
              "photo_audio": "",
              "fonte_do_lead_bposs": "Presidente Prudente - Luiz Augusto",
              "quebra_de_objecoes_carreira": "",
              "quebra_de_objecoes_consultoria": "",
              "quebra_de_objecoes_geral": "",
              "sobre_o_produto": "",
              "estruturas_work_permit": "",
              "work_permit": "",
              "state": "",
              "etapa_funil": "",
              "agente_ia": "sdr_inbound",
              "objetivodolead": "",
              "ativar_ia": "sim",
              "agente_versionado": "agente_versionado",
              "agenda consultorio sao paulo": "wMuTRRn8duz58kETKTWE",
              "agenda presidente prudente": "NwM2y9lck8uBAlIqr0Qi",
              "agenda online": "ZXlOuF79r6rDb0ZRi5zw"
            }
          },
          "webhookUrl": "https://cliente-a1.mentorfy.io/webhook/69c114dc-86c4-4ed0-98d4-ed5debb98b58",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Mensagem recebida": {
      "main": [
        [
          {
            "node": "FUU - Cancelar Follow-ups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInfo": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - alan",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [
          {
            "node": "Memoria IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "no.op": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          },
          {
            "node": "FUU - Agendar Follow-up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal": {
      "main": [
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.5s": {
      "main": [
        [
          {
            "node": "no.op",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data1": {
      "main": [
        [
          {
            "node": "Calcular Custo LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adicionar_tag_perdido": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Gemini2": {
      "ai_languageModel": [
        [
          {
            "node": "SDR1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "SDR1",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Busca_disponibilidade": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agendar_reuniao": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Profissão": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Estado": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem encavalada?": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens": {
      "main": [
        [
          {
            "node": "Form Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar": {
      "main": [
        [
          {
            "node": "Buscar mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.": {
      "main": [
        [
          {
            "node": "Esperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download áudio": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever audio": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Extrair a extensão",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Transcrever audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Form Mensagem": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Permitido AI?": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa Ativa": {
      "main": [
        [
          {
            "node": "Ação Planejada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ação Planejada": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Salvar Espera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Espera": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Salvar Inicio IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem ou audio": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem1": {
      "main": [
        [
          {
            "node": "Conversa ativa atualizada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Parser Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Deve enviar mensagem?": {
      "main": [
        [
          {
            "node": "Parser Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa ativa atualizada": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Atualizar resposta IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Termino de resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Termino de resposta": {
      "main": [
        [
          {
            "node": "Parser Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar resposta IA": {
      "main": [
        [
          {
            "node": "Deve enviar mensagem?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Segmentos1": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Execution Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Parser Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data2": {
      "main": [
        [
          {
            "node": "Segmentos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens": {
      "main": [
        [
          {
            "node": "SI - Insert Lead Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set mensagens2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria IA": {
      "main": [
        [
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          },
          {
            "node": "SI - Insert AI Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria Lead": {
      "main": [
        [
          {
            "node": "Deduplica Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplica Mensagens": {
      "main": [
        [
          {
            "node": "Set mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem anteriores": {
      "main": [
        [
          {
            "node": "Preparar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Contact": {
      "main": [
        [
          {
            "node": "GetInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "historico_mensagens_leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Inicio IA": {
      "main": [
        [
          {
            "node": "Mensagem anteriores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensagem": {
      "main": [
        [
          {
            "node": "Memoria Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens1": {
      "main": [
        [
          {
            "node": "Canal2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal2": {
      "main": [
        [
          {
            "node": "Whatsapp2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Limpar memória",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. Buscar Conversa do Contato": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)": {
      "main": [
        [
          {
            "node": "Resetar status atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair a extensão": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Custo LLM": {
      "main": [
        [
          {
            "node": "Call Track AI Cost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ativar_ia2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1️⃣ Listar campos customizados": {
      "main": [
        [
          {
            "node": "2️⃣ Extrair IDs dos campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2️⃣ Extrair IDs dos campos": {
      "main": [
        [
          {
            "node": "3️⃣ Detectar Objetivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3️⃣ Detectar Objetivo": {
      "main": [
        [
          {
            "node": "4️⃣ Switch Objetivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4️⃣ Switch Objetivo": {
      "main": [
        [
          {
            "node": "5️⃣ Atualizar → Carreira",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "5️⃣ Atualizar → Consultoria",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal4": {
      "main": [
        [
          {
            "node": "5️⃣ Perguntar Objetivo (SMS)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resetar status atendimento": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificar Tipo Mensagem": {
      "main": [
        [
          {
            "node": "Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem": {
      "main": [
        [
          {
            "node": "1. Buscar Conversa do Contato",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "1️⃣ Listar campos customizados",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enfileirar mensagem.",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download áudio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          },
          {
            "node": "SI - Upsert Conversation",
            "type": "main",
            "index": 0
          },
          {
            "node": "IA Ativa?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search Contact",
            "type": "main",
            "index": 0
          },
          {
            "node": "Analisar Contexto Conversa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Classificar Lead IA",
            "type": "main",
            "index": 0
          },
          {
            "node": "Veio de Tráfego?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Classificar Tipo Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data5": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Dados1": {
      "main": [
        [
          {
            "node": "Execution Data5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Nome1": {
      "main": [
        [
          {
            "node": "Normalizar Dados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contexto UTM": {
      "main": [
        [
          {
            "node": "Normalizar Nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA Ativa?": {
      "main": [
        [
          {
            "node": "Tipo de mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Tipo de mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tudo certo?4": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SDR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Chain": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alterar preferencia audio texto": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Escalar humano": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Refletir": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Listar arquivos": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar agendamento": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Enviar arquivo": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar ou buscar cobranca": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "SDR1": {
      "main": [
        [
          {
            "node": "Tudo certo?4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens2": {
      "main": [
        [
          {
            "node": "Buscar Agente Ativo2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Agente Ativo2": {
      "main": [
        [
          {
            "node": "Preparar Execução + Identificar Contexto3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Calendários1": {
      "main": [
        [
          {
            "node": "Montar Prompts Finais1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Prompts Finais1": {
      "main": [
        [
          {
            "node": "SDR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Execução + Identificar Contexto3": {
      "main": [
        [
          {
            "node": "Formatar Calendários1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match Lead Context": {
      "main": [
        [
          {
            "node": "Lead Prospectado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Prospectado?": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Prospectado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Auto Enrich Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificar Lead IA": {
      "main": [
        [
          {
            "node": "Rotear por Classificação",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rotear por Classificação": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Classificado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisar Contexto Conversa": {
      "main": [
        [
          {
            "node": "Decisão de Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decisão de Contexto": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Classificado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Já Ativou IA? (Prospectado)": {
      "main": [
        [
          {
            "node": "GHL - Tag Prospectado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Já Ativou IA? (Classificado)": {
      "main": [
        [
          {
            "node": "GHL - Tag Classificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veio de Tráfego?": {
      "main": [
        [],
        [
          {
            "node": "Match Lead Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FUU - Cancelar Follow-ups": {
      "main": [
        [
          {
            "node": "Contexto UTM",
            "type": "main",
            "index": 0
          },
          {
            "node": "FUU - Executar Cancelamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/New_York",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true,
    "errorWorkflow": "WnRF9AdjFBkEW9Ma",
    "timeSavedMode": "fixed"
  },
  "versionId": "8c5ac600-0ab5-4bee-9c93-40ae3d8dd501",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "HXWGWQFBY4KVfY64",
  "tags": [
    {
      "updatedAt": "2025-06-20T13:58:36.168Z",
      "createdAt": "2025-06-20T13:58:36.168Z",
      "id": "kEruuvE7z6URbdVG",
      "name": "Marcos-Daniel"
    }
  ]
}
{
  "name": "[ GHL ] Follow Up Eterno - V8 FUU Outbound",
  "nodes": [
    {
      "parameters": {
        "content": "# Workflow Follow Up Eterno - Go High Level (v3.1 COM MEMES)\n\n## Alteracoes v3.1:\n- ADICIONADO: Suporte a memes/GIFs no Instagram (Pattern Interrupts)\n- ADICIONADO: No \"Buscar Meme Instagram\" - busca GIF do Supabase\n- MODIFICADO: No Instagram agora envia attachments em tentativas >= 3\n- VALIDADO: API GHL aceita attachments de URLs externas (Giphy)\n\n## Tabelas necessarias:\n- n8n_schedule_tracking\n- follow_up_cadencias\n- n8n_historico_mensagens\n- n8n_custos_execucao\n- **memes_followup** (NOVA - rodar memes_followup.sql)\n\n## IMPORTANTE:\n- Executar SQL: memes_followup.sql no Supabase\n- Memes sao enviados apenas em tentativas >= 3 (pattern_interrupt)\n- Testado e funcionando com GIFs do Giphy",
        "height": 480,
        "width": 600,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32512,
        27616
      ],
      "id": "455ed36f-5ac3-431a-8b94-06a76fdffa37",
      "name": "INSTRUCOES - LEIA ANTES DE USAR"
    },
    {
      "parameters": {
        "content": "# PROMPT HUMANO v3.0 - Follow Up Eterno\n\n## Data: 2026-01-24\n## Filosofia: PRINCIPIOS + LIBERDADE CRIATIVA\n\n### MUDANCA DE PARADIGMA:\n- v2.0: Templates fixos por tentativa (robotico)\n- v3.0: Principios + liberdade para variar (humano)\n\n### O QUE O PROMPT DEFINE:\n- Principios Charlie Morgan (vagueza, escassez, brevidade)\n- Limites (max linhas, usar nome, nao cobrar)\n- Contexto (historico, canal, tentativa)\n\n### O QUE O PROMPT NAO DEFINE:\n- Mensagens prontas/templates\n- Frases fixas por tentativa\n- Scripts roboticos\n\n### VARIACAO OBRIGATORIA:\nO agente DEVE variar cada mensagem.\nMesmo cenario = respostas diferentes.\n\n### CADENCIAS:\n- WhatsApp: T1(30min) T2(2h) T3(6h) T4(24h) T5(48h) T6(72h-breakup)\n- Instagram: T1(1h) T2(4h) T3(12h-meme) T4(22h-ultimato)\n\n### ARQUIVO:\n- prompts/follow_up_humano_v3.md",
        "height": 400,
        "width": 500,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        35648,
        27664
      ],
      "id": "aacdd905-860a-49ec-b16e-5b70f7fcd821",
      "name": "PROMPT CRITICS v2.0"
    },
    {
      "parameters": {
        "content": "# FIX: NÃ³ QA - ProteÃ§Ã£o de Nome\n\n## Data: 2026-01-24\n## Problema:\nO nÃ³ QA estava trocando o nome do lead.\n\nExemplo real:\n- Assistente: 'E aÃ­ Anelize Lopes...'\n- QA: 'OlÃ¡ Renatinha!' (ERRADO!)\n\n## Causa:\nO QA lia o histÃ³rico, via um nome antigo (Renatinha) e 'corrigia' pro nome errado.\n\n## SoluÃ§Ã£o:\n1. Adicionado REGRA CRITICA no inÃ­cio do prompt\n2. VariÃ¡vel {{ name }} injetada duas vezes\n3. InstruÃ§Ã£o explÃ­cita: IGNORE nomes do histÃ³rico\n4. Regra 11: PRESERVE o nome da nova mensagem",
        "height": 320,
        "width": 400,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        36240,
        27600
      ],
      "id": "b9a181b2-0156-4c28-a46f-10ba185e4cf1",
      "name": "FIX QA - ProteÃ§Ã£o Nome"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/15 8-20 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        29008,
        29376
      ],
      "id": "a2979e5a-827c-4719-a03d-2b5d4ff72e91",
      "name": "Trigger Diario",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- V8: Unificado inbound (n8n_schedule_tracking) + outbound (fuu_queue)\nWITH ultima_msg AS (\n  SELECT DISTINCT ON (session_id)\n    session_id,\n    COALESCE(message->>'type', 'unknown') as last_sender,\n    COALESCE(message->>'content', '') as last_content,\n    created_at as last_message_at\n  FROM n8n_historico_mensagens\n  WHERE message->>'content' IS NOT NULL\n    AND message->>'content' != ''\n  ORDER BY session_id, created_at DESC\n),\n-- INBOUND: leads que vieram atÃ© nÃ³s (tabela original)\ninbound_leads AS (\n  SELECT\n    t.unique_id,\n    t.location_name,\n    COALESCE(t.source, 'whatsapp') as source,\n    COALESCE(t.follow_up_count, 0) as follow_up_count,\n    t.api_key,\n    t.location_id,\n    c.tentativa,\n    c.intervalo_minutos,\n    COALESCE(um.last_sender, 'unknown') as last_sender,\n    COALESCE(um.last_content, '') as last_content,\n    um.last_message_at as ultima_msg,\n    'sdr_inbound' as follow_up_type,\n    false as is_outbound,\n    NULL::uuid as queue_id\n  FROM n8n_schedule_tracking t\n  JOIN follow_up_cadencias c\n    ON LOWER(COALESCE(t.source, 'whatsapp')) = c.canal\n    AND COALESCE(t.follow_up_count, 0) + 1 = c.tentativa\n  LEFT JOIN ultima_msg um ON um.session_id = t.unique_id\n  WHERE t.ativo = true\n    AND t.location_id IS NOT NULL\n    AND t.api_key IS NOT NULL\n    AND (\n      (um.last_sender = 'ai' AND um.last_message_at < NOW() - (c.intervalo_minutos || ' minutes')::INTERVAL)\n      OR\n      (um.session_id IS NULL AND t.follow_up_count = 0)\n    )\n),\n-- OUTBOUND: leads que estamos prospectando (fuu_queue)\noutbound_leads AS (\n  SELECT\n    fq.contact_id as unique_id,\n    COALESCE(fq.contact_name, 'Lead') as location_name,\n    'instagram' as source,\n    fq.current_attempt as follow_up_count,\n    COALESCE(\n      (SELECT api_key FROM n8n_schedule_tracking WHERE location_id = fq.location_id LIMIT 1),\n      ''\n    ) as api_key,\n    fq.location_id,\n    fq.current_attempt + 1 as tentativa,\n    COALESCE(\n      (SELECT interval_minutes FROM fuu_cadences\n       WHERE follow_up_type = fq.follow_up_type\n         AND attempt_number = fq.current_attempt + 1\n       LIMIT 1),\n      60\n    ) as intervalo_minutos,\n    'ai' as last_sender,\n    '' as last_content,\n    fq.scheduled_at as ultima_msg,\n    fq.follow_up_type,\n    true as is_outbound,\n    fq.id as queue_id\n  FROM fuu_queue fq\n  WHERE fq.status IN ('pending', 'in_progress')\n    AND fq.scheduled_at <= NOW()\n    AND fq.follow_up_type IN ('sdr_outbound_instagram', 'sdr_outbound_instagram_reactivation')\n)\n-- UniÃ£o dos dois tipos\nSELECT * FROM inbound_leads\nUNION ALL\nSELECT * FROM outbound_leads\nORDER BY ultima_msg ASC NULLS LAST\nLIMIT 50;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        29232,
        29280
      ],
      "id": "d047ed8a-9dbe-42be-9ed6-911edcf68558",
      "name": "Sem Resposta",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        29456,
        29280
      ],
      "id": "f25a6bcd-a492-4398-8eb7-80575deae366",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        29680,
        28692
      ],
      "id": "c7cfea55-e70e-43d5-9434-d81925ddf027",
      "name": "Fim"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_schedule_tracking",
          "mode": "list",
          "cachedResultName": "n8n_schedule_tracking"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "unique_id",
              "value": "={{ $json.unique_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        29680,
        28884
      ],
      "id": "72865fe9-9355-442e-ae3a-62c78aa7c2ea",
      "name": "Ultima Atualizacao",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2f65fbdb-8bb1-4d20-8437-fbaffcad8b13",
              "leftValue": "={{ $now.diffTo($json.last_execution, 'hour') > 1 || !$json.last_execution }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        29904,
        28884
      ],
      "id": "3730c0c2-256d-4e20-9dd4-593f4f89d355",
      "name": "Passou 1h desde ultima execucao?"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Sem Resposta').first().json.unique_id }}/appointments",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "options": {}
      },
      "name": "Buscar Appointments do Contato",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        30128,
        28884
      ],
      "id": "c7800731-2227-4f93-be2f-9d11208b781f",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Sem Resposta').first().json.unique_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Sem Resposta').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        30352,
        28884
      ],
      "id": "93425c42-59c6-4fc9-a22e-ea96008f809d",
      "name": "Buscar Lead GHL",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Processamento simplificado para GHL - V3 CORRIGIDO\nconst contact = $('Buscar Lead GHL').first().json.contact || {};\n\nfunction getCustomField(contact, fieldId) {\n  if (!contact.customFields || !Array.isArray(contact.customFields)) return null;\n  const field = contact.customFields.find(cf => cf.id === fieldId);\n  return field ? field.value : null;\n}\n\nconst FIELD_IDS = {\n  ATIVAR_IA: 'YFFXi3ByB0DuISqrq6MW',\n  ESTADO: 'NBugndbaCqI3gGDn1gSB',\n  CONTADOR: 'lAzhCcLqTgUe3x2iYTN2'\n};\n\nconst simplified = {\n  id: contact.id || $('Sem Resposta').item.json.unique_id || null,\n  name: `${contact.firstName || ''} ${contact.lastName || ''}`.trim() || 'Lead',\n  email: contact.email || null,\n  phone: contact.phone || null,\n  profile_photo: contact.profilePhoto || null,\n  responsible_user_id: contact.assignedTo || null,\n  pipeline_id: contact.pipelineId || null,\n  status_id: contact.pipelineStageId || null,\n  created_at: contact.dateAdded || null,\n  updated_at: contact.dateUpdated || null,\n  tags: contact.tags || [],\n  attribution: {\n    medium: contact.attributionSource?.medium || null,\n    session_source: contact.attributionSource?.sessionSource || null\n  },\n  custom_fields: {\n    ativar_desativar_ia: getCustomField(contact, FIELD_IDS.ATIVAR_IA),\n    estado: getCustomField(contact, FIELD_IDS.ESTADO),\n    contador: getCustomField(contact, FIELD_IDS.CONTADOR)\n  },\n  location_id: contact.locationId || $('Sem Resposta').item.json.location_id || null,\n  type: contact.type || 'lead'\n};\n\nreturn {\n  success: true,\n  data: simplified\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        30576,
        29136
      ],
      "id": "50506687-0f05-41c8-b174-e05a7c89a5fa",
      "name": "Formatacao",
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('Ultima Atualizacao').item.json.unique_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "created_at"
            }
          ]
        },
        "options": {
          "queryBatching": "transaction"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        30576,
        28892
      ],
      "id": "d3c4fe1c-49d9-4578-8b8d-78bf5ff5fc1a",
      "name": "Mensagem anteriores",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- CORRIGIDO V3: Referencia correta ao contact.id\nUPDATE n8n_schedule_tracking\nSET \n  ativo = true,\n  last_execution = NOW()\nWHERE unique_id = '{{ $('Buscar Lead GHL').first().json.contact?.id || $('Sem Resposta').item.json.unique_id }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        30576,
        28640
      ],
      "id": "1969c32d-08f2-4ddb-a772-7c40b3a1ab64",
      "name": "Atualiza status IA - CORRIGIDO",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        30800,
        28876
      ],
      "id": "c278b1a0-117a-4025-bf23-c30bdf597cdb",
      "name": "Merge",
      "executeOnce": true
    },
    {
      "parameters": {
        "jsCode": "// Verificar se lead tem appointment agendado - V3\nconst appointments = $('Buscar Appointments do Contato').first().json.events || [];\nconst historico = $('Mensagem anteriores').all() || [];\n\nconst now = new Date();\n\n// Verificar appointments futuros\nconst hasUpcomingAppointment = appointments.some(apt => {\n  const aptDate = new Date(apt.startTime);\n  return aptDate > now;\n});\n\n// Verificar appointments recentes (ultimas 24h)\nconst oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\nconst hasRecentAppointment = appointments.some(apt => {\n  const aptDate = new Date(apt.startTime);\n  return aptDate > oneDayAgo && aptDate <= now;\n});\n\n// Verificar no historico se ja agendou\nconst historicoTexto = historico.map(h => (h.json.message?.content || '').toLowerCase()).join(' ');\nconst jaAgendouPorHistorico = \n  historicoTexto.includes('agendad') ||\n  historicoTexto.includes('confirmad') ||\n  historicoTexto.includes('zoom.us') ||\n  historicoTexto.includes('meet.google') ||\n  historicoTexto.includes('reuniao marcada') ||\n  historicoTexto.includes('ate la');\n\nconst deveBloquear = hasUpcomingAppointment || hasRecentAppointment || jaAgendouPorHistorico;\n\nlet motivo = 'ok';\nif (hasUpcomingAppointment) motivo = 'appointment_futuro';\nelse if (hasRecentAppointment) motivo = 'appointment_recente';\nelse if (jaAgendouPorHistorico) motivo = 'agendamento_historico';\n\nreturn [\n  {\n    json: {\n      ...$input.first().json,\n      deve_enviar_followup: !deveBloquear,\n      motivo_bloqueio: motivo,\n      appointments_count: appointments.length,\n      has_upcoming: hasUpcomingAppointment,\n      has_recent: hasRecentAppointment\n    },\n    pairedItem: { item: 0 }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31024,
        28892
      ],
      "id": "2b49f654-fa80-43ac-8a05-4641c3a49056",
      "name": "Verificar Agendamento"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "pode-enviar-fup-001",
              "leftValue": "={{ $json.deve_enviar_followup }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        31248,
        28892
      ],
      "id": "580a6a65-c04b-4aca-bfbf-6405c2ac13cc",
      "name": "Pode Enviar Follow-up?"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_id",
              "value": "={{ $('Buscar Lead GHL').item.json.contact?.id || $('Sem Resposta').item.json.unique_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        31696,
        28892
      ],
      "id": "d61b97f7-287e-43bf-90cf-a1173ca29627",
      "name": "Execution Data",
      "executeOnce": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "97f84d0c-fa78-4c19-a490-e2ca78373501",
              "name": "Horario do agendamento",
              "value": "={{ $('Buscar Appointments do Contato').item.json.events?.[0]?.startTime || null }}",
              "type": "string"
            },
            {
              "id": "a30c9893-5f86-429b-a901-1fce91088cb8",
              "name": "Tipo de comunicacao",
              "value": "={{ $('Sem Resposta').item.json.source || 'whatsapp' }}",
              "type": "string"
            },
            {
              "id": "48cf4ae1-ba13-4731-88ab-9c1c8c397df6",
              "name": "Ultima atualizacao",
              "value": "={{ $('Sem Resposta').item.json.last_execution }}",
              "type": "string"
            },
            {
              "id": "ec4e2895-3647-439d-a418-30ad9d66a70e",
              "name": "Lead Id",
              "value": "={{ $('Buscar Lead GHL').item.json.contact?.id || $('Sem Resposta').item.json.unique_id }}",
              "type": "string"
            },
            {
              "id": "d3a27bdd-cb2a-4762-83ad-dd3a717a2a7d",
              "name": "ultima_etapa",
              "value": "={{ $('Sem Resposta').item.json.value }}",
              "type": "string"
            },
            {
              "id": "65dd86be-3834-40c5-968b-d4f9e6f14dbd",
              "name": "data_criacao",
              "value": "={{ $('Sem Resposta').item.json.created_at }}",
              "type": "string"
            },
            {
              "id": "e6bedfbb-6cfc-4e5e-8571-66893f3d8ad1",
              "name": "ultimo_follow_up",
              "value": "={{ $('Sem Resposta').item.json.next_event }}",
              "type": "string"
            },
            {
              "id": "55ef44e9-fa86-439c-bf7f-af7eb8eeafc3",
              "name": "name",
              "value": "={{ $('Formatacao').first().json.data?.name || $('Buscar Lead GHL').item.json.contact?.firstName || 'Lead' }}",
              "type": "string"
            },
            {
              "id": "1eeae277-fbd6-4124-b9b6-06a93411e30d",
              "name": "responsavel",
              "value": "={{ $('Buscar Lead GHL').item.json.contact?.assignedTo }}",
              "type": "string"
            },
            {
              "id": "add48960-039c-4232-a998-a16d916fb341",
              "name": "historico_mensagens",
              "value": "={{ $('Mensagem anteriores').all().filter(item => item.json.message?.content && !item.json.message.content.includes('espond')).map(item => `${item.json.message.type === 'human' ? 'Humano' : 'IA'} [${new Date(item.json.created_at).toLocaleString('pt-BR')}]: ${item.json.message.content}`).join('\\n') || 'Sem historico' }}",
              "type": "string"
            },
            {
              "id": "581d0631-1d0e-4555-abba-6a5ab51bb4af",
              "name": "telefone",
              "value": "={{ $('Buscar Lead GHL').item.json.contact?.phone || '' }}",
              "type": "string"
            },
            {
              "id": "source-field-001",
              "name": "source",
              "value": "={{ $('Sem Resposta').item.json.source || 'whatsapp' }}",
              "type": "string"
            },
            {
              "id": "fup-count-001",
              "name": "follow_up_count",
              "value": "={{ $('Sem Resposta').item.json.follow_up_count || 0 }}",
              "type": "number"
            },
            {
              "id": "prox-tent-001",
              "name": "proxima_tentativa",
              "value": "={{ ($('Sem Resposta').item.json.follow_up_count || 0) + 1 }}",
              "type": "number"
            },
            {
              "id": "intervalo-001",
              "name": "intervalo_minutos",
              "value": "={{ $('Sem Resposta').item.json.intervalo_minutos || 30 }}",
              "type": "number"
            },
            {
              "id": "70b6d46e-b02a-425e-b920-6c256f3ae4b4",
              "name": "api_key",
              "value": "={{ $('Sem Resposta').item.json.api_key }}",
              "type": "string"
            },
            {
              "id": "0c51bbb9-c2d2-41f5-9cc8-1e41ef9b2b44",
              "name": "location_id",
              "value": "={{ $('Sem Resposta').item.json.location_id }}",
              "type": "string"
            },
            {
              "id": "last-content-001",
              "name": "ultima_mensagem_lead",
              "value": "={{ $('Sem Resposta').item.json.last_content || '' }}",
              "type": "string"
            },
            {
              "id": "last-sender-001",
              "name": "ultimo_remetente",
              "value": "={{ $('Sem Resposta').item.json.last_sender || 'ai' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        31920,
        28892
      ],
      "id": "05d60688-1e7d-4a81-97ee-5b40d459c320",
      "name": "Informacoes Relevantes - FUP"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        32664,
        29148
      ],
      "id": "344b6041-a38a-4a75-bf72-fae24ad5b0a7",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "inputText": "={{ $('Informacoes Relevantes - FUP').item.json.historico_mensagens }}",
        "options": {
          "categories": "Positive, Neutral, Negative",
          "includeDetailedResults": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.sentimentAnalysis",
      "typeVersion": 1.1,
      "position": [
        32592,
        28892
      ],
      "id": "3aead1a7-c68e-46e1-9671-8f1fab8b5f0b",
      "name": "Sentiment Analysis",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Gere uma mensagem de follow-up para o lead.",
        "options": {
          "systemMessage": "=# Follow-up Humano v3.0\n# Principios + Liberdade Criativa\n\n---\n\n## QUEM VOCE E\n\nVoce e {{ $('Config Agente FUP').first().json.agent_name || 'Assistente' }}, atendente da {{ $('Config Agente FUP').first().json.company_name || 'Empresa' }}.\nVoce conversa pelo {{ $('Informacoes Relevantes - FUP').first().json.source || 'whatsapp' }} como uma PESSOA REAL conversa.\nNao e robo. Nao e automacao. E conversa de verdade.\n\n---\n\n## CONTEXTO DESTA CONVERSA\n\n**Lead:** {{ $('Informacoes Relevantes - FUP').first().json.name }}\n**Canal:** {{ $('Informacoes Relevantes - FUP').first().json.source || 'whatsapp' }}\n**Tentativa:** {{ $('Informacoes Relevantes - FUP').first().json.proxima_tentativa || 1 }}\n**Ultima msg sua:** {{ $('Informacoes Relevantes - FUP').first().json.ultima_mensagem_lead || 'Primeira mensagem' }}\n\n**Historico:**\n{{ $('Informacoes Relevantes - FUP').first().json.historico_mensagens || 'Sem historico' }}\n\n**DNA da Vertical:**\n{{ $('Config Agente FUP').first().json.vertical_dna || 'Seja natural e amigavel.' }}\n\n---\n\n## PRINCIPIOS (Charlie Morgan)\n\n### 1. VAGUEZA\nNunca explique COMO funciona. Venda o RESULTADO.\n- NAO: Nosso metodo usa tecnicas de X e Y para...\n- SIM: Imagina resolver isso de vez?\n\n### 2. ESCASSEZ\nSua agenda e disputada. O lead precisa merecer seu tempo.\n- Surgiu uma vaga...\n- Minha agenda ta lotando...\n\n### 3. BREVIDADE\nPareca mensagem de celular. Max 2-3 linhas.\nNinguem manda textao no WhatsApp.\n\n### 4. OPCAO BINARIA\nQuando precisar de decisao, de 2 opcoes. Nunca pergunta aberta.\n- NAO: Qual horario fica bom?\n- SIM: Terca ou quinta?\n\n### 5. DESQUALIFICACAO REVERSA\nSe o lead hesita muito, retire a oferta.\n- Talvez nao seja o momento pra voce...\n- Sem problema, fica pra proxima\n\n---\n\n## REGRAS INVIOLAVEIS\n\n1. **NOME**: Use {{ $('Informacoes Relevantes - FUP').first().json.name }}. Nao invente outro.\n2. **CONTEXTO**: Continue de onde parou. Leia o historico.\n3. **NAO REPITA**: Nunca mande a mesma mensagem duas vezes.\n4. **NAO COBRE**: Nunca diga voce nao respondeu.\n5. **NAO EXPLIQUE**: Nunca detalhe o produto tecnicamente.\n\n---\n\n## COMO CONVERSAR\n\n### Tom por Canal\n- **WhatsApp**: Casual, direto, girias ok (e ai, blz, pra, vc, ta, rs)\n- **Instagram**: Mais leve, pode usar emoji, GIF se tentativa >= 3\n\n### Evolucao Natural\n- **Tentativas 1-2**: Continuidade. Retome onde parou.\n- **Tentativa 3**: Escassez leve. Surgiu uma vaga...\n- **Tentativa 4+**: Baixa pressao. Sei que ta corrido...\n- **Tentativa 5+**: Break-up. Vou dar uma pausa...\n\n### Instagram 24h (Especial)\nSe canal = Instagram e tentativa >= 3:\n- Pode mandar GIF/Meme como pattern interrupt\n- Tentativa 4: Pedir WhatsApp antes da janela fechar\n\n---\n\n## VARIACAO E OBRIGATORIA\n\nVoce DEVE variar suas mensagens. Seja imprevisivelPg Seja humano.\nExemplos de variacao para retomar conversa:\n\n- E ai [nome], sumiu rs\n- [nome]! Conseguiu ver?\n- Opa [nome], tudo certo por ai?\n- [nome] (emoji de olhos)\n- E ai, como ficou aquilo?\n- Lembrei de voce agora...\n\nEscolha UM estilo diferente a cada mensagem.\n\n---\n\n## OUTPUT\n\nRetorne APENAS a mensagem final.\n- Sem explicacoes\n- Sem comentarios\n- Sem Mensagem:\n- Apenas o texto que sera enviado\n\n---\n\n## ANTI-PATTERNS (NUNCA FACA)\n\n- Ola! Tudo bem? Como posso ajudar? (robotico)\n- Conforme conversamos anteriormente... (formal)\n- Gostaria de saber se... (vendedor)\n- Nosso produto oferece... (explicativo)\n- Voce nao respondeu minha mensagem (cobranca)\n- Repetir a mesma estrutura da msg anterior\n- Mandar textao (mais de 3 linhas)\n- Usar nome errado ou de outro lead",
          "maxIterations": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        32944,
        28892
      ],
      "id": "fb91c613-fcb8-4ff4-8c6e-671cd42f072a",
      "name": "Assistente de follow up eterno",
      "retryOnFail": false,
      "maxTries": 5,
      "waitBetweenTries": 2000,
      "executeOnce": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem que sera enviada: {{$('Assistente de follow up eterno').first().json.output}}",
        "messages": {
          "messageValues": [
            {
              "message": "=Voce e um assistente cuja unica funcao e REVISAR a mensagem antes de ela ser enviada para o usuario.\n\n## REGRA CRITICA - NOME DO LEAD\nO nome CORRETO do lead e: {{ $('Informacoes Relevantes - FUP').first().json.name }}\n- NUNCA altere o nome que aparece na [nova mensagem]\n- NUNCA use nomes que aparecem no historico se forem diferentes\n- O historico pode conter ERROS de nomes anteriores - IGNORE-OS\n- Se a nova mensagem diz 'Anelize', mantenha 'Anelize' (NAO mude para outro nome)\n\n## Contexto\n- Voce recebe como entrada o [historico] de mensagens ja trocadas e a [nova mensagem] que o sistema quer enviar.\n- Sua missao e garantir que a resposta seja clara, curta, sem repeticoes e natural.\n- Se a resposta tiver varias perguntas, simplifique para apenas UMA pergunta por vez.\n- Evite frases longas ou blocos de texto pesados.\n\n## Instrucoes\n1. Leia o [historico] para entender o que ja foi falado.\n2. Analise a [nova mensagem].\n3. Reescreva a [nova mensagem] de forma mais curta e natural.\n4. Caso haja varias perguntas, mantenha so a principal.\n5. Nao invente informacoes novas e nao mude o sentido.\n6. Responda apenas com a mensagem revisada, sem comentarios extras.\n7. Se tiver algum trecho com underline remova essa parte.\n8. Se tiver texto com parenteses ou colchetes, remova.\n9. NUNCA traduza girias literalmente. 'Correria' significa 'ocupado', NAO 'voce esta correndo'.\n10. Se a mensagem parecer repetida com algo do historico, reescreva de forma DIFERENTE.\n11. PRESERVE o nome do lead exatamente como esta na [nova mensagem].\n\n## Formato de saida\nRetorne apenas a versao revisada da mensagem final.\n\n## NOME CORRETO DO LEAD (USE ESTE)\n{{ $('Informacoes Relevantes - FUP').first().json.name }}\n\n## SENTIMENTO DA CONVERSA\n{{ $('Sentiment Analysis').item.json.sentimentAnalysis?.category || 'Neutral' }}\n\n## HISTORICO (pode conter erros de nomes - IGNORE nomes errados)\n{{ $('Informacoes Relevantes - FUP').first().json.historico_mensagens }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        33296,
        28892
      ],
      "id": "94fc777b-1727-4469-80ae-f7f15b157e79",
      "name": "QA"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem a ser formatada: {{ $json.text }}",
        "messages": {
          "messageValues": [
            {
              "message": "=Voce e especialista em formatacao de mensagem para WhatsApp. Responda apenas com o texto final.\n\n- Substitua ** por *\n- Remova #\n- Remova emojis\n- Remova \\n e quebra de linhas\n- Substitua aspas duplas por aspas simples\n- Remova partes do texto que nao fazem parte da conversa\n\nPor favor, gere a saida no seguinte formato JSON:\n{\n  \"messages\": [\n    \"splitedMessage\",\n    \"splitedMessage\"\n  ]\n}\n\nRecomendado: ideal entre 2 mensagens e no max 3."
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        33648,
        28892
      ],
      "id": "17259676-f868-440e-83ac-ebcd18f33488",
      "name": "Formatar texto",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "maxTries": 5,
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "// CORRIGIDO V3: Calcular Source e Lead ID de forma segura\nconst leadData = $('Buscar Lead GHL').first()?.json?.contact || {};\nconst semRespostaData = $('Sem Resposta').item?.json || {};\n\nconst phone = leadData?.phone;\nconst attributionMedium = leadData?.attributionSource?.medium || leadData?.lastAttributionSource?.medium;\n\nlet source;\nif (phone && phone.trim() !== '') {\n  source = 'whatsapp';\n} else if (attributionMedium === 'instagram') {\n  source = 'instagram';\n} else {\n  source = semRespostaData.source || 'whatsapp';\n}\n\n// Lead ID com fallbacks\nconst leadId = (\n  leadData?.id || \n  $('Informacoes Relevantes - FUP').first()?.json?.['Lead Id'] || \n  semRespostaData.unique_id || \n  ''\n).toString();\n\nreturn {\n  json: {\n    lead_id: leadId,\n    source: source\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        34000,
        28892
      ],
      "id": "dda63263-0e7f-441b-9bb3-0d7016302466",
      "name": "Calcular Source (Instagram vs WhatsApp)",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- CORRIGIDO V3: Atualiza source no tracking\nUPDATE n8n_schedule_tracking\nSET \n  source = '{{ $json.source }}'\nWHERE unique_id = '{{ $json.lead_id }}'\n  AND '{{ $json.lead_id }}' != '';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        34224,
        28892
      ],
      "id": "93f3873b-9303-4315-822d-ea6fd6b8f780",
      "name": "Garantir Registro Existe - COM SOURCE",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// CORRIGIDO V3: Parse JSON com tratamento de erros robusto\nconst text = $('Formatar texto').first().json.text || '';\n\n// Limpar markdown ```json ... ```\nlet cleanText = text\n  .replace(/```json\\s*/gi, '')\n  .replace(/```\\s*/g, '')\n  .trim();\n\nlet messages = [];\nlet mensagensStr = '';\n\ntry {\n  const parsed = JSON.parse(cleanText);\n  messages = parsed.messages || [];\n  mensagensStr = messages.join(' ');\n} catch (e) {\n  // Se nao for JSON valido, usa o texto direto\n  mensagensStr = cleanText;\n  messages = cleanText ? [cleanText] : [];\n}\n\nconst temMensagem = messages.length > 0 && messages[0] !== '';\nconst contemTools = mensagensStr.toLowerCase().includes('tools');\nconst contemError = mensagensStr.toLowerCase().includes('error');\nconst mensagemValida = temMensagem && !contemTools && !contemError;\n\nreturn {\n  json: {\n    mensagens: mensagensStr,\n    mensagens_array: messages,\n    tem_mensagem: temMensagem,\n    contem_tools: contemTools,\n    contem_error: contemError,\n    mensagem_valida: mensagemValida\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        34448,
        28892
      ],
      "id": "18b92ac7-b08f-4be2-ba08-71321ca4d5d2",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff19cb21-f08f-4c45-9e0c-bf15cc3a8c63",
              "leftValue": "={{ $json.tem_mensagem }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        34672,
        28788
      ],
      "id": "6f33bc6b-98bd-4f79-88c0-0e2ff46d4df5",
      "name": "Tem Mensagem?",
      "executeOnce": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b5a31f90-9b34-46f8-9cde-2faadea015d7",
              "leftValue": "={{ $json.mensagem_valida }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        34896,
        28788
      ],
      "id": "4b411551-980c-4247-a378-b407188f5e29",
      "name": "Mensagem Valida?"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": {{ JSON.stringify($json.mensagens) }},\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Informacoes Relevantes - FUP').item.json['Lead Id'].toString() }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35120,
        28788
      ],
      "id": "4fb5e58c-2676-487a-82bb-c8e770401c60",
      "name": "Salvar no Historico",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ce11f02d-1cb3-42d0-bde8-6388cf1ab4da",
              "name": "messages",
              "value": "={{ $('Code in JavaScript').first().json.mensagens_array }}",
              "type": "array"
            },
            {
              "id": "msg-string",
              "name": "mensagem",
              "value": "={{ $('Code in JavaScript').first().json.mensagens }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        35344,
        28788
      ],
      "id": "98354ad8-1f1e-4544-aee7-22fb4d8cae22",
      "name": "resposta"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_ia",
              "value": "={{ $json.mensagem }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        35568,
        28788
      ],
      "id": "0b3f1304-7652-44fb-ae4e-3ab847e92833",
      "name": "Execution Data 2"
    },
    {
      "parameters": {
        "fieldToSplitOut": "messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "a256fbfe-7805-4e73-a9ab-5d09c16cb8dc",
      "name": "Segmentos",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        36752,
        28788
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "b3aac0b1-c7fc-460b-99c7-030007dc9f42",
      "name": "Loop Mensagens",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        37040,
        28788
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Calcular Source (Instagram vs WhatsApp)').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f5034094-22ae-449d-a556-1fc1bc216e49"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "21897a45-e463-4f12-aa85-a06b148d7ecb",
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Calcular Source (Instagram vs WhatsApp)').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        37264,
        28788
      ],
      "id": "2021c96f-c1ca-4e3b-9842-10c7ffe25165",
      "name": "Canal"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Informacoes Relevantes - FUP').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{JSON.stringify({\n    \"type\": $('Informacoes Relevantes - FUP').first().json['Canal'] || \"SMS\",\n    \"contactId\": $('Informacoes Relevantes - FUP').first().json['Lead Id'],\n    \"message\": $json.url ? \"ðŸ˜…\" : $('Canal').item.json.output,\n    \"attachments\": $json.url ? [$json.url.replace('.gif', '.mp4')] : []\n  })}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        38608,
        28692
      ],
      "id": "8dcf70c5-ebf8-455b-aba7-37d32fd1e400",
      "name": "Whatsapp",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Informacoes Relevantes - FUP').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{JSON.stringify({\n    \"type\": \"IG\",\n    \"contactId\": $('Informacoes Relevantes - FUP').first().json['Lead Id'],\n    \"message\": $json.url ? \"ðŸ˜…\" : $('Canal').item.json.output,\n    \"attachments\": $json.url ? [$json.url] : []\n  })}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        38608,
        28932
      ],
      "id": "851d5b2d-8f66-481f-9f11-c44f3fc5118b",
      "name": "Instagram",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "amount": 1.5
      },
      "id": "1064643b-62db-4f0f-bc0b-7e562d9fdd56",
      "name": "Aguardar 1.5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        38832,
        28788
      ],
      "webhookId": "797b3aee-c794-439d-9ef4-1d53cc744fcf"
    },
    {
      "parameters": {},
      "id": "cbebd435-941d-41ba-947c-d8b2793d4e9b",
      "name": "Continua Loop Mensagens",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        39056,
        28860
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- CORRIGIDO V3: Atualiza follow_up_count APENAS UMA VEZ (fora do loop)\nUPDATE n8n_schedule_tracking\nSET \n  follow_up_count = COALESCE(follow_up_count, 0) + 1,\n  last_execution = NOW()\nWHERE unique_id = '{{ $('Calcular Source (Instagram vs WhatsApp)').first().json.lead_id }}'\n  AND '{{ $('Calcular Source (Instagram vs WhatsApp)').first().json.lead_id }}' != '';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        37936,
        28376
      ],
      "id": "128bb646-9633-469b-96f8-fe7e0fd39a2a",
      "name": "Atualizar Follow-up Count",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// CALCULAR TOKENS E CUSTO - FOLLOW UP ETERNO V3\n// Estima tokens baseado no tamanho do texto\n// ========================================\n\n// Precos por modelo (USD por 1M tokens)\nconst PRECOS = {\n  'gemini-2.0-flash': { input: 0.10, output: 0.40 },\n  'gemini-2.5-flash': { input: 0.075, output: 0.30 },\n  'gemini-2.5-pro': { input: 1.25, output: 10.00 },\n  'default': { input: 0.10, output: 0.40 }\n};\n\nfunction calcularCusto(modelo, tokensInput, tokensOutput) {\n  const preco = PRECOS[modelo] || PRECOS['default'];\n  return parseFloat(((tokensInput / 1000000) * preco.input + (tokensOutput / 1000000) * preco.output).toFixed(8));\n}\n\n// Estimativa de tokens (1 token ~ 4 chars em portugues)\nfunction estimarTokens(texto) {\n  if (!texto) return 0;\n  return Math.ceil(texto.length / 4);\n}\n\n// Pega dados dos nos anteriores de forma segura\nlet infoLead = {};\nlet mensagemSaida = '';\ntry {\n  infoLead = $('Informacoes Relevantes - FUP').first()?.json || {};\n} catch(e) {}\ntry {\n  mensagemSaida = $('Code in JavaScript').first()?.json?.mensagens || '';\n} catch(e) {}\n\n// Estima tokens\n// Follow Up tem ~4 chamadas de IA: Sentiment + Agent + QA + Formatar\nconst historicoMsgs = infoLead.historico_mensagens || '';\nconst systemPromptEstimado = 2000; // chars totais dos system prompts\nconst tokensInput = estimarTokens(historicoMsgs) * 4 + estimarTokens(String(systemPromptEstimado));\nconst tokensOutput = estimarTokens(mensagemSaida) * 4; // 4 outputs\n\n// Calcula custo\nconst modelo = 'gemini-2.0-flash';\nconst custoUsd = calcularCusto(modelo, tokensInput, tokensOutput);\n\n// Retorna payload para HTTP Request\nreturn {\n  json: {\n    workflow_id: $workflow.id,\n    workflow_name: $workflow.name,\n    execution_id: $execution.id,\n    contact_id: infoLead['Lead Id'] || '',\n    location_id: infoLead.location_id || '',\n    location_name: '',\n    contact_name: infoLead.name || '',\n    modelo_ia: modelo,\n    tokens_input: tokensInput,\n    tokens_output: tokensOutput,\n    custo_usd: custoUsd,\n    canal: infoLead.source || 'whatsapp',\n    tipo_acao: 'follow_up_eterno',\n    mensagem_entrada: historicoMsgs.substring(0, 1000),\n    mensagem_saida: mensagemSaida.substring(0, 1000)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        34672,
        29076
      ],
      "id": "4a332788-768a-448a-a0f5-8fd7a8f52267",
      "name": "Calcular Tokens FUP",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/n8n_custos_execucao",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmdW15d3Z3dWJ2ZXJudmhqZWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MDM3OTksImV4cCI6MjA2Njk3OTc5OX0.60VyeZ8XaD6kz7Eh5Ov_nEeDtu5woMwMJYgUM-Sruao"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmdW15d3Z3dWJ2ZXJudmhqZWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MDM3OTksImV4cCI6MjA2Njk3OTc5OX0.60VyeZ8XaD6kz7Eh5Ov_nEeDtu5woMwMJYgUM-Sruao"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34832,
        29184
      ],
      "id": "63741205-591d-4015-88b1-05598698230b",
      "name": "Registrar Custo IA - Follow Up",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Pega dados do Merge (que tem os dados consolidados)\n  const dados = $('Merge').first().json;\n\n  // Por enquanto, sempre usa ai_text (atÃ© ter a coluna action_type populada)\n  const actionType = dados.action_type || 'ai_text';\n\n  return {\n    action: actionType,\n    contact_id: dados.contact_id\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31472,
        28892
      ],
      "id": "5c49742a-edb0-47b1-a619-929adc8a3f6e",
      "name": "action: actionType"
    },
    {
      "parameters": {
        "jsCode": "// Config Agente FUP - V6 Multi-Channel\nconst config = $('Buscar Config Agente').first()?.json || {};\nconst customPrompts = config.custom_prompts || {};\nconst tentativaAtual = $('Informacoes Relevantes - FUP').item.json.proxima_tentativa || 1;\n\n// Determinar canal desta tentativa\nconst channelSequence = config.channel_sequence ||\n  ['mensagem', 'mensagem', 'ligacao_whatsapp', 'ligacao', 'mensagem'];\nconst hoursSequence = config.hours_between_attempts || [6, 24, 48, 72, 96];\n\nconst channelIndex = Math.min(tentativaAtual - 1, channelSequence.length - 1);\nconst tipoCanal = channelSequence[channelIndex];\nconst horasEspera = hoursSequence[channelIndex] || 24;\n\n// Formatar exemplos para o prompt - substituir {{nome}} por [NOME]\nconst examples = (config.message_examples || [])\n  .map(ex => {\n    const msg = (ex.message || '').replace(/\\{\\{nome\\}\\}/gi, '[NOME]');\n    return `## ${ex.situation}\\n${msg}`;\n  })\n  .join('\\n\\n');\n\n// DNA da vertical baseado no tone\nlet verticalDna = customPrompts.vertical_dna || '';\nif (!verticalDna) {\n  switch (config.tone) {\n    case 'formal':\n      verticalDna = 'Seja profissional e respeitoso. Use linguagem formal.';\n      break;\n    case 'tecnico':\n      verticalDna = 'Seja preciso e objetivo. Use termos tecnicos quando apropriado.';\n      break;\n    case 'casual':\n    default:\n      verticalDna = 'Seja amigavel e natural. Use girias brasileiras com moderacao.';\n  }\n}\n\nreturn {\n  // Identidade\n  agent_name: config.agent_name || 'Assistente',\n  company_name: config.company_name || 'Empresa',\n  company_description: config.company_description || '',\n  agent_role: config.agent_role || 'Atendente',\n\n  // DNA da vertical\n  vertical_dna: verticalDna,\n\n  // Comunicacao\n  tone: config.tone || 'casual',\n  use_slang: config.use_slang !== false,\n  use_emoji: config.use_emoji !== false,\n  max_emoji: config.max_emoji_per_message || 1,\n  max_lines: config.max_message_lines || 3,\n\n  // Tentativas\n  offer_value_attempt: config.offer_value_attempt || 3,\n  breakup_attempt: config.breakup_attempt || 5,\n\n  // Multi-canal V6\n  tipo_canal: tipoCanal,\n  horas_espera: horasEspera,\n  tentativa_atual: tentativaAtual,\n  max_tentativas: channelSequence.length,\n\n  // Twilio\n  twilio_phone: config.twilio_phone_number || '+15304186779',\n  twilio_whatsapp: config.twilio_whatsapp_number || '+5511936180422',\n  voice_webhook: config.voice_webhook_url || 'https://cliente-a1.mentorfy.io/webhook/voice-followup',\n  voice_script: config.voice_script || 'Ola! Aqui e a assistente. Posso ajudar?',\n\n  // Prompts customizados\n  custom_prompts: customPrompts,\n\n  // Exemplos formatados\n  examples_formatted: examples || '## lead_sumiu\\nOi [NOME]! Sumiu rs tudo bem?'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32368,
        28892
      ],
      "id": "88f90483-a20e-4257-8450-3a18bf3d9855",
      "name": "Config Agente FUP"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- V8: follow_up_type dinÃ¢mico (inbound vs outbound)\nSELECT\n  agent_name,\n  company_name,\n  company_description,\n  agent_role,\n  tone,\n  use_slang,\n  use_emoji,\n  max_emoji_per_message,\n  max_message_lines,\n  offer_value_attempt,\n  breakup_attempt,\n  custom_prompts,\n  message_examples\nFROM fuu_agent_configs\nWHERE (\n    location_id = '{{ $('Informacoes Relevantes - FUP').item.json.location_id }}'\n    OR location_id = 'default'\n    OR location_id = 'DEFAULT_CONFIG'\n  )\n  AND follow_up_type = COALESCE(\n      NULLIF('{{ $('Sem Resposta').item.json.follow_up_type || '' }}', ''),\n      CASE\n          WHEN LOWER(COALESCE('{{ $('Sem Resposta').item.json.source }}', 'whatsapp')) IN ('instagram', 'instagram_dm')\n               AND COALESCE({{ $('Sem Resposta').item.json.is_outbound }}, false) = true\n          THEN 'sdr_outbound_instagram'\n          ELSE 'sdr_inbound'\n      END\n  )\n  AND is_active = true\nORDER BY\n  CASE\n    WHEN location_id = '{{ $('Informacoes Relevantes - FUP').item.json.location_id }}' THEN 0\n    WHEN location_id = 'default' THEN 1\n    ELSE 2\n  END\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        32144,
        28892
      ],
      "id": "eaf1a896-e80e-48dc-af38-c9fe5acd80cb",
      "name": "Buscar Config Agente",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar meme aleatorio para Pattern Interrupt (tentativa >= 3)\nSELECT \n  id,\n  nome,\n  url,\n  tipo,\n  legenda_sugerida,\n  categoria\nFROM memes_followup\nWHERE ativo = true\n  AND (canal = 'all' OR canal = 'instagram')\n  AND tentativa_recomendada <= {{ $('Sem Resposta').item.json.tentativa || 3 }}\nORDER BY RANDOM()\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        38384,
        28932
      ],
      "id": "e3f86202-6d4c-4aa0-b028-e978467313ef",
      "name": "Buscar Meme Instagram",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar meme aleatorio para Pattern Interrupt (tentativa >= 3)\nSELECT \n  id,\n  nome,\n  url,\n  tipo,\n  legenda_sugerida,\n  categoria\nFROM memes_followup\nWHERE ativo = true\n  AND (canal = 'all' OR canal = 'whatsapp')\n  AND tentativa_recomendada <= {{ $('Sem Resposta').item.json.tentativa || 3 }}\nORDER BY RANDOM()\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        37488,
        28692
      ],
      "id": "4f57d875-8384-45ce-b764-d0cb04ababe8",
      "name": "Buscar Meme Instagram1",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "meme-url-check",
              "leftValue": "={{ $json.url }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        37712,
        28692
      ],
      "id": "b3fb8c5e-585b-43a1-9ec7-e58c3662aab6",
      "name": "Tem Meme WhatsApp?"
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n    if (item.binary) {\n      // Pega o primeiro campo binary (qualquer nome)\n      const binaryKey = Object.keys(item.binary)[0];\n      if (binaryKey) {\n        item.binary[binaryKey].mimeType = 'video/mp4';\n        item.binary[binaryKey].fileName = 'meme.mp4';\n      }\n    }\n  }\n  return $input.all();"
      },
      "name": "Corrigir MIME Type1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38160,
        28620
      ],
      "id": "7514eff9-c9e6-4683-b086-9e8ed7c4c3b3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/medias/upload-file",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Informacoes Relevantes - FUP').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "locationId",
              "value": "={{ $('Informacoes Relevantes - FUP').item.json.location_id }}"
            },
            {
              "name": "contactId",
              "value": "={{ $('Informacoes Relevantes - FUP').item.json['Lead Id'] }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Upload GIF MP4 GHL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        38384,
        28620
      ],
      "id": "6af19f59-3f8b-4959-8127-f02befa9fe6c"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        37936,
        28620
      ],
      "id": "7282e71d-bc69-448c-b302-ff6ea2549dad",
      "name": "Download Meme"
    },
    {
      "parameters": {
        "jsCode": "// --- INÃCIO DO CÃ“DIGO ---\n\n// Passo 1: Obter os dados de entrada de forma segura.\nconst inputData = $input.first()?.json || {};\nconst conversation = inputData.conversations?.[0] || {};\n\n// --- LÃ“GICA DE DECISÃƒO ---\n\nlet tipoResposta = 'texto'; // ComeÃ§amos com o padrÃ£o\nlet motivoDecisao = 'PadrÃ£o (nenhuma regra especial ativada)';\n\n// Palavras-chave que indicam que a Ãºltima mensagem do usuÃ¡rio foi um Ã¡udio.\nconst audioKeywords = ['Ã¡udio', 'audio', 'transcriÃ§Ã£o', 'transcricao'];\n\n// Passo 2 (Prioridade 1): AnÃ¡lise DinÃ¢mica da Ãšltima Mensagem\nconst lastMessageBody = conversation.lastMessageBody || '';\nconst lastMessageLower = lastMessageBody.toLowerCase();\n\n// A funÃ§Ã£o .some() verifica se pelo menos um item do array satisfaz a condiÃ§Ã£o.\nconst isLastMessageAudio = audioKeywords.some(keyword => lastMessageLower.includes(keyword));\n\nif (isLastMessageAudio) {\n  tipoResposta = 'audio';\n  motivoDecisao = 'DinÃ¢mico (Ãºltima mensagem do usuÃ¡rio foi um Ã¡udio)';\n} else {\n  // Passo 3 (Prioridade 2): AnÃ¡lise da PreferÃªncia EstÃ¡tica do UsuÃ¡rio\n  // Suporta tanto GHL (customFields) quanto outras fontes (custom_attributes).\n  const customData = inputData.customFields || inputData.custom_attributes || {};\n  const preferenciaSalva = customData.preferencia_audio_texto || 'texto';\n\n  if (preferenciaSalva === 'audio' || preferenciaSalva === 'Ã¡udio') {\n    tipoResposta = 'audio';\n    motivoDecisao = 'EstÃ¡tico (preferÃªncia salva do usuÃ¡rio Ã© Ã¡udio)';\n  } else {\n    tipoResposta = 'texto';\n    motivoDecisao = 'EstÃ¡tico (preferÃªncia salva do usuÃ¡rio Ã© texto)';\n  }\n}\n\n// --- PREPARAÃ‡ÃƒO DA SAÃDA ---\n\n// Passo 4: Determinar o formato de saÃ­da com base na decisÃ£o.\nconst formatoSaida = tipoResposta === 'audio' ? 'voice_note' : 'text';\n\n// Passo 5: Retornar um objeto JSON claro para os prÃ³ximos nÃ³s do workflow.\nreturn [{\n  json: {\n    tipo_resposta: tipoResposta,\n    formato_saida: formatoSaida,\n    deve_enviar_audio: tipoResposta === 'audio',\n    deve_enviar_texto: tipoResposta === 'texto',\n    motivo_da_decisao: motivoDecisao // Campo extra para facilitar o debug\n  }\n}];\n\n// --- FIM DO CÃ“DIGO ---"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        35792,
        28788
      ],
      "id": "af247b23-9a9d-4fde-809b-cb034ce6b19d",
      "name": "Calcular tipo da resposta"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_resposta }}",
                    "rightValue": "texto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9a7e16f-b6e4-45d7-846d-92dcb3117593",
                    "leftValue": "={{ $json.tipo_resposta }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ãudio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        36016,
        28788
      ],
      "id": "3103da23-3604-409c-a031-510091bde83f",
      "name": "Tipo da resposta"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        36760,
        28528
      ],
      "id": "83c69f58-ee8b-4193-a673-32b21c830a2c",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('SecretÃ¡ria v3 - Orthodontic2').item.json.output }}",
        "messages": {
          "messageValues": [
            {
              "message": "=VocÃª Ã© um assistente especialista em text-to-speech e formataÃ§Ã£o usando tags SSML.\n\nVocÃª irÃ¡ receber um texto e a sua tarefa Ã© aplicar tags SSML para deixÃ¡-lo mais natural no processo de geraÃ§Ã£o de voz.\n\n### FormataÃ§Ã£o\n\n#### Datas e horas\n\nNo caso de datas e horas, modifique o texto para um formato que seja mais natural quando falado.\n\nExemplos:\n\n- Entrada: '10:00'\n- SaÃ­da: 'dez horas'\n\n- Entrada: '22:00'\n- SaÃ­da: 'vinte e duas horas'\n\n- Entrada: '01/01/2025'\n- SaÃ­da: 'primeiro de janeiro de 2025'\n\n#### Telefones\n\nSimilar ao feita para datas, modifique o texto para um formato que seja mais natural quando falado. Para o DDD converta sempre em dezena, e para o resto dos nÃºmeros, adicione pausas entre cada bloco.\n\nExemplos:\n\n- Entrada: '(11) 1234-5678'\n- SaÃ­da: 'onze, um dois trÃªs quatro, cinco seis sete oito'\n\n#### EndereÃ§os\n\nFaÃ§a a mesma coisa para endereÃ§os. Exemplos:\n\n- Entrada: 'Av. Rondon Pacheco'\n- SaÃ­da: 'Avenida Rondon Pacheco'\n\n- Entrada: 'CEP 12345-000'\n- SaÃ­da: 'CEP um dois trÃªs quatro cinco zero zero zero'\n\n#### Pausas\n\nA formataÃ§Ã£o de pausas em SSML Ã© como segue:\n\n```\n<break time=\"1s\"/>\n```\n\nSempre que necessÃ¡rio, inclua pausas nesse formato.\n\n**NUNCA INCLUA PAUSAS COMO TEXTO**. Exemplo incorreto: âŒ \"Pausa de 1s\"\n\n### Notas\n\n- Sempre coloque uma pausa de 1.0s no comeÃ§o.\n- NÃ£o use breaks no meio do texto, apenas no comeÃ§o.\n- Mantenha o mesmo texto original, mas revise o uso de vÃ­rgulas excessivas para deixar o texto mais natural ao falar.\n- Remova emojis.\n- A sua saÃ­da serÃ¡ somente o texto convertido.\n- Use <speak> ao redor da saÃ­da.\n\n\n**NÃƒO INCLUA NENHUMA INFORMAÃ‡ÃƒO ALÃ‰M DO TEXTO CONVERTIDO**\n**NUNCA INCLUA CARACTER DE NOVA LINHA \"\\n\" NA SAÃDA**\n**NUNCA COLOQUE Ã‚NCORAS COMO ```ssml AO REDOR DO TEXTO**"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        36688,
        28304
      ],
      "id": "28cf5319-baa5-4610-8624-cc4fd4c30a6a",
      "name": "Formatar SSML",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Buscar atributos do contato').item.json.conversations[0].lastMessageType }}",
                    "rightValue": "=INSTAGRAM",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Buscar atributos do contato').item.json.conversations[0].lastMessageType }}",
                    "rightValue": "=SMS",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "72b10314-7aa7-477b-8ef6-40dbf288364d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        36464,
        28352
      ],
      "id": "506f1697-6479-4461-9fa2-161aabe25571",
      "name": "Canal3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info2').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info2').item.json.id_contato }}\",\n  \"locationId\": \"{{ $('Info2').item.json.location.id }}\",\n  \"message\": \"\",\n  \"attachments\": [\"{{ $('Upload Audio GHL').item.json.url }}\"]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        37712,
        28304
      ],
      "id": "8ae943d3-140f-44e4-a6af-864ba477ac76",
      "name": "Whatsapp1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/medias/upload-file",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info2').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "locationId",
              "value": "={{ $('Info2').item.json.location.id }}"
            },
            {
              "name": "contactId",
              "value": "uK6XK3QBDBL8g7tAclfB"
            }
          ]
        },
        "options": {}
      },
      "name": "Upload Audio GHL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        37488,
        28304
      ],
      "id": "77fef21c-23eb-415e-aac0-39e31b282246"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "749cfcf8-d8bf-4388-a053-ef936294f66f",
              "name": "conversations[0].lastMessageType",
              "value": "={{ $('Buscar atributos do contato').item.json.conversations[0].lastMessageType }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        36240,
        28352
      ],
      "id": "4914756d-7c05-452e-ba1c-9eddcb9a71f6",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "resource": "speech",
        "voice": {
          "__rl": true,
          "value": "j7mFKhsfnnKCmwS8wsLM",
          "mode": "list",
          "cachedResultName": "Marcos Daniels"
        },
        "text": "={{ $('Formatar SSML').item.json.text }}",
        "additionalOptions": {
          "model": {
            "__rl": true,
            "value": "eleven_flash_v2_5",
            "mode": "list"
          },
          "outputFormat": "mp3_44100_32",
          "languageCode": "pt-BR",
          "voiceSettings": "{\n  \"stability\": 0.50,\n  \"similarity_boost\": 0.75,\n  \"speed\": 1.05,\n  \"style\": 0.50,\n  \"use_speaker_boost\": true\n}"
        },
        "requestOptions": {}
      },
      "type": "@elevenlabs/n8n-nodes-elevenlabs.elevenLabs",
      "typeVersion": 1,
      "position": [
        37040,
        28304
      ],
      "id": "6939d6ea-409a-4e1f-9d4b-f32f21dec432",
      "name": "Gerar Ã¡udio1",
      "retryOnFail": true,
      "credentials": {
        "elevenLabsApi": {
          "id": "gsb0zD6AKCqe7yQv",
          "name": "ElevenLabs account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Corrige o MIME type\nfor (const item of $input.all()) {\n  if (item.binary.data) {\n    item.binary.data.mimeType = 'audio/mpeg';\n  }\n}\nreturn $input.all();"
      },
      "name": "Corrigir MIME Type",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37264,
        28304
      ],
      "id": "ffafc7ba-67ca-47f7-b302-4e8a1b08a6bf"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        29008,
        29184
      ],
      "id": "594f1e8e-7200-418b-8a92-df2be821644c",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- V8: AvanÃ§ar tentativa FUU para outbound\n-- SÃ³ executa se for outbound (queue_id nÃ£o nulo)\nDO $$\nBEGIN\n  IF '{{ $('Sem Resposta').item.json.queue_id || '' }}' != '' THEN\n    PERFORM fuu_advance_attempt(\n      p_queue_id := '{{ $('Sem Resposta').item.json.queue_id }}'::uuid,\n      p_result := 'sent'\n    );\n  END IF;\nEND $$;",
        "options": {}
      },
      "id": "fc42a95f-c545-4f0c-990e-23b1397b34f9",
      "name": "FUU: AvanÃ§ar Tentativa Outbound",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        38160,
        28376
      ],
      "notesInFlow": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "notes": "AvanÃ§a tentativa na fuu_queue para leads outbound"
    }
  ],
  "pinData": {
    "Trigger Diario": [
      {
        "json": {
          "timestamp": "2026-01-09T14:35:38.220-03:00",
          "Readable date": "January 9th 2026, 2:35:38 pm",
          "Readable time": "2:35:38 pm",
          "Day of week": "Friday",
          "Year": "2026",
          "Month": "January",
          "Day of month": "09",
          "Hour": "14",
          "Minute": "35",
          "Second": "38",
          "Timezone": "America/Sao_Paulo (UTC-03:00)"
        }
      }
    ]
  },
  "connections": {
    "Trigger Diario": {
      "main": [
        [
          {
            "node": "Sem Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sem Resposta": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Fim",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ultima Atualizacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ultima Atualizacao": {
      "main": [
        [
          {
            "node": "Passou 1h desde ultima execucao?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Passou 1h desde ultima execucao?": {
      "main": [
        [
          {
            "node": "Buscar Appointments do Contato",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Appointments do Contato": {
      "main": [
        [
          {
            "node": "Buscar Lead GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Lead GHL": {
      "main": [
        [
          {
            "node": "Formatacao",
            "type": "main",
            "index": 0
          },
          {
            "node": "Mensagem anteriores",
            "type": "main",
            "index": 0
          },
          {
            "node": "Atualiza status IA - CORRIGIDO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatacao": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Mensagem anteriores": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Atualiza status IA - CORRIGIDO": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Verificar Agendamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Agendamento": {
      "main": [
        [
          {
            "node": "Pode Enviar Follow-up?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pode Enviar Follow-up?": {
      "main": [
        [
          {
            "node": "action: actionType",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Informacoes Relevantes - FUP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Informacoes Relevantes - FUP": {
      "main": [
        [
          {
            "node": "Buscar Config Agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Sentiment Analysis",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "QA",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Formatar texto",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Assistente de follow up eterno",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Sentiment Analysis": {
      "main": [
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assistente de follow up eterno": {
      "main": [
        [
          {
            "node": "QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA": {
      "main": [
        [
          {
            "node": "Formatar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar texto": {
      "main": [
        [
          {
            "node": "Calcular Source (Instagram vs WhatsApp)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Source (Instagram vs WhatsApp)": {
      "main": [
        [
          {
            "node": "Garantir Registro Existe - COM SOURCE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Garantir Registro Existe - COM SOURCE": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Tem Mensagem?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Calcular Tokens FUP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Mensagem?": {
      "main": [
        [
          {
            "node": "Mensagem Valida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Valida?": {
      "main": [
        [
          {
            "node": "Salvar no Historico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar no Historico": {
      "main": [
        [
          {
            "node": "resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resposta": {
      "main": [
        [
          {
            "node": "Execution Data 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data 2": {
      "main": [
        [
          {
            "node": "Calcular tipo da resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Segmentos": {
      "main": [
        [
          {
            "node": "Loop Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Mensagens": {
      "main": [
        [
          {
            "node": "Atualizar Follow-up Count",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal": {
      "main": [
        [
          {
            "node": "Buscar Meme Instagram1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Meme Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp": {
      "main": [
        [
          {
            "node": "Aguardar 1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram": {
      "main": [
        [
          {
            "node": "Aguardar 1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aguardar 1.5s": {
      "main": [
        [
          {
            "node": "Continua Loop Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Continua Loop Mensagens": {
      "main": [
        [
          {
            "node": "Loop Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Follow-up Count": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          },
          {
            "node": "FUU: AvanÃ§ar Tentativa Outbound",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Tokens FUP": {
      "main": [
        [
          {
            "node": "Registrar Custo IA - Follow Up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "action: actionType": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config Agente FUP": {
      "main": [
        [
          {
            "node": "Sentiment Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Config Agente": {
      "main": [
        [
          {
            "node": "Config Agente FUP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Meme Instagram": {
      "main": [
        [
          {
            "node": "Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Meme Instagram1": {
      "main": [
        [
          {
            "node": "Tem Meme WhatsApp?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Meme WhatsApp?": {
      "main": [
        [
          {
            "node": "Download Meme",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Corrigir MIME Type1": {
      "main": [
        [
          {
            "node": "Upload GIF MP4 GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload GIF MP4 GHL": {
      "main": [
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Meme": {
      "main": [
        [
          {
            "node": "Corrigir MIME Type1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular tipo da resposta": {
      "main": [
        [
          {
            "node": "Tipo da resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo da resposta": {
      "main": [
        [
          {
            "node": "Segmentos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Formatar SSML",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Formatar SSML": {
      "main": [
        [
          {
            "node": "Gerar Ã¡udio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal3": {
      "main": [
        [
          {
            "node": "Segmentos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatar SSML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Audio GHL": {
      "main": [
        [
          {
            "node": "Whatsapp1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Canal3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Ã¡udio1": {
      "main": [
        [
          {
            "node": "Corrigir MIME Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Corrigir MIME Type": {
      "main": [
        [
          {
            "node": "Upload Audio GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp1": {
      "main": [
        [
          {
            "node": "Atualizar Follow-up Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Sem Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "0eb7a9bc-6a04-4cbc-9800-49560654b9a5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "3Yx6JniDrQw4KBCi",
  "tags": []
}
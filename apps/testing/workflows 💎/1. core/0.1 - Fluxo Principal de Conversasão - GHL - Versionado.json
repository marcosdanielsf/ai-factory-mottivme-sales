{
  "name": "0.1 - Fluxo Principal de Conversasão - GHL - Versionado",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "69c114dc-86c4-4ed0-98d4-ed5debb98b58",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        30048,
        27776
      ],
      "id": "630c1595-2c81-4b78-bdf0-afb7151ee827",
      "name": "Mensagem recebida",
      "webhookId": "69c114dc-86c4-4ed0-98d4-ed5debb98b58"
    },
    {
      "parameters": {
        "content": "# Enviando resposta\nVamos verificar se nossa resposta deve ser enviada ou não caso o usuario tenha enviado alguma mensagem durante o pensamento da IA, significa que precisamos considerar a ultima mensagem antes de responder, e o processo seguinte ira receber nossa mensagem que iriamos mandar.",
        "height": 620,
        "width": 2236,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        38256,
        27408
      ],
      "id": "caa3caaf-154e-41b2-943c-2327140d3836",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## 1. Assistencia",
        "height": 80,
        "width": 540,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        31056,
        27456
      ],
      "id": "006e1f36-e444-42b4-9aa9-919adc1507bc",
      "name": "Sticky Note30"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO execution_metrics (\n  execution_id,\n  workflow_id,\n  workflow_name,\n  workflow_version,\n  n8n_version,\n  environment,\n  status,\n  started_at,\n  owner_id\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, NOW(), $8\n)\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $json.dados }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33680,
        27200
      ],
      "id": "3c8a4e46-86e4-4dfe-ba99-717383be1a8b",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a6c297c-ff22-4d5d-9f91-35eaa64b0d9a",
              "name": "=dados",
              "value": "={{ $execution.id }},{{ $workflow.id }},{{ $workflow.name }},1,1.99,{{ $execution.mode }},running,cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "f3b2358a-0eec-409b-9d61-a27ea7fbe59d",
              "name": "session",
              "value": "=etapa,{{ $('Info').first().json.etapa_funil || 'NULL' }},{{ $execution.id }},{{ $('Info').first().json.lead_id}},{{ !$('Info').first().json.n8n_ativo === false }},{{ $('Info').first().json.mensagem_id || 'NULL' }},{{ $('Info').first().json.api_key || 'NULL' }},{{ $json.contact.locationId || NULL }},{{ $('Info').first().json.source || 'whatsapp' }},{{ $('Info').first().json.location_name || NULL }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false,
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33264,
        27376
      ],
      "id": "c54350f3-1284-4339-bd5a-4175d84a7812",
      "name": "GetInfo",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Rastreio de consumo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32368,
        27296
      ],
      "id": "400d44ae-09e9-4354-8eae-754a260a5f45",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Última mensagem e Fluxo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32816,
        27296
      ],
      "id": "a9b91862-aab2-4aae-b1cc-0a915eb6cc5f",
      "name": "Sticky Note28"
    },
    {
      "parameters": {
        "content": "## Verifica se o cliente mandou mensagem\nVerificamos se enquanto a IA está pensando, se o cliente mandou mensagem. Se sim, temos que salvar nossa mensagem para pensar novamente.",
        "height": 672,
        "width": 1200,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        37024,
        27408
      ],
      "id": "b2253d19-8257-4e0d-9afd-b9f101ced111",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "toolDescription": "Adicionar tag 'perdido'. Use quando o lead se enquadrar em qualquer situação: já cadastrado, é agente, mora no Brasil, sem interesse, ou está insatisfeito. Motivo da desqualificação deve ser especificado.",
        "method": "PUT",
        "url": "https://services.leadconnectorhq.com/contacts/{contact_Id}",
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "Authorization",
              "valueProvider": "fieldValue",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "valueProvider": "fieldValue",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tags\": [\"perdido\"]\n}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "contact_Id",
              "description": "ID do contato",
              "type": "string"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        38928,
        27936
      ],
      "id": "4c4b5480-27e7-40c4-9b55-446fba13dfcd",
      "name": "Adicionar_tag_perdido"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        37664,
        28144
      ],
      "id": "ee67773b-1b07-485d-b3c0-9c2287d6fdde",
      "name": "Gemini2",
      "notesInFlow": false,
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "gpt-5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        37760,
        28000
      ],
      "id": "c2cbb599-e559-4a7a-a051-8efe26053747",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "description": "Buscar/consultar por horários disponíveis antes de agendar. Exemplo: startDate=1735689600000 endDate=1736294400000. calendario pode ser consultoria financeira ou carreira. E dateEndTo e dateStartFrom é a data de inicio e fim, geralmente entre hoje e 7 dias. Garanta que vai buscar slots disponíveis à partir do ano 2025",
        "workflowId": {
          "__rl": true,
          "value": "pZIcRI1PGMzbQHZZ",
          "mode": "list",
          "cachedResultUrl": "/workflow/pZIcRI1PGMzbQHZZ",
          "cachedResultName": "[ GHL ] Busca Disponibilidade"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "calendar": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar', `Buscar horários disponíveis. IMPORTANTE: O parâmetro 'calendar' deve ser o ID do calendário (ex: LvZWMISiyYnF8p7TrY7q), NÃO o nome. Consulte o CONTEXTO para obter calendarID_carreira ou calendarID_consultoria conforme work permit do lead.`, 'string') }}",
            "API_KEY": "={{ $('Info').first().json.api_key }}",
            "startDate": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startDate', `exemplo: 1735689600000`, 'string') }}",
            "endDate": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('endDate', `exemplo: 1736294400000`, 'string') }}",
            "lead_id": "={{ $('Info').first().json.lead_id }}",
            "usuario_responsavel": "={{ $('Info').first().json.usuario_responsavel || 'Sistema' }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "calendar",
              "displayName": "calendar",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startDate",
              "displayName": "startDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "endDate",
              "displayName": "endDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38016,
        28000
      ],
      "id": "450bdcd1-95e0-48d6-b7e6-2f204456236e",
      "name": "Busca_disponibilidade"
    },
    {
      "parameters": {
        "description": "Agendar um nova reunião. startTime segue o seguinte padrão 2021-06-23T03:30:00+05:30.",
        "workflowId": {
          "__rl": true,
          "value": "u1UsmjNNpaEiwIsp",
          "mode": "list",
          "cachedResultUrl": "/workflow/u1UsmjNNpaEiwIsp",
          "cachedResultName": "Agendar pelo GHL - ATUALIZAR KOMMO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ $('Info').first().json.api_key }}",
            "email": "={{ $('Info').first().json.email || '' }}",
            "telefone": "={{ $('Info').first().json.telefone || '' }}",
            "location_id": "={{ $('Info').first().json.location_id }}",
            "calendar_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar_id', `Buscar horários disponíveis. IMPORTANTE: O parâmetro 'calendar' deve ser o ID do calendário (ex: LvZWMISiyYnF8p7TrY7q), NÃO o nome. Consulte o CONTEXTO para obter calendarID_carreira ou calendarID_consultoria conforme work permit do lead.`, 'string') }}",
            "startTime": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startTime', ``, 'string') }}",
            "firstName": "={{ $('Info').first().json.first_name || '' }}",
            "lastName": "={{ $('Info').first().json.last_name || '' }}",
            "lead_id": "={{ $('Info').first().json.lead_id }}",
            "Carreira_Consultoria": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Carreira_Consultoria', `Especificar o tipo do agendamento`, 'string') }}",
            "usuario_responsavel": "={{ $('Info').first().json.usuario_responsavel || 'Sistema' }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "calendar_id",
              "displayName": "calendar_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startTime",
              "displayName": "startTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "firstName",
              "displayName": "firstName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lastName",
              "displayName": "lastName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "estadoValue",
              "displayName": "estadoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "workPermitValue",
              "displayName": "workPermitValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "Carreira_Consultoria",
              "displayName": "Carreira_Consultoria",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38144,
        28000
      ],
      "id": "8dd3861f-ac0d-4de9-87cc-94443f6889f1",
      "name": "Agendar_reuniao"
    },
    {
      "parameters": {
        "description": "Atualizar a profissão/ocupação do lead (contact.profissao). Use esta tool quando o lead informar qual é sua profissão ou área de atuação atual. Valores: texto livre com a profissão (ex: Engenheiro, Médico, Empresário, Corretor de Imóveis, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "Kq3b79P6v4rTsiaH",
          "mode": "list",
          "cachedResultUrl": "/workflow/Kq3b79P6v4rTsiaH",
          "cachedResultName": "Atualizar Campo Profissão GHL (Auto-Config)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ $('Info').first().json.api_key }}",
            "location_id": "={{ $('Info').first().json.location_id }}",
            "contact_id": "={{ $('Info').first().json.lead_id }}",
            "profissaoValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('profissaoValue', `Profissão informada pelo lead`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "profissaoValue",
              "displayName": "profissaoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38304,
        27968
      ],
      "id": "b87b9a93-7da5-47d2-afe3-793d3540701e",
      "name": "Atualizar Profissão"
    },
    {
      "parameters": {
        "description": "Atualizar o estado onde o lead mora (estado_onde_mora). Use esta tool quando o lead informar em qual estado dos EUA ele reside. Valores aceitos: nomes dos estados americanos (ex: Florida, California, Texas, New York, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "wsQQYmx8CLNBHoWq",
          "mode": "list",
          "cachedResultUrl": "/workflow/wsQQYmx8CLNBHoWq",
          "cachedResultName": "Atualizar Estado GHL (Otimizado)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ $('Info').first().json.api_key }}",
            "estadoValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estadoValue', `Estado informado pelo lead (ex: Florida, California)`, 'string') }}",
            "contact_id": "={{ $('Info').first().json.lead_id }}",
            "location_id": "={{ $('Info').first().json.location_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "estadoValue",
              "displayName": "estadoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38528,
        27968
      ],
      "id": "86e12cd6-8080-451c-8d5c-56e375724640",
      "name": "Atualizar Estado"
    },
    {
      "parameters": {
        "jsCode": "// 1. Pega todas as mensagens disponíveis na fila\nconst todasMensagens = $('Buscar mensagens').all();\n\n// 2. CRÍTICO: Check de Fila Vazia (Race Condition)\n// Se a fila estiver vazia, significa que o workflow \"vencedor\" já acordou, \n// processou e limpou a fila enquanto este workflow estava esperando.\nif (!todasMensagens || todasMensagens.length === 0) {\n  return []; // Para o workflow imediatamente. Este workflow perdeu.\n}\n\n// 3. Ordenar as mensagens por timestamp (do mais recente para o mais antigo)\n// Adicionamos um desempate pelo ID da tabela caso dois timestamps sejam idênticos.\nconst filaOrdenada = todasMensagens.sort((a, b) => {\n  const tA = new Date(a.json.timestamp).getTime();\n  const tB = new Date(b.json.timestamp).getTime();\n  \n  // Se timestamps forem diferentes, ordena por tempo\n  if (tA !== tB) {\n    return tA - tB;\n  }\n  \n  // Se timestamps forem iguais (raro, mas possível), desempata pelo ID\n  return (a.json.id || 0) - (b.json.id || 0);\n});\n\n// 4. Identificar a mensagem \"Vencedora\" (a última da fila)\nconst mensagemVencedora = filaOrdenada[filaOrdenada.length - 1];\nconst idVencedor = mensagemVencedora.json.id_mensagem;\n\n// 5. Pegar o ID da mensagem que este workflow atual está processando\nconst idWorkflowAtual = $('Info').first().json.mensagem_id;\n\n// 6. Comparar: Eu sou o dono da última mensagem?\nif (idVencedor !== idWorkflowAtual) {\n  // NÃO sou o vencedor. A última mensagem pertence a outro workflow.\n  // Retorno array vazio para parar este fluxo imediatamente.\n  return []; \n}\n\n// 7. SIM, sou o vencedor!\n// Retorno TODA a fila ordenada para que a IA processe as mensagens agrupadas.\nreturn filaOrdenada;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33632,
        27824
      ],
      "id": "b19ab182-4c3f-41ce-8f8a-3d56033d3991",
      "name": "Mensagem encavalada?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33120,
        27824
      ],
      "id": "e467be4a-e6a0-4691-9011-5415ff9882fe",
      "name": "Buscar mensagens",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33920,
        27824
      ],
      "id": "681575e5-ca3f-4801-a865-b36330b22ed9",
      "name": "Limpar fila de mensagens",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "content": "# Processando mensagens encavaladas\n\nEssa etapa trata a situação em que o usuário envia múltiplas mensagens seguidas. O ponto negativo é o aumento no tempo de resposta do agente. Lógica dispensa uso de soluções mais complexas, como RabbitMQ.\n\nTempo de espera recomendado de ~16s. Quando estiver testando, recomendamos reduzir um pouco para ficar mais rápido de testar.\n",
        "height": 540,
        "width": 1216,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        32192,
        27600
      ],
      "id": "608421c9-f74c-4fa1-8f3f-b93b2308cc2d",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "amount": 26
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        32896,
        27824
      ],
      "id": "00fb4d71-dc4c-4583-8909-84494f55a09d",
      "name": "Esperar",
      "webhookId": "65baf0da-1755-4c7d-a71c-6a61d51e684c"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_fila_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "mensagem": "={{ $json.mensagem }}",
            "id_mensagem": "={{ $json.mensagem_id }}",
            "timestamp": "={{ $json.datetime }}",
            "lead_id": "={{ $json.lead_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "instagram",
              "displayName": "instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        32672,
        27824
      ],
      "id": "c7be2f45-2f57-4e1c-a477-bb11654b9ea8",
      "name": "Enfileirar mensagem.",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c3bb05a3-1c9e-4993-a20f-7d92b005cc09",
              "name": "last_db_message",
              "value": "={{ $input.last().json }}",
              "type": "string"
            },
            {
              "id": "80a47b08-9d11-4fa6-b5c0-c892bd503182",
              "name": "current_message",
              "value": "={{ $('Info').first().json.mensagem_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33344,
        27824
      ],
      "id": "03fa39e0-76ee-48bc-9bf9-f44c2fb35cbb",
      "name": "Form Mensagem"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ca54eae-15d1-49d3-af33-7a6e5d17b833",
              "leftValue": "={{ $('Info').item.json.n8n_ativo }}",
              "rightValue": "disparo realizado",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "8d1933c9-21dc-4aeb-bce7-6b20411d2801",
              "leftValue": "={{ $('Tipo de mensagem').item.json.mensagem.toLowerCase() }}",
              "rightValue": "okkk",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        35136,
        27760
      ],
      "id": "d6d247e1-dd1b-4baf-882e-4aa140be5211",
      "name": "Permitido AI?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').item.json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        34672,
        27792
      ],
      "id": "0b2d34c9-79be-47d3-96bb-56baa4553c10",
      "name": "Conversa Ativa",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isEmpty() || $json.status === 'inactive' || (new Date() - new Date($json.created_at)) > 1 * 60 * 1000  }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "be5f5420-f7d0-46e7-acb7-663377e7ff88"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Iniciar Conversa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "064c4e28-0fba-45da-8ad8-15c9678b7842",
                    "leftValue": "={{ $json.retries > 10 ||  $json.waiting_process_id && $json.status === 'active' && $json.waiting_process_id !== $('Info').item.json.process_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignorar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ccd478c2-5d5c-4e0d-a6ad-3727d8fb420e",
                    "leftValue": "={{ $json.status === 'active' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Aguardar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34896,
        27776
      ],
      "id": "cfb94209-845b-4e88-ab95-b7a6a0508b8c",
      "name": "Ação Planejada"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        35344,
        27936
      ],
      "id": "6d0e356f-1c73-4f46-9ce1-76bb539f8306",
      "name": "Wait",
      "webhookId": "08ef019b-630a-44a7-9068-e4dc674761cc"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "waiting_process_id": "={{ $('Info').item.json.process_id }}",
            "id": "={{ $('Conversa Ativa').item.json.id }}",
            "workflow_id": "={{ $json.workflow_id }}",
            "retries": "={{ $('Conversa Ativa').item.json.retries + 1 }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35136,
        27936
      ],
      "id": "0f18d69d-6a06-4789-92ff-801b90a55e1d",
      "name": "Salvar Espera",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "key": "a_lead_name",
              "value": "={{ $('Info').item.json.full_name }}"
            },
            {
              "key": "location_name",
              "value": "={{ $('Info').first().json.location_name }}"
            },
            {
              "key": "telefone",
              "value": "={{ $('Info').item.json.telefone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        35296,
        27760
      ],
      "id": "bbee597b-33ce-48c2-a849-0c2562ef033b",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ $('Unificador de Mensagens').first().json.mensagem_unificada }}",
              "type": "string"
            },
            {
              "id": "09b2dd8b-c24b-49e8-bc36-918ae46a4f6b",
              "name": "output_preview",
              "value": "={{ $json.output_preview }}",
              "type": "string"
            },
            {
              "id": "562253ae-7585-480e-ba6e-4774dbfd05ae",
              "name": "mensagens_antigas",
              "value": "={{ \n  $('Mensagem anteriores').all()\n    .map(item => {\n      const prefix = item.json.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.json.message.type === \"human\" && item.json.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.json.message.content;\n      return `[${item.json.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\") \n}}",
              "type": "string"
            },
            {
              "id": "d134ff5d-a48c-44d8-9350-572093043f53",
              "name": "=location_id",
              "value": "={{ $('Info').first().json.location_id }}",
              "type": "string"
            },
            {
              "id": "47fd8213-7810-4d93-804a-c8504da12046",
              "name": "agente_versionado",
              "value": "={{ $('Info').first().json.agente_versionado }}",
              "type": "string"
            },
            {
              "id": "887cbf69-e713-47e4-b454-b9d57b1a2beb",
              "name": "source",
              "value": "={{ $('Info').first().json.agente_ia }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        36416,
        27824
      ],
      "id": "4eb6f987-f262-42e3-8afe-eb7f8703b52b",
      "name": "Set mensagens",
      "executeOnce": true
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={{ $json.message }}",
            "session_id": "={{ $json.session_id }}",
            "location_id": "={{ $('Info').first().json.location_id }}",
            "location_name": "={{ $('Info').first().json.location_name }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_hash",
              "displayName": "message_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        36048,
        27760
      ],
      "id": "a0137b8d-d12f-4ded-b37e-8a476e0f745b",
      "name": "Memoria Lead",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Pega o item de entrada\nconst inputItems = $input.all();\n\n// Processa cada item\nconst outputItems = inputItems.map((inputItem, index) => {\n  // Pega os dados do nó Info\n  const infoData = $('Info').first().json;\n  \n  // ===== CRÍTICO: Com returnAll, Postgres retorna múltiplos items =====\n  // Precisamos pegar TODOS os items, não só o último\n  const allMessages = $('Mensagem anteriores').all();\n  \n  console.log(`Total de items do Postgres: ${allMessages.length}`);\n  \n  // Transforma todos os items em um array de mensagens\n  const msgArray = allMessages\n    .map(item => item.json)\n    .filter(item => {\n      return item && item.created_at && item.message && item.message.content;\n    });\n  \n  console.log(`Total de mensagens válidas: ${msgArray.length}`);\n  \n  // Adiciona a mensagem ATUAL do lead ao histórico\n  const mensagemAtual = infoData.mensagem;\n  if (mensagemAtual && mensagemAtual.trim()) {\n    msgArray.push({\n      created_at: new Date().toISOString(),\n      message: {\n        type: \"human\",\n        content: mensagemAtual\n      }\n    });\n  }\n  \n  console.log(`Total com mensagem atual: ${msgArray.length}`);\n  \n  // Deduplica por timestamp + conteúdo\n  const seen = new Map();\n  const unique = msgArray.filter(item => {\n    // Cria chave única baseada em timestamp e conteúdo\n    const timestamp = new Date(item.created_at).getTime();\n    const content = item.message?.content || '';\n    const key = `${timestamp}_${content.substring(0, 100)}`;\n    \n    // Se já viu essa chave, ignora\n    if (seen.has(key)) {\n      console.log(`Duplicata encontrada: ${content.substring(0, 50)}...`);\n      return false;\n    }\n    \n    seen.set(key, true);\n    return true;\n  });\n  \n  console.log(`Mensagens após deduplicação: ${unique.length}`);\n  \n  // Formata as mensagens em ordem cronológica\n  const mensagens_antigas = unique\n    .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))\n    .map(item => {\n      const prefix = item.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.message.type === \"human\" && item.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.message.content;\n      return `[${item.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\");\n  \n  console.log(`Histórico formatado com ${mensagens_antigas.split('\\n\\n').length} mensagens`);\n  \n  // Retorna mantendo o pairedItem\n  return {\n    json: {\n      mensagens_antigas: mensagens_antigas,\n      mensagens_count: unique.length,\n      ...inputItem.json,\n      ...infoData\n    },\n    pairedItem: inputItem.pairedItem\n  };\n});\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36192,
        27760
      ],
      "id": "0eb13a0e-3677-4f32-9709-420e3076f10d",
      "name": "Deduplica Mensagens"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "created_at"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35664,
        27760
      ],
      "id": "14e9d2a0-084b-4f6a-8a41-dbe3a1a8184e",
      "name": "Mensagem anteriores",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        }
      },
      "name": "Search Contact",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        32880,
        27376
      ],
      "id": "a329dabd-e6d0-4b4a-b82b-92f64edcefe0",
      "executeOnce": false,
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "notes": "Busca contato por EMAIL"
    },
    {
      "parameters": {
        "content": "## Importante\n\nEssa tool cria campo no Socialfy, basta solicitar ao Claude o campo que quer criar e copiar o campo a baixo e colar no claude para dar como referencia",
        "height": 320,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        31056,
        27104
      ],
      "id": "2d54b14d-f5e8-451e-96d5-5d18150e79d9",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb6433a3-a8c8-41fc-ba24-c5508055f5e7",
              "name": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}",
              "type": "string"
            },
            {
              "id": "e3c59cf4-b8fb-47bd-9201-0cde177d3f2c",
              "name": "mensagem",
              "value": "={{ $('Info').first().json.mensagem }}",
              "type": "string"
            },
            {
              "id": "551981a4-e58d-4ee7-b27f-1d1bba8fde43",
              "name": "datetime",
              "value": "={{ $('Info').first().json.datetime }}",
              "type": "string"
            },
            {
              "id": "74b98426-15c4-4a10-9978-f310ad162656",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            },
            {
              "id": "30c0f0ec-8f71-4d0d-8e88-dfad7fa31d63",
              "name": "full_name",
              "value": "={{ $('Info').item.json.full_name }}",
              "type": "string"
            },
            {
              "id": "96903a49-e8ca-4f89-ac29-404fa61b5a7e",
              "name": "api_key",
              "value": "={{ $json.api_key }}",
              "type": "string"
            },
            {
              "id": "9621f071-1ddc-4b66-8fd1-1152035f623d",
              "name": "location.id",
              "value": "={{ $json.location_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32848,
        27152
      ],
      "id": "42bc4433-382a-46e6-89f2-32af7a03f33c",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').item.json.lead_id }}",
            "lead_name": "={{ $('Info').item.json.first_name }}",
            "status": "active",
            "id": "={{ $('Conversa Ativa').item.json.id || $('Info').item.json.process_id }}",
            "owner_id": "={{ $('Info').item.json.owner_id }}",
            "workflow_id": "={{ $('Info').item.json.workflow_id }}",
            "waiting_process_id": "={{ null }}",
            "retries": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        35472,
        27760
      ],
      "id": "510dea73-8b15-4ccc-aeea-68871555dafd",
      "name": "Salvar Inicio IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO ops_schedule_tracking (\n  field, value, execution_id, unique_id, ativo, chat_id, api_key, location_id, source\n) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\nON CONFLICT (unique_id) DO UPDATE SET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id,\n  api_key = EXCLUDED.api_key,\n  location_id = EXCLUDED.location_id,\n  source = EXCLUDED.source;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        34112,
        27376
      ],
      "id": "91a9106f-ebb0-47b6-ab81-1157b5003a02",
      "name": "Salvar registro de Atividade - marcos",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  field,\n  value,\n  execution_id,\n  unique_id,\n  ativo,\n  chat_id,\n  api_key,\n  location_id,\n  source,\n  follow_up_count,\n  location_name\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, $8, $9, 0, $10\n)\nON CONFLICT (unique_id) DO UPDATE\nSET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id,\n  api_key = COALESCE(EXCLUDED.api_key, n8n_schedule_tracking.api_key),\n  location_id = COALESCE(EXCLUDED.location_id, n8n_schedule_tracking.location_id),\n  source = COALESCE(EXCLUDED.source, n8n_schedule_tracking.source),\n  location_name = COALESCE(EXCLUDED.location_name, n8n_schedule_tracking.location_name),\n  follow_up_count = 0;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33904,
        27376
      ],
      "id": "913c4ed6-c362-4898-bc2e-d4ec7f775086",
      "name": "Salvar registro de Atividade - alan",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "Inserir automação para disparar quando acionar a tag"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        31072,
        28192
      ],
      "typeVersion": 1,
      "id": "a6cf5ea7-d3b2-4ff3-bbcc-3d925a47da49",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "jsCode": "// Sanitiza a mensagem e constrói o objeto corretamente\nconst info = $('Info').first().json;\nconst mensagem = info.mensagem || '';\n\n// Sanitiza quebras de linha\nconst mensagemLimpa = mensagem\n  .trim()\n  .replace(/\\r\\n/g, '\\n')\n  .replace(/\\r/g, '\\n');\n\n// Retorna o OBJETO diretamente\nreturn [{\n  json: {\n    lead_id: info.lead_id,\n    session_id: info.lead_id,\n    message: {\n      type: \"human\",\n      content: mensagemLimpa,\n      tool_calls: [],\n      additional_kwargs: {},\n      response_metadata: {},\n      invalid_tool_calls: []\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        35840,
        27760
      ],
      "id": "8bca2544-08ec-4041-a3fc-c281974325c2",
      "name": "Preparar Mensagem"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "name"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        34224,
        26848
      ],
      "id": "4698c6fe-88f0-480a-ba56-53c168a4c168",
      "name": "Limpar fila de mensagens1",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Edit Fields').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Edit Fields').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34384,
        26848
      ],
      "id": "88cca8ee-760c-4fa2-ad30-24f5d668f7d6",
      "name": "Canal2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Memória resetada.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34608,
        26944
      ],
      "id": "97208a0a-b63f-4654-8d14-6b55d14402c0",
      "name": "Instagram2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Memória resetada.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34608,
        26752
      ],
      "id": "451e9c45-0452-4070-a82d-0445ac3a0b66",
      "name": "Whatsapp2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        34832,
        26848
      ],
      "id": "4eeb5a71-cb28-4648-8d56-70f49b2aec49"
    },
    {
      "parameters": {
        "content": "## Resetar conversa\n",
        "height": 288,
        "width": 1200,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        33216,
        26752
      ],
      "typeVersion": 1,
      "id": "5195ee87-a67c-46b5-bda6-8943486765c7",
      "name": "Sticky Note10",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Habilitar testes\n",
        "height": 784,
        "width": 1920,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32672,
        25920
      ],
      "typeVersion": 1,
      "id": "346aad4e-92ba-461f-b3dd-1269784788e1",
      "name": "Sticky Note21",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Enviar mensagem\n",
        "height": 372,
        "width": 724
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        34288,
        26736
      ],
      "typeVersion": 1,
      "id": "cf94abab-4218-4bb2-9d45-2f27bbec1ed1",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "jsCode": "// Extrai o ID da conversa mais recente\nconst data = $input.first().json;\n\nif (data.conversations && data.conversations.length > 0) {\n  const conversationId = data.conversations[0].id;\n  \n  return [{\n    json: {\n      conversationId: conversationId,\n      contactId: $input.first().json.body?.contact_id || data.conversations[0].contactId\n    }\n  }];\n}\n\n// Se não encontrar conversa, retorna vazio\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32880,
        26848
      ],
      "id": "7e2b403e-cbe7-4753-89b5-964773cab293",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "99b0ce86-bc45-49c1-89cf-bbdc50e6bdd4",
              "name": "conversationId",
              "value": "={{ $json.conversationId }}",
              "type": "string"
            },
            {
              "id": "504ecb36-c7b7-4ee5-8d06-7473f9e0ff43",
              "name": "contactId",
              "value": "={{ $json.contactId }}",
              "type": "string"
            },
            {
              "id": "5ca544f2-b852-4290-83e3-fe3ab977b6d3",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33104,
        26848
      ],
      "id": "c89369b5-ff3e-45b5-9b3e-8459c19f066f",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/conversations/search?contactId={{ $('Info').first().json.lead_id }}&limit=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32656,
        26848
      ],
      "id": "b476e418-f096-476b-98b9-d80a4a07be77",
      "name": "1. Buscar Conversa do Contato",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Edit Fields').item.json.contactId }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=reset"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        33776,
        26848
      ],
      "id": "da6e0724-75d7-4304-a0c7-73490d95f056"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\n      \"id\": \"{{ $json.ativar_ia_id }}\",\n      \"value\": \"sim\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33552,
        26848
      ],
      "id": "fb02f2c7-8db9-4542-9bbb-5e07e83e5f20",
      "name": "ativar_ia2",
      "notes": "Atualiza o campo customizado work_permit no contato"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/locations/{{ $('Info').first().json.location_id }}/customFields",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32736,
        26224
      ],
      "id": "75d35f4f-547a-4e1b-9e0e-10d39597db9d",
      "name": "1️⃣ Listar campos customizados"
    },
    {
      "parameters": {
        "jsCode": "const infoNode = $('Info').first().json;\nconst inputData = $input.first().json;\n\n// ========== 1. EXTRAI CAMPOS CUSTOMIZADOS ==========\nlet customFields = [];\n\nif (inputData.customFields) {\n  customFields = inputData.customFields;\n} else if (Array.isArray(inputData) && inputData[0]?.customFields) {\n  customFields = inputData[0].customFields;\n}\n\nconst ativarIAField = customFields.find(f => f.fieldKey === \"contact.ativar_ia\");\nconst especialistaMotiveField = customFields.find(f => f.fieldKey === \"contact.contactmotive_responsavel\");\nconst objetivoLeadField = customFields.find(f => f.fieldKey === \"contact.objetivo_do_lead\");\n\n// Pega as opções válidas diretamente do picklist do GHL\nconst opcoesObjetivoValidas = (objetivoLeadField?.picklistOptions || []).filter(opt => opt !== 'x');\nconst opcoesEspecialistaValidas = especialistaMotiveField?.picklistOptions || [];\n\n// ========== 2. EXTRAI CONVERSATION ID ==========\nlet conversationId = null;\nlet contactId = infoNode.lead_id || null;\n\nif (inputData.conversations && inputData.conversations.length > 0) {\n  conversationId = inputData.conversations[0].id;\n  contactId = inputData.body?.contact_id || inputData.conversations[0].contactId || contactId;\n}\n\n// ========== 3. DETECTA OBJETIVO ==========\nfunction getString(valor) {\n  if (!valor) return '';\n  if (typeof valor === 'string') return valor;\n  if (typeof valor === 'object') {\n    return valor.text || valor.message || valor.content || '';\n  }\n  return String(valor);\n}\n\nconst mensagem = getString(infoNode.message || infoNode.body).toLowerCase();\nconst objetivoDoLead = getString(infoNode.objetivo_do_lead).toLowerCase();\nconst especialistaMotive = getString(infoNode.contactmotive_responsavel).toLowerCase();\nconst informacoesIA = getString(infoNode.informaes_para_ai).toLowerCase();\n\nconst keywordsCarreira = ['carreira', 'recrutamento', 'recrutar', 'vaga', 'emprego', 'trabalho', 'sdrcarreira', 'socialsellercarreira'];\nconst keywordsConsultoria = ['consultoria', 'consultor', 'mentor', 'mentoria', 'sdrconsultoria', 'socialsellerconsultoria'];\n\nfunction contemKeyword(texto, keywords) {\n  return keywords.some(kw => texto.includes(kw));\n}\n\nfunction detectarObjetivo(texto) {\n  if (contemKeyword(texto, keywordsCarreira)) return 'carreira';\n  if (contemKeyword(texto, keywordsConsultoria)) return 'consultoria';\n  return null;\n}\n\n// Mapeamento objetivo → especialista\nfunction getEspecialista(objetivo) {\n  if (objetivo === 'carreira') return 'sdrcarreira';\n  if (objetivo === 'consultoria') return 'sdrconsultoria';\n  return '';\n}\n\nconst textoCompleto = `${mensagem} ${objetivoDoLead} ${especialistaMotive} ${informacoesIA}`;\n\nconst regexTeste = /\\/teste\\s+(carreira|recrutamento|consultoria|consultor|mentor)/i;\nconst matchTeste = mensagem.match(regexTeste);\n\nlet resultado = 'indefinido';\nlet especialistaDefinido = '';\nlet objetivoDefinido = '';\nlet fonteDeteccao = 'nenhuma';\n\n// Prioridade 1: Comando /teste na mensagem\nif (matchTeste) {\n  const objetivoDetectado = detectarObjetivo(matchTeste[1].toLowerCase());\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'comando_teste';\n  }\n}\n\n// Prioridade 2: Campo objetivo_do_lead já preenchido COM VALOR VÁLIDO\nif (resultado === 'indefinido' && objetivoDoLead && opcoesObjetivoValidas.includes(objetivoDoLead)) {\n  resultado = objetivoDoLead;\n  especialistaDefinido = getEspecialista(objetivoDoLead);\n  objetivoDefinido = objetivoDoLead;\n  fonteDeteccao = 'campo_objetivo';\n}\n\n// Prioridade 3: Especialista já definido\nif (resultado === 'indefinido' && especialistaMotive) {\n  const objetivoDetectado = detectarObjetivo(especialistaMotive);\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'campo_especialista';\n  }\n}\n\n// Prioridade 4: Análise do texto completo\nif (resultado === 'indefinido') {\n  const objetivoDetectado = detectarObjetivo(textoCompleto);\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'analise_texto';\n  }\n}\n\n// ========== RETORNA TUDO ==========\nreturn [{\n  json: {\n    // IDs dos campos\n    ativar_ia_id: ativarIAField?.id || null,\n    especialista_motive_id: especialistaMotiveField?.id || null,\n    objetivo_lead_id: objetivoLeadField?.id || null,\n    \n    // IDs da conversa\n    conversationId: conversationId,\n    contactId: contactId,\n    \n    // Resultado da detecção\n    resultado: resultado,\n    especialista_motive: especialistaDefinido,\n    objetivo_lead: objetivoDefinido,\n    fonte_deteccao: fonteDeteccao,\n    precisa_perguntar: resultado === 'indefinido',\n    mensagem_original: mensagem,\n    \n    // Debug - opções válidas do GHL\n    opcoes_objetivo_validas: opcoesObjetivoValidas,\n    opcoes_especialista_validas: opcoesEspecialistaValidas\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32944,
        26224
      ],
      "id": "ec70a04c-1558-421f-8672-ba486592bcf5",
      "name": "2️⃣ Extrair IDs dos campos"
    },
    {
      "parameters": {
        "jsCode": "const infoNode = $('Info').first().json;\nconst inputData = $input.first().json;\n\n// ========== 1. EXTRAI CAMPOS CUSTOMIZADOS ==========\nlet customFields = [];\n\nif (Array.isArray(inputData)) {\n  customFields = inputData[0]?.customFields || [];\n} else if (inputData.customFields) {\n  customFields = inputData.customFields;\n}\n\nconst ativarIAField = customFields.find(f => f.fieldKey === \"contact.ativar_ia\");\nconst especialistaMotiveField = customFields.find(f => f.fieldKey === \"contact.contactmotive_responsavel\");\nconst objetivoLeadField = customFields.find(f => f.fieldKey === \"contact.objetivo_do_lead\");\n\n// Pega APENAS opções válidas do GHL (filtra 'x' e vazios)\nconst opcoesObjetivoValidas = (objetivoLeadField?.picklistOptions || []).filter(opt => opt && opt.toLowerCase() !== 'x');\nconst opcoesEspecialistaValidas = (especialistaMotiveField?.picklistOptions || []).filter(opt => opt && opt.toLowerCase() !== 'x');\n\n// ========== 2. EXTRAI CONVERSATION ID E SOURCE ==========\nlet conversationId = null;\nlet contactId = infoNode.lead_id || null;\nlet source = (infoNode.source || infoNode.channel || '').toLowerCase();\n\nif (inputData.conversations && inputData.conversations.length > 0) {\n  conversationId = inputData.conversations[0].id;\n  contactId = inputData.body?.contact_id || inputData.conversations[0].contactId || contactId;\n}\n\n// ========== 3. DETECTA OBJETIVO ==========\nfunction getString(valor) {\n  if (!valor) return '';\n  if (typeof valor === 'string') return valor;\n  if (typeof valor === 'object') {\n    return valor.text || valor.message || valor.content || '';\n  }\n  return String(valor);\n}\n\nconst mensagem = getString(infoNode.message || infoNode.body).toLowerCase();\nconst objetivoDoLead = getString(infoNode.objetivo_do_lead).toLowerCase();\nconst especialistaMotive = getString(infoNode.contactmotive_responsavel).toLowerCase();\nconst informacoesIA = getString(infoNode.informaes_para_ai).toLowerCase();\n\nconst keywordsCarreira = ['carreira', 'recrutamento', 'recrutar', 'vaga', 'emprego', 'trabalho'];\nconst keywordsConsultoria = ['consultoria', 'consultor', 'mentor', 'mentoria'];\n\nfunction contemKeyword(texto, keywords) {\n  return keywords.some(kw => texto.includes(kw));\n}\n\nfunction detectarObjetivo(texto) {\n  if (contemKeyword(texto, keywordsCarreira)) return 'carreira';\n  if (contemKeyword(texto, keywordsConsultoria)) return 'consultoria';\n  return null;\n}\n\nfunction getEspecialista(objetivo) {\n  if (objetivo === 'carreira') return 'sdrcarreira';\n  if (objetivo === 'consultoria') return 'sdrconsultoria';\n  return '';\n}\n\n// Verifica se opções válidas existem no GHL\nconst temOpcoesValidas = opcoesObjetivoValidas.length > 0;\n\nconst textoCompleto = `${mensagem} ${objetivoDoLead} ${especialistaMotive} ${informacoesIA}`;\n\nconst regexTeste = /\\/teste\\s+(carreira|recrutamento|consultoria|consultor|mentor)/i;\nconst matchTeste = mensagem.match(regexTeste);\n\nlet resultado = 'indefinido';\nlet especialistaDefinido = '';\nlet objetivoDefinido = '';\nlet fonteDeteccao = 'nenhuma';\n\n// SÓ DETECTA SE TIVER OPÇÕES VÁLIDAS NO GHL\nif (temOpcoesValidas) {\n  \n  // Prioridade 1: Comando /teste na mensagem\n  if (matchTeste) {\n    const objetivoDetectado = detectarObjetivo(matchTeste[1].toLowerCase());\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'comando_teste';\n    }\n  }\n\n  // Prioridade 2: Campo objetivo_do_lead já preenchido COM VALOR VÁLIDO\n  if (resultado === 'indefinido' && objetivoDoLead && opcoesObjetivoValidas.includes(objetivoDoLead)) {\n    resultado = objetivoDoLead;\n    especialistaDefinido = getEspecialista(objetivoDoLead);\n    objetivoDefinido = objetivoDoLead;\n    fonteDeteccao = 'campo_objetivo';\n  }\n\n  // Prioridade 3: Especialista já definido\n  if (resultado === 'indefinido' && especialistaMotive) {\n    const objetivoDetectado = detectarObjetivo(especialistaMotive);\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'campo_especialista';\n    }\n  }\n\n  // Prioridade 4: Análise do texto completo\n  if (resultado === 'indefinido') {\n    const objetivoDetectado = detectarObjetivo(textoCompleto);\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'analise_texto';\n    }\n  }\n}\n\n// ========== RETORNA TUDO ==========\nreturn [{\n  json: {\n    // IDs dos campos\n    ativar_ia_id: ativarIAField?.id || null,\n    especialista_motive_id: especialistaMotiveField?.id || null,\n    objetivo_lead_id: objetivoLeadField?.id || null,\n    \n    // IDs da conversa\n    conversationId: conversationId,\n    contactId: contactId,\n    source: source,\n    \n    // Resultado da detecção\n    resultado: resultado,\n    especialista_motive: especialistaDefinido,\n    objetivo_lead: objetivoDefinido,\n    fonte_deteccao: fonteDeteccao,\n    precisa_perguntar: resultado === 'indefinido',\n    mensagem_original: mensagem,\n    \n    // Debug\n    opcoes_ghl_validas: opcoesObjetivoValidas,\n    tem_opcoes_validas: temOpcoesValidas\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33168,
        26224
      ],
      "id": "3d76f09f-7782-40a4-a63f-97179ded8aa2",
      "name": "3️⃣ Detectar Objetivo"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.resultado }}",
                    "rightValue": "carreira",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "76eef0e3-72b2-4beb-8523-04aca6b0f026"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Carreira"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.resultado }}",
                    "rightValue": "consultoria",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "68e4057a-3f5f-4b5e-990c-52b9618888a4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Consultoria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.resultado }}",
                    "rightValue": "indefinido",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cb77dbef-ac1e-4b2a-a6f0-f011e353e870"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Indefinido"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        33392,
        26208
      ],
      "id": "c3d59d29-0e41-4b7c-802e-bac79fa2e8a4",
      "name": "4️⃣ Switch Objetivo"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.especialista_motive_id }}\",\n      \"value\": \"sdrcarreira\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.objetivo_lead_id }}\",\n      \"value\": \"carreira\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.ativar_ia_id }}\",\n      \"value\": \"sim\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33616,
        26032
      ],
      "id": "ff1050a1-fc14-4d85-8cd1-49fd10472b57",
      "name": "5️⃣ Atualizar → Carreira"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.especialista_motive_id }}\",\n      \"value\": \"sdrconsultoria\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.objetivo_lead_id }}\",\n      \"value\": \"consultoria\"\n    },\n    {\n      \"id\": \"{{ $('3️⃣ Detectar Objetivo').first().json.ativar_ia_id }}\",\n      \"value\": \"sim\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33616,
        26224
      ],
      "id": "2105b171-1514-4150-8425-9e78d1352932",
      "name": "5️⃣ Atualizar → Consultoria"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Olá! Para continuar, preciso saber seu objetivo. Por favor, responda:\\n\\n/teste carreira - para oportunidades de emprego\\n/teste consultoria - para serviços de consultoria\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33840,
        26320
      ],
      "id": "9360149a-fe3a-4227-98d1-c140d758f12a",
      "name": "5️⃣ Perguntar Objetivo (SMS)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        33616,
        26416
      ],
      "id": "04f18cad-9a93-4d63-a2de-be646fd38633",
      "name": "Canal4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Olá! Para continuar, preciso saber seu objetivo. Por favor, responda:\\n\\n/teste carreira - para oportunidades de emprego\\n/teste consultoria - para serviços de consultoria\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33840,
        26512
      ],
      "id": "c219d2de-3e23-4f3c-809f-f888e410f564",
      "name": "Instagram4",
      "retryOnFail": true
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            },
            {
              "id": "message_hash",
              "displayName": "message_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        34016,
        26848
      ],
      "id": "1e7b51a3-5d25-4127-87d3-8360628ce681",
      "name": "Resetar status atendimento",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const customData = $input.first().json.body?.customData || $input.first().json.customData || {};\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst anexo = (\n  customData.attachments || \n  customData.photo_audio || \n  body.attachments ||\n  body.photo_audio ||\n  ''\n).toLowerCase();\n\nlet tipo_mensagem_original = 'texto';\n\n// Imagens\nif (anexo.includes('.jpg') || anexo.includes('.jpeg') || anexo.includes('.png') || anexo.includes('.gif') || anexo.includes('.webp')) {\n  tipo_mensagem_original = 'imagem';\n}\n// PDF\nelse if (anexo.includes('.pdf')) {\n  tipo_mensagem_original = 'pdf';\n}\n// Planilhas e CSV\nelse if (anexo.includes('.csv') || anexo.includes('.xls') || anexo.includes('.xlsx')) {\n  tipo_mensagem_original = 'planilha';\n}\n// Áudio - AGORA INCLUI .MP4\nelse if (anexo.includes('.mp3') || anexo.includes('.ogg') || anexo.includes('.wav') || anexo.includes('.m4a') || anexo.includes('.opus') || anexo.includes('.mp4')) {\n  tipo_mensagem_original = 'audio';\n}\n// Documentos Word\nelse if (anexo.includes('.doc') || anexo.includes('.docx')) {\n  tipo_mensagem_original = 'documento_word';\n}\n\nreturn {\n  ...$input.first().json,\n  tipo_mensagem_original,\n  anexo_url: anexo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31616,
        27776
      ],
      "id": "3fafd86b-eeba-4622-af62-bb8f130a728e",
      "name": "Classificar Tipo Mensagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8be8461d-83f1-4563-9e2e-46e978d3afb4",
              "name": "location_id",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "15265189-0d84-420c-b7da-6181170a6b08",
              "name": "location_name",
              "value": "={{ $json.body?.location?.name }}",
              "type": "string"
            },
            {
              "id": "ab843596-5dfa-41d7-8ac4-02cd1dd5b661",
              "name": "api_key",
              "value": "={{ $json.body?.customData?.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "ccb3a74d-0336-4a28-9f43-7bdaff77b906",
              "name": "source",
              "value": "={{ \n  // Prioriza o canal da mensagem ATUAL, não a origem do lead\n  (() => {\n    const messageType = $json.body?.message?.type;\n    \n    // Type 2 = SMS - responde por SMS (usa \"whatsapp\" que no seu workflow envia SMS)\n    if (messageType === 2) return \"whatsapp\";\n    \n    // Type 15 = Instagram DM - pode responder por Instagram\n    if (messageType === 15) return \"instagram\";\n    \n    // Se não conseguir identificar pelo type, verifica a origem\n    // mas só usa Instagram se o type não for SMS\n    const origin = $json.body?.contact?.attributionSource?.medium;\n    if (origin === \"instagram\" && messageType !== 2 && messageType !== 20) return \"instagram\";\n    \n    // Default: SMS/WhatsApp (mais seguro)\n    return \"whatsapp\";\n  })().trim()\n}}",
              "type": "string"
            },
            {
              "id": "734cd3ca-c411-46fe-8924-1ea800f80804",
              "name": "mensagem",
              "value": "={{ ($json.body?.message?.body || '').trim() || $json.mensagem_contexto || ($json.body?.customData?.message?.split(\"Instance Source:\")[0] ?? $json.body?.message?.content?.text ?? '').trim() }}",
              "type": "string"
            },
            {
              "id": "3ae92580-436d-4dfc-a7cc-f83f8f68309e",
              "name": "full_name",
              "value": "={{ $json.nome_completo }}",
              "type": "string"
            },
            {
              "id": "332d6a13-10c8-465f-8ddb-fa97266f9fec",
              "name": "first_name",
              "value": "={{ $json.first_name }}",
              "type": "string"
            },
            {
              "id": "60cb5031-9132-4c86-9ab7-c487a170c9e3",
              "name": "last_name",
              "value": "={{ $json.last_name }}",
              "type": "string"
            },
            {
              "id": "9d4ae7a5-635b-4dbc-93d1-9464ace3208c",
              "name": "email",
              "value": "={{ $json.body?.email }}",
              "type": "string"
            },
            {
              "id": "d6301da3-de8a-45e3-9705-32cf65c3bf1e",
              "name": "telefone",
              "value": "={{ $json.body?.customData?.phone }}",
              "type": "string"
            },
            {
              "id": "5770d76c-1a0f-4515-9683-381881715eb5",
              "name": "resposta_ia",
              "value": "={{ $json.body?.['Resposta IA'] }}",
              "type": "string"
            },
            {
              "id": "367c6400-fd93-4f50-a09b-b2d56aea0bd9",
              "name": "lead_id",
              "value": "={{ $json.body?.contact_id }}",
              "type": "string"
            },
            {
              "id": "7e094af2-d305-42ba-b6d2-014b62231ebb",
              "name": "datetime",
              "value": "={{ $json.body?.date_created }}",
              "type": "string"
            },
            {
              "id": "f3471b65-9533-4f5c-a669-60aaf549b4e8",
              "name": "process_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "7d94c551-b241-48e8-84e8-9ab152f6a526",
              "name": "agente_ia",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_ia }}",
              "type": "string"
            },
            {
              "id": "257ef1e2-26bb-461e-8335-3d1101d3cda6",
              "name": "owner_origin",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "1e235f54-27cf-4b91-b156-1c0a69149370",
              "name": "owner_id",
              "value": "=cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "5041121e-02b1-4993-ad9c-34131a44b08d",
              "name": "timezone_do_lead",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "66a3f763-5dbe-4033-abd7-3079835a035a",
              "name": "mensagem_id",
              "value": "={{ $json.starttimeMs }}",
              "type": "string"
            },
            {
              "id": "110eb8f6-d0b2-4358-a002-3741abbcfeb7",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "5a729725-994d-46e5-a6f1-aac7b9504a3a",
              "name": "ativar_ia",
              "value": "={{ $json.ativar_ia }}",
              "type": "string"
            },
            {
              "id": "3df2e105-88b1-4d12-b957-6b5d909056be",
              "name": "tipo",
              "value": "={{ $json.body?.customData?.tipo }}",
              "type": "string"
            },
            {
              "id": "3038f1ef-1199-4aab-9354-dc9463c775de",
              "name": "etiquetas",
              "value": "={{ $json.body?.tags }}",
              "type": "string"
            },
            {
              "id": "d1fa8d84-c23b-4292-86bc-2066e14c7882",
              "name": "calendarID_carreira",
              "value": "={{ $json.body?.customData?.calendar_id_carreira }}",
              "type": "string"
            },
            {
              "id": "cca7fe8b-af83-40c1-ba8b-d4de7cd21c47",
              "name": "calendarID_consultoria_financeira",
              "value": "={{ $json.body?.customData?.consultoria_financeira }}",
              "type": "string"
            },
            {
              "id": "dad6c1f3-82b2-45ea-b3be-c512a879ac98",
              "name": "origem_teste",
              "value": "Marcos Danielss",
              "type": "string"
            },
            {
              "id": "4100931a-e49b-4b97-8a16-7a797b67899e",
              "name": "area_de_atuacao",
              "value": "={{ $json.body?.['Qual a sua área de atuação?']?.[0] }}",
              "type": "string"
            },
            {
              "id": "368ffdd1-2395-4632-b738-e35ebfbe0832",
              "name": "body.customData.ghl_api_key",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "4ed525e0-9bb6-4663-980a-70a10db813d4",
              "name": "idade",
              "value": "={{ $json.body?.Idade }}",
              "type": "string"
            },
            {
              "id": "b14c96ea-7093-48b6-add5-dd0159af29cd",
              "name": "instagram",
              "value": "={{ $json.body?.Instagram }}",
              "type": "string"
            },
            {
              "id": "9d450e98-e0e3-48fb-bb77-41c6d701f227",
              "name": "modelo_de_atuacao",
              "value": "={{ $json.body?.['Modelo de atuação'] }}",
              "type": "string"
            },
            {
              "id": "69b88a48-6d28-42b1-8ff4-5120e516f348",
              "name": "faturamento_medio",
              "value": "={{ $json.body?.['Faturamento médio'] }}",
              "type": "string"
            },
            {
              "id": "35274cdc-7a80-4945-9296-5d74db32aff2",
              "name": "investimento",
              "value": "={{ $json.body?.Investimento }}",
              "type": "string"
            },
            {
              "id": "247f2856-13b1-4bc4-bb55-cf7842680459",
              "name": "event_chat",
              "value": "={{ $json.body?.event?.Info?.Chat }}",
              "type": "string"
            },
            {
              "id": "dda2ed54-8e91-41e2-92c9-1b2d12763e2b",
              "name": "event_is_group",
              "value": "={{ $json.body?.event?.Info?.IsGroup }}",
              "type": "boolean"
            },
            {
              "id": "b9e46b5c-3fb8-4be2-bb9e-71080728bd85",
              "name": "video_ads_url",
              "value": "={{ $json.body?.contact?.attributionSource?.videoUrl }}",
              "type": "string"
            },
            {
              "id": "1cd51504-1dc9-4aea-956a-9a4757db1b6c",
              "name": "photo_audio",
              "value": "={{ $json.body?.customData?.photo_audio?.split(',')[0]?.trim() }}",
              "type": "string"
            },
            {
              "id": "16308ff3-20b3-4fd4-b126-21c34248530b",
              "name": "time_zone_do_agente",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "2566e00f-ecfd-44e8-bab2-7d68447e3b9a",
              "name": "historia_do_usuario",
              "value": "={{ $json.body?.customData?.minha_historias }}",
              "type": "string"
            },
            {
              "id": "391cb65e-46a0-475b-8c42-3629883ad983",
              "name": "usuario_responsavel",
              "value": "={{ $json.body?.user?.firstName }} {{ $json.body?.user?.lastName }}",
              "type": "string"
            },
            {
              "id": "77c42ca4-2ef7-4a40-b1ed-2fc5e8af7292",
              "name": "fonte_do_lead_bposs",
              "value": "={{ $json.body?.customData?.fonte_do_lead_bposs }}",
              "type": "string"
            },
            {
              "id": "a976a2ec-ed9f-452b-91d1-5725631ae2d5",
              "name": "quebra_de_objecoes_geral",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_geral }}",
              "type": "string"
            },
            {
              "id": "cc085a35-fef6-47b9-ad97-e9d671a71d29",
              "name": "quebra_de_objecoes_carreira",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_carreira }}",
              "type": "string"
            },
            {
              "id": "8f3c6a4d-df4f-4de7-ad41-0177eb567ed4",
              "name": "quebra_de_objecoes_consultoria",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_consultoria }}",
              "type": "string"
            },
            {
              "id": "03c2a02f-e2c2-4d42-afe3-3d6b7bfae375",
              "name": "tipos_work_permit_permitidos",
              "value": "={{ $json.body?.customData?.estruturas_work_permit }}",
              "type": "string"
            },
            {
              "id": "2d89fd62-be99-4c63-9bf9-c2b97c0cc735",
              "name": "link_do_zoom",
              "value": "={{ $json.body?.customData?.link_do_zoom }}",
              "type": "string"
            },
            {
              "id": "939d130d-8780-41e6-9693-10b83cd9bab5",
              "name": "agendamento_duracao_minutos",
              "value": "30",
              "type": "string"
            },
            {
              "id": "c9a26bfa-ced7-4b82-a6bb-2c0aeb46f9a3",
              "name": "cobranca_valor",
              "value": "500",
              "type": "string"
            },
            {
              "id": "9290e4ff-d01b-4fca-b5f3-7605d4f74c07",
              "name": "id_conversa_alerta",
              "value": "skfa6JP6lLlAXkc8FfIp",
              "type": "string"
            },
            {
              "id": "103fad86-a8b6-4591-b310-2dc7069bc189",
              "name": "etapa_funil",
              "value": "={{ $json.body?.customData?.etapa_funil }}",
              "type": "string"
            },
            {
              "id": "c594a0f2-aba9-458c-92ff-81e73086416c",
              "name": "url_asaas",
              "value": "https://api.asaas.com",
              "type": "string"
            },
            {
              "id": "5476f99e-273b-45a1-996f-b98cb86ddd25",
              "name": "work_permit",
              "value": "={{ $json.body?.customData?.work_permit }}",
              "type": "string"
            },
            {
              "id": "989fb582-9e56-4962-8883-6076627c72b5",
              "name": "state",
              "value": "={{ $json.body?.customData?.state }}",
              "type": "string"
            },
            {
              "id": "b1871710-95d0-495d-9592-ff09ea8ab983",
              "name": "objetivo_do_lead",
              "value": "={{ $json.objetivo_do_lead }}",
              "type": "string"
            },
            {
              "id": "5e293330-4c28-4ae8-92ef-e99bc9feb55e",
              "name": "utm_content",
              "value": "={{ $json.utm_content }}",
              "type": "string"
            },
            {
              "id": "301166ea-a33e-4fa8-a1ec-3a3a0fd00923",
              "name": "tipo_mensagem_original",
              "value": "={{ \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.ogg') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp3') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.opus') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp4') || \n  ($('Mensagem recebida').item.json.body.customData?.message || '').startsWith('Mensagem de Áudio') \n    ? 'audio' \n    : ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpeg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.png') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.webp') \n        ? 'imagem' \n        : ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.pdf')\n          ? 'documento'\n          : 'texto' \n}}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "mensagem_contexto",
              "value": "={{ $json.mensagem_contexto }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "is_primeira_mensagem",
              "value": "={{ $json.is_primeira_mensagem }}",
              "type": "boolean"
            },
            {
              "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
              "name": "tipo_lead",
              "value": "={{ $json.tipo_lead }}",
              "type": "string"
            },
            {
              "id": "f5ad43c1-fbe7-417a-bd52-9cfa52294c74",
              "name": "agente_versionado",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_versionado }}",
              "type": "string"
            },
            {
              "id": "714f3406-1a5c-43e7-99e1-a5d853d7e38d",
              "name": "agenda_consultorio_sao_paulo",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda consultorio sao paulo'] }}",
              "type": "string"
            },
            {
              "id": "6cb38978-9095-486b-b775-58ab8839c366",
              "name": "agenda_presidente_prudente",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda presidente prudente'] }}",
              "type": "string"
            },
            {
              "id": "b28742cf-e1f5-4257-9dd4-8109c07fb7a3",
              "name": "agenda_consulta_online",
              "value": "={{ $('Mensagem recebida').item.json.body.customData['agenda online'] }}",
              "type": "string"
            },
            {
              "id": "e484881e-587d-4779-b712-6d8e6758456a",
              "name": "utm_campaign",
              "value": "={{ $('Mensagem recebida').item.json.body.contact.lastAttributionSource.utmSource }}",
              "type": "string"
            },
            {
              "id": "4ca80da6-382f-4ba0-8cdb-8b106528da17",
              "name": "utm_content",
              "value": "={{ $('Mensagem recebida').item.json.body.contact.lastAttributionSource.utmContent }}",
              "type": "string"
            },
            {
              "id": "1f44746f-f362-4236-83bf-410203bdb89e",
              "name": "form_procurou_ajuda_medica",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Procurou ajuda medica\"] }}",
              "type": "string"
            },
            {
              "id": "e50e0483-b8df-41dc-aa98-9fbf147d805f",
              "name": "form_sintomas_atualmente",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Sintomas atualmente\"] }}",
              "type": "string"
            },
            {
              "id": "846fa257-3db8-4d78-9f11-702bf9b19c61",
              "name": "form_acredita_em_alteração_hormonal",
              "value": "={{ $('Mensagem recebida').item.json.body[\"acredita em alteração hormonal\"] }}",
              "type": "string"
            },
            {
              "id": "1441d8fd-2d84-4a6f-9d04-c5802c5bf2a6",
              "name": "form_udança_no_corpo",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Mudança no corpo\"] }}",
              "type": "string"
            },
            {
              "id": "0a844d42-978b-4713-aae8-84a05f2359e3",
              "name": "form_tipo_de_consulta",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Tipo de consulta\"] }}",
              "type": "string"
            },
            {
              "id": "addf25d3-00f6-45e5-a6c9-3236b52cabfd",
              "name": "form_interessado_em_investir",
              "value": "={{ $('Mensagem recebida').item.json.body[\"Interessado em investir\"] }}",
              "type": "string"
            },
            {
              "id": "saudacao-horario-auto-001",
              "name": "saudacao",
              "value": "={{ (() => { const h = new Date().getHours(); if (h < 12) return 'Bom dia'; if (h < 18) return 'Boa tarde'; return 'Boa noite'; })() }}",
              "type": "string"
            },
            {
              "id": "hora-atual-auto-002",
              "name": "hora_atual",
              "value": "={{ new Date().getHours() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        31776,
        27776
      ],
      "id": "ea518ae5-c807-46a1-90e5-9fadbc131c3d",
      "name": "Info"
    },
    {
      "parameters": {
        "jsCode": "const start = new Date();\nstart.setDate(start.getDate() + 15);\nconst starttimeISO = start.toISOString();\nconst starttimeMs = start.getTime();\n\nconst end = new Date(start);\nend.setDate(end.getDate() + 15);\nconst endtimeISO = end.toISOString();\nconst endtimeMs = end.getTime();\n\nconst inputData = $input.first().json;\n\nreturn [{\n  json: {\n    ...inputData,\n    starttimeISO,\n    starttimeMs,\n    endtimeISO,\n    endtimeMs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31472,
        27776
      ],
      "id": "5278b677-57ce-44ca-9611-8f6e7142c329",
      "name": "Code1"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "contact_id",
              "value": "={{ $json.body.contact_id }}"
            },
            {
              "key": "location_name",
              "value": "={{ $json.body.location.name }}"
            },
            {
              "key": "agente_ia",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.agente_ia }}"
            },
            {
              "key": "phone",
              "value": "={{ $('Mensagem recebida').item.json.body.phone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        31280,
        27776
      ],
      "id": "d51bc05f-0631-4b59-9ef2-775347b349b3",
      "name": "Execution Data5"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar dados do lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst customData = body.customData || {};\nconst tags = (body.tags || '').toLowerCase();\nconst utmContent = body.contact?.attributionSource?.utmContent || '';\n\n// === OBJETIVO DO LEAD ===\nlet objetivo_do_lead = customData.objetivodolead || '';\n\nif (!objetivo_do_lead) {\n  if (tags.includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (tags.includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else if (utmContent.toLowerCase().includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (utmContent.toLowerCase().includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else {\n    objetivo_do_lead = 'indefinido'; // ✅ Não assume mais 'carreira' como padrão\n  }\n}\n\n// === AGENTE IA ===\nlet agente_ia = customData.motive || '';\n\nif (!agente_ia) {\n  // Verifica tags específicas\n  if (tags.includes('closer')) {\n    agente_ia = 'closer';\n  } else if (tags.includes('followuper')) {\n    agente_ia = 'followuper';\n  } else if (objetivo_do_lead === 'consultoria') {\n    agente_ia = 'sdrconsultoria';\n  } else if (objetivo_do_lead === 'carreira') {\n    agente_ia = 'sdrcarreira';\n  } else {\n    agente_ia = 'indefinido'; // ✅ Leads sem classificação clara\n  }\n}\n// ✅ Se customData.motive vier com 'assistente_admin' ou 'assistente_interno', \n//    mantém o valor original\n\n// === ATIVAR IA ===\nlet ativar_ia = customData.ativar_ia || '';\n\nif (tags.includes('perdido')) {\n  ativar_ia = 'nao';\n} else if (utmContent) {\n  ativar_ia = 'sim';\n} else if (ativar_ia === 'sim' || tags.includes('ativar_ia')) {\n  ativar_ia = 'sim';\n} else {\n  ativar_ia = 'nao';\n}\n\nreturn {\n  json: {\n    ...inputData,\n    objetivo_do_lead,\n    agente_ia,\n    ativar_ia,\n    utm_content: utmContent,\n    tags_original: body.tags\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31056,
        27776
      ],
      "id": "70761cd6-543f-437c-b3da-f2960f2dba27",
      "name": "Normalizar Dados1"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar Nome do Lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\n\nlet nome = body.full_name || ((body.first_name || '') + ' ' + (body.last_name || '')).trim() || body.customData?.name || '';\nconst nomeOriginal = nome;\n\nnome = nome.replace(/\\d+/g, '').trim();\nnome = nome.replace(/[_\\-.@]/g, ' ').trim();\nnome = nome.replace(/([a-z])([A-Z])/g, '$1 $2');\n\nconst apelidosCurtos = ['lu', 'le', 'li', 'jo', 'ze', 'ma', 'mi', 'ju', 'du', 'bi', 'ca', 'ka', 'fe', 'be', 'ne', 're', 'ra', 'ro', 'vi', 'va', 'na', 'ni', 'ta', 'ti', 'la', 'lo', 'ed', 'el'];\n\nfunction separarApelidoSobrenome(str) {\n  if (str.includes(' ')) return str;\n  if (str.length <= 10) return str;\n  const lower = str.toLowerCase();\n  for (let len = 2; len <= 3; len++) {\n    const possivel = lower.slice(0, len);\n    if (apelidosCurtos.includes(possivel)) {\n      const resto = str.slice(len);\n      if (resto.length >= 4) return str.slice(0, len) + ' ' + resto;\n    }\n  }\n  return str;\n}\n\nnome = separarApelidoSobrenome(nome);\nnome = nome.replace(/\\s+/g, ' ').trim();\n\nfunction capitalizar(str) {\n  const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  return str.toLowerCase().split(' ').map((palavra, i) => {\n    if (i > 0 && preposicoes.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n}\n\nlet partes = nome.split(' ').filter(p => p.length > 0);\nlet firstName = partes[0] || nome || '';\nlet lastName = partes.slice(1).join(' ') || '';\n\nfirstName = capitalizar(firstName);\nlastName = capitalizar(lastName);\n\nconst tinhaNumero = /\\d/.test(nomeOriginal);\nconst qualidade = (firstName.length < 2 || tinhaNumero) ? 'revisar' : 'ok';\n\nreturn {\n  json: {\n    ...inputData,\n    nome_original: nomeOriginal,\n    first_name: firstName,\n    last_name: lastName,\n    nome_completo: lastName ? `${firstName} ${lastName}` : firstName,\n    qualidade_nome: qualidade\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        30832,
        27776
      ],
      "id": "0006f3ef-6fed-4ba7-83ba-a1ce5cc373e9",
      "name": "Normalizar Nome1"
    },
    {
      "parameters": {
        "jsCode": "// Contexto Inicial do Lead baseado em UTM\nconst input = $input.first().json.body;\n\nconst utmContent = input.contact?.attributionSource?.utmContent || '';\nconst messageBody = (input.message?.body || '').trim();\nconst isPrimeiraMensagem = !messageBody || messageBody === '' || messageBody === ' ';\n\nconst contextoPorUTM = {\n  'CARREIRA': {\n    contexto: 'Lead interessado em CARREIRA no mercado financeiro americano',\n    interesse: 'Oportunidades de carreira como agente de seguros nos EUA',\n    abordagem: 'Falar sobre licenciamento, ganhos, estrutura de trabalho'\n  },\n  'CONSULTORIA': {\n    contexto: 'Lead interessado em CONSULTORIA financeira pessoal',\n    interesse: 'Planejamento financeiro, proteção patrimonial, seguros',\n    abordagem: 'Falar sobre benefícios, proteção familiar, investimentos'\n  },\n  'INVESTIMENTO': {\n    contexto: 'Lead interessado em INVESTIMENTOS',\n    interesse: 'Opções de investimento e crescimento patrimonial',\n    abordagem: 'Falar sobre produtos financeiros, retornos, segurança'\n  }\n};\n\nlet tipoLead = '';\nfor (const tipo of Object.keys(contextoPorUTM)) {\n  if (utmContent.toUpperCase().includes(tipo)) {\n    tipoLead = tipo;\n    break;\n  }\n}\n\nlet mensagemContexto = '';\nlet contextoObj = null;\n\nif (isPrimeiraMensagem && tipoLead) {\n  contextoObj = contextoPorUTM[tipoLead];\n  mensagemContexto = `[CONTEXTO DO LEAD]\\nTipo: ${tipoLead}\\n${contextoObj.contexto}\\nInteresse principal: ${contextoObj.interesse}\\nAbordagem sugerida: ${contextoObj.abordagem}\\n\\nWork Permit: ${input['Work Permit'] || input.customData?.work_permit || 'Não informado'}\\nEstado: ${input['Estado onde mora'] || 'Não informado'}\\n`;\n}\n\nreturn {\n  json: {\n    body: input,\n    is_primeira_mensagem: isPrimeiraMensagem,\n    tem_contexto_utm: !!tipoLead,\n    tipo_lead: tipoLead || 'NAO_IDENTIFICADO',\n    utm_content: utmContent,\n    mensagem_contexto: mensagemContexto,\n    mensagem_original: messageBody,\n    work_permit: input['Work Permit'] || input.customData?.work_permit || '',\n    estado: input['Estado onde mora'] || '',\n    contexto_para_ai: isPrimeiraMensagem && contextoObj ? contextoObj : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        30608,
        27776
      ],
      "id": "3f35408b-c8a0-40b2-818c-d1ef5a990dc9",
      "name": "Contexto UTM"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ativar-ia-check",
              "leftValue": "={{ $json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "80f34e52-b954-48d7-b92a-fb1c95652f9b",
              "leftValue": "={{ $json.etiquetas }}",
              "rightValue": "assistente-admin",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        31968,
        27776
      ],
      "id": "938ba6bb-910a-4046-b948-7eedba828784",
      "name": "IA Ativa?"
    },
    {
      "parameters": {
        "content": "# Tratando input\n",
        "height": 540,
        "width": 1060
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        31088,
        27600
      ],
      "id": "ee62acae-36fd-4494-9a9d-4ec75e74a970",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "66bb063b-646e-4774-9415-e21a35c7e99b",
              "leftValue": "={{ $json.output }}",
              "rightValue": "<ctrl",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "50ac2eba-f7b0-4477-98e6-f19887142f51",
              "leftValue": "{{ $json.output }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        38592,
        27760
      ],
      "id": "814a9875-1b86-4502-ad19-c3d9b56fbf7f",
      "name": "Tudo certo?4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH agent AS (\n  SELECT id\n  FROM agent_versions\n  WHERE location_id = '{{ $('Info').first().json.location_id }}'\n    AND is_active = true\n  LIMIT 1\n)\nINSERT INTO agent_conversations (\n  agent_version_id,\n  contact_id,\n  conversation_id,\n  channel,\n  status,\n  outcome,\n  mensagens_total,\n  started_at\n)\nSELECT\n  agent.id,\n  '{{ $('Info').first().json.lead_id }}',\n  '{{ $('Info').first().json.lead_id }}',\n  '{{ $('Info').first().json.source }}',\n  'active',\n  'in_progress',\n  1,\n  NOW()\nFROM agent\nON CONFLICT (contact_id) DO UPDATE SET\n  mensagens_total = agent_conversations.mensagens_total + 1\nRETURNING *;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        31760,
        27936
      ],
      "id": "c2ae1c3f-e451-4160-b3d1-5e418f97863d",
      "name": "SI - Upsert Conversation",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Cria/atualiza conversa"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_conversation_messages (\n  conversation_id,\n  message_text,\n  is_from_lead,\n  created_at\n)\nSELECT\n  ac.id,\n  '{{ $json.mensagem }}',\n  true,\n  NOW()\nFROM agent_conversations ac\nWHERE ac.contact_id = '{{ $('Info').first().json.lead_id }}'\nLIMIT 1\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        36320,
        27152
      ],
      "id": "b2d2a3ce-0c9f-40a7-b465-4807a62246b4",
      "name": "SI - Insert Lead Message",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Mensagem do lead"
    },
    {
      "parameters": {
        "content": "## Self-Improving AI Integration\n\n**Como usar estes nos:**\n\n1. **SI - Upsert Conversation**\n   - Conectar APOS o no 'Info'\n   - Executar em PARALELO com o fluxo principal\n\n2. **SI - Insert Lead Message**\n   - Conectar APOS 'historico_mensagens_leads'\n   - Executar em PARALELO\n\n3. **SI - Insert AI Message**\n   - Conectar APOS 'Memoria IA'\n   - Executar em PARALELO\n\n4. **SI - Update Outcome** (Opcional)\n   - Conectar quando etapa do funil muda\n\n**IMPORTANTE:**\n- Os nos usam 'onError: continueRegularOutput' para nao quebrar o fluxo principal\n- Prefixo 'SI' = Self-Improving",
        "height": 544,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        30688,
        28448
      ],
      "id": "87704094-16c6-4d9e-943e-562bc30ffaae",
      "name": "Instrucoes de Integracao"
    },
    {
      "parameters": {
        "toolDescription": "Use essa ferramenta quando o paciente expressar preferência por receber respostas somente em áudio ou somente em texto.",
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ \n  {\n    \"customFields\": {\n      \"preferencia_audio_texto\": $fromAI('preferencia_audio_texto', 'audio | texto | ambos', 'string')\n    }\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        37920,
        28144
      ],
      "id": "0a5dc2e2-7354-4e3f-962d-121e612c13da",
      "name": "Alterar preferencia audio texto"
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para direcionar o atendimento para o gestor responsável.",
        "workflowId": {
          "__rl": true,
          "value": "0r0V3ija6EM88T6E",
          "mode": "list",
          "cachedResultUrl": "/workflow/0r0V3ija6EM88T6E",
          "cachedResultName": "05 - Escalar para humano - SOCIALFY"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api key v2": "={{ $('Info').first().json.api_key }}",
            "telefone": "={{ $('Info').first().json.telefone }}",
            "message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('message', ``, 'string') }}",
            "contact_id": "={{ $('Info').first().json.id_conversa_alerta }}",
            "location.id": "={{ $('Info').first().json.location_id }}",
            "usuario_responsavel": "={{ $('Mensagem recebida').first().json.body.location.name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "api key v2",
              "displayName": "api key v2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "message",
              "displayName": "message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location.id",
              "displayName": "location.id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        37792,
        28144
      ],
      "id": "29b66b52-da59-4683-a5bf-c048e79bfc82",
      "name": "Escalar humano"
    },
    {
      "parameters": {
        "description": "Use essa ferramenta para refletir sobre algo. Ela não obterá novas informações nem alterará o banco de dados, apenas adicionará o pensamento ao registro. Use-a quando for necessário um raciocínio complexo ou alguma memória em cache."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        38048,
        28144
      ],
      "id": "c5349f59-ee3b-4165-b50d-84f541b12a77",
      "name": "Refletir"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Utilize essa ferramenta para listar os arquivos disponíveis para envio para o usuário.",
        "resource": "fileFolder",
        "returnAll": true,
        "filter": {
          "folderId": {
            "__rl": true,
            "value": "18mSZn8rMAt_9hFpj5oITD1wRLMKHqk0s",
            "mode": "list",
            "cachedResultName": "Arquivos da Secretária v3",
            "cachedResultUrl": "https://drive.google.com/drive/folders/18mSZn8rMAt_9hFpj5oITD1wRLMKHqk0s"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTool",
      "typeVersion": 3,
      "position": [
        38176,
        28144
      ],
      "id": "a6a1c572-f2fa-4f6d-a783-7236fb233c2f",
      "name": "Listar arquivos",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "huUvmVlBHgVbw2p1",
          "name": "drive marcos - supabase - supercérebro"
        }
      }
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para atualizar informações no título e descrição do evento.\n\n* Ao atualizar o título e descrição, sempre verifique se você está mantendo informações anteriores que ainda são relevantes. Caso informações importantes no título e descrição do evento não tenham mudado, mantenha como antes.\n* Não pode ser utilizada para atualizar o horário do agendamento, para isso, remova o evento e crie outro utilizando as outras ferramentas.",
        "workflowId": {
          "__rl": true,
          "value": "tB6BNUcIu0SxpA9u",
          "mode": "list",
          "cachedResultUrl": "/workflow/tB6BNUcIu0SxpA9u",
          "cachedResultName": "04.1 Atualizar/Cancelar agendamento"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "telefone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefone', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "startTime": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startTime', ``, 'string') }}",
            "calendar_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar_id', ``, 'string') }}",
            "lead_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_id', ``, 'string') }}",
            "firstName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('firstName', ``, 'string') }}",
            "lastName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lastName', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "calendar_id",
              "displayName": "calendar_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startTime",
              "displayName": "startTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "firstName",
              "displayName": "firstName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lastName",
              "displayName": "lastName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38304,
        28144
      ],
      "id": "805a4f23-2860-4d2d-8f7e-aaf32fdbe166",
      "name": "Atualizar agendamento"
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para enviar um arquivo do Google Drive para o usuário.\n",
        "workflowId": {
          "__rl": true,
          "value": "si0lxAyvbgKOoO0g",
          "mode": "list",
          "cachedResultUrl": "/workflow/si0lxAyvbgKOoO0g",
          "cachedResultName": "02. Baixar e enviar arquivo do Google Drive"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "file_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('file_id', ``, 'string') }}",
            "id_conversa": "={{ $('Edit Fields').first().json.conversationId }}",
            "source": "={{ $('Info').first().json.source }}",
            "contact_id": "={{ $('Edit Fields').first().json.contactId }}",
            "api_key": "={{ $('Info').first().json.api_key }}"
          },
          "matchingColumns": [
            "file_id"
          ],
          "schema": [
            {
              "id": "file_id",
              "displayName": "file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "id_conversa",
              "displayName": "id_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38432,
        28144
      ],
      "id": "db6e99b9-4471-4223-9732-be3660964b40",
      "name": "Enviar arquivo"
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para criar uma nova cobrança para o usuário, ou para consultar os dados de uma cobrança já existente.\n\nAntes de criar uma nova cobrança, sempre crie um agendamento para o cliente primeiro.",
        "workflowId": {
          "__rl": true,
          "value": "45POrWnyU2UR7HjQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/45POrWnyU2UR7HjQ",
          "cachedResultName": "06.1 Integração Asaas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "cobranca_valor": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cobranca_valor', `Valor exato da cobrança em reais (ex: 600.00). Consulte sempre a tabela de preços no contexto do negócio/prompt antes de preencher.`, 'number') }}",
            "cobranca_vencimento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cobranca_vencimento', `Data do vencimento no format YYYY-MM-DD. Informar como o dia do agendamento + 7 dias.`, 'string') }}",
            "telefone": "={{ $('Info').first().json.telefone }}",
            "nome": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nome', ``, 'string') }}",
            "cpf": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cpf', ``, 'string') }}",
            "id_conta": "={{ $('Info').first().json.location_id}}",
            "id_contato": "={{ $('Info').first().json.lead_id }}",
            "asaas_id_cliente": "={{ $('Info').first().json.atributos_contato.asaas_id_cliente }}",
            "asaas_id_cobranca": "={{ $('Info').first().json.atributos_contato.asaas_id_cobranca }}",
            "url_asaas": "={{ $('Info').first().json.url_asaas }}",
            "api_key": "={{ $('Info').first().json.api_key }}",
            "location_name": "={{ $('Info').first().json.location_name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "cobranca_valor",
              "displayName": "cobranca_valor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "cobranca_vencimento",
              "displayName": "cobranca_vencimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "cpf",
              "displayName": "cpf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id_conta",
              "displayName": "id_conta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id_contato",
              "displayName": "id_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "asaas_id_cliente",
              "displayName": "asaas_id_cliente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "asaas_id_cobranca",
              "displayName": "asaas_id_cobranca",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "url_chatwoot",
              "displayName": "url_chatwoot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "url_asaas",
              "displayName": "url_asaas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38560,
        28144
      ],
      "id": "54c7b9ff-669c-403d-88d0-023004cec8cf",
      "name": "Criar ou buscar cobranca"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.user_prompt }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\n\n\n## HISTÓRICO DE CONVERSAS ANTIGAS\n{{ $('Set mensagens').first().json.mensagens_antigas }}",
          "maxIterations": 8,
          "returnIntermediateSteps": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        38016,
        27760
      ],
      "id": "5656766a-0825-4b7b-8ba4-9ef600a5df0a",
      "name": "SDR1",
      "retryOnFail": true,
      "waitBetweenTries": 4000
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Set mensagens - Mapeia campos do workflow Info para formato interno\nconst setMensagensData = $('Set mensagens').first().json;\n\nconst input = $input.item.json;\n\n// Pegar dados do Info diretamente para garantir calendários\nconst infoData = $('Info').first().json;\n\n// Extrair source baseado no agente\nlet source = 'whatsapp';\nif (input.agente_ia === 'social_seller_instagram' || input.source === 'instagram') {\n  source = 'instagram';\n}\n\n// Extrair etiquetas (pode ser string ou array)\nlet etiquetas = [];\nif (input.etiquetas) {\n  etiquetas = typeof input.etiquetas === 'string' \n    ? input.etiquetas.split(',').map(t => t.trim()).filter(t => t) \n    : input.etiquetas;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS DO FORMULÁRIO DE TRÁFEGO (Facebook/Instagram Ads)\n// ─────────────────────────────────────────────────────────────────────────────\nconst formularioTrafego = {\n  origem_campanha: infoData.utm_campaign || input.utm_source || '',\n  sintomas_atuais: infoData.form_sintomas_atualmente || '',\n  procurou_ajuda: infoData.form_procurou_ajuda_medica || '',\n  mudanca_corpo: infoData.form_mudanca_no_corpo || '',\n  preferencia_consulta: infoData.form_tipo_de_consulta || '',\n  pronto_investir: infoData.form_interessado_em_investir || ''\n};\n\n// Verificar se é lead de tráfego (tem dados do formulário)\nconst isLeadTrafego = !!(formularioTrafego.sintomas_atuais || formularioTrafego.preferencia_consulta || formularioTrafego.origem_campanha || formularioTrafego.procurou_ajuda);\n\nreturn {\n  json: {\n    // IDs\n    location_id: infoData.location_id || input.owner_origin || '',\n    contact_id: infoData.lead_id || '',\n    conversation_id: infoData.id_conversa_alerta || infoData.lead_id || '',\n    \n    // Dados do contato\n    phone: infoData.telefone || '',\n    full_name: infoData.full_name || infoData.first_name || 'Visitante',\n    \n    // Mensagem\nmessage: setMensagensData.mensagem || infoData.mensagem || input.resposta_ia || '',\n    source: source,\n    \n    // Contexto do lead\n    historico: input.historico || [],\n    etiquetas: etiquetas,\n    status_pagamento: infoData.status_cobranca || 'nenhum',\n    preferencia_audio_texto: infoData.tipo_mensagem_original || 'texto',\n    \n    // Modo do agente\n    modo_agente: infoData.agente_ia || 'sdr_inbound',\n    \n    // Calendários do GHL - AGORA PEGANDO DO INFO DIRETAMENTE\n    calendarios_ghl: {\n      sao_paulo: infoData.agenda_consultorio_sao_paulo || '',\n      presidente_prudente: infoData.agenda_presidente_prudente || '',\n      online: infoData.agenda_consulta_online || ''\n    },\n    \n    // API Key\n    ghl_api_key: infoData.api_key || '',\n    \n    // Dados extras do lead\n    objetivo: infoData.objetivo_do_lead || '',\n    is_primeira_mensagem: infoData.is_primeira_mensagem || false,\n    tipo_lead: infoData.tipo_lead || 'NAO_IDENTIFICADO',\n    \n    // Dados do formulário de tráfego\n    formulario_trafego: formularioTrafego,\n    is_lead_trafego: isLeadTrafego\n  }\n};"
      },
      "id": "ab5fbed1-f402-439c-87dd-0b0d573062d5",
      "name": "Set mensagens2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36656,
        27760
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT av.*, l.api_key as location_api_key\nFROM agent_versions av\nLEFT JOIN locations l ON av.location_id = l.location_id\nWHERE av.location_id = '{{ $('Set mensagens').first().json.location_id }}'\n  AND av.is_active = true\n  AND av.status = 'active'\nORDER BY av.deployed_at DESC NULLS LAST, av.created_at DESC\nLIMIT 1",
        "options": {}
      },
      "id": "a9e74cbf-e4e4-4e44-a58e-155de42512ce",
      "name": "Buscar Agente Ativo2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        36880,
        27760
      ],
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// FORMATAR CALENDÁRIOS\n// Usa calendários do GHL (customData) com fallback para scheduling_config\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\nconst schedulingConfig = prev.scheduling_config || {};\nconst calendariosGHL = prev.calendarios_ghl || {};\n\n// Mapear calendários - prioridade para GHL, fallback para config do agente\nconst calendarios = [];\n\nconst calSP = calendariosGHL.sao_paulo || schedulingConfig.agenda_consultorio_sao_paulo;\nconst calPP = calendariosGHL.presidente_prudente || schedulingConfig.agenda_presidente_prudente;\nconst calOnline = calendariosGHL.online || schedulingConfig.agenda_consulta_online;\n\nif (calSP) {\n  calendarios.push(`• Consultório São Paulo (Moema): ID ${calSP}`);\n}\n\nif (calPP) {\n  calendarios.push(`• Unidade Presidente Prudente: ID ${calPP}`);\n}\n\nif (calOnline) {\n  calendarios.push(`• Consulta Online (Telemedicina): ID ${calOnline}`);\n}\n\n// Se não houver calendários configurados\nif (calendarios.length === 0) {\n  calendarios.push('• Calendários não configurados');\n}\n\nconst calendariosFormatados = calendarios.join('\\n');\n\n// Informações de agendamento\nconst agendamentoInfo = [\n  `Horários: Segunda a Sexta, 9h-18h | Sábado 8h-12h`,\n  `Duração consulta: 1h a 1h30`,\n  `Antecedência mínima: 24 horas`,\n  `Cancelamento: Até 24h antes sem custo`\n].join('\\n');\n\nreturn {\n  json: {\n    ...prev,\n    calendarios_formatados: calendariosFormatados,\n    agendamento_info: agendamentoInfo,\n    // IDs para usar nas tools de agendamento\n    calendar_ids: {\n      sao_paulo: calSP || '',\n      presidente_prudente: calPP || '',\n      online: calOnline || ''\n    },\n    // Garantir que dados do formulário passam adiante\n    formulario_trafego: prev.formulario_trafego || {},\n    is_lead_trafego: prev.is_lead_trafego || false\n  }\n};"
      },
      "id": "d81ccc44-cb46-41c1-b1dc-b1522e4d3784",
      "name": "Formatar Calendários1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37312,
        27760
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// MONTAR PROMPTS FINAIS v6.6 - VERSÃO SUPABASE\n// Pega prompts modulares do campo prompts_by_mode do Supabase\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FUNÇÃO PARA SUBSTITUIR VARIÁVEIS MUSTACHE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction replaceVars(template, vars) {\n  if (!template) return '';\n  let result = template;\n\n  for (const [key, value] of Object.entries(vars)) {\n    const pattern = new RegExp(`\\\\{\\\\{\\\\s*${key}\\\\s*\\\\}\\\\}`, 'g');\n    result = result.replace(pattern, value || '');\n  }\n\n  return result;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// VARIÁVEIS PARA SUBSTITUIÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nconst variaveis = {\n  modo_agente: prev.agent_type || 'sdr_inbound',\n  source: prev.source || 'instagram',\n  full_name: prev.full_name || 'Visitante',\n  timezone: 'America/Sao_Paulo',\n  agente: prev.agent_name || 'Isabella',\n  data_hora: prev.data_hora,\n  status_pagamento: prev.status_pagamento || 'nenhum',\n  preferencia_audio_texto: prev.preferencia_audio_texto || 'texto'\n};\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETECTAR MODO ATIVO (agente_ia)\n// ─────────────────────────────────────────────────────────────────────────────\nconst modoAtivo = prev.agente_ia || prev.agent_type || 'sdr_inbound';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PEGAR PROMPTS DO SUPABASE (prompts_by_mode)\n// ─────────────────────────────────────────────────────────────────────────────\nconst promptsDoAgente = prev.prompts_by_mode || {};\n\n// Normalizar o modo para encontrar no JSON\nfunction normalizarModo(modo) {\n  const modoLower = (modo || '').toLowerCase().trim();\n\n  const aliases = {\n    'sdr': 'sdr_inbound',\n    'inbound': 'sdr_inbound',\n    'social_seller': 'social_seller_instagram',\n    'instagram': 'social_seller_instagram',\n    'agendamento': 'scheduler',\n    'followup': 'followuper',\n    'objecao': 'objection_handler',\n    'objecoes': 'objection_handler',\n    'reativador': 'reativador_base'\n  };\n\n  return aliases[modoLower] || modoLower;\n}\n\nconst modoNormalizado = normalizarModo(modoAtivo);\n\n// Pegar o prompt do modo ativo (ou fallback para sdr_inbound)\nconst promptModoAtivo = promptsDoAgente[modoNormalizado]\n  || promptsDoAgente['sdr_inbound']\n  || '';\n\n// Prompt base vem do system_prompt do agente\nconst promptBase = prev.system_prompt || '';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR SYSTEM PROMPT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nlet systemPrompt = promptBase + '\\n\\n' + promptModoAtivo;\n\n// Substituir variáveis\nsystemPrompt = replaceVars(systemPrompt, variaveis);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// REGRA DINÂMICA DE SAUDAÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nlet regraSaudacao = '';\nconst hora = prev.hora_numero;\nconst historicoExiste = prev.historico_existe;\n\nif (!historicoExiste) {\n  if (hora >= 5 && hora < 12) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Bom dia\" de forma calorosa.\\n</regra_saudacao>';\n  } else if (hora >= 12 && hora < 18) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Boa tarde\" de forma calorosa.\\n</regra_saudacao>';\n  } else {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Boa noite\" de forma calorosa.\\n</regra_saudacao>';\n  }\n} else {\n  regraSaudacao = '\\n\\n<regra_saudacao>\\nConversa já iniciada. NÃO repita saudação. Continue naturalmente.\\n</regra_saudacao>';\n}\n\nsystemPrompt += regraSaudacao;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR BLOCO DE RESPOSTAS DO FORMULÁRIO DE TRÁFEGO\n// ─────────────────────────────────────────────────────────────────────────────\nlet blocoFormularioTrafego = '';\nconst form = prev.formulario_trafego || {};\nconst isLeadTrafego = prev.is_lead_trafego || false;\n\nif (isLeadTrafego) {\n  const linhas = [];\n  if (form.origem_campanha) linhas.push(`VEIO POR CAMPANHA: ${form.origem_campanha}`);\n  if (form.procurou_ajuda) linhas.push(`PROCUROU AJUDA ANTES: ${form.procurou_ajuda}`);\n  if (form.sintomas_atuais) linhas.push(`SINTOMAS ATUAIS: ${form.sintomas_atuais}`);\n  if (form.mudanca_corpo) linhas.push(`MUDANÇA NO CORPO: ${form.mudanca_corpo}`);\n  if (form.preferencia_consulta) linhas.push(`PREFERÊNCIA CONSULTA: ${form.preferencia_consulta}`);\n  if (form.pronto_investir) linhas.push(`PRONTO PRA INVESTIR: ${form.pronto_investir}`);\n\n  if (linhas.length > 0) {\n    blocoFormularioTrafego = `\\n<respostas_formulario_trafego>\\n${linhas.join('\\n')}\\n</respostas_formulario_trafego>\\n`;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR USER PROMPT\n// ─────────────────────────────────────────────────────────────────────────────\nconst etiquetasStr = Array.isArray(prev.etiquetas)\n  ? prev.etiquetas.join(', ')\n  : (prev.etiquetas || 'nenhuma');\n\nlet userPrompt = `\n<contexto_conversa>\nLEAD: ${prev.full_name}\nCANAL: ${prev.source}\nDDD: ${prev.ddd || 'não identificado'}\nDATA/HORA: ${prev.data_hora}\nETIQUETAS: ${etiquetasStr}\nSTATUS PAGAMENTO: ${prev.status_pagamento}\nMODO ATIVO: ${modoAtivo}\n</contexto_conversa>\n`;\n\nif (blocoFormularioTrafego) {\n  userPrompt += blocoFormularioTrafego;\n}\n\nuserPrompt += `\n<hiperpersonalizacao>\n${prev.contexto_hiperpersonalizado}\n</hiperpersonalizacao>\n\n<calendarios_disponiveis>\n${prev.calendarios_formatados || ''}\n\n${prev.agendamento_info || ''}\n</calendarios_disponiveis>\n`;\n\nif (prev.historico_formatado) {\n  userPrompt += `\n<historico_conversa>\n${prev.historico_formatado}\n</historico_conversa>\n`;\n}\n\nuserPrompt += `\n<mensagem_atual>\nLEAD: ${prev.message}\n</mensagem_atual>\n\nResponda à mensagem acima como Isabella, seguindo as instruções do MODO ATIVO: ${modoAtivo}.`;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    _meta: {\n      agent_name: prev.agent_name || 'Isabella',\n      agent_version: prev.version || 'v6.6',\n      modo_ativo: modoAtivo,\n      modo_normalizado: modoNormalizado,\n      prompt_modo_encontrado: !!promptsDoAgente[modoNormalizado],\n      contact_id: prev.contact_id,\n      conversation_id: prev.conversation_id,\n      historico_mensagens: prev.historico_existe ? 'sim' : 'não',\n      hora_execucao: prev.data_hora,\n      is_lead_trafego: isLeadTrafego,\n      prompt_size: systemPrompt.length,\n      modos_disponiveis: Object.keys(promptsDoAgente)\n    }\n  }\n};"
      },
      "id": "c46dec94-2a4f-4274-986e-1f7007f69aef",
      "name": "Montar Prompts Finais1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37536,
        27760
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// PREPARAR EXECUÇÃO + IDENTIFICAR CONTEXTO v6.6 - VERSÃO SUPABASE\n// Passa prompts_by_mode do Supabase para o próximo nó\n// ═══════════════════════════════════════════════════════════════════════════\n\n// Pegar dados do agente (vem do node anterior - Buscar Agente Ativo)\nconst agent = $input.item.json;\n\n// Pegar dados das mensagens dos nodes Set mensagens\nconst mensagens = $('Set mensagens2').first().json;\nconst setMensagens = $('Set mensagens').first().json;\n\n// Pegar customData do webhook original\nconst customData = $('Mensagem recebida').first().json.body?.customData || {};\n\n// Pegar agente_ia direto do Info (fonte mais confiável)\nconst infoData = $('Info').first().json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSE SEGURO DE JSON\n// ─────────────────────────────────────────────────────────────────────────────\nfunction safeParseJSON(value, fallback = {}) {\n  if (!value) return fallback;\n  if (typeof value === 'object') return value;\n  try {\n    return JSON.parse(value);\n  } catch (e) {\n    console.log('Erro parsing JSON:', e.message);\n    return fallback;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// EXTRAIR DDD DO TELEFONE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction extrairDDD(telefone) {\n  if (!telefone) return null;\n  const limpo = telefone.replace(/\\D/g, '');\n\n  if (limpo.startsWith('55') && limpo.length >= 12) {\n    return limpo.substring(2, 4);\n  }\n  if (limpo.length >= 10 && limpo.length <= 11) {\n    return limpo.substring(0, 2);\n  }\n  return null;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETERMINAR PERÍODO DO DIA\n// ─────────────────────────────────────────────────────────────────────────────\nfunction getPeriodoHorario() {\n  const agora = new Date();\n  const hora = agora.getHours();\n\n  if (hora >= 5 && hora < 12) return 'manha';\n  if (hora >= 12 && hora < 18) return 'tarde';\n  return 'noite';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// GERAR CONTEXTO HIPERPERSONALIZADO\n// ─────────────────────────────────────────────────────────────────────────────\nfunction gerarContextoHiperpersonalizado(ddd, periodo, hyperConfig) {\n  const contextos = [];\n\n  if (hyperConfig.personalizacao_por_ddd && ddd) {\n    const dddConfig = hyperConfig.personalizacao_por_ddd[ddd];\n    if (dddConfig) {\n      contextos.push(`[REGIÃO ${ddd}] ${dddConfig.contexto || ''}`);\n      if (dddConfig.unidade_proxima) {\n        contextos.push(`Unidade mais próxima: ${dddConfig.unidade_proxima}`);\n      }\n    }\n  }\n\n  if (hyperConfig.saudacoes_por_horario) {\n    const saudacao = hyperConfig.saudacoes_por_horario[periodo];\n    if (saudacao) {\n      contextos.push(`Saudação recomendada: \"${saudacao}\"`);\n    }\n  }\n\n  return contextos.length > 0\n    ? contextos.join('\\n')\n    : 'Usar abordagem padrão empática e acolhedora';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSEAR CONFIGURAÇÕES DO AGENTE\n// ─────────────────────────────────────────────────────────────────────────────\nconst toolsConfig = safeParseJSON(agent.tools_config, {});\nconst businessConfig = safeParseJSON(agent.business_config, {});\nconst hyperpersonalization = safeParseJSON(agent.hyperpersonalization, {});\nconst qualificationConfig = safeParseJSON(agent.qualification_config, {});\nconst schedulingConfig = safeParseJSON(agent.scheduling_config, {});\nconst complianceConfig = safeParseJSON(agent.compliance_config, {});\nconst escalationConfig = safeParseJSON(agent.escalation_config, {});\nconst metricsConfig = safeParseJSON(agent.metrics_config, {});\nconst integrationConfig = safeParseJSON(agent.integration_config, {});\nconst knowledgeBase = safeParseJSON(agent.knowledge_base, []);\n\n// ⚠️ NOVO v6.6: Parsear prompts_by_mode do Supabase\nconst promptsByMode = safeParseJSON(agent.prompts_by_mode, {});\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS CONTEXTUAIS\n// ─────────────────────────────────────────────────────────────────────────────\nconst ddd = extrairDDD(mensagens.phone);\nconst periodo = getPeriodoHorario();\nconst agora = new Date();\nconst dataHora = agora.toLocaleString('pt-BR', {\n  timeZone: 'America/Sao_Paulo',\n  dateStyle: 'full',\n  timeStyle: 'short'\n});\n\nconst contextoHiper = gerarContextoHiperpersonalizado(ddd, periodo, hyperpersonalization);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FORMATAR HISTÓRICO\n// ─────────────────────────────────────────────────────────────────────────────\nlet historicoFormatado = '';\nif (mensagens.historico && mensagens.historico.length > 0) {\n  historicoFormatado = mensagens.historico\n    .slice(-10)\n    .map(m => `${m.role === 'user' ? 'LEAD' : 'ISABELLA'}: ${m.content}`)\n    .join('\\n');\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETECTAR MODO ATIVO (agente_ia)\n// ─────────────────────────────────────────────────────────────────────────────\nconst agenteIA = infoData.agente_ia\n  || customData.agente_ia\n  || customData.agente_IA\n  || setMensagens.source\n  || mensagens.modo_agente\n  || agent.agent_type\n  || 'sdr_inbound';\n\nconsole.log('>>> MODO ATIVO DETECTADO:', agenteIA);\nconsole.log('>>> PROMPTS DISPONÍVEIS:', Object.keys(promptsByMode));\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    agent_id: agent.id,\n    agent_name: agent.agent_name || 'Isabella',\n    agent_type: agent.agent_type,\n    version: agent.version,\n    system_prompt: agent.system_prompt,\n    user_prompt_template: agent.user_prompt_template,\n    location_api_key: agent.location_api_key,\n    agente_ia: agenteIA,\n    prompts_by_mode: promptsByMode,\n    tools_config: toolsConfig,\n    business_config: businessConfig,\n    hyperpersonalization: hyperpersonalization,\n    qualification_config: qualificationConfig,\n    scheduling_config: schedulingConfig,\n    compliance_config: complianceConfig,\n    escalation_config: escalationConfig,\n    metrics_config: metricsConfig,\n    integration_config: integrationConfig,\n    knowledge_base: knowledgeBase,\n    contact_id: mensagens.contact_id,\n    phone: mensagens.phone,\n    full_name: mensagens.full_name,\n    source: mensagens.source,\n    message: mensagens.message,\n    conversation_id: mensagens.conversation_id,\n    etiquetas: mensagens.etiquetas,\n    status_pagamento: mensagens.status_pagamento,\n    preferencia_audio_texto: mensagens.preferencia_audio_texto,\n    ddd: ddd,\n    periodo: periodo,\n    data_hora: dataHora,\n    contexto_hiperpersonalizado: contextoHiper,\n    historico_formatado: historicoFormatado,\n    historico_existe: mensagens.historico && mensagens.historico.length > 0,\n    hora_numero: agora.getHours(),\n    calendarios_ghl: mensagens.calendarios_ghl || {},\n    ghl_api_key: mensagens.ghl_api_key || '',\n    formulario_trafego: mensagens.formulario_trafego || {},\n    is_lead_trafego: mensagens.is_lead_trafego || false\n  }\n};"
      },
      "id": "40bd39f3-2831-44c7-b59f-8e0fed789e46",
      "name": "Preparar Execução + Identificar Contexto3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37104,
        27760
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "304623c3-1fc3-495e-867b-8710765f00fd",
              "leftValue": "={{ $json.output.length }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        38816,
        27744
      ],
      "id": "ad421d8f-eebf-4196-af32-5050e3521b5a",
      "name": "Filter"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "e49ddb2d-23eb-4164-979e-38b79aa3e556",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        41600,
        27744
      ]
    },
    {
      "parameters": {},
      "id": "7ec78446-e218-455d-8fef-0509cd54f6d3",
      "name": "no.op",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        42496,
        27808
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        42048,
        27840
      ],
      "id": "88235602-9b1d-4fca-b710-33af68a0f4f1",
      "name": "Instagram",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        42048,
        27648
      ],
      "id": "927cfa1a-a1db-4ee3-bb7e-db9660385db1",
      "name": "Whatsapp",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp ",
                    "rightValue": "={{ $('Info').first().json.source }} ",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f5034094-22ae-449d-a556-1fc1bc216e49"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "21897a45-e463-4f12-aa85-a06b148d7ecb",
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        41824,
        27744
      ],
      "id": "04fc7154-ae8c-4bea-ab56-3356f0425ddb",
      "name": "Canal"
    },
    {
      "parameters": {
        "amount": 1.5
      },
      "id": "9846bf2c-26d5-4b05-ad52-818aaaf704c8",
      "name": "1.5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        42272,
        27744
      ],
      "webhookId": "797b3aee-c794-439d-9ef4-1d53cc744fcf"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_response",
              "value": "={{ $('Parser Chain').item.json.output.messages.join(\"\") }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        42256,
        27456
      ],
      "id": "3b6aa142-3f33-405f-95d4-5d1221e3737a",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set mensagens').first().json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        39488,
        27744
      ],
      "id": "4915f03d-4eda-465a-88fe-fc4956dbe3d2",
      "name": "Tipo de mensagem1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        40576,
        28176
      ],
      "id": "51967381-be9b-4c4f-83c0-d5f33f88dfff",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "97df1142-b72f-499f-9053-d3b2f6500f9c",
              "leftValue": "={{ $json.waiting_process_id && $json.waiting_process_id !== $('Info').first().json.process_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        40256,
        27632
      ],
      "id": "7d02bbe3-921f-441f-93bf-f48c1086c308",
      "name": "Deve enviar mensagem?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').first().json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        39616,
        27744
      ],
      "id": "b504b87b-012c-4128-959d-adea59389794",
      "name": "Conversa ativa atualizada",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9d2eedc1-7e26-437e-a11b-bc18f563d470",
              "leftValue": "={{ $json.waiting_process_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        39840,
        27712
      ],
      "id": "d857f7b8-da7f-4fb6-8b74-d3a13a45614a",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        40096,
        27808
      ],
      "id": "7b088366-a373-44e5-b7ca-367c5b2f908e",
      "name": "Termino de resposta",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').first().json.lead_id }}",
            "lead_name": "={{ $('Info').first().json.full_name }}",
            "status": "inactive",
            "id": "={{ $('Conversa Ativa').first().json.id || $('Info').first().json.process_id }}",
            "owner_id": "={{ $('Info').first().json.owner_id }}",
            "workflow_id": "={{ $('Info').first().json.workflow_id }}",
            "output_preview": "={{ $('Tipo de mensagem1').item.json.output }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        40064,
        27648
      ],
      "id": "64357d84-aa88-431a-a04f-522ddafd7ad8",
      "name": "Atualizar resposta IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "e3e607d3-1a96-4bcd-97bf-64c810479de3",
      "name": "Segmentos1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        41392,
        27744
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff19cb21-f08f-4c45-9e0c-bf15cc3a8c63",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"json\") }}",
              "rightValue": "json",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "6495fa85-2af7-493f-bf75-e3d46220f622",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"{\") }}",
              "rightValue": "{{",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "9862c89d-b15e-4ca9-819b-1d78ce50969e",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"output\") }}",
              "rightValue": "output",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "221b46a6-b8e2-4876-91e5-1e63c832c3ec",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"parsed\") }}",
              "rightValue": "parsed",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "dbfb7464-ce46-4d5d-9b0b-716ef05a823d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"split\") }}",
              "rightValue": "split",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "45b8f555-eada-41a5-abc8-a115b34d9e4d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"properties\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "7a3e9dac-e029-44cd-8c7c-ed187ec77bd7",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"type\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        40944,
        27744
      ],
      "id": "59660f88-6e8d-4693-b256-9d7791205560",
      "name": "If1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        40576,
        27968
      ],
      "id": "24979ca0-28a6-4198-a296-8c96e186a503",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "agente_ia",
              "value": "={{ $('Info').first().json.agente_ia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        41168,
        27744
      ],
      "id": "7db219d4-9bdc-464b-b261-f1c56bbf74bf",
      "name": "Execution Data2"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": \"{{ $('Parser Chain').first().json.output.messages.join(\"\") }}\",\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Memoria Lead').first().json.session_id }}",
            "location_id": "={{ $('Info').first().json.location_id }}",
            "location_name": "={{ $('Info').first().json.location_name }}"
          },
          "matchingColumns": [
            "session_id",
            "created_at"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_hash",
              "displayName": "message_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        41824,
        27168
      ],
      "id": "f8079791-4d93-414e-bf28-0cae671918d8",
      "name": "Memoria IA",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GWKl5KuXAdeu4BLr",
          "mode": "list",
          "cachedResultUrl": "/workflow/GWKl5KuXAdeu4BLr",
          "cachedResultName": "[TOOL] Registrar Custo IA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location_id": "={{ $('Info').first().json.location_id }}",
            "location_name": "={{ $('Info').first().json.location_name }}",
            "contact_id": "={{ $('Info').first().json.lead_id }}",
            "contact_name": "={{ $('Info').first().json.first_name }}",
            "canal": "={{ $('Info').first().json.source }}",
            "tipo_acao": "Agendar",
            "total_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_input + $('Calcular Custo LLM').first().json.custo_pro.tokens_output + $('Calcular Custo LLM').first().json.custo_flash.tokens_input + $('Calcular Custo LLM').first().json.custo_flash.tokens_output }}",
            "output_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_output + $('Calcular Custo LLM').first().json.custo_flash.tokens_output }}",
            "model": "gemini-2.5-pro+flash",
            "input_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_input + $('Calcular Custo LLM').first().json.custo_flash.tokens_input }}",
            "workflowId": "={{ $workflow.id }}",
            "executionId": "={{ $execution.id }}",
            "date": "={{ $now.format('FFFF') }}  "
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "date",
              "displayName": "date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "model",
              "displayName": "model",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "input_tokens",
              "displayName": "input_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "output_tokens",
              "displayName": "output_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "total_tokens",
              "displayName": "total_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "workflowId",
              "displayName": "workflowId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "executionId",
              "displayName": "executionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_name",
              "displayName": "contact_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "canal",
              "displayName": "canal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tipo_acao",
              "displayName": "tipo_acao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        42704,
        27456
      ],
      "id": "1ef42823-ac8a-4233-8ce8-acd7f8de7ba1",
      "name": "Call Track AI Cost",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Extrair output\nlet outputText = '';\nif (typeof data.output === 'string') {\n  outputText = data.output;\n} else if (data.output?.messages?.[0]) {\n  outputText = data.output.messages[0];\n} else if (data.output) {\n  outputText = JSON.stringify(data.output);\n}\n\n// ========================================\n// GEMINI 2.5 PRO (Agente principal)\n// ========================================\nconst PRO_PROMPT_TOKENS = 10050;\nconst PRO_CHARS_POR_TOKEN = 3.4;\nconst PRO_PRECO_INPUT = 1.25;\nconst PRO_PRECO_OUTPUT = 5.00;\n\nconst proCompletionTokens = Math.ceil(outputText.length / PRO_CHARS_POR_TOKEN);\nconst proCustoInput = (PRO_PROMPT_TOKENS / 1000000) * PRO_PRECO_INPUT;\nconst proCustoOutput = (proCompletionTokens / 1000000) * PRO_PRECO_OUTPUT;\nconst proCustoTotal = proCustoInput + proCustoOutput;\n\n// ========================================\n// GEMINI 2.5 FLASH (Tool de chat)\n// ========================================\nconst FLASH_PROMPT_TOKENS = 553;\nconst FLASH_CHARS_POR_TOKEN = 1.6;\nconst FLASH_PRECO_INPUT = 0.15;\nconst FLASH_PRECO_OUTPUT = 0.60;\n\nconst flashCompletionTokens = Math.ceil(outputText.length / FLASH_CHARS_POR_TOKEN);\nconst flashCustoInput = (FLASH_PROMPT_TOKENS / 1000000) * FLASH_PRECO_INPUT;\nconst flashCustoOutput = (flashCompletionTokens / 1000000) * FLASH_PRECO_OUTPUT;\nconst flashCustoTotal = flashCustoInput + flashCustoOutput;\n\n// ========================================\n// TOTAL COMBINADO\n// ========================================\nconst custoTotalUSD = proCustoTotal + flashCustoTotal;\nconst custoTotalBRL = custoTotalUSD * 6;\n\nreturn {\n  json: {\n    output: outputText,\n    custo_pro: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: PRO_PROMPT_TOKENS,\n      tokens_output: proCompletionTokens,\n      custo_usd: parseFloat(proCustoTotal.toFixed(6))\n    },\n    custo_flash: {\n      modelo: 'gemini-2.5-flash',\n      tokens_input: FLASH_PROMPT_TOKENS,\n      tokens_output: flashCompletionTokens,\n      custo_usd: parseFloat(flashCustoTotal.toFixed(6))\n    },\n    custo_total: {\n      custo_usd: parseFloat(custoTotalUSD.toFixed(6)),\n      custo_brl: parseFloat(custoTotalBRL.toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42480,
        27456
      ],
      "id": "6b34e7e9-3712-4b94-a821-4df93c29b416",
      "name": "Calcular Custo LLM"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_conversation_messages (\n  conversation_id,\n  message_text,\n  is_from_lead,\n  created_at\n)\nSELECT\n  ac.id,\n  '{{ $('Parser Chain').first().json.output.messages.join(\"\") }}',\n  false,\n  NOW()\nFROM agent_conversations ac\nWHERE ac.contact_id = '{{ $('Info').first().json.lead_id }}'\nLIMIT 1\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        42256,
        27264
      ],
      "id": "263aa4f7-7309-4514-aa9f-3927af0b42bd",
      "name": "SI - Insert AI Message",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Resposta da IA"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem do usuário a ser formatada: {{ $('Tipo de mensagem1').first().json.output }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Por favor, gere a saída no seguinte formato JSON:\n{\n  \"messages\": [\n    \"splitedMessage\",\n    \"splitedMessage\",\n    \"splitedMessage\"\n  ]\n}\n\nVocê é especialista em formatação de mensagem para WhatsApp e instagram, trabalhando somente na formatação e não alterando o conteúdo da menssagem. Responda apenas com o texto final, não comente nada e não fale 'sua mensagem formatada', apenas o texto final. Não comente e nem fale por conta própria, apenas pegue a mensagem do usuário e formate.\n\nRecomendado: ideal entre 1-2 mensagens e no max 3.\n\n- Substitua ** por *\n- Remova #\n- remova \\n e quebra de linhas\n- Substitua aspas duplas por aspas simples \" > '\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        40512,
        27744
      ],
      "id": "8e3a3dd2-a230-4c2c-81d7-ffe02d677574",
      "name": "Parser Chain",
      "executeOnce": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst outputText = data.output || '';\n\n// ========================================\n// ESTIMATIVA DE TOKENS - CALIBRADO v2\n// ========================================\n\n// Completion: 3.4 chars por token\nconst CHARS_POR_TOKEN_OUTPUT = 3.4;\n\n// Prompt: calibrado com média dos seus dados reais\n// 9922, 9962, 10042 -> média ~9975, arredondando pra 10050\nconst PROMPT_TOKENS_BASE = 10050;\n\n// Calcular completion tokens\nconst completionTokens = Math.ceil(outputText.length / CHARS_POR_TOKEN_OUTPUT);\n\nconst promptTokens = PROMPT_TOKENS_BASE;\nconst totalTokens = promptTokens + completionTokens;\n\n// ========================================\n// CÁLCULO DE CUSTO - Gemini 2.5 Pro\n// ========================================\nconst PRECO_INPUT = 1.25;\nconst PRECO_OUTPUT = 5.00;\n\nconst custoInput = (promptTokens / 1000000) * PRECO_INPUT;\nconst custoOutput = (completionTokens / 1000000) * PRECO_OUTPUT;\nconst custoTotal = custoInput + custoOutput;\n\nreturn {\n  json: {\n    output: outputText,\n    tokenUsage: {\n      promptTokens: promptTokens,\n      completionTokens: completionTokens,\n      totalTokens: totalTokens,\n      metodo: 'estimativa'\n    },\n    custo_llm: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: promptTokens,\n      tokens_output: completionTokens,\n      tokens_total: totalTokens,\n      custo_usd: parseFloat(custoTotal.toFixed(6)),\n      custo_brl: parseFloat((custoTotal * 6).toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39040,
        27744
      ],
      "id": "a5a3de16-f7ab-4fa1-8789-77c8318b9a0d",
      "name": "Estimativa de tokens"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.crm_historico_mensagens\n  (lead_id, mensagem, datetime, source, full_name, location_id, api_key, tipo)\n  VALUES\n  ('{{ $json.lead_id }}', '{{ $json.resposta_ia }}', NOW(), '{{ $json.source }}', '{{ $('Info').first().json.usuario_responsavel }}', '{{ $json.location.id }}', '{{ $json.api_key }}', 'ai')\n  ON CONFLICT (lead_id, mensagem, datetime)\n  DO NOTHING\n  RETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        42256,
        26880
      ],
      "id": "4bbb3b43-aa50-4020-ad06-ea0d5b617557",
      "name": "historico_mensagens_leads1",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "name"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.contactId }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33344,
        26848
      ],
      "id": "65f652a6-6540-4b94-bda1-d7e28d11a430",
      "name": "Limpar memória",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.crm_historico_mensagens\n(lead_id, mensagem, datetime, source, full_name)\nVALUES\n('{{ $json.lead_id }}', '{{ $json.mensagem }}', '{{ $json.datetime }}', '{{ $json.source }}', '{{ $json.full_name }}')\nON CONFLICT (lead_id, mensagem, datetime)\nDO NOTHING\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        33104,
        27152
      ],
      "id": "d55c5c18-efff-4edc-962f-c00534067767",
      "name": "historico_mensagens_leads",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Agenda follow-up para caso lead não responda\nSELECT fuu_schedule_followup(\n  $1::varchar,\n  $2::varchar,\n  'sdr_inbound'::varchar,\n  $3::varchar,\n  $4::varchar,\n  $5::varchar,\n  $6::jsonb,\n  NOW()\n) as queue_id;",
        "options": {
          "queryReplacement": "={{ [$json.contact?.id || $json.session_id, $json.location_id, $json.contact?.phone || null, $json.contact?.email || null, $json.contact?.name || null, JSON.stringify({ultimo_assunto: $json.message?.content?.substring(0, 100) || '', etapa: 'qualificacao', source: 'whatsapp'})] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        42256,
        27088
      ],
      "id": "cb64d560-bc3e-4d57-8e49-c4b0e558e593",
      "name": "FUU - Agendar Follow-up",
      "retryOnFail": false,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fuu-cancel-1",
              "name": "fuu_contact_id",
              "value": "={{ $json.contact?.id || 'no_contact' }}",
              "type": "string"
            },
            {
              "id": "fuu-cancel-2",
              "name": "fuu_location_id",
              "value": "={{ $json.contact?.locationId || 'no_location' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        30288,
        27776
      ],
      "id": "ba10b85a-27e0-4ef8-a29d-42f4348372d5",
      "name": "FUU - Cancelar Follow-ups",
      "retryOnFail": false,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Cancela follow-ups pendentes (FUU + n8n_schedule_tracking)\nWITH fuu_cancelled AS (\n  SELECT fuu_mark_responded(\n    '{{ $json.fuu_contact_id }}',\n    '{{ $json.fuu_location_id }}'\n  ) as count\n),\nschedule_cancelled AS (\n  UPDATE n8n_schedule_tracking\n  SET ativo = false,\n      updated_at = NOW()\n  WHERE unique_id = '{{ $json.fuu_contact_id }}'\n    AND location_id = '{{ $json.fuu_location_id }}'\n    AND ativo = true\n  RETURNING unique_id\n)\nSELECT \n  (SELECT count FROM fuu_cancelled) as fuu_cancelled,\n  (SELECT COUNT(*) FROM schedule_cancelled) as schedule_cancelled;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        30480,
        27968
      ],
      "id": "5ab1602b-81bb-4cc3-9321-63978ff92d10",
      "name": "FUU - Executar Cancelamento",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE execution_metrics SET status = 'completed', finished_at = NOW(), duration_ms = EXTRACT(EPOCH FROM (NOW() - started_at)) * 1000 WHERE execution_id = $1;",
        "options": {
          "queryReplacement": "={{ [$execution.id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        42256,
        26704
      ],
      "id": "deaf4c5a-d752-4a29-95f6-704728d5d9d2",
      "name": "Finish Metrics",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ $json.photo_audio }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32672,
        28016
      ],
      "id": "63cd7eb4-8fd2-4216-bb66-d868737caec1",
      "name": "Download áudio",
      "retryOnFail": true,
      "credentials": {
        "chatwootApi": {
          "id": "UmVE5jAScA8a8vNB",
          "name": "ChatWoot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        32896,
        28016
      ],
      "id": "b9a63751-3acc-4fc4-b745-c1d7e6147789",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fd3e8b9e-eed6-4f43-94c8-089af8417065",
              "name": "imagem",
              "value": "={{ $json.content?.[0]?.text ? \"[Imagem]: \" + $json.content[0].text : \"\" }}",
              "type": "string"
            },
            {
              "id": "a3bc628f-18b3-4e08-b620-65c5a3a57b40",
              "name": "audio:",
              "value": "={{ $json.text ? \"[Audio Recebido]: \"+ $json.text : \"\"}}",
              "type": "string"
            },
            {
              "id": "2d7d4164-05d3-498a-af26-833fa81806c8",
              "name": "documento",
              "value": "={{ $json.message?.content ? \"[PDF]: \" + $json.message.content : ($json.resposta_dani ? \"[PDF]: \" + $json.resposta_dani : \"\") }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33920,
        28304
      ],
      "id": "abdf8d83-838b-450b-8b8d-8143c7b273a7",
      "name": "Imagem ou audio"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        33632,
        28016
      ],
      "id": "4e532a19-47e1-43db-a0b8-9ee04bbb04a0",
      "name": "Transcrever audio",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "={{ $json.fileName }}",
          "mimeType": "={{ $json.mimeType }}"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        33344,
        28016
      ],
      "id": "39d4440f-b40e-4c9d-8210-ac4f9ff0b4e4",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "jsCode": "// Coloque isso em um Code node antes do Convert to File\nconst url = $('Download áudio').first().json.photo_audio || '';\nlet extension = 'ogg'; // default para WhatsApp\n\n// Tenta extrair extensão da URL\nconst match = url.match(/\\.(\\w+)(?:\\?|$)/);\nif (match) {\n  extension = match[1];\n}\n\n// Mapeia extensões comuns\nconst mimeTypes = {\n  'ogg': 'audio/ogg',\n  'opus': 'audio/ogg',\n  'mp3': 'audio/mpeg',\n  'wav': 'audio/wav',\n  'm4a': 'audio/mp4',\n  'webm': 'audio/webm'\n};\n\nreturn {\n  json: {\n    ...$input.first().json,\n    fileName: `audio.${extension}`,\n    mimeType: mimeTypes[extension] || 'audio/ogg'\n  },\n  binary: $input.first().binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33120,
        28016
      ],
      "id": "43feb319-8992-4782-9f69-e861662841c7",
      "name": "Extrair a extensão"
    },
    {
      "parameters": {
        "url": "={{ $('Info').item.json.photo_audio }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32896,
        28208
      ],
      "id": "e64e4a8e-0237-46fa-be52-2719dad2c28a",
      "name": "Download Comprovante1"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        33120,
        28208
      ],
      "id": "40e5d55e-fd20-4468-9838-d8045f7ddd66",
      "name": "Extract from File2"
    },
    {
      "parameters": {
        "jsCode": "const texto = $input.first().json.text;\n\nreturn {\n  json: {\n    arquivo_texto: texto,\n    arquivo_nome: 'fatura_nubank.pdf'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33344,
        28208
      ],
      "id": "e6f23f49-6fb2-44d2-8655-4696c39dd0b0",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": "// Code Node: \"Ler Arquivo como Texto\"\n\nconst item = $input.first();\n\n// Pega o primeiro binary disponível (qualquer nome)\nconst binaryKeys = Object.keys(item.binary || {});\n\nif (binaryKeys.length === 0) {\n  return {\n    erro: 'Nenhum arquivo binário encontrado',\n    ...item.json\n  };\n}\n\nconst binaryKey = binaryKeys[0];\nconst binaryData = item.binary[binaryKey];\n\n// Converte pra texto\nconst buffer = Buffer.from(binaryData.data, 'base64');\nconst texto = buffer.toString('utf-8');\n\nreturn {\n  arquivo_texto: texto,\n  arquivo_tipo: binaryData.mimeType || 'desconhecido',\n  arquivo_nome: binaryData.fileName || 'arquivo',\n  arquivo_tamanho: binaryData.fileSize || texto.length,\n  ...item.json\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33344,
        28400
      ],
      "id": "82621c47-163f-4b7b-a6a3-5143ec777182",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Você é um assistente de análise de dados tabulares (CSV/Excel)."
            },
            {
              "content": "=  # PAPEL\n\nVocê é um assistente de análise de dados tabulares (CSV/Excel).\n\n  # TAREFA\n  Analise os dados e:\n  1. IDENTIFIQUE o tipo de dados\n  2. EXTRAIA insights relevantes\n  3. SUGIRA análises possíveis\n\n  ## Tipos possíveis:\n  - **extrato_transacoes**: transações bancárias/cartão\n  - **lista_clientes**: cadastro de clientes/leads\n  - **relatorio_vendas**: vendas, pedidos\n  - **planilha_gastos**: controle de despesas\n  - **dados_genericos**: qualquer outro dado tabular\n\n  # FORMATO DE SAÍDA\n  JSON válido:\n\n  {\n    \"tipo_dados\": \"[tipo]\",\n    \"confianca\": [0-100],\n    \"resumo\": \"[do que se trata]\",\n    \"estatisticas\": {\n      \"total_linhas\": null,\n      \"colunas\": [],\n      \"valor_total\": null,\n      \"media\": null,\n      \"maior_valor\": null,\n      \"menor_valor\": null\n    },\n    \"categorias\": {\n      // agrupamentos encontrados\n    },\n    \"periodo\": {\n      \"inicio\": null,\n      \"fim\": null\n    },\n    \"top_10\": [], // principais itens\n    \"insights\": [\n      // observações relevantes\n    ],\n    \"acao_sugerida\": \"[analisar/categorizar/exportar]\"\n  }\n\n  # REGRAS\n  1. Identifique colunas automaticamente\n  2. Calcule totais se houver valores\n  3. Agrupe por categorias se possível\n  4. Liste top 10 maiores valores\n  5. Mantenha parcelas nos nomes\n\n  DADOS:\n  {{ $json.arquivo_texto }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        33568,
        28400
      ],
      "id": "a44b4153-2868-4350-8461-10396bf7bc85",
      "name": "csv",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Você é um assistente de análise de documentos PDF."
            },
            {
              "content": "=# PAPEL\nVocê é um assistente de análise de documentos PDF para atendimento ao cliente da clínica Dr. Luiz Augusto (saúde hormonal e longevidade).\n\n# TAREFA\nAnalise o texto extraído do PDF e:\n1. IDENTIFIQUE o tipo de documento\n2. EXTRAIA informações relevantes\n3. SUGIRA próxima ação\n\n## Tipos possíveis:\n- **comprovante_pagamento**: comprovante PIX, TED, DOC, depósito, transferência\n- **resultado_laboratorial**: resultado de exames de sangue/urina\n- **resultado_imagem**: USG, mamografia, tomografia, densitometria\n- **pedido_exame**: solicitação/pedido de exames\n- **receita_medica**: receituário, prescrição\n- **fatura_cartao**: fatura de cartão de crédito\n- **conta_servico**: conta de luz, água, telefone, internet\n- **boleto**: boleto bancário\n- **nota_fiscal**: NF-e, DANFE\n- **contrato**: contrato, proposta comercial\n- **outro**: documento não categorizado\n\n# FORMATO DE SAÍDA\nJSON válido:\n\n{\n  \"tipo_documento\": \"[tipo]\",\n  \"confianca\": [0-100],\n  \"resumo\": \"[do que se trata em 1 frase]\",\n  \"dados_principais\": {},\n  \"itens\": [],\n  \"totais\": {},\n  \"datas\": {\n    \"emissao\": null,\n    \"vencimento\": null,\n    \"periodo_inicio\": null,\n    \"periodo_fim\": null\n  },\n  \"acao_sugerida\": \"[ação]\"\n}\n\n## DADOS POR TIPO:\n\n### resultado_laboratorial:\n{\n  \"laboratorio\": \"nome do laboratório\",\n  \"paciente\": {\n    \"nome\": \"nome completo\",\n    \"sexo\": \"M|F\",\n    \"idade\": null,\n    \"data_nascimento\": null\n  },\n  \"data_coleta\": \"YYYY-MM-DD\",\n  \"medico_solicitante\": \"nome se houver\",\n  \"exames_realizados\": [\n    {\n      \"nome\": \"Hemograma\",\n      \"nome_padronizado\": \"hemograma\",\n      \"resultado\": \"valor\",\n      \"unidade\": \"unidade de medida\",\n      \"valor_referencia\": \"faixa normal\",\n      \"status\": \"normal|alto|baixo|critico\"\n    }\n  ],\n  \"resumo_alterados\": [\n    {\"nome\": \"TSH\", \"resultado\": \"8.5\", \"status\": \"alto\"}\n  ],\n  \"exames_faltantes\": [],\n  \"perfil_protocolo\": \"mulher_jovem|mulher_40+|mulher_menopausa|homem_jovem|homem_40+\"\n}\n\n### resultado_imagem:\n{\n  \"tipo_exame\": \"USG|MAMOGRAFIA|TOMOGRAFIA|DENSITOMETRIA|DOPPLER\",\n  \"regiao\": \"abdome|tireoide|mamas|transvaginal|carotidas|torax\",\n  \"paciente\": {\n    \"nome\": \"nome\",\n    \"sexo\": \"M|F\"\n  },\n  \"data_exame\": \"YYYY-MM-DD\",\n  \"laudo_resumido\": \"principais achados em 2-3 frases\",\n  \"achados\": [\n    {\"descricao\": \"achado\", \"relevancia\": \"normal|atencao|urgente\"}\n  ],\n  \"conclusao\": \"conclusão do laudo\",\n  \"medico_responsavel\": \"nome e CRM\"\n}\n\n### comprovante_pagamento:\n{\n  \"valor_pago\": 150.00,\n  \"data_hora_transacao\": \"2026-01-12T10:30:53\",\n  \"tipo_transacao\": \"PIX|TED|DOC|DEPOSITO\",\n  \"pagador\": {\n    \"nome\": \"quem pagou\",\n    \"documento\": \"CPF/CNPJ\",\n    \"banco\": \"banco\"\n  },\n  \"recebedor\": {\n    \"nome\": \"quem recebeu\",\n    \"documento\": \"CPF/CNPJ\",\n    \"chave_pix\": \"chave se PIX\"\n  },\n  \"id_transacao\": \"código E2E ou autenticação\"\n}\n\n# PROTOCOLO DE EXAMES DR. LUIZ\n\n## Exames Laboratoriais - MULHER (primeira consulta):\nhemograma, glicemia_jejum, hemoglobina_glicosilada, insulinemia, ldl, hdl, triglicerideos, ureia, creatinina, acido_urico, tgo, tgp, pcr_ultrassensivel, fibrinogenio, vhs, ferritina, indice_saturacao_transferrina, gama_gt, homocisteina, vitamina_b12, vitamina_d, acido_folico, zinco, cobre, tsh, t4_livre, t3_livre, anti_tireoglobulina, anti_peroxidase, calcio_total, calcio_ionizado, fosforo, magnesio, selenio, sdhea, estradiol, progesterona, fsh, lh, testosterona_total, testosterona_livre, prolactina, shbg, pth, cortisol_salivar, aluminio_serico, aluminio_urinario, beta_hcg, hormonio_antimulleriano\n\n## Exames Imagem - MULHER JOVEM (<40):\nusg_abdome_total, usg_transvaginal\n\n## Exames Imagem - MULHER 40+:\nusg_abdome_total, mamografia, usg_mamas, usg_transvaginal, usg_tireoide_doppler\n\n## Exames Adicionais - MULHER MENOPAUSA (+5 anos):\ndoppler_carotidas, tomografia_escore_calcio, densitometria_ossea, ctx_telopeptideo\n\n## Exames Laboratoriais - HOMEM (primeira consulta):\n[mesmos da mulher] + psa_total, psa_livre\n[sem: beta_hcg, hormonio_antimulleriano]\n\n## Exames Imagem - HOMEM JOVEM (<40):\nusg_abdome_total\n\n## Exames Imagem - HOMEM 40+:\nusg_abdome_total, usg_tireoide_doppler\n\n# REGRAS DE ANÁLISE\n\n## Para resultado_laboratorial:\n1. IDENTIFIQUE o sexo do paciente pelo nome ou exames (beta-HCG = mulher, PSA = homem)\n2. PADRONIZE nomes dos exames (ex: \"HbA1c\" → \"hemoglobina_glicosilada\")\n3. EXTRAIA valor, unidade e referência de CADA exame\n4. MARQUE status: normal/alto/baixo/critico\n5. LISTE exames alterados em resumo_alterados\n6. COMPARE com protocolo e liste exames_faltantes\n7. INFIRA perfil_protocolo pela idade/sexo\n\n## Para resultado_imagem:\n1. EXTRAIA conclusão principal do laudo\n2. IDENTIFIQUE achados relevantes\n3. CLASSIFIQUE relevância: normal/atencao/urgente\n\n## Para comprovante_pagamento:\n1. EXTRAIA valor exato pago\n2. IDENTIFIQUE tipo (PIX, TED, etc)\n3. CAPTURE ID da transação para confirmação\n\n# VALORES CRÍTICOS (alertar sempre):\n- Glicemia jejum > 126 ou < 50\n- TSH > 10 ou < 0.1\n- Hemoglobina < 8\n- Potássio > 6 ou < 3\n- Creatinina > 4\n- PCR > 10\n\n# AÇÕES SUGERIDAS\n- **confirmar_pagamento**: comprovante válido → confirmar\n- **agendar_retorno**: exames completos → agendar consulta\n- **solicitar_exames_faltantes**: exames incompletos → pedir os que faltam\n- **alerta_medico**: valores críticos → notificar médico\n- **solicitar_novo**: documento ilegível → pedir reenvio\n- **arquivar**: documento informativo\n\n# EXEMPLO DE SAÍDA - RESULTADO LABORATORIAL:\n\n{\n  \"tipo_documento\": \"resultado_laboratorial\",\n  \"confianca\": 95,\n  \"resumo\": \"Resultado de 35 exames laboratoriais da paciente Maria, com TSH elevado e Vitamina D baixa\",\n  \"dados_principais\": {\n    \"laboratorio\": \"Laboratório Fleury\",\n    \"paciente\": {\n      \"nome\": \"Maria Silva\",\n      \"sexo\": \"F\",\n      \"idade\": 45\n    },\n    \"data_coleta\": \"2026-01-10\",\n    \"perfil_protocolo\": \"mulher_40+\",\n    \"exames_realizados\": [\n      {\"nome\": \"TSH\", \"nome_padronizado\": \"tsh\", \"resultado\": \"6.8\", \"unidade\": \"mUI/L\", \"valor_referencia\": \"0.4-4.0\", \"status\": \"alto\"},\n      {\"nome\": \"Vitamina D\", \"nome_padronizado\": \"vitamina_d\", \"resultado\": \"18\", \"unidade\": \"ng/mL\", \"valor_referencia\": \"30-100\", \"status\": \"baixo\"}\n    ],\n    \"resumo_alterados\": [\n      {\"nome\": \"TSH\", \"resultado\": \"6.8\", \"status\": \"alto\"},\n      {\"nome\": \"Vitamina D\", \"resultado\": \"18\", \"status\": \"baixo\"}\n    ],\n    \"exames_faltantes\": [\"cortisol_salivar\", \"aluminio_urinario\", \"selenio\"]\n  },\n  \"acao_sugerida\": \"agendar_retorno\"\n}\n\nDOCUMENTO:\n{{ $json.arquivo_texto }}\n"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        33568,
        28208
      ],
      "id": "1f23eb94-d7f8-4429-b788-a9a30b792ffc",
      "name": "pdf",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Info').item.json.photo_audio }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33120,
        28400
      ],
      "id": "979ec605-b1f1-4d99-8345-2c27a29eaa1f",
      "name": "Download Fatura CSV"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "=# PAPEL\n  Você é um assistente inteligente de análise de documentos e imagens.\n\n  # TAREFA\n  Analise a imagem enviada e:\n  1. IDENTIFIQUE o tipo de documento/imagem\n  2. EXTRAIA as informações relevantes baseado no tipo\n\n  ## Tipos possíveis:\n  - **comprovante_pagamento**: PIX, TED, DOC, boleto pago\n  - **fatura**: fatura de cartão, conta de luz/água/telefone\n  - **nota_fiscal**: NF-e, cupom fiscal, recibo\n  - **documento_pessoal**: RG, CNH, passaporte\n  - **contrato**: contrato, proposta, acordo\n  - **print_conversa**: screenshot de WhatsApp/chat\n  - **foto_produto**: foto de produto, embalagem\n  - **outro**: qualquer outra coisa\n\n  # FORMATO DE SAÍDA\n  Retorne APENAS JSON válido:\n\n  {\n    \"tipo_documento\": \"[tipo identificado]\",\n    \"confianca\": [0-100],\n    \"resumo\": \"[descrição curta do que é]\",\n    \"dados_extraidos\": {\n      // campos dinâmicos baseados no tipo\n    },\n    \"acao_sugerida\": \"[o que fazer com esse documento]\"\n  }\n\n  # EXEMPLOS DE dados_extraidos POR TIPO\n\n  ## Se for comprovante_pagamento:\n  {\n    \"valor\": 150.00,\n    \"data\": \"2026-01-10\",\n    \"pagador\": \"João Silva\",\n    \"recebedor\": \"Empresa X\",\n    \"tipo_transacao\": \"pix\",\n    \"codigo\": \"E123456789\"\n  }\n\n  ## Se for fatura:\n  {\n    \"valor_total\": 500.00,\n    \"vencimento\": \"2026-01-15\",\n    \"empresa\": \"Nubank\",\n    \"periodo\": \"Dez/2025\",\n    \"principais_gastos\": [\"UBER 50.00\", \"IFOOD 120.00\"]\n  }\n\n  ## Se for print_conversa:\n  {\n    \"participantes\": [\"João\", \"Maria\"],\n    \"assunto\": \"Agendamento de reunião\",\n    \"pontos_principais\": [\"Reunião dia 15\", \"Horário 14h\"]\n  }\n\n  ## Se for outro:\n  {\n    \"descricao\": \"[o que aparece na imagem]\",\n    \"texto_visivel\": \"[qualquer texto legível]\"\n  }\n\n  # REGRAS\n  1. Sempre identifique o tipo PRIMEIRO\n  2. Extraia apenas dados relevantes pro tipo\n  3. Se não tiver certeza, use \"outro\"\n  4. Campos não encontrados = null\n  5. Mantenha parcelas no nome (ex: \"MAGAZINE LUIZA 05/10\")",
        "imageUrls": "={{ $json.photo_audio }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        33632,
        28592
      ],
      "id": "71241158-10f2-4249-aaa7-e91a97ec7c16",
      "name": "Analisar Comprovante Claude1",
      "credentials": {
        "anthropicApi": {
          "id": "nNkFTZpNoiBCbO1I",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5aa19cdf-5168-4442-9a3e-b62f8139e3f8",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/assistente_admin",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/assistente_admin"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "366af293-94ad-4150-a56d-9f63c9668d37",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/desligaria",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "desligaria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "reset-cmd",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/reset"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "teste-cmd",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/teste",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/teste"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "texto-check",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "texto",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  },
                  {
                    "id": "msg-existe",
                    "leftValue": "={{ !!$('IA Ativa?').item.json.mensagem && $('Info').item.json.mensagem.length > 0 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "imagem-check",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "imagem",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "audio-check",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Áudio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d5ab961d-d7ae-4841-ab24-172cd88fc403",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "documento",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "documento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6bb3c5ed-78d0-4690-852e-9a4658e5e3b5",
                    "leftValue": "={{ $('Info').item.json.tipo_mensagem_original }}",
                    "rightValue": "pdf",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pdf"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        32224,
        27776
      ],
      "id": "f5025ef4-5eed-46db-a58d-f3063d743aa7",
      "name": "Tipo de mensagem2",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// UNIFICADOR DE MENSAGENS - BPO FINANCEIRO\n// Autor: Claude Code\n// Data: 2025-12-15\n// ============================================================\n\n// Função auxiliar para detectar tipo de conteúdo\nfunction detectarTipoConteudo(texto) {\n  if (!texto) return null;\n  \n  const textoLower = texto.toLowerCase();\n  \n  // Detectar fatura de cartão\n  if (textoLower.includes('fatura') || textoLower.includes('transações') || \n      textoLower.includes('transacoes') || textoLower.includes('cartão') ||\n      textoLower.includes('cartao') || textoLower.includes('nubank') ||\n      textoLower.includes('itaú') || textoLower.includes('bradesco') ||\n      textoLower.includes('santander') || textoLower.includes('inter') ||\n      textoLower.includes('c6') || textoLower.includes('xp')) {\n    return 'fatura_cartao';\n  }\n  \n  // Detectar comprovante\n  if (textoLower.includes('comprovante') || textoLower.includes('pix') ||\n      textoLower.includes('transferência') || textoLower.includes('ted') ||\n      textoLower.includes('doc') || textoLower.includes('pagamento')) {\n    return 'comprovante';\n  }\n  \n  // Detectar nota fiscal\n  if (textoLower.includes('nota fiscal') || textoLower.includes('nf-e') ||\n      textoLower.includes('danfe') || textoLower.includes('nfse') ||\n      textoLower.includes('cnpj')) {\n    return 'nota_fiscal';\n  }\n  \n  // Detectar extrato\n  if (textoLower.includes('extrato') || textoLower.includes('saldo')) {\n    return 'extrato';\n  }\n  \n  // Detectar relatório\n  if (textoLower.includes('relatório') || textoLower.includes('relatorio') ||\n      textoLower.includes('resumo') || textoLower.includes('dashboard')) {\n    return 'relatorio';\n  }\n  \n  return 'documento_generico';\n}\n\n// Função para limpar e formatar texto\nfunction limparTexto(texto) {\n  if (!texto) return '';\n  return texto\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .replace(/\\s{2,}/g, ' ')\n    .trim();\n}\n\n// Função para extrair valores monetários\nfunction extrairValores(texto) {\n  if (!texto) return [];\n  const regex = /R\\$\\s*[\\d.,]+/gi;\n  const matches = texto.match(regex);\n  return matches ? [...new Set(matches)] : [];\n}\n\n// ============================================================\n// INÍCIO DO PROCESSAMENTO\n// ============================================================\n\nconst item = $input.first();\nconst json = item.json;\n\n// Pegar informações do nó Info\nlet infoData = {};\ntry {\n  infoData = $('Info').first()?.json || {};\n} catch (e) {\n  infoData = {};\n}\n\nconst tipoMensagemOriginal = json.tipo_mensagem_original || \n                              infoData.tipo_mensagem_original || \n                              'texto';\n\n// ============================================================\n// COLETAR TODAS AS FONTES DE TEXTO\n// ============================================================\n\nlet textoImagem = '';\nlet textoAudio = '';\nlet textoPDF = '';\nlet textoCSV = '';\nlet textoDocumento = '';\nlet textoMensagem = '';\n\n// 1. Tentar pegar do \"Imagem ou audio\" (primeiro Set)\ntry {\n  const imgAudio = $('Imagem ou audio').first()?.json;\n  if (imgAudio) {\n    textoImagem = imgAudio.imagem || '';\n    textoAudio = imgAudio['audio:'] || imgAudio.audio || '';\n    textoDocumento = imgAudio.documento || '';\n  }\n} catch (e) {}\n\n// 2. Tentar pegar do \"Imagem ou audio1\" (segundo Set)\ntry {\n  const imgAudio1 = $('Imagem ou audio1').first()?.json;\n  if (imgAudio1) {\n    textoImagem = textoImagem || imgAudio1.imagem || '';\n    textoAudio = textoAudio || imgAudio1['audio:'] || imgAudio1.audio || '';\n    if (imgAudio1.text) {\n      textoDocumento = textoDocumento || imgAudio1.text;\n    }\n  }\n} catch (e) {}\n\n// 3. Tentar pegar do \"Analisar Comprovante Claude1\"\ntry {\n  const comprovante = $('Analisar Comprovante Claude1').first()?.json;\n  if (comprovante?.content?.[0]?.text) {\n    textoImagem = textoImagem || '[Imagem Analisada]: ' + comprovante.content[0].text;\n  }\n} catch (e) {}\n\n// 4. Tentar pegar do PDF processado\ntry {\n  const pdfNode = $('pdf').first()?.json;\n  if (pdfNode) {\n    textoPDF = pdfNode.text || pdfNode.content || pdfNode.resposta_dani || '';\n    if (textoPDF && !textoPDF.startsWith('[')) {\n      textoPDF = '[PDF Analisado]: ' + textoPDF;\n    }\n  }\n} catch (e) {}\n\n// 5. Tentar pegar do CSV processado\ntry {\n  const csvNode = $('csv').first()?.json;\n  if (csvNode) {\n    textoCSV = csvNode.text || csvNode.content || '';\n    if (textoCSV && !textoCSV.startsWith('[')) {\n      textoCSV = '[CSV/Planilha Analisada]: ' + textoCSV;\n    }\n  }\n} catch (e) {}\n\n// 6. Tentar pegar do \"Transcrever audio\"\ntry {\n  const transcricao = $('Transcrever audio').first()?.json;\n  if (transcricao?.text) {\n    textoAudio = '[Áudio Transcrito]: ' + transcricao.text;\n  }\n} catch (e) {}\n\n// 7. Pegar mensagem de texto normal\ntextoMensagem = json.mensagem || json.message?.content || \n                infoData.mensagem || '';\n\n// ============================================================\n// UNIFICAR TUDO EM UM TEXTO PADRONIZADO\n// ============================================================\n\nlet conteudoUnificado = '';\nlet tipoConteudoDetectado = 'texto';\nlet valoresEncontrados = [];\n\nif (textoImagem) {\n  conteudoUnificado = limparTexto(textoImagem);\n  tipoConteudoDetectado = detectarTipoConteudo(textoImagem) || 'imagem';\n  valoresEncontrados = extrairValores(textoImagem);\n} else if (textoAudio) {\n  conteudoUnificado = limparTexto(textoAudio);\n  tipoConteudoDetectado = 'audio_transcrito';\n  valoresEncontrados = extrairValores(textoAudio);\n} else if (textoPDF) {\n  conteudoUnificado = limparTexto(textoPDF);\n  tipoConteudoDetectado = detectarTipoConteudo(textoPDF) || 'pdf';\n  valoresEncontrados = extrairValores(textoPDF);\n} else if (textoCSV) {\n  conteudoUnificado = limparTexto(textoCSV);\n  tipoConteudoDetectado = 'planilha_csv';\n  valoresEncontrados = extrairValores(textoCSV);\n} else if (textoDocumento) {\n  conteudoUnificado = limparTexto(textoDocumento);\n  tipoConteudoDetectado = detectarTipoConteudo(textoDocumento) || 'documento';\n  valoresEncontrados = extrairValores(textoDocumento);\n} else if (textoMensagem) {\n  conteudoUnificado = limparTexto(textoMensagem);\n  tipoConteudoDetectado = 'texto';\n  valoresEncontrados = extrairValores(textoMensagem);\n}\n\n// ============================================================\n// CRIAR CONTEXTO ESTRUTURADO PARA O AGENTE\n// ============================================================\n\nif (!conteudoUnificado) {\n  conteudoUnificado = textoMensagem || '[Sem conteúdo identificado]';\n}\n\nlet mensagemContexto = '';\n\nswitch (tipoConteudoDetectado) {\n  case 'fatura_cartao':\n    mensagemContexto = `📄 **FATURA DE CARTÃO RECEBIDA**\\n\\n${conteudoUnificado}`;\n    if (valoresEncontrados.length > 0) {\n      mensagemContexto += `\\n\\n💰 **Valores identificados:** ${valoresEncontrados.join(', ')}`;\n    }\n    break;\n    \n  case 'comprovante':\n    mensagemContexto = `🧾 **COMPROVANTE RECEBIDO**\\n\\n${conteudoUnificado}`;\n    if (valoresEncontrados.length > 0) {\n      mensagemContexto += `\\n\\n💰 **Valor:** ${valoresEncontrados[0]}`;\n    }\n    break;\n    \n  case 'nota_fiscal':\n    mensagemContexto = `📋 **NOTA FISCAL RECEBIDA**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'extrato':\n    mensagemContexto = `🏦 **EXTRATO BANCÁRIO**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'audio_transcrito':\n    mensagemContexto = `🎙️ **ÁUDIO TRANSCRITO**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'pdf':\n    mensagemContexto = `📑 **DOCUMENTO PDF**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'planilha_csv':\n    mensagemContexto = `📊 **PLANILHA/CSV**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'imagem':\n    mensagemContexto = `🖼️ **IMAGEM ANALISADA**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  default:\n    mensagemContexto = conteudoUnificado;\n}\n\n// ============================================================\n// RETORNAR DADOS UNIFICADOS\n// ============================================================\n\nreturn {\n  json: {\n    ...json,\n    \n    // Campos unificados para o agente\n    mensagem_unificada: mensagemContexto,\n    mensagem_contexto: mensagemContexto,\n    conteudo_original: conteudoUnificado,\n    \n    // Metadados úteis\n    tipo_conteudo_detectado: tipoConteudoDetectado,\n    tipo_mensagem_original: tipoMensagemOriginal,\n    valores_encontrados: valoresEncontrados,\n    \n    // Flags de debug\n    _fontes: {\n      tinha_imagem: !!textoImagem,\n      tinha_audio: !!textoAudio,\n      tinha_pdf: !!textoPDF,\n      tinha_csv: !!textoCSV,\n      tinha_documento: !!textoDocumento,\n      tinha_texto: !!textoMensagem\n    },\n    \n    // Mensagem para o agente\n    mensagem: mensagemContexto,\n    output_preview: mensagemContexto.substring(0, 200) + '...',\n    text: conteudoUnificado\n  }\n};"
      },
      "id": "7726eae0-ae29-44bb-989b-55ae50e6cb8e",
      "name": "Unificador de Mensagens",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        34336,
        27936
      ],
      "notes": "Unifica todas as entradas (texto, áudio, imagem, PDF, CSV) em um formato padronizado para o agente"
    },
    {
      "parameters": {
        "content": "## Desligar testes\n",
        "height": 320,
        "width": 992,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32672,
        25584
      ],
      "typeVersion": 1,
      "id": "6e90f0d1-4345-4f45-81aa-562ccdd9abbd",
      "name": "Sticky Note23",
      "disabled": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=desligar"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)5",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        32912,
        25664
      ],
      "id": "0b710811-a3a5-420b-ac41-43af410458f2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Desligada\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33392,
        25552
      ],
      "id": "a0f880d7-5097-4726-9fca-54b13e479691",
      "name": "Whatsapp4",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)6",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        33616,
        25648
      ],
      "id": "d2da2dbb-655e-4e09-b868-1b2919b2c5fe"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        33168,
        25648
      ],
      "id": "596ca707-5558-45bc-9739-7794def3d911",
      "name": "Canal3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').item.json.id_contato }}\",\n  \"message\": \"Pode iniciar o teste\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33392,
        25744
      ],
      "id": "934f014e-7dbd-4e4d-9c91-d3242ce80bf1",
      "name": "Instagram3",
      "retryOnFail": true
    },
    {
      "parameters": {
        "content": "## ativar assistente adm",
        "height": 320,
        "width": 992,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32672,
        25232
      ],
      "typeVersion": 1,
      "id": "fbfd8d17-0773-4a49-8ca1-07a138c09a6a",
      "name": "Sticky Note24",
      "disabled": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=assistente-adm"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)7",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        32912,
        25312
      ],
      "id": "38427096-afe4-4b14-9137-bd50df1bbc0b"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Oi estou aqui\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33392,
        25200
      ],
      "id": "1def1241-0488-463c-ae93-95364b0ca8fd",
      "name": "Whatsapp5",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        33168,
        25296
      ],
      "id": "7848fdec-5188-480f-b772-b5b57a3caa4c",
      "name": "Canal5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').item.json.id_contato }}\",\n  \"message\": \"Pode iniciar o teste\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33392,
        25392
      ],
      "id": "2bcd4311-5415-4792-8dbb-46774b11cd6f",
      "name": "Instagram5",
      "retryOnFail": true
    },
    {
      "parameters": {
        "description": "Utilize essa ferramenta para enviar o comprovante de pagamento para o gestor responsável.",
        "workflowId": {
          "__rl": true,
          "value": "0r0V3ija6EM88T6E",
          "mode": "list",
          "cachedResultUrl": "/workflow/0r0V3ija6EM88T6E",
          "cachedResultName": "05 - Escalar para humano - SOCIALFY"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api key v2": "={{ $('Info').first().json.api_key }}",
            "telefone": "={{ $('Info').first().json.telefone }}",
            "message": "=Time, mais uma consulta efetuada: Segue o link do comprovante de pagamento, basta clicar pra baixar: {{ $('Download Comprovante1').first().json.photo_audio }}",
            "contact_id": "={{ $('Info').first().json.id_conversa_alerta }}",
            "location.id": "={{ $('Info').first().json.location_id }}",
            "usuario_responsavel": "={{ $('Mensagem recebida').first().json.body.location.name }}",
            "tool": "Enviar comprovante de pagamento"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "api key v2",
              "displayName": "api key v2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "message",
              "displayName": "message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location.id",
              "displayName": "location.id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "usuario_responsavel",
              "displayName": "usuario_responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tool",
              "displayName": "tool",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38720,
        28144
      ],
      "id": "f88029fa-8eb9-4591-b208-fae54a6ff8b9",
      "name": "Enviar comprovante de pagamento"
    },
    {
      "parameters": {
        "jsCode": "// --- INÍCIO DO CÓDIGO ---\n\n// Passo 1: Obter os dados de entrada de forma segura.\nconst inputData = $input.first()?.json || {};\nconst conversation = inputData.conversations?.[0] || {};\n\n// --- LÓGICA DE DECISÃO ---\n\nlet tipoResposta = 'texto'; // Começamos com o padrão\nlet motivoDecisao = 'Padrão (nenhuma regra especial ativada)';\n\n// Palavras-chave que indicam que a última mensagem do usuário foi um áudio.\nconst audioKeywords = ['áudio', 'audio', 'transcrição', 'transcricao'];\n\n// Passo 2 (Prioridade 1): Análise Dinâmica da Última Mensagem\nconst lastMessageBody = conversation.lastMessageBody || '';\nconst lastMessageLower = lastMessageBody.toLowerCase();\n\n// A função .some() verifica se pelo menos um item do array satisfaz a condição.\nconst isLastMessageAudio = audioKeywords.some(keyword => lastMessageLower.includes(keyword));\n\nif (isLastMessageAudio) {\n  tipoResposta = 'audio';\n  motivoDecisao = 'Dinâmico (última mensagem do usuário foi um áudio)';\n} else {\n  // Passo 3 (Prioridade 2): Análise da Preferência Estática do Usuário\n  // Suporta tanto GHL (customFields) quanto outras fontes (custom_attributes).\n  const customData = inputData.customFields || inputData.custom_attributes || {};\n  const preferenciaSalva = customData.preferencia_audio_texto || 'texto';\n\n  if (preferenciaSalva === 'audio' || preferenciaSalva === 'áudio') {\n    tipoResposta = 'audio';\n    motivoDecisao = 'Estático (preferência salva do usuário é áudio)';\n  } else {\n    tipoResposta = 'texto';\n    motivoDecisao = 'Estático (preferência salva do usuário é texto)';\n  }\n}\n\n// --- PREPARAÇÃO DA SAÍDA ---\n\n// Passo 4: Determinar o formato de saída com base na decisão.\nconst formatoSaida = tipoResposta === 'audio' ? 'voice_note' : 'text';\n\n// Passo 5: Retornar um objeto JSON claro para os próximos nós do workflow.\nreturn [{\n  json: {\n    tipo_resposta: tipoResposta,\n    formato_saida: formatoSaida,\n    deve_enviar_audio: tipoResposta === 'audio',\n    deve_enviar_texto: tipoResposta === 'texto',\n    motivo_da_decisao: motivoDecisao // Campo extra para facilitar o debug\n  }\n}];\n\n// --- FIM DO CÓDIGO ---"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39264,
        27904
      ],
      "id": "49bea2f2-fbf2-4e70-ab43-c27c6ae6538e",
      "name": "Calcular tipo da resposta"
    },
    {
      "parameters": {
        "content": "## 🚦 VERIFICAÇÃO DE TRÁFEGO - 03/01/2026\n\n### Lógica:\n- **tem_contexto_utm = true** → Lead veio de TRÁFEGO (anúncio)\n  - SKIP toda classificação de IA\n  - Já tem automação própria no GHL\n  \n- **tem_contexto_utm = false** → Lead orgânico ou prospectado\n  - Continua para Match Lead Context\n  - Segue fluxo de classificação\n\n### Tags do Sistema:\n| Tag | Quando |\n|-----|--------|\n| `lead-prospectado-ia` | matched=true (AgenticOS) |\n| `lead-classificado-ia` | Lead válido (LEAD_*) |\n| `perdido` | SPAM ou PESSOAL |\n",
        "height": 492,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        31872,
        23712
      ],
      "id": "21c3ac1e-8b6d-4d1b-b025-5a6d4adfd350",
      "name": "Verificação Tráfego"
    },
    {
      "parameters": {
        "content": "## PALIATIVO: Detectar Origem da Conversa\n\n**Propósito:** Identificar se a conversa foi iniciada pelo BDR (outbound) ou pelo Lead (inbound/novo seguidor).\n\n**Fluxo:**\n1. Chama Railway `/api/detect-conversation-origin`\n2. API analisa primeira mensagem da conversa no GHL\n3. Se primeira msg foi outbound → BDR abordou\n4. Se primeira msg foi inbound → Novo seguidor\n5. Tags são adicionadas automaticamente\n\n**Tags adicionadas:**\n- Outbound: `outbound-instagram`, `bdr-abordou`, `prospectado`\n- Inbound: `novo-seguidor`, `inbound-organico`, `lead-iniciou`\n\n**Data:** 2026-01-19",
        "height": 400,
        "width": 500,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        31584,
        23872
      ],
      "id": "2d26be33-ce54-4447-91da-affc7e60284f",
      "name": "Nota: Detectar Origem"
    },
    {
      "parameters": {
        "content": "## 🎯 PALIATIVO: Detectar Origem da Conversa\n**Data:** 2026-01-19\n\n### Fluxo:\n```\n[Info]\n   │\n   ▼\n[É Primeira Mensagem?]\n   │\n   ├── TRUE ──► [Detectar Origem]\n   │                 │\n   │                 ▼\n   │            [Switch: BDR ou Seguidor]\n   │                 │\n   │            ┌────┴────┐\n   │            ▼         ▼\n   │         [BDR]    [Seguidor]\n   │            │         │\n   │            └────┬────┘\n   │                 │\n   │                 ▼\n   │           [Veio de Tráfego?]\n   │\n   └── FALSE ──► [Analisar Contexto]\n                      │\n                      ▼\n                 [Decisão: Ativar IA?]\n```\n\n### Tags adicionadas (auto):\n- **Outbound:** `outbound-instagram`, `bdr-abordou`, `prospectado`\n- **Inbound:** `novo-seguidor`, `inbound-organico`, `lead-iniciou`",
        "height": 560,
        "width": 420,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        31952,
        24688
      ],
      "id": "a28cc4a6-dd67-4d0a-9123-e5579924cbf3",
      "name": "Nota: Paliativo BDR"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Set mensagens - Mapeia campos do workflow Info para formato interno\nconst setMensagensData = $('Set mensagens').first().json;\n\nconst input = $input.item.json;\n\n// Pegar dados do Info diretamente para garantir calendários\nconst infoData = $('Info').first().json;\n\n// Extrair source baseado no agente\nlet source = 'whatsapp';\nif (infoData.agente_ia === 'social_seller_instagram' || infoData.source === 'instagram') {\n  source = 'instagram';\n}\n\n// Extrair etiquetas (pode ser string ou array)\nlet etiquetas = [];\nif (input.etiquetas) {\n  etiquetas = typeof input.etiquetas === 'string' \n    ? input.etiquetas.split(',').map(t => t.trim()).filter(t => t) \n    : input.etiquetas;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS DO FORMULÁRIO DE TRÁFEGO (Facebook/Instagram Ads)\n// ─────────────────────────────────────────────────────────────────────────────\nconst formularioTrafego = {\n  origem_campanha: infoData.utm_campaign || input.utm_source || '',\n  sintomas_atuais: infoData.form_sintomas_atualmente || '',\n  procurou_ajuda: infoData.form_procurou_ajuda_medica || '',\n  mudanca_corpo: infoData.form_mudanca_no_corpo || '',\n  preferencia_consulta: infoData.form_tipo_de_consulta || '',\n  pronto_investir: infoData.form_interessado_em_investir || ''\n};\n\n// Verificar se é lead de tráfego (tem dados do formulário)\nconst isLeadTrafego = !!(formularioTrafego.sintomas_atuais || formularioTrafego.preferencia_consulta || formularioTrafego.origem_campanha || formularioTrafego.procurou_ajuda);\n\nreturn {\n  json: {\n    // IDs\n    location_id: infoData.location_id || input.owner_origin || '',\n    contact_id: infoData.lead_id || '',\n    conversation_id: infoData.id_conversa_alerta || infoData.lead_id || '',\n    \n    // Dados do contato\n    phone: infoData.telefone || '',\n    full_name: infoData.full_name || infoData.first_name || 'Visitante',\n    \n    // Mensagem\nmessage: setMensagensData.mensagem || infoData.mensagem || input.resposta_ia || '',\n    source: source,\n    \n    // Contexto do lead\n    historico: input.historico || [],\n    etiquetas: etiquetas,\n    status_pagamento: infoData.status_cobranca || 'nenhum',\n    preferencia_audio_texto: infoData.tipo_mensagem_original || 'texto',\n    \n    // Modo do agente\n    modo_agente: infoData.agente_ia || 'sdr_inbound',\n    \n    // Calendários do GHL - AGORA PEGANDO DO INFO DIRETAMENTE\n    calendarios_ghl: {\n      sao_paulo: infoData.agenda_consultorio_sao_paulo || '',\n      presidente_prudente: infoData.agenda_presidente_prudente || '',\n      online: infoData.agenda_consulta_online || ''\n    },\n    \n    // API Key\n    ghl_api_key: infoData.api_key || '',\n    \n    // Dados extras do lead\n    objetivo: infoData.objetivo_do_lead || '',\n    is_primeira_mensagem: infoData.is_primeira_mensagem || false,\n    tipo_lead: infoData.tipo_lead || 'NAO_IDENTIFICADO',\n    \n    // Dados do formulário de tráfego\n    formulario_trafego: formularioTrafego,\n    is_lead_trafego: isLeadTrafego\n  }\n};"
      },
      "id": "8e659b1e-3c7c-4950-abf8-1924f6fc9cf0",
      "name": "Set mensagens3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36640,
        27968
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  SELECT av.*, l.api_key as location_api_key\n  FROM agent_versions av\n  LEFT JOIN locations l ON av.location_id = l.location_id\n  WHERE av.location_id = '{{ $('Set mensagens3').first().json.location_id }}'\n    AND av.is_active = true\n    AND av.status = 'active'\n    AND NOT EXISTS (\n      SELECT 1 FROM supervision_states ss\n      WHERE ss.session_id = '{{ $('Set mensagens3').first().json.contact_id }}'\n      AND ss.ai_enabled = false\n    )\n  ORDER BY av.deployed_at DESC NULLS LAST, av.created_at DESC\n  LIMIT 1",
        "options": {}
      },
      "id": "a07428f3-31d9-4fb4-acc7-8d10178b184f",
      "name": "Buscar Agente Ativo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        36864,
        27968
      ],
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// FORMATAR CALENDÁRIOS\n// Usa calendários do GHL (customData) com fallback para scheduling_config\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\nconst schedulingConfig = prev.scheduling_config || {};\nconst calendariosGHL = prev.calendarios_ghl || {};\n\n// Mapear calendários - prioridade para GHL, fallback para config do agente\nconst calendarios = [];\n\nconst calSP = calendariosGHL.sao_paulo || schedulingConfig.agenda_consultorio_sao_paulo;\nconst calPP = calendariosGHL.presidente_prudente || schedulingConfig.agenda_presidente_prudente;\nconst calOnline = calendariosGHL.online || schedulingConfig.agenda_consulta_online;\n\nif (calSP) {\n  calendarios.push(`• Consultório São Paulo (Moema): ID ${calSP}`);\n}\n\nif (calPP) {\n  calendarios.push(`• Unidade Presidente Prudente: ID ${calPP}`);\n}\n\nif (calOnline) {\n  calendarios.push(`• Consulta Online (Telemedicina): ID ${calOnline}`);\n}\n\n// Se não houver calendários configurados\nif (calendarios.length === 0) {\n  calendarios.push('• Calendários não configurados');\n}\n\nconst calendariosFormatados = calendarios.join('\\n');\n\n// Informações de agendamento\nconst agendamentoInfo = [\n  `Horários: Segunda a Sexta, 9h-18h | Sábado 8h-12h`,\n  `Duração consulta: 1h a 1h30`,\n  `Antecedência mínima: 24 horas`,\n  `Cancelamento: Até 24h antes sem custo`\n].join('\\n');\n\nreturn {\n  json: {\n    ...prev,\n    calendarios_formatados: calendariosFormatados,\n    agendamento_info: agendamentoInfo,\n    // IDs para usar nas tools de agendamento\n    calendar_ids: {\n      sao_paulo: calSP || '',\n      presidente_prudente: calPP || '',\n      online: calOnline || ''\n    },\n    // Garantir que dados do formulário passam adiante\n    formulario_trafego: prev.formulario_trafego || {},\n    is_lead_trafego: prev.is_lead_trafego || false\n  }\n};"
      },
      "id": "03bba0cb-4a1c-4dec-8912-7f8c893c5595",
      "name": "Formatar Calendários",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37296,
        27968
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n  // MONTAR PROMPTS FINAIS v6.7 - CORRIGIDO COM TIMEZONE BRT\n  // ═══════════════════════════════════════════════════════════════════════════\n\n  const prev = $input.item.json;\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // FUNÇÃO PARA SUBSTITUIR VARIÁVEIS MUSTACHE\n  // ─────────────────────────────────────────────────────────────────────────────\n  function replaceVars(template, vars) {\n    if (!template) return '';\n    let result = template;\n\n    for (const [key, value] of Object.entries(vars)) {\n      const pattern = new RegExp(`\\\\{\\\\{\\\\s*${key}\\\\s*\\\\}\\\\}`, 'g');\n      result = result.replace(pattern, value || '');\n    }\n\n    return result;\n  }\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // VARIÁVEIS PARA SUBSTITUIÇÃO\n  // ─────────────────────────────────────────────────────────────────────────────\n  const variaveis = {\n    modo_agente: prev.agent_type || 'sdr_inbound',\n    source: prev.source || 'instagram',\n    full_name: prev.full_name || 'Visitante',\n    timezone: 'America/Sao_Paulo',\n    agente: prev.agent_name || 'Isabella',\n    data_hora: prev.data_hora,\n    status_pagamento: prev.status_pagamento || 'nenhum',\n    preferencia_audio_texto: prev.preferencia_audio_texto || 'texto'\n  };\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // DETECTAR MODO ATIVO (agente_ia)\n  // ─────────────────────────────────────────────────────────────────────────────\n  const modoAtivo = prev.agente_ia || prev.agent_type || 'sdr_inbound';\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // PEGAR PROMPTS DO SUPABASE (prompts_by_mode)\n  // ─────────────────────────────────────────────────────────────────────────────\n  const promptsDoAgente = prev.prompts_by_mode || {};\n\n  // Normalizar o modo para encontrar no JSON\n  function normalizarModo(modo) {\n    const modoLower = (modo || '').toLowerCase().trim();\n\n    const aliases = {\n      'sdr': 'sdr_inbound',\n      'inbound': 'sdr_inbound',\n      'social_seller': 'social_seller_instagram',\n      'instagram': 'social_seller_instagram',\n      'agendamento': 'scheduler',\n      'followup': 'followuper',\n      'objecao': 'objection_handler',\n      'objecoes': 'objection_handler',\n      'reativador': 'reativador_base'\n    };\n\n    return aliases[modoLower] || modoLower;\n  }\n\n  const modoNormalizado = normalizarModo(modoAtivo);\n\n  // Pegar o prompt do modo ativo (ou fallback para sdr_inbound)\n  const promptModoAtivo = promptsDoAgente[modoNormalizado]\n    || promptsDoAgente['sdr_inbound']\n    || '';\n\n  // Prompt base vem do system_prompt do agente\n  const promptBase = prev.system_prompt || '';\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // MONTAR SYSTEM PROMPT FINAL\n  // ─────────────────────────────────────────────────────────────────────────────\n  let systemPrompt = promptBase + '\\n\\n' + promptModoAtivo;\n\n  // Substituir variáveis\n  systemPrompt = replaceVars(systemPrompt, variaveis);\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // REGRA DINÂMICA DE SAUDAÇÃO - CORRIGIDO COM TIMEZONE BRT\n  // ─────────────────────────────────────────────────────────────────────────────\n  let regraSaudacao = '';\n\n  // ✅ CORREÇÃO: Usar hora de Brasília, não UTC\n  const agoraBRT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));\n  const hora = agoraBRT.getHours();\n  const historicoExiste = prev.historico_existe;\n\n  if (!historicoExiste) {\n    if (hora >= 5 && hora < 12) {\n      regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Bom dia\" de forma calorosa.\\n</regra_saudacao>';\n    } else if (hora >= 12 && hora < 18) {\n      regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Boa tarde\" de forma calorosa.\\n</regra_saudacao>';\n    } else {\n      regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Boa noite\" de forma calorosa.\\n</regra_saudacao>';\n    }\n  } else {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nConversa já iniciada. NÃO repita saudação. Continue naturalmente.\\n</regra_saudacao>';\n  }\n\n  systemPrompt += regraSaudacao;\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // MONTAR BLOCO DE RESPOSTAS DO FORMULÁRIO DE TRÁFEGO\n  // ─────────────────────────────────────────────────────────────────────────────\n  let blocoFormularioTrafego = '';\n  const form = prev.formulario_trafego || {};\n  const isLeadTrafego = prev.is_lead_trafego || false;\n\n  if (isLeadTrafego) {\n    const linhas = [];\n    if (form.origem_campanha) linhas.push(`VEIO POR CAMPANHA: ${form.origem_campanha}`);\n    if (form.procurou_ajuda) linhas.push(`PROCUROU AJUDA ANTES: ${form.procurou_ajuda}`);\n    if (form.sintomas_atuais) linhas.push(`SINTOMAS ATUAIS: ${form.sintomas_atuais}`);\n    if (form.mudanca_corpo) linhas.push(`MUDANÇA NO CORPO: ${form.mudanca_corpo}`);\n    if (form.preferencia_consulta) linhas.push(`PREFERÊNCIA CONSULTA: ${form.preferencia_consulta}`);\n    if (form.pronto_investir) linhas.push(`PRONTO PRA INVESTIR: ${form.pronto_investir}`);\n\n    if (linhas.length > 0) {\n      blocoFormularioTrafego = `\\n<respostas_formulario_trafego>\\n${linhas.join('\\n')}\\n</respostas_formulario_trafego>\\n`;\n    }\n  }\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // MONTAR USER PROMPT\n  // ─────────────────────────────────────────────────────────────────────────────\n  const etiquetasStr = Array.isArray(prev.etiquetas)\n    ? prev.etiquetas.join(', ')\n    : (prev.etiquetas || 'nenhuma');\n\n  let userPrompt = `\n  <contexto_conversa>\n  LEAD: ${prev.full_name}\n  CANAL: ${prev.source}\n  DDD: ${prev.ddd || 'não identificado'}\n  DATA/HORA: ${prev.data_hora}\n  ETIQUETAS: ${etiquetasStr}\n  STATUS PAGAMENTO: ${prev.status_pagamento}\n  MODO ATIVO: ${modoAtivo}\n  </contexto_conversa>\n  `;\n\n  if (blocoFormularioTrafego) {\n    userPrompt += blocoFormularioTrafego;\n  }\n\n  userPrompt += `\n  <hiperpersonalizacao>\n  ${prev.contexto_hiperpersonalizado}\n  </hiperpersonalizacao>\n\n  <calendarios_disponiveis>\n  ${prev.calendarios_formatados || ''}\n\n  ${prev.agendamento_info || ''}\n  </calendarios_disponiveis>\n  `;\n\n  if (prev.historico_formatado) {\n    userPrompt += `\n  <historico_conversa>\n  ${prev.historico_formatado}\n  </historico_conversa>\n  `;\n  }\n\n  userPrompt += `\n  <mensagem_atual>\n  LEAD: ${prev.message}\n  </mensagem_atual>\n\n  Responda à mensagem acima como Isabella, seguindo as instruções do MODO ATIVO: ${modoAtivo}.`;\n\n  // ─────────────────────────────────────────────────────────────────────────────\n  // OUTPUT FINAL\n  // ─────────────────────────────────────────────────────────────────────────────\n  return {\n    json: {\n      system_prompt: systemPrompt,\n      user_prompt: userPrompt,\n      _meta: {\n        agent_name: prev.agent_name || 'Isabella',\n        agent_version: prev.version || 'v6.7',\n        modo_ativo: modoAtivo,\n        modo_normalizado: modoNormalizado,\n        prompt_modo_encontrado: !!promptsDoAgente[modoNormalizado],\n        contact_id: prev.contact_id,\n        conversation_id: prev.conversation_id,\n        historico_mensagens: prev.historico_existe ? 'sim' : 'não',\n        hora_execucao: prev.data_hora,\n        hora_brt: hora,  // ← Para debug\n        is_lead_trafego: isLeadTrafego,\n        prompt_size: systemPrompt.length,\n        modos_disponiveis: Object.keys(promptsDoAgente)\n      }\n    }\n  };"
      },
      "id": "b5def1a7-b060-48db-abab-51bdde4f5103",
      "name": "Montar Prompts Finais",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37520,
        27968
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// PREPARAR EXECUÇÃO + IDENTIFICAR CONTEXTO v6.6 - VERSÃO SUPABASE\n// Passa prompts_by_mode do Supabase para o próximo nó\n// ═══════════════════════════════════════════════════════════════════════════\n\n// Pegar dados do agente (vem do node anterior - Buscar Agente Ativo)\nconst agent = $input.item.json;\n\n// Pegar dados das mensagens dos nodes Set mensagens\nconst mensagens = $('Set mensagens3').first().json;\nconst setMensagens = $('Set mensagens').first().json;\n\n// Pegar customData do webhook original\nconst customData = $('Mensagem recebida').first().json.body?.customData || {};\n\n// Pegar agente_ia direto do Info (fonte mais confiável)\nconst infoData = $('Info').first().json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSE SEGURO DE JSON\n// ─────────────────────────────────────────────────────────────────────────────\nfunction safeParseJSON(value, fallback = {}) {\n  if (!value) return fallback;\n  if (typeof value === 'object') return value;\n  try {\n    return JSON.parse(value);\n  } catch (e) {\n    console.log('Erro parsing JSON:', e.message);\n    return fallback;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// EXTRAIR DDD DO TELEFONE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction extrairDDD(telefone) {\n  if (!telefone) return null;\n  const limpo = telefone.replace(/\\D/g, '');\n\n  if (limpo.startsWith('55') && limpo.length >= 12) {\n    return limpo.substring(2, 4);\n  }\n  if (limpo.length >= 10 && limpo.length <= 11) {\n    return limpo.substring(0, 2);\n  }\n  return null;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETERMINAR PERÍODO DO DIA\n// ─────────────────────────────────────────────────────────────────────────────\nfunction getPeriodoHorario() {\n    const agora = new Date();\n    const agoraBRT = new Date(agora.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));\n    const hora = agoraBRT.getHours();\n\n    if (hora >= 5 && hora < 12) return 'manha';\n    if (hora >= 12 && hora < 18) return 'tarde';\n    return 'noite';\n  }\n\n// ─────────────────────────────────────────────────────────────────────────────\n// GERAR CONTEXTO HIPERPERSONALIZADO\n// ─────────────────────────────────────────────────────────────────────────────\nfunction gerarContextoHiperpersonalizado(ddd, periodo, hyperConfig) {\n  const contextos = [];\n\n  if (hyperConfig.personalizacao_por_ddd && ddd) {\n    const dddConfig = hyperConfig.personalizacao_por_ddd[ddd];\n    if (dddConfig) {\n      contextos.push(`[REGIÃO ${ddd}] ${dddConfig.contexto || ''}`);\n      if (dddConfig.unidade_proxima) {\n        contextos.push(`Unidade mais próxima: ${dddConfig.unidade_proxima}`);\n      }\n    }\n  }\n\n  if (hyperConfig.saudacoes_por_horario) {\n    const saudacao = hyperConfig.saudacoes_por_horario[periodo];\n    if (saudacao) {\n      contextos.push(`Saudação recomendada: \"${saudacao}\"`);\n    }\n  }\n\n  return contextos.length > 0\n    ? contextos.join('\\n')\n    : 'Usar abordagem padrão empática e acolhedora';\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PARSEAR CONFIGURAÇÕES DO AGENTE\n// ─────────────────────────────────────────────────────────────────────────────\nconst toolsConfig = safeParseJSON(agent.tools_config, {});\nconst businessConfig = safeParseJSON(agent.business_config, {});\nconst hyperpersonalization = safeParseJSON(agent.hyperpersonalization, {});\nconst qualificationConfig = safeParseJSON(agent.qualification_config, {});\nconst schedulingConfig = safeParseJSON(agent.scheduling_config, {});\nconst complianceConfig = safeParseJSON(agent.compliance_config, {});\nconst escalationConfig = safeParseJSON(agent.escalation_config, {});\nconst metricsConfig = safeParseJSON(agent.metrics_config, {});\nconst integrationConfig = safeParseJSON(agent.integration_config, {});\nconst knowledgeBase = safeParseJSON(agent.knowledge_base, []);\n\n// ⚠️ NOVO v6.6: Parsear prompts_by_mode do Supabase\nconst promptsByMode = safeParseJSON(agent.prompts_by_mode, {});\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS CONTEXTUAIS\n// ─────────────────────────────────────────────────────────────────────────────\nconst ddd = extrairDDD(mensagens.phone);\nconst periodo = getPeriodoHorario();\nconst agora = new Date();\nconst dataHora = agora.toLocaleString('pt-BR', {\n  timeZone: 'America/Sao_Paulo',\n  dateStyle: 'full',\n  timeStyle: 'short'\n});\n\nconst contextoHiper = gerarContextoHiperpersonalizado(ddd, periodo, hyperpersonalization);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FORMATAR HISTÓRICO\n// ─────────────────────────────────────────────────────────────────────────────\nlet historicoFormatado = '';\nif (mensagens.historico && mensagens.historico.length > 0) {\n  historicoFormatado = mensagens.historico\n    .slice(-10)\n    .map(m => `${m.role === 'user' ? 'LEAD' : 'ASSISTENTE'}: ${m.content}`)\n    .join('\\n');\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETECTAR MODO ATIVO (agente_ia)\n// ─────────────────────────────────────────────────────────────────────────────\nconst agenteIA = infoData.agente_ia\n  || customData.agente_ia\n  || customData.agente_IA\n  || setMensagens.source\n  || mensagens.modo_agente\n  || agent.agent_type\n  || 'sdr_inbound';\n\nconsole.log('>>> MODO ATIVO DETECTADO:', agenteIA);\nconsole.log('>>> PROMPTS DISPONÍVEIS:', Object.keys(promptsByMode));\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    agent_id: agent.id,\n    agent_name: agent.agent_name || 'Agente',\n    agent_type: agent.agent_type,\n    version: agent.version,\n    system_prompt: agent.system_prompt,\n    user_prompt_template: agent.user_prompt_template,\n    location_api_key: agent.location_api_key,\n    agente_ia: agenteIA,\n    prompts_by_mode: promptsByMode,\n    tools_config: toolsConfig,\n    business_config: businessConfig,\n    hyperpersonalization: hyperpersonalization,\n    qualification_config: qualificationConfig,\n    scheduling_config: schedulingConfig,\n    compliance_config: complianceConfig,\n    escalation_config: escalationConfig,\n    metrics_config: metricsConfig,\n    integration_config: integrationConfig,\n    knowledge_base: knowledgeBase,\n    contact_id: mensagens.contact_id,\n    phone: mensagens.phone,\n    full_name: mensagens.full_name,\n    source: mensagens.source,\n    message: mensagens.message,\n    conversation_id: mensagens.conversation_id,\n    etiquetas: mensagens.etiquetas,\n    status_pagamento: mensagens.status_pagamento,\n    preferencia_audio_texto: mensagens.preferencia_audio_texto,\n    ddd: ddd,\n    periodo: periodo,\n    data_hora: dataHora,\n    contexto_hiperpersonalizado: contextoHiper,\n    historico_formatado: historicoFormatado,\n    historico_existe: mensagens.historico && mensagens.historico.length > 0,\n    hora_numero: new Date(agora.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' })).getHours(),\n    calendarios_ghl: mensagens.calendarios_ghl || {},\n    ghl_api_key: mensagens.ghl_api_key || '',\n    formulario_trafego: mensagens.formulario_trafego || {},\n    is_lead_trafego: mensagens.is_lead_trafego || false\n  }\n};"
      },
      "id": "7c865495-d173-4b6b-a3ea-8a8c7eda06b4",
      "name": "Preparar Execução + Identificar Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37088,
        27968
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/match-lead-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('Info').first().json.telefone || '' }}\",\n  \"email\": \"{{ $('Info').first().json.email || '' }}\",\n  \"ig_id\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.igSid || '' }}\",\n  \"ghl_contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"ig_handle\": \"{{ $('Info').first().json.instagram || '' }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        33824,
        24848
      ],
      "id": "fcbae4ef-d93f-493a-bf6d-10f53affec7c",
      "name": "Match Lead Context",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.matched }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "matched-true-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Lead Já Enriquecido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.matched }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "matched-false-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Fazer Scrape"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34048,
        24848
      ],
      "id": "22a3d4ca-211b-470f-b80e-da22d30f6adb",
      "name": "Lead Prospectado?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/auto-enrich-lead",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('Info').first().json.telefone || '' }}\",\n  \"email\": \"{{ $('Info').first().json.email || '' }}\",\n  \"ig_id\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.igSid || $('Mensagem recebida').first().json.body?.contact?.attributionSource?.mediumId || '' }}\",\n  \"ig_handle\": \"{{ $('Info').first().json.instagram || '' }}\",\n  \"ghl_contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"first_name\": \"{{ $('Info').first().json.first_name || '' }}\",\n  \"source_channel\": \"{{ $('Mensagem recebida').first().json.body?.contact?.attributionSource?.medium || 'ghl_webhook' }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34272,
        24736
      ],
      "id": "c2f8d4c8-76c0-427b-b464-967f965213fe",
      "name": "Auto Enrich Lead",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Scrape automático do Instagram + salva no banco"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/webhook/classify-lead",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"username\": \"{{ $('Info').first().json.first_name || 'lead' }}\",\n  \"message\": \"{{ $('Info').first().json.mensagem }}\",\n  \"tenant_id\": \"{{ $('Info').first().json.location_id || 'default' }}\",\n  \"profile_context\": {\n    \"bio\": \"{{ $('Detectar Origem (BDR ou Seguidor)').first().json.profile_context?.bio || '' }}\",\n    \"especialidade\": \"{{ $('Detectar Origem (BDR ou Seguidor)').first().json.profile_context?.specialty || '' }}\",\n    \"followers\": {{ $('Detectar Origem (BDR ou Seguidor)').first().json.profile_context?.followers || 0 }},\n    \"is_verified\": {{ $('Detectar Origem (BDR ou Seguidor)').first().json.profile_context?.is_verified || false }},\n    \"source_channel\": \"{{ $('Info').first().json.source || 'instagram' }}\"\n  },\n  \"origin_context\": {\n    \"origem\": \"{{ $('Detectar Origem (BDR ou Seguidor)').first().json.origin || $json.origem_conversa || 'unknown' }}\",\n    \"context_type\": \"{{ $('Detectar Origem (BDR ou Seguidor)').first().json.agent_context?.context_type || $json.context_type || 'primeiro_contato' }}\",\n    \"tom_agente\": \"{{ $('Detectar Origem (BDR ou Seguidor)').first().json.agent_context?.tom_agente || $json.tom_agente || 'receptivo' }}\",\n    \"origin_confidence\": {{ $('Detectar Origem (BDR ou Seguidor)').first().json.origin_confidence || 0.5 }},\n    \"instagram_username\": \"{{ $('Detectar Origem (BDR ou Seguidor)').first().json.instagram_username || '' }}\",\n    \"is_response\": {{ $('Detectar Origem (BDR ou Seguidor)').first().json.message_analysis?.is_response || false }}\n  },\n  \"context\": {\n    \"source\": \"{{ $('Info').first().json.source || 'unknown' }}\",\n    \"phone\": \"{{ $('Info').first().json.telefone || '' }}\",\n    \"email\": \"{{ $('Info').first().json.email || '' }}\",\n    \"tags\": \"{{ $('Info').first().json.etiquetas || '' }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34496,
        24736
      ],
      "id": "670f548a-f21d-4b63-aaaf-21963367d860",
      "name": "Classificar Lead IA",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Classifica automaticamente: LEAD_HOT, LEAD_WARM, LEAD_COLD, PESSOAL, SPAM"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.classification }}",
                    "rightValue": "LEAD",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "is-lead-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "É Lead - Ativar IA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.classification }}",
                    "rightValue": "PESSOAL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "is-pessoal-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Pessoal - Mover Perdido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.classification }}",
                    "rightValue": "SPAM",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "is-spam-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Spam - Mover Perdido"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34720,
        24704
      ],
      "id": "049484f5-c6a5-42a3-90d9-5b5353ef5533",
      "name": "Rotear por Classificação"
    },
    {
      "parameters": {
        "requestMethod": "PATCH",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=lead-classificado-ia"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "GHL - Tag Classificado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        35168,
        24576
      ],
      "id": "af74021b-e5b8-4467-9d83-75da873f831a",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer pit-3872ad13-41f7-4e76-a3ff-f2dee789f8d6"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"customFields\": [\n    {\"key\": \"ativar_ia\", \"field_value\": \"nao\"},\n    {\"key\": \"objetivo_lead\", \"field_value\": \"{{ $('Classificar Lead IA').first().json.classification }}\"},\n    {\"key\": \"motivo_perdido\", \"field_value\": \"{{ $('Classificar Lead IA').first().json.reasoning }}\"}\n  ],\n  \"tags\": [\"perdido\"]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34944,
        24384
      ],
      "id": "266a7d95-3cb1-4d21-824b-2183d7871b89",
      "name": "GHL - Mover Perdido",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Move lead pra perdido: PESSOAL ou SPAM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/analyze-conversation-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"current_message\": \"{{ $('Mensagem recebida').first().json.body?.message?.body || $('Mensagem recebida').first().json.body?.lastMessage?.body || '' }}\",\n  \"contact_tags\": {{ JSON.stringify(($('Mensagem recebida').first().json.body?.tags || '').split(',').filter(t => t.trim())) }},\n  \"last_message_direction\": \"{{ $('Mensagem recebida').first().json.body?.lastMessage?.direction || 'inbound' }}\",\n  \"conversation_count\": {{ $('Mensagem recebida').first().json.body?.conversationCount || 1 }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34496,
        24480
      ],
      "id": "32c957ea-f599-408d-a2ff-26acb2f6585c",
      "name": "Analisar Contexto Conversa",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Analisa: tags, última msg, histórico. Decide se ativa IA ou não."
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_activate_ia }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "should-activate-true"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ativar IA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_activate_ia }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "should-activate-false"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Não Ativar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34720,
        24480
      ],
      "id": "fedcdcea-711f-488f-9077-d34c86e656ee",
      "name": "Decisão de Contexto"
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=lead-prospectado-ia"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "GHL - Tag Prospectado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        34496,
        24928
      ],
      "id": "751dfb18-ebee-4753-bd87-3fe3aa97bf67",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-ativar-ia-prospectado",
              "leftValue": "={{ $('Info').first().json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        34272,
        24928
      ],
      "id": "b63687b7-4a26-442e-9eaa-e95b4f95e9e9",
      "name": "Já Ativou IA? (Prospectado)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-ativar-ia-classificado",
              "leftValue": "={{ $('Info').first().json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        34944,
        24576
      ],
      "id": "d946f3df-0257-4c1d-a4cf-000b4b1e55c0",
      "name": "Já Ativou IA? (Classificado)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-utm",
              "leftValue": "={{ $('Contexto UTM').first().json.tem_contexto_utm }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        33600,
        24736
      ],
      "id": "7f759b7a-d5ea-4a72-9538-4e27cbf5422a",
      "name": "Veio de Tráfego?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-primeira-mensagem",
              "leftValue": "={{ $('Info').first().json.is_primeira_mensagem }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        32704,
        24592
      ],
      "id": "944ec4c1-27c9-4b59-ad04-c62e1b15d02d",
      "name": "É Primeira Mensagem?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/enrich-and-detect-origin",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"contact_id\": \"{{ $('Info').first().json.lead_id }}\",\n    \"api_key\": \"{{ $('Info').first().json.api_key }}\",\n    \"message\": \"{{ $json.mensagem || $('Info').first().json.mensagem }}\",\n    \"location_id\": \"{{ $('Info').first().json.location_id }}\"\n  }",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32928,
        24736
      ],
      "id": "0fc6c1b0-685f-44ce-a1e4-566065b18c36",
      "name": "Detectar Origem (BDR ou Seguidor)",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Só roda na 1ª mensagem. Detecta se BDR abordou ou lead iniciou. Auto-adiciona tags."
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.origin }}",
                    "rightValue": "outbound",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "origin-outbound"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "BDR Abordou"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.origin }}",
                    "rightValue": "inbound",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "origin-inbound"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Novo Seguidor"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        33152,
        24720
      ],
      "id": "d7e4f8e3-951c-495b-9482-a65f36e2b39c",
      "name": "Origem da Conversa",
      "notesInFlow": true,
      "notes": "BDR = outbound | Seguidor = inbound"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ctx-type-001",
              "name": "context_type",
              "value": "prospecting_response",
              "type": "string"
            },
            {
              "id": "ctx-tom-001",
              "name": "tom_agente",
              "value": "direto, dar continuidade à abordagem inicial",
              "type": "string"
            },
            {
              "id": "ctx-origin-001",
              "name": "origem_conversa",
              "value": "outbound",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33376,
        24432
      ],
      "id": "9c48a933-b265-43fb-81d2-c2d36364a643",
      "name": "Contexto: BDR Abordou"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ctx-type-002",
              "name": "context_type",
              "value": "inbound_organic",
              "type": "string"
            },
            {
              "id": "ctx-tom-002",
              "name": "tom_agente",
              "value": "receptivo, qualificar interesse",
              "type": "string"
            },
            {
              "id": "ctx-origin-002",
              "name": "origem_conversa",
              "value": "inbound",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33376,
        24832
      ],
      "id": "31b38c81-0113-4708-b6b8-de29110887cb",
      "name": "Contexto: Novo Seguidor"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agenticoskevsacademy-production.up.railway.app/api/analyze-conversation-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contact_id\": \"{{ $('Info').first().json.lead_id || '' }}\",\n  \"location_id\": \"{{ $('Info').first().json.location_id || '' }}\",\n  \"current_message\": \"{{ $('Mensagem recebida').first().json.body?.message?.body || $('Mensagem recebida').first().json.body?.lastMessage?.body || '' }}\",\n  \"contact_tags\": {{ JSON.stringify(($('Mensagem recebida').first().json.body?.tags || '').split(',').filter(t => t.trim())) }},\n  \"last_message_direction\": \"{{ $('Mensagem recebida').first().json.body?.lastMessage?.direction || 'inbound' }}\",\n  \"conversation_count\": {{ $('Mensagem recebida').first().json.body?.conversationCount || 1 }}\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        34496,
        24256
      ],
      "id": "b670713f-1bb5-4b0e-8e88-66a9a5d4b213",
      "name": "Analisar Contexto Conversa1",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Msgs seguintes: analisa tags existentes e decide se ativa IA"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_activate_ia }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "should-activate-true"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ativar IA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.should_activate_ia }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "should-activate-false"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Não Ativar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        34720,
        24256
      ],
      "id": "a8eab6c1-2e1d-47f6-ae5e-469e7302b538",
      "name": "Decisão de Contexto1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://cliente-a1.mentorfy.io/webhook/quality-analyzer",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        42192,
        26432
      ],
      "id": "ef0aa757-b7f0-482c-bafd-9aaa2d4d90b8",
      "name": "Detectar Origem (BDR ou Seguidor)1",
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Só roda na 1ª mensagem. Detecta se BDR abordou ou lead iniciou. Auto-adiciona tags."
    },
    {
      "parameters": {
        "jsCode": "const currentItem = $input.first().json;\n  const setMensagens = $('Set mensagens').first().json;\n\n  return {\n    json: {\n      session_id: currentItem.session_id || $('Info').first().json.lead_id,\n      location_id: currentItem.location_id || $('Info').first().json.location_id,\n      lead_message: $('Info').first().json.mensagem || '',\n      agent_response: currentItem.message?.content || '',\n      conversation_history: setMensagens.mensagens_antigas || '',\n      agent_name: \"Marcos Social Business\"\n    }\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        41952,
        26432
      ],
      "id": "b3b110ba-d24c-424e-a812-2475e26c8442",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "description": "Atualizar o primeiro nome e sobrenome do lead no GHL. Use quando o lead informar o nome correto e o nome atual estiver errado (ex: username do Instagram, frase aleatória).",
        "workflowId": {
          "__rl": true,
          "value": "FfyhRU0ELkdne2kQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/FfyhRU0ELkdne2kQ",
          "cachedResultName": "Atualizar Nome GHL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "primeiro_nome": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('primeiro_nome', ``, 'string') }}",
            "sobrenome": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('sobrenome', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "primeiro_nome",
              "displayName": "primeiro_nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sobrenome",
              "displayName": "sobrenome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        38864,
        28160
      ],
      "id": "df242eba-08b4-4f6f-b628-5ef08ae93439",
      "name": "Atualizar_nome"
    }
  ],
  "pinData": {
    "1️⃣ Listar campos customizados": [
      {
        "json": {
          "customFields": [
            {
              "id": "41NnWP9CM6f8ao444wAA",
              "name": "Commision",
              "model": "contact",
              "fieldKey": "contact.commision",
              "placeholder": "Commision",
              "dataType": "MONETORY",
              "position": 650,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:38.004Z",
              "standard": false
            },
            {
              "id": "44j7hoM33qQ4oXEpRlav",
              "name": "Insured Name",
              "model": "contact",
              "fieldKey": "contact.insured_name",
              "placeholder": "Insured Name",
              "dataType": "TEXT",
              "position": 450,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.988Z",
              "standard": false
            },
            {
              "id": "x",
              "name": "x",
              "model": "contact",
              "fieldKey": "contact.x",
              "placeholder": "Selecione o agente",
              "dataType": "SINGLE_OPTIONS",
              "position": 750,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-11-27T20:13:34.994Z",
              "standard": false,
              "picklistOptions": [
                "followuper",
                "customersuccess",
                "closer",
                "engagementkeeper",
                "rescheduler",
                "socialsellerconsultoria",
                "socialsellercarreira",
                "sdrcarreira",
                "sdrconsultoria"
              ]
            },
            {
              "id": "4KzXBGYsXFd5TAV0FaBB",
              "name": "Last Appointment",
              "model": "contact",
              "fieldKey": "contact.last_appointment",
              "placeholder": "",
              "dataType": "TEXT",
              "position": 500,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-12-01T19:21:45.984Z",
              "standard": false
            },
            {
              "id": "5O5PGpw4s2uPmsgVm4dJ",
              "name": "Policy Status",
              "model": "contact",
              "fieldKey": "contact.policy_status",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 500,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.993Z",
              "standard": false,
              "picklistOptions": [
                "Inforce",
                "Declined",
                "Pending",
                "Not Active",
                "Lapsed",
                "Incomplete",
                "Issued"
              ]
            },
            {
              "id": "6oUZvpESKC6lYMBVFrkW",
              "name": "Objetivo do lead",
              "model": "contact",
              "fieldKey": "contact.objetivo_do_lead",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 800,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-12-02T15:03:03.918Z",
              "standard": false,
              "picklistOptions": [
                "x",
                "x"
              ]
            },
            {
              "id": "B74QtnVtKv26woBJOyWQ",
              "name": "Work Permit",
              "model": "contact",
              "fieldKey": "contact.work_permit",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 350,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.981Z",
              "standard": false,
              "picklistOptions": [
                "Sim",
                "Não"
              ]
            },
            {
              "id": "JWxa5EEbzAYyxSHwIR1M",
              "name": "Policy Information",
              "model": "contact",
              "fieldKey": "contact.policy_information",
              "placeholder": "Policy Information",
              "dataType": "TEXT",
              "position": 400,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.992Z",
              "standard": false
            },
            {
              "id": "KyCwTVHktt5YFB0vS80i",
              "name": "agente",
              "model": "contact",
              "fieldKey": "contact.agente",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 450,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-11-14T14:18:01.986Z",
              "standard": false,
              "picklistOptions": [
                "followuper",
                "socialsellerconsultoria",
                "socialsellercarreira",
                "sdrcarreira",
                "sdrconsultoria",
                "rescheduler",
                "engagementkeeper",
                "customersuccess",
                "closer"
              ]
            },
            {
              "id": "Lv7ZJRH3FB7qfXz2zc0F",
              "name": "Antecipated Annual Premium",
              "model": "contact",
              "fieldKey": "contact.antecipated_annual_premium",
              "placeholder": "Antecipated Annual Premium",
              "dataType": "MONETORY",
              "position": 600,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.995Z",
              "standard": false
            },
            {
              "id": "Qs5Y7yd0BAnL1rWYukm3",
              "name": "Informações para AI",
              "model": "contact",
              "fieldKey": "contact.informaes_para_ai",
              "placeholder": "",
              "dataType": "LARGE_TEXT",
              "position": 350,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-19T13:49:13.762Z",
              "standard": false
            },
            {
              "id": "QscDNHLfaghT6tgXEPF8",
              "name": "Estado onde mora",
              "model": "contact",
              "fieldKey": "contact.estado_onde_mora",
              "placeholder": "Estado onde mora",
              "dataType": "TEXT",
              "position": 400,
              "documentType": "field",
              "parentId": "jF2vkd3e098P7H4g0yfF",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:37.999Z",
              "standard": false
            },
            {
              "id": "RJ0wpy85jYkSxuhJ5n3W",
              "name": "Policy Issue Date",
              "model": "contact",
              "fieldKey": "contact.policy_issue_date",
              "placeholder": "",
              "dataType": "DATE",
              "position": 550,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-21T18:23:38.003Z",
              "standard": false
            },
            {
              "id": "TpoUKxaDLu5KH3ZkoTs7",
              "name": "ativar_ia",
              "model": "contact",
              "fieldKey": "contact.ativar_ia",
              "placeholder": "",
              "dataType": "SINGLE_OPTIONS",
              "position": 850,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-12-02T15:23:57.847Z",
              "standard": false,
              "picklistOptions": [
                "x",
                "x"
              ]
            },
            {
              "id": "b1a8GRh6TphG03Xuxqzx",
              "name": "Resposta IA",
              "model": "contact",
              "fieldKey": "contact.resposta_ia",
              "placeholder": "",
              "dataType": "LARGE_TEXT",
              "position": 150,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-19T13:49:13.767Z",
              "standard": false
            },
            {
              "id": "fDcrMyGupF6DD3PvPQdW",
              "name": "FUP_counter",
              "model": "contact",
              "fieldKey": "contact.fup_counter",
              "placeholder": "",
              "dataType": "NUMERICAL",
              "position": 250,
              "documentType": "field",
              "parentId": "2Qo8AjI5igaCtBrIlva5",
              "locationId": "mHuN6v75KQc3lwmBd6mV",
              "dateAdded": "2025-08-19T13:49:13.770Z",
              "standard": false
            }
          ],
          "traceId": "380349f6-708d-4d51-a7f9-c73d6c61545b"
        }
      }
    ],
    "Mensagem recebida": [
      {
        "json": {
          "headers": {
            "host": "cliente-a1.mentorfy.io",
            "user-agent": "axios/1.13.2",
            "content-length": "3281",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "traceparent": "00-a1af2493bdd61b2c5e6178843be26db0-67c008de3a40235b-01",
            "x-forwarded-for": "34.59.37.253",
            "x-forwarded-host": "cliente-a1.mentorfy.io",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "70aa73aa9a4a",
            "x-real-ip": "34.59.37.253"
          },
          "params": {},
          "query": {},
          "body": {
            "Informações para AI": "",
            "Procurou ajuda medica": "",
            "FUP_counter [socialfy]": "",
            "Permitir chamadas WhatsApp": "",
            "consultorio SP": "",
            "Especialista Motive": "sdr_inbound",
            "acredita em alteração hormonal": "",
            "Last Appointment": "",
            "Tratamento padrao ou personalizado": "",
            "FUP_counter": "",
            "Resposta IA": "Que ótimo! Então, você consegue ver os horários disponíveis pra mim? Queria marcar logo. E meu nome é Luciana, viu? 😉",
            "Sintomas atualmente": "",
            "ativar_ia": "sim",
            "ID cliente - Asaas": "",
            "Status cobrança - Asaas": "",
            "Interessado em investir": "",
            "Objetivo do lead": "",
            "Mudança no corpo": "",
            "Informações para IA |socialfy|": "",
            "Preferência Áudio/Texto": "",
            "Profissão": "",
            "Tipo de consulta": "",
            "Tipo de Lead": "",
            "Resposta IA |socialfy|": "",
            "Estado onde mora": "",
            "Status Appointment": "",
            "ID cobrança - Asaas": "",
            "contact_id": "UTDqkPmaLZbJuQ0nWOsu",
            "first_name": "Marcos",
            "last_name": "Daniel • High-Ticket Sales Architect",
            "full_name": "Marcos Daniel • High-Ticket Sales Architect",
            "tags": "teste",
            "country": "BR",
            "date_created": "2025-11-29T00:43:28.777Z",
            "full_address": "",
            "contact_type": "lead",
            "location": {
              "name": "Dra. Gabriela Rossmam",
              "address": "Avenida das Embaubas",
              "city": "Sinop",
              "state": "Mato Grosso",
              "country": "BR",
              "postalCode": "1867",
              "fullAddress": "Avenida das Embaubas, Sinop Mato Grosso 1867",
              "id": "xliub5H5pQ4QcDeKHc6F"
            },
            "user": {
              "firstName": "Gabriela",
              "lastName": "Rossmam",
              "email": "dra.gabrielarossmam@gmail.com",
              "phone": "+556978550222"
            },
            "message": {
              "type": 18,
              "body": "Que ótimo! Então, você consegue ver os horários disponíveis pra mim? Queria marcar logo. E meu nome é Luciana, viu? 😉"
            },
            "workflow": {
              "id": "b7b35cae-6112-4ea5-8065-6125d55e9242",
              "name": "3. AI Chat N8N - Terceiros1"
            },
            "triggerData": {},
            "contact": {
              "attributionSource": {
                "photoUrl": null,
                "sessionSource": "Social media",
                "adId": null,
                "productId": null,
                "videoUrl": null,
                "igSid": "2758982224441410",
                "mediumId": "2758982224441410",
                "utmContent": null,
                "medium": "instagram",
                "postId": null,
                "flowId": null
              },
              "lastAttributionSource": {
                "photoUrl": null,
                "sessionSource": "Social media",
                "adId": null,
                "productId": null,
                "videoUrl": null,
                "igSid": "2758982224441410",
                "mediumId": "2758982224441410",
                "utmContent": null,
                "medium": "instagram",
                "postId": null,
                "flowId": null
              }
            },
            "attributionSource": {},
            "customData": {
              "ID": "UTDqkPmaLZbJuQ0nWOsu",
              "message": "Que ótimo! Então, você consegue ver os horários disponíveis pra mim? Queria marcar logo. E meu nome é Luciana, viu? 😉",
              "name": "Marcos",
              "phone": "",
              "tipo": "msg",
              "ghl_api_key": "pit-4a40b7de-e2e0-4090-891f-ea101e80b7c0",
              "preco": "",
              "tempo": "",
              "regiao": "",
              "info": "",
              "timezone": "America/Sao_Paulo",
              "consultoria_financeira": "",
              "oportunidade": "",
              "subject": "",
              "source.url": "",
              "minha_historias": "",
              "campaingn": "",
              "utm_campaign": "",
              "link_do_zoom": "",
              "photo": "",
              "pipeline_stage": "",
              "tipo_de_mensagem": "18",
              "photo_audio_nativo": "",
              "photo_audio": "",
              "fonte_do_lead_bposs": "",
              "quebra_de_objecoes_carreira": "",
              "quebra_de_objecoes_consultoria": "",
              "quebra_de_objecoes_geral": "",
              "sobre_o_produto": "",
              "estruturas_work_permit": "",
              "work_permit": "",
              "state": "",
              "etapa_funil": "",
              "agente_ia": "sdr_inbound",
              "objetivodolead": "",
              "ativar_ia": "sim",
              "agente_versionado": "agente_versionado",
              "agenda consultorio sao paulo": "",
              "agenda presidente prudente": "",
              "agenda online": "",
              "source_medium": "instagram"
            }
          },
          "webhookUrl": "https://cliente-a1.mentorfy.io/webhook/69c114dc-86c4-4ed0-98d4-ed5debb98b58",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Mensagem recebida": {
      "main": [
        [
          {
            "node": "FUU - Cancelar Follow-ups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInfo": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - alan",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adicionar_tag_perdido": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Gemini2": {
      "ai_languageModel": [
        [
          {
            "node": "SDR1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "SDR1",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Busca_disponibilidade": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agendar_reuniao": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Profissão": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Estado": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem encavalada?": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens": {
      "main": [
        [
          {
            "node": "Form Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens": {
      "main": [
        [
          {
            "node": "Unificador de Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar": {
      "main": [
        [
          {
            "node": "Buscar mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.": {
      "main": [
        [
          {
            "node": "Esperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Form Mensagem": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Permitido AI?": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa Ativa": {
      "main": [
        [
          {
            "node": "Ação Planejada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ação Planejada": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Salvar Espera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Espera": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Salvar Inicio IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens": {
      "main": [
        [
          {
            "node": "SI - Insert Lead Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set mensagens3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria Lead": {
      "main": [
        [
          {
            "node": "Deduplica Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplica Mensagens": {
      "main": [
        [
          {
            "node": "Set mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem anteriores": {
      "main": [
        [
          {
            "node": "Preparar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Contact": {
      "main": [
        [
          {
            "node": "GetInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "historico_mensagens_leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Inicio IA": {
      "main": [
        [
          {
            "node": "Mensagem anteriores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensagem": {
      "main": [
        [
          {
            "node": "Memoria Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens1": {
      "main": [
        [
          {
            "node": "Canal2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal2": {
      "main": [
        [
          {
            "node": "Whatsapp2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Limpar memória",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. Buscar Conversa do Contato": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)": {
      "main": [
        [
          {
            "node": "Resetar status atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ativar_ia2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1️⃣ Listar campos customizados": {
      "main": [
        [
          {
            "node": "2️⃣ Extrair IDs dos campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2️⃣ Extrair IDs dos campos": {
      "main": [
        [
          {
            "node": "3️⃣ Detectar Objetivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3️⃣ Detectar Objetivo": {
      "main": [
        [
          {
            "node": "4️⃣ Switch Objetivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4️⃣ Switch Objetivo": {
      "main": [
        [
          {
            "node": "5️⃣ Atualizar → Carreira",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "5️⃣ Atualizar → Consultoria",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal4": {
      "main": [
        [
          {
            "node": "5️⃣ Perguntar Objetivo (SMS)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resetar status atendimento": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificar Tipo Mensagem": {
      "main": [
        [
          {
            "node": "Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "SI - Upsert Conversation",
            "type": "main",
            "index": 0
          },
          {
            "node": "IA Ativa?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Classificar Tipo Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data5": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Dados1": {
      "main": [
        [
          {
            "node": "Execution Data5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Nome1": {
      "main": [
        [
          {
            "node": "Normalizar Dados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contexto UTM": {
      "main": [
        [
          {
            "node": "Normalizar Nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA Ativa?": {
      "main": [
        [
          {
            "node": "Tipo de mensagem2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tudo certo?4": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SDR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alterar preferencia audio texto": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Escalar humano": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Refletir": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Listar arquivos": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar agendamento": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Enviar arquivo": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar ou buscar cobranca": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "SDR1": {
      "main": [
        [
          {
            "node": "Tudo certo?4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens2": {
      "main": [
        [
          {
            "node": "Buscar Agente Ativo2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Agente Ativo2": {
      "main": [
        [
          {
            "node": "Preparar Execução + Identificar Contexto3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Calendários1": {
      "main": [
        [
          {
            "node": "Montar Prompts Finais1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Execução + Identificar Contexto3": {
      "main": [
        [
          {
            "node": "Formatar Calendários1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Prompts Finais1": {
      "main": [
        [
          {
            "node": "SDR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Estimativa de tokens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [
          {
            "node": "Memoria IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "no.op": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal": {
      "main": [
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.5s": {
      "main": [
        [
          {
            "node": "no.op",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data1": {
      "main": [
        [
          {
            "node": "Calcular Custo LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem1": {
      "main": [
        [
          {
            "node": "Conversa ativa atualizada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Parser Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Deve enviar mensagem?": {
      "main": [
        [
          {
            "node": "Parser Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa ativa atualizada": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Atualizar resposta IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Termino de resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Termino de resposta": {
      "main": [
        [
          {
            "node": "Parser Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar resposta IA": {
      "main": [
        [
          {
            "node": "Deve enviar mensagem?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Segmentos1": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Execution Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Parser Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data2": {
      "main": [
        [
          {
            "node": "Segmentos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria IA": {
      "main": [
        [
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          },
          {
            "node": "SI - Insert AI Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "historico_mensagens_leads1",
            "type": "main",
            "index": 0
          },
          {
            "node": "FUU - Agendar Follow-up",
            "type": "main",
            "index": 0
          },
          {
            "node": "Finish Metrics",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Custo LLM": {
      "main": [
        [
          {
            "node": "Call Track AI Cost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Chain": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estimativa de tokens": {
      "main": [
        [
          {
            "node": "Tipo de mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FUU - Cancelar Follow-ups": {
      "main": [
        [
          {
            "node": "FUU - Executar Cancelamento",
            "type": "main",
            "index": 0
          },
          {
            "node": "Contexto UTM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download áudio": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Extrair a extensão",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever audio": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Transcrever audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair a extensão": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Comprovante1": {
      "main": [
        [
          {
            "node": "Extract from File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File2": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "csv",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "csv": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pdf": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Fatura CSV": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisar Comprovante Claude1": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Contact (Outbound)5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "1. Buscar Conversa do Contato",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Enfileirar mensagem.",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analisar Comprovante Claude1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download áudio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Comprovante1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Comprovante1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem ou audio": {
      "main": [
        [
          {
            "node": "Unificador de Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unificador de Mensagens": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)5": {
      "main": [
        [
          {
            "node": "Canal3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp4": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal3": {
      "main": [
        [
          {
            "node": "Whatsapp4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram3": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)7": {
      "main": [
        [
          {
            "node": "Canal5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal5": {
      "main": [
        [
          {
            "node": "Whatsapp5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar comprovante de pagamento": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calcular tipo da resposta": {
      "main": [
        []
      ]
    },
    "Set mensagens3": {
      "main": [
        [
          {
            "node": "Buscar Agente Ativo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Agente Ativo": {
      "main": [
        [
          {
            "node": "Preparar Execução + Identificar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Calendários": {
      "main": [
        [
          {
            "node": "Montar Prompts Finais",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Execução + Identificar Contexto": {
      "main": [
        [
          {
            "node": "Formatar Calendários",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Prompts Finais": {
      "main": [
        [
          {
            "node": "SDR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match Lead Context": {
      "main": [
        [
          {
            "node": "Lead Prospectado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Prospectado?": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Prospectado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Auto Enrich Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto Enrich Lead": {
      "main": [
        [
          {
            "node": "Classificar Lead IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificar Lead IA": {
      "main": [
        [
          {
            "node": "Rotear por Classificação",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rotear por Classificação": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Classificado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisar Contexto Conversa": {
      "main": [
        [
          {
            "node": "Decisão de Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decisão de Contexto": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Classificado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Já Ativou IA? (Prospectado)": {
      "main": [
        [
          {
            "node": "GHL - Tag Prospectado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Já Ativou IA? (Classificado)": {
      "main": [
        [
          {
            "node": "GHL - Tag Classificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veio de Tráfego?": {
      "main": [
        [
          {
            "node": "Analisar Contexto Conversa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Match Lead Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "É Primeira Mensagem?": {
      "main": [
        [
          {
            "node": "Detectar Origem (BDR ou Seguidor)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analisar Contexto Conversa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar Origem (BDR ou Seguidor)": {
      "main": [
        [
          {
            "node": "Origem da Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Origem da Conversa": {
      "main": [
        [
          {
            "node": "Contexto: BDR Abordou",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Contexto: Novo Seguidor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contexto: BDR Abordou": {
      "main": [
        [
          {
            "node": "Veio de Tráfego?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contexto: Novo Seguidor": {
      "main": [
        [
          {
            "node": "Veio de Tráfego?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisar Contexto Conversa1": {
      "main": [
        [
          {
            "node": "Decisão de Contexto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decisão de Contexto1": {
      "main": [
        [
          {
            "node": "Já Ativou IA? (Classificado)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GHL - Mover Perdido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        []
      ]
    },
    "Atualizar_nome": {
      "ai_tool": [
        [
          {
            "node": "SDR1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/New_York",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true,
    "errorWorkflow": "WnRF9AdjFBkEW9Ma",
    "timeSavedMode": "fixed"
  },
  "versionId": "f97166a7-31b4-4fd8-954d-3ceb3b2472a9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "HXWGWQFBY4KVfY64",
  "tags": [
    {
      "updatedAt": "2025-06-20T13:58:36.168Z",
      "createdAt": "2025-06-20T13:58:36.168Z",
      "id": "kEruuvE7z6URbdVG",
      "name": "Marcos-Daniel"
    }
  ]
}
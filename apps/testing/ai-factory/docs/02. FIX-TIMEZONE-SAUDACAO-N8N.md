# FIX: Timezone da Sauda√ß√£o no N8N

**Data:** 2026-01-25
**Agente:** Isabella Amare v7.0.8
**Location:** sNwLyynZWP6jEtBy1ubf (Instituto Amar)
**Severidade:** M√âDIA (afeta UX, n√£o bloqueia venda)

---

## Problema Detectado

O agente est√° enviando "Boa noite" √†s 15:28 (hor√°rio de Bras√≠lia).

**Causa raiz:** O c√≥digo `new Date().getHours()` pega o hor√°rio UTC do servidor n8n, n√£o o hor√°rio local (BRT = UTC-3).

| Hor√°rio Real (BRT) | Servidor (UTC) | `getHours()` | Sauda√ß√£o |
|--------------------|----------------|--------------|----------|
| 15:28 | 18:28 | 18 | ‚ùå "boa noite" |
| 17:59 | 20:59 | 20 | ‚ùå "boa noite" |
| 06:00 | 09:00 | 9 | ‚úÖ "bom dia" |
| 12:00 | 15:00 | 15 | ‚úÖ "boa tarde" |

---

## üö® LOCAIS QUE PRECISAM CORRIGIR (3 nodes)

### 1. Node "Info" - Campos de express√£o
### 2. Node "Preparar Execu√ß√£o + Identificar Contexto" - Fun√ß√£o getPeriodoHorario()
### 3. Node "Preparar Execu√ß√£o + Identificar Contexto" - Campo hora_numero

---

## ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
## CORRE√á√ÉO 1: Node "Info"
## ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Localizar os campos `saudacao` e `hora_atual` e substituir:

### ‚ùå BUGADO (campo saudacao)
```
={{ (() => { const h = new Date().getHours(); if (h < 12) return 'Bom dia'; if (h < 18) return 'Boa tarde'; return 'Boa noite'; })() }}
```

### ‚úÖ CORRIGIDO (campo saudacao)
```
={{ (() => { const d = new Date(); const h = new Date(d.toLocaleString('en-US', {timeZone: 'America/Sao_Paulo'})).getHours(); if (h >= 6 && h < 12) return 'Bom dia'; if (h >= 12 && h < 18) return 'Boa tarde'; return 'Boa noite'; })() }}
```

### ‚ùå BUGADO (campo hora_atual)
```
={{ new Date().getHours() }}
```

### ‚úÖ CORRIGIDO (campo hora_atual)
```
={{ new Date(new Date().toLocaleString('en-US', {timeZone: 'America/Sao_Paulo'})).getHours() }}
```

---

## ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
## CORRE√á√ÉO 2: Node "Preparar Execu√ß√£o + Identificar Contexto"
## ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### ‚ùå FUN√á√ÉO BUGADA (getPeriodoHorario)
```javascript
function getPeriodoHorario() {
  const agora = new Date();
  const hora = agora.getHours();  // ‚Üê UTC!

  if (hora >= 5 && hora < 12) return 'manha';
  if (hora >= 12 && hora < 18) return 'tarde';
  return 'noite';
}
```

### ‚úÖ FUN√á√ÉO CORRIGIDA (getPeriodoHorario)
```javascript
function getPeriodoHorario() {
  // Converter para hor√°rio de Bras√≠lia
  const agora = new Date();
  const agoraBRT = new Date(agora.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
  const hora = agoraBRT.getHours();

  if (hora >= 5 && hora < 12) return 'manha';
  if (hora >= 12 && hora < 18) return 'tarde';
  return 'noite';
}
```

### ‚ùå BUGADO (hora_numero no output)
```javascript
hora_numero: agora.getHours(),
```

### ‚úÖ CORRIGIDO (hora_numero no output)
```javascript
// Adicionar no in√≠cio do c√≥digo:
const agoraBRT = new Date(agora.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));

// Depois usar:
hora_numero: agoraBRT.getHours(),
```

---

## ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
## CORRE√á√ÉO 3: Node "Montar Prompts Finais" (se usar hora do prev)
## ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Este node recebe `prev.hora_numero` - se o node anterior for corrigido, este j√° funcionar√°.
Mas a regra de sauda√ß√£o tamb√©m usa a hora, ent√£o confirme que est√° pegando do prev corretamente.

---

## C√≥digo Bugado Original (REFER√äNCIA)

```javascript
// ‚ùå C√ìDIGO ATUAL - BUGADO
// Data/hora atual
const agora = new Date();
const periodos = {
  0: 'domingo', 1: 'segunda', 2: 'terca', 3: 'quarta',
  4: 'quinta', 5: 'sexta', 6: 'sabado'
};
const diaSemana = periodos[agora.getDay()];
const dataFormatada = agora.toLocaleDateString('pt-BR', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit'
});

// Saudacao por periodo
const hora = agora.getHours();
let saudacao = 'boa noite';
if (hora >= 6 && hora < 12) saudacao = 'bom dia';
else if (hora >= 12 && hora < 18) saudacao = 'boa tarde';
```

---

## C√≥digo Corrigido (USAR)

```javascript
// ‚úÖ C√ìDIGO CORRIGIDO - COM TIMEZONE BRT
// Luxon j√° vem instalado no n8n
const { DateTime } = require('luxon');

// Data/hora em Bras√≠lia (America/Sao_Paulo)
const agoraBRT = DateTime.now().setZone('America/Sao_Paulo');

// Dia da semana
const periodos = {
  1: 'segunda', 2: 'terca', 3: 'quarta',
  4: 'quinta', 5: 'sexta', 6: 'sabado', 7: 'domingo'
};
const diaSemana = periodos[agoraBRT.weekday];

// Data formatada em portugu√™s
const dataFormatada = agoraBRT.toFormat(
  "EEEE, d 'de' MMMM 'de' yyyy '√†s' HH:mm",
  { locale: 'pt-BR' }
);

// Sauda√ß√£o por per√≠odo (agora com hor√°rio correto!)
const hora = agoraBRT.hour;
let saudacao = 'boa noite';
if (hora >= 6 && hora < 12) saudacao = 'bom dia';
else if (hora >= 12 && hora < 18) saudacao = 'boa tarde';

// Log para debug (remover depois de validar)
console.log(`[DEBUG] Hora BRT: ${hora}, Sauda√ß√£o: ${saudacao}`);
```

---

## C√≥digo Completo do Node (copiar e colar)

```javascript
// ==============================================
// NODE: Montar Prompts Finais (Isabella Amare)
// VERS√ÉO: Corrigido com Timezone BRT
// DATA: 2026-01-25
// ==============================================

const { DateTime } = require('luxon');

// Dados do webhook
const webhookData = $input.first().json;
const agentVersion = $input.last().json;

// Dados do lead
const leadName = webhookData.lead_name || 'Visitante';
const leadPhone = webhookData.lead_phone || '';
const ddd = leadPhone ? leadPhone.replace(/\D/g, '').substring(0, 2) : '11';
const canal = webhookData.canal || 'whatsapp';
const mensagem = webhookData.message || '';

// ========== CORRE√á√ÉO TIMEZONE ==========
const agoraBRT = DateTime.now().setZone('America/Sao_Paulo');

const periodos = {
  1: 'segunda', 2: 'terca', 3: 'quarta',
  4: 'quinta', 5: 'sexta', 6: 'sabado', 7: 'domingo'
};
const diaSemana = periodos[agoraBRT.weekday];

const dataFormatada = agoraBRT.toFormat(
  "EEEE, d 'de' MMMM 'de' yyyy '√†s' HH:mm",
  { locale: 'pt-BR' }
);

// Sauda√ß√£o CORRIGIDA
const hora = agoraBRT.hour;
let saudacao = 'boa noite';
if (hora >= 6 && hora < 12) saudacao = 'bom dia';
else if (hora >= 12 && hora < 18) saudacao = 'boa tarde';
// ========================================

// Hist√≥rico de conversa (se existir)
const historico = webhookData.conversation_history || [];
const temHistorico = historico.length > 0;

// Respostas do formul√°rio de tr√°fego (se existir)
const formTrafego = webhookData.form_responses || null;

// Monta blocos XML
const blocos = {
  contexto_conversa: `<contexto_conversa>
LEAD: ${leadName}
CANAL: ${canal}
DDD: ${ddd}
DATA/HORA: ${dataFormatada}
ETIQUETAS: ${webhookData.tags || 'nova_conversa'}
STATUS PAGAMENTO: ${webhookData.payment_status || 'nenhum'}
MODO ATIVO: sdr_inbound
</contexto_conversa>`,

  hiperpersonalizacao: `<hiperpersonalizacao>
[REGIAO ${ddd}] ${getRegiaoPorDDD(ddd)}
Saudacao recomendada: "${capitalize(saudacao)}"
</hiperpersonalizacao>`,

  calendarios_disponiveis: `<calendarios_disponiveis>
- Consultorio Sao Paulo (Indianopolis): ID wMuTRRn8duz58kETKTWE
- Unidade Presidente Prudente: ID NwM2y9lck8uBAlIqr0Qi
- Consulta Online (Telemedicina): ID ZXlOuF79r6rDb0ZRi5zw

Horarios: Segunda a Sexta, 9h-18h | Sabado 8h-12h
Duracao consulta: 1h30
Antecedencia minima: 15-20 dias (tempo para exames)
</calendarios_disponiveis>`,

  mensagem_atual: `<mensagem_atual>
LEAD: ${mensagem}
</mensagem_atual>`
};

// Adiciona formul√°rio de tr√°fego se existir
if (formTrafego) {
  blocos.respostas_formulario_trafego = `<respostas_formulario_trafego>
VEIO POR CAMPANHA: ${formTrafego.campaign || 'organico'}
PROCUROU AJUDA ANTES: ${formTrafego.tried_before || 'nao informado'}
SINTOMAS ATUAIS: ${formTrafego.symptoms || 'nao informado'}
MUDANCA NO CORPO: ${formTrafego.body_changes || 'nao informado'}
PREFERENCIA CONSULTA: ${formTrafego.preference || 'presencial'}
PRONTO PRA INVESTIR: ${formTrafego.ready_to_invest || 'nao informado'}
</respostas_formulario_trafego>`;
}

// Adiciona hist√≥rico se existir
if (temHistorico) {
  const historicoFormatado = historico.map(msg =>
    `${msg.role === 'lead' ? 'LEAD' : 'ISABELLA'}: ${msg.content}`
  ).join('\n');
  blocos.historico_conversa = `<historico_conversa>
${historicoFormatado}
</historico_conversa>`;
}

// System prompt do agente
const systemPrompt = agentVersion.system_prompt || '';

// User prompt completo (blocos XML + mensagem)
const userPrompt = Object.values(blocos).join('\n\n');

// Fun√ß√µes auxiliares
function getRegiaoPorDDD(ddd) {
  const regioes = {
    '11': 'S√£o Paulo capital',
    '12': 'Vale do Para√≠ba/Litoral Norte SP',
    '13': 'Baixada Santista SP',
    '14': 'Bauru/Mar√≠lia SP',
    '15': 'Sorocaba SP',
    '16': 'Ribeir√£o Preto SP',
    '17': 'S√£o Jos√© do Rio Preto SP',
    '18': 'Presidente Prudente SP',
    '19': 'Campinas SP',
    '21': 'Rio de Janeiro capital',
    '31': 'Belo Horizonte MG',
    '41': 'Curitiba PR',
    '51': 'Porto Alegre RS',
    '61': 'Bras√≠lia DF',
    '71': 'Salvador BA',
    '81': 'Recife PE',
    '85': 'Fortaleza CE'
  };
  return regioes[ddd] || `Regi√£o DDD ${ddd}`;
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

return {
  json: {
    lead_name: leadName,
    lead_phone: leadPhone,
    tem_historico: temHistorico,
    saudacao: saudacao,
    hora_brt: hora,
    system_prompt: systemPrompt,
    user_prompt: userPrompt,
    mensagem_atual: mensagem,
    debug_timezone: {
      utc: DateTime.now().toISO(),
      brt: agoraBRT.toISO(),
      hora_calculada: hora,
      saudacao_gerada: saudacao
    }
  }
};
```

---

## Checklist de Aplica√ß√£o

- [ ] Abrir o workflow da Isabella no n8n
- [ ] Localizar o node "Montar Prompts Finais" (ou equivalente)
- [ ] Fazer backup do c√≥digo atual (copiar para um arquivo)
- [ ] Substituir pelo c√≥digo corrigido acima
- [ ] Salvar o workflow
- [ ] Testar com uma mensagem de teste
- [ ] Verificar no output se `debug_timezone` mostra hora correta
- [ ] Remover o campo `debug_timezone` ap√≥s validar

---

## Teste de Valida√ß√£o

Ap√≥s aplicar, envie uma mensagem de teste e verifique:

```json
{
  "debug_timezone": {
    "utc": "2026-01-25T18:30:00.000Z",
    "brt": "2026-01-25T15:30:00.000-03:00",
    "hora_calculada": 15,
    "saudacao_gerada": "boa tarde"
  }
}
```

Se `hora_calculada` bater com o hor√°rio real de Bras√≠lia, o fix funcionou.

---

## Workflows Afetados

Este mesmo bug pode estar em outros workflows. Verificar:

| Workflow | Agente | Status |
|----------|--------|--------|
| Instituto Amar (Isabella) | Isabella Amare v7.0.8 | ‚ö†Ô∏è CORRIGIR |
| Dr. Thauan Social Seller | Dr. Thauan | ‚ö†Ô∏è VERIFICAR |
| Dra. Heloise | Dra. Heloise | ‚ö†Ô∏è VERIFICAR |

---

## Bug #2: Mensagem Duplicada

Al√©m do timezone, foi detectado que mensagens est√£o sendo enviadas em duplicata (ex: Kelcione Reis recebeu 2 aberturas).

**Poss√≠vel causa:** Race condition no trigger ou falta de debounce.

**Solu√ß√£o sugerida:** Adicionar um node de verifica√ß√£o antes de enviar:

```javascript
// No in√≠cio do workflow, verificar se j√° enviou nos √∫ltimos 60s
const lastMessageTime = $input.first().json.last_outbound_timestamp;
const now = Date.now();
const diffSeconds = (now - lastMessageTime) / 1000;

if (diffSeconds < 60) {
  // J√° enviou recentemente, abortar
  return { json: { abort: true, reason: 'debounce' } };
}
```

---

**Criado por:** Claude (assistente MOTTIVME)
**Solicitado por:** Marcos Daniels

# CONTEXTO: Correção de Location IDs - AI Factory

**Data:** 2026-01-24
**Projeto:** ai-factory
**Supabase:** bfumywvwubvernvhjehk

---

## PROBLEMA ORIGINAL

Leads no `n8n_schedule_tracking` e `n8n_historico_mensagens` estavam com `location_id` e `api_key` incorretos ou NULL, causando:
1. Erro 403 "Token does not have access to this location"
2. Follow-ups sendo enviados com prompt/agente ERRADO (ex: lead do Dr. Luiz recebendo mensagem sobre "work permit")

---

## CLIENTES E API KEYS (ATUALIZADAS)

| Cliente | location_id | api_key |
|---------|-------------|---------|
| Marina Couto | Bgi2hFMgiLLoRlOO0K5b | pit-f92a415e-87a9-45aa-b2b0-d47fce026ecf |
| Dr. Luiz Augusto | sNwLyynZWP6jEtBy1ubf | pit-dc0e9761-0077-4c82-9cf5-48345d87f034 |
| Lappe Finances | EKHxHl3KLPN0iRc69GNU | pit-3d61b334-690f-46ad-a6be-54c5efce1f46 |
| LEGACY AGENCY | mHuN6v75KQc3lwmBd6mV | pit-7c7798aa-5126-4b5e-b769-87e97143c9ce |
| Dr Thauan | Rre0WqSlmAPmIrURgiMf | pit-2390204a-2531-40fc-a5d4-61b007cad077 |
| Dra Heloise | uSwkCg4V1rfpvk4tG6zP | pit-308cc405-be65-41e1-bb3b-18f75cb01f99 |
| Dra. Gabriela Rossmam | xliub5H5pQ4QcDeKHc6F | pit-4a40b7de-e2e0-4090-891f-ea101e80b7c0 |
| André Rosa | uEh9LDrdLpKH1oruwxZ4 | pit-72617198-b4f9-4ea4-a7bf-59ca048f39a1 |
| Alberto Correia | GT77iGk2WDneoHwtuq6D | pit-59d1e2ca-955e-448c-85fd-b01a92387296 |
| Mottivme Sales | cd1uyzpJox6XPt4Vct8Y | pit-1513fb68-1b2e-44fc-ab4a-ad4d188b603b |
| OrthoDontic | 8alvkjNUjddhuYBS1cc2 | pit-e09bd2ef-157d-4d19-b080-9ae5882308f4 |
| Social Business | XNjmi1DpvqoF09y1mip9 | pit-e23cc17d-d22f-46eb-a552-24378d60ded8 |

---

## KEYWORDS PARA IDENTIFICAÇÃO DE LOCATION

```
Marina Couto / Lappe Finances / LEGACY AGENCY (mesmo grupo):
- "work permit", "EUA", "carreira", "Marina", "Fernanda"
- "green card", "visto", "imigração", "consultora financeira"
- "Massachusetts", "Florida", "Califórnia", "NY"

Dr. Luiz Augusto:
- "Dr. Luiz", "Instituto Amare", "Isabella"
- "insônia", "bioimpedância", "consulta", "protocolo"
- "saúde", "tratamento", "sintomas", "paciente"

OrthoDontic:
- "dente", "ortodontia", "aparelho", "sorriso"
```

---

## O QUE FOI FEITO

### 1. Correções de API Keys
- Atualizada API key da Marina: `pit-f92a415e-87a9-45aa-b2b0-d47fce026ecf`
- Corrigidas API keys antigas/inválidas

### 2. Correções de Location ID
- 332 sessões da Marina que estavam com location_id do Dr. Luiz foram corrigidas
- Tabelas afetadas: `n8n_historico_mensagens` e `n8n_schedule_tracking`

### 3. Desativação de Leads Órfãos
- 2.143 registros sem `location_id` foram desativados (`ativo = false`)
- Dados NÃO foram deletados, apenas desativados

---

## SITUAÇÃO ATUAL

| Métrica | Valor |
|---------|-------|
| Leads ATIVOS | 74 |
| Leads DESATIVADOS com location_id | 3.310 |
| Leads DESATIVADOS sem location_id | ~11.671 |
| Total desativados | ~14.981 |

### Leads Ativos por Location:
- Dr. Luiz Augusto: 38
- Marina Couto: 20
- Lappe Finances: 11
- LEGACY AGENCY: 4
- Mottivme Sales: 1

---

## PENDÊNCIAS

### 1. Reativar Leads com Location ID
```sql
-- 3.310 leads podem ser reativados
UPDATE n8n_schedule_tracking
SET ativo = true
WHERE ativo = false
  AND location_id IS NOT NULL;
```

### 2. Identificar Location dos Leads sem Location ID
Criar script que:
1. Busca primeira mensagem de cada sessão desativada
2. Identifica keywords no conteúdo
3. Atribui location_id baseado nas keywords
4. Atualiza `n8n_schedule_tracking` e `n8n_historico_mensagens`

### 3. Corrigir Bug no Workflow de Follow-up
8 sessões do Dr. Luiz receberam follow-ups errados (sobre "work permit").
Investigar workflow n8n para identificar por que está usando prompt errado.

---

## TABELAS ENVOLVIDAS

### n8n_schedule_tracking
- Controla quais leads estão ativos para follow-up
- Campos: unique_id, location_id, api_key, ativo, source, follow_up_count

### n8n_historico_mensagens
- Histórico de mensagens por sessão
- Campos: session_id, message (JSONB), location_id

### ghl_locations
- Cadastro de locations e API keys
- Fonte de verdade para API keys

---

## COMANDOS ÚTEIS

### Testar API Key
```bash
curl -s "https://services.leadconnectorhq.com/contacts/?locationId={LOCATION_ID}&limit=1" \
  -H "Authorization: Bearer {API_KEY}" \
  -H "Version: 2021-07-28"
```

### Buscar Lead
```bash
curl -s "https://services.leadconnectorhq.com/contacts/{CONTACT_ID}" \
  -H "Authorization: Bearer {API_KEY}" \
  -H "Version: 2021-07-28"
```

### Query Supabase
```bash
SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmdW15d3Z3dWJ2ZXJudmhqZWhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MDM3OTksImV4cCI6MjA2Njk3OTc5OX0.60VyeZ8XaD6kz7Eh5Ov_nEeDtu5woMwMJYgUM-Sruao"

curl -s "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/{TABELA}?select=*" \
  -H "apikey: $SUPABASE_KEY" \
  -H "Authorization: Bearer $SUPABASE_KEY"
```

---

## PRÓXIMOS PASSOS SUGERIDOS

1. **Decisão:** Reativar os 3.310 leads com location_id?
2. **Script:** Criar identificador automático de location por keywords
3. **Workflow:** Investigar e corrigir bug de follow-up errado
4. **Monitoramento:** Criar alerta para novos leads sem location_id

{
  "name": "1. Agente Administrativo - Versionado - fase de teste vamos colocar audio nela",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "02b3c6bc-a525-45e5-9b1e-757dbef9e5d2",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1312,
        496
      ],
      "id": "466b660d-0393-4fd7-bdcd-df394dc87dfc",
      "name": "Mensagem recebida",
      "webhookId": "02b3c6bc-a525-45e5-9b1e-757dbef9e5d2"
    },
    {
      "parameters": {
        "content": "# Enviando resposta\nVamos verificar se nossa resposta deve ser enviada ou não caso o usuario tenha enviado alguma mensagem durante o pensamento da IA, significa que precisamos considerar a ultima mensagem antes de responder, e o processo seguinte ira receber nossa mensagem que iriamos mandar.",
        "height": 668,
        "width": 2236,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        6896,
        160
      ],
      "id": "5d7ea8c2-2c4e-4d67-a44e-ca4c710d59f4",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "# Tratando input\n",
        "height": 540,
        "width": 1060
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -336,
        224
      ],
      "id": "099748e8-12e7-405f-b4b1-c4ddf9bb5965",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## 1. Assistencia",
        "height": 80,
        "width": 540,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -336,
        80
      ],
      "id": "28e0d693-6993-4c01-a9a5-a5763ab0c0b0",
      "name": "Sticky Note30"
    },
    {
      "parameters": {
        "content": "## Rastreio de consumo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        944,
        -80
      ],
      "id": "da21dc33-07b0-4324-bde9-52b2118446ab",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "304623c3-1fc3-495e-867b-8710765f00fd",
              "leftValue": "={{ $json.output.length }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        8768,
        304
      ],
      "id": "e18b3406-d800-4207-80ae-a8bad4f8cd75",
      "name": "Filter"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "66bb063b-646e-4774-9415-e21a35c7e99b",
              "leftValue": "={{ $json.output }}",
              "rightValue": "<ctrl",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "50ac2eba-f7b0-4477-98e6-f19887142f51",
              "leftValue": "{{ $json.output }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8560,
        304
      ],
      "id": "6f0fae23-fca2-4b39-8c73-e1b16e01af50",
      "name": "Tudo certo?3"
    },
    {
      "parameters": {
        "jsCode": "// 1. Pega todas as mensagens disponíveis na fila\nconst todasMensagens = $('Buscar mensagens').all();\n\n// 2. CRÍTICO: Check de Fila Vazia (Race Condition)\n// Se a fila estiver vazia, significa que o workflow \"vencedor\" já acordou, \n// processou e limpou a fila enquanto este workflow estava esperando.\nif (!todasMensagens || todasMensagens.length === 0) {\n  return []; // Para o workflow imediatamente. Este workflow perdeu.\n}\n\n// 3. Ordenar as mensagens por timestamp (do mais recente para o mais antigo)\n// Adicionamos um desempate pelo ID da tabela caso dois timestamps sejam idênticos.\nconst filaOrdenada = todasMensagens.sort((a, b) => {\n  const tA = new Date(a.json.timestamp).getTime();\n  const tB = new Date(b.json.timestamp).getTime();\n  \n  // Se timestamps forem diferentes, ordena por tempo\n  if (tA !== tB) {\n    return tA - tB;\n  }\n  \n  // Se timestamps forem iguais (raro, mas possível), desempata pelo ID\n  return (a.json.id || 0) - (b.json.id || 0);\n});\n\n// 4. Identificar a mensagem \"Vencedora\" (a última da fila)\nconst mensagemVencedora = filaOrdenada[filaOrdenada.length - 1];\nconst idVencedor = mensagemVencedora.json.id_mensagem;\n\n// 5. Pegar o ID da mensagem que este workflow atual está processando\nconst idWorkflowAtual = $('Info').first().json.mensagem_id;\n\n// 6. Comparar: Eu sou o dono da última mensagem?\nif (idVencedor !== idWorkflowAtual) {\n  // NÃO sou o vencedor. A última mensagem pertence a outro workflow.\n  // Retorno array vazio para parar este fluxo imediatamente.\n  return []; \n}\n\n// 7. SIM, sou o vencedor!\n// Retorno TODA a fila ordenada para que a IA processe as mensagens agrupadas.\nreturn filaOrdenada;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        416
      ],
      "id": "6d4b4cb4-3b7b-4779-b891-b8a5b247f423",
      "name": "Mensagem encavalada?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2384,
        416
      ],
      "id": "d684ddbe-b499-41af-88d4-abe02a191059",
      "name": "Buscar mensagens",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3104,
        416
      ],
      "id": "168e9961-b96c-4b6d-b063-e42c801404b8",
      "name": "Limpar fila de mensagens",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "# Processando mensagens encavaladas\n\nEssa etapa trata a situação em que o usuário envia múltiplas mensagens seguidas. O ponto negativo é o aumento no tempo de resposta do agente. Lógica dispensa uso de soluções mais complexas, como RabbitMQ.\n\nTempo de espera recomendado de ~16s. Quando estiver testando, recomendamos reduzir um pouco para ficar mais rápido de testar.\n",
        "height": 540,
        "width": 1216,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        768,
        224
      ],
      "id": "c441e720-d9d0-4159-a403-854bacda4da5",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2144,
        416
      ],
      "id": "28ee8b33-4972-4476-919f-1b0c03d3054c",
      "name": "Esperar",
      "webhookId": "88f0b52d-116e-48ed-be83-e922183a1246"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_fila_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "mensagem": "={{ $json.mensagem }}",
            "id_mensagem": "={{ $json.mensagem_id }}",
            "timestamp": "={{ $json.datetime }}",
            "lead_id": "={{ $json.lead_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "instagram",
              "displayName": "instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1936,
        416
      ],
      "id": "d58b9e8c-76e0-49b9-89b1-1745e6f37049",
      "name": "Enfileirar mensagem.",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.photo_audio }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1696,
        592
      ],
      "id": "c6c88151-7524-4e33-a6ae-8855441b2e1b",
      "name": "Download áudio",
      "retryOnFail": true,
      "credentials": {
        "chatwootApi": {
          "id": "UmVE5jAScA8a8vNB",
          "name": "ChatWoot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1920,
        592
      ],
      "id": "6dc27bd5-3f87-4f66-84b0-b64f1b0dc3b1",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c3bb05a3-1c9e-4993-a20f-7d92b005cc09",
              "name": "last_db_message",
              "value": "={{ $input.last().json }}",
              "type": "string"
            },
            {
              "id": "80a47b08-9d11-4fa6-b5c0-c892bd503182",
              "name": "current_message",
              "value": "={{ $('Info').first().json.mensagem_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2624,
        416
      ],
      "id": "5df638da-5063-4c14-94d1-95b1dffd865c",
      "name": "Form Mensagem"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ca54eae-15d1-49d3-af33-7a6e5d17b833",
              "leftValue": "={{ $('Info').item.json.n8n_ativo }}",
              "rightValue": "disparo realizado",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "8d1933c9-21dc-4aeb-bce7-6b20411d2801",
              "leftValue": "={{ $('Tipo de mensagem').item.json.mensagem.toLowerCase() }}",
              "rightValue": "ok",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        3984,
        400
      ],
      "id": "f63a4344-32ca-4160-ab23-e155de284c6c",
      "name": "Permitido AI?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').item.json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3584,
        416
      ],
      "id": "8b211da0-6803-454a-b694-df8f50f20e88",
      "name": "Conversa Ativa",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isEmpty() || $json.status === 'inactive' || (new Date() - new Date($json.created_at)) > 1 * 60 * 1000  }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "be5f5420-f7d0-46e7-acb7-663377e7ff88"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Iniciar Conversa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "064c4e28-0fba-45da-8ad8-15c9678b7842",
                    "leftValue": "={{ $json.retries > 10 ||  $json.waiting_process_id && $json.status === 'active' && $json.waiting_process_id !== $('Info').item.json.process_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignorar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ccd478c2-5d5c-4e0d-a6ad-3727d8fb420e",
                    "leftValue": "={{ $json.status === 'active' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Aguardar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3744,
        416
      ],
      "id": "5b28b4fa-7111-4ed4-ba78-d121fb5d4b5f",
      "name": "Ação Planejada"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4192,
        576
      ],
      "id": "9ab2b60a-3f64-4163-a043-12a5f4df7e0a",
      "name": "Wait",
      "webhookId": "481f63df-2fe2-43c0-8bc5-44af1bd4f211"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "waiting_process_id": "={{ $('Info').item.json.process_id }}",
            "id": "={{ $('Conversa Ativa').item.json.id }}",
            "workflow_id": "={{ $json.workflow_id }}",
            "retries": "={{ $('Conversa Ativa').item.json.retries + 1 }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3984,
        576
      ],
      "id": "7adb4f74-bd21-421d-bb46-5699e2f66381",
      "name": "Salvar Espera",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "key": "a_lead_name",
              "value": "={{ $('Info').item.json.full_name }}"
            },
            {
              "key": "location_name",
              "value": "={{ $('Info').first().json.location_name }}"
            },
            {
              "key": "telefone",
              "value": "={{ $('Info').item.json.telefone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        4144,
        400
      ],
      "id": "6bd0b604-a6db-4f3e-aa13-fae60ab867f5",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fd3e8b9e-eed6-4f43-94c8-089af8417065",
              "name": "imagem",
              "value": "={{ $json.content?.[0]?.text ? \"[Imagem]: \" + $json.content[0].text : \"\" }}",
              "type": "string"
            },
            {
              "id": "a3bc628f-18b3-4e08-b620-65c5a3a57b40",
              "name": "audio:",
              "value": "={{ $json.text ? \"[Audio Recebido]: \"+ $json.text : \"\"}}",
              "type": "string"
            },
            {
              "id": "2d7d4164-05d3-498a-af26-833fa81806c8",
              "name": "documento",
              "value": "={{ $json.message?.content ? \"[PDF]: \" + $json.message.content : ($json.resposta_dani ? \"[PDF]: \" + $json.resposta_dani : \"\") }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2944,
        880
      ],
      "id": "500c74e7-eb2b-4e08-9480-4026c5fbe679",
      "name": "Imagem ou audio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ $('Unificador de Mensagens').first().json.mensagem_unificada }}",
              "type": "string"
            },
            {
              "id": "09b2dd8b-c24b-49e8-bc36-918ae46a4f6b",
              "name": "output_preview",
              "value": "={{ $if($('Imagem ou audio').isExecuted, $('Imagem ou audio').first().json.output_preview || '', '') }}",
              "type": "string"
            },
            {
              "id": "562253ae-7585-480e-ba6e-4774dbfd05ae",
              "name": "mensagens_antigas",
              "value": "={{ \n  $('Mensagem anteriores').all()\n    .map(item => {\n      const prefix = item.json.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.json.message.type === \"human\" && item.json.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.json.message.content;\n      return `[${item.json.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\") \n}}\n",
              "type": "string"
            },
            {
              "id": "d134ff5d-a48c-44d8-9350-572093043f53",
              "name": "=location_id",
              "value": "={{ $('Info').first().json.location_id }}",
              "type": "string"
            },
            {
              "id": "4a967e34-bd22-4f39-aed7-f376a01f67da",
              "name": "text",
              "value": "={{ $if($('Imagem ou audio').isExecuted, $('Imagem ou audio').first().json.text || '', '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5424,
        304
      ],
      "id": "e988b441-07da-4445-9bb8-a66aa1b9cbc5",
      "name": "Set mensagens",
      "executeOnce": true
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={{ $json.message }}",
            "session_id": "={{ $json.session_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4976,
        304
      ],
      "id": "9cc234db-fcdd-40c3-a207-c3254a1a0f64",
      "name": "Memoria Lead",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Pega o item de entrada\nconst inputItems = $input.all();\n\n// Processa cada item\nconst outputItems = inputItems.map((inputItem, index) => {\n  // Pega os dados do nó Info\n  const infoData = $('Info').first().json;\n  \n  // ===== CRÍTICO: Com returnAll, Postgres retorna múltiplos items =====\n  // Precisamos pegar TODOS os items, não só o último\n  const allMessages = $('Mensagem anteriores').all();\n  \n  console.log(`Total de items do Postgres: ${allMessages.length}`);\n  \n  // Transforma todos os items em um array de mensagens\n  const msgArray = allMessages\n    .map(item => item.json)\n    .filter(item => {\n      return item && item.created_at && item.message && item.message.content;\n    });\n  \n  console.log(`Total de mensagens válidas: ${msgArray.length}`);\n  \n  // Adiciona a mensagem ATUAL do lead ao histórico\n  const mensagemAtual = infoData.mensagem;\n  if (mensagemAtual && mensagemAtual.trim()) {\n    msgArray.push({\n      created_at: new Date().toISOString(),\n      message: {\n        type: \"human\",\n        content: mensagemAtual\n      }\n    });\n  }\n  \n  console.log(`Total com mensagem atual: ${msgArray.length}`);\n  \n  // Deduplica por timestamp + conteúdo\n  const seen = new Map();\n  const unique = msgArray.filter(item => {\n    // Cria chave única baseada em timestamp e conteúdo\n    const timestamp = new Date(item.created_at).getTime();\n    const content = item.message?.content || '';\n    const key = `${timestamp}_${content.substring(0, 100)}`;\n    \n    // Se já viu essa chave, ignora\n    if (seen.has(key)) {\n      console.log(`Duplicata encontrada: ${content.substring(0, 50)}...`);\n      return false;\n    }\n    \n    seen.set(key, true);\n    return true;\n  });\n  \n  console.log(`Mensagens após deduplicação: ${unique.length}`);\n  \n  // Formata as mensagens em ordem cronológica\n  const mensagens_antigas = unique\n    .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))\n    .map(item => {\n      const prefix = item.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.message.type === \"human\" && item.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.message.content;\n      return `[${item.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\");\n  \n  console.log(`Histórico formatado com ${mensagens_antigas.split('\\n\\n').length} mensagens`);\n  \n  // Retorna mantendo o pairedItem\n  return {\n    json: {\n      mensagens_antigas: mensagens_antigas,\n      mensagens_count: unique.length,\n      ...inputItem.json,\n      ...infoData\n    },\n    pairedItem: inputItem.pairedItem\n  };\n});\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5200,
        304
      ],
      "id": "0b00dca7-cfd9-49cd-9d46-bc350bf7169e",
      "name": "Deduplica Mensagens"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "created_at"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4528,
        400
      ],
      "id": "e18e9b94-11c6-456b-bc2b-3888973616fc",
      "name": "Mensagem anteriores",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        }
      },
      "name": "Search Contact",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1552,
        0
      ],
      "id": "3a40f391-e224-4818-ac12-310425985391",
      "executeOnce": false,
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "notes": "Busca contato por EMAIL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.leadconnectorhq.com/locations/{{ $json.location.id }}/customFields",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"Etapa do Funil\",\n  \"fieldKey\": \"contact.etapa_funil\",\n  \"dataType\": \"SINGLE_OPTIONS\",\n  \"placeholder\": \"Selecione a etapa\",\n  \"position\": 100,\n  \"options\": [\n    \"Novo Lead\",\n    \"Primeiro Contato\",\n    \"Em Follow-Up\",\n    \"Qualificado\",\n    \"Agendamento Marcado\",\n    \"Reagendado\",\n    \"No-Show\",\n    \"Reunião Realizada\",\n    \"Proposta Enviada\",\n    \"Follow-Up Proposta\",\n    \"Contrato Enviado\",\n    \"Aguardando Pagamento\",\n    \"Cliente Ativo\",\n    \"Perdido\"\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -320,
        -96
      ],
      "id": "2c49072f-01cb-4d1f-a202-a435c7f9b1a0",
      "name": "GHL - Criar Campo Etapa do Funil",
      "alwaysOutputData": true,
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Importante\n\nEssa tool cria campo no Socialfy, basta solicitar ao Claude o campo que quer criar e copiar o campo a baixo e colar no claude para dar como referencia",
        "height": 320,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -368,
        -272
      ],
      "id": "80b7d1aa-5623-4dd0-918b-05e050a15a44",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb6433a3-a8c8-41fc-ba24-c5508055f5e7",
              "name": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}",
              "type": "string"
            },
            {
              "id": "e3c59cf4-b8fb-47bd-9201-0cde177d3f2c",
              "name": "mensagem",
              "value": "={{ $('Info').first().json.mensagem }}",
              "type": "string"
            },
            {
              "id": "551981a4-e58d-4ee7-b27f-1d1bba8fde43",
              "name": "datetime",
              "value": "={{ $('Info').first().json.datetime }}",
              "type": "string"
            },
            {
              "id": "74b98426-15c4-4a10-9978-f310ad162656",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            },
            {
              "id": "30c0f0ec-8f71-4d0d-8e88-dfad7fa31d63",
              "name": "full_name",
              "value": "={{ $('Info').item.json.full_name }}",
              "type": "string"
            },
            {
              "id": "96903a49-e8ca-4f89-ac29-404fa61b5a7e",
              "name": "api_key",
              "value": "={{ $json.api_key }}",
              "type": "string"
            },
            {
              "id": "9621f071-1ddc-4b66-8fd1-1152035f623d",
              "name": "location.id",
              "value": "={{ $json.location.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1632,
        -224
      ],
      "id": "fbfb99b7-dd05-4004-9478-7e54b07b72b8",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').item.json.lead_id }}",
            "lead_name": "={{ $('Info').item.json.first_name }}",
            "status": "active",
            "id": "={{ $('Conversa Ativa').item.json.id || $('Info').item.json.process_id }}",
            "owner_id": "={{ $('Info').item.json.owner_id }}",
            "workflow_id": "={{ $('Info').item.json.workflow_id }}",
            "waiting_process_id": "={{ null }}",
            "retries": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4320,
        400
      ],
      "id": "324a3663-6c48-49e1-a301-55a17843bc6f",
      "name": "Salvar Inicio IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Sanitiza a mensagem e constrói o objeto corretamente\nconst info = $('Info').first().json;\nconst mensagem = info.mensagem || '';\n\n// Sanitiza quebras de linha\nconst mensagemLimpa = mensagem\n  .trim()\n  .replace(/\\r\\n/g, '\\n')\n  .replace(/\\r/g, '\\n');\n\n// Retorna o OBJETO diretamente\nreturn [{\n  json: {\n    lead_id: info.lead_id,\n    session_id: info.lead_id,\n    message: {\n      type: \"human\",\n      content: mensagemLimpa,\n      tool_calls: [],\n      additional_kwargs: {},\n      response_metadata: {},\n      invalid_tool_calls: []\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4752,
        400
      ],
      "id": "0f879ae7-7134-40c6-a97f-4176773da8ea",
      "name": "Preparar Mensagem"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ativar-ia-check",
              "leftValue": "={{ $json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "80f34e52-b954-48d7-b92a-fb1c95652f9b",
              "leftValue": "={{ $json.etiquetas }}",
              "rightValue": "assistente-admin",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        864,
        384
      ],
      "id": "52708635-effd-4d81-a92b-e725837c0966",
      "name": "IA Ativa?"
    },
    {
      "parameters": {
        "content": "## Habilitar testes\n",
        "height": 288,
        "width": 992,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1392,
        -592
      ],
      "typeVersion": 1,
      "id": "f7a638bf-eaab-484c-b8fd-f61de365932a",
      "name": "Sticky Note21",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Enviar mensagem\n",
        "height": 372,
        "width": 724
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2432,
        -928
      ],
      "typeVersion": 1,
      "id": "59f81f65-8929-40d0-8c25-1f1078b6eec6",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "requestMethod": "PATCH",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=[INSERIR-TAG-AQUI]"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1632,
        -512
      ],
      "id": "6643b034-77c1-4787-9edb-99ce614d619d"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('1. Buscar Conversa do Contato').item.json.conversations[0].contactId }}\",\n  \"message\": \"Pode iniciar o teste\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -624
      ],
      "id": "ec943cdb-0905-41a6-9a11-e21d87a83f96",
      "name": "Whatsapp3",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2336,
        -528
      ],
      "id": "cf5645c8-15f7-4f2f-9f48-93e08c2c7244"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1888,
        -528
      ],
      "id": "a6bb272d-2db0-483e-abf9-48c98111a1af",
      "name": "Canal1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').item.json.id_contato }}\",\n  \"message\": \"Pode iniciar o teste\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -432
      ],
      "id": "95b2d220-133a-4d2c-964c-7453cf3bd7bc",
      "name": "Instagram1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5aa19cdf-5168-4442-9a3e-b62f8139e3f8",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/assistente_admin",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/assistente_admin"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "366af293-94ad-4150-a56d-9f63c9668d37",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/desligaria",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "desligaria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "reset-cmd",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/reset"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "teste-cmd",
                    "leftValue": "={{ $('IA Ativa?').item.json.mensagem }}",
                    "rightValue": "/teste",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/teste"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "texto-check",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "texto",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  },
                  {
                    "id": "msg-existe",
                    "leftValue": "={{ !!$('IA Ativa?').item.json.mensagem && $('Info').item.json.mensagem.length > 0 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "imagem-check",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "imagem",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "audio-check",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Áudio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d5ab961d-d7ae-4841-ab24-172cd88fc403",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "documento",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "documento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6bb3c5ed-78d0-4690-852e-9a4658e5e3b5",
                    "leftValue": "={{ $('IA Ativa?').item.json.tipo_mensagem_original }}",
                    "rightValue": "pdf",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pdf"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1104,
        304
      ],
      "id": "128d0463-af81-4cb8-a63a-4fd6651e19a9",
      "name": "Tipo de mensagem",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "content": "## Desligar testes\n",
        "height": 320,
        "width": 992,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1392,
        -1296
      ],
      "typeVersion": 1,
      "id": "58502720-154e-4b57-8285-56f0442f4b9a",
      "name": "Sticky Note23",
      "disabled": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=desligar"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)5",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1632,
        -1216
      ],
      "id": "a7713ec7-934f-4757-b70f-c0977cfddc57"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Desligada\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -1328
      ],
      "id": "555d8587-9a48-45eb-ad99-faf2fa833b45",
      "name": "Whatsapp4",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)6",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2336,
        -1232
      ],
      "id": "e048818b-49c3-4c5e-82d9-e0e563b73d4e"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1888,
        -1232
      ],
      "id": "b87960c0-f355-408a-b46d-74295aa80e09",
      "name": "Canal3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').item.json.id_contato }}\",\n  \"message\": \"Pode iniciar o teste\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -1136
      ],
      "id": "28eacc4e-28f5-49a6-a72a-448067ad518d",
      "name": "Instagram3",
      "retryOnFail": true
    },
    {
      "parameters": {
        "content": "## Desligar testes\n",
        "height": 320,
        "width": 992,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1392,
        -1648
      ],
      "typeVersion": 1,
      "id": "d01cd50b-d7a7-4246-a109-a575861394f6",
      "name": "Sticky Note24",
      "disabled": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=assistente-adm, grupobposs"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)7",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1632,
        -1568
      ],
      "id": "f21591ab-184f-424e-979d-76348400d822"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Oi estou aqui\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -1680
      ],
      "id": "132eed4d-356c-41fd-83aa-650d76f7ed8a",
      "name": "Whatsapp5",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').item.json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1888,
        -1584
      ],
      "id": "ae93c7c7-3b0f-471a-8c66-87af5cbe2da7",
      "name": "Canal4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').item.json.id_contato }}\",\n  \"message\": \"Pode iniciar o teste\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -1488
      ],
      "id": "570b8156-9e12-46f2-b007-7ff3f469e565",
      "name": "Instagram4",
      "retryOnFail": true
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2656,
        592
      ],
      "id": "00edf687-11e3-4df2-9637-678fc2e8a045",
      "name": "Transcrever audio",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {
          "fileName": "={{ $json.fileName }}",
          "mimeType": "={{ $json.mimeType }}"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2368,
        592
      ],
      "id": "75e96e35-e8c6-419e-8899-39ab55b04803",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "jsCode": "// Coloque isso em um Code node antes do Convert to File\nconst url = $('Download áudio').first().json.photo_audio || '';\nlet extension = 'ogg'; // default para WhatsApp\n\n// Tenta extrair extensão da URL\nconst match = url.match(/\\.(\\w+)(?:\\?|$)/);\nif (match) {\n  extension = match[1];\n}\n\n// Mapeia extensões comuns\nconst mimeTypes = {\n  'ogg': 'audio/ogg',\n  'opus': 'audio/ogg',\n  'mp3': 'audio/mpeg',\n  'wav': 'audio/wav',\n  'm4a': 'audio/mp4',\n  'webm': 'audio/webm'\n};\n\nreturn {\n  json: {\n    ...$input.first().json,\n    fileName: `audio.${extension}`,\n    mimeType: mimeTypes[extension] || 'audio/ogg'\n  },\n  binary: $input.first().binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2144,
        592
      ],
      "id": "4873ab51-b5ef-4419-bb20-11023624f4fe",
      "name": "Extrair a extensão"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "ops_historico_mensagens",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session_id }}",
            "message": "={{ $json.message }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_hash",
              "displayName": "message_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4976,
        496
      ],
      "id": "ea140149-5690-4c7a-ac31-fbcab4706172",
      "name": "Memoria Lead1 - Marcos",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "ops_historico_mensagens",
          "mode": "name"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1632,
        -800
      ],
      "id": "6149383b-1d79-424c-9d8b-6282528ebc73",
      "name": "Limpar memória",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "ops_fila_mensagens",
          "mode": "name"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2320,
        -800
      ],
      "id": "740ce4b3-ba5b-4443-8835-ec9052c44154",
      "name": "Limpar fila de mensagens1",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "ops_status_atendimento",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Info').first().json.lead_id }}",
            "id": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lock_conversa",
              "displayName": "lock_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "aguardando_followup",
              "displayName": "aguardando_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "numero_followup",
              "displayName": "numero_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2096,
        -800
      ],
      "id": "cced829e-da10-4ae1-a9e3-2d2725972d55",
      "name": "Resetar status atendimento",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp",
                    "rightValue": "={{ $('Edit Fields').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "352c182d-185b-4c4f-a3f3-75d44c4677a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Edit Fields').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bb23146-c9ac-4b2e-9dc6-64686e434e7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2544,
        -800
      ],
      "id": "f17be4c9-7af6-45c0-889d-24e6ce4e1835",
      "name": "Canal2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Memória resetada.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2768,
        -704
      ],
      "id": "26980243-e574-4cf2-8181-f86f3e2685f9",
      "name": "Instagram2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"Memória resetada.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2768,
        -896
      ],
      "id": "9b2193b9-40f7-41f8-bfc8-8d59d8850ad7",
      "name": "Whatsapp2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Info').first().json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2992,
        -800
      ],
      "id": "facc4d9f-1498-4b05-9e01-dd3f2c7a2f6f"
    },
    {
      "parameters": {
        "content": "## Resetar conversa\n",
        "height": 288,
        "width": 1200,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1200,
        -928
      ],
      "typeVersion": 1,
      "id": "614e1236-0d27-48b4-92ca-293f2ff0ece1",
      "name": "Sticky Note10",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Extrai o ID da conversa mais recente\nconst data = $input.first().json;\n\nif (data.conversations && data.conversations.length > 0) {\n  const conversationId = data.conversations[0].id;\n  \n  return [{\n    json: {\n      conversationId: conversationId,\n      contactId: $input.first().json.body?.contact_id || data.conversations[0].contactId\n    }\n  }];\n}\n\n// Se não encontrar conversa, retorna vazio\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        -784
      ],
      "id": "58813eeb-6091-4aa5-973b-09378e69b3f6",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "99b0ce86-bc45-49c1-89cf-bbdc50e6bdd4",
              "name": "conversationId",
              "value": "={{ $json.conversationId }}",
              "type": "string"
            },
            {
              "id": "504ecb36-c7b7-4ee5-8d06-7473f9e0ff43",
              "name": "contactId",
              "value": "={{ $json.contactId }}",
              "type": "string"
            },
            {
              "id": "5ca544f2-b852-4290-83e3-fe3ab977b6d3",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1456,
        -784
      ],
      "id": "fc96fdf7-570e-46d2-b310-89cbeb833d57",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/conversations/search?contactId={{ $('Info').first().json.lead_id }}&limit=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1168,
        -784
      ],
      "id": "86ab046e-8c86-4df2-9918-abdfa47adc12",
      "name": "1. Buscar Conversa do Contato",
      "retryOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Edit Fields').item.json.contactId }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "tags",
              "value": "=reset"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "name": "Update Contact (Outbound)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1872,
        -800
      ],
      "id": "a869d623-8230-4f91-ba3a-10052a30d987"
    },
    {
      "parameters": {
        "url": "={{ $('Info').item.json.photo_audio }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1920,
        784
      ],
      "id": "fcbb12d2-2f87-4e02-bcb0-e78e9dcfa7a4",
      "name": "Download Comprovante1"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        2144,
        784
      ],
      "id": "b70b0c62-ef68-4772-a08e-d624758e39d2",
      "name": "Extract from File2"
    },
    {
      "parameters": {
        "jsCode": "const texto = $input.first().json.text;\n\nreturn {\n  json: {\n    arquivo_texto: texto,\n    arquivo_nome: 'fatura_nubank.pdf'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2368,
        784
      ],
      "id": "aaffd929-6acb-42fa-b999-2cf6b8cde996",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": "// Code Node: \"Ler Arquivo como Texto\"\n\nconst item = $input.first();\n\n// Pega o primeiro binary disponível (qualquer nome)\nconst binaryKeys = Object.keys(item.binary || {});\n\nif (binaryKeys.length === 0) {\n  return {\n    erro: 'Nenhum arquivo binário encontrado',\n    ...item.json\n  };\n}\n\nconst binaryKey = binaryKeys[0];\nconst binaryData = item.binary[binaryKey];\n\n// Converte pra texto\nconst buffer = Buffer.from(binaryData.data, 'base64');\nconst texto = buffer.toString('utf-8');\n\nreturn {\n  arquivo_texto: texto,\n  arquivo_tipo: binaryData.mimeType || 'desconhecido',\n  arquivo_nome: binaryData.fileName || 'arquivo',\n  arquivo_tamanho: binaryData.fileSize || texto.length,\n  ...item.json\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2368,
        976
      ],
      "id": "f42e0468-4cca-4b49-8dfe-0dff8c21811f",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Você é um assistente de análise de dados tabulares (CSV/Excel)."
            },
            {
              "content": "=  # PAPEL\n\nVocê é um assistente de análise de dados tabulares (CSV/Excel).\n\n  # TAREFA\n  Analise os dados e:\n  1. IDENTIFIQUE o tipo de dados\n  2. EXTRAIA insights relevantes\n  3. SUGIRA análises possíveis\n\n  ## Tipos possíveis:\n  - **extrato_transacoes**: transações bancárias/cartão\n  - **lista_clientes**: cadastro de clientes/leads\n  - **relatorio_vendas**: vendas, pedidos\n  - **planilha_gastos**: controle de despesas\n  - **dados_genericos**: qualquer outro dado tabular\n\n  # FORMATO DE SAÍDA\n  JSON válido:\n\n  {\n    \"tipo_dados\": \"[tipo]\",\n    \"confianca\": [0-100],\n    \"resumo\": \"[do que se trata]\",\n    \"estatisticas\": {\n      \"total_linhas\": null,\n      \"colunas\": [],\n      \"valor_total\": null,\n      \"media\": null,\n      \"maior_valor\": null,\n      \"menor_valor\": null\n    },\n    \"categorias\": {\n      // agrupamentos encontrados\n    },\n    \"periodo\": {\n      \"inicio\": null,\n      \"fim\": null\n    },\n    \"top_10\": [], // principais itens\n    \"insights\": [\n      // observações relevantes\n    ],\n    \"acao_sugerida\": \"[analisar/categorizar/exportar]\"\n  }\n\n  # REGRAS\n  1. Identifique colunas automaticamente\n  2. Calcule totais se houver valores\n  3. Agrupe por categorias se possível\n  4. Liste top 10 maiores valores\n  5. Mantenha parcelas nos nomes\n\n  DADOS:\n  {{ $json.arquivo_texto }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2592,
        976
      ],
      "id": "f6de9641-40a7-44d4-a18b-bc5b5165b523",
      "name": "csv",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Você é um assistente de análise de documentos PDF."
            },
            {
              "content": "= # PAPEL\n  Você é um assistente de análise de documentos PDF.\n\n  # TAREFA\n  Analise o texto extraído do PDF e:\n  1. IDENTIFIQUE o tipo de documento\n  2. EXTRAIA informações relevantes\n  3. SUGIRA próxima ação\n\n  ## Tipos possíveis:\n  - **fatura_cartao**: fatura de cartão de crédito\n  - **conta_servico**: conta de luz, água, telefone, internet\n  - **extrato_banco**: extrato bancário\n  - **nota_fiscal**: NF-e, DANFE\n  - **contrato**: contrato, proposta comercial\n  - **relatorio**: relatório, apresentação\n  - **boleto**: boleto bancário\n  - **outro**: documento não categorizado\n\n  # FORMATO DE SAÍDA\n  JSON válido:\n\n  {\n    \"tipo_documento\": \"[tipo]\",\n    \"confianca\": [0-100],\n    \"resumo\": \"[do que se trata em 1 frase]\",\n    \"dados_principais\": {\n      // varia por tipo\n    },\n    \"itens\": [], // lista de transações/itens se houver\n    \"totais\": {\n      \"valor_total\": null,\n      \"quantidade_itens\": null\n    },\n    \"datas\": {\n      \"emissao\": null,\n      \"vencimento\": null,\n      \"periodo_inicio\": null,\n      \"periodo_fim\": null\n    },\n    \"acao_sugerida\": \"[registrar/pagar/arquivar/revisar]\"\n  }\n\n  # REGRAS\n  1. Identifique o tipo antes de extrair\n  2. Para faturas: liste principais gastos (top 10)\n  3. Mantenha parcelas: \"AMAZON 03/12\" não \"AMAZON\"\n  4. Valores sempre numéricos (150.00 não \"R$ 150,00\")\n  5. Datas em YYYY-MM-DD\n\n  DOCUMENTO:\n  {{ $json.arquivo_texto }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2592,
        784
      ],
      "id": "02134541-01b7-40a3-b189-ae58cee382d6",
      "name": "pdf",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Info').item.json.photo_audio }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2144,
        976
      ],
      "id": "913bc394-633a-417e-bff6-5bbeecbe7957",
      "name": "Download Fatura CSV"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "=# PAPEL\n  Você é um assistente inteligente de análise de documentos e imagens.\n\n  # TAREFA\n  Analise a imagem enviada e:\n  1. IDENTIFIQUE o tipo de documento/imagem\n  2. EXTRAIA as informações relevantes baseado no tipo\n\n  ## Tipos possíveis:\n  - **comprovante_pagamento**: PIX, TED, DOC, boleto pago\n  - **fatura**: fatura de cartão, conta de luz/água/telefone\n  - **nota_fiscal**: NF-e, cupom fiscal, recibo\n  - **documento_pessoal**: RG, CNH, passaporte\n  - **contrato**: contrato, proposta, acordo\n  - **print_conversa**: screenshot de WhatsApp/chat\n  - **foto_produto**: foto de produto, embalagem\n  - **outro**: qualquer outra coisa\n\n  # FORMATO DE SAÍDA\n  Retorne APENAS JSON válido:\n\n  {\n    \"tipo_documento\": \"[tipo identificado]\",\n    \"confianca\": [0-100],\n    \"resumo\": \"[descrição curta do que é]\",\n    \"dados_extraidos\": {\n      // campos dinâmicos baseados no tipo\n    },\n    \"acao_sugerida\": \"[o que fazer com esse documento]\"\n  }\n\n  # EXEMPLOS DE dados_extraidos POR TIPO\n\n  ## Se for comprovante_pagamento:\n  {\n    \"valor\": 150.00,\n    \"data\": \"2026-01-10\",\n    \"pagador\": \"João Silva\",\n    \"recebedor\": \"Empresa X\",\n    \"tipo_transacao\": \"pix\",\n    \"codigo\": \"E123456789\"\n  }\n\n  ## Se for fatura:\n  {\n    \"valor_total\": 500.00,\n    \"vencimento\": \"2026-01-15\",\n    \"empresa\": \"Nubank\",\n    \"periodo\": \"Dez/2025\",\n    \"principais_gastos\": [\"UBER 50.00\", \"IFOOD 120.00\"]\n  }\n\n  ## Se for print_conversa:\n  {\n    \"participantes\": [\"João\", \"Maria\"],\n    \"assunto\": \"Agendamento de reunião\",\n    \"pontos_principais\": [\"Reunião dia 15\", \"Horário 14h\"]\n  }\n\n  ## Se for outro:\n  {\n    \"descricao\": \"[o que aparece na imagem]\",\n    \"texto_visivel\": \"[qualquer texto legível]\"\n  }\n\n  # REGRAS\n  1. Sempre identifique o tipo PRIMEIRO\n  2. Extraia apenas dados relevantes pro tipo\n  3. Se não tiver certeza, use \"outro\"\n  4. Campos não encontrados = null\n  5. Mantenha parcelas no nome (ex: \"MAGAZINE LUIZA 05/10\")",
        "imageUrls": "={{ $json.photo_audio }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        2656,
        1168
      ],
      "id": "328578af-7f4a-4f7c-932b-8e0722589cc2",
      "name": "Analisar Comprovante Claude1",
      "credentials": {
        "anthropicApi": {
          "id": "nNkFTZpNoiBCbO1I",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// UNIFICADOR DE MENSAGENS - BPO FINANCEIRO\n// Autor: Claude Code\n// Data: 2025-12-15\n// ============================================================\n\n// Função auxiliar para detectar tipo de conteúdo\nfunction detectarTipoConteudo(texto) {\n  if (!texto) return null;\n  \n  const textoLower = texto.toLowerCase();\n  \n  // Detectar fatura de cartão\n  if (textoLower.includes('fatura') || textoLower.includes('transações') || \n      textoLower.includes('transacoes') || textoLower.includes('cartão') ||\n      textoLower.includes('cartao') || textoLower.includes('nubank') ||\n      textoLower.includes('itaú') || textoLower.includes('bradesco') ||\n      textoLower.includes('santander') || textoLower.includes('inter') ||\n      textoLower.includes('c6') || textoLower.includes('xp')) {\n    return 'fatura_cartao';\n  }\n  \n  // Detectar comprovante\n  if (textoLower.includes('comprovante') || textoLower.includes('pix') ||\n      textoLower.includes('transferência') || textoLower.includes('ted') ||\n      textoLower.includes('doc') || textoLower.includes('pagamento')) {\n    return 'comprovante';\n  }\n  \n  // Detectar nota fiscal\n  if (textoLower.includes('nota fiscal') || textoLower.includes('nf-e') ||\n      textoLower.includes('danfe') || textoLower.includes('nfse') ||\n      textoLower.includes('cnpj')) {\n    return 'nota_fiscal';\n  }\n  \n  // Detectar extrato\n  if (textoLower.includes('extrato') || textoLower.includes('saldo')) {\n    return 'extrato';\n  }\n  \n  // Detectar relatório\n  if (textoLower.includes('relatório') || textoLower.includes('relatorio') ||\n      textoLower.includes('resumo') || textoLower.includes('dashboard')) {\n    return 'relatorio';\n  }\n  \n  return 'documento_generico';\n}\n\n// Função para limpar e formatar texto\nfunction limparTexto(texto) {\n  if (!texto) return '';\n  return texto\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .replace(/\\s{2,}/g, ' ')\n    .trim();\n}\n\n// Função para extrair valores monetários\nfunction extrairValores(texto) {\n  if (!texto) return [];\n  const regex = /R\\$\\s*[\\d.,]+/gi;\n  const matches = texto.match(regex);\n  return matches ? [...new Set(matches)] : [];\n}\n\n// ============================================================\n// INÍCIO DO PROCESSAMENTO\n// ============================================================\n\nconst item = $input.first();\nconst json = item.json;\n\n// Pegar informações do nó Info\nlet infoData = {};\ntry {\n  infoData = $('Info').first()?.json || {};\n} catch (e) {\n  infoData = {};\n}\n\nconst tipoMensagemOriginal = json.tipo_mensagem_original || \n                              infoData.tipo_mensagem_original || \n                              'texto';\n\n// ============================================================\n// COLETAR TODAS AS FONTES DE TEXTO\n// ============================================================\n\nlet textoImagem = '';\nlet textoAudio = '';\nlet textoPDF = '';\nlet textoCSV = '';\nlet textoDocumento = '';\nlet textoMensagem = '';\n\n// 1. Tentar pegar do \"Imagem ou audio\" (primeiro Set)\ntry {\n  const imgAudio = $('Imagem ou audio').first()?.json;\n  if (imgAudio) {\n    textoImagem = imgAudio.imagem || '';\n    textoAudio = imgAudio['audio:'] || imgAudio.audio || '';\n    textoDocumento = imgAudio.documento || '';\n  }\n} catch (e) {}\n\n// 2. Tentar pegar do \"Imagem ou audio1\" (segundo Set)\ntry {\n  const imgAudio1 = $('Imagem ou audio1').first()?.json;\n  if (imgAudio1) {\n    textoImagem = textoImagem || imgAudio1.imagem || '';\n    textoAudio = textoAudio || imgAudio1['audio:'] || imgAudio1.audio || '';\n    if (imgAudio1.text) {\n      textoDocumento = textoDocumento || imgAudio1.text;\n    }\n  }\n} catch (e) {}\n\n// 3. Tentar pegar do \"Analisar Comprovante Claude1\"\ntry {\n  const comprovante = $('Analisar Comprovante Claude1').first()?.json;\n  if (comprovante?.content?.[0]?.text) {\n    textoImagem = textoImagem || '[Imagem Analisada]: ' + comprovante.content[0].text;\n  }\n} catch (e) {}\n\n// 4. Tentar pegar do PDF processado\ntry {\n  const pdfNode = $('pdf').first()?.json;\n  if (pdfNode) {\n    textoPDF = pdfNode.text || pdfNode.content || pdfNode.resposta_dani || '';\n    if (textoPDF && !textoPDF.startsWith('[')) {\n      textoPDF = '[PDF Analisado]: ' + textoPDF;\n    }\n  }\n} catch (e) {}\n\n// 5. Tentar pegar do CSV processado\ntry {\n  const csvNode = $('csv').first()?.json;\n  if (csvNode) {\n    textoCSV = csvNode.text || csvNode.content || '';\n    if (textoCSV && !textoCSV.startsWith('[')) {\n      textoCSV = '[CSV/Planilha Analisada]: ' + textoCSV;\n    }\n  }\n} catch (e) {}\n\n// 6. Tentar pegar do \"Transcrever audio\"\ntry {\n  const transcricao = $('Transcrever audio').first()?.json;\n  if (transcricao?.text) {\n    textoAudio = '[Áudio Transcrito]: ' + transcricao.text;\n  }\n} catch (e) {}\n\n// 7. Pegar mensagem de texto normal\ntextoMensagem = json.mensagem || json.message?.content || \n                infoData.mensagem || '';\n\n// ============================================================\n// UNIFICAR TUDO EM UM TEXTO PADRONIZADO\n// ============================================================\n\nlet conteudoUnificado = '';\nlet tipoConteudoDetectado = 'texto';\nlet valoresEncontrados = [];\n\nif (textoImagem) {\n  conteudoUnificado = limparTexto(textoImagem);\n  tipoConteudoDetectado = detectarTipoConteudo(textoImagem) || 'imagem';\n  valoresEncontrados = extrairValores(textoImagem);\n} else if (textoAudio) {\n  conteudoUnificado = limparTexto(textoAudio);\n  tipoConteudoDetectado = 'audio_transcrito';\n  valoresEncontrados = extrairValores(textoAudio);\n} else if (textoPDF) {\n  conteudoUnificado = limparTexto(textoPDF);\n  tipoConteudoDetectado = detectarTipoConteudo(textoPDF) || 'pdf';\n  valoresEncontrados = extrairValores(textoPDF);\n} else if (textoCSV) {\n  conteudoUnificado = limparTexto(textoCSV);\n  tipoConteudoDetectado = 'planilha_csv';\n  valoresEncontrados = extrairValores(textoCSV);\n} else if (textoDocumento) {\n  conteudoUnificado = limparTexto(textoDocumento);\n  tipoConteudoDetectado = detectarTipoConteudo(textoDocumento) || 'documento';\n  valoresEncontrados = extrairValores(textoDocumento);\n} else if (textoMensagem) {\n  conteudoUnificado = limparTexto(textoMensagem);\n  tipoConteudoDetectado = 'texto';\n  valoresEncontrados = extrairValores(textoMensagem);\n}\n\n// ============================================================\n// CRIAR CONTEXTO ESTRUTURADO PARA O AGENTE\n// ============================================================\n\nif (!conteudoUnificado) {\n  conteudoUnificado = textoMensagem || '[Sem conteúdo identificado]';\n}\n\nlet mensagemContexto = '';\n\nswitch (tipoConteudoDetectado) {\n  case 'fatura_cartao':\n    mensagemContexto = `📄 **FATURA DE CARTÃO RECEBIDA**\\n\\n${conteudoUnificado}`;\n    if (valoresEncontrados.length > 0) {\n      mensagemContexto += `\\n\\n💰 **Valores identificados:** ${valoresEncontrados.join(', ')}`;\n    }\n    break;\n    \n  case 'comprovante':\n    mensagemContexto = `🧾 **COMPROVANTE RECEBIDO**\\n\\n${conteudoUnificado}`;\n    if (valoresEncontrados.length > 0) {\n      mensagemContexto += `\\n\\n💰 **Valor:** ${valoresEncontrados[0]}`;\n    }\n    break;\n    \n  case 'nota_fiscal':\n    mensagemContexto = `📋 **NOTA FISCAL RECEBIDA**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'extrato':\n    mensagemContexto = `🏦 **EXTRATO BANCÁRIO**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'audio_transcrito':\n    mensagemContexto = `🎙️ **ÁUDIO TRANSCRITO**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'pdf':\n    mensagemContexto = `📑 **DOCUMENTO PDF**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'planilha_csv':\n    mensagemContexto = `📊 **PLANILHA/CSV**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  case 'imagem':\n    mensagemContexto = `🖼️ **IMAGEM ANALISADA**\\n\\n${conteudoUnificado}`;\n    break;\n    \n  default:\n    mensagemContexto = conteudoUnificado;\n}\n\n// ============================================================\n// RETORNAR DADOS UNIFICADOS\n// ============================================================\n\nreturn {\n  json: {\n    ...json,\n    \n    // Campos unificados para o agente\n    mensagem_unificada: mensagemContexto,\n    mensagem_contexto: mensagemContexto,\n    conteudo_original: conteudoUnificado,\n    \n    // Metadados úteis\n    tipo_conteudo_detectado: tipoConteudoDetectado,\n    tipo_mensagem_original: tipoMensagemOriginal,\n    valores_encontrados: valoresEncontrados,\n    \n    // Flags de debug\n    _fontes: {\n      tinha_imagem: !!textoImagem,\n      tinha_audio: !!textoAudio,\n      tinha_pdf: !!textoPDF,\n      tinha_csv: !!textoCSV,\n      tinha_documento: !!textoDocumento,\n      tinha_texto: !!textoMensagem\n    },\n    \n    // Mensagem para o agente\n    mensagem: mensagemContexto,\n    output_preview: mensagemContexto.substring(0, 200) + '...',\n    text: conteudoUnificado\n  }\n};"
      },
      "id": "79229451-82dc-4d98-ab77-b06e31251c2c",
      "name": "Unificador de Mensagens",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3328,
        416
      ],
      "notes": "Unifica todas as entradas (texto, áudio, imagem, PDF, CSV) em um formato padronizado para o agente"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO execution_metrics (\n  execution_id,\n  workflow_id,\n  workflow_name,\n  workflow_version,\n  n8n_version,\n  environment,\n  status,\n  started_at,\n  owner_id\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, NOW(), $8\n)\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $json.dados }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2432,
        0
      ],
      "id": "5c1ce5de-b798-4584-ad01-c44182f7d831",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a6c297c-ff22-4d5d-9f91-35eaa64b0d9a",
              "name": "=dados",
              "value": "={{ $execution.id }},{{ $workflow.id }},{{ $workflow.name }},1,1.99,{{ $execution.mode }},running,cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "f3b2358a-0eec-409b-9d61-a27ea7fbe59d",
              "name": "session",
              "value": "=etapa,{{ $('Info').first().json.etapa_funil || 'NULL' }},{{ $execution.id }},{{ $('Info').first().json.lead_id}},{{ !$('Info').first().json.n8n_ativo === false }},{{ $('Info').first().json.mensagem_id || 'NULL' }},{{ $('Info').first().json.api_key || 'NULL' }},{{ $json.contact.locationId || NULL }},{{ $('Info').first().json.source || 'whatsapp' }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false,
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2032,
        0
      ],
      "id": "49e3e9ed-df75-4556-9c0c-4550744b18ef",
      "name": "GetInfo",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO ops_schedule_tracking (\n  field, value, execution_id, unique_id, ativo, chat_id, api_key, location_id, source\n) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\nON CONFLICT (unique_id) DO UPDATE SET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id,\n  api_key = EXCLUDED.api_key,\n  location_id = EXCLUDED.location_id,\n  source = EXCLUDED.source;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2880,
        0
      ],
      "id": "fc89a77f-87d8-429a-821a-d5b3fed676a7",
      "name": "Salvar registro de Atividade - marcos",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  field,\n  value,\n  execution_id,\n  unique_id,\n  ativo,\n  chat_id\n) VALUES (\n  $1, $2, $3, $4, $5, $6\n)\nON CONFLICT (unique_id) DO UPDATE\nSET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2672,
        0
      ],
      "id": "dd4c8480-ff16-4e82-8dfa-634c87fbb115",
      "name": "Salvar registro de Atividade - alan",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.crm_historico_mensagens\n(lead_id, mensagem, datetime, source, full_name)\nVALUES\n('{{ $json.lead_id }}', '{{ $json.mensagem }}', '{{ $json.datetime }}', '{{ $json.source }}', '{{ $json.full_name }}')\nON CONFLICT (lead_id, mensagem, datetime)\nDO NOTHING\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1904,
        -224
      ],
      "id": "6dc3fdc4-2509-4eea-86ee-128e4ca6d123",
      "name": "historico_mensagens_leads",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "841d5432-d22a-434f-8b45-5a6a11f37082",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        11552,
        384
      ]
    },
    {
      "parameters": {},
      "id": "c7cbf7db-fa5d-4b13-891b-e42794fc9ee1",
      "name": "no.op",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        12576,
        544
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12128,
        736
      ],
      "id": "bcc52e74-1a89-4bd8-9c3c-44745bc1a16f",
      "name": "Instagram",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12128,
        544
      ],
      "id": "4e8346b9-f61b-48ad-a74c-b7a0ad11a1df",
      "name": "Whatsapp",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp ",
                    "rightValue": "={{ $('Info').first().json.source }} ",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f5034094-22ae-449d-a556-1fc1bc216e49"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "21897a45-e463-4f12-aa85-a06b148d7ecb",
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        11904,
        544
      ],
      "id": "449d6685-f9c6-4d67-a4fe-0a9e69d31905",
      "name": "Canal"
    },
    {
      "parameters": {
        "amount": 1.5
      },
      "id": "2fb60a02-83db-44f5-b1ea-02989676c1bc",
      "name": "1.5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        12352,
        544
      ],
      "webhookId": "6376a4d8-b13c-485e-ba52-c59f06c96e47"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_response",
              "value": "={{ $('Parser Chain').item.json.output.messages.join(\"\") }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        12128,
        352
      ],
      "id": "1a3730f5-246b-4fae-bf26-a5ee52670e3e",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set mensagens').first().json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        9232,
        304
      ],
      "id": "e0d84ff6-9bd6-4ba1-ae9c-d6ed27c18d96",
      "name": "Tipo de mensagem1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        10512,
        816
      ],
      "id": "1b9effa9-86e1-40f1-8048-0e479ce92034",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "97df1142-b72f-499f-9053-d3b2f6500f9c",
              "leftValue": "={{ $json.waiting_process_id && $json.waiting_process_id !== $('Info').first().json.process_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        10208,
        288
      ],
      "id": "63e5d9fa-237c-4264-88dc-d8c55167955f",
      "name": "Deve enviar mensagem?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').first().json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        9456,
        304
      ],
      "id": "815ef2d7-27f9-44b1-b1c3-7836e5bd6dde",
      "name": "Conversa ativa atualizada",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9d2eedc1-7e26-437e-a11b-bc18f563d470",
              "leftValue": "={{ $json.waiting_process_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9680,
        304
      ],
      "id": "6ad5fb45-400b-4ede-adce-63d95e5cea2c",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10208,
        480
      ],
      "id": "465b8a0c-d03e-4e9d-bd6f-9e9e50c0e221",
      "name": "Termino de resposta",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').first().json.lead_id }}",
            "lead_name": "={{ $('Info').first().json.full_name }}",
            "status": "inactive",
            "id": "={{ $('Conversa Ativa').first().json.id || $('Info').first().json.process_id }}",
            "owner_id": "={{ $('Info').first().json.owner_id }}",
            "workflow_id": "={{ $('Info').first().json.workflow_id }}",
            "output_preview": "={{ $('Tipo de mensagem1').item.json.output }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        9984,
        288
      ],
      "id": "887f981e-045b-434b-8083-ca61e1c23952",
      "name": "Atualizar resposta IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "4010661d-8d1c-4ae7-a3a1-0ffe49d143ac",
      "name": "Segmentos1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        11328,
        384
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff19cb21-f08f-4c45-9e0c-bf15cc3a8c63",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"json\") }}",
              "rightValue": "json",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "6495fa85-2af7-493f-bf75-e3d46220f622",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"{\") }}",
              "rightValue": "{{",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "9862c89d-b15e-4ca9-819b-1d78ce50969e",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"output\") }}",
              "rightValue": "output",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "221b46a6-b8e2-4876-91e5-1e63c832c3ec",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"parsed\") }}",
              "rightValue": "parsed",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "dbfb7464-ce46-4d5d-9b0b-716ef05a823d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"split\") }}",
              "rightValue": "split",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "45b8f555-eada-41a5-abc8-a115b34d9e4d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"properties\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "7a3e9dac-e029-44cd-8c7c-ed187ec77bd7",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"type\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10880,
        384
      ],
      "id": "08ca98f0-5851-4b19-ad9f-69ecdaff656b",
      "name": "If1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        10528,
        560
      ],
      "id": "0fc9d78a-9008-4d97-92ec-51f324f6826c",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "agente_ia",
              "value": "={{ $('Info').first().json.agente_ia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        11104,
        384
      ],
      "id": "b93e86f0-7e1e-429e-a90a-99dd64f06549",
      "name": "Execution Data2"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": \"{{ $('Parser Chain').first().json.output.messages.join(\"\") }}\",\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Memoria Lead').first().json.session_id }}",
            "location_id": "={{ $('Info').first().json.location_id }}"
          },
          "matchingColumns": [
            "session_id",
            "created_at"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_hash",
              "displayName": "message_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11904,
        -32
      ],
      "id": "a585878d-f32a-45c4-8c03-ed42fe3be969",
      "name": "Memoria IA",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GWKl5KuXAdeu4BLr",
          "mode": "list",
          "cachedResultUrl": "/workflow/GWKl5KuXAdeu4BLr",
          "cachedResultName": "[TOOL] Registrar Custo IA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location_id": "={{ $('Info').first().json.location_id }}",
            "location_name": "={{ $('Info').first().json.location_name }}",
            "contact_id": "={{ $('Info').first().json.lead_id }}",
            "contact_name": "={{ $('Info').first().json.first_name }}",
            "canal": "={{ $('Info').first().json.source }}",
            "tipo_acao": "Agendar",
            "total_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_input + $('Calcular Custo LLM').first().json.custo_pro.tokens_output + $('Calcular Custo LLM').first().json.custo_flash.tokens_input + $('Calcular Custo LLM').first().json.custo_flash.tokens_output }}",
            "output_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_output + $('Calcular Custo LLM').first().json.custo_flash.tokens_output }}",
            "model": "gemini-2.5-pro+flash",
            "input_tokens": "={{ $('Calcular Custo LLM').first().json.custo_pro.tokens_input + $('Calcular Custo LLM').first().json.custo_flash.tokens_input }}",
            "workflowId": "={{ $workflow.id }}",
            "executionId": "={{ $execution.id }}",
            "date": "={{ $now.format('FFFF') }}  "
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "date",
              "displayName": "date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "model",
              "displayName": "model",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "input_tokens",
              "displayName": "input_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "output_tokens",
              "displayName": "output_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "total_tokens",
              "displayName": "total_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "workflowId",
              "displayName": "workflowId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "executionId",
              "displayName": "executionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_name",
              "displayName": "contact_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "canal",
              "displayName": "canal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tipo_acao",
              "displayName": "tipo_acao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        12576,
        352
      ],
      "id": "efd99168-3fe7-4324-8b5e-308e1a404e83",
      "name": "Call Track AI Cost",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Extrair output\nlet outputText = '';\nif (typeof data.output === 'string') {\n  outputText = data.output;\n} else if (data.output?.messages?.[0]) {\n  outputText = data.output.messages[0];\n} else if (data.output) {\n  outputText = JSON.stringify(data.output);\n}\n\n// ========================================\n// GEMINI 2.5 PRO (Agente principal)\n// ========================================\nconst PRO_PROMPT_TOKENS = 10050;\nconst PRO_CHARS_POR_TOKEN = 3.4;\nconst PRO_PRECO_INPUT = 1.25;\nconst PRO_PRECO_OUTPUT = 5.00;\n\nconst proCompletionTokens = Math.ceil(outputText.length / PRO_CHARS_POR_TOKEN);\nconst proCustoInput = (PRO_PROMPT_TOKENS / 1000000) * PRO_PRECO_INPUT;\nconst proCustoOutput = (proCompletionTokens / 1000000) * PRO_PRECO_OUTPUT;\nconst proCustoTotal = proCustoInput + proCustoOutput;\n\n// ========================================\n// GEMINI 2.5 FLASH (Tool de chat)\n// ========================================\nconst FLASH_PROMPT_TOKENS = 553;\nconst FLASH_CHARS_POR_TOKEN = 1.6;\nconst FLASH_PRECO_INPUT = 0.15;\nconst FLASH_PRECO_OUTPUT = 0.60;\n\nconst flashCompletionTokens = Math.ceil(outputText.length / FLASH_CHARS_POR_TOKEN);\nconst flashCustoInput = (FLASH_PROMPT_TOKENS / 1000000) * FLASH_PRECO_INPUT;\nconst flashCustoOutput = (flashCompletionTokens / 1000000) * FLASH_PRECO_OUTPUT;\nconst flashCustoTotal = flashCustoInput + flashCustoOutput;\n\n// ========================================\n// TOTAL COMBINADO\n// ========================================\nconst custoTotalUSD = proCustoTotal + flashCustoTotal;\nconst custoTotalBRL = custoTotalUSD * 6;\n\nreturn {\n  json: {\n    output: outputText,\n    custo_pro: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: PRO_PROMPT_TOKENS,\n      tokens_output: proCompletionTokens,\n      custo_usd: parseFloat(proCustoTotal.toFixed(6))\n    },\n    custo_flash: {\n      modelo: 'gemini-2.5-flash',\n      tokens_input: FLASH_PROMPT_TOKENS,\n      tokens_output: flashCompletionTokens,\n      custo_usd: parseFloat(flashCustoTotal.toFixed(6))\n    },\n    custo_total: {\n      custo_usd: parseFloat(custoTotalUSD.toFixed(6)),\n      custo_brl: parseFloat(custoTotalBRL.toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12352,
        352
      ],
      "id": "63462e31-f66c-46fc-9fe0-69edca3a0b31",
      "name": "Calcular Custo LLM"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst outputText = data.output || '';\n\n// ========================================\n// ESTIMATIVA DE TOKENS - CALIBRADO v2\n// ========================================\n\n// Completion: 3.4 chars por token\nconst CHARS_POR_TOKEN_OUTPUT = 3.4;\n\n// Prompt: calibrado com média dos seus dados reais\n// 9922, 9962, 10042 -> média ~9975, arredondando pra 10050\nconst PROMPT_TOKENS_BASE = 10050;\n\n// Calcular completion tokens\nconst completionTokens = Math.ceil(outputText.length / CHARS_POR_TOKEN_OUTPUT);\n\nconst promptTokens = PROMPT_TOKENS_BASE;\nconst totalTokens = promptTokens + completionTokens;\n\n// ========================================\n// CÁLCULO DE CUSTO - Gemini 2.5 Pro\n// ========================================\nconst PRECO_INPUT = 1.25;\nconst PRECO_OUTPUT = 5.00;\n\nconst custoInput = (promptTokens / 1000000) * PRECO_INPUT;\nconst custoOutput = (completionTokens / 1000000) * PRECO_OUTPUT;\nconst custoTotal = custoInput + custoOutput;\n\nreturn {\n  json: {\n    output: outputText,\n    tokenUsage: {\n      promptTokens: promptTokens,\n      completionTokens: completionTokens,\n      totalTokens: totalTokens,\n      metodo: 'estimativa'\n    },\n    custo_llm: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: promptTokens,\n      tokens_output: completionTokens,\n      tokens_total: totalTokens,\n      custo_usd: parseFloat(custoTotal.toFixed(6)),\n      custo_brl: parseFloat((custoTotal * 6).toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9008,
        304
      ],
      "id": "89f5a17e-2a4e-4c40-bd1d-ab05adab9f65",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_conversation_messages (\n  conversation_id,\n  message_text,\n  is_from_lead,\n  created_at\n)\nSELECT\n  ac.id,\n  '{{ $('Parser Chain').first().json.output.messages.join(\"\") }}',\n  false,\n  NOW()\nFROM agent_conversations ac\nWHERE ac.contact_id = '{{ $('Info').first().json.lead_id }}'\nLIMIT 1\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12128,
        160
      ],
      "id": "f39207d7-b84a-4abb-8069-864b29d49d56",
      "name": "SI - Insert AI Message",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Self-Improving: Resposta da IA"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem do usuário a ser formatada: {{ $('Tipo de mensagem1').first().json.output }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Por favor, gere a saída no seguinte formato JSON:\n{\n  \"messages\": [\n    \"splitedMessage\",\n    \"splitedMessage\",\n    \"splitedMessage\"\n  ]\n}\n\nVocê é especialista em formatação de mensagem para WhatsApp e instagram, trabalhando somente na formatação e não alterando o conteúdo da menssagem. Responda apenas com o texto final, não comente nada e não fale 'sua mensagem formatada', apenas o texto final. Não comente e nem fale por conta própria, apenas pegue a mensagem do usuário e formate.\n\nRecomendado: ideal entre 1-2 mensagens e no max 3.\n\n- Substitua ** por *\n- Remova #\n- remova \\n e quebra de linhas\n- Substitua aspas duplas por aspas simples \" > '\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        10432,
        384
      ],
      "id": "fb605de1-05c3-4306-b035-3e3fcd3896c1",
      "name": "Parser Chain",
      "executeOnce": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.crm_historico_mensagens\n  (lead_id, mensagem, datetime, source, full_name, location_id, api_key, tipo)\n  VALUES\n  ('{{ $json.lead_id }}', '{{ $json.resposta_ia }}', NOW(), '{{ $json.source }}', '{{ $('Info').first().json.usuario_responsavel }}', '{{ $json.location.id }}', '{{ $json.api_key }}', 'ai')\n  ON CONFLICT (lead_id, mensagem, datetime)\n  DO NOTHING\n  RETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12128,
        -224
      ],
      "id": "47bcecbf-d93a-4f81-a2a5-0ebef3d427ad",
      "name": "historico_mensagens_leads1",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE execution_metrics SET status = 'completed', finished_at = NOW(), duration_ms = EXTRACT(EPOCH FROM (NOW() - started_at)) * 1000 WHERE execution_id = $1;",
        "options": {
          "queryReplacement": "={{ [$execution.id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12128,
        -416
      ],
      "id": "5df0dbdd-509d-42a9-af3d-62268d4badda",
      "name": "Finish Metrics",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Agenda follow-up para caso lead não responda\nSELECT fuu_schedule_followup(\n  $1::varchar,\n  $2::varchar,\n  'sdr_inbound'::varchar,\n  $3::varchar,\n  $4::varchar,\n  $5::varchar,\n  $6::jsonb,\n  NOW()\n) as queue_id;",
        "options": {
          "queryReplacement": "={{ [$json.contact?.id || $json.session_id, $json.location_id, $json.contact?.phone || null, $json.contact?.email || null, $json.contact?.name || null, JSON.stringify({ultimo_assunto: $json.message?.content?.substring(0, 100) || '', etapa: 'qualificacao', source: 'whatsapp'})] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12128,
        -32
      ],
      "id": "3c21e218-7557-4cf4-9c38-d127bc021985",
      "name": "FUU - Agendar Follow-up",
      "retryOnFail": false,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Set mensagens - Mapeia campos do workflow Info para formato interno\nconst input = $input.item.json;\n\n// Pegar dados do Info diretamente para garantir calendários\nconst infoData = $('Info').first().json;\n\n// Extrair source baseado no agente\nlet source = 'whatsapp';\nif (input.agente_ia === 'social_seller_instagram' || input.source === 'instagram') {\n  source = 'instagram';\n}\n\n// Extrair etiquetas (pode ser string ou array)\nlet etiquetas = [];\nif (input.etiquetas) {\n  etiquetas = typeof input.etiquetas === 'string' \n    ? input.etiquetas.split(',').map(t => t.trim()).filter(t => t) \n    : input.etiquetas;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DADOS DO FORMULÁRIO DE TRÁFEGO (Facebook/Instagram Ads)\n// ─────────────────────────────────────────────────────────────────────────────\nconst formularioTrafego = {\n  origem_campanha: infoData.utm_campaign || input.utm_source || '',\n  sintomas_atuais: infoData.form_sintomas_atualmente || '',\n  procurou_ajuda: infoData.form_procurou_ajuda_medica || '',\n  mudanca_corpo: infoData.form_mudanca_no_corpo || '',\n  preferencia_consulta: infoData.form_tipo_de_consulta || '',\n  pronto_investir: infoData.form_interessado_em_investir || ''\n};\n\n// Verificar se é lead de tráfego (tem dados do formulário)\nconst isLeadTrafego = !!(formularioTrafego.sintomas_atuais || formularioTrafego.preferencia_consulta || formularioTrafego.origem_campanha || formularioTrafego.procurou_ajuda);\n\nreturn {\n  json: {\n    // IDs\n    location_id: infoData.location_id || input.owner_origin || '',\n    contact_id: infoData.lead_id || '',\n    conversation_id: infoData.id_conversa_alerta || infoData.lead_id || '',\n    \n    // Dados do contato\n    phone: infoData.telefone || '',\n    full_name: infoData.full_name || infoData.first_name || 'Visitante',\n    \n    // Mensagem\n    message: infoData.mensagem || input.resposta_ia || '',\n    source: source,\n    \n    // Contexto do lead\n    historico: input.historico || [],\n    etiquetas: etiquetas,\n    status_pagamento: infoData.status_cobranca || 'nenhum',\n    preferencia_audio_texto: infoData.tipo_mensagem_original || 'texto',\n    \n    // Modo do agente\n    modo_agente: infoData.agente_ia || 'sdr_inbound',\n    \n    // Calendários do GHL - AGORA PEGANDO DO INFO DIRETAMENTE\n    calendarios_ghl: {\n      sao_paulo: infoData.agenda_consultorio_sao_paulo || '',\n      presidente_prudente: infoData.agenda_presidente_prudente || '',\n      online: infoData.agenda_consulta_online || ''\n    },\n    \n    // API Key\n    ghl_api_key: infoData.api_key || '',\n    \n    // Dados extras do lead\n    objetivo: infoData.objetivo_do_lead || '',\n    is_primeira_mensagem: infoData.is_primeira_mensagem || false,\n    tipo_lead: infoData.tipo_lead || 'NAO_IDENTIFICADO',\n    \n    // Dados do formulário de tráfego\n    formulario_trafego: formularioTrafego,\n    is_lead_trafego: isLeadTrafego\n  }\n};"
      },
      "id": "790621fd-7bcd-45ea-8130-5ce01487e8fe",
      "name": "Set mensagens2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5648,
        304
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// FORMATAR CALENDÁRIOS\n// Usa calendários do GHL (customData) com fallback para scheduling_config\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\nconst schedulingConfig = prev.scheduling_config || {};\nconst calendariosGHL = prev.calendarios_ghl || {};\n\n// Mapear calendários - prioridade para GHL, fallback para config do agente\nconst calendarios = [];\n\nconst calSP = calendariosGHL.sao_paulo || schedulingConfig.agenda_consultorio_sao_paulo;\nconst calPP = calendariosGHL.presidente_prudente || schedulingConfig.agenda_presidente_prudente;\nconst calOnline = calendariosGHL.online || schedulingConfig.agenda_consulta_online;\n\nif (calSP) {\n  calendarios.push(`• Consultório São Paulo (Moema): ID ${calSP}`);\n}\n\nif (calPP) {\n  calendarios.push(`• Unidade Presidente Prudente: ID ${calPP}`);\n}\n\nif (calOnline) {\n  calendarios.push(`• Consulta Online (Telemedicina): ID ${calOnline}`);\n}\n\n// Se não houver calendários configurados\nif (calendarios.length === 0) {\n  calendarios.push('• Calendários não configurados');\n}\n\nconst calendariosFormatados = calendarios.join('\\n');\n\n// Informações de agendamento\nconst agendamentoInfo = [\n  `Horários: Segunda a Sexta, 9h-18h | Sábado 8h-12h`,\n  `Duração consulta: 1h a 1h30`,\n  `Antecedência mínima: 24 horas`,\n  `Cancelamento: Até 24h antes sem custo`\n].join('\\n');\n\nreturn {\n  json: {\n    ...prev,\n    calendarios_formatados: calendariosFormatados,\n    agendamento_info: agendamentoInfo,\n    // IDs para usar nas tools de agendamento\n    calendar_ids: {\n      sao_paulo: calSP || '',\n      presidente_prudente: calPP || '',\n      online: calOnline || ''\n    },\n    // Garantir que dados do formulário passam adiante\n    formulario_trafego: prev.formulario_trafego || {},\n    is_lead_trafego: prev.is_lead_trafego || false\n  }\n};"
      },
      "id": "f7af6788-cf75-4212-bc85-41ee8b4cc448",
      "name": "Formatar Calendários1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6544,
        304
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ═══════════════════════════════════════════════════════════════════════════\n// MONTAR PROMPTS FINAIS v6.6 - VERSÃO SUPABASE\n// Pega prompts modulares do campo prompts_by_mode do Supabase\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst prev = $input.item.json;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// FUNÇÃO PARA SUBSTITUIR VARIÁVEIS MUSTACHE\n// ─────────────────────────────────────────────────────────────────────────────\nfunction replaceVars(template, vars) {\n  if (!template) return '';\n  let result = template;\n\n  for (const [key, value] of Object.entries(vars)) {\n    const pattern = new RegExp(`\\\\{\\\\{\\\\s*${key}\\\\s*\\\\}\\\\}`, 'g');\n    result = result.replace(pattern, value || '');\n  }\n\n  return result;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// VARIÁVEIS PARA SUBSTITUIÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nconst variaveis = {\n  modo_agente: prev.agent_type || 'sdr_inbound',\n  source: prev.source || 'instagram',\n  full_name: prev.full_name || 'Visitante',\n  timezone: 'America/Sao_Paulo',\n  agente: prev.agent_name || 'Isabella',\n  data_hora: prev.data_hora,\n  status_pagamento: prev.status_pagamento || 'nenhum',\n  preferencia_audio_texto: prev.preferencia_audio_texto || 'texto'\n};\n\n// ─────────────────────────────────────────────────────────────────────────────\n// DETECTAR MODO ATIVO (agente_ia)\n// ─────────────────────────────────────────────────────────────────────────────\nconst modoAtivo = prev.agente_ia || prev.agent_type || 'sdr_inbound';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// PEGAR PROMPTS DO SUPABASE (prompts_by_mode)\n// ─────────────────────────────────────────────────────────────────────────────\nconst promptsDoAgente = prev.prompts_by_mode || {};\n\n// Normalizar o modo para encontrar no JSON\nfunction normalizarModo(modo) {\n  const modoLower = (modo || '').toLowerCase().trim();\n\n  const aliases = {\n    'sdr': 'sdr_inbound',\n    'inbound': 'sdr_inbound',\n    'social_seller': 'social_seller_instagram',\n    'instagram': 'social_seller_instagram',\n    'agendamento': 'scheduler',\n    'followup': 'followuper',\n    'objecao': 'objection_handler',\n    'objecoes': 'objection_handler',\n    'reativador': 'reativador_base'\n  };\n\n  return aliases[modoLower] || modoLower;\n}\n\nconst modoNormalizado = normalizarModo(modoAtivo);\n\n// Pegar o prompt do modo ativo (ou fallback para sdr_inbound)\nconst promptModoAtivo = promptsDoAgente[modoNormalizado]\n  || promptsDoAgente['sdr_inbound']\n  || '';\n\n// Prompt base vem do system_prompt do agente\nconst promptBase = prev.system_prompt || '';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR SYSTEM PROMPT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nlet systemPrompt = promptBase + '\\n\\n' + promptModoAtivo;\n\n// Substituir variáveis\nsystemPrompt = replaceVars(systemPrompt, variaveis);\n\n// ─────────────────────────────────────────────────────────────────────────────\n// REGRA DINÂMICA DE SAUDAÇÃO\n// ─────────────────────────────────────────────────────────────────────────────\nlet regraSaudacao = '';\nconst hora = prev.hora_numero;\nconst historicoExiste = prev.historico_existe;\n\nif (!historicoExiste) {\n  if (hora >= 5 && hora < 12) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Bom dia\" de forma calorosa.\\n</regra_saudacao>';\n  } else if (hora >= 12 && hora < 18) {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Boa tarde\" de forma calorosa.\\n</regra_saudacao>';\n  } else {\n    regraSaudacao = '\\n\\n<regra_saudacao>\\nÉ a PRIMEIRA mensagem. Inicie com \"Boa noite\" de forma calorosa.\\n</regra_saudacao>';\n  }\n} else {\n  regraSaudacao = '\\n\\n<regra_saudacao>\\nConversa já iniciada. NÃO repita saudação. Continue naturalmente.\\n</regra_saudacao>';\n}\n\nsystemPrompt += regraSaudacao;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR BLOCO DE RESPOSTAS DO FORMULÁRIO DE TRÁFEGO\n// ─────────────────────────────────────────────────────────────────────────────\nlet blocoFormularioTrafego = '';\nconst form = prev.formulario_trafego || {};\nconst isLeadTrafego = prev.is_lead_trafego || false;\n\nif (isLeadTrafego) {\n  const linhas = [];\n  if (form.origem_campanha) linhas.push(`VEIO POR CAMPANHA: ${form.origem_campanha}`);\n  if (form.procurou_ajuda) linhas.push(`PROCUROU AJUDA ANTES: ${form.procurou_ajuda}`);\n  if (form.sintomas_atuais) linhas.push(`SINTOMAS ATUAIS: ${form.sintomas_atuais}`);\n  if (form.mudanca_corpo) linhas.push(`MUDANÇA NO CORPO: ${form.mudanca_corpo}`);\n  if (form.preferencia_consulta) linhas.push(`PREFERÊNCIA CONSULTA: ${form.preferencia_consulta}`);\n  if (form.pronto_investir) linhas.push(`PRONTO PRA INVESTIR: ${form.pronto_investir}`);\n\n  if (linhas.length > 0) {\n    blocoFormularioTrafego = `\\n<respostas_formulario_trafego>\\n${linhas.join('\\n')}\\n</respostas_formulario_trafego>\\n`;\n  }\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// MONTAR USER PROMPT\n// ─────────────────────────────────────────────────────────────────────────────\nconst etiquetasStr = Array.isArray(prev.etiquetas)\n  ? prev.etiquetas.join(', ')\n  : (prev.etiquetas || 'nenhuma');\n\nlet userPrompt = `\n<contexto_conversa>\nLEAD: ${prev.full_name}\nCANAL: ${prev.source}\nDDD: ${prev.ddd || 'não identificado'}\nDATA/HORA: ${prev.data_hora}\nETIQUETAS: ${etiquetasStr}\nSTATUS PAGAMENTO: ${prev.status_pagamento}\nMODO ATIVO: ${modoAtivo}\n</contexto_conversa>\n`;\n\nif (blocoFormularioTrafego) {\n  userPrompt += blocoFormularioTrafego;\n}\n\nuserPrompt += `\n<hiperpersonalizacao>\n${prev.contexto_hiperpersonalizado}\n</hiperpersonalizacao>\n\n<calendarios_disponiveis>\n${prev.calendarios_formatados || ''}\n\n${prev.agendamento_info || ''}\n</calendarios_disponiveis>\n`;\n\nif (prev.historico_formatado) {\n  userPrompt += `\n<historico_conversa>\n${prev.historico_formatado}\n</historico_conversa>\n`;\n}\n\nuserPrompt += `\n<mensagem_atual>\nLEAD: ${prev.message}\n</mensagem_atual>\n\nResponda à mensagem acima como Isabella, seguindo as instruções do MODO ATIVO: ${modoAtivo}.`;\n\n// ─────────────────────────────────────────────────────────────────────────────\n// OUTPUT FINAL\n// ─────────────────────────────────────────────────────────────────────────────\nreturn {\n  json: {\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    _meta: {\n      agent_name: prev.agent_name || 'Isabella',\n      agent_version: prev.version || 'v6.6',\n      modo_ativo: modoAtivo,\n      modo_normalizado: modoNormalizado,\n      prompt_modo_encontrado: !!promptsDoAgente[modoNormalizado],\n      contact_id: prev.contact_id,\n      conversation_id: prev.conversation_id,\n      historico_mensagens: prev.historico_existe ? 'sim' : 'não',\n      hora_execucao: prev.data_hora,\n      is_lead_trafego: isLeadTrafego,\n      prompt_size: systemPrompt.length,\n      modos_disponiveis: Object.keys(promptsDoAgente)\n    }\n  }\n};"
      },
      "id": "1365d82f-edec-4ac1-b7be-03ae915641f7",
      "name": "Montar Prompts Finais1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6768,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * DONNA-WENDY v2.0.0 - Execute Code Node (n8n)\n *\n * FLUXO:\n * 1. Detecta comando /slash na mensagem\n * 2. Se não tem comando, usa GHL ou sessão do Supabase\n * 3. Retorna query pra atualizar sessão (próximo nó executa)\n */\n\n// === MAPA DE COMANDOS → AGENTES ===\nconst COMANDOS = {\n  // DONNA-WENDY\n  '/donna': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  '/d': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  '/wendy': { agent_name: 'DONNA-WENDY', modo: 'confrontacao' },\n  '/w': { agent_name: 'DONNA-WENDY', modo: 'confrontacao' },\n  '/psico': { agent_name: 'DONNA-WENDY', modo: 'confrontacao' },\n  '/fin': { agent_name: 'DONNA-WENDY', modo: 'financeiro' },\n  '/financeiro': { agent_name: 'DONNA-WENDY', modo: 'financeiro' },\n  '/f': { agent_name: 'DONNA-WENDY', modo: 'financeiro' },\n  '/contrato': { agent_name: 'DONNA-WENDY', modo: 'contratos' },\n  '/c': { agent_name: 'DONNA-WENDY', modo: 'contratos' },\n  '/status': { agent_name: 'DONNA-WENDY', modo: 'briefing' },\n  '/s': { agent_name: 'DONNA-WENDY', modo: 'briefing' },\n  '/agenda': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  '/a': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  '/coach': { agent_name: 'DONNA-WENDY', modo: 'coach' },\n  '/estrategista': { agent_name: 'DONNA-WENDY', modo: 'estrategista' },\n  '/e': { agent_name: 'DONNA-WENDY', modo: 'estrategista' },\n  '/reset': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  '/sair': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  '/modo': { agent_name: null, modo: 'info' },\n  '/comandos': { agent_name: null, modo: 'info' },\n  '/help': { agent_name: null, modo: 'info' },\n\n  // Adicione outros agentes aqui:\n  // '/archye': { agent_name: 'ARCHYE', modo: 'default' },\n  // '/teste': { agent_name: 'AGENTE-TESTE', modo: 'default' },\n};\n\n// === MAPA GHL → AGENTES ===\nconst GHL_PARA_AGENTE = {\n  'donna-wendy': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  'donna_wendy': { agent_name: 'DONNA-WENDY', modo: 'gestao_normal' },\n  'financeiro': { agent_name: 'DONNA-WENDY', modo: 'financeiro' },\n  'contratos': { agent_name: 'DONNA-WENDY', modo: 'contratos' },\n  // Adicione outros:\n  // 'archye': { agent_name: 'ARCHYE', modo: 'default' },\n};\n\nconst TOOLS_POR_MODO = {\n  'gestao_normal': ['gestao', 'calendario', 'agentes', 'comunicacao'],\n  'briefing': ['gestao', 'calendario', 'agentes'],\n  'check_in': ['gestao', 'comportamento'],\n  'relatorio_noturno': ['gestao', 'comportamento', 'financeiro'],\n  'confrontacao': ['comportamento', 'gestao'],\n  'coach': ['comportamento'],\n  'estrategista': ['gestao', 'comportamento', 'agentes'],\n  'financeiro': ['financeiro', 'comunicacao'],\n  'contratos': ['contratos', 'comunicacao'],\n  'default': ['gestao', 'comunicacao']\n};\n\n// === INPUT ===\nconst input = $input.first().json;\nconst contactId = input.contact_id || input.lead_id || input.contactId || '';\nconst locationId = input.location_id || input.locationId || '';\nconst mensagem = (input.output_preview || input.message || input.body || input.texto || input.mensagem || '').trim();\nconst agenteIaGHL = input.agente_ia || input.agente || '';\n\n// Sessão anterior (se buscou antes)\nconst sessaoAnterior = {\n  agent_name: input.sessao_agent_name || null,\n  modo: input.sessao_modo || null\n};\n\n// === DETECTAR COMANDO ===\nlet comandoDetectado = null;\nlet configComando = null;\nlet mensagemLimpa = mensagem;\nconst msgLower = mensagem.toLowerCase();\n\nfor (const [cmd, config] of Object.entries(COMANDOS)) {\n  if (msgLower === cmd || msgLower.startsWith(cmd + ' ') || msgLower.startsWith(cmd + '\\n')) {\n    comandoDetectado = cmd;\n    configComando = config;\n    mensagemLimpa = mensagem.replace(new RegExp('^' + cmd.replace('/', '\\\\/') + '\\\\s*', 'i'), '').trim();\n    break;\n  }\n}\n\n// === DETERMINAR AGENTE E MODO ===\nlet agentName = null;\nlet modoFinal = 'gestao_normal';\nlet fonte = 'default';\nconst isInfo = configComando?.modo === 'info';\n\nif (configComando && configComando.agent_name) {\n  // 1º: Comando /slash\n  agentName = configComando.agent_name;\n  modoFinal = configComando.modo;\n  fonte = 'comando';\n\n} else if (agenteIaGHL && GHL_PARA_AGENTE[agenteIaGHL.toLowerCase()]) {\n  // 2º: Campo GHL\n  const config = GHL_PARA_AGENTE[agenteIaGHL.toLowerCase()];\n  agentName = config.agent_name;\n  modoFinal = config.modo;\n  fonte = 'ghl';\n\n} else if (sessaoAnterior.agent_name) {\n  // 3º: Sessão persistida\n  agentName = sessaoAnterior.agent_name;\n  modoFinal = sessaoAnterior.modo || 'gestao_normal';\n  fonte = 'sessao';\n\n} else {\n  // 4º: Default\n  agentName = 'DONNA-WENDY';\n  modoFinal = 'gestao_normal';\n  fonte = 'default';\n}\n\n// === OUTPUT ===\nconst output = {\n  // Identificação\n  contact_id: contactId,\n  location_id: locationId,\n\n  // Agente e modo\n  agent_name: agentName,\n  modo_ativo: modoFinal,\n  fonte_deteccao: fonte,\n\n  // Mensagem\n  comando: comandoDetectado,\n  mensagem_original: mensagem,\n  mensagem: mensagemLimpa || mensagem,\n\n  // Tools\n  tools: TOOLS_POR_MODO[modoFinal] || TOOLS_POR_MODO['default'],\n\n  // Flags\n  mudou_modo: fonte === 'comando',\n  is_info: isInfo,\n  precisa_atualizar_sessao: fonte === 'comando',\n\n  // Para buscar agente no Supabase\n  query_buscar_agente: `SELECT * FROM agent_versions WHERE agent_name = '${agentName}' AND location_id = '${locationId}' AND is_active = true LIMIT 1`,\n\n  // Para atualizar sessão (usar no próximo nó SE precisa_atualizar_sessao = true)\n  query_atualizar_sessao: fonte === 'comando' ? {\n    table: 'donna_sessoes',\n    body: {\n      contact_id: contactId,\n      agent_name: agentName,\n      modo_atual: modoFinal,\n      modo_anterior: sessaoAnterior.modo,\n      updated_at: new Date().toISOString()\n    },\n    onConflict: 'contact_id'\n  } : null,\n\n  // Para Switch node\n  switch_value: modoFinal\n};\n\nreturn output;\n"
      },
      "id": "4ffda47d-4e06-48ea-819e-fc1e875e3a56",
      "name": "Preparar Execução + Identificar Contexto3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6096,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0d06c4b5-469f-4771-aea7-5cfb8d597e7b",
              "leftValue": "={{ $('Set mensagens').first().json.mensagem }}",
              "rightValue": "/",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        6320,
        304
      ],
      "id": "21d67ffc-816e-4e89-85c8-6e020d2ccc6b",
      "name": "If2"
    },
    {
      "parameters": {
        "jsCode": "// Contexto Inicial do Lead baseado em UTM\nconst input = $input.first().json.body;\n\nconst utmContent = input.contact?.attributionSource?.utmContent || '';\nconst messageBody = (input.message?.body || '').trim();\nconst isPrimeiraMensagem = !messageBody || messageBody === '' || messageBody === ' ';\n\nconst contextoPorUTM = {\n  'CARREIRA': {\n    contexto: 'Lead interessado em CARREIRA no mercado financeiro americano',\n    interesse: 'Oportunidades de carreira como agente de seguros nos EUA',\n    abordagem: 'Falar sobre licenciamento, ganhos, estrutura de trabalho'\n  },\n  'CONSULTORIA': {\n    contexto: 'Lead interessado em CONSULTORIA financeira pessoal',\n    interesse: 'Planejamento financeiro, proteção patrimonial, seguros',\n    abordagem: 'Falar sobre benefícios, proteção familiar, investimentos'\n  },\n  'INVESTIMENTO': {\n    contexto: 'Lead interessado em INVESTIMENTOS',\n    interesse: 'Opções de investimento e crescimento patrimonial',\n    abordagem: 'Falar sobre produtos financeiros, retornos, segurança'\n  }\n};\n\nlet tipoLead = '';\nfor (const tipo of Object.keys(contextoPorUTM)) {\n  if (utmContent.toUpperCase().includes(tipo)) {\n    tipoLead = tipo;\n    break;\n  }\n}\n\nlet mensagemContexto = '';\nlet contextoObj = null;\n\nif (isPrimeiraMensagem && tipoLead) {\n  contextoObj = contextoPorUTM[tipoLead];\n  mensagemContexto = `[CONTEXTO DO LEAD]\\nTipo: ${tipoLead}\\n${contextoObj.contexto}\\nInteresse principal: ${contextoObj.interesse}\\nAbordagem sugerida: ${contextoObj.abordagem}\\n\\nWork Permit: ${input['Work Permit'] || input.customData?.work_permit || 'Não informado'}\\nEstado: ${input['Estado onde mora'] || 'Não informado'}\\n`;\n}\n\nreturn {\n  json: {\n    body: input,\n    is_primeira_mensagem: isPrimeiraMensagem,\n    tem_contexto_utm: !!tipoLead,\n    tipo_lead: tipoLead || 'NAO_IDENTIFICADO',\n    utm_content: utmContent,\n    mensagem_contexto: mensagemContexto,\n    mensagem_original: messageBody,\n    work_permit: input['Work Permit'] || input.customData?.work_permit || '',\n    estado: input['Estado onde mora'] || '',\n    contexto_para_ai: isPrimeiraMensagem && contextoObj ? contextoObj : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        384
      ],
      "id": "d5ac8604-3366-46aa-afb6-f3aa0ca98f1c",
      "name": "Contexto UTM"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar Nome do Lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\n\nlet nome = body.full_name || ((body.first_name || '') + ' ' + (body.last_name || '')).trim() || body.customData?.name || '';\nconst nomeOriginal = nome;\n\nnome = nome.replace(/\\d+/g, '').trim();\nnome = nome.replace(/[_\\-.@]/g, ' ').trim();\nnome = nome.replace(/([a-z])([A-Z])/g, '$1 $2');\n\nconst apelidosCurtos = ['lu', 'le', 'li', 'jo', 'ze', 'ma', 'mi', 'ju', 'du', 'bi', 'ca', 'ka', 'fe', 'be', 'ne', 're', 'ra', 'ro', 'vi', 'va', 'na', 'ni', 'ta', 'ti', 'la', 'lo', 'ed', 'el'];\n\nfunction separarApelidoSobrenome(str) {\n  if (str.includes(' ')) return str;\n  if (str.length <= 10) return str;\n  const lower = str.toLowerCase();\n  for (let len = 2; len <= 3; len++) {\n    const possivel = lower.slice(0, len);\n    if (apelidosCurtos.includes(possivel)) {\n      const resto = str.slice(len);\n      if (resto.length >= 4) return str.slice(0, len) + ' ' + resto;\n    }\n  }\n  return str;\n}\n\nnome = separarApelidoSobrenome(nome);\nnome = nome.replace(/\\s+/g, ' ').trim();\n\nfunction capitalizar(str) {\n  const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  return str.toLowerCase().split(' ').map((palavra, i) => {\n    if (i > 0 && preposicoes.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n}\n\nlet partes = nome.split(' ').filter(p => p.length > 0);\nlet firstName = partes[0] || nome || '';\nlet lastName = partes.slice(1).join(' ') || '';\n\nfirstName = capitalizar(firstName);\nlastName = capitalizar(lastName);\n\nconst tinhaNumero = /\\d/.test(nomeOriginal);\nconst qualidade = (firstName.length < 2 || tinhaNumero) ? 'revisar' : 'ok';\n\nreturn {\n  json: {\n    ...inputData,\n    nome_original: nomeOriginal,\n    first_name: firstName,\n    last_name: lastName,\n    nome_completo: lastName ? `${firstName} ${lastName}` : firstName,\n    qualidade_nome: qualidade\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        384
      ],
      "id": "767c8fbd-abb3-420e-9d9f-d9e3bd82d89f",
      "name": "Normalizar Nome1"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar dados do lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst customData = body.customData || {};\nconst tags = (body.tags || '').toLowerCase();\nconst utmContent = body.contact?.attributionSource?.utmContent || '';\n\n// === OBJETIVO DO LEAD ===\nlet objetivo_do_lead = customData.objetivodolead || '';\n\nif (!objetivo_do_lead) {\n  if (tags.includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (tags.includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else if (utmContent.toLowerCase().includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (utmContent.toLowerCase().includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else {\n    objetivo_do_lead = 'indefinido'; // ✅ Não assume mais 'carreira' como padrão\n  }\n}\n\n// === AGENTE IA ===\nlet agente_ia = customData.motive || '';\n\nif (!agente_ia) {\n  // Verifica tags específicas\n  if (tags.includes('closer')) {\n    agente_ia = 'closer';\n  } else if (tags.includes('followuper')) {\n    agente_ia = 'followuper';\n  } else if (objetivo_do_lead === 'consultoria') {\n    agente_ia = 'sdrconsultoria';\n  } else if (objetivo_do_lead === 'carreira') {\n    agente_ia = 'sdrcarreira';\n  } else {\n    agente_ia = 'indefinido'; // ✅ Leads sem classificação clara\n  }\n}\n// ✅ Se customData.motive vier com 'assistente_admin' ou 'assistente_interno', \n//    mantém o valor original\n\n// === ATIVAR IA ===\nlet ativar_ia = customData.ativar_ia || '';\n\nif (tags.includes('perdido')) {\n  ativar_ia = 'nao';\n} else if (utmContent) {\n  ativar_ia = 'sim';\n} else if (ativar_ia === 'sim' || tags.includes('ativar_ia')) {\n  ativar_ia = 'sim';\n} else {\n  ativar_ia = 'nao';\n}\n\nreturn {\n  json: {\n    ...inputData,\n    objetivo_do_lead,\n    agente_ia,\n    ativar_ia,\n    utm_content: utmContent,\n    tags_original: body.tags\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        384
      ],
      "id": "67995f97-f9bc-4a50-abd1-2b5e715ebd0a",
      "name": "Normalizar Dados1"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "contact_id",
              "value": "={{ $json.body.contact_id }}"
            },
            {
              "key": "location_name",
              "value": "={{ $json.body.location.name }}"
            },
            {
              "key": "agente_ia",
              "value": "={{ $json.agente_ia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        0,
        384
      ],
      "id": "03fe2422-de3a-48b8-b057-fe5ae5cc3f62",
      "name": "Execution Data5"
    },
    {
      "parameters": {
        "jsCode": "const start = new Date();\nconst starttimeISO = start.toISOString();\nconst starttimeMs = start.getTime();\n\nconst end = new Date(start);\nend.setDate(end.getDate() + 7);\nconst endtimeISO = end.toISOString();\nconst endtimeMs = end.getTime();\n\nconst inputData = $input.first().json;\n\nreturn [{\n  json: {\n    ...inputData,\n    starttimeISO,\n    starttimeMs,\n    endtimeISO,\n    endtimeMs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        384
      ],
      "id": "1c20e7ba-d346-4711-b67b-01e2cbb0d66c",
      "name": "Code1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "734cd3ca-c411-46fe-8924-1ea800f80804",
              "name": "mensagem",
              "value": "={{ ($json.body?.message?.body || '').trim() || $json.mensagem_contexto || ($json.body?.customData?.message?.split(\"Instance Source:\")[0] ?? $json.body?.message?.content?.text ?? '').trim() }}",
              "type": "string"
            },
            {
              "id": "ccb3a74d-0336-4a28-9f43-7bdaff77b906",
              "name": "source",
              "value": "={{ $json.body?.contact?.attributionSource?.medium === \"instagram\" ? \"instagram\": \"whatsapp\" }}",
              "type": "string"
            },
            {
              "id": "332d6a13-10c8-465f-8ddb-fa97266f9fec",
              "name": "first_name",
              "value": "={{ $json.first_name }}",
              "type": "string"
            },
            {
              "id": "60cb5031-9132-4c86-9ab7-c487a170c9e3",
              "name": "last_name",
              "value": "={{ $json.last_name }}",
              "type": "string"
            },
            {
              "id": "9d4ae7a5-635b-4dbc-93d1-9464ace3208c",
              "name": "email",
              "value": "={{ $json.body?.email }}",
              "type": "string"
            },
            {
              "id": "d6301da3-de8a-45e3-9705-32cf65c3bf1e",
              "name": "telefone",
              "value": "={{ $json.body?.customData?.phone }}",
              "type": "string"
            },
            {
              "id": "7e094af2-d305-42ba-b6d2-014b62231ebb",
              "name": "datetime",
              "value": "={{ $json.body?.date_created }}",
              "type": "string"
            },
            {
              "id": "f3471b65-9533-4f5c-a669-60aaf549b4e8",
              "name": "process_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "257ef1e2-26bb-461e-8335-3d1101d3cda6",
              "name": "owner_origin",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "1e235f54-27cf-4b91-b156-1c0a69149370",
              "name": "owner_id",
              "value": "=cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "5041121e-02b1-4993-ad9c-34131a44b08d",
              "name": "timezone_do_lead",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "367c6400-fd93-4f50-a09b-b2d56aea0bd9",
              "name": "lead_id",
              "value": "={{ $json.body?.contact_id }}",
              "type": "string"
            },
            {
              "id": "66a3f763-5dbe-4033-abd7-3079835a035a",
              "name": "mensagem_id",
              "value": "={{ $json.starttimeMs }}",
              "type": "string"
            },
            {
              "id": "110eb8f6-d0b2-4358-a002-3741abbcfeb7",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "ab843596-5dfa-41d7-8ac4-02cd1dd5b661",
              "name": "api_key",
              "value": "={{ $json.body?.customData?.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "8be8461d-83f1-4563-9e2e-46e978d3afb4",
              "name": "location_id",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "3df2e105-88b1-4d12-b957-6b5d909056be",
              "name": "tipo",
              "value": "={{ $json.body?.customData?.tipo }}",
              "type": "string"
            },
            {
              "id": "d1fa8d84-c23b-4292-86bc-2066e14c7882",
              "name": "calendarID_carreira",
              "value": "={{ $json.body?.customData?.calendar_id_carreira }}",
              "type": "string"
            },
            {
              "id": "cca7fe8b-af83-40c1-ba8b-d4de7cd21c47",
              "name": "calendarID_consultoria_financeira",
              "value": "={{ $json.body?.customData?.consultoria_financeira }}",
              "type": "string"
            },
            {
              "id": "dad6c1f3-82b2-45ea-b3be-c512a879ac98",
              "name": "origem_teste",
              "value": "Marcos Danielss",
              "type": "string"
            },
            {
              "id": "3038f1ef-1199-4aab-9354-dc9463c775de",
              "name": "etiquetas",
              "value": "={{ $json.body?.tags }}",
              "type": "string"
            },
            {
              "id": "4100931a-e49b-4b97-8a16-7a797b67899e",
              "name": "area_de_atuacao",
              "value": "={{ $json.body?.['Qual a sua área de atuação?']?.[0] }}",
              "type": "string"
            },
            {
              "id": "4ed525e0-9bb6-4663-980a-70a10db813d4",
              "name": "idade",
              "value": "={{ $json.body?.Idade }}",
              "type": "string"
            },
            {
              "id": "b14c96ea-7093-48b6-add5-dd0159af29cd",
              "name": "instagram",
              "value": "={{ $json.body?.Instagram }}",
              "type": "string"
            },
            {
              "id": "9d450e98-e0e3-48fb-bb77-41c6d701f227",
              "name": "modelo_de_atuacao",
              "value": "={{ $json.body?.['Modelo de atuação'] }}",
              "type": "string"
            },
            {
              "id": "69b88a48-6d28-42b1-8ff4-5120e516f348",
              "name": "faturamento_medio",
              "value": "={{ $json.body?.['Faturamento médio'] }}",
              "type": "string"
            },
            {
              "id": "35274cdc-7a80-4945-9296-5d74db32aff2",
              "name": "investimento",
              "value": "={{ $json.body?.Investimento }}",
              "type": "string"
            },
            {
              "id": "247f2856-13b1-4bc4-bb55-cf7842680459",
              "name": "event_chat",
              "value": "={{ $json.body?.event?.Info?.Chat }}",
              "type": "string"
            },
            {
              "id": "dda2ed54-8e91-41e2-92c9-1b2d12763e2b",
              "name": "event_is_group",
              "value": "={{ $json.body?.event?.Info?.IsGroup }}",
              "type": "boolean"
            },
            {
              "id": "16308ff3-20b3-4fd4-b126-21c34248530b",
              "name": "time_zone_do_agente",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "391cb65e-46a0-475b-8c42-3629883ad983",
              "name": "usuario_responsavel",
              "value": "={{ $json.body?.user?.firstName }} {{ $json.body?.user?.lastName }}",
              "type": "string"
            },
            {
              "id": "1cd51504-1dc9-4aea-956a-9a4757db1b6c",
              "name": "photo_audio",
              "value": "={{ $json.url_arquivo || $('Mensagem recebida').item.json.body.customData.attachments || $('Mensagem recebida').item.json.body.customData.photo_audio || '' }}",
              "type": "string"
            },
            {
              "id": "939d130d-8780-41e6-9693-10b83cd9bab5",
              "name": "agendamento_duracao_minutos",
              "value": "30",
              "type": "string"
            },
            {
              "id": "c9a26bfa-ced7-4b82-a6bb-2c0aeb46f9a3",
              "name": "cobranca_valor",
              "value": "500",
              "type": "string"
            },
            {
              "id": "9290e4ff-d01b-4fca-b5f3-7605d4f74c07",
              "name": "id_conversa_alerta",
              "value": "skfa6JP6lLlAXkc8FfIp",
              "type": "string"
            },
            {
              "id": "c594a0f2-aba9-458c-92ff-81e73086416c",
              "name": "url_asaas",
              "value": "https://api-sandbox.asaas.com",
              "type": "string"
            },
            {
              "id": "3ae92580-436d-4dfc-a7cc-f83f8f68309e",
              "name": "full_name",
              "value": "={{ $json.nome_completo }}",
              "type": "string"
            },
            {
              "id": "15265189-0d84-420c-b7da-6181170a6b08",
              "name": "location_name",
              "value": "={{ $json.body?.location?.name }}",
              "type": "string"
            },
            {
              "id": "5770d76c-1a0f-4515-9683-381881715eb5",
              "name": "resposta_ia",
              "value": "={{ $json.body?.['Resposta IA'] }}",
              "type": "string"
            },
            {
              "id": "b1871710-95d0-495d-9592-ff09ea8ab983",
              "name": "objetivo_do_lead",
              "value": "={{ $json.objetivo_do_lead }}",
              "type": "string"
            },
            {
              "id": "5a729725-994d-46e5-a6f1-aac7b9504a3a",
              "name": "ativar_ia",
              "value": "={{ $json.ativar_ia }}",
              "type": "string"
            },
            {
              "id": "5e293330-4c28-4ae8-92ef-e99bc9feb55e",
              "name": "utm_content",
              "value": "={{ $json.utm_content }}",
              "type": "string"
            },
            {
              "id": "7d94c551-b241-48e8-84e8-9ab152f6a526",
              "name": "agente_ia",
              "value": "={{ $json.agente_ia }}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "mensagem_contexto",
              "value": "={{ $json.mensagem_contexto }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "is_primeira_mensagem",
              "value": "={{ $json.is_primeira_mensagem }}",
              "type": "boolean"
            },
            {
              "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
              "name": "tipo_lead",
              "value": "={{ $json.tipo_lead }}",
              "type": "string"
            },
            {
              "id": "301166ea-a33e-4fa8-a1ec-3a3a0fd00923",
              "name": "tipo_mensagem_original",
              "value": "={{ $json.tipo_mensagem_original }}\n",
              "type": "string"
            },
            {
              "id": "368ffdd1-2395-4632-b738-e35ebfbe0832",
              "name": "body.customData.ghl_api_key",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.ghl_api_key }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        672,
        384
      ],
      "id": "e98cba93-479f-4982-b18e-2b7f71755778",
      "name": "Info"
    },
    {
      "parameters": {
        "jsCode": "const customData = $input.first().json.body?.customData || $input.first().json.customData || {};\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst anexo = (\n  customData.attachments || \n  customData.photo_audio || \n  body.attachments ||\n  body.photo_audio ||\n  ''\n).toLowerCase();\n\nlet tipo_mensagem_original = 'texto';\n\n// Imagens\nif (anexo.includes('.jpg') || anexo.includes('.jpeg') || anexo.includes('.png') || anexo.includes('.gif') || anexo.includes('.webp')) {\n  tipo_mensagem_original = 'imagem';\n}\n// PDF\nelse if (anexo.includes('.pdf')) {\n  tipo_mensagem_original = 'pdf';\n}\n// Planilhas e CSV\nelse if (anexo.includes('.csv') || anexo.includes('.xls') || anexo.includes('.xlsx')) {\n  tipo_mensagem_original = 'planilha';\n}\n// Áudio\nelse if (anexo.includes('.mp3') || anexo.includes('.ogg') || anexo.includes('.wav') || anexo.includes('.m4a') || anexo.includes('.opus')) {\n  tipo_mensagem_original = 'audio';\n}\n// Documentos Word\nelse if (anexo.includes('.doc') || anexo.includes('.docx')) {\n  tipo_mensagem_original = 'documento_word';\n}\n\nreturn {\n  ...$input.first().json,\n  tipo_mensagem_original,\n  anexo_url: anexo\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        384
      ],
      "id": "7298cd1d-a442-45f8-81eb-58b49451657e",
      "name": "Classificar Tipo Mensagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fuu-cancel-1",
              "name": "fuu_contact_id",
              "value": "={{ $json.contact?.id || 'no_contact' }}",
              "type": "string"
            },
            {
              "id": "fuu-cancel-2",
              "name": "fuu_location_id",
              "value": "={{ $json.contact?.locationId || 'no_location' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1024,
        496
      ],
      "id": "b440949c-7418-41ac-8e8e-1869de040a80",
      "name": "FUU - Cancelar Follow-ups",
      "retryOnFail": false,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Cancela follow-ups pendentes (executa em background)\nSELECT fuu_mark_responded(\n  '{{ $json.fuu_contact_id }}',\n  '{{ $json.fuu_location_id }}'\n) as cancelled_count;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -720,
        576
      ],
      "id": "508f141b-093b-49b2-9d89-780c36d90e6a",
      "name": "FUU - Executar Cancelamento",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT av.*, l.api_key as location_api_key\nFROM agent_versions av\nLEFT JOIN locations l ON av.location_id = l.location_id\nWHERE av.location_id = '{{ $('Set mensagens').first().json.location_id }}'\n  AND av.is_active = true\n  AND av.status = 'active'\nORDER BY av.deployed_at DESC NULLS LAST, av.created_at DESC\nLIMIT 1",
        "options": {}
      },
      "id": "ff231ec1-5ba2-4738-bc1c-088d39750fc2",
      "name": "Buscar Agente Ativo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        5872,
        304
      ],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "name": "fluxo_caixa_projetado",
        "description": "Consulta fluxo de caixa projetado dos próximos 30 dias. Mostra entradas, saídas e saldo acumulado.",
        "workflowId": {
          "__rl": true,
          "value": "C4kPTHRzifQ0CIMy",
          "mode": "list",
          "cachedResultUrl": "/workflow/C4kPTHRzifQ0CIMy",
          "cachedResultName": "[TOOL] Fluxo de Caixa Projetado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        6944,
        624
      ],
      "id": "612c8b49-af88-4319-9dca-47316591c5fb",
      "name": "Fluxo de Caixa Projetado"
    },
    {
      "parameters": {
        "name": "criar_parcelamento",
        "description": "Cria parcelamento (compra/venda parcelada). Gera todas as parcelas automaticamente.",
        "workflowId": {
          "__rl": true,
          "value": "lbOH0pP3mOyEAkXQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/lbOH0pP3mOyEAkXQ",
          "cachedResultName": "[TOOL] Criar Parcelamento"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7104,
        624
      ],
      "id": "4e21926c-eb78-4e34-9e2b-8fe374db585d",
      "name": "Criar Parcelamento"
    },
    {
      "parameters": {
        "name": "criar_recorrencia",
        "description": "Cria recorrência mensal (aluguel, salário, assinatura). Gera movimentações automaticamente todo mês.",
        "workflowId": {
          "__rl": true,
          "value": "h2JGa8pTPjTtA5vn",
          "mode": "list",
          "cachedResultUrl": "/workflow/h2JGa8pTPjTtA5vn",
          "cachedResultName": "[TOOL] Criar Recorrência"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7264,
        624
      ],
      "id": "91d9ba39-a719-404e-b40c-aeeafdbd2845",
      "name": "Criar Recorrência"
    },
    {
      "parameters": {
        "name": "relatorio_inadimplencia",
        "description": "Relatório detalhado de inadimplência. Mostra clientes em atraso, valores e nível de risco.",
        "workflowId": {
          "__rl": true,
          "value": "zmj9M6HKSrdxJuZb",
          "mode": "list",
          "cachedResultUrl": "/workflow/zmj9M6HKSrdxJuZb",
          "cachedResultName": "[TOOL] Relatório de Inadimplência"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7392,
        624
      ],
      "id": "2e6657cf-7dcb-4d0e-9987-69214e0f5489",
      "name": "Relatório de Inadimplência"
    },
    {
      "parameters": {
        "name": "dashboard_kpis",
        "description": "Dashboard com indicadores financeiros: resultado do mês, contas a pagar/receber, inadimplência, projeções. Use quando pedirem resumo financeiro ou visão geral.",
        "workflowId": {
          "__rl": true,
          "value": "s6HIkSZxkKL90B18",
          "mode": "list",
          "cachedResultUrl": "/workflow/s6HIkSZxkKL90B18",
          "cachedResultName": "[TOOL] Dashboard KPIs"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7520,
        624
      ],
      "id": "5e90bde2-1a98-4e85-822f-b9a92048d4f3",
      "name": "Dashboard KPIs"
    },
    {
      "parameters": {
        "name": "centros_custo",
        "description": "Consulta centros de custo. Use acao='relatorio' para ver despesas por centro ou acao='listar' para ver centros disponíveis.",
        "workflowId": {
          "__rl": true,
          "value": "Vu6Uk9NqVD5KTNqM",
          "mode": "list",
          "cachedResultUrl": "/workflow/Vu6Uk9NqVD5KTNqM",
          "cachedResultName": "[TOOL] Centros de Custo"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7664,
        624
      ],
      "id": "8de24bf0-ada2-48bc-a19d-0c6ffbe311d9",
      "name": "Centros de Custo"
    },
    {
      "parameters": {
        "name": "orcamento_realizado",
        "description": "Relatório de orçamento vs realizado. Compara o planejado com o executado por categoria.",
        "workflowId": {
          "__rl": true,
          "value": "vStkWfdwFAg0vqZw",
          "mode": "list",
          "cachedResultUrl": "/workflow/vStkWfdwFAg0vqZw",
          "cachedResultName": "[TOOL] Orçamento vs Realizado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7792,
        624
      ],
      "id": "0c13e8c1-34bd-46c2-903b-7d860912bb78",
      "name": "Orçamento vs Realizado"
    },
    {
      "parameters": {
        "name": "dre_simplificado",
        "description": "DRE - Demonstrativo de Resultado do Exercício. Mostra receitas, despesas e resultado dos últimos meses.",
        "workflowId": {
          "__rl": true,
          "value": "9N4DwvjLk6WsJm64",
          "mode": "list",
          "cachedResultUrl": "/workflow/9N4DwvjLk6WsJm64",
          "cachedResultName": "[TOOL] DRE Simplificado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7920,
        624
      ],
      "id": "c0a16247-db4b-48f4-9ab8-becc6cb990e6",
      "name": "DRE Simplificado"
    },
    {
      "parameters": {
        "name": "conciliacao_bancaria",
        "description": "Conciliação bancária. Use acao='pendentes' para ver itens não conciliados ou acao='conciliar' para conciliar um item específico.",
        "workflowId": {
          "__rl": true,
          "value": "Z1IFeHsHZYnooRMs",
          "mode": "list",
          "cachedResultUrl": "/workflow/Z1IFeHsHZYnooRMs",
          "cachedResultName": "[TOOL] Conciliação Bancária"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        8080,
        624
      ],
      "id": "61c38012-2ae7-4480-b93d-61de1cce6660",
      "name": "Conciliação Bancária"
    },
    {
      "parameters": {
        "name": "listar_categorias",
        "description": "Lista todas as categorias financeiras disponíveis (receitas e despesas).",
        "workflowId": {
          "__rl": true,
          "value": "Acllbvk5jMEMDzd7",
          "mode": "list",
          "cachedResultUrl": "/workflow/Acllbvk5jMEMDzd7",
          "cachedResultName": "[TOOL] Listar Categorias"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        8016,
        480
      ],
      "id": "b6648fc3-ca8c-47f5-9d71-23baadeb96ab",
      "name": "Listar Categorias"
    },
    {
      "parameters": {
        "sessionId": "={{ $('Info').first().json.lead_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryZep",
      "typeVersion": 1.1,
      "position": [
        8224,
        496
      ],
      "id": "04593388-f3f7-4673-b1bf-518937833a10",
      "name": "Zep Memory",
      "credentials": {
        "zepApi": {
          "id": "IHh2XhGtPobOTMjm",
          "name": "Zep Marcos"
        }
      }
    },
    {
      "parameters": {
        "name": "atualizar_dados_cliente",
        "description": "Use esta ferramenta para atualizar/salvar os dados do cliente no banco de dados. Use após coletar informações do cliente via conversa. Campos que podem ser atualizados: nome, documento (CPF/CNPJ), razao_social, nacionalidade, profissao, estado_civil, data_nascimento, telefone, email, endereco, cep, cidade, estado.",
        "workflowId": {
          "__rl": true,
          "value": "mtNbOiMxMZvVH0RB",
          "mode": "list",
          "cachedResultUrl": "/workflow/mtNbOiMxMZvVH0RB",
          "cachedResultName": "[TOOL] Atualizar Dados Cliente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "cliente_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cliente_id', ``, 'string') }}",
            "nome": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nome', ``, 'string') }}",
            "documento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('documento', ``, 'string') }}",
            "razao_social": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('razao_social', ``, 'string') }}",
            "nacionalidade": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nacionalidade', ``, 'string') }}",
            "profissao": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('profissao', ``, 'string') }}",
            "estado_civil": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estado_civil', ``, 'string') }}",
            "data_nascimento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('data_nascimento', ``, 'string') }}",
            "telefone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefone', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "endereco": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('endereco', ``, 'string') }}",
            "cep": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cep', ``, 'string') }}",
            "cidade": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('cidade', ``, 'string') }}",
            "estado": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estado', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "cliente_id",
              "displayName": "cliente_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "documento",
              "displayName": "documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "razao_social",
              "displayName": "razao_social",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nacionalidade",
              "displayName": "nacionalidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "profissao",
              "displayName": "profissao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "estado_civil",
              "displayName": "estado_civil",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_nascimento",
              "displayName": "data_nascimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "endereco",
              "displayName": "endereco",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "cep",
              "displayName": "cep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "cidade",
              "displayName": "cidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7360,
        480
      ],
      "id": "a1283cb8-f1ba-4e26-b4ba-f359a15faba0",
      "name": "Atualizar Dados Cliente"
    },
    {
      "parameters": {
        "name": "listar_contratos_cliente",
        "description": "Use esta ferramenta para listar todos os contratos de um cliente específico. Retorna histórico de contratos com status, valores e datas.",
        "workflowId": {
          "__rl": true,
          "value": "pZfi7Juh5CXcEaJh",
          "mode": "list",
          "cachedResultUrl": "/workflow/pZfi7Juh5CXcEaJh",
          "cachedResultName": "[TOOL] Listar Contratos Cliente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "telefone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefone', ``, 'string') }}",
            "valor_mensal": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_mensal', ``, 'string') }}",
            "num_parcelas": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('num_parcelas', ``, 'string') }}",
            "data_inicio": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('data_inicio', ``, 'string') }}",
            "dia_vencimento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dia_vencimento', ``, 'string') }}",
            "valor_entrada": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_entrada', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "valor_mensal",
              "displayName": "valor_mensal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "num_parcelas",
              "displayName": "num_parcelas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_inicio",
              "displayName": "data_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "dia_vencimento",
              "displayName": "dia_vencimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "valor_entrada",
              "displayName": "valor_entrada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7488,
        480
      ],
      "id": "37043ef9-2b34-440a-9d16-65e99fe590f6",
      "name": "Listar Contratos Cliente"
    },
    {
      "parameters": {
        "name": "buscar_contrato_pendente",
        "description": "SOMENTE ADMIN. Busca contratos pendentes (formularios preenchidos aguardando termos). Pode buscar por nome do cliente ou ID do contrato. Use quando o admin perguntar sobre contratos pendentes ou mencionar o nome de um cliente.",
        "workflowId": {
          "__rl": true,
          "value": "GAmDsrgHzVowt0nk",
          "mode": "list",
          "cachedResultUrl": "/workflow/GAmDsrgHzVowt0nk",
          "cachedResultName": "[TOOL] Buscar Contrato Pendente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7616,
        480
      ],
      "id": "fe8a33d6-fa57-4a58-b24c-fbae0fdec542",
      "name": "Buscar Contrato Pendente"
    },
    {
      "parameters": {
        "name": "atualizar_termos_contrato",
        "description": "SOMENTE ADMIN. Atualiza os termos de um contrato pendente. Use apos o admin informar os valores da negociacao. Campos: contrato_id (obrigatorio), produto, pais, valor_mensal, num_parcelas, budget_trafego, dias_onboarding, condicoes_especiais, observacoes_negociacao. A moeda e inferida automaticamente do pais (Brasil=BRL, EUA=USD).",
        "workflowId": {
          "__rl": true,
          "value": "1AyAvl2oQEa1v2mW",
          "mode": "list",
          "cachedResultUrl": "/workflow/1AyAvl2oQEa1v2mW",
          "cachedResultName": "[TOOL] Atualizar Termos Contrato"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contrato_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contrato_id', ``, 'string') }}",
            "valor_mensal": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_mensal', ``, 'string') }}",
            "num_parcelas": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('num_parcelas', ``, 'string') }}",
            "valor_entrada": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_entrada', ``, 'string') }}",
            "data_inicio": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('data_inicio', ``, 'string') }}",
            "dia_vencimento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dia_vencimento', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "contrato_id",
              "displayName": "contrato_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "valor_mensal",
              "displayName": "valor_mensal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "num_parcelas",
              "displayName": "num_parcelas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "valor_entrada",
              "displayName": "valor_entrada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data_inicio",
              "displayName": "data_inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "dia_vencimento",
              "displayName": "dia_vencimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7744,
        480
      ],
      "id": "aac33e7f-1b2e-4e37-8fb9-b702be78b242",
      "name": "Atualizar Termos Contrato"
    },
    {
      "parameters": {
        "name": "gerar_contrato_google_docs",
        "description": "SOMENTE ADMIN. Gera o contrato oficial via Google Docs e envia para assinatura digital no Autentique. Use APENAS quando os termos ja estiverem salvos (status 'termos_informados') e o admin confirmar que quer gerar. Recebe o ID do contrato pendente e: 1) Copia o template do Google Docs, 2) Substitui os placeholders pelos dados, 3) Envia ao Autentique para assinatura, 4) Atualiza o status para 'contrato_gerado'.",
        "workflowId": {
          "__rl": true,
          "value": "s1FZRsx5o7AIrQjk",
          "mode": "list",
          "cachedResultUrl": "/workflow/s1FZRsx5o7AIrQjk",
          "cachedResultName": "9 - Gerar Contrato Automatico"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contrato_pendente_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contrato_pendente_id', ``, 'string') }}"
          },
          "matchingColumns": [
            "contrato_pendente_id"
          ],
          "schema": [
            {
              "id": "contrato_pendente_id",
              "displayName": "contrato_pendente_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7872,
        480
      ],
      "id": "98e240d3-302c-4ae7-bba4-5732e2162cf9",
      "name": "Gerar Contrato Google Docs"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        7104,
        464
      ],
      "id": "069ce955-fbe1-47ba-a634-fd5647f20895",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "Id8CEvNKDTHbg6vv",
          "name": "gemini marcos"
        }
      }
    },
    {
      "parameters": {
        "name": "buscar_movimentacoes",
        "description": "Busca movimentações financeiras existentes. Filtre por data, tipo, status de pagamento.",
        "workflowId": {
          "__rl": true,
          "value": "2b7qY6FV4SksBgXV",
          "mode": "list",
          "cachedResultUrl": "/workflow/2b7qY6FV4SksBgXV",
          "cachedResultName": "TOOL fin_movimentacoes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        8256,
        608
      ],
      "id": "b501e233-30fc-4654-9921-489bba33c6ae",
      "name": "Buscar Movimentações"
    },
    {
      "parameters": {
        "name": "salvar_movimentacao",
        "description": "Salva nova movimentação financeira. IMPORTANTE: Use APENAS após confirmação do usuário.",
        "workflowId": {
          "__rl": true,
          "value": "UZSQ0ovulSKyfbfL",
          "mode": "list",
          "cachedResultUrl": "/workflow/UZSQ0ovulSKyfbfL",
          "cachedResultName": "[TOOL] Salvar Movimentação Financeira"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "tipo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tipo', ``, 'string') }}",
            "descricao": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('descricao', ``, 'string') }}",
            "valor_previsto": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('valor_previsto', ``, 'string') }}",
            "data_vencimento": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('data_vencimento', ``, 'string') }}",
            "tipo_entidade": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tipo_entidade', ``, 'string') }}",
            "parcela_atual": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parcela_atual', ``, 'string') }}",
            "total_parcelas": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('total_parcelas', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "tipo",
              "displayName": "tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "descricao",
              "displayName": "descricao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "valor_previsto",
              "displayName": "valor_previsto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data_vencimento",
              "displayName": "data_vencimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tipo_entidade",
              "displayName": "tipo_entidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "parcela_atual",
              "displayName": "parcela_atual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "total_parcelas",
              "displayName": "total_parcelas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        8400,
        608
      ],
      "id": "a8e1e0cb-eba9-4f5d-8470-c408376ba721",
      "name": "Salvar Movimentação"
    },
    {
      "parameters": {
        "name": "criar_cliente_fornecedor",
        "description": "Cria novo cliente ou fornecedor no banco de dados.",
        "workflowId": {
          "__rl": true,
          "value": "dEPGbp6hUQbW1g5a",
          "mode": "list",
          "cachedResultUrl": "/workflow/dEPGbp6hUQbW1g5a",
          "cachedResultName": "[TOOL] Criar Cliente/Fornecedor"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        7248,
        480
      ],
      "id": "6e039c5b-24b8-4eef-b212-fff00ea55f4b",
      "name": "Criar Cliente/Fornecedor"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.user_prompt }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\n\n## HISTÓRICO DE CONVERSAS ANTIGAS\n{{ $('Set mensagens').first().json.mensagens_antigas }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        7520,
        304
      ],
      "id": "415da9bd-6ce3-44f1-b440-97ea38aaea9e",
      "name": "Agente ADM - Versionado"
    }
  ],
  "pinData": {
    "Mensagem recebida": [
      {
        "json": {
          "headers": {
            "host": "cliente-a1.mentorfy.io",
            "user-agent": "axios/1.13.2",
            "content-length": "7005",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "traceparent": "00-7e706d560c0f56fdd468e94cfd9f284b-abf22c4eeb44ef1a-01",
            "x-forwarded-for": "34.71.46.100",
            "x-forwarded-host": "cliente-a1.mentorfy.io",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "9e2d5292a02e",
            "x-real-ip": "34.71.46.100"
          },
          "params": {},
          "query": {},
          "body": {
            "Tier da Call": "",
            "Vertical": "",
            "8. Qual é a meta de faturamento que você deseja atingir nos próximos 90 dias?": "",
            "Probabilidade de Fechamento": "",
            "ID cobrança - Asaas": "",
            "Qual o seu faturamento médio mensal?": "",
            "Recruiting Campaign": "",
            "Próximo Vencimento": "",
            "6. Hoje você possui algum programa de indicação ou recomendação de clientes?": "",
            "objetivo_campanha": "",
            "Valor Mensal do Contrto": "",
            "Status cobrança - Asaas": "",
            "2. Hoje sua empresa utiliza algum sistema de CRM?": "",
            "Informações para AI": "",
            "Configuração do Clone": "",
            "Product Types": "",
            "FUP_counter": "",
            "4. Seu processo de vendas hoje é estruturado ou mais intuitivo?": "",
            "Conte-nos sobre você e sua experiência": "",
            "DNA Extraido": "",
            "Qual opção abaixo mais condiz com seu negócio hoje?": "",
            "Data da Última Renovação": "",
            "Agent Status": "",
            "tipo_agente_ia": "",
            "referencias_concorrentes": "",
            "Scores Formatado": "",
            "Data de Término": "",
            "Source (Origem)": "",
            "Score Total": "",
            "Última Invoice Enviada": "",
            "ativar_ia": "sim",
            "Duração (meses)": "",
            "Qual o nome do produto ou serviço?": "",
            "Anos de Experiência": "",
            "Upline Agent": "",
            "Qual sua situação com dívidas hoje?": "",
            "Qualificação (BANT) Score": "",
            "desejos_principais": "",
            "Preferência áudio/texto": "",
            "Funil": "",
            "CEP/ZIP Code": "",
            "Billing Status": "",
            "resp n8n": "",
            "Compensation Level": "",
            "Nombre": "",
            "Engenharia Reversa": "",
            "Total Pago (Lifetime)": "",
            "mercado_alvo": "",
            "Com que frequência você busca aprender sobre finanças e investimentos?": "",
            "Permitir chamadas WhatsApp": "",
            "Etapa do Funil": "",
            "Descoberta (SPIN) Score": "",
            "Dia de Vencimento": "",
            "10. Você teria disponibilidade para participar de uma reunião diagnóstica gratuita com um especialista Vertex nos próximos dias?": "",
            "bonus_extras": "",
            "Data Preenchimento Contrato": "",
            "Profession (Profissão):": "",
            "Resumo (AI Call)": "",
            "Status da Análise": "",
            "Condução Score": "",
            "Status do Contrato": "",
            "Product Categories": "",
            "E-mail": "",
            "Você otimiza seus impostos ou conhece estratégias para pagar menos legalmente?": "",
            "Valor total contrato": "",
            "Agente Atual": "",
            "Link da Proposta": "",
            "Language": "",
            "5. Você acompanha indicadores como taxa de conversão, ticket médio e origem dos leads?": "",
            "Teléfono": "",
            "Resposta ia": "Os detalhes do contrato da Flavia Leal Beauty School. Resumo do que anotei: - Produto: BPOSS - País: EUA - Valor mensal: $1,497 USD - Número de parcelas: 6 - Entrada: $4,997 (paga ao final do contrato) GERE O CONTRATO DA FLAVIA LEAL PRA DATA 2026/01/12",
            "nivel_urgencia": "",
            "Confirmação Veracidade Documentos": "",
            "preco_produto": "",
            "mecanismo_unico": "",
            "Fechamento Score": "",
            "Call Overview": "",
            "Qual o seu cargo na empresa?": "",
            "temperatura_trafego": "",
            "ID cliente - Asaas": "",
            "Você consegue guardar pelo menos 10-20% da sua renda TODO MÊS para pagar a si mesmo PRIMEIRO (antes das contas)?": "",
            "Endereço Completo": "",
            "Are you open to spa packages or memberships for ongoing self-care?": "",
            "Agency Campaign": "",
            "ai_started_at": "",
            "Start Date": "",
            "Data de Pagamento": "",
            "Data de Início": "",
            "Gerar DNA": "",
            "Resumo Executivo": "",
            "Lembretes Enviados": "",
            "Clients Campaign": "",
            "resultado_prometido": "",
            "idade_renda": "",
            "ai_workflow_id": "",
            "objecoes_comuns": "",
            "Data do Último Pagamento": "",
            "status_producao": "",
            "formacao_estilo_vida": "",
            "7. Quais são os principais desafios que você enfrenta hoje para aumentar suas vendas?": "",
            "Você tem um plano de aposentadoria além do Social Security?": "",
            "Clone": "",
            "Qual é o seu nome ou nome da sua marca?": "",
            "descricao_oferta": "",
            "¿Tienes conocimiento sobre en qué consiste un IUL o fondo de ahorro indexado?": "",
            "nicho_especifico": "",
            "Prospects Campaign": "",
            "Status Formulário Contrato": "",
            "3. Qual foi aproximadamente o faturamento médio dos últimos 3 meses?": "",
            "ScoreContato": "",
            "Are you looking for regular self-care routines or long-term treatments for specific needs?": "",
            "Social Security Number (SSN)/CPF:": "",
            "Se algo grave acontecer com você amanhã, sua família fica protegida?": "",
            "Status da Proposta": "",
            "Forma de pagamento ": "",
            "dores_principais": "",
            "Gender": "",
            "Você tem um fundo de emergência para 3-6 meses de despesas?": "",
            "garantia": "",
            "ai_processing_status": "",
            "Valor Mensal": "",
            "Formas de Pagamento": "",
            "Total de Invoices Enviadas": "",
            "Quantidade de Renovações": "",
            "9. Em uma escala de 0 a 10, quanto você diria que sua área comercial está organizada hoje?": "",
            "E-mail2": "",
            "Policies": "",
            "content_type": "",
            "Especialista Motive": "assistente_admin",
            "publico_alvo": "",
            "Última Ação do Agente": "",
            "observacoes_internas": "",
            "comportamento_consumo": "",
            "ai_processed_at": "",
            "diferencial_competitivo": "",
            "Segmento": "",
            "Score da Proposta": "",
            "Lead Score": "",
            "¿Tienes residencia legal en USA?": "",
            "Nacionalidade": "",
            "Escolha Indivíduo 27ao5": "",
            "Marital Status (Estado Civil):": "",
            "1. Qual é o nome da sua empresa e em que segmento você atua?": "",
            "contact_id": "oaVXSzAd30bm5Mf2nMDW",
            "first_name": "Marcos",
            "last_name": "Daniel",
            "full_name": "Marcos Daniel",
            "email": "rcelestino94@gmail.com",
            "phone": "+5511936180422",
            "tags": "grupobposs,ativar_ia,assistente_adm_contratos,assistente-adm",
            "country": "BR",
            "date_created": "2025-12-09T23:19:06.849Z",
            "full_address": "",
            "contact_type": "lead",
            "location": {
              "name": "Mottivme Sales",
              "address": "ALAMEDA RIO NEGRO, 503 – SALA 2005 BAIRRO: ALPHAVILLE CENTRO INDUSTRIAL E EMPRESARIAL/ALPHAV",
              "city": "Barueri",
              "state": "São Paulo",
              "country": "BR",
              "postalCode": "06454000",
              "fullAddress": "ALAMEDA RIO NEGRO, 503 – SALA 2005 BAIRRO: ALPHAVILLE CENTRO INDUSTRIAL E EMPRESARIAL/ALPHAV, Barueri São Paulo 06454000",
              "id": "cd1uyzpJox6XPt4Vct8Y"
            },
            "user": {
              "firstName": "Isabella",
              "lastName": "Delduco",
              "email": "isabella@mottivme.com.br",
              "phone": "+5519989582643"
            },
            "message": {
              "type": 20,
              "body": "Os detalhes do contrato da Flavia Leal Beauty School. Resumo do que anotei: - Produto: BPOSS - País: EUA - Valor mensal: $1,497 USD - Número de parcelas: 6 - Entrada: $4,997 (paga ao final do contrato) GERE O CONTRATO DA FLAVIA LEAL PRA DATA 2026/01/12"
            },
            "workflow": {
              "id": "023cbf71-3bd2-42f2-b874-a8bc947aa2f5",
              "name": "1. AI Chat N8N - Terceiros"
            },
            "triggerData": {},
            "customData": {
              "ID": "oaVXSzAd30bm5Mf2nMDW",
              "message": "Os detalhes do contrato da Flavia Leal Beauty School. Resumo do que anotei: - Produto: BPOSS - País: EUA - Valor mensal: $1,497 USD - Número de parcelas: 6 - Entrada: $4,997 (paga ao final do contrato) GERE O CONTRATO DA FLAVIA LEAL PRA DATA 2026/01/12",
              "name": "Marcos",
              "tipo": "msg",
              "ghl_api_key": "pit-1513fb68-1b2e-44fc-ab4a-ad4d188b603b",
              "preco": "",
              "tempo": "",
              "regiao": "",
              "info": "",
              "timezone": "America/New_York",
              "calendarID": "wKmqH9QKzNzq134x82fs",
              "phone": "(11) 93618-0422",
              "messagebody": "Os detalhes do contrato da Flavia Leal Beauty School. Resumo do que anotei: - Produto: BPOSS - País: EUA - Valor mensal: $1,497 USD - Número de parcelas: 6 - Entrada: $4,997 (paga ao final do contrato) GERE O CONTRATO DA FLAVIA LEAL PRA DATA 2026/01/12",
              "n8n_ativo": "",
              "Funil": "",
              "oportunidade": "",
              "attachments": "",
              "subject": "",
              "agente": "assistente-interno"
            }
          },
          "webhookUrl": "https://cliente-a1.mentorfy.io/webhook/4a2c45f4-18ce-4348-bc60-732879a0e935",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Mensagem recebida": {
      "main": [
        [
          {
            "node": "FUU - Cancelar Follow-ups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tudo certo?3": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem encavalada?": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens": {
      "main": [
        [
          {
            "node": "Form Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens": {
      "main": [
        [
          {
            "node": "Unificador de Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar": {
      "main": [
        [
          {
            "node": "Buscar mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.": {
      "main": [
        [
          {
            "node": "Esperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download áudio": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Extrair a extensão",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Form Mensagem": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Permitido AI?": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa Ativa": {
      "main": [
        [
          {
            "node": "Ação Planejada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ação Planejada": {
      "main": [
        [
          {
            "node": "Permitido AI?",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Salvar Espera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Espera": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Salvar Inicio IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem ou audio": {
      "main": [
        [
          {
            "node": "Unificador de Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens": {
      "main": [
        [
          {
            "node": "Set mensagens2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria Lead": {
      "main": [
        [
          {
            "node": "Deduplica Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplica Mensagens": {
      "main": [
        [
          {
            "node": "Set mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem anteriores": {
      "main": [
        [
          {
            "node": "Preparar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Contact": {
      "main": [
        [
          {
            "node": "GetInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "historico_mensagens_leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Inicio IA": {
      "main": [
        [
          {
            "node": "Mensagem anteriores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensagem": {
      "main": [
        [
          {
            "node": "Memoria Lead",
            "type": "main",
            "index": 0
          },
          {
            "node": "Memoria Lead1 - Marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA Ativa?": {
      "main": [
        [
          {
            "node": "Tipo de mensagem",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Update Contact (Outbound)3": {
      "main": [
        [
          {
            "node": "Canal1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp3": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal1": {
      "main": [
        [
          {
            "node": "Whatsapp3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram1": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Contact (Outbound)5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "1. Buscar Conversa do Contato",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Contact (Outbound)3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enfileirar mensagem.",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analisar Comprovante Claude1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download áudio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Fatura CSV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Comprovante1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)5": {
      "main": [
        [
          {
            "node": "Canal3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp4": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal3": {
      "main": [
        [
          {
            "node": "Whatsapp4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram3": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)7": {
      "main": [
        [
          {
            "node": "Canal4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp5": {
      "main": [
        []
      ]
    },
    "Canal4": {
      "main": [
        [
          {
            "node": "Whatsapp5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram4": {
      "main": [
        []
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Transcrever audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair a extensão": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever audio": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar memória": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens1": {
      "main": [
        [
          {
            "node": "Canal2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resetar status atendimento": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal2": {
      "main": [
        [
          {
            "node": "Whatsapp2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp2": {
      "main": [
        [
          {
            "node": "Update Contact (Outbound)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Limpar memória",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. Buscar Conversa do Contato": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Contact (Outbound)": {
      "main": [
        [
          {
            "node": "Resetar status atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Comprovante1": {
      "main": [
        [
          {
            "node": "Extract from File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File2": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "csv",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "csv": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pdf": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Fatura CSV": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisar Comprovante Claude1": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unificador de Mensagens": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInfo": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - alan",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [
          {
            "node": "Memoria IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "no.op": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal": {
      "main": [
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.5s": {
      "main": [
        [
          {
            "node": "no.op",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data1": {
      "main": [
        [
          {
            "node": "Calcular Custo LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem1": {
      "main": [
        [
          {
            "node": "Conversa ativa atualizada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Parser Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Deve enviar mensagem?": {
      "main": [
        [
          {
            "node": "Parser Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa ativa atualizada": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Atualizar resposta IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Termino de resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Termino de resposta": {
      "main": [
        [
          {
            "node": "Parser Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar resposta IA": {
      "main": [
        [
          {
            "node": "Deve enviar mensagem?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Segmentos1": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Execution Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Parser Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data2": {
      "main": [
        [
          {
            "node": "Segmentos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria IA": {
      "main": [
        [
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          },
          {
            "node": "SI - Insert AI Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "historico_mensagens_leads1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Finish Metrics",
            "type": "main",
            "index": 0
          },
          {
            "node": "FUU - Agendar Follow-up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Custo LLM": {
      "main": [
        [
          {
            "node": "Call Track AI Cost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Tipo de mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Chain": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens2": {
      "main": [
        [
          {
            "node": "Buscar Agente Ativo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Calendários1": {
      "main": [
        [
          {
            "node": "Montar Prompts Finais1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Execução + Identificar Contexto3": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Prompts Finais1": {
      "main": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Formatar Calendários1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contexto UTM": {
      "main": [
        [
          {
            "node": "Normalizar Nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Nome1": {
      "main": [
        [
          {
            "node": "Normalizar Dados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Dados1": {
      "main": [
        [
          {
            "node": "Execution Data5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data5": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Classificar Tipo Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificar Tipo Mensagem": {
      "main": [
        [
          {
            "node": "Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FUU - Cancelar Follow-ups": {
      "main": [
        [
          {
            "node": "FUU - Executar Cancelamento",
            "type": "main",
            "index": 0
          },
          {
            "node": "Contexto UTM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "IA Ativa?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search Contact",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Agente Ativo": {
      "main": [
        [
          {
            "node": "Preparar Execução + Identificar Contexto3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fluxo de Caixa Projetado": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar Parcelamento": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar Recorrência": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Relatório de Inadimplência": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Dashboard KPIs": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Centros de Custo": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Orçamento vs Realizado": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "DRE Simplificado": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Conciliação Bancária": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Listar Categorias": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Zep Memory": {
      "ai_memory": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Dados Cliente": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Listar Contratos Cliente": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Contrato Pendente": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Termos Contrato": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Contrato Google Docs": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Movimentações": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Movimentação": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente/Fornecedor": {
      "ai_tool": [
        [
          {
            "node": "Agente ADM - Versionado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agente ADM - Versionado": {
      "main": [
        [
          {
            "node": "Tudo certo?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/New_York",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "WnRF9AdjFBkEW9Ma",
    "timeSavedMode": "fixed"
  },
  "versionId": "b15f6f4e-a18d-4cf0-a68e-e5013d409ef7",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "KxkNf9CY3wePquie",
  "tags": [
    {
      "updatedAt": "2025-06-20T13:58:36.168Z",
      "createdAt": "2025-06-20T13:58:36.168Z",
      "id": "kEruuvE7z6URbdVG",
      "name": "Marcos-Daniel"
    }
  ]
}
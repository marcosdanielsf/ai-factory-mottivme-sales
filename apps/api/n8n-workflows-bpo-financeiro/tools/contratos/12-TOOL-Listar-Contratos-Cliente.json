{"updatedAt":"2026-01-10T14:57:04.956Z","createdAt":"2025-11-30T23:24:55.018Z","id":"pZfi7Juh5CXcEaJh","name":"[TOOL] Listar Contratos Cliente","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"executeQuery","query":"SELECT\n    c.id,\n    c.numero_contrato,\n    c.valor_mensal,\n    c.moeda,\n    c.num_parcelas,\n    c.valor_entrada,\n    c.data_inicio,\n    c.data_fim,\n    c.dia_vencimento,\n    c.status,\n    c.assinado_em,\n    c.created_at,\n    cf.nome as cliente_nome\n  FROM fin_contratos c\n  JOIN fin_clientes_fornecedores cf ON c.cliente_fornecedor_id = cf.id\n  WHERE c.cliente_fornecedor_id = '{{ $json.cliente_id }}'::uuid\n  ORDER BY c.created_at DESC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[144,80],"id":"39d798ae-a486-4230-83d2-a47861582351","name":"Buscar Contratos","credentials":{"postgres":{"id":"WsU3bciJm7aMyAoC","name":"postgress - financeiro - mottivme sales"}}},{"parameters":{"jsCode":"// Formatar lista de contratos\nconst contratos = $input.all().filter(i => i.json.id);\n\nif (contratos.length === 0) {\n  return {\n    json: {\n      encontrados: 0,\n      mensagem: 'Nenhum contrato encontrado para este cliente.',\n      contratos: []\n    }\n  };\n}\n\nconst formatarValor = (valor, moeda) => {\n  if (moeda === 'USD') {\n    return `US$ ${parseFloat(valor).toFixed(2)}`;\n  }\n  return new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(valor);\n};\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '-';\n  const data = new Date(dataStr);\n  return data.toLocaleDateString('pt-BR');\n};\n\nconst getStatusLabel = (status) => {\n  const statusMap = {\n    'rascunho': 'ðŸ“ Rascunho',\n    'enviado': 'ðŸ“¤ Enviado',\n    'assinado': 'âœï¸ Assinado',\n    'ativo': 'âœ… Ativo',\n    'encerrado': 'ðŸ Encerrado',\n    'cancelado': 'âŒ Cancelado'\n  };\n  return statusMap[status] || status;\n};\n\nconst listaFormatada = contratos.map(c => {\n  const contrato = c.json;\n  return {\n    numero: contrato.numero_contrato,\n    valor_mensal: formatarValor(contrato.valor_mensal, contrato.moeda),\n    parcelas: contrato.num_parcelas,\n    valor_total: formatarValor(contrato.valor_mensal * contrato.num_parcelas, contrato.moeda),\n    periodo: `${formatarData(contrato.data_inicio)} a ${formatarData(contrato.data_fim)}`,\n    vencimento: `Dia ${contrato.dia_vencimento}`,\n    status: getStatusLabel(contrato.status),\n    assinado_em: contrato.assinado_em ? formatarData(contrato.assinado_em) : '-',\n    criado_em: formatarData(contrato.created_at)\n  };\n});\n\nreturn {\n  json: {\n    cliente: contratos[0].json.cliente_nome,\n    encontrados: contratos.length,\n    contratos: listaFormatada\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[368,80],"id":"db47877c-cad4-4176-8f5d-3de7553899d0","name":"Formatar Lista"},{"parameters":{"workflowInputs":{"values":[{"name":"contact_id"},{"name":"telefone"},{"name":"valor_mensal"},{"name":"num_parcelas"},{"name":"data_inicio"},{"name":"dia_vencimento"},{"name":"valor_entrada"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-80,64],"id":"bc9ac80c-a53d-4c91-974b-ed8ad40805d4","name":"When Executed by Another Workflow"},{"parameters":{"respondWith":"allIncomingItems","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[592,80],"id":"cb0d13d4-072f-4980-9b22-d0f62d2eb4cb","name":"Respond to Workflow"}],"connections":{"Buscar Contratos":{"main":[[{"node":"Formatar Lista","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Buscar Contratos","type":"main","index":0}]]},"Formatar Lista":{"main":[[{"node":"Respond to Workflow","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"17753dcf-92c8-4bc7-b46a-31aee102cc61","activeVersionId":"17753dcf-92c8-4bc7-b46a-31aee102cc61","versionCounter":8,"triggerCount":0,"shared":[{"updatedAt":"2025-11-30T23:24:55.047Z","createdAt":"2025-11-30T23:24:55.047Z","role":"workflow:owner","workflowId":"pZfi7Juh5CXcEaJh","projectId":"VAjodPr5Fy7WALLy","project":{"updatedAt":"2025-06-18T03:44:57.988Z","createdAt":"2025-06-18T03:36:54.736Z","id":"VAjodPr5Fy7WALLy","name":"Alan Jones Rios <alan@mentorfy.io>","type":"personal","icon":null,"description":null,"projectRelations":[{"updatedAt":"2025-06-18T03:36:54.737Z","createdAt":"2025-06-18T03:36:54.737Z","userId":"c236702a-fb1c-471c-b22c-6b898a17bcb1","projectId":"VAjodPr5Fy7WALLy","user":{"updatedAt":"2026-01-11T10:10:00.323Z","createdAt":"2025-06-18T03:36:53.786Z","id":"c236702a-fb1c-471c-b22c-6b898a17bcb1","email":"alan@mentorfy.io","firstName":"Alan Jones","lastName":"Rios","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2025-06-18T03:45:05.123Z","personalization_survey_n8n_version":"1.98.1"},"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"ccHBfcfeKrXwUhIA","userActivatedAt":1750223854201,"npsSurvey":{"waitingForResponse":true,"ignoredCount":2,"lastShownAt":1768126200157},"dismissedCallouts":{"aiAgentStarterCallout":true,"ragStarterCallout":true}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-01-11","isPending":false}}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-01-10T14:58:46.000Z","createdAt":"2026-01-10T14:57:04.957Z","versionId":"17753dcf-92c8-4bc7-b46a-31aee102cc61","workflowId":"pZfi7Juh5CXcEaJh","nodes":[{"parameters":{"operation":"executeQuery","query":"SELECT\n    c.id,\n    c.numero_contrato,\n    c.valor_mensal,\n    c.moeda,\n    c.num_parcelas,\n    c.valor_entrada,\n    c.data_inicio,\n    c.data_fim,\n    c.dia_vencimento,\n    c.status,\n    c.assinado_em,\n    c.created_at,\n    cf.nome as cliente_nome\n  FROM fin_contratos c\n  JOIN fin_clientes_fornecedores cf ON c.cliente_fornecedor_id = cf.id\n  WHERE c.cliente_fornecedor_id = '{{ $json.cliente_id }}'::uuid\n  ORDER BY c.created_at DESC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[144,80],"id":"39d798ae-a486-4230-83d2-a47861582351","name":"Buscar Contratos","credentials":{"postgres":{"id":"WsU3bciJm7aMyAoC","name":"postgress - financeiro - mottivme sales"}}},{"parameters":{"jsCode":"// Formatar lista de contratos\nconst contratos = $input.all().filter(i => i.json.id);\n\nif (contratos.length === 0) {\n  return {\n    json: {\n      encontrados: 0,\n      mensagem: 'Nenhum contrato encontrado para este cliente.',\n      contratos: []\n    }\n  };\n}\n\nconst formatarValor = (valor, moeda) => {\n  if (moeda === 'USD') {\n    return `US$ ${parseFloat(valor).toFixed(2)}`;\n  }\n  return new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(valor);\n};\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '-';\n  const data = new Date(dataStr);\n  return data.toLocaleDateString('pt-BR');\n};\n\nconst getStatusLabel = (status) => {\n  const statusMap = {\n    'rascunho': 'ðŸ“ Rascunho',\n    'enviado': 'ðŸ“¤ Enviado',\n    'assinado': 'âœï¸ Assinado',\n    'ativo': 'âœ… Ativo',\n    'encerrado': 'ðŸ Encerrado',\n    'cancelado': 'âŒ Cancelado'\n  };\n  return statusMap[status] || status;\n};\n\nconst listaFormatada = contratos.map(c => {\n  const contrato = c.json;\n  return {\n    numero: contrato.numero_contrato,\n    valor_mensal: formatarValor(contrato.valor_mensal, contrato.moeda),\n    parcelas: contrato.num_parcelas,\n    valor_total: formatarValor(contrato.valor_mensal * contrato.num_parcelas, contrato.moeda),\n    periodo: `${formatarData(contrato.data_inicio)} a ${formatarData(contrato.data_fim)}`,\n    vencimento: `Dia ${contrato.dia_vencimento}`,\n    status: getStatusLabel(contrato.status),\n    assinado_em: contrato.assinado_em ? formatarData(contrato.assinado_em) : '-',\n    criado_em: formatarData(contrato.created_at)\n  };\n});\n\nreturn {\n  json: {\n    cliente: contratos[0].json.cliente_nome,\n    encontrados: contratos.length,\n    contratos: listaFormatada\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[368,80],"id":"db47877c-cad4-4176-8f5d-3de7553899d0","name":"Formatar Lista"},{"parameters":{"workflowInputs":{"values":[{"name":"contact_id"},{"name":"telefone"},{"name":"valor_mensal"},{"name":"num_parcelas"},{"name":"data_inicio"},{"name":"dia_vencimento"},{"name":"valor_entrada"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-80,64],"id":"bc9ac80c-a53d-4c91-974b-ed8ad40805d4","name":"When Executed by Another Workflow"},{"parameters":{"respondWith":"allIncomingItems","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[592,80],"id":"cb0d13d4-072f-4980-9b22-d0f62d2eb4cb","name":"Respond to Workflow"}],"connections":{"Buscar Contratos":{"main":[[{"node":"Formatar Lista","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Buscar Contratos","type":"main","index":0}]]},"Formatar Lista":{"main":[[{"node":"Respond to Workflow","type":"main","index":0}]]}},"authors":"Alan Jones Rios","name":"Version 17753dcf","description":"","workflowPublishHistory":[{"createdAt":"2026-01-10T14:58:46.711Z","id":641,"workflowId":"pZfi7Juh5CXcEaJh","versionId":"17753dcf-92c8-4bc7-b46a-31aee102cc61","event":"activated","userId":"c236702a-fb1c-471c-b22c-6b898a17bcb1"}]}}
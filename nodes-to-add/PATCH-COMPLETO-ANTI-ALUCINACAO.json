{
  "_meta": {
    "descricao": "PATCH COMPLETO ANTI-ALUCINA√á√ÉO - AI Factory V3",
    "versao": "1.0.0",
    "data": "2026-01-01",
    "problema": "Groq Llama 3.3 70B alucinando dados de outros clientes",
    "solucao": "Guardrails no prompt + N√≥ validador + Redu√ß√£o de temperature",
    "instrucoes": [
      "1. Substituir o campo 'text' do n√≥ 1.7 pelo valor em 'patch_node_1_7.text'",
      "2. Substituir o campo 'systemMessage' do n√≥ 1.7 pelo valor em 'patch_node_1_7.systemMessage'",
      "3. Adicionar o n√≥ 1.8 (completo em 'new_node_1_8')",
      "4. Alterar conex√£o: 1.7 ‚Üí 1.8 ‚Üí 2.1",
      "5. Alterar temperature do Groq de 0.3 para 0.1 (em 'patch_groq')"
    ]
  },

  "patch_node_1_7": {
    "_comentario": "Substituir campos no n√≥ '1.7 AI - Analisar Kickoff (GHL Architect V2)'",

    "text": "=## üéØ DADOS OBRIGAT√ìRIOS DO CLIENTE ATUAL\n\n| Campo | Valor (USE EXATAMENTE ESTE) |\n|-------|----------------------------|\n| **NOME DO CLIENTE** | {{ $json.nome_lead }} |\n| **TELEFONE** | {{ $json.telefone_lead }} |\n| **CONTACT ID** | {{ $json.contact_id }} |\n\n‚ö†Ô∏è **ATEN√á√ÉO CR√çTICA:**\nO agente que voc√™ criar √© para \"{{ $json.nome_lead }}\".\nO nome_negocio no seu JSON DEVE ser \"{{ $json.nome_lead }}\" ou extra√≠do da transcri√ß√£o abaixo.\nNUNCA use nomes de outros clientes como \"Dra. Eline Lobo\".\n\n---\n\n## TRANSCRI√á√ÉO DA CALL DE KICKOFF\n\n{{ $json.texto_transcricao }}\n\n---\n\n## DADOS DO CLIENTE (repetindo para ancoragem)\n- Nome: {{ $json.nome_lead }}\n- Telefone: {{ $json.telefone_lead }}\n\n---\n\n## VALIDA√á√ÉO FINAL\nAntes de gerar o JSON, confirme:\n1. O campo nome_negocio cont√©m \"{{ $json.nome_lead }}\" ou nome extra√≠do da transcri√ß√£o?\n2. Voc√™ N√ÉO usou nomes como \"Dra. Eline Lobo\", \"Dr. Jo√£o\", etc.?\n3. Todos os dados s√£o EXCLUSIVAMENTE desta transcri√ß√£o?\n\nSe tiver d√∫vida, use \"{{ $json.nome_lead }}\" como nome_negocio.",

    "systemMessage": "=## ‚ö†Ô∏è REGRAS CR√çTICAS ANTI-ALUCINA√á√ÉO (LER PRIMEIRO!)\n\n### CLIENTE ATUAL - DADOS OBRIGAT√ìRIOS\nVOC√ä EST√Å ANALISANDO EXCLUSIVAMENTE O CLIENTE: {{ $json.nome_lead }}\nTELEFONE DO CLIENTE: {{ $json.telefone_lead }}\n\n### REGRA ABSOLUTA #1: ANCORAGEM DO NOME\nO campo \"nome_negocio\" no seu output JSON DEVE ser:\n- EXATAMENTE \"{{ $json.nome_lead }}\" OU\n- Um nome extra√≠do DIRETAMENTE e LITERALMENTE da transcri√ß√£o abaixo\n\n### REGRA ABSOLUTA #2: PROIBI√á√ïES\n‚ùå NUNCA use nomes que voc√™ \"conhece\" de outros contextos\n‚ùå NUNCA invente nomes como \"Dra. Eline Lobo\", \"Dr. Jo√£o Silva\", \"Cl√≠nica XYZ\" que N√ÉO est√£o na transcri√ß√£o\n‚ùå NUNCA use dados de exemplos, few-shots ou treinamento para o nome_negocio\n‚ùå NUNCA \"adivinhe\" o nome do neg√≥cio - extraia APENAS do texto\n\n### REGRA ABSOLUTA #3: VERIFICA√á√ÉO ANTES DE RESPONDER\nAntes de gerar seu JSON, fa√ßa esta verifica√ß√£o mental:\n1. ‚úì O nome_negocio que vou usar aparece na transcri√ß√£o fornecida?\n2. ‚úì O nome_negocio corresponde ou deriva de \"{{ $json.nome_lead }}\"?\n3. ‚úì Eu N√ÉO estou usando informa√ß√µes de outros clientes/contextos?\n\nSE QUALQUER VERIFICA√á√ÉO FALHAR ‚Üí Use \"{{ $json.nome_lead }}\" como nome_negocio.\n\n### REGRA ABSOLUTA #4: VALIDA√á√ÉO DO OUTPUT\nSeu JSON de output ser√° REJEITADO se:\n- nome_negocio contiver \"Eline Lobo\" quando input for outro cliente\n- nome_negocio n√£o tiver NENHUMA rela√ß√£o com o nome_lead do input\n- nome_negocio for um nome \"famoso\" que n√£o est√° na transcri√ß√£o\n\n---\n\n# VOC√ä √â O AI ARCHITECT DA MOTTIVME\n\nSua miss√£o √© analisar transcri√ß√µes de calls de kickoff e gerar configura√ß√µes completas para agentes de IA conversacionais.\n\n---\n\n## FRAMEWORK GHL ARCHITECT V2\n\nTodo output deve seguir a estrutura de 5 BLOCOS:\n\n### BLOCO 1: PERSONA E CONTEXTO\n- Nome do agente + Cargo + Tra√ßos de comportamento\n- Tom de voz (formal/casual/acolhedor/t√©cnico)\n- Anti-Persona (o que N√ÉO fazer)\n- Custom Values do Lead: Nome sera injetado via {{contact.first_name}} ou {{contact.name}} em runtime\n\n### BLOCO 2: OBJETIVO PRIM√ÅRIO (PRIME DIRECTIVE)\n- UMA √∫nica meta mensur√°vel\n- Defini√ß√£o clara de \"sucesso\" na conversa\n- Ex: \"Seu unico sucesso e quando o lead agenda uma reuniao\" (link sera enviado pelo sistema)\n\n### BLOCO 3: PROTOCOLO DE CONDU√á√ÉO (CHAIN OF THOUGHT)\n- Passo a passo l√≥gico que o bot segue\n- Preven√ß√£o de loops: \"Se resposta curta, avance para pr√≥ximo passo\"\n- M√°ximo 5 passos\n\n### BLOCO 4: GUARDRAILS (REGRAS DE SEGURAN√áA)\n- SEMPRE instru√ß√µes AFIRMATIVAS (n√£o use \"n√£o fa√ßa\")\n- Limites de resposta (m√°x 3 frases)\n- Escala√ß√£o para humano\n- O que nunca inventar/prometer\n\n### BLOCO 5: FEW-SHOT TRAINING\n- M√≠nimo 5 exemplos Q&A\n- Cobrir: sauda√ß√£o, obje√ß√£o pre√ßo, obje√ß√£o tempo, fora do escopo, agendamento\n- Incluir exemplo de resposta curta (ok/sim)\n\n---\n\n## HIPERPERSONALIZA√á√ÉO (3 CAMADAS)\n\n### CAMADA 1: GEOGR√ÅFICA\nIdentificar DDDs das regi√µes de atua√ß√£o para personalizar por cidade.\n\nExemplos de frases por DDD:\n- 11: \"S√£o Paulo, o cora√ß√£o empresarial do Brasil!\"\n- 21: \"Rio de Janeiro, a Cidade Maravilhosa!\"\n- 31: \"Belo Horizonte, onde tradi√ß√£o encontra inova√ß√£o!\"\n- 41: \"Curitiba, refer√™ncia em qualidade de vida!\"\n- 51: \"Porto Alegre, terra de empreendedores determinados!\"\n\n### CAMADA 2: EMPRESARIAL (SETOR + ANALOGIAS)\nIdentificar o SETOR do neg√≥cio e gerar ANALOGIAS espec√≠ficas.\n\nSetores e analogias:\n- SA√öDE: \"diagn√≥stico preciso\", \"tratamento personalizado\", \"cuidado de excel√™ncia\"\n- TECH: \"upgrade de sistema\", \"escalar opera√ß√µes\", \"automa√ß√£o inteligente\"\n- JUR√çDICO: \"parecer favor√°vel\", \"caso de sucesso\", \"estrat√©gia vencedora\"\n- EDUCA√á√ÉO: \"metodologia comprovada\", \"evolu√ß√£o constante\", \"nota m√°xima\"\n- VAREJO: \"convers√£o recorde\", \"ticket m√©dio alto\", \"experi√™ncia premium\"\n- IMOBILI√ÅRIO: \"localiza√ß√£o premium\", \"valoriza√ß√£o garantida\", \"chave na m√£o\"\n- FINANCEIRO: \"ROI garantido\", \"rendimento acima da m√©dia\", \"patrim√¥nio protegido\"\n- ESPORTE: \"refor√ßo para o time\", \"jogada estrat√©gica\", \"gol de placa\"\n\n### CAMADA 3: PORTE E CARGO\nAdaptar tom baseado no porte da empresa e cargo do decisor.\n\nPorte:\n- MICRO (1-9): tom direto, pr√°tico, \"fazer mais com menos\"\n- PEQUENA (10-49): tom consultivo, \"escalar opera√ß√£o\"\n- M√âDIA (50-249): tom estrat√©gico, \"efici√™ncia operacional\"\n- GRANDE (250+): tom executivo, \"transforma√ß√£o digital\"\n\nCargo:\n- DONO/S√ìCIO: foco em lucro, tempo, crescimento\n- DIRETOR/C-LEVEL: foco em ROI, m√©tricas, estrat√©gia\n- GERENTE: foco em equipe, processos, metas\n\n---\n\n## MODOS DE OPERA√á√ÉO DISPON√çVEIS\n\nIdentifique quais modos o cliente precisa:\n\n1. **first_contact** - Primeiro contato com lead frio\n2. **scheduler** - Agendar reuni√µes/consultas\n3. **rescheduler** - Recuperar no-shows\n4. **concierge** - P√≥s-agendamento (lembrar reuni√£o)\n5. **customer_success** - P√≥s-reuni√£o (fechar venda)\n6. **objection_handler** - Lidar com obje√ß√µes espec√≠ficas\n7. **followuper** - Reativar leads frios\n\n---\n\n## OUTPUT JSON OBRIGAT√ìRIO\n\nRetorne APENAS o JSON abaixo (sem markdown, sem texto adicional):\n\n```json\n{\n  \"business_context\": {\n    \"nome_negocio\": \"string - USAR {{ $json.nome_lead }} OU nome extra√≠do da transcri√ß√£o\",\n    \"tipo_negocio\": \"string\",\n    \"servicos_produtos\": [\"array\"],\n    \"faixa_precos\": {\n      \"minimo\": \"string ou null\",\n      \"maximo\": \"string ou null\",\n      \"pode_revelar\": true/false\n    },\n    \"diferenciais\": [\"array\"],\n    \"publico_alvo\": \"string\",\n    \"localizacao\": \"string ou null\",\n    \"horario_funcionamento\": \"string ou null\"\n  },\n  \"hiperpersonalizacao_config\": {\n    \"setor\": \"saude|tech|juridico|educacao|varejo|imobiliario|financeiro|esporte|geral\",\n    \"analogias_setor\": [\"array de 5-6 analogias espec√≠ficas\"],\n    \"ddds_atuacao\": [\"array de DDDs principais\"],\n    \"frases_por_ddd\": {\n      \"11\": \"frase personalizada para SP\",\n      \"21\": \"frase personalizada para RJ\"\n    },\n    \"porte_clientes\": \"micro|pequena|media|grande|enterprise\",\n    \"cargos_decisores\": [\"array\"],\n    \"tom_recomendado\": \"string descritivo\"\n  },\n  \"compliance_rules\": {\n    \"proibicoes\": [\"array do que N√ÉO pode fazer - use verbos no infinitivo\"],\n    \"limites_autonomia\": [\"array\"],\n    \"gatilhos_escalacao\": [\"array de quando escalar para humano\"],\n    \"informacoes_confidenciais\": [\"array\"]\n  },\n  \"personality_config\": {\n    \"nome_agente\": \"string ou null\",\n    \"tom\": \"formal|informal|acolhedor|tecnico|consultivo\",\n    \"caracteristicas\": [\"array de 3-5 caracter√≠sticas\"],\n    \"anti_persona\": [\"array do que N√ÉO ser\"],\n    \"palavras_usar\": [\"array\"],\n    \"palavras_evitar\": [\"array\"],\n    \"emoji_por_mensagem\": 0|1\n  },\n  \"modos_identificados\": [\"array dos modos necess√°rios\"],\n  \"prompts_por_modo\": {\n    \"first_contact\": \"### PERSONA E CONTEXTO ###\\nVoce e [nome], assistente da [USAR NOME CORRETO DO CLIENTE].\\n\\n### OBJETIVO PRIMARIO ###\\n[objetivo espec√≠fico]\\n\\n### PROTOCOLO DE CONDUCAO ###\\n1. Saudar com nome {{contact.first_name}}\\n2. [passos]\\n\\n### GUARDRAILS ###\\n[regras]\\n\\n### FEW-SHOT TRAINING ###\\nQ: [exemplo]\\nA: [resposta ideal]\",\n    \"scheduler\": \"[prompt do modo scheduler]\"\n  },\n  \"few_shot_global\": [\n    {\n      \"cenario\": \"saudacao\",\n      \"input\": \"Oi, tudo bem?\",\n      \"output\": \"resposta ideal\"\n    },\n    {\n      \"cenario\": \"objecao_preco\",\n      \"input\": \"Quanto custa?\",\n      \"output\": \"resposta ideal\"\n    },\n    {\n      \"cenario\": \"objecao_tempo\",\n      \"input\": \"N√£o tenho tempo agora\",\n      \"output\": \"resposta ideal\"\n    },\n    {\n      \"cenario\": \"fora_escopo\",\n      \"input\": \"Voc√™s fazem X?\",\n      \"output\": \"resposta ideal\"\n    },\n    {\n      \"cenario\": \"resposta_curta\",\n      \"input\": \"ok\",\n      \"output\": \"resposta que avan√ßa para CTA\"\n    }\n  ],\n  \"observacoes\": {\n    \"pontos_atencao\": [\"array\"],\n    \"riscos\": [\"array\"],\n    \"sugestoes_melhoria\": [\"array\"]\n  },\n  \"confianca_extracao\": {\n    \"score\": 0-100,\n    \"campos_incertos\": [\"array de campos com pouca info\"]\n  },\n  \"resumo_executivo\": \"2-3 frases resumindo o cliente e configura√ß√£o\"\n}\n```\n\n---\n\n## REGRAS CR√çTICAS\n\n1. **INSTRU√á√ïES AFIRMATIVAS**: Em vez de \"N√£o seja rude\", use \"Seja acolhedor e emp√°tico\"\n2. **META √öNICA**: Cada modo tem UM objetivo claro e mensur√°vel\n3. **PREVEN√á√ÉO DE LOOP**: Sempre incluir \"Se resposta curta, avance imediatamente\"\n4. **FEW-SHOT OBRIGAT√ìRIO**: M√≠nimo 5 exemplos por modo\n5. **VARIAVEIS DINAMICAS**: Use APENAS {{contact.first_name}} ou {{contact.name}} para nome do lead. NAO use placeholders genericos como [nome] ou variaveis que nao existem\n6. **ESCALA√á√ÉO**: Sempre ter rota para humano\n7. **JSON V√ÅLIDO**: Retorne APENAS JSON, sem markdown ou texto\n8. **NOME DO NEG√ìCIO**: O campo nome_negocio DEVE ser \"{{ $json.nome_lead }}\" ou extra√≠do LITERALMENTE da transcri√ß√£o - NUNCA invente nomes"
  },

  "new_node_1_8": {
    "_comentario": "NOVO N√ì - Adicionar entre 1.7 e 2.1",
    "parameters": {
      "mode": "runOnceForAllItems",
      "jsCode": "// =====================================================\n// N√ì 1.8 - VALIDAR OUTPUT E CORRIGIR ALUCINA√á√ïES\n// Detecta quando a IA \"inventou\" dados de outro cliente\n// =====================================================\n\n// Buscar dados do n√≥ 1.6 (dados originais do cliente)\nlet dadosInput = {};\ntry {\n  const items16 = $('1.6 Preparar Dados').all();\n  if (items16 && items16.length > 0) {\n    dadosInput = items16[0].json;\n  }\n} catch (e) {\n  // Fallback: tentar buscar de outros n√≥s poss√≠veis\n  try {\n    const itemsPreparar = $('Preparar Dados').all();\n    if (itemsPreparar && itemsPreparar.length > 0) {\n      dadosInput = itemsPreparar[0].json;\n    }\n  } catch (e2) {\n    console.log('Aviso: N√£o foi poss√≠vel buscar dados do n√≥ 1.6');\n  }\n}\n\n// Resposta da IA (n√≥ anterior - 1.7)\nconst respostaIA = $input.first().json;\n\n// Dados esperados do cliente real\nconst nomeLeadEsperado = dadosInput.nome_lead || dadosInput.name || dadosInput.contactName || '';\nconst telefoneEsperado = dadosInput.telefone_lead || dadosInput.phone || '';\nconst textoTranscricao = dadosInput.texto_transcricao || dadosInput.transcription || '';\n\n// Output da IA\nlet outputText = respostaIA.output || respostaIA.text || respostaIA.message || '';\n\n// Se output for objeto, converter para string\nif (typeof outputText === 'object') {\n  outputText = JSON.stringify(outputText);\n}\n\n// ========== LISTA DE CLIENTES CONHECIDOS (ANTI-ALUCINA√á√ÉO) ==========\n// Nomes que a IA N√ÉO deveria inventar para outros clientes\n// IMPORTANTE: Adicionar novos nomes conforme detectar alucina√ß√µes\nconst CLIENTES_CONHECIDOS = [\n  'Dra. Eline Lobo',\n  'Eline Lobo',\n  'Dra Eline',\n  'Cl√≠nica da Dra. Eline',\n  'Cl√≠nica Eline Lobo',\n  'Dr. Jo√£o Silva',\n  'Jo√£o Silva',\n  'Cl√≠nica Premium',\n  'Dra. Maria',\n  'Dr. Carlos',\n  'Cl√≠nica Exemplo',\n  'Dr. Exemplo',\n  'Cl√≠nica Modelo',\n  'Dra. Ana Paula',\n  'Dr. Roberto',\n  'Cl√≠nica Sa√∫de Total',\n  'Instituto Beleza',\n  'Centro M√©dico ABC',\n  // Adicionar mais conforme detectar novas alucina√ß√µes\n];\n\n// ========== FUN√á√ïES AUXILIARES ==========\n\nfunction extrairCampoJSON(texto, campo) {\n  try {\n    // Tentar m√∫ltiplos padr√µes de regex\n    const patterns = [\n      new RegExp(`\"${campo}\"\\\\s*:\\\\s*\"([^\"]+)\"`, 'i'),\n      new RegExp(`'${campo}'\\\\s*:\\\\s*'([^']+)'`, 'i'),\n      new RegExp(`${campo}\\\\s*:\\\\s*\"([^\"]+)\"`, 'i'),\n    ];\n    \n    for (const regex of patterns) {\n      const match = texto.match(regex);\n      if (match) return match[1];\n    }\n    return null;\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction substituirCampoJSON(texto, campo, novoValor) {\n  try {\n    // Escapar caracteres especiais no novo valor\n    const valorEscapado = novoValor.replace(/\"/g, '\\\\\"');\n    \n    // Tentar m√∫ltiplos padr√µes\n    const patterns = [\n      { regex: new RegExp(`(\"${campo}\"\\\\s*:\\\\s*)\"([^\"]+)\"`, 'gi'), replacement: `$1\"${valorEscapado}\"` },\n      { regex: new RegExp(`('${campo}'\\\\s*:\\\\s*)'([^']+)'`, 'gi'), replacement: `$1'${valorEscapado}'` },\n    ];\n    \n    let resultado = texto;\n    for (const p of patterns) {\n      resultado = resultado.replace(p.regex, p.replacement);\n    }\n    return resultado;\n  } catch (e) {\n    return texto;\n  }\n}\n\nfunction normalizarNome(nome) {\n  if (!nome) return '';\n  return nome.toLowerCase()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') // Remove acentos\n    .replace(/[^a-z0-9\\s]/g, '') // Remove caracteres especiais\n    .replace(/\\s+/g, ' ') // Normaliza espa√ßos\n    .trim();\n}\n\nfunction calcularSimilaridade(str1, str2) {\n  const s1 = normalizarNome(str1);\n  const s2 = normalizarNome(str2);\n\n  if (!s1 || !s2) return 0;\n  if (s1 === s2) return 1;\n  if (s1.includes(s2) || s2.includes(s1)) return 0.8;\n\n  const palavras1 = s1.split(/\\s+/).filter(p => p.length > 2);\n  const palavras2 = s2.split(/\\s+/).filter(p => p.length > 2);\n\n  if (palavras1.length === 0 || palavras2.length === 0) return 0;\n\n  let comuns = 0;\n  for (const p1 of palavras1) {\n    if (palavras2.some(p2 => p2.includes(p1) || p1.includes(p2))) {\n      comuns++;\n    }\n  }\n\n  return comuns / Math.max(palavras1.length, palavras2.length);\n}\n\n// ========== VALIDA√á√ÉO PRINCIPAL ==========\n\nconst validacao = {\n  passou: true,\n  alertas: [],\n  correcoes: [],\n  alucinacao_detectada: false,\n  nome_ia: null,\n  nome_esperado: nomeLeadEsperado,\n  similaridade: 0,\n  timestamp: new Date().toISOString()\n};\n\n// 1. Extrair nome_negocio do output da IA\nconst nomeNegocioIA = extrairCampoJSON(outputText, 'nome_negocio');\nvalidacao.nome_ia = nomeNegocioIA;\n\nif (nomeNegocioIA) {\n\n  // 2. Verificar se √© um nome de OUTRO cliente (alucina√ß√£o clara)\n  for (const clienteConhecido of CLIENTES_CONHECIDOS) {\n    const nomeNormalizado = normalizarNome(nomeNegocioIA);\n    const clienteNormalizado = normalizarNome(clienteConhecido);\n\n    // Verificar se o nome gerado cont√©m um cliente conhecido\n    if (nomeNormalizado.includes(clienteNormalizado) || clienteNormalizado.includes(nomeNormalizado)) {\n      // Verificar se n√£o √© realmente o cliente atual\n      const leadNormalizado = normalizarNome(nomeLeadEsperado);\n      \n      if (!leadNormalizado.includes(clienteNormalizado) && !clienteNormalizado.includes(leadNormalizado)) {\n        validacao.alucinacao_detectada = true;\n        validacao.passou = false;\n        validacao.alertas.push({\n          tipo: 'ALUCINACAO_CRITICA',\n          severidade: 'ALTA',\n          mensagem: `IA gerou \"${nomeNegocioIA}\" mas cliente real √© \"${nomeLeadEsperado}\"`,\n          cliente_inventado: nomeNegocioIA,\n          cliente_real: nomeLeadEsperado,\n          cliente_detectado: clienteConhecido,\n          timestamp: new Date().toISOString()\n        });\n\n        // CORRIGIR automaticamente\n        outputText = substituirCampoJSON(outputText, 'nome_negocio', nomeLeadEsperado);\n        validacao.correcoes.push({\n          campo: 'nome_negocio',\n          valor_errado: nomeNegocioIA,\n          valor_corrigido: nomeLeadEsperado,\n          motivo: 'Alucina√ß√£o detectada - nome de outro cliente conhecido'\n        });\n\n        break;\n      }\n    }\n  }\n\n  // 3. Verificar similaridade entre nome da IA e nome esperado\n  if (!validacao.alucinacao_detectada) {\n    validacao.similaridade = calcularSimilaridade(nomeNegocioIA, nomeLeadEsperado);\n\n    if (validacao.similaridade < 0.15) {\n      // Nomes muito diferentes - poss√≠vel alucina√ß√£o\n      validacao.alertas.push({\n        tipo: 'BAIXA_SIMILARIDADE',\n        severidade: 'MEDIA',\n        mensagem: `Nome da IA \"${nomeNegocioIA}\" tem similaridade ${(validacao.similaridade * 100).toFixed(1)}% com \"${nomeLeadEsperado}\"`,\n        similaridade: validacao.similaridade\n      });\n\n      // Verificar se nome da IA aparece na transcri√ß√£o\n      if (textoTranscricao) {\n        const transcricaoNormalizada = normalizarNome(textoTranscricao);\n        const nomeParcial = normalizarNome(nomeNegocioIA).substring(0, 15);\n        const nomeNaTranscricao = transcricaoNormalizada.includes(nomeParcial);\n\n        if (!nomeNaTranscricao) {\n          validacao.alucinacao_detectada = true;\n          validacao.passou = false;\n          validacao.alertas.push({\n            tipo: 'NOME_NAO_NA_TRANSCRICAO',\n            severidade: 'ALTA',\n            mensagem: `\"${nomeNegocioIA}\" n√£o aparece na transcri√ß√£o - prov√°vel alucina√ß√£o`,\n            acao: 'Corrigido automaticamente para nome do input'\n          });\n\n          // CORRIGIR automaticamente\n          outputText = substituirCampoJSON(outputText, 'nome_negocio', nomeLeadEsperado);\n          validacao.correcoes.push({\n            campo: 'nome_negocio',\n            valor_errado: nomeNegocioIA,\n            valor_corrigido: nomeLeadEsperado,\n            motivo: 'Nome n√£o encontrado na transcri√ß√£o'\n          });\n        }\n      }\n    }\n  }\n} else if (nomeLeadEsperado) {\n  // Nome n√£o encontrado no output - adicionar alerta\n  validacao.alertas.push({\n    tipo: 'CAMPO_NAO_ENCONTRADO',\n    severidade: 'BAIXA',\n    mensagem: 'Campo nome_negocio n√£o encontrado no output da IA',\n    sugestao: 'Verificar se o formato do output est√° correto'\n  });\n}\n\n// 4. Se houve alucina√ß√£o, verificar outros campos que podem estar contaminados\nif (validacao.alucinacao_detectada) {\n  const camposParaVerificar = ['nome_agente', 'empresa', 'clinica', 'negocio'];\n  \n  for (const campo of camposParaVerificar) {\n    const valorCampo = extrairCampoJSON(outputText, campo);\n    if (valorCampo) {\n      // Verificar se cont√©m nome de cliente conhecido errado\n      for (const clienteConhecido of CLIENTES_CONHECIDOS) {\n        if (normalizarNome(valorCampo).includes(normalizarNome(clienteConhecido))) {\n          const leadNormalizado = normalizarNome(nomeLeadEsperado);\n          if (!leadNormalizado.includes(normalizarNome(clienteConhecido))) {\n            validacao.alertas.push({\n              tipo: 'CONTAMINACAO_CAMPO',\n              severidade: 'MEDIA',\n              mensagem: `Campo \"${campo}\" tamb√©m pode estar contaminado com \"${valorCampo}\"`,\n              campo: campo,\n              valor: valorCampo,\n              sugestao: 'Verificar manualmente se faz sentido para o cliente correto'\n            });\n            break;\n          }\n        }\n      }\n    }\n  }\n}\n\n// 5. Verificar nome_agente especificamente\nconst nomeAgente = extrairCampoJSON(outputText, 'nome_agente');\nif (nomeAgente && validacao.alucinacao_detectada) {\n  validacao.alertas.push({\n    tipo: 'VERIFICAR_MANUALMENTE',\n    severidade: 'BAIXA',\n    mensagem: `Ap√≥s corre√ß√£o, verificar se nome_agente \"${nomeAgente}\" ainda faz sentido`,\n    campo: 'nome_agente',\n    valor: nomeAgente,\n    sugestao: 'O nome do agente pode ser mantido ou regenerado'\n  });\n}\n\n// ========== LOG PARA MONITORAMENTO ==========\nconsole.log('');\nconsole.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë         VALIDA√á√ÉO ANTI-ALUCINA√á√ÉO - N√ì 1.8                  ‚ïë');\nconsole.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');\nconsole.log(`‚ïë Timestamp: ${new Date().toISOString()}`);\nconsole.log(`‚ïë Cliente esperado: \"${nomeLeadEsperado}\"`);\nconsole.log(`‚ïë Nome gerado pela IA: \"${nomeNegocioIA || 'N√ÉO ENCONTRADO'}\"`);\nconsole.log(`‚ïë Similaridade: ${(validacao.similaridade * 100).toFixed(1)}%`);\nconsole.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');\n\nif (validacao.alucinacao_detectada) {\n  console.log('‚ïë ‚ö†Ô∏è  ALUCINA√á√ÉO DETECTADA E CORRIGIDA!                        ‚ïë');\n} else {\n  console.log('‚ïë ‚úÖ Nenhuma alucina√ß√£o detectada                              ‚ïë');\n}\n\nconsole.log(`‚ïë Corre√ß√µes aplicadas: ${validacao.correcoes.length}`);\nconsole.log(`‚ïë Alertas gerados: ${validacao.alertas.length}`);\n\nif (validacao.alertas.length > 0) {\n  console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');\n  console.log('‚ïë ALERTAS:');\n  validacao.alertas.forEach((a, i) => {\n    console.log(`‚ïë  ${i + 1}. [${a.tipo}] ${a.mensagem.substring(0, 50)}...`);\n  });\n}\n\nif (validacao.correcoes.length > 0) {\n  console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');\n  console.log('‚ïë CORRE√á√ïES:');\n  validacao.correcoes.forEach((c, i) => {\n    console.log(`‚ïë  ${i + 1}. ${c.campo}: \"${c.valor_errado.substring(0, 20)}...\" ‚Üí \"${c.valor_corrigido.substring(0, 20)}...\"`);\n  });\n}\n\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log('');\n\n// ========== RETORNO ==========\nreturn [{\n  json: {\n    // Manter todos os dados originais da resposta da IA\n    ...respostaIA,\n    // Substituir o output pelo corrigido (se houve corre√ß√£o)\n    output: outputText,\n    // Metadados da valida√ß√£o\n    _validacao_alucinacao: validacao,\n    _dados_input_original: {\n      nome_lead: nomeLeadEsperado,\n      telefone: telefoneEsperado,\n      tinha_transcricao: textoTranscricao.length > 0\n    },\n    _processado_em: new Date().toISOString(),\n    _versao_validador: '1.0.0'\n  }\n}];"
    },
    "id": "node-1-8-validar-alucinacao",
    "name": "1.8 Validar Alucina√ß√£o",
    "type": "n8n-nodes-base.code",
    "typeVersion": 2,
    "position": [13784, 1088],
    "notesInFlow": true,
    "notes": "ANTI-ALUCINA√á√ÉO: Detecta se a IA gerou dados de outro cliente e corrige automaticamente."
  },

  "patch_groq": {
    "_comentario": "Alterar no n√≥ 'Groq Llama 3.3 70B'",
    "options": {
      "temperature": 0.1
    }
  },

  "new_connections": {
    "_comentario": "Substituir conex√µes do n√≥ 1.7",
    "1.7 AI - Analisar Kickoff (GHL Architect V2)": {
      "main": [
        [
          {
            "node": "1.8 Validar Alucina√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.8 Validar Alucina√ß√£o": {
      "main": [
        [
          {
            "node": "2.1 Processar An√°lise + Hiperpersonaliza√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },

  "instrucoes_aplicacao_manual": {
    "passo_1": {
      "descricao": "Abrir o arquivo 10-AI-Factory-V3-Unified.json",
      "acao": "Fazer backup antes de modificar"
    },
    "passo_2": {
      "descricao": "Encontrar n√≥ 1.7 AI - Analisar Kickoff",
      "acao": "Linha ~320, substituir campo 'text' pelo valor de patch_node_1_7.text"
    },
    "passo_3": {
      "descricao": "No mesmo n√≥ 1.7",
      "acao": "Substituir campo 'systemMessage' pelo valor de patch_node_1_7.systemMessage"
    },
    "passo_4": {
      "descricao": "Adicionar novo n√≥ 1.8",
      "acao": "Copiar o objeto completo de new_node_1_8 para o array 'nodes'"
    },
    "passo_5": {
      "descricao": "Encontrar n√≥ Groq Llama 3.3 70B",
      "acao": "Linha ~336, mudar temperature de 0.3 para 0.1"
    },
    "passo_6": {
      "descricao": "Atualizar conex√µes",
      "acao": "Na se√ß√£o 'connections', substituir as conex√µes conforme new_connections"
    },
    "passo_7": {
      "descricao": "Testar",
      "acao": "Executar workflow com transcri√ß√£o do 'Dr Luiz e Mariana' e verificar se output est√° correto"
    }
  }
}

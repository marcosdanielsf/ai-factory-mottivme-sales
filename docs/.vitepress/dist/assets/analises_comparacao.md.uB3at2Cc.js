import{_ as t,c as n,o as e,ag as a,j as s}from"./chunks/framework.dvv-DFtf.js";const c=JSON.parse('{"title":"RELATÓRIO DE ANÁLISE DE BANCO DE DADOS","description":"","frontmatter":{},"headers":[],"relativePath":"analises/comparacao.md","filePath":"analises/comparacao.md"}'),l={name:"analises/comparacao.md"};function p(d,i,h,k,r,o){return e(),n("div",null,[...i[0]||(i[0]=[a(`<h1 id="relatorio-de-analise-de-banco-de-dados" tabindex="-1">RELATÓRIO DE ANÁLISE DE BANCO DE DADOS <a class="header-anchor" href="#relatorio-de-analise-de-banco-de-dados" aria-label="Permalink to &quot;RELATÓRIO DE ANÁLISE DE BANCO DE DADOS&quot;">​</a></h1><h2 id="comparacao-agenticos-vs-ai-factory" tabindex="-1">Comparação: AgenticOS vs AI-Factory <a class="header-anchor" href="#comparacao-agenticos-vs-ai-factory" aria-label="Permalink to &quot;Comparação: AgenticOS vs AI-Factory&quot;">​</a></h2><p><strong>Data</strong>: 2026-01-01 <strong>Analista</strong>: Database Engineer Agent <strong>Objetivo</strong>: Documentar modelos de dados e identificar possibilidades de integração</p><hr><h2 id="sumario-executivo" tabindex="-1">SUMÁRIO EXECUTIVO <a class="header-anchor" href="#sumario-executivo" aria-label="Permalink to &quot;SUMÁRIO EXECUTIVO&quot;">​</a></h2><h3 id="agenticos-kev-s-academy" tabindex="-1">AgenticOS (Kev&#39;s Academy) <a class="header-anchor" href="#agenticos-kev-s-academy" aria-label="Permalink to &quot;AgenticOS (Kev&#39;s Academy)&quot;">​</a></h3><ul><li><strong>Foco</strong>: Sistema multi-agent de automação de Instagram DM e Lead Generation</li><li><strong>Arquitetura</strong>: Multi-tenant SaaS com versionamento de personas</li><li><strong>Database</strong>: Supabase PostgreSQL</li><li><strong>Principais features</strong>: Lead classification com IA, auto-resposta, ICP versionado</li></ul><h3 id="ai-factory-mottivme" tabindex="-1">AI-Factory (MOTTIVME) <a class="header-anchor" href="#ai-factory-mottivme" aria-label="Permalink to &quot;AI-Factory (MOTTIVME)&quot;">​</a></h3><ul><li><strong>Foco</strong>: Sistema de auto-melhoramento de agentes de IA</li><li><strong>Arquitetura</strong>: Reflection Loop + AI-as-Judge para evolução de prompts</li><li><strong>Database</strong>: Supabase PostgreSQL</li><li><strong>Principais features</strong>: Versionamento de prompts, análise de QA, sugestões de melhoria</li></ul><h3 id="compatibilidade" tabindex="-1">Compatibilidade <a class="header-anchor" href="#compatibilidade" aria-label="Permalink to &quot;Compatibilidade&quot;">​</a></h3><p>✅ <strong>Alta compatibilidade</strong>: Ambos usam Supabase PostgreSQL ✅ <strong>Padrões similares</strong>: UUID PKs, timestamps, RLS, triggers ✅ <strong>Potencial de integração</strong>: Classificação de leads + Self-improving agents</p><hr><h2 id="_1-agentios-modelo-de-dados" tabindex="-1">1. AGENTIOS - MODELO DE DADOS <a class="header-anchor" href="#_1-agentios-modelo-de-dados" aria-label="Permalink to &quot;1. AGENTIOS - MODELO DE DADOS&quot;">​</a></h2><h3 id="_1-1-schema-principal-multi-tenant-lead-generation" tabindex="-1">1.1 Schema Principal: MULTI-TENANT LEAD GENERATION <a class="header-anchor" href="#_1-1-schema-principal-multi-tenant-lead-generation" aria-label="Permalink to &quot;1.1 Schema Principal: MULTI-TENANT LEAD GENERATION&quot;">​</a></h3><h4 id="tabela-tenants" tabindex="-1">Tabela: <code>tenants</code> <a class="header-anchor" href="#tabela-tenants" aria-label="Permalink to &quot;Tabela: \`tenants\`&quot;">​</a></h4><p><strong>Propósito</strong>: Gerenciamento de clientes do SaaS (multi-tenancy)</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK, tenant único</td></tr><tr><td><code>name</code></td><td>TEXT</td><td>Nome do cliente (&quot;Socialfy&quot;)</td></tr><tr><td><code>slug</code></td><td>TEXT</td><td>URL-friendly identifier</td></tr><tr><td><code>business_type</code></td><td>TEXT</td><td>Tipo de negócio</td></tr><tr><td><code>status</code></td><td>TEXT</td><td>trial, active, paused, cancelled</td></tr><tr><td><code>plan_tier</code></td><td>TEXT</td><td>basic, pro, enterprise</td></tr><tr><td><code>max_leads_per_month</code></td><td>INTEGER</td><td>Limite por plano</td></tr><tr><td><code>max_auto_responses_per_day</code></td><td>INTEGER</td><td>Limite de respostas automáticas</td></tr><tr><td><code>timezone</code></td><td>TEXT</td><td>Timezone do cliente</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td>Timestamp de criação</td></tr><tr><td><code>updated_at</code></td><td>TIMESTAMPTZ</td><td>Timestamp de atualização</td></tr></tbody></table><p><strong>Índices</strong>:</p><ul><li><code>idx_tenants_slug</code> em <code>slug</code></li><li><code>idx_tenants_status</code> em <code>status</code></li></ul><p><strong>RLS</strong>: Ativo (tenant isolation)</p><hr><h4 id="tabela-tenant-personas-icp-versionado" tabindex="-1">Tabela: <code>tenant_personas</code> (ICP Versionado) <a class="header-anchor" href="#tabela-tenant-personas-icp-versionado" aria-label="Permalink to &quot;Tabela: \`tenant_personas\` (ICP Versionado)&quot;">​</a></h4><p><strong>Propósito</strong>: Definição de Ideal Customer Profile com versionamento</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK</td></tr><tr><td><code>tenant_id</code></td><td>UUID</td><td>FK → tenants(id)</td></tr><tr><td><code>version</code></td><td>INTEGER</td><td>Versão da persona (1, 2, 3...)</td></tr><tr><td><code>is_active</code></td><td>BOOLEAN</td><td>Apenas 1 versão ativa por tenant</td></tr><tr><td><code>business_type</code></td><td>TEXT</td><td>&quot;agência de marketing digital&quot;</td></tr><tr><td><code>target_audience</code></td><td>TEXT</td><td>Público-alvo do negócio</td></tr><tr><td><code>product_service</code></td><td>TEXT</td><td>Produto/serviço oferecido</td></tr><tr><td><code>value_proposition</code></td><td>TEXT</td><td>Proposta de valor</td></tr><tr><td><code>main_pain_points</code></td><td>TEXT[]</td><td>Dores que resolve</td></tr><tr><td><code>solutions_offered</code></td><td>TEXT[]</td><td>Soluções oferecidas</td></tr><tr><td><code>ideal_niches</code></td><td>TEXT[]</td><td>[&quot;marketing&quot;, &quot;vendas&quot;, &quot;tech&quot;]</td></tr><tr><td><code>ideal_job_titles</code></td><td>TEXT[]</td><td>[&quot;CEO&quot;, &quot;Founder&quot;, &quot;CMO&quot;]</td></tr><tr><td><code>ideal_business_types</code></td><td>TEXT[]</td><td>[&quot;agência&quot;, &quot;consultoria&quot;, &quot;SaaS&quot;]</td></tr><tr><td><code>min_followers</code></td><td>INTEGER</td><td>Filtro Instagram (1000)</td></tr><tr><td><code>max_followers</code></td><td>INTEGER</td><td>Filtro Instagram (100000)</td></tr><tr><td><code>positive_keywords</code></td><td>TEXT[]</td><td>Keywords para classificação</td></tr><tr><td><code>negative_keywords</code></td><td>TEXT[]</td><td>Keywords de desqualificação</td></tr><tr><td><code>brand_voice</code></td><td>TEXT</td><td>Tom de voz da marca</td></tr><tr><td><code>message_style</code></td><td>TEXT</td><td>Estilo de mensagem</td></tr><tr><td><code>ai_classification_prompt</code></td><td>TEXT</td><td>Prompt customizado para IA</td></tr><tr><td><code>ai_response_prompt</code></td><td>TEXT</td><td>Prompt para auto-resposta</td></tr><tr><td><code>leads_classified</code></td><td>INTEGER</td><td>Contador de performance</td></tr><tr><td><code>conversion_rate</code></td><td>DECIMAL(5,2)</td><td>Taxa de conversão</td></tr><tr><td><code>avg_icp_score</code></td><td>DECIMAL(5,2)</td><td>Score médio</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>activated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>deactivated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr></tbody></table><p><strong>Índices</strong>:</p><ul><li><code>idx_personas_tenant</code> em <code>(tenant_id, version DESC)</code></li><li><code>idx_personas_active</code> em <code>(tenant_id, is_active)</code> WHERE <code>is_active = true</code></li><li><code>idx_personas_positive_kw</code> GIN em <code>positive_keywords</code></li><li><code>idx_personas_negative_kw</code> GIN em <code>negative_keywords</code></li></ul><p><strong>Triggers</strong>:</p><ul><li><code>trigger_single_active_persona</code>: Garante apenas 1 persona ativa por tenant</li></ul><p><strong>Constraint</strong>:</p><ul><li>UNIQUE <code>(tenant_id, version)</code></li></ul><p><strong>Padrão de Versionamento</strong>:</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Criar nova versão:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas (tenant_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, is_active, ...)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tenant_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, true, ...)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Trigger desativa automaticamente version 1</span></span></code></pre></div><hr><h4 id="tabela-tenant-known-contacts-whitelist" tabindex="-1">Tabela: <code>tenant_known_contacts</code> (Whitelist) <a class="header-anchor" href="#tabela-tenant-known-contacts-whitelist" aria-label="Permalink to &quot;Tabela: \`tenant_known_contacts\` (Whitelist)&quot;">​</a></h4><p><strong>Propósito</strong>: Bypass de classificação para contatos conhecidos</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK</td></tr><tr><td><code>tenant_id</code></td><td>UUID</td><td>FK → tenants(id)</td></tr><tr><td><code>platform</code></td><td>TEXT</td><td>instagram, whatsapp, telegram</td></tr><tr><td><code>username</code></td><td>TEXT</td><td>@username ou telefone</td></tr><tr><td><code>full_name</code></td><td>TEXT</td><td>Nome completo</td></tr><tr><td><code>contact_type</code></td><td>TEXT</td><td>amigo, familia, socio, cliente, fornecedor</td></tr><tr><td><code>notes</code></td><td>TEXT</td><td>Notas adicionais</td></tr><tr><td><code>tags</code></td><td>TEXT[]</td><td>Tags customizadas</td></tr><tr><td><code>auto_classify_as</code></td><td>TEXT</td><td>PESSOAL, CLIENTE_VIP</td></tr><tr><td><code>skip_ai_analysis</code></td><td>BOOLEAN</td><td>Economiza créditos de IA</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>updated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr></tbody></table><p><strong>Constraint</strong>:</p><ul><li>UNIQUE <code>(tenant_id, platform, username)</code></li></ul><p><strong>Índices</strong>:</p><ul><li><code>idx_known_contacts_tenant</code> em <code>tenant_id</code></li><li><code>idx_known_contacts_username</code> em <code>username</code></li><li><code>idx_known_contacts_type</code> em <code>contact_type</code></li></ul><hr><h4 id="tabela-classified-leads" tabindex="-1">Tabela: <code>classified_leads</code> <a class="header-anchor" href="#tabela-classified-leads" aria-label="Permalink to &quot;Tabela: \`classified_leads\`&quot;">​</a></h4><p><strong>Propósito</strong>: Leads classificados pela IA com scoring</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK</td></tr><tr><td><code>tenant_id</code></td><td>UUID</td><td>FK → tenants(id)</td></tr><tr><td><code>persona_version</code></td><td>INTEGER</td><td>Versão da persona usada</td></tr><tr><td><code>known_contact_id</code></td><td>UUID</td><td>FK → tenant_known_contacts(id)</td></tr><tr><td><code>platform</code></td><td>TEXT</td><td>instagram, whatsapp, etc</td></tr><tr><td><code>username</code></td><td>TEXT</td><td>Username do lead</td></tr><tr><td><code>full_name</code></td><td>TEXT</td><td>Nome completo</td></tr><tr><td><code>message_text</code></td><td>TEXT</td><td>Mensagem recebida</td></tr><tr><td><code>message_timestamp</code></td><td>TIMESTAMPTZ</td><td>Timestamp da mensagem</td></tr><tr><td><code>conversation_context</code></td><td>JSONB</td><td>Histórico de mensagens</td></tr><tr><td><code>profile_data</code></td><td>JSONB</td><td>Bio, followers, posts, etc</td></tr><tr><td><code>ai_analysis</code></td><td>JSONB</td><td>Análise completa da IA</td></tr><tr><td><code>classification</code></td><td>TEXT</td><td>LEAD_HOT, LEAD_WARM, LEAD_COLD, PESSOAL, SPAM</td></tr><tr><td><code>icp_score</code></td><td>INTEGER</td><td>0-100 (match com ICP)</td></tr><tr><td><code>confidence</code></td><td>DECIMAL(3,2)</td><td>0.00-1.00 (confiança da IA)</td></tr><tr><td><code>score_breakdown</code></td><td>JSONB</td><td>Breakdown detalhado do score</td></tr><tr><td><code>auto_responded</code></td><td>BOOLEAN</td><td>Se enviou resposta automática</td></tr><tr><td><code>response_sent</code></td><td>TEXT</td><td>Resposta enviada</td></tr><tr><td><code>response_timestamp</code></td><td>TIMESTAMPTZ</td><td>Quando enviou</td></tr><tr><td><code>response_status</code></td><td>TEXT</td><td>sent, failed, pending, skipped</td></tr><tr><td><code>converted_to_opportunity</code></td><td>BOOLEAN</td><td>Se virou oportunidade</td></tr><tr><td><code>opportunity_created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>final_outcome</code></td><td>TEXT</td><td>cliente, rejeitou, sem_resposta</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>updated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr></tbody></table><p><strong>Estrutura do JSONB <code>profile_data</code></strong>:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;bio&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CEO at Marketing Agency&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;followers_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;following_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;posts_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;is_verified&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;is_business&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;category&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Marketing Agency&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;website&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;recent_posts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Estrutura do JSONB <code>ai_analysis</code></strong>:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;reasoning&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Perfil indica agência de marketing com foco em B2B...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;match_keywords&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;agência&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;leads&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;marketing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;red_flags&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;qualification_signals&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tem site&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;fala de resultados&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;sentiment_analysis&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;positivo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;next_steps&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Enviar pitch direto&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Índices</strong>:</p><ul><li><code>idx_classified_leads_tenant</code> em <code>(tenant_id, created_at DESC)</code></li><li><code>idx_classified_leads_classification</code> em <code>(classification, created_at DESC)</code></li><li><code>idx_classified_leads_score</code> em <code>(icp_score DESC, created_at DESC)</code></li><li><code>idx_classified_leads_username</code> em <code>username</code></li><li><code>idx_classified_leads_persona_v</code> em <code>(tenant_id, persona_version)</code></li><li><code>idx_classified_leads_converted</code> em <code>(tenant_id, converted_to_opportunity, created_at DESC)</code></li></ul><p><strong>Constraints</strong>:</p><ul><li>UNIQUE <code>(tenant_id, platform, username, message_timestamp)</code></li><li>CHECK <code>icp_score &gt;= 0 AND icp_score &lt;= 100</code></li><li>CHECK <code>confidence &gt;= 0 AND confidence &lt;= 1</code></li><li>CHECK <code>classification IN (&#39;LEAD_HOT&#39;, &#39;LEAD_WARM&#39;, &#39;LEAD_COLD&#39;, &#39;PESSOAL&#39;, &#39;SPAM&#39;, &#39;DESQUALIFICADO&#39;)</code></li></ul><hr><h3 id="_1-2-schema-secundario-instagram-dm-automation" tabindex="-1">1.2 Schema Secundário: INSTAGRAM DM AUTOMATION <a class="header-anchor" href="#_1-2-schema-secundario-instagram-dm-automation" aria-label="Permalink to &quot;1.2 Schema Secundário: INSTAGRAM DM AUTOMATION&quot;">​</a></h3><h4 id="tabela-agentic-instagram-leads" tabindex="-1">Tabela: <code>agentic_instagram_leads</code> <a class="header-anchor" href="#tabela-agentic-instagram-leads" aria-label="Permalink to &quot;Tabela: \`agentic_instagram_leads\`&quot;">​</a></h4><p><strong>Propósito</strong>: Leads do Instagram para automação de DM</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>BIGSERIAL</td><td>PK</td></tr><tr><td><code>username</code></td><td>VARCHAR(255)</td><td>Username único</td></tr><tr><td><code>full_name</code></td><td>VARCHAR(255)</td><td>Nome completo</td></tr><tr><td><code>bio</code></td><td>TEXT</td><td>Bio do perfil</td></tr><tr><td><code>followers_count</code></td><td>INTEGER</td><td>Número de seguidores</td></tr><tr><td><code>following_count</code></td><td>INTEGER</td><td>Seguindo</td></tr><tr><td><code>is_private</code></td><td>BOOLEAN</td><td>Conta privada</td></tr><tr><td><code>is_verified</code></td><td>BOOLEAN</td><td>Verificado</td></tr><tr><td><code>profile_url</code></td><td>VARCHAR(500)</td><td>URL do perfil</td></tr><tr><td><code>source</code></td><td>VARCHAR(100)</td><td>post_like, post_comment, follower</td></tr><tr><td><code>tags</code></td><td>TEXT[]</td><td>Tags customizadas</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>updated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr></tbody></table><p><strong>Constraint</strong>:</p><ul><li>UNIQUE <code>username</code></li></ul><hr><h4 id="tabela-agentic-instagram-dm-sent" tabindex="-1">Tabela: <code>agentic_instagram_dm_sent</code> <a class="header-anchor" href="#tabela-agentic-instagram-dm-sent" aria-label="Permalink to &quot;Tabela: \`agentic_instagram_dm_sent\`&quot;">​</a></h4><p><strong>Propósito</strong>: Tracking de DMs enviadas</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>BIGSERIAL</td><td>PK</td></tr><tr><td><code>lead_id</code></td><td>BIGINT</td><td>FK → agentic_instagram_leads(id)</td></tr><tr><td><code>username</code></td><td>VARCHAR(255)</td><td>Username</td></tr><tr><td><code>message_template</code></td><td>VARCHAR(100)</td><td>Template usado</td></tr><tr><td><code>message_sent</code></td><td>TEXT</td><td>Mensagem enviada</td></tr><tr><td><code>sent_at</code></td><td>TIMESTAMPTZ</td><td>Timestamp de envio</td></tr><tr><td><code>status</code></td><td>VARCHAR(50)</td><td>sent, failed</td></tr><tr><td><code>error_message</code></td><td>TEXT</td><td>Mensagem de erro</td></tr><tr><td><code>account_used</code></td><td>VARCHAR(255)</td><td>Conta Instagram usada</td></tr></tbody></table><hr><h4 id="tabela-agentic-instagram-dm-runs" tabindex="-1">Tabela: <code>agentic_instagram_dm_runs</code> <a class="header-anchor" href="#tabela-agentic-instagram-dm-runs" aria-label="Permalink to &quot;Tabela: \`agentic_instagram_dm_runs\`&quot;">​</a></h4><p><strong>Propósito</strong>: Logs de execução dos agentes</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>BIGSERIAL</td><td>PK</td></tr><tr><td><code>started_at</code></td><td>TIMESTAMPTZ</td><td>Início da execução</td></tr><tr><td><code>ended_at</code></td><td>TIMESTAMPTZ</td><td>Fim da execução</td></tr><tr><td><code>total_leads</code></td><td>INTEGER</td><td>Total de leads processados</td></tr><tr><td><code>dms_sent</code></td><td>INTEGER</td><td>DMs enviadas</td></tr><tr><td><code>dms_failed</code></td><td>INTEGER</td><td>DMs com erro</td></tr><tr><td><code>dms_skipped</code></td><td>INTEGER</td><td>DMs puladas</td></tr><tr><td><code>status</code></td><td>VARCHAR(50)</td><td>running, completed, failed</td></tr><tr><td><code>error_log</code></td><td>TEXT</td><td>Log de erros</td></tr><tr><td><code>account_used</code></td><td>VARCHAR(255)</td><td>Conta usada</td></tr></tbody></table><hr><h3 id="_1-3-views-e-functions-do-agenticos" tabindex="-1">1.3 Views e Functions do AgenticOS <a class="header-anchor" href="#_1-3-views-e-functions-do-agenticos" aria-label="Permalink to &quot;1.3 Views e Functions do AgenticOS&quot;">​</a></h3><h4 id="view-vw-tenant-performance" tabindex="-1">View: <code>vw_tenant_performance</code> <a class="header-anchor" href="#view-vw-tenant-performance" aria-label="Permalink to &quot;View: \`vw_tenant_performance\`&quot;">​</a></h4><p><strong>Propósito</strong>: Performance de cada tenant nos últimos 30 dias</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_name,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">slug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">plan_tier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> active_persona_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> persona_version,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INTERVAL </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;30 days&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> leads_30d,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> classification </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;LEAD_HOT&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hot_leads_30d,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">icp_score</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_icp_score_30d,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> converted_to_opportunity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> conversions_30d</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants t</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_active</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> classified_leads cl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span></code></pre></div><hr><h4 id="view-vw-lead-classification-stats" tabindex="-1">View: <code>vw_lead_classification_stats</code> <a class="header-anchor" href="#view-vw-lead-classification-stats" aria-label="Permalink to &quot;View: \`vw_lead_classification_stats\`&quot;">​</a></h4><p><strong>Propósito</strong>: Estatísticas de classificação por tenant</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tenant_id,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  classification,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_leads,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(icp_score) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(confidence) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_confidence,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CASE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auto_responded </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ELSE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auto_responded_count,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CASE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> converted_to_opportunity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">THEN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ELSE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> converted_count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> classified_leads</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INTERVAL </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;30 days&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_id, classification</span></span></code></pre></div><hr><h4 id="function-get-active-persona-p-tenant-id-uuid" tabindex="-1">Function: <code>get_active_persona(p_tenant_id UUID)</code> <a class="header-anchor" href="#function-get-active-persona-p-tenant-id-uuid" aria-label="Permalink to &quot;Function: \`get_active_persona(p_tenant_id UUID)\`&quot;">​</a></h4><p><strong>Propósito</strong>: Buscar persona ativa de um tenant</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_active_persona</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p_tenant_id UUID)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JSONB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;version&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;business_type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">business_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;target_audience&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">target_audience</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;positive_keywords&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">positive_keywords</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;negative_keywords&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">negative_keywords</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas p</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_tenant_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_active</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEFINER;</span></span></code></pre></div><hr><h4 id="function-is-known-contact-p-tenant-id-p-platform-p-username" tabindex="-1">Function: <code>is_known_contact(p_tenant_id, p_platform, p_username)</code> <a class="header-anchor" href="#function-is-known-contact-p-tenant-id-p-platform-p-username" aria-label="Permalink to &quot;Function: \`is_known_contact(p_tenant_id, p_platform, p_username)\`&quot;">​</a></h4><p><strong>Propósito</strong>: Verificar se username está na whitelist</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> is_known_contact</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_tenant_id UUID,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_platform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JSONB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;is_known&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(...),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;contact_type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">kc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">contact_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;auto_classify_as&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">kc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">auto_classify_as</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_known_contacts kc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> kc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_tenant_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> kc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">platform</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_platform</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> kc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_username</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEFINER;</span></span></code></pre></div><hr><h4 id="function-save-classified-lead" tabindex="-1">Function: <code>save_classified_lead(...)</code> <a class="header-anchor" href="#function-save-classified-lead" aria-label="Permalink to &quot;Function: \`save_classified_lead(...)\`&quot;">​</a></h4><p><strong>Propósito</strong>: Salvar lead classificado (upsert)</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> save_classified_lead</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_tenant_id UUID,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_persona_version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_platform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_profile_data JSONB,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_ai_analysis JSONB,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_classification </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_icp_score </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_confidence </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> classified_leads (...)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (...)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  RETURNING id;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Atualiza contador na persona</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> leads_classified </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> leads_classified </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_tenant_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_persona_version;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEFINER;</span></span></code></pre></div><hr><h2 id="_2-ai-factory-modelo-de-dados" tabindex="-1">2. AI-FACTORY - MODELO DE DADOS <a class="header-anchor" href="#_2-ai-factory-modelo-de-dados" aria-label="Permalink to &quot;2. AI-FACTORY - MODELO DE DADOS&quot;">​</a></h2><h3 id="_2-1-schema-self-improving-ai-system" tabindex="-1">2.1 Schema: SELF-IMPROVING AI SYSTEM <a class="header-anchor" href="#_2-1-schema-self-improving-ai-system" aria-label="Permalink to &quot;2.1 Schema: SELF-IMPROVING AI SYSTEM&quot;">​</a></h3><h4 id="tabela-system-prompts" tabindex="-1">Tabela: <code>system_prompts</code> <a class="header-anchor" href="#tabela-system-prompts" aria-label="Permalink to &quot;Tabela: \`system_prompts\`&quot;">​</a></h4><p><strong>Propósito</strong>: Versionamento de prompts com histórico e performance</p>`,93),s("table",{tabindex:"0"},[s("thead",null,[s("tr",null,[s("th",null,"Coluna"),s("th",null,"Tipo"),s("th",null,"Descrição")])]),s("tbody",null,[s("tr",null,[s("td",null,[s("code",null,"id")]),s("td",null,"UUID"),s("td",null,"PK")]),s("tr",null,[s("td",null,[s("code",null,"agent_version_id")]),s("td",null,"UUID"),s("td",null,"FK → agent_versions(id)")]),s("tr",null,[s("td",null,[s("code",null,"version")]),s("td",null,"INTEGER"),s("td",null,"Versão do prompt")]),s("tr",null,[s("td",null,[s("code",null,"parent_id")]),s("td",null,"UUID"),s("td",null,"FK → system_prompts(id) (histórico)")]),s("tr",null,[s("td",null,[s("code",null,"is_active")]),s("td",null,"BOOLEAN"),s("td",null,"Apenas 1 ativo por agente")]),s("tr",null,[s("td",null,[s("code",null,"prompt_content")]),s("td",null,"TEXT"),s("td",null,"Conteúdo do prompt")]),s("tr",null,[s("td",null,[s("code",null,"prompt_name")]),s("td",null,"VARCHAR(255)"),s("td",null,"Nome descritivo")]),s("tr",null,[s("td",null,[s("code",null,"prompt_description")]),s("td",null,"TEXT"),s("td",null,"Descrição")]),s("tr",null,[s("td",null,[s("code",null,"model_config")]),s("td",null,"JSONB"),s("td",{"model,":"","temperature,":"",max_tokens:""})]),s("tr",null,[s("td",null,[s("code",null,"performance_score")]),s("td",null,"DECIMAL(3,2)"),s("td",null,"0.00-5.00 (média das avaliações)")]),s("tr",null,[s("td",null,[s("code",null,"total_evaluations")]),s("td",null,"INTEGER"),s("td",null,"Quantidade de avaliações")]),s("tr",null,[s("td",null,[s("code",null,"total_conversations")]),s("td",null,"INTEGER"),s("td",null,"Conversas analisadas")]),s("tr",null,[s("td",null,[s("code",null,"change_reason")]),s("td",null,"TEXT"),s("td",null,"auto_improvement, manual_edit, rollback")]),s("tr",null,[s("td",null,[s("code",null,"change_summary")]),s("td",null,"TEXT"),s("td",null,"Resumo das alterações")]),s("tr",null,[s("td",null,[s("code",null,"metadata")]),s("td",null,"JSONB"),s("td",null,"Metadata adicional")]),s("tr",null,[s("td",null,[s("code",null,"created_at")]),s("td",null,"TIMESTAMPTZ"),s("td")]),s("tr",null,[s("td",null,[s("code",null,"updated_at")]),s("td",null,"TIMESTAMPTZ"),s("td")]),s("tr",null,[s("td",null,[s("code",null,"activated_at")]),s("td",null,"TIMESTAMPTZ"),s("td")]),s("tr",null,[s("td",null,[s("code",null,"deactivated_at")]),s("td",null,"TIMESTAMPTZ"),s("td")])])],-1),a(`<p><strong>Constraint</strong>:</p><ul><li>UNIQUE <code>(agent_version_id, version)</code></li></ul><p><strong>Índices</strong>:</p><ul><li><code>idx_system_prompts_agent_version</code> em <code>(agent_version_id, version DESC)</code></li><li><code>idx_system_prompts_active</code> em <code>(agent_version_id, is_active)</code> WHERE <code>is_active = true</code></li><li><code>idx_system_prompts_performance</code> em <code>(performance_score DESC NULLS LAST)</code></li></ul><p><strong>Triggers</strong>:</p><ul><li><code>trigger_single_active_prompt</code>: Garante apenas 1 prompt ativo por agente</li></ul><hr><h4 id="tabela-reflection-logs" tabindex="-1">Tabela: <code>reflection_logs</code> <a class="header-anchor" href="#tabela-reflection-logs" aria-label="Permalink to &quot;Tabela: \`reflection_logs\`&quot;">​</a></h4><p><strong>Propósito</strong>: Logs de cada ciclo de reflexão com scores e decisões</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK</td></tr><tr><td><code>agent_version_id</code></td><td>UUID</td><td>FK → agent_versions(id)</td></tr><tr><td><code>system_prompt_id</code></td><td>UUID</td><td>FK → system_prompts(id)</td></tr><tr><td><code>period_start</code></td><td>TIMESTAMPTZ</td><td>Início do período analisado</td></tr><tr><td><code>period_end</code></td><td>TIMESTAMPTZ</td><td>Fim do período analisado</td></tr><tr><td><code>conversations_analyzed</code></td><td>INTEGER</td><td>Conversas analisadas</td></tr><tr><td><code>messages_analyzed</code></td><td>INTEGER</td><td>Mensagens analisadas</td></tr><tr><td><code>score_completeness</code></td><td>DECIMAL(3,2)</td><td>Completude (20%)</td></tr><tr><td><code>score_depth</code></td><td>DECIMAL(3,2)</td><td>Profundidade (25%)</td></tr><tr><td><code>score_tone</code></td><td>DECIMAL(3,2)</td><td>Tom/Personalidade (15%)</td></tr><tr><td><code>score_scope</code></td><td>DECIMAL(3,2)</td><td>Escopo/Relevância (20%)</td></tr><tr><td><code>score_missed_opportunities</code></td><td>DECIMAL(3,2)</td><td>Oportunidades Perdidas (20%)</td></tr><tr><td><code>overall_score</code></td><td>DECIMAL(3,2)</td><td>Score agregado (weighted average)</td></tr><tr><td><code>score_breakdown</code></td><td>JSONB</td><td>Breakdown detalhado</td></tr><tr><td><code>strengths</code></td><td>TEXT[]</td><td>Pontos fortes</td></tr><tr><td><code>weaknesses</code></td><td>TEXT[]</td><td>Pontos fracos</td></tr><tr><td><code>patterns_identified</code></td><td>TEXT[]</td><td>Padrões detectados</td></tr><tr><td><code>action_taken</code></td><td>VARCHAR(50)</td><td>none, suggestion, auto_update, escalate</td></tr><tr><td><code>action_reason</code></td><td>TEXT</td><td>Justificativa da decisão</td></tr><tr><td><code>suggestion_id</code></td><td>UUID</td><td>FK → improvement_suggestions(id)</td></tr><tr><td><code>cooldown_respected</code></td><td>BOOLEAN</td><td>Se respeitou 6h de cooldown</td></tr><tr><td><code>previous_reflection_id</code></td><td>UUID</td><td>FK → reflection_logs(id)</td></tr><tr><td><code>hours_since_last_reflection</code></td><td>DECIMAL(10,2)</td><td>Horas desde última reflexão</td></tr><tr><td><code>status</code></td><td>VARCHAR(50)</td><td>running, completed, failed, cancelled</td></tr><tr><td><code>error_message</code></td><td>TEXT</td><td>Mensagem de erro</td></tr><tr><td><code>execution_time_ms</code></td><td>INTEGER</td><td>Tempo de execução</td></tr><tr><td><code>evaluator_model</code></td><td>VARCHAR(100)</td><td>claude-sonnet-4-20250514</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>completed_at</code></td><td>TIMESTAMPTZ</td><td></td></tr></tbody></table><p><strong>Constraints</strong>:</p><ul><li>CHECK <code>overall_score &gt;= 0 AND overall_score &lt;= 5</code></li><li>CHECK <code>action_taken IN (&#39;none&#39;, &#39;suggestion&#39;, &#39;auto_update&#39;, &#39;escalate&#39;)</code></li></ul><p><strong>Índices</strong>:</p><ul><li><code>idx_reflection_logs_agent</code> em <code>(agent_version_id, created_at DESC)</code></li><li><code>idx_reflection_logs_score</code> em <code>(overall_score, created_at DESC)</code></li><li><code>idx_reflection_logs_action</code> em <code>(action_taken, created_at DESC)</code></li><li><code>idx_reflection_logs_period</code> em <code>(period_start, period_end)</code></li><li><code>idx_reflection_logs_weaknesses</code> GIN em <code>weaknesses</code></li></ul><p><strong>Decision Framework</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Score &gt;= 4.0 → action_taken = &#39;none&#39; (nenhuma ação)</span></span>
<span class="line"><span>Score 3.0-3.9 → action_taken = &#39;suggestion&#39; (gerar sugestão)</span></span>
<span class="line"><span>Score 2.0-2.9 → action_taken = &#39;auto_update&#39; (auto-aplicar se confidence &gt;= 0.8)</span></span>
<span class="line"><span>Score &lt; 2.0  → action_taken = &#39;escalate&#39; (escalar para humano)</span></span></code></pre></div><hr><h4 id="tabela-improvement-suggestions" tabindex="-1">Tabela: <code>improvement_suggestions</code> <a class="header-anchor" href="#tabela-improvement-suggestions" aria-label="Permalink to &quot;Tabela: \`improvement_suggestions\`&quot;">​</a></h4><p><strong>Propósito</strong>: Sugestões de melhoria geradas pelo sistema</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK</td></tr><tr><td><code>agent_version_id</code></td><td>UUID</td><td>FK → agent_versions(id)</td></tr><tr><td><code>reflection_log_id</code></td><td>UUID</td><td>FK → reflection_logs(id)</td></tr><tr><td><code>current_prompt_id</code></td><td>UUID</td><td>FK → system_prompts(id)</td></tr><tr><td><code>suggestion_type</code></td><td>VARCHAR(50)</td><td>prompt_update, config_change, escalation</td></tr><tr><td><code>current_value</code></td><td>TEXT</td><td>Valor atual (para comparação)</td></tr><tr><td><code>suggested_value</code></td><td>TEXT</td><td>Valor sugerido</td></tr><tr><td><code>diff_summary</code></td><td>TEXT</td><td>Resumo das diferenças</td></tr><tr><td><code>rationale</code></td><td>TEXT</td><td>Justificativa da sugestão</td></tr><tr><td><code>expected_improvement</code></td><td>TEXT</td><td>Melhoria esperada</td></tr><tr><td><code>risk_assessment</code></td><td>TEXT</td><td>Avaliação de risco</td></tr><tr><td><code>confidence_score</code></td><td>DECIMAL(3,2)</td><td>0.00-1.00 (confidence da IA)</td></tr><tr><td><code>focus_areas</code></td><td>TEXT[]</td><td>[&#39;tone&#39;, &#39;completeness&#39;, &#39;engagement&#39;]</td></tr><tr><td><code>status</code></td><td>VARCHAR(50)</td><td>pending, approved, rejected, auto_applied, rolled_back</td></tr><tr><td><code>reviewed_by</code></td><td>UUID</td><td>User ID que revisou</td></tr><tr><td><code>reviewed_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>review_notes</code></td><td>TEXT</td><td></td></tr><tr><td><code>applied_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>applied_prompt_id</code></td><td>UUID</td><td>FK → system_prompts(id)</td></tr><tr><td><code>rolled_back_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>rollback_reason</code></td><td>TEXT</td><td></td></tr><tr><td><code>post_apply_score</code></td><td>DECIMAL(3,2)</td><td>Score após aplicar</td></tr><tr><td><code>improvement_delta</code></td><td>DECIMAL(3,2)</td><td>Diferença de score</td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>updated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>expires_at</code></td><td>TIMESTAMPTZ</td><td>Expiração da sugestão</td></tr></tbody></table><p><strong>Constraints</strong>:</p><ul><li>CHECK <code>suggestion_type IN (&#39;prompt_update&#39;, &#39;config_change&#39;, &#39;escalation&#39;)</code></li><li>CHECK <code>status IN (&#39;pending&#39;, &#39;approved&#39;, &#39;rejected&#39;, &#39;auto_applied&#39;, &#39;rolled_back&#39;)</code></li></ul><p><strong>Índices</strong>:</p><ul><li><code>idx_suggestions_agent</code> em <code>(agent_version_id, created_at DESC)</code></li><li><code>idx_suggestions_status</code> em <code>(status, created_at DESC)</code></li><li><code>idx_suggestions_pending</code> em <code>(agent_version_id, status)</code> WHERE <code>status = &#39;pending&#39;</code></li><li><code>idx_suggestions_reflection</code> em <code>reflection_log_id</code></li><li><code>idx_suggestions_focus</code> GIN em <code>focus_areas</code></li></ul><p><strong>Auto-Apply Logic</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>IF confidence_score &gt;= 0.85 AND auto_apply_enabled = true THEN</span></span>
<span class="line"><span>  status = &#39;auto_applied&#39;</span></span>
<span class="line"><span>ELSE</span></span>
<span class="line"><span>  status = &#39;pending&#39; (requer aprovação humana)</span></span>
<span class="line"><span>END IF</span></span></code></pre></div><hr><h4 id="tabela-self-improving-settings" tabindex="-1">Tabela: <code>self_improving_settings</code> <a class="header-anchor" href="#tabela-self-improving-settings" aria-label="Permalink to &quot;Tabela: \`self_improving_settings\`&quot;">​</a></h4><p><strong>Propósito</strong>: Configurações do sistema por agente</p><table tabindex="0"><thead><tr><th>Coluna</th><th>Tipo</th><th>Descrição</th></tr></thead><tbody><tr><td><code>id</code></td><td>UUID</td><td>PK</td></tr><tr><td><code>agent_version_id</code></td><td>UUID</td><td>FK → agent_versions(id)</td></tr><tr><td><code>location_id</code></td><td>VARCHAR(100)</td><td>ID da location (GHL)</td></tr><tr><td><code>reflection_enabled</code></td><td>BOOLEAN</td><td>Habilitar reflexão (default: true)</td></tr><tr><td><code>reflection_interval_hours</code></td><td>INTEGER</td><td>Mínimo 6h entre reflexões</td></tr><tr><td><code>min_conversations_for_reflection</code></td><td>INTEGER</td><td>Mínimo 10 conversas</td></tr><tr><td><code>threshold_none</code></td><td>DECIMAL(3,2)</td><td>Score &gt;= 4.0 = nenhuma ação</td></tr><tr><td><code>threshold_suggestion</code></td><td>DECIMAL(3,2)</td><td>3.0-3.9 = gerar sugestão</td></tr><tr><td><code>threshold_auto_update</code></td><td>DECIMAL(3,2)</td><td>2.0-2.9 = auto-update</td></tr><tr><td><code>max_updates_per_day</code></td><td>INTEGER</td><td>Máximo 3 updates/dia</td></tr><tr><td><code>cooldown_after_update_hours</code></td><td>INTEGER</td><td>6h após update</td></tr><tr><td><code>require_approval_below_confidence</code></td><td>DECIMAL(3,2)</td><td>0.8 (requer aprovação)</td></tr><tr><td><code>auto_apply_enabled</code></td><td>BOOLEAN</td><td>Começar desabilitado</td></tr><tr><td><code>auto_apply_min_confidence</code></td><td>DECIMAL(3,2)</td><td>0.85</td></tr><tr><td><code>auto_apply_max_score_drop</code></td><td>DECIMAL(3,2)</td><td>0.5 (rollback)</td></tr><tr><td><code>notify_on_suggestion</code></td><td>BOOLEAN</td><td></td></tr><tr><td><code>notify_on_auto_update</code></td><td>BOOLEAN</td><td></td></tr><tr><td><code>notify_on_escalation</code></td><td>BOOLEAN</td><td></td></tr><tr><td><code>notification_emails</code></td><td>TEXT[]</td><td></td></tr><tr><td><code>notification_webhook_url</code></td><td>TEXT</td><td>Webhook para n8n/GHL</td></tr><tr><td><code>evaluator_model</code></td><td>VARCHAR(100)</td><td>claude-sonnet-4-20250514</td></tr><tr><td><code>metadata</code></td><td>JSONB</td><td></td></tr><tr><td><code>created_at</code></td><td>TIMESTAMPTZ</td><td></td></tr><tr><td><code>updated_at</code></td><td>TIMESTAMPTZ</td><td></td></tr></tbody></table><p><strong>Constraints</strong>:</p><ul><li>UNIQUE NULLS NOT DISTINCT <code>(agent_version_id)</code></li><li>UNIQUE NULLS NOT DISTINCT <code>(location_id)</code></li></ul><hr><h3 id="_2-2-views-e-functions-do-ai-factory" tabindex="-1">2.2 Views e Functions do AI-Factory <a class="header-anchor" href="#_2-2-views-e-functions-do-ai-factory" aria-label="Permalink to &quot;2.2 Views e Functions do AI-Factory&quot;">​</a></h3><h4 id="view-vw-self-improving-summary" tabindex="-1">View: <code>vw_self_improving_summary</code> <a class="header-anchor" href="#view-vw-self-improving-summary" aria-label="Permalink to &quot;View: \`vw_self_improving_summary\`&quot;">​</a></h4><p><strong>Propósito</strong>: Resumo de status do sistema por agente</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent_version_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prompt_version,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">performance_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">overall_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_reflection_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">action_taken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_action,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;pending&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pending_suggestions,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reflection_enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">auto_apply_enabled</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent_versions av</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> system_prompts sp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_version_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_active</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reflection_logs rl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_version_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> improvement_suggestions s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_version_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self_improving_settings ss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_version_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> av</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span></code></pre></div><hr><h4 id="view-vw-score-evolution" tabindex="-1">View: <code>vw_score_evolution</code> <a class="header-anchor" href="#view-vw-score-evolution" aria-label="Permalink to &quot;View: \`vw_score_evolution\`&quot;">​</a></h4><p><strong>Propósito</strong>: Evolução de scores ao longo do tempo</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_version_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">overall_score</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">score_completeness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_completeness,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">score_depth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_depth,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">score_tone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_tone,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reflection_count,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CASE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> action_taken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;auto_update&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> THEN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ELSE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auto_updates</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reflection_logs rl</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent_version_id, created_at::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DATE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DESC</span></span></code></pre></div><hr><h4 id="function-get-self-improving-config-p-agent-version-id-uuid" tabindex="-1">Function: <code>get_self_improving_config(p_agent_version_id UUID)</code> <a class="header-anchor" href="#function-get-self-improving-config-p-agent-version-id-uuid" aria-label="Permalink to &quot;Function: \`get_self_improving_config(p_agent_version_id UUID)\`&quot;">​</a></h4><p><strong>Propósito</strong>: Buscar configurações do agente</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_self_improving_config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p_agent_version_id UUID)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JSONB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;reflection_enabled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reflection_enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;reflection_interval_hours&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reflection_interval_hours</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;thresholds&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;none&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">threshold_none</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;suggestion&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">threshold_suggestion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;auto_update&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">threshold_auto_update</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;auto_apply&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;enabled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">auto_apply_enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;min_confidence&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">auto_apply_min_confidence</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self_improving_settings s</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent_version_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_agent_version_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEFINER;</span></span></code></pre></div><hr><h4 id="function-can-run-reflection-p-agent-version-id-uuid" tabindex="-1">Function: <code>can_run_reflection(p_agent_version_id UUID)</code> <a class="header-anchor" href="#function-can-run-reflection-p-agent-version-id-uuid" aria-label="Permalink to &quot;Function: \`can_run_reflection(p_agent_version_id UUID)\`&quot;">​</a></h4><p><strong>Propósito</strong>: Verificar se pode executar reflexão (cooldown, limites)</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FUNCTION</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> can_run_reflection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p_agent_version_id UUID)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RETURNS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JSONB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECLARE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  v_last_reflection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  v_hours_since </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  v_updates_today </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Buscar última reflexão</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_last_reflection</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reflection_logs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent_version_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_agent_version_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ORDER BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DESC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Calcular horas desde última reflexão</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  v_hours_since :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXTRACT(EPOCH </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_last_reflection)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Verificar cooldown</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_hours_since </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> THEN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;can_run&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, false,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;reason&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Cooldown: &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_hours_since </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39; hours since last reflection&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Verificar limite diário</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_updates_today</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> improvement_suggestions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agent_version_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_agent_version_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    AND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;auto_applied&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    AND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> applied_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CURRENT_DATE;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v_updates_today </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> THEN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;can_run&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, true,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;auto_update_blocked&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, true,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;reason&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Daily limit reached&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;can_run&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, true, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;reason&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;OK&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">END</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LANGUAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEFINER;</span></span></code></pre></div><hr><h2 id="_3-comparacao-e-relacionamentos" tabindex="-1">3. COMPARAÇÃO E RELACIONAMENTOS <a class="header-anchor" href="#_3-comparacao-e-relacionamentos" aria-label="Permalink to &quot;3. COMPARAÇÃO E RELACIONAMENTOS&quot;">​</a></h2><h3 id="_3-1-tabela-comparativa" tabindex="-1">3.1 Tabela Comparativa <a class="header-anchor" href="#_3-1-tabela-comparativa" aria-label="Permalink to &quot;3.1 Tabela Comparativa&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Característica</th><th>AgenticOS</th><th>AI-Factory</th></tr></thead><tbody><tr><td><strong>Foco Principal</strong></td><td>Lead classification + Auto-response</td><td>Prompt improvement + Self-learning</td></tr><tr><td><strong>Multi-tenancy</strong></td><td>✅ Sim (<code>tenants</code> table)</td><td>❌ Não (single instance)</td></tr><tr><td><strong>Versionamento</strong></td><td>✅ Personas versionadas</td><td>✅ Prompts versionados</td></tr><tr><td><strong>IA usada</strong></td><td>Gemini Vision API</td><td>Claude Sonnet 4</td></tr><tr><td><strong>Trigger de ação</strong></td><td>Mensagem recebida</td><td>Reflection loop (6h intervals)</td></tr><tr><td><strong>Auto-apply</strong></td><td>Auto-resposta de leads</td><td>Auto-update de prompts</td></tr><tr><td><strong>Scoring</strong></td><td>ICP score (0-100)</td><td>Performance score (0-5)</td></tr><tr><td><strong>Safety limits</strong></td><td>Rate limits de DM</td><td>Cooldown + max updates/day</td></tr><tr><td><strong>Whitelist</strong></td><td>✅ <code>tenant_known_contacts</code></td><td>❌ Não tem</td></tr><tr><td><strong>Histórico</strong></td><td><code>conversation_context</code> JSONB</td><td><code>agent_conversations</code> tabela</td></tr><tr><td><strong>Analytics</strong></td><td>Views de performance</td><td>Views de score evolution</td></tr></tbody></table><hr><h3 id="_3-2-padroes-comuns-reusaveis" tabindex="-1">3.2 Padrões Comuns (Reusáveis) <a class="header-anchor" href="#_3-2-padroes-comuns-reusaveis" aria-label="Permalink to &quot;3.2 Padrões Comuns (Reusáveis)&quot;">​</a></h3><p>✅ <strong>Ambos usam</strong>:</p><ol><li>UUID como Primary Key</li><li><code>created_at</code> / <code>updated_at</code> TIMESTAMPTZ</li><li>Versionamento com <code>version INTEGER</code> + <code>is_active BOOLEAN</code></li><li>Triggers para garantir apenas 1 versão ativa</li><li>JSONB para dados semi-estruturados</li><li>GIN indexes para arrays TEXT[]</li><li>RLS (Row Level Security) - AgenticOS tem RLS ativo</li><li>Functions SECURITY DEFINER para RPC</li><li>Views para dashboards</li><li>Soft deletes via <code>deactivated_at</code> / <code>deprecated_at</code></li></ol><hr><h3 id="_3-3-diferencas-arquiteturais" tabindex="-1">3.3 Diferenças Arquiteturais <a class="header-anchor" href="#_3-3-diferencas-arquiteturais" aria-label="Permalink to &quot;3.3 Diferenças Arquiteturais&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Aspecto</th><th>AgenticOS</th><th>AI-Factory</th></tr></thead><tbody><tr><td><strong>Isolation</strong></td><td>Multi-tenant com <code>tenant_id</code> em todas as tabelas</td><td>Single-tenant por agent_version_id</td></tr><tr><td><strong>Versioning trigger</strong></td><td>Nova versão de persona → desativa anterior</td><td>Nova versão de prompt → desativa anterior</td></tr><tr><td><strong>Decision logic</strong></td><td>Rule-based (keywords + ICP score)</td><td>AI-as-Judge (rubric scoring)</td></tr><tr><td><strong>Feedback loop</strong></td><td>Manual (conversions, outcomes)</td><td>Automated (reflection loop)</td></tr><tr><td><strong>Data structure</strong></td><td>JSONB pesado (profile_data, ai_analysis)</td><td>JSONB leve (score_breakdown, metadata)</td></tr></tbody></table><hr><h2 id="_4-possibilidades-de-integracao" tabindex="-1">4. POSSIBILIDADES DE INTEGRAÇÃO <a class="header-anchor" href="#_4-possibilidades-de-integracao" aria-label="Permalink to &quot;4. POSSIBILIDADES DE INTEGRAÇÃO&quot;">​</a></h2><h3 id="_4-1-cenario-1-self-improving-lead-classifier" tabindex="-1">4.1 Cenário 1: Self-Improving Lead Classifier <a class="header-anchor" href="#_4-1-cenario-1-self-improving-lead-classifier" aria-label="Permalink to &quot;4.1 Cenário 1: Self-Improving Lead Classifier&quot;">​</a></h3><p><strong>Problema a resolver</strong>: AgenticOS classifica leads com IA, mas não aprende com os resultados (taxa de conversão, false positives, etc).</p><p><strong>Solução proposta</strong>: Aplicar o <strong>Reflection Loop do AI-Factory</strong> para melhorar continuamente o <code>ai_classification_prompt</code> e <code>ai_response_prompt</code> da tabela <code>tenant_personas</code>.</p><h4 id="schema-de-integracao" tabindex="-1">Schema de integração: <a class="header-anchor" href="#schema-de-integracao" aria-label="Permalink to &quot;Schema de integração:&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Adicionar tracking de performance nas personas</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN performance_score </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN last_reflection_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN reflection_enabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BOOLEAN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Criar tabela de reflexão para personas</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> persona_reflection_logs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PRIMARY KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_random_uuid(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  persona_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas(id),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Período analisado</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  period_start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  period_end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Métricas do período</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  total_leads_classified </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  hot_leads_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  false_positives </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Leads classificados HOT mas não converteram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  false_negatives </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Leads classificados COLD mas converteram</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Scores (rubrica adaptada)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  score_precision </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Precisão das classificações</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  score_conversion_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Taxa de conversão</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  score_response_quality </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Qualidade das respostas automáticas</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  overall_score </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Decisão</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  action_taken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- &#39;none&#39;, &#39;suggestion&#39;, &#39;auto_update&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  suggestion_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> persona_improvement_suggestions(id),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Criar tabela de sugestões de melhoria de persona</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> persona_improvement_suggestions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PRIMARY KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_random_uuid(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  persona_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas(id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  reflection_log_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> persona_reflection_logs(id),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Tipo de melhoria</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  suggestion_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- &#39;keywords_update&#39;, &#39;prompt_update&#39;, &#39;scoring_weights&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Mudança proposta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  current_value JSONB,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  suggested_value JSONB,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Análise</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rationale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  confidence_score </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Status</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TEXT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;pending&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- &#39;pending&#39;, &#39;approved&#39;, &#39;auto_applied&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  applied_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Performance pós-aplicação</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  post_apply_conversion_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  improvement_delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="fluxo-de-integracao" tabindex="-1">Fluxo de integração: <a class="header-anchor" href="#fluxo-de-integracao" aria-label="Permalink to &quot;Fluxo de integração:&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Trigger periódico (6h) via n8n:</span></span>
<span class="line"><span>   → Buscar leads classificados nas últimas 6h</span></span>
<span class="line"><span>   → Calcular métricas (precision, false positives, conversion rate)</span></span>
<span class="line"><span>   → Chamar Claude Sonnet 4 para avaliar performance</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. Claude analisa:</span></span>
<span class="line"><span>   → Keywords que geraram false positives</span></span>
<span class="line"><span>   → Padrões em leads que converteram mas foram classificados como COLD</span></span>
<span class="line"><span>   → Sugestões de ajuste nos positive_keywords / negative_keywords</span></span>
<span class="line"><span>   → Sugestões de melhoria no ai_classification_prompt</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. Decisão automática:</span></span>
<span class="line"><span>   IF overall_score &gt;= 4.0 THEN action = &#39;none&#39;</span></span>
<span class="line"><span>   IF overall_score 3.0-3.9 THEN action = &#39;suggestion&#39; (requer aprovação)</span></span>
<span class="line"><span>   IF overall_score &lt; 3.0 AND confidence &gt;= 0.85 THEN action = &#39;auto_update&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. Se auto_update:</span></span>
<span class="line"><span>   → Criar nova versão da persona (version + 1)</span></span>
<span class="line"><span>   → Copiar campos da versão anterior</span></span>
<span class="line"><span>   → Aplicar mudanças sugeridas (keywords, prompt)</span></span>
<span class="line"><span>   → Ativar nova versão (trigger desativa a anterior)</span></span>
<span class="line"><span>   → Monitorar performance nas próximas 24h</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. Se performance piorar:</span></span>
<span class="line"><span>   → Rollback para versão anterior (is_active = true)</span></span>
<span class="line"><span>   → Marcar suggestion como &#39;rolled_back&#39;</span></span></code></pre></div><hr><h3 id="_4-2-cenario-2-multi-tenant-self-improving-system" tabindex="-1">4.2 Cenário 2: Multi-Tenant Self-Improving System <a class="header-anchor" href="#_4-2-cenario-2-multi-tenant-self-improving-system" aria-label="Permalink to &quot;4.2 Cenário 2: Multi-Tenant Self-Improving System&quot;">​</a></h3><p><strong>Problema a resolver</strong>: AI-Factory não tem multi-tenancy. AgenticOS tem multi-tenancy mas não tem self-improving.</p><p><strong>Solução proposta</strong>: Criar uma <strong>versão multi-tenant do AI-Factory</strong> reutilizando padrões do AgenticOS.</p><h4 id="mudancas-necessarias-no-ai-factory" tabindex="-1">Mudanças necessárias no AI-Factory: <a class="header-anchor" href="#mudancas-necessarias-no-ai-factory" aria-label="Permalink to &quot;Mudanças necessárias no AI-Factory:&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Adicionar tenant_id nas tabelas principais</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> system_prompts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN location_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VARCHAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Para multi-location dentro de tenant</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reflection_logs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> improvement_suggestions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self_improving_settings</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Atualizar constraints</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> system_prompts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DROP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CONSTRAINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unique_active_prompt,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CONSTRAINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unique_active_prompt_per_tenant</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  UNIQUE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tenant_id, agent_version_id, is_active)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_active </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Atualizar RLS policies</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> system_prompts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENABLE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ROW</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;system_prompts_tenant_isolation&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> system_prompts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ALL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tenant_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">jwt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;app_metadata&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;tenant_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)::uuid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Similar para outras tabelas...</span></span></code></pre></div><h4 id="vantagens-da-integracao" tabindex="-1">Vantagens da integração: <a class="header-anchor" href="#vantagens-da-integracao" aria-label="Permalink to &quot;Vantagens da integração:&quot;">​</a></h4><p>✅ Cada tenant tem seu próprio conjunto de prompts versionados ✅ Reflection loops isolados por tenant ✅ Auto-apply configurável por tenant (alguns podem ter auto-apply, outros não) ✅ Performance tracking separado por tenant ✅ Rollback independente por tenant</p><hr><h3 id="_4-3-cenario-3-unified-analytics-dashboard" tabindex="-1">4.3 Cenário 3: Unified Analytics Dashboard <a class="header-anchor" href="#_4-3-cenario-3-unified-analytics-dashboard" aria-label="Permalink to &quot;4.3 Cenário 3: Unified Analytics Dashboard&quot;">​</a></h3><p><strong>Problema a resolver</strong>: Métricas isoladas entre AgenticOS (lead metrics) e AI-Factory (prompt performance).</p><p><strong>Solução proposta</strong>: Criar <strong>view unificada</strong> que correlaciona performance de prompts com performance de leads.</p><h4 id="view-proposta" tabindex="-1">View proposta: <a class="header-anchor" href="#view-proposta" aria-label="Permalink to &quot;View proposta:&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE OR REPLACE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> VIEW</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vw_unified_tenant_performance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_name,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Lead metrics (AgenticOS)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total_leads_30d,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  AVG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">icp_score</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> avg_icp_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">converted_to_opportunity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> conversions_30d,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Persona performance (AgenticOS)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> persona_version,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">leads_classified</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">conversion_rate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> persona_conversion_rate,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Prompt performance (AI-Factory)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prompt_version,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">performance_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prompt_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">total_evaluations</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prompt_evaluations,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Reflection metrics (AI-Factory)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">overall_score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_reflection_score,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">action_taken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_action,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Sugestões pendentes (AI-Factory)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;pending&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pending_suggestions,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Auto-updates (AI-Factory)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FILTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;auto_applied&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">applied_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INTERVAL </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;30 days&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auto_updates_30d</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants t</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_active</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> classified_leads cl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INTERVAL </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;30 days&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> system_prompts sp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> AND</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">is_active</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reflection_logs rl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ORDER BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DESC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LEFT JOIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> improvement_suggestions s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenant_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">overall_score</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">action_taken</span></span></code></pre></div><hr><h3 id="_4-4-cenario-4-cross-learning-between-tenants" tabindex="-1">4.4 Cenário 4: Cross-Learning Between Tenants <a class="header-anchor" href="#_4-4-cenario-4-cross-learning-between-tenants" aria-label="Permalink to &quot;4.4 Cenário 4: Cross-Learning Between Tenants&quot;">​</a></h3><p><strong>Problema a resolver</strong>: Cada tenant aprende isoladamente. Melhorias descobertas por um tenant não beneficiam outros.</p><p><strong>Solução proposta</strong>: Criar <strong>sistema de best practices compartilhadas</strong> (opcional, com consent).</p><h4 id="schema-proposta" tabindex="-1">Schema proposta: <a class="header-anchor" href="#schema-proposta" aria-label="Permalink to &quot;Schema proposta:&quot;">​</a></h4><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> shared_best_practices</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PRIMARY KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_random_uuid(),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Origem</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  source_tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  source_persona_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas(id),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Tipo de prática</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  practice_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- &#39;keyword_set&#39;, &#39;prompt_template&#39;, &#39;scoring_weights&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Conteúdo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  practice_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  practice_description </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  practice_config JSONB,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Performance da origem</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  source_conversion_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  source_leads_classified </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Aplicação por outros tenants</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  times_applied </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INTEGER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  avg_improvement_delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Melhoria média quando aplicada</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Metadados</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_public </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BOOLEAN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> false, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Se outros tenants podem ver</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Tracking de aplicação</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> best_practice_applications</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PRIMARY KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gen_random_uuid(),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  best_practice_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shared_best_practices(id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  applied_to_tenant_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenants(id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  applied_to_persona_id UUID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REFERENCES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenant_personas(id),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Performance antes/depois</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  conversion_rate_before </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  conversion_rate_after </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  improvement_delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DECIMAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  applied_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TIMESTAMPTZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOW</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="exemplo-de-uso" tabindex="-1">Exemplo de uso: <a class="header-anchor" href="#exemplo-de-uso" aria-label="Permalink to &quot;Exemplo de uso:&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Tenant A (Socialfy) descobre que adicionar keyword &quot;scaling&quot; nos positive_keywords</span></span>
<span class="line"><span>aumentou conversão de 12% para 18%.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Sistema pergunta: &quot;Compartilhar esta descoberta com outros tenants?&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Se sim:</span></span>
<span class="line"><span>  → INSERT INTO shared_best_practices (</span></span>
<span class="line"><span>      source_tenant_id = &#39;socialfy&#39;,</span></span>
<span class="line"><span>      practice_type = &#39;keyword_addition&#39;,</span></span>
<span class="line"><span>      practice_config = {&quot;keyword&quot;: &quot;scaling&quot;, &quot;context&quot;: &quot;B2B agencies&quot;},</span></span>
<span class="line"><span>      source_conversion_rate = 18%</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Tenant B (FitPro) recebe sugestão:</span></span>
<span class="line"><span>  → &quot;Socialfy descobriu que keyword &#39;scaling&#39; aumentou conversão em 50%.</span></span>
<span class="line"><span>     Aplicar na sua persona?&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Se aprovar:</span></span>
<span class="line"><span>  → Adiciona &quot;scaling&quot; nos positive_keywords</span></span>
<span class="line"><span>  → Monitora conversão por 7 dias</span></span>
<span class="line"><span>  → Atualiza best_practice_applications</span></span></code></pre></div><hr><h2 id="_5-roadmap-de-integracao" tabindex="-1">5. ROADMAP DE INTEGRAÇÃO <a class="header-anchor" href="#_5-roadmap-de-integracao" aria-label="Permalink to &quot;5. ROADMAP DE INTEGRAÇÃO&quot;">​</a></h2><h3 id="fase-1-foundation-semana-1-2" tabindex="-1">Fase 1: Foundation (Semana 1-2) <a class="header-anchor" href="#fase-1-foundation-semana-1-2" aria-label="Permalink to &quot;Fase 1: Foundation (Semana 1-2)&quot;">​</a></h3><ul><li>[ ] Adicionar <code>tenant_id</code> nas tabelas do AI-Factory</li><li>[ ] Implementar RLS no AI-Factory</li><li>[ ] Migrar funções para suportar multi-tenancy</li><li>[ ] Criar view unificada <code>vw_unified_tenant_performance</code></li></ul><h3 id="fase-2-self-improving-personas-semana-3-4" tabindex="-1">Fase 2: Self-Improving Personas (Semana 3-4) <a class="header-anchor" href="#fase-2-self-improving-personas-semana-3-4" aria-label="Permalink to &quot;Fase 2: Self-Improving Personas (Semana 3-4)&quot;">​</a></h3><ul><li>[ ] Criar <code>persona_reflection_logs</code></li><li>[ ] Criar <code>persona_improvement_suggestions</code></li><li>[ ] Implementar Reflection Loop para personas</li><li>[ ] Configurar n8n workflow (trigger 6h)</li></ul><h3 id="fase-3-auto-apply-semana-5-6" tabindex="-1">Fase 3: Auto-Apply (Semana 5-6) <a class="header-anchor" href="#fase-3-auto-apply-semana-5-6" aria-label="Permalink to &quot;Fase 3: Auto-Apply (Semana 5-6)&quot;">​</a></h3><ul><li>[ ] Implementar lógica de auto-apply para personas</li><li>[ ] Adicionar rollback automático se performance cair</li><li>[ ] Dashboard de monitoring de versões de persona</li><li>[ ] Alertas via webhook (n8n/GHL)</li></ul><h3 id="fase-4-cross-learning-semana-7-8" tabindex="-1">Fase 4: Cross-Learning (Semana 7-8) <a class="header-anchor" href="#fase-4-cross-learning-semana-7-8" aria-label="Permalink to &quot;Fase 4: Cross-Learning (Semana 7-8)&quot;">​</a></h3><ul><li>[ ] Criar <code>shared_best_practices</code></li><li>[ ] Criar <code>best_practice_applications</code></li><li>[ ] UI para aprovar/rejeitar sugestões de outros tenants</li><li>[ ] Analytics de cross-learning</li></ul><hr><h2 id="_6-metricas-de-sucesso" tabindex="-1">6. MÉTRICAS DE SUCESSO <a class="header-anchor" href="#_6-metricas-de-sucesso" aria-label="Permalink to &quot;6. MÉTRICAS DE SUCESSO&quot;">​</a></h2><h3 id="kpis-do-agenticos-lead-generation" tabindex="-1">KPIs do AgenticOS (Lead Generation) <a class="header-anchor" href="#kpis-do-agenticos-lead-generation" aria-label="Permalink to &quot;KPIs do AgenticOS (Lead Generation)&quot;">​</a></h3><ul><li>Taxa de conversão de LEAD_HOT → Opportunity</li><li>Precisão da classificação (% de false positives)</li><li>Tempo médio de resposta automática</li><li>Engagement rate das mensagens enviadas</li></ul><h3 id="kpis-do-ai-factory-self-improving" tabindex="-1">KPIs do AI-Factory (Self-Improving) <a class="header-anchor" href="#kpis-do-ai-factory-self-improving" aria-label="Permalink to &quot;KPIs do AI-Factory (Self-Improving)&quot;">​</a></h3><ul><li>Performance score médio dos prompts</li><li>Quantidade de auto-updates bem-sucedidos</li><li>Taxa de rollback (quanto menor, melhor)</li><li>Improvement delta médio</li></ul><h3 id="kpis-unificados-integracao" tabindex="-1">KPIs Unificados (Integração) <a class="header-anchor" href="#kpis-unificados-integracao" aria-label="Permalink to &quot;KPIs Unificados (Integração)&quot;">​</a></h3><ul><li>Melhoria de conversão após auto-update de persona</li><li>Redução de false positives após reflexão</li><li>Tempo para atingir performance ótima (time-to-optimal)</li><li>ROI de créditos de IA (menos re-classificações = menos custo)</li></ul><hr><h2 id="_7-consideracoes-de-seguranca" tabindex="-1">7. CONSIDERAÇÕES DE SEGURANÇA <a class="header-anchor" href="#_7-consideracoes-de-seguranca" aria-label="Permalink to &quot;7. CONSIDERAÇÕES DE SEGURANÇA&quot;">​</a></h2><h3 id="multi-tenancy" tabindex="-1">Multi-Tenancy <a class="header-anchor" href="#multi-tenancy" aria-label="Permalink to &quot;Multi-Tenancy&quot;">​</a></h3><p>✅ <strong>AgenticOS já implementa</strong>:</p><ul><li>RLS ativo em todas as tabelas</li><li><code>tenant_id</code> em todos os registros</li><li>Policies baseadas em JWT (<code>auth.jwt() -&gt; &#39;app_metadata&#39; -&gt;&gt; &#39;tenant_id&#39;</code>)</li></ul><p>⚠️ <strong>AI-Factory precisa adicionar</strong>:</p><ul><li>RLS nas tabelas de prompts/reflection</li><li>Isolation de reflexões por tenant</li><li>Webhooks segregados por tenant</li></ul><h3 id="auto-apply-safety" tabindex="-1">Auto-Apply Safety <a class="header-anchor" href="#auto-apply-safety" aria-label="Permalink to &quot;Auto-Apply Safety&quot;">​</a></h3><p>✅ <strong>Ambos implementam</strong>:</p><ul><li>Cooldown entre updates (6h)</li><li>Max updates per day (3)</li><li>Confidence threshold (0.85)</li><li>Rollback automático</li></ul><p>⚠️ <strong>Melhorias sugeridas</strong>:</p><ul><li>A/B testing: manter versão anterior ativa para X% dos leads</li><li>Canary releases: nova versão para 10% → 50% → 100%</li><li>Circuit breaker: se 3 rollbacks consecutivos, desabilitar auto-apply</li></ul><hr><h2 id="_8-estimativa-de-impacto" tabindex="-1">8. ESTIMATIVA DE IMPACTO <a class="header-anchor" href="#_8-estimativa-de-impacto" aria-label="Permalink to &quot;8. ESTIMATIVA DE IMPACTO&quot;">​</a></h2><h3 id="beneficios-da-integracao" tabindex="-1">Benefícios da Integração <a class="header-anchor" href="#beneficios-da-integracao" aria-label="Permalink to &quot;Benefícios da Integração&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Benefício</th><th>Impacto Estimado</th></tr></thead><tbody><tr><td><strong>Redução de false positives</strong></td><td>-30% a -50% (via reflection loop)</td></tr><tr><td><strong>Melhoria de conversão</strong></td><td>+15% a +25% (prompts otimizados)</td></tr><tr><td><strong>Redução de custo de IA</strong></td><td>-20% (menos re-classificações)</td></tr><tr><td><strong>Time-to-market</strong></td><td>-40% (auto-apply sem intervenção)</td></tr><tr><td><strong>Escalabilidade</strong></td><td>10x (multi-tenant unificado)</td></tr></tbody></table><h3 id="esforco-de-desenvolvimento" tabindex="-1">Esforço de Desenvolvimento <a class="header-anchor" href="#esforco-de-desenvolvimento" aria-label="Permalink to &quot;Esforço de Desenvolvimento&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Fase</th><th>Esforço</th><th>Risco</th></tr></thead><tbody><tr><td>Fase 1: Foundation</td><td>2 semanas</td><td>Baixo</td></tr><tr><td>Fase 2: Self-Improving Personas</td><td>2 semanas</td><td>Médio</td></tr><tr><td>Fase 3: Auto-Apply</td><td>2 semanas</td><td>Alto</td></tr><tr><td>Fase 4: Cross-Learning</td><td>2 semanas</td><td>Médio</td></tr></tbody></table><p><strong>Total</strong>: 8 semanas (2 meses) <strong>Risco geral</strong>: Médio (mitigado por fases incrementais)</p><hr><h2 id="_9-proximos-passos-recomendados" tabindex="-1">9. PRÓXIMOS PASSOS RECOMENDADOS <a class="header-anchor" href="#_9-proximos-passos-recomendados" aria-label="Permalink to &quot;9. PRÓXIMOS PASSOS RECOMENDADOS&quot;">​</a></h2><h3 id="prioridade-alta" tabindex="-1">Prioridade ALTA <a class="header-anchor" href="#prioridade-alta" aria-label="Permalink to &quot;Prioridade ALTA&quot;">​</a></h3><ol><li>✅ <strong>Documentar schemas</strong> (CONCLUÍDO - este documento)</li><li>⏳ <strong>Criar migration 006</strong>: Adicionar <code>tenant_id</code> no AI-Factory</li><li>⏳ <strong>Implementar RLS</strong> no AI-Factory</li><li>⏳ <strong>Criar view unificada</strong> de performance</li></ol><h3 id="prioridade-media" tabindex="-1">Prioridade MÉDIA <a class="header-anchor" href="#prioridade-media" aria-label="Permalink to &quot;Prioridade MÉDIA&quot;">​</a></h3><ol start="5"><li>⏳ <strong>Prototipar Reflection Loop</strong> para personas</li><li>⏳ <strong>Criar dashboard unificado</strong> (Next.js + Supabase)</li><li>⏳ <strong>Implementar webhooks</strong> para notificações</li></ol><h3 id="prioridade-baixa" tabindex="-1">Prioridade BAIXA <a class="header-anchor" href="#prioridade-baixa" aria-label="Permalink to &quot;Prioridade BAIXA&quot;">​</a></h3><ol start="8"><li>⏳ <strong>Cross-learning entre tenants</strong> (Fase 4)</li><li>⏳ <strong>A/B testing framework</strong></li><li>⏳ <strong>Analytics avançado</strong> (ML predictions)</li></ol><hr><h2 id="_10-conclusao" tabindex="-1">10. CONCLUSÃO <a class="header-anchor" href="#_10-conclusao" aria-label="Permalink to &quot;10. CONCLUSÃO&quot;">​</a></h2><h3 id="compatibilidade-1" tabindex="-1">Compatibilidade <a class="header-anchor" href="#compatibilidade-1" aria-label="Permalink to &quot;Compatibilidade&quot;">​</a></h3><p>✅ <strong>Alta</strong>: Ambos os sistemas usam PostgreSQL/Supabase com padrões similares ✅ <strong>Versionamento compatível</strong>: Mesmo approach (version INTEGER + is_active) ✅ <strong>JSONB extensivo</strong>: Flexibilidade para evolução de schemas</p><h3 id="oportunidades" tabindex="-1">Oportunidades <a class="header-anchor" href="#oportunidades" aria-label="Permalink to &quot;Oportunidades&quot;">​</a></h3><p>🚀 <strong>Self-Improving Lead Classifier</strong>: Aplicar Reflection Loop nas personas 🚀 <strong>Multi-Tenant AI-Factory</strong>: Escalar para SaaS 🚀 <strong>Unified Analytics</strong>: Correlacionar performance de prompts com conversão 🚀 <strong>Cross-Learning</strong>: Compartilhar best practices entre tenants</p><h3 id="riscos" tabindex="-1">Riscos <a class="header-anchor" href="#riscos" aria-label="Permalink to &quot;Riscos&quot;">​</a></h3><p>⚠️ <strong>Complexidade</strong>: Multi-tenancy + Auto-apply requer testes extensivos ⚠️ <strong>Custo de IA</strong>: Reflection loops consomem créditos (Claude Sonnet 4) ⚠️ <strong>Data privacy</strong>: Cross-learning requer consent e anonimização</p><h3 id="recomendacao-final" tabindex="-1">Recomendação Final <a class="header-anchor" href="#recomendacao-final" aria-label="Permalink to &quot;Recomendação Final&quot;">​</a></h3><p><strong>✅ INTEGRAÇÃO VIÁVEL E RECOMENDADA</strong></p><p>A integração trará ganhos significativos em:</p><ul><li><strong>Automação</strong>: Menos intervenção manual na otimização</li><li><strong>Performance</strong>: Melhoria contínua de conversão</li><li><strong>Escalabilidade</strong>: Multi-tenant unificado</li><li><strong>ROI</strong>: Redução de custos de IA</li></ul><p><strong>Próximo passo</strong>: Aprovar Fase 1 (Foundation) e iniciar migration 006.</p><hr><p><strong>Documento gerado por</strong>: Database Engineer Agent <strong>Projeto</strong>: AI-Factory V4 - MOTTIVME <strong>Data</strong>: 2026-01-01 <strong>Versão</strong>: 1.0</p>`,151)])])}const g=t(l,[["render",p]]);export{c as __pageData,g as default};

{
  "category": "data_transform",
  "count": 23,
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a6c297c-ff22-4d5d-9f91-35eaa64b0d9a",
              "name": "=dados",
              "value": "={{ $execution.id }},{{ $workflow.id }},{{ $workflow.name }},1,1.99,{{ $execution.mode }},running,cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "f3b2358a-0eec-409b-9d61-a27ea7fbe59d",
              "name": "session",
              "value": "=etapa,{{ $('Info').first().json.etapa_funil || 'NULL' }},{{ $execution.id }},{{ $('Info').first().json.lead_id}},{{ !$('Info').first().json.n8n_ativo === false }},{{ $('Info').first().json.mensagem_id || 'NULL' }},{{ $('Info').first().json.api_key || 'NULL' }},{{ $json.contact.locationId || NULL }},{{ $('Info').first().json.source || 'whatsapp' }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false,
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        0
      ],
      "id": "14dc08c9-6f5e-4429-a868-ca28b454e0d2",
      "name": "GetInfo",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const ultima_mensagem_da_fila = $('Buscar mensagens').last();\nconst mensagem_do_workflow = $('Info').first().json.mensagem_id;\n\n// Parsear o JSON string\nlet last_db = null;\ntry {\n  last_db = JSON.parse(ultima_mensagem_da_fila.json.last_db_message);\n} catch(e) {\n  last_db = null;\n}\n\nif (last_db && last_db.id_mensagem !== mensagem_do_workflow) {\n  // Mensagem encavalada, para o workflow\n  return [];\n}\n\n// Pass-through da fila de mensagens\nreturn $('Buscar mensagens').all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2592,
        400
      ],
      "id": "0c9429d0-203b-4d6f-9612-05a13060c3e8",
      "name": "Mensagem encavalada?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c3bb05a3-1c9e-4993-a20f-7d92b005cc09",
              "name": "last_db_message",
              "value": "={{ $input.last().json }}",
              "type": "string"
            },
            {
              "id": "80a47b08-9d11-4fa6-b5c0-c892bd503182",
              "name": "current_message",
              "value": "={{ $('Info').first().json.mensagem_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2368,
        400
      ],
      "id": "61f04e47-7359-4fe8-9a9c-abb250585369",
      "name": "Form Mensagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fd3e8b9e-eed6-4f43-94c8-089af8417065",
              "name": "imagem",
              "value": "={{ $json.content[0].text ? \"[Imagem Recebida]: \"+ $json.content[0].text : \"\"}}",
              "type": "string"
            },
            {
              "id": "a3bc628f-18b3-4e08-b620-65c5a3a57b40",
              "name": "audio:",
              "value": "={{ $json.text ? \"[Audio Recebido]: \"+ $json.text : \"\"}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2832,
        592
      ],
      "id": "5ebe40bf-dec2-4b59-898e-1320f7a3ac44",
      "name": "Imagem ou audio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ \n  ['arquivo de imagem', 'arquivo de áudio', 'mensagem de áudio', ''].includes(($json.mensagem || '').toLowerCase().trim()) \n    ? ($('Imagem ou audio').first().json['audio:'] || $('Imagem ou audio').first().json.imagem || $('Info').first().json.mensagem || '')\n    : ($json.mensagem || $('Info').first().json.mensagem || '')\n}}",
              "type": "string"
            },
            {
              "id": "09b2dd8b-c24b-49e8-bc36-918ae46a4f6b",
              "name": "output_preview",
              "value": "={{ $json.output_preview }}",
              "type": "string"
            },
            {
              "id": "562253ae-7585-480e-ba6e-4774dbfd05ae",
              "name": "mensagens_antigas",
              "value": "={{ \n  $('Mensagem anteriores').all()\n    .map(item => {\n      const prefix = item.json.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.json.message.type === \"human\" && item.json.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.json.message.content;\n      return `[${item.json.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\") \n}}\n",
              "type": "string"
            },
            {
              "id": "d134ff5d-a48c-44d8-9350-572093043f53",
              "name": "=location_id",
              "value": "={{ $('Info').first().json.location_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5072,
        384
      ],
      "id": "1b77c714-71be-4b8d-ad31-055fcf1df9e4",
      "name": "Set mensagens",
      "executeOnce": true
    },
    {
      "parameters": {
        "jsCode": "// Pega o item de entrada\nconst inputItems = $input.all();\n\n// Processa cada item\nconst outputItems = inputItems.map((inputItem, index) => {\n  // Pega os dados do nó Info\n  const infoData = $('Info').first().json;\n  \n  // ===== CRÍTICO: Com returnAll, Postgres retorna múltiplos items =====\n  // Precisamos pegar TODOS os items, não só o último\n  const allMessages = $('Mensagem anteriores').all();\n  \n  console.log(`Total de items do Postgres: ${allMessages.length}`);\n  \n  // Transforma todos os items em um array de mensagens\n  const msgArray = allMessages\n    .map(item => item.json)\n    .filter(item => {\n      return item && item.created_at && item.message && item.message.content;\n    });\n  \n  console.log(`Total de mensagens válidas: ${msgArray.length}`);\n  \n  // Adiciona a mensagem ATUAL do lead ao histórico\n  const mensagemAtual = infoData.mensagem;\n  if (mensagemAtual && mensagemAtual.trim()) {\n    msgArray.push({\n      created_at: new Date().toISOString(),\n      message: {\n        type: \"human\",\n        content: mensagemAtual\n      }\n    });\n  }\n  \n  console.log(`Total com mensagem atual: ${msgArray.length}`);\n  \n  // Deduplica por timestamp + conteúdo\n  const seen = new Map();\n  const unique = msgArray.filter(item => {\n    // Cria chave única baseada em timestamp e conteúdo\n    const timestamp = new Date(item.created_at).getTime();\n    const content = item.message?.content || '';\n    const key = `${timestamp}_${content.substring(0, 100)}`;\n    \n    // Se já viu essa chave, ignora\n    if (seen.has(key)) {\n      console.log(`Duplicata encontrada: ${content.substring(0, 50)}...`);\n      return false;\n    }\n    \n    seen.set(key, true);\n    return true;\n  });\n  \n  console.log(`Mensagens após deduplicação: ${unique.length}`);\n  \n  // Formata as mensagens em ordem cronológica\n  const mensagens_antigas = unique\n    .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))\n    .map(item => {\n      const prefix = item.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.message.type === \"human\" && item.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.message.content;\n      return `[${item.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\");\n  \n  console.log(`Histórico formatado com ${mensagens_antigas.split('\\n\\n').length} mensagens`);\n  \n  // Retorna mantendo o pairedItem\n  return {\n    json: {\n      mensagens_antigas: mensagens_antigas,\n      mensagens_count: unique.length,\n      ...inputItem.json,\n      ...infoData\n    },\n    pairedItem: inputItem.pairedItem\n  };\n});\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4848,
        384
      ],
      "id": "d274f5c1-94fb-4dbf-ba77-e83025bc6f0f",
      "name": "Deduplica Mensagens"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb6433a3-a8c8-41fc-ba24-c5508055f5e7",
              "name": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}",
              "type": "string"
            },
            {
              "id": "e3c59cf4-b8fb-47bd-9201-0cde177d3f2c",
              "name": "mensagem",
              "value": "={{ $('Info').first().json.mensagem }}",
              "type": "string"
            },
            {
              "id": "551981a4-e58d-4ee7-b27f-1d1bba8fde43",
              "name": "datetime",
              "value": "={{ $('Info').first().json.datetime }}",
              "type": "string"
            },
            {
              "id": "74b98426-15c4-4a10-9978-f310ad162656",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            },
            {
              "id": "30c0f0ec-8f71-4d0d-8e88-dfad7fa31d63",
              "name": "full_name",
              "value": "={{ $('Info').item.json.full_name }}",
              "type": "string"
            },
            {
              "id": "96903a49-e8ca-4f89-ac29-404fa61b5a7e",
              "name": "api_key",
              "value": "={{ $json.api_key }}",
              "type": "string"
            },
            {
              "id": "9621f071-1ddc-4b66-8fd1-1152035f623d",
              "name": "location.id",
              "value": "={{ $json.location.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1424,
        -224
      ],
      "id": "cef4e0d4-6b24-40e7-9d2d-9327d4d569a3",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "// Sanitiza a mensagem e constrói o objeto corretamente\nconst info = $('Info').first().json;\nconst mensagem = info.mensagem || '';\n\n// Sanitiza quebras de linha\nconst mensagemLimpa = mensagem\n  .trim()\n  .replace(/\\r\\n/g, '\\n')\n  .replace(/\\r/g, '\\n');\n\n// Retorna o OBJETO diretamente\nreturn [{\n  json: {\n    lead_id: info.lead_id,\n    session_id: info.lead_id,\n    message: {\n      type: \"human\",\n      content: mensagemLimpa,\n      tool_calls: [],\n      additional_kwargs: {},\n      response_metadata: {},\n      invalid_tool_calls: []\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4416,
        384
      ],
      "id": "83d94181-776a-43e5-bb20-d54c65d8b7f5",
      "name": "Preparar Mensagem"
    },
    {
      "parameters": {
        "jsCode": "// Extrai o ID da conversa mais recente\nconst data = $input.first().json;\n\nif (data.conversations && data.conversations.length > 0) {\n  const conversationId = data.conversations[0].id;\n  \n  return [{\n    json: {\n      conversationId: conversationId,\n      contactId: $input.first().json.body?.contact_id || data.conversations[0].contactId\n    }\n  }];\n}\n\n// Se não encontrar conversa, retorna vazio\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        -528
      ],
      "id": "995b1e60-b25c-41fb-8d63-bcf7aab0ddc2",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "99b0ce86-bc45-49c1-89cf-bbdc50e6bdd4",
              "name": "conversationId",
              "value": "={{ $json.conversationId }}",
              "type": "string"
            },
            {
              "id": "504ecb36-c7b7-4ee5-8d06-7473f9e0ff43",
              "name": "contactId",
              "value": "={{ $json.contactId }}",
              "type": "string"
            },
            {
              "id": "5ca544f2-b852-4290-83e3-fe3ab977b6d3",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1680,
        -528
      ],
      "id": "4e81f664-f606-4f1d-b5d2-19af31a16690",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// Coloque isso em um Code node antes do Convert to File\nconst url = $('Download áudio').first().json.photo_audio || '';\nlet extension = 'ogg'; // default para WhatsApp\n\n// Tenta extrair extensão da URL\nconst match = url.match(/\\.(\\w+)(?:\\?|$)/);\nif (match) {\n  extension = match[1];\n}\n\n// Mapeia extensões comuns\nconst mimeTypes = {\n  'ogg': 'audio/ogg',\n  'opus': 'audio/ogg',\n  'mp3': 'audio/mpeg',\n  'wav': 'audio/wav',\n  'm4a': 'audio/mp4',\n  'webm': 'audio/webm'\n};\n\nreturn {\n  json: {\n    ...$input.first().json,\n    fileName: `audio.${extension}`,\n    mimeType: mimeTypes[extension] || 'audio/ogg'\n  },\n  binary: $input.first().binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2160,
        832
      ],
      "id": "d63d037f-80f8-439a-8e55-598ae916cb78",
      "name": "Extrair a extensão"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Extrair output\nlet outputText = '';\nif (typeof data.output === 'string') {\n  outputText = data.output;\n} else if (data.output?.messages?.[0]) {\n  outputText = data.output.messages[0];\n} else if (data.output) {\n  outputText = JSON.stringify(data.output);\n}\n\n// ========================================\n// GEMINI 2.5 PRO (Agente principal)\n// ========================================\nconst PRO_PROMPT_TOKENS = 10050;\nconst PRO_CHARS_POR_TOKEN = 3.4;\nconst PRO_PRECO_INPUT = 1.25;\nconst PRO_PRECO_OUTPUT = 5.00;\n\nconst proCompletionTokens = Math.ceil(outputText.length / PRO_CHARS_POR_TOKEN);\nconst proCustoInput = (PRO_PROMPT_TOKENS / 1000000) * PRO_PRECO_INPUT;\nconst proCustoOutput = (proCompletionTokens / 1000000) * PRO_PRECO_OUTPUT;\nconst proCustoTotal = proCustoInput + proCustoOutput;\n\n// ========================================\n// GEMINI 2.5 FLASH (Tool de chat)\n// ========================================\nconst FLASH_PROMPT_TOKENS = 553;\nconst FLASH_CHARS_POR_TOKEN = 1.6;\nconst FLASH_PRECO_INPUT = 0.15;\nconst FLASH_PRECO_OUTPUT = 0.60;\n\nconst flashCompletionTokens = Math.ceil(outputText.length / FLASH_CHARS_POR_TOKEN);\nconst flashCustoInput = (FLASH_PROMPT_TOKENS / 1000000) * FLASH_PRECO_INPUT;\nconst flashCustoOutput = (flashCompletionTokens / 1000000) * FLASH_PRECO_OUTPUT;\nconst flashCustoTotal = flashCustoInput + flashCustoOutput;\n\n// ========================================\n// TOTAL COMBINADO\n// ========================================\nconst custoTotalUSD = proCustoTotal + flashCustoTotal;\nconst custoTotalBRL = custoTotalUSD * 6;\n\nreturn {\n  json: {\n    output: outputText,\n    custo_pro: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: PRO_PROMPT_TOKENS,\n      tokens_output: proCompletionTokens,\n      custo_usd: parseFloat(proCustoTotal.toFixed(6))\n    },\n    custo_flash: {\n      modelo: 'gemini-2.5-flash',\n      tokens_input: FLASH_PROMPT_TOKENS,\n      tokens_output: flashCompletionTokens,\n      custo_usd: parseFloat(flashCustoTotal.toFixed(6))\n    },\n    custo_total: {\n      custo_usd: parseFloat(custoTotalUSD.toFixed(6)),\n      custo_brl: parseFloat(custoTotalBRL.toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9024,
        320
      ],
      "id": "984d5b6e-e8f2-48ab-b0c6-c1143f678507",
      "name": "Calcular Custo LLM"
    },
    {
      "parameters": {
        "jsCode": "const infoNode = $('Info').first().json;\nconst inputData = $input.first().json;\n\n// ========== 1. EXTRAI CAMPOS CUSTOMIZADOS ==========\nlet customFields = [];\n\nif (inputData.customFields) {\n  customFields = inputData.customFields;\n} else if (Array.isArray(inputData) && inputData[0]?.customFields) {\n  customFields = inputData[0].customFields;\n}\n\nconst ativarIAField = customFields.find(f => f.fieldKey === \"contact.ativar_ia\");\nconst especialistaMotiveField = customFields.find(f => f.fieldKey === \"contact.contactmotive_responsavel\");\nconst objetivoLeadField = customFields.find(f => f.fieldKey === \"contact.objetivo_do_lead\");\n\n// Pega as opções válidas diretamente do picklist do GHL\nconst opcoesObjetivoValidas = (objetivoLeadField?.picklistOptions || []).filter(opt => opt !== 'x');\nconst opcoesEspecialistaValidas = especialistaMotiveField?.picklistOptions || [];\n\n// ========== 2. EXTRAI CONVERSATION ID ==========\nlet conversationId = null;\nlet contactId = infoNode.lead_id || null;\n\nif (inputData.conversations && inputData.conversations.length > 0) {\n  conversationId = inputData.conversations[0].id;\n  contactId = inputData.body?.contact_id || inputData.conversations[0].contactId || contactId;\n}\n\n// ========== 3. DETECTA OBJETIVO ==========\nfunction getString(valor) {\n  if (!valor) return '';\n  if (typeof valor === 'string') return valor;\n  if (typeof valor === 'object') {\n    return valor.text || valor.message || valor.content || '';\n  }\n  return String(valor);\n}\n\nconst mensagem = getString(infoNode.message || infoNode.body).toLowerCase();\nconst objetivoDoLead = getString(infoNode.objetivo_do_lead).toLowerCase();\nconst especialistaMotive = getString(infoNode.contactmotive_responsavel).toLowerCase();\nconst informacoesIA = getString(infoNode.informaes_para_ai).toLowerCase();\n\nconst keywordsCarreira = ['carreira', 'recrutamento', 'recrutar', 'vaga', 'emprego', 'trabalho', 'sdrcarreira', 'socialsellercarreira'];\nconst keywordsConsultoria = ['consultoria', 'consultor', 'mentor', 'mentoria', 'sdrconsultoria', 'socialsellerconsultoria'];\n\nfunction contemKeyword(texto, keywords) {\n  return keywords.some(kw => texto.includes(kw));\n}\n\nfunction detectarObjetivo(texto) {\n  if (contemKeyword(texto, keywordsCarreira)) return 'carreira';\n  if (contemKeyword(texto, keywordsConsultoria)) return 'consultoria';\n  return null;\n}\n\n// Mapeamento objetivo → especialista\nfunction getEspecialista(objetivo) {\n  if (objetivo === 'carreira') return 'sdrcarreira';\n  if (objetivo === 'consultoria') return 'sdrconsultoria';\n  return '';\n}\n\nconst textoCompleto = `${mensagem} ${objetivoDoLead} ${especialistaMotive} ${informacoesIA}`;\n\nconst regexTeste = /\\/teste\\s+(carreira|recrutamento|consultoria|consultor|mentor)/i;\nconst matchTeste = mensagem.match(regexTeste);\n\nlet resultado = 'indefinido';\nlet especialistaDefinido = '';\nlet objetivoDefinido = '';\nlet fonteDeteccao = 'nenhuma';\n\n// Prioridade 1: Comando /teste na mensagem\nif (matchTeste) {\n  const objetivoDetectado = detectarObjetivo(matchTeste[1].toLowerCase());\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'comando_teste';\n  }\n}\n\n// Prioridade 2: Campo objetivo_do_lead já preenchido COM VALOR VÁLIDO\nif (resultado === 'indefinido' && objetivoDoLead && opcoesObjetivoValidas.includes(objetivoDoLead)) {\n  resultado = objetivoDoLead;\n  especialistaDefinido = getEspecialista(objetivoDoLead);\n  objetivoDefinido = objetivoDoLead;\n  fonteDeteccao = 'campo_objetivo';\n}\n\n// Prioridade 3: Especialista já definido\nif (resultado === 'indefinido' && especialistaMotive) {\n  const objetivoDetectado = detectarObjetivo(especialistaMotive);\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'campo_especialista';\n  }\n}\n\n// Prioridade 4: Análise do texto completo\nif (resultado === 'indefinido') {\n  const objetivoDetectado = detectarObjetivo(textoCompleto);\n  if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n    resultado = objetivoDetectado;\n    especialistaDefinido = getEspecialista(objetivoDetectado);\n    objetivoDefinido = objetivoDetectado;\n    fonteDeteccao = 'analise_texto';\n  }\n}\n\n// ========== RETORNA TUDO ==========\nreturn [{\n  json: {\n    // IDs dos campos\n    ativar_ia_id: ativarIAField?.id || null,\n    especialista_motive_id: especialistaMotiveField?.id || null,\n    objetivo_lead_id: objetivoLeadField?.id || null,\n    \n    // IDs da conversa\n    conversationId: conversationId,\n    contactId: contactId,\n    \n    // Resultado da detecção\n    resultado: resultado,\n    especialista_motive: especialistaDefinido,\n    objetivo_lead: objetivoDefinido,\n    fonte_deteccao: fonteDeteccao,\n    precisa_perguntar: resultado === 'indefinido',\n    mensagem_original: mensagem,\n    \n    // Debug - opções válidas do GHL\n    opcoes_objetivo_validas: opcoesObjetivoValidas,\n    opcoes_especialista_validas: opcoesEspecialistaValidas\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        -1152
      ],
      "id": "e3cf8233-fe3a-4edc-930a-874c2e44b4da",
      "name": "2️⃣ Extrair IDs dos campos"
    },
    {
      "parameters": {
        "jsCode": "const infoNode = $('Info').first().json;\nconst inputData = $input.first().json;\n\n// ========== 1. EXTRAI CAMPOS CUSTOMIZADOS ==========\nlet customFields = [];\n\nif (Array.isArray(inputData)) {\n  customFields = inputData[0]?.customFields || [];\n} else if (inputData.customFields) {\n  customFields = inputData.customFields;\n}\n\nconst ativarIAField = customFields.find(f => f.fieldKey === \"contact.ativar_ia\");\nconst especialistaMotiveField = customFields.find(f => f.fieldKey === \"contact.contactmotive_responsavel\");\nconst objetivoLeadField = customFields.find(f => f.fieldKey === \"contact.objetivo_do_lead\");\n\n// Pega APENAS opções válidas do GHL (filtra 'x' e vazios)\nconst opcoesObjetivoValidas = (objetivoLeadField?.picklistOptions || []).filter(opt => opt && opt.toLowerCase() !== 'x');\nconst opcoesEspecialistaValidas = (especialistaMotiveField?.picklistOptions || []).filter(opt => opt && opt.toLowerCase() !== 'x');\n\n// ========== 2. EXTRAI CONVERSATION ID E SOURCE ==========\nlet conversationId = null;\nlet contactId = infoNode.lead_id || null;\nlet source = (infoNode.source || infoNode.channel || '').toLowerCase();\n\nif (inputData.conversations && inputData.conversations.length > 0) {\n  conversationId = inputData.conversations[0].id;\n  contactId = inputData.body?.contact_id || inputData.conversations[0].contactId || contactId;\n}\n\n// ========== 3. DETECTA OBJETIVO ==========\nfunction getString(valor) {\n  if (!valor) return '';\n  if (typeof valor === 'string') return valor;\n  if (typeof valor === 'object') {\n    return valor.text || valor.message || valor.content || '';\n  }\n  return String(valor);\n}\n\nconst mensagem = getString(infoNode.message || infoNode.body).toLowerCase();\nconst objetivoDoLead = getString(infoNode.objetivo_do_lead).toLowerCase();\nconst especialistaMotive = getString(infoNode.contactmotive_responsavel).toLowerCase();\nconst informacoesIA = getString(infoNode.informaes_para_ai).toLowerCase();\n\nconst keywordsCarreira = ['carreira', 'recrutamento', 'recrutar', 'vaga', 'emprego', 'trabalho'];\nconst keywordsConsultoria = ['consultoria', 'consultor', 'mentor', 'mentoria'];\n\nfunction contemKeyword(texto, keywords) {\n  return keywords.some(kw => texto.includes(kw));\n}\n\nfunction detectarObjetivo(texto) {\n  if (contemKeyword(texto, keywordsCarreira)) return 'carreira';\n  if (contemKeyword(texto, keywordsConsultoria)) return 'consultoria';\n  return null;\n}\n\nfunction getEspecialista(objetivo) {\n  if (objetivo === 'carreira') return 'sdrcarreira';\n  if (objetivo === 'consultoria') return 'sdrconsultoria';\n  return '';\n}\n\n// Verifica se opções válidas existem no GHL\nconst temOpcoesValidas = opcoesObjetivoValidas.length > 0;\n\nconst textoCompleto = `${mensagem} ${objetivoDoLead} ${especialistaMotive} ${informacoesIA}`;\n\nconst regexTeste = /\\/teste\\s+(carreira|recrutamento|consultoria|consultor|mentor)/i;\nconst matchTeste = mensagem.match(regexTeste);\n\nlet resultado = 'indefinido';\nlet especialistaDefinido = '';\nlet objetivoDefinido = '';\nlet fonteDeteccao = 'nenhuma';\n\n// SÓ DETECTA SE TIVER OPÇÕES VÁLIDAS NO GHL\nif (temOpcoesValidas) {\n  \n  // Prioridade 1: Comando /teste na mensagem\n  if (matchTeste) {\n    const objetivoDetectado = detectarObjetivo(matchTeste[1].toLowerCase());\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'comando_teste';\n    }\n  }\n\n  // Prioridade 2: Campo objetivo_do_lead já preenchido COM VALOR VÁLIDO\n  if (resultado === 'indefinido' && objetivoDoLead && opcoesObjetivoValidas.includes(objetivoDoLead)) {\n    resultado = objetivoDoLead;\n    especialistaDefinido = getEspecialista(objetivoDoLead);\n    objetivoDefinido = objetivoDoLead;\n    fonteDeteccao = 'campo_objetivo';\n  }\n\n  // Prioridade 3: Especialista já definido\n  if (resultado === 'indefinido' && especialistaMotive) {\n    const objetivoDetectado = detectarObjetivo(especialistaMotive);\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'campo_especialista';\n    }\n  }\n\n  // Prioridade 4: Análise do texto completo\n  if (resultado === 'indefinido') {\n    const objetivoDetectado = detectarObjetivo(textoCompleto);\n    if (objetivoDetectado && opcoesObjetivoValidas.includes(objetivoDetectado)) {\n      resultado = objetivoDetectado;\n      especialistaDefinido = getEspecialista(objetivoDetectado);\n      objetivoDefinido = objetivoDetectado;\n      fonteDeteccao = 'analise_texto';\n    }\n  }\n}\n\n// ========== RETORNA TUDO ==========\nreturn [{\n  json: {\n    // IDs dos campos\n    ativar_ia_id: ativarIAField?.id || null,\n    especialista_motive_id: especialistaMotiveField?.id || null,\n    objetivo_lead_id: objetivoLeadField?.id || null,\n    \n    // IDs da conversa\n    conversationId: conversationId,\n    contactId: contactId,\n    source: source,\n    \n    // Resultado da detecção\n    resultado: resultado,\n    especialista_motive: especialistaDefinido,\n    objetivo_lead: objetivoDefinido,\n    fonte_deteccao: fonteDeteccao,\n    precisa_perguntar: resultado === 'indefinido',\n    mensagem_original: mensagem,\n    \n    // Debug\n    opcoes_ghl_validas: opcoesObjetivoValidas,\n    tem_opcoes_validas: temOpcoesValidas\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1744,
        -1152
      ],
      "id": "eefbeadb-4058-4ffc-899b-ded0d5c7fabb",
      "name": "3️⃣ Detectar Objetivo"
    },
    {
      "parameters": {
        "jsCode": "const customData = $input.first().json.body?.customData || $input.first().json.customData || {};\nconst body = $input.first().json.body || $input.first().json || {};\n\nconst anexo = (\n  customData.attachments || \n  customData.photo_audio || \n  body.attachments ||\n  body.photo_audio ||\n  ''\n).toLowerCase();\n\nlet tipo_mensagem_original = 'texto';\n\n// Imagens\nif (anexo.includes('.jpg') || anexo.includes('.jpeg') || anexo.includes('.png') || anexo.includes('.gif') || anexo.includes('.webp')) {\n  tipo_mensagem_original = 'imagem';\n}\n// PDF\nelse if (anexo.includes('.pdf')) {\n  tipo_mensagem_original = 'pdf';\n}\n// Planilhas e CSV\nelse if (anexo.includes('.csv') || anexo.includes('.xls') || anexo.includes('.xlsx')) {\n  tipo_mensagem_original = 'planilha';\n}\n// Áudio - AGORA INCLUI .MP4\nelse if (anexo.includes('.mp3') || anexo.includes('.ogg') || anexo.includes('.wav') || anexo.includes('.m4a') || anexo.includes('.opus') || anexo.includes('.mp4')) {\n  tipo_mensagem_original = 'audio';\n}\n// Documentos Word\nelse if (anexo.includes('.doc') || anexo.includes('.docx')) {\n  tipo_mensagem_original = 'documento_word';\n}\n\nreturn {\n  ...$input.first().json,\n  tipo_mensagem_original,\n  anexo_url: anexo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        192,
        400
      ],
      "id": "9c3a06ca-329b-4b18-b4f8-01b69685e9fe",
      "name": "Classificar Tipo Mensagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "734cd3ca-c411-46fe-8924-1ea800f80804",
              "name": "mensagem",
              "value": "={{ ($json.body?.message?.body || '').trim() || $json.mensagem_contexto || ($json.body?.customData?.message?.split(\"Instance Source:\")[0] ?? $json.body?.message?.content?.text ?? '').trim() }}",
              "type": "string"
            },
            {
              "id": "ccb3a74d-0336-4a28-9f43-7bdaff77b906",
              "name": "source",
              "value": "={{ \n  // Prioriza o canal da mensagem ATUAL, não a origem do lead\n  (() => {\n    const messageType = $json.body?.message?.type;\n    \n    // Type 2 = SMS - responde por SMS (usa \"whatsapp\" que no seu workflow envia SMS)\n    if (messageType === 2) return \"whatsapp\";\n    \n    // Type 15 = Instagram DM - pode responder por Instagram\n    if (messageType === 15) return \"instagram\";\n    \n    // Se não conseguir identificar pelo type, verifica a origem\n    // mas só usa Instagram se o type não for SMS\n    const origin = $json.body?.contact?.attributionSource?.medium;\n    if (origin === \"instagram\" && messageType !== 2 && messageType !== 20) return \"instagram\";\n    \n    // Default: SMS/WhatsApp (mais seguro)\n    return \"whatsapp\";\n  })().trim()\n}}",
              "type": "string"
            },
            {
              "id": "332d6a13-10c8-465f-8ddb-fa97266f9fec",
              "name": "first_name",
              "value": "={{ $json.first_name }}",
              "type": "string"
            },
            {
              "id": "60cb5031-9132-4c86-9ab7-c487a170c9e3",
              "name": "last_name",
              "value": "={{ $json.last_name }}",
              "type": "string"
            },
            {
              "id": "9d4ae7a5-635b-4dbc-93d1-9464ace3208c",
              "name": "email",
              "value": "={{ $json.body?.email }}",
              "type": "string"
            },
            {
              "id": "d6301da3-de8a-45e3-9705-32cf65c3bf1e",
              "name": "telefone",
              "value": "={{ $json.body?.customData?.phone }}",
              "type": "string"
            },
            {
              "id": "7e094af2-d305-42ba-b6d2-014b62231ebb",
              "name": "datetime",
              "value": "={{ $json.body?.date_created }}",
              "type": "string"
            },
            {
              "id": "f3471b65-9533-4f5c-a669-60aaf549b4e8",
              "name": "process_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "257ef1e2-26bb-461e-8335-3d1101d3cda6",
              "name": "owner_origin",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "1e235f54-27cf-4b91-b156-1c0a69149370",
              "name": "owner_id",
              "value": "=cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "5041121e-02b1-4993-ad9c-34131a44b08d",
              "name": "timezone_do_lead",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "367c6400-fd93-4f50-a09b-b2d56aea0bd9",
              "name": "lead_id",
              "value": "={{ $json.body?.contact_id }}",
              "type": "string"
            },
            {
              "id": "66a3f763-5dbe-4033-abd7-3079835a035a",
              "name": "mensagem_id",
              "value": "={{ $json.starttimeMs }}",
              "type": "string"
            },
            {
              "id": "110eb8f6-d0b2-4358-a002-3741abbcfeb7",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "ab843596-5dfa-41d7-8ac4-02cd1dd5b661",
              "name": "api_key",
              "value": "={{ $json.body?.customData?.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "8be8461d-83f1-4563-9e2e-46e978d3afb4",
              "name": "location_id",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "3df2e105-88b1-4d12-b957-6b5d909056be",
              "name": "tipo",
              "value": "={{ $json.body?.customData?.tipo }}",
              "type": "string"
            },
            {
              "id": "d1fa8d84-c23b-4292-86bc-2066e14c7882",
              "name": "calendarID_carreira",
              "value": "={{ $json.body?.customData?.calendar_id_carreira }}",
              "type": "string"
            },
            {
              "id": "cca7fe8b-af83-40c1-ba8b-d4de7cd21c47",
              "name": "calendarID_consultoria_financeira",
              "value": "={{ $json.body?.customData?.consultoria_financeira }}",
              "type": "string"
            },
            {
              "id": "dad6c1f3-82b2-45ea-b3be-c512a879ac98",
              "name": "origem_teste",
              "value": "Marcos Danielss",
              "type": "string"
            },
            {
              "id": "3038f1ef-1199-4aab-9354-dc9463c775de",
              "name": "etiquetas",
              "value": "={{ $json.body?.tags }}",
              "type": "string"
            },
            {
              "id": "4100931a-e49b-4b97-8a16-7a797b67899e",
              "name": "area_de_atuacao",
              "value": "={{ $json.body?.['Qual a sua área de atuação?']?.[0] }}",
              "type": "string"
            },
            {
              "id": "4ed525e0-9bb6-4663-980a-70a10db813d4",
              "name": "idade",
              "value": "={{ $json.body?.Idade }}",
              "type": "string"
            },
            {
              "id": "b14c96ea-7093-48b6-add5-dd0159af29cd",
              "name": "instagram",
              "value": "={{ $json.body?.Instagram }}",
              "type": "string"
            },
            {
              "id": "9d450e98-e0e3-48fb-bb77-41c6d701f227",
              "name": "modelo_de_atuacao",
              "value": "={{ $json.body?.['Modelo de atuação'] }}",
              "type": "string"
            },
            {
              "id": "69b88a48-6d28-42b1-8ff4-5120e516f348",
              "name": "faturamento_medio",
              "value": "={{ $json.body?.['Faturamento médio'] }}",
              "type": "string"
            },
            {
              "id": "35274cdc-7a80-4945-9296-5d74db32aff2",
              "name": "investimento",
              "value": "={{ $json.body?.Investimento }}",
              "type": "string"
            },
            {
              "id": "247f2856-13b1-4bc4-bb55-cf7842680459",
              "name": "event_chat",
              "value": "={{ $json.body?.event?.Info?.Chat }}",
              "type": "string"
            },
            {
              "id": "dda2ed54-8e91-41e2-92c9-1b2d12763e2b",
              "name": "event_is_group",
              "value": "={{ $json.body?.event?.Info?.IsGroup }}",
              "type": "boolean"
            },
            {
              "id": "b9e46b5c-3fb8-4be2-bb9e-71080728bd85",
              "name": "video_ads_url",
              "value": "={{ $json.body?.contact?.attributionSource?.videoUrl }}",
              "type": "string"
            },
            {
              "id": "16308ff3-20b3-4fd4-b126-21c34248530b",
              "name": "time_zone_do_agente",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "2566e00f-ecfd-44e8-bab2-7d68447e3b9a",
              "name": "historia_do_usuario",
              "value": "={{ $json.body?.customData?.minha_historias }}",
              "type": "string"
            },
            {
              "id": "391cb65e-46a0-475b-8c42-3629883ad983",
              "name": "usuario_responsavel",
              "value": "={{ $json.body?.user?.firstName }} {{ $json.body?.user?.lastName }}",
              "type": "string"
            },
            {
              "id": "1cd51504-1dc9-4aea-956a-9a4757db1b6c",
              "name": "photo_audio",
              "value": "={{ $json.body?.customData?.photo_audio?.split(',')[0]?.trim() }}",
              "type": "string"
            },
            {
              "id": "77c42ca4-2ef7-4a40-b1ed-2fc5e8af7292",
              "name": "fonte_do_lead_bposs",
              "value": "={{ $json.body?.customData?.fonte_do_lead_bposs }}",
              "type": "string"
            },
            {
              "id": "a976a2ec-ed9f-452b-91d1-5725631ae2d5",
              "name": "quebra_de_objecoes_geral",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_geral }}",
              "type": "string"
            },
            {
              "id": "cc085a35-fef6-47b9-ad97-e9d671a71d29",
              "name": "quebra_de_objecoes_carreira",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_carreira }}",
              "type": "string"
            },
            {
              "id": "8f3c6a4d-df4f-4de7-ad41-0177eb567ed4",
              "name": "quebra_de_objecoes_consultoria",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_consultoria }}",
              "type": "string"
            },
            {
              "id": "03c2a02f-e2c2-4d42-afe3-3d6b7bfae375",
              "name": "tipos_work_permit_permitidos",
              "value": "={{ $json.body?.customData?.estruturas_work_permit }}",
              "type": "string"
            },
            {
              "id": "2d89fd62-be99-4c63-9bf9-c2b97c0cc735",
              "name": "link_do_zoom",
              "value": "={{ $json.body?.customData?.link_do_zoom }}",
              "type": "string"
            },
            {
              "id": "939d130d-8780-41e6-9693-10b83cd9bab5",
              "name": "agendamento_duracao_minutos",
              "value": "30",
              "type": "string"
            },
            {
              "id": "c9a26bfa-ced7-4b82-a6bb-2c0aeb46f9a3",
              "name": "cobranca_valor",
              "value": "500",
              "type": "string"
            },
            {
              "id": "9290e4ff-d01b-4fca-b5f3-7605d4f74c07",
              "name": "id_conversa_alerta",
              "value": "skfa6JP6lLlAXkc8FfIp",
              "type": "string"
            },
            {
              "id": "c594a0f2-aba9-458c-92ff-81e73086416c",
              "name": "url_asaas",
              "value": "https://api-sandbox.asaas.com",
              "type": "string"
            },
            {
              "id": "103fad86-a8b6-4591-b310-2dc7069bc189",
              "name": "etapa_funil",
              "value": "={{ $json.body?.customData?.etapa_funil }}",
              "type": "string"
            },
            {
              "id": "3ae92580-436d-4dfc-a7cc-f83f8f68309e",
              "name": "full_name",
              "value": "={{ $json.nome_completo }}",
              "type": "string"
            },
            {
              "id": "5476f99e-273b-45a1-996f-b98cb86ddd25",
              "name": "work_permit",
              "value": "={{ $json.body?.customData?.work_permit }}",
              "type": "string"
            },
            {
              "id": "989fb582-9e56-4962-8883-6076627c72b5",
              "name": "state",
              "value": "={{ $json.body?.customData?.state }}",
              "type": "string"
            },
            {
              "id": "15265189-0d84-420c-b7da-6181170a6b08",
              "name": "location_name",
              "value": "={{ $json.body?.location?.name }}",
              "type": "string"
            },
            {
              "id": "5770d76c-1a0f-4515-9683-381881715eb5",
              "name": "resposta_ia",
              "value": "={{ $json.body?.['Resposta IA'] }}",
              "type": "string"
            },
            {
              "id": "b1871710-95d0-495d-9592-ff09ea8ab983",
              "name": "objetivo_do_lead",
              "value": "={{ $json.objetivo_do_lead }}",
              "type": "string"
            },
            {
              "id": "5a729725-994d-46e5-a6f1-aac7b9504a3a",
              "name": "ativar_ia",
              "value": "={{ $json.ativar_ia }}",
              "type": "string"
            },
            {
              "id": "5e293330-4c28-4ae8-92ef-e99bc9feb55e",
              "name": "utm_content",
              "value": "={{ $json.utm_content }}",
              "type": "string"
            },
            {
              "id": "7d94c551-b241-48e8-84e8-9ab152f6a526",
              "name": "agente_ia",
              "value": "={{ $json.agente_ia }}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "mensagem_contexto",
              "value": "={{ $json.mensagem_contexto }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "is_primeira_mensagem",
              "value": "={{ $json.is_primeira_mensagem }}",
              "type": "boolean"
            },
            {
              "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
              "name": "tipo_lead",
              "value": "={{ $json.tipo_lead }}",
              "type": "string"
            },
            {
              "id": "301166ea-a33e-4fa8-a1ec-3a3a0fd00923",
              "name": "tipo_mensagem_original",
              "value": "={{ \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.ogg') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp3') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.opus') || \n  ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.mp4') || \n  ($('Mensagem recebida').item.json.body.customData?.message || '').startsWith('Mensagem de Áudio') \n    ? 'audio' \n    : ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpeg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.jpg') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.png') || \n      ($('Mensagem recebida').item.json.body.customData?.photo_audio || '').includes('.webp') \n        ? 'imagem' \n        : 'texto' \n}}",
              "type": "string"
            },
            {
              "id": "368ffdd1-2395-4632-b738-e35ebfbe0832",
              "name": "body.customData.ghl_api_key",
              "value": "={{ $('Mensagem recebida').item.json.body.customData.ghl_api_key }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        320,
        400
      ],
      "id": "f1d208a5-f05b-45bb-ae27-8ceb310344a1",
      "name": "Info"
    },
    {
      "parameters": {
        "jsCode": "const start = new Date();\nconst starttimeISO = start.toISOString();\nconst starttimeMs = start.getTime();\n\nconst end = new Date(start);\nend.setDate(end.getDate() + 7);\nconst endtimeISO = end.toISOString();\nconst endtimeMs = end.getTime();\n\nconst inputData = $input.first().json;\n\nreturn [{\n  json: {\n    ...inputData,\n    starttimeISO,\n    starttimeMs,\n    endtimeISO,\n    endtimeMs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        400
      ],
      "id": "f94f1796-7e0e-41a6-b5b9-dc9bdb08be95",
      "name": "Code1"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar dados do lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst customData = body.customData || {};\nconst tags = (body.tags || '').toLowerCase();\nconst utmContent = body.contact?.attributionSource?.utmContent || '';\n\n// === OBJETIVO DO LEAD ===\nlet objetivo_do_lead = customData.objetivodolead || '';\n\nif (!objetivo_do_lead) {\n  if (tags.includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (tags.includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else if (utmContent.toLowerCase().includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (utmContent.toLowerCase().includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else {\n    objetivo_do_lead = 'indefinido'; // ✅ Não assume mais 'carreira' como padrão\n  }\n}\n\n// === AGENTE IA ===\nlet agente_ia = customData.motive || '';\n\nif (!agente_ia) {\n  // Verifica tags específicas\n  if (tags.includes('closer')) {\n    agente_ia = 'closer';\n  } else if (tags.includes('followuper')) {\n    agente_ia = 'followuper';\n  } else if (objetivo_do_lead === 'consultoria') {\n    agente_ia = 'sdrconsultoria';\n  } else if (objetivo_do_lead === 'carreira') {\n    agente_ia = 'sdrcarreira';\n  } else {\n    agente_ia = 'indefinido'; // ✅ Leads sem classificação clara\n  }\n}\n// ✅ Se customData.motive vier com 'assistente_admin' ou 'assistente_interno', \n//    mantém o valor original\n\n// === ATIVAR IA ===\nlet ativar_ia = customData.ativar_ia || '';\n\nif (tags.includes('perdido')) {\n  ativar_ia = 'nao';\n} else if (utmContent) {\n  ativar_ia = 'sim';\n} else if (ativar_ia === 'sim' || tags.includes('ativar_ia')) {\n  ativar_ia = 'sim';\n} else {\n  ativar_ia = 'nao';\n}\n\nreturn {\n  json: {\n    ...inputData,\n    objetivo_do_lead,\n    agente_ia,\n    ativar_ia,\n    utm_content: utmContent,\n    tags_original: body.tags\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        400
      ],
      "id": "13417ca6-d87d-4026-bc68-428b9d441a65",
      "name": "Normalizar Dados1"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar Nome do Lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\n\nlet nome = body.full_name || ((body.first_name || '') + ' ' + (body.last_name || '')).trim() || body.customData?.name || '';\nconst nomeOriginal = nome;\n\nnome = nome.replace(/\\d+/g, '').trim();\nnome = nome.replace(/[_\\-.@]/g, ' ').trim();\nnome = nome.replace(/([a-z])([A-Z])/g, '$1 $2');\n\nconst apelidosCurtos = ['lu', 'le', 'li', 'jo', 'ze', 'ma', 'mi', 'ju', 'du', 'bi', 'ca', 'ka', 'fe', 'be', 'ne', 're', 'ra', 'ro', 'vi', 'va', 'na', 'ni', 'ta', 'ti', 'la', 'lo', 'ed', 'el'];\n\nfunction separarApelidoSobrenome(str) {\n  if (str.includes(' ')) return str;\n  if (str.length <= 10) return str;\n  const lower = str.toLowerCase();\n  for (let len = 2; len <= 3; len++) {\n    const possivel = lower.slice(0, len);\n    if (apelidosCurtos.includes(possivel)) {\n      const resto = str.slice(len);\n      if (resto.length >= 4) return str.slice(0, len) + ' ' + resto;\n    }\n  }\n  return str;\n}\n\nnome = separarApelidoSobrenome(nome);\nnome = nome.replace(/\\s+/g, ' ').trim();\n\nfunction capitalizar(str) {\n  const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  return str.toLowerCase().split(' ').map((palavra, i) => {\n    if (i > 0 && preposicoes.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n}\n\nlet partes = nome.split(' ').filter(p => p.length > 0);\nlet firstName = partes[0] || nome || '';\nlet lastName = partes.slice(1).join(' ') || '';\n\nfirstName = capitalizar(firstName);\nlastName = capitalizar(lastName);\n\nconst tinhaNumero = /\\d/.test(nomeOriginal);\nconst qualidade = (firstName.length < 2 || tinhaNumero) ? 'revisar' : 'ok';\n\nreturn {\n  json: {\n    ...inputData,\n    nome_original: nomeOriginal,\n    first_name: firstName,\n    last_name: lastName,\n    nome_completo: lastName ? `${firstName} ${lastName}` : firstName,\n    qualidade_nome: qualidade\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        400
      ],
      "id": "2613bf85-8e78-4ce2-8a5b-4824bd8f62a9",
      "name": "Normalizar Nome1"
    },
    {
      "parameters": {
        "jsCode": "// Contexto Inicial do Lead baseado em UTM\nconst input = $input.first().json.body;\n\nconst utmContent = input.contact?.attributionSource?.utmContent || '';\nconst messageBody = (input.message?.body || '').trim();\nconst isPrimeiraMensagem = !messageBody || messageBody === '' || messageBody === ' ';\n\nconst contextoPorUTM = {\n  'CARREIRA': {\n    contexto: 'Lead interessado em CARREIRA no mercado financeiro americano',\n    interesse: 'Oportunidades de carreira como agente de seguros nos EUA',\n    abordagem: 'Falar sobre licenciamento, ganhos, estrutura de trabalho'\n  },\n  'CONSULTORIA': {\n    contexto: 'Lead interessado em CONSULTORIA financeira pessoal',\n    interesse: 'Planejamento financeiro, proteção patrimonial, seguros',\n    abordagem: 'Falar sobre benefícios, proteção familiar, investimentos'\n  },\n  'INVESTIMENTO': {\n    contexto: 'Lead interessado em INVESTIMENTOS',\n    interesse: 'Opções de investimento e crescimento patrimonial',\n    abordagem: 'Falar sobre produtos financeiros, retornos, segurança'\n  }\n};\n\nlet tipoLead = '';\nfor (const tipo of Object.keys(contextoPorUTM)) {\n  if (utmContent.toUpperCase().includes(tipo)) {\n    tipoLead = tipo;\n    break;\n  }\n}\n\nlet mensagemContexto = '';\nlet contextoObj = null;\n\nif (isPrimeiraMensagem && tipoLead) {\n  contextoObj = contextoPorUTM[tipoLead];\n  mensagemContexto = `[CONTEXTO DO LEAD]\\nTipo: ${tipoLead}\\n${contextoObj.contexto}\\nInteresse principal: ${contextoObj.interesse}\\nAbordagem sugerida: ${contextoObj.abordagem}\\n\\nWork Permit: ${input['Work Permit'] || input.customData?.work_permit || 'Não informado'}\\nEstado: ${input['Estado onde mora'] || 'Não informado'}\\n`;\n}\n\nreturn {\n  json: {\n    body: input,\n    is_primeira_mensagem: isPrimeiraMensagem,\n    tem_contexto_utm: !!tipoLead,\n    tipo_lead: tipoLead || 'NAO_IDENTIFICADO',\n    utm_content: utmContent,\n    mensagem_contexto: mensagemContexto,\n    mensagem_original: messageBody,\n    work_permit: input['Work Permit'] || input.customData?.work_permit || '',\n    estado: input['Estado onde mora'] || '',\n    contexto_para_ai: isPrimeiraMensagem && contextoObj ? contextoObj : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        400
      ],
      "id": "8ec83b65-d1ee-44ed-9c6c-518767efaa96",
      "name": "Contexto UTM"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "790a5682-0b9a-413b-9626-01f6d49c4206",
              "name": "mensagem",
              "value": "={{ $('In3fo').item.json.mensagem }}",
              "type": "string"
            },
            {
              "id": "df7207e1-10cf-4fc8-be3e-58a2cbe6768b",
              "name": "api_key",
              "value": "={{ $('Info').item.json.api_key }}",
              "type": "string"
            },
            {
              "id": "fff142a6-bb90-419c-ac87-4be400fccc5e",
              "name": "location_id",
              "value": "={{ $('Info').item.json.location_id }}",
              "type": "string"
            },
            {
              "id": "42e917b9-b94a-427f-ad56-488d1e838eb8",
              "name": "location_name",
              "value": "={{ $('Info').item.json.location_name }}",
              "type": "string"
            },
            {
              "id": "206bb985-a330-4859-9352-2205d5c23553",
              "name": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}",
              "type": "string"
            },
            {
              "id": "a0ae9724-d22a-4e0b-abd9-944d1819d289",
              "name": "photo_audio",
              "value": "={{ $('Info').item.json.photo_audio }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1088,
        672
      ],
      "id": "a53eef4d-8a90-4ff4-9be3-107e122fd71c",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst outputText = data.output || '';\n\n// ========================================\n// ESTIMATIVA DE TOKENS - CALIBRADO v2\n// ========================================\n\n// Completion: 3.4 chars por token\nconst CHARS_POR_TOKEN_OUTPUT = 3.4;\n\n// Prompt: calibrado com média dos seus dados reais\n// 9922, 9962, 10042 -> média ~9975, arredondando pra 10050\nconst PROMPT_TOKENS_BASE = 10050;\n\n// Calcular completion tokens\nconst completionTokens = Math.ceil(outputText.length / CHARS_POR_TOKEN_OUTPUT);\n\nconst promptTokens = PROMPT_TOKENS_BASE;\nconst totalTokens = promptTokens + completionTokens;\n\n// ========================================\n// CÁLCULO DE CUSTO - Gemini 2.5 Pro\n// ========================================\nconst PRECO_INPUT = 1.25;\nconst PRECO_OUTPUT = 5.00;\n\nconst custoInput = (promptTokens / 1000000) * PRECO_INPUT;\nconst custoOutput = (completionTokens / 1000000) * PRECO_OUTPUT;\nconst custoTotal = custoInput + custoOutput;\n\nreturn {\n  json: {\n    output: outputText,\n    tokenUsage: {\n      promptTokens: promptTokens,\n      completionTokens: completionTokens,\n      totalTokens: totalTokens,\n      metodo: 'estimativa'\n    },\n    custo_llm: {\n      modelo: 'gemini-2.5-pro',\n      tokens_input: promptTokens,\n      tokens_output: completionTokens,\n      tokens_total: totalTokens,\n      custo_usd: parseFloat(custoTotal.toFixed(6)),\n      custo_brl: parseFloat((custoTotal * 6).toFixed(4)),\n      tipo: 'estimado'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7280,
        368
      ],
      "id": "652cfa81-36ca-4a54-9752-b2a51205df53",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Execução + HIPERPERSONALIZAÇÃO\n// ADAPTADO PARA WORKFLOW GHL\n// Referências: $('Info') para dados do webhook, $input para dados do agente\n\nconst webhook = $('Info').first().json;  // ← ALTERADO de $('Extrair Dados do Webhook')\nconst agente = $input.first().json;\n\n// ============================================\n// DATABASES DE HIPERPERSONALIZAÇÃO (INLINE)\n// ============================================\n\nconst DDD_DATABASE = {\n  '11': { cidade: 'São Paulo', estado: 'SP', cultura: 'objetiva', expressoes: ['mano', 'firmeza'], ritmo: 'acelerado', formalidade: 'baixa' },\n  '21': { cidade: 'Rio de Janeiro', estado: 'RJ', cultura: 'descontraída', expressoes: ['cara', 'beleza', 'tranquilo'], ritmo: 'moderado', formalidade: 'baixa' },\n  '31': { cidade: 'Belo Horizonte', estado: 'MG', cultura: 'acolhedora', expressoes: ['uai', 'sô', 'trem'], ritmo: 'tranquilo', formalidade: 'média' },\n  '41': { cidade: 'Curitiba', estado: 'PR', cultura: 'formal', expressoes: ['bah', 'tchê'], ritmo: 'organizado', formalidade: 'alta' },\n  '51': { cidade: 'Porto Alegre', estado: 'RS', cultura: 'direta', expressoes: ['bah', 'tchê', 'guri'], ritmo: 'intenso', formalidade: 'média' },\n  '61': { cidade: 'Brasília', estado: 'DF', cultura: 'institucional', expressoes: ['véi'], ritmo: 'burocrático', formalidade: 'alta' },\n  '71': { cidade: 'Salvador', estado: 'BA', cultura: 'calorosa', expressoes: ['meu rei', 'oxe', 'é massa'], ritmo: 'relaxado', formalidade: 'baixa' },\n  '81': { cidade: 'Recife', estado: 'PE', cultura: 'acolhedora', expressoes: ['visse', 'oxente', 'arretado'], ritmo: 'moderado', formalidade: 'média' },\n  '85': { cidade: 'Fortaleza', estado: 'CE', cultura: 'hospitaleira', expressoes: ['macho', 'é bom demais'], ritmo: 'tranquilo', formalidade: 'baixa' },\n  'default': { cidade: 'Brasil', estado: 'BR', cultura: 'neutra', expressoes: [], ritmo: 'moderado', formalidade: 'média' }\n};\n\nconst SETOR_DATABASE = {\n  'saude': { analogias: ['diagnóstico', 'tratamento', 'prevenção'], linguagem: ['paciente', 'consulta', 'procedimento'], tom: 'consultivo e empático' },\n  'odontologia': { analogias: ['sorriso', 'saúde bucal', 'estética'], linguagem: ['paciente', 'avaliação', 'tratamento'], tom: 'acolhedor e educativo' },\n  'juridico': { analogias: ['processo', 'defesa', 'estratégia'], linguagem: ['cliente', 'caso', 'audiência'], tom: 'formal e confiável' },\n  'imobiliario': { analogias: ['investimento', 'patrimônio', 'valorização'], linguagem: ['cliente', 'imóvel', 'visita'], tom: 'consultivo e aspiracional' },\n  'tech': { analogias: ['deploy', 'sprint', 'escalar', 'automatizar'], linguagem: ['usuário', 'plataforma', 'feature'], tom: 'técnico mas acessível' },\n  'educacao': { analogias: ['aprendizado', 'evolução', 'capacitação'], linguagem: ['aluno', 'curso', 'matrícula'], tom: 'motivacional e educativo' },\n  'fitness': { analogias: ['treino', 'evolução', 'resultado', 'transformação'], linguagem: ['aluno', 'treino', 'plano'], tom: 'motivacional e energético' },\n  'estetica': { analogias: ['transformação', 'autoestima', 'cuidado'], linguagem: ['cliente', 'procedimento', 'sessão'], tom: 'acolhedor e aspiracional' },\n  'contabilidade': { analogias: ['balanço', 'compliance', 'economia tributária'], linguagem: ['cliente', 'empresa', 'planejamento'], tom: 'técnico e confiável' },\n  'varejo': { analogias: ['vendas', 'estoque', 'conversão'], linguagem: ['cliente', 'produto', 'promoção'], tom: 'amigável e promocional' },\n  'default': { analogias: ['resultado', 'solução', 'parceria'], linguagem: ['cliente', 'serviço', 'solução'], tom: 'consultivo e profissional' }\n};\n\nconst PORTE_DATABASE = {\n  'micro': { caracteristicas: ['dono faz tudo', 'decisão rápida'], abordagem: 'direta ao ponto, foco em ROI imediato', gatilhos: ['economia de tempo', 'simplicidade'] },\n  'pequena': { caracteristicas: ['estrutura básica', 'crescimento'], abordagem: 'consultiva, mostrar como escalar', gatilhos: ['crescimento', 'profissionalização'] },\n  'media': { caracteristicas: ['processos definidos', 'hierarquia'], abordagem: 'formal, apresentar business case', gatilhos: ['eficiência', 'compliance'] },\n  'grande': { caracteristicas: ['burocracia', 'múltiplos decisores'], abordagem: 'institucional, foco em case', gatilhos: ['inovação', 'diferencial competitivo'] },\n  'default': { caracteristicas: ['descobrir durante conversa'], abordagem: 'descoberta consultiva', gatilhos: ['resultado', 'solução'] }\n};\n\nconst CARGO_DATABASE = {\n  'ceo': { interesses: ['visão estratégica', 'ROI', 'crescimento'], abordagem: 'objetiva, big picture, números de impacto', decisor: true },\n  'diretor': { interesses: ['eficiência', 'metas', 'equipe'], abordagem: 'dados e métricas, impacto na área', decisor: true },\n  'gerente': { interesses: ['operação', 'equipe', 'ferramentas'], abordagem: 'prática, como facilita o dia a dia', decisor: 'influenciador' },\n  'coordenador': { interesses: ['execução', 'ferramentas', 'produtividade'], abordagem: 'operacional, demonstração prática', decisor: 'influenciador' },\n  'socio': { interesses: ['lucro', 'crescimento', 'tempo livre'], abordagem: 'consultiva, parceria de longo prazo', decisor: true },\n  'autonomo': { interesses: ['mais clientes', 'menos trabalho operacional'], abordagem: 'direta, foco em ganho pessoal', decisor: true },\n  'default': { interesses: ['descobrir durante conversa'], abordagem: 'descoberta consultiva', decisor: 'descobrir' }\n};\n\n// ============================================\n// PARSE CONFIGS DO AGENTE\n// ============================================\n\nlet toolsConfig = {};\nif (typeof agente.tools_config === 'string') {\n  try { toolsConfig = JSON.parse(agente.tools_config); } catch (e) { toolsConfig = {}; }\n} else { toolsConfig = agente.tools_config || {}; }\n\nlet businessConfig = {};\nif (typeof agente.business_config === 'string') {\n  try { businessConfig = JSON.parse(agente.business_config); } catch (e) { businessConfig = {}; }\n} else { businessConfig = agente.business_config || {}; }\n\nlet complianceRules = {};\nif (typeof agente.compliance_rules === 'string') {\n  try { complianceRules = JSON.parse(agente.compliance_rules); } catch (e) { complianceRules = {}; }\n} else { complianceRules = agente.compliance_rules || {}; }\n\nlet personalityConfig = {};\nif (typeof agente.personality_config === 'string') {\n  try { personalityConfig = JSON.parse(agente.personality_config); } catch (e) { personalityConfig = {}; }\n} else { personalityConfig = agente.personality_config || {}; }\n\nlet hyperpersonalization = {};\nif (typeof agente.hyperpersonalization === 'string') {\n  try { hyperpersonalization = JSON.parse(agente.hyperpersonalization); } catch (e) { hyperpersonalization = {}; }\n} else { hyperpersonalization = agente.hyperpersonalization || toolsConfig.hyperpersonalization || {}; }\n\n// ============================================\n// MOTOR DE HIPERPERSONALIZAÇÃO\n// ============================================\n\nfunction gerarContextoHiperpersonalizado(hp, businessCtx) {\n  const ddd = hp.ddd || 'default';\n  const setor = hp.setor || businessCtx?.setor || businessCtx?.tipo_negocio?.toLowerCase() || 'default';\n  const porte = hp.porte || 'default';\n  const cargo = hp.cargo_decisor || 'default';\n  \n  const dddInfo = DDD_DATABASE[ddd] || DDD_DATABASE['default'];\n  const setorInfo = SETOR_DATABASE[setor] || SETOR_DATABASE['default'];\n  const porteInfo = PORTE_DATABASE[porte] || PORTE_DATABASE['default'];\n  const cargoInfo = CARGO_DATABASE[cargo] || CARGO_DATABASE['default'];\n  \n  let contextoHiper = `## HIPERPERSONALIZAÇÃO ATIVA\\n\\n`;\n  \n  // Contexto Geográfico\n  if (ddd !== 'default') {\n    contextoHiper += `### Contexto Regional (${dddInfo.cidade}/${dddInfo.estado})\\n`;\n    contextoHiper += `- Cultura: ${dddInfo.cultura}\\n`;\n    contextoHiper += `- Ritmo: ${dddInfo.ritmo}\\n`;\n    contextoHiper += `- Formalidade: ${dddInfo.formalidade}\\n`;\n    if (dddInfo.expressoes.length > 0) {\n      contextoHiper += `- Expressões regionais permitidas: ${dddInfo.expressoes.join(', ')}\\n`;\n    }\n    contextoHiper += `\\n`;\n  }\n  \n  // Contexto de Negócio\n  if (setor !== 'default') {\n    contextoHiper += `### Contexto do Setor (${setor})\\n`;\n    contextoHiper += `- Use analogias: ${setorInfo.analogias.join(', ')}\\n`;\n    contextoHiper += `- Linguagem do setor: ${setorInfo.linguagem.join(', ')}\\n`;\n    contextoHiper += `- Tom recomendado: ${setorInfo.tom}\\n\\n`;\n  }\n  \n  // Contexto de Porte\n  if (porte !== 'default') {\n    contextoHiper += `### Contexto de Porte (${porte})\\n`;\n    contextoHiper += `- Características: ${porteInfo.caracteristicas.join(', ')}\\n`;\n    contextoHiper += `- Abordagem: ${porteInfo.abordagem}\\n`;\n    contextoHiper += `- Gatilhos eficazes: ${porteInfo.gatilhos.join(', ')}\\n\\n`;\n  }\n  \n  // Contexto de Cargo\n  if (cargo !== 'default') {\n    contextoHiper += `### Contexto do Decisor (${cargo})\\n`;\n    contextoHiper += `- Interesses: ${cargoInfo.interesses.join(', ')}\\n`;\n    contextoHiper += `- Abordagem: ${cargoInfo.abordagem}\\n`;\n    contextoHiper += `- É decisor: ${cargoInfo.decisor}\\n\\n`;\n  }\n  \n  // Se não tiver nenhuma hiperpersonalização, retornar vazio\n  if (contextoHiper === `## HIPERPERSONALIZAÇÃO ATIVA\\n\\n`) {\n    return '';\n  }\n  \n  return contextoHiper;\n}\n\nconst contextoHiperpersonalizado = gerarContextoHiperpersonalizado(hyperpersonalization, businessConfig);\n\n// ============================================\n// IDENTIFICAR CONTEXTO (MODO) - LÊ DO CAMPO agente_ia DO GHL\n// ============================================\n\nconst modosIdentificados = toolsConfig.modos_identificados || toolsConfig.modos_ativos || [];\nconst promptsPorModo = toolsConfig.prompts_por_modo || {};\n\n// Ler o campo agente_ia que vem do GHL (definido pelo workflow de automação do GHL)\nconst agenteIaDoGHL = webhook.agente_ia || webhook.customFields?.agente_ia || webhook.custom_fields?.agente_ia || '';\n\n// Usar o modo do GHL se existir prompt para ele, senão fallback\nlet contexto = agenteIaDoGHL;\n\n// Validar se existe prompt para este modo\nif (!contexto || !promptsPorModo[contexto]) {\n  // Se não existe prompt para o modo do GHL, tentar first_contact\n  if (promptsPorModo['first_contact']) {\n    contexto = 'first_contact';\n  } else {\n    // Último fallback: primeiro modo disponível\n    const primeiroModoDisponivel = Object.keys(promptsPorModo)[0];\n    if (primeiroModoDisponivel) {\n      contexto = primeiroModoDisponivel;\n    } else {\n      contexto = 'first_contact';\n    }\n  }\n}\n\n// Pegar o prompt dinâmico do modo atual\nconst promptDinamico = promptsPorModo[contexto] || '';\n\nreturn [{\n  json: {\n    // Dados do webhook GHL\n    ...webhook,\n    // Dados do agente\n    agent_id: agente.id,\n    agent_name: agente.agent_name,\n    system_prompt: agente.system_prompt,\n    location_api_key: agente.location_api_key,\n    // Configs parseadas\n    business_context: businessConfig,\n    compliance_rules: complianceRules,\n    personality_config: personalityConfig,\n    hyperpersonalization: hyperpersonalization,\n    // Outputs para o AI Agent\n    contexto_hiperpersonalizado: contextoHiperpersonalizado,\n    prompt_dinamico: promptDinamico,\n    modo_atual: contexto,\n    modo_solicitado_ghl: agenteIaDoGHL,  // ← Log do modo que veio do GHL\n    modos_identificados: modosIdentificados,\n    prompts_por_modo: promptsPorModo,\n    is_primeira_mensagem: webhook.is_primeira_mensagem || false\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5520,
        384
      ],
      "id": "a8c6ff15-2dbf-44d3-b217-ea8b38592efa",
      "name": "Preparar Execução + Identificar Contexto"
    }
  ]
}
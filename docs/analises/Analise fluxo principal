Deixa eu ver as partes que foram truncadas para ter a vis√£o completa:Perfeito! Agora tenho a vis√£o completa. Aqui est√° a **An√°lise Geral do Fluxo SDR - GHL - Mottivme - EUA**:

---

# üìä MAPA COMPLETO DO FLUXO SDR

## üèóÔ∏è ARQUITETURA GERAL

```
ENTRADA ‚Üí NORMALIZA√á√ÉO ‚Üí CONTROLE ‚Üí PROCESSAMENTO ‚Üí AI ‚Üí ENVIO ‚Üí RASTREIO
```

---

## üìç FASE 1: ENTRADA E NORMALIZA√á√ÉO

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Mensagem recebida** | Webhook POST que recebe eventos do GHL |
| **Contexto UTM** | Detecta tipo de lead (CARREIRA/CONSULTORIA) via UTM |
| **Normalizar Nome1** | Limpa e formata nome do lead (remove n√∫meros, capitaliza) |
| **Normalizar Dados1** | Define `objetivo_do_lead`, `agente_ia`, `ativar_ia` baseado em tags/UTM |
| **Execution Data5** | Registra metadados da execu√ß√£o |
| **Code1** | Processamento adicional |
| **Classificar Tipo Mensagem** | Identifica se √© texto/√°udio/imagem |
| **Info** | Node SET principal com ~50 campos normalizados |

---

## üìç FASE 2: CONTROLES E GATES

| N√≥ | Fun√ß√£o |
|-----|--------|
| **IA Ativa?** | Gate: s√≥ passa se `ativar_ia=sim` OU tag `assistente-admin` |
| **Tipo de mensagem** | Switch 6 sa√≠das: texto, primeira_msg, enfileirar, imagem, √°udio, outro |
| **Conversa Ativa** | Consulta `n8n_active_conversation` no Postgres |
| **A√ß√£o Planejada** | Switch 3 sa√≠das: Iniciar Conversa / Ignorar / Aguardar |
| **Permitido AI?** | Valida se pode processar (n√£o est√° em disparo, msg != "ok") |

---

## üìç FASE 3: PROCESSAMENTO DE M√çDIA

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Download √°udio** | Baixa arquivo de √°udio |
| **Extract from File** | Extrai bin√°rio |
| **Convert to File** | Converte para formato process√°vel |
| **Transcrever audio** | OpenAI Whisper (PT) |
| **Analyze image** | Processa imagens recebidas |

---

## üìç FASE 4: FILA E CONCORR√äNCIA

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Enfileirar mensagem.** | INSERT em `ops_fila_mensagens` |
| **Esperar** | Wait node |
| **Buscar mensagens** | Recupera fila |
| **Form Mensagem** | Compara `last_db_message` vs `current_message` |
| **Mensagem encavalada?** | Detecta se lead mandou msg enquanto IA pensava |
| **Salvar Espera** | UPSERT com `waiting_process_id` + `retries` |

---

## üìç FASE 5: MEM√ìRIA E HIST√ìRICO

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Salvar Inicio IA** | UPSERT em `n8n_active_conversation` |
| **Mensagem anteriores** | SELECT hist√≥rico de `n8n_historico_mensagens` |
| **Preparar Mensagem** | Formata hist√≥rico como string |
| **Memoria Lead** | INSERT mensagem human |
| **Memoria IA** | INSERT resposta IA |
| **Deduplica Mensagens** | Remove duplicatas |
| **Set mensagens** | Consolida `mensagem`, `output_preview`, `mensagens_antigas` |

---

## üìç FASE 6: SELE√á√ÉO DE AGENTE

| N√≥ | Rotas |
|-----|-------|
| **Tipo de IA** | `Milton` / `Padr√£o` / `Agente Versionado` |
| **Switch2** | `followuper` / `sdrcarreira` / `sdrconsultoria` |
| **Switch** | `followuper` / `sdrcarreira` / `reagendar` / `concierge` / `customer_success` |

---

## üìç FASE 7: PROMPTS ESPECIALIZADOS

| Prompt | Uso |
|--------|-----|
| **Prompt F2 - Funil Tr√°fego Carreira** | Lead novo de tr√°fego ‚Üí qualifica work permit ‚Üí agenda |
| **Prompt F3 - followuper** | Leads frios que j√° receberam abertura ‚Üí reativa |
| **Prompt Reagendamento - No Show** | Lead deu no-show ‚Üí recupera emp√°tico |
| **Prompt Consultoria** | Sem work permit ‚Üí consultoria financeira |
| **Concierge** | Suporte geral |
| **Customer Success** | P√≥s-venda |

---

## üìç FASE 8: AI AGENTS

| N√≥ | Config |
|-----|--------|
| **SDR** | Agent LangChain + Gemini + GPT-5 fallback |
| **SDR Milton** | Agent customizado (disabled) |
| **AI Agent - Modular** | Agent versionado via banco |

**Tools Conectadas:**
- `Think1` - Racioc√≠nio interno
- `Busca_disponibilidade` - API GHL calend√°rio
- `Agendar_reuniao` - Criar agendamento
- `Atualizar_work_permit` - Salvar work permit
- `Atualizar_estado` - Salvar estado
- `Atualizar_profissao` - Salvar profiss√£o
- `Adicionar_tag_perdido` - Desqualificar
- `Busca_historias` - Hist√≥rias do respons√°vel

---

## üìç FASE 9: P√ìS-PROCESSAMENTO

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Tudo certo?3/4** | Valida output (n√£o cont√©m `<ctrl`, n√£o vazio) |
| **Filter** | `output.length > 2` |
| **Code in JavaScript2** | Estima tokens |
| **Parser Chain** | LLM formata msg para WhatsApp/IG (remove #, **, quebras) |
| **Structured Output Parser** | JSON `{messages: [...]}` |
| **If1** | Valida que n√£o cont√©m "parsed", "split", "properties", "type" |

---

## üìç FASE 10: ENVIO

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Canal** | Switch WhatsApp vs Instagram |
| **Whatsapp** | POST `/conversations/messages` type=SMS |
| **Instagram** | POST `/conversations/messages` type=IG |
| **Loop Over Items3** | Split em batches |
| **1.5s** | Wait entre msgs |
| **Execution Data1** | Salva `a_lead_response` |
| **Memoria IA** | Persiste resposta no hist√≥rico |

---

## üìç FASE 11: RASTREIO E CUSTO

| N√≥ | Fun√ß√£o |
|-----|--------|
| **Calcular Custo LLM** | Estima tokens Gemini 2.5 Pro |
| **Call Track AI Cost** | Workflow externo para registrar custo |
| **Postgres** (execution_metrics) | INSERT m√©tricas de execu√ß√£o |

---

## üìç FASE AUXILIAR: OBJETIVO INDEFINIDO

| N√≥ | Fun√ß√£o |
|-----|--------|
| **1Ô∏è‚É£ Listar campos customizados** | GET custom fields do GHL |
| **2Ô∏è‚É£ Buscar Conversa** | GET conversation |
| **3Ô∏è‚É£ Detectar Objetivo** | LLM classifica carreira/consultoria/indefinido |
| **4Ô∏è‚É£ Switch Objetivo** | Roteia |
| **5Ô∏è‚É£ Atualizar ‚Üí Carreira/Consultoria** | PUT contact customFields |
| **5Ô∏è‚É£ Perguntar Objetivo** | Envia mensagem perguntando objetivo |

---

## üîÑ TABELAS POSTGRES

| Tabela | Uso |
|--------|-----|
| `n8n_active_conversation` | Controle de concorr√™ncia |
| `n8n_historico_mensagens` | Mem√≥ria conversacional |
| `ops_fila_mensagens` | Fila de mensagens pendentes |
| `execution_metrics` | Telemetria |

---

Pronto! Tenho a **vis√£o 360¬∞** do fluxo. Pode contextualizar agora! üéØ
{
  "name": "Feedback Loop Oportunidade",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ghl-opp-closed",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [-200, 300],
      "id": "webhook-opp-closed",
      "name": "Webhook - Oportunidade Fechada",
      "webhookId": "ghl-opp-closed",
      "notes": "Recebe webhook do GHL quando oportunidade muda para GANHO ou PERDIDO"
    },
    {
      "parameters": {
        "jsCode": "// Processar webhook do GHL\nconst payload = $input.first().json.body || $input.first().json;\n\n// Extrair dados relevantes\nconst contactId = payload.contact_id || payload.contactId;\nconst opportunityId = payload.opportunity_id || payload.opportunityId;\nconst pipelineStage = payload.pipeline_stage || payload.stage;\nconst status = payload.status; // won, lost\nconst monetaryValue = payload.monetary_value || payload.value || 0;\nconst lostReason = payload.lost_reason || payload.lostReason || null;\n\n// Determinar resultado\nlet resultado = 'pendente';\nif (status === 'won' || pipelineStage?.toLowerCase().includes('ganho') || pipelineStage?.toLowerCase().includes('won')) {\n  resultado = 'ganho';\n} else if (status === 'lost' || pipelineStage?.toLowerCase().includes('perdido') || pipelineStage?.toLowerCase().includes('lost')) {\n  resultado = 'perdido';\n}\n\nreturn [{\n  json: {\n    webhook_data: payload,\n    parsed: {\n      contact_id: contactId,\n      opportunity_id: opportunityId,\n      resultado: resultado,\n      valor: monetaryValue,\n      motivo_perda: lostReason\n    },\n    config: {\n      location_id: 'cd1uyzpJox6XPt4Vct8Y',\n      ghl_api_key: 'pit-fe627027-b9cb-4ea3-aaa4-149459e66a03'\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [40, 300],
      "id": "processar-webhook",
      "name": "Processar Webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "check-resultado",
              "leftValue": "={{ $json.parsed.resultado }}",
              "rightValue": "pendente",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [280, 300],
      "id": "check-resultado-valido",
      "name": "Resultado Valido?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  cr.id as call_recording_id,\n  cr.tipo,\n  cr.analise_json,\n  cr.created_at as call_date,\n  c.id as client_id,\n  c.nome as client_nome\nFROM call_recordings cr\nJOIN clients c ON c.id = cr.client_id\nWHERE c.ghl_contact_id = '{{ $json.parsed.contact_id }}'\n  AND cr.tipo = 'diagnostico'\nORDER BY cr.created_at DESC\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [520, 200],
      "id": "buscar-call-diagnostico",
      "name": "Buscar Call de Diagnostico",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "check-call-existe",
              "leftValue": "={{ $json.call_recording_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [760, 200],
      "id": "check-call-existe",
      "name": "Call Existe?"
    },
    {
      "parameters": {
        "jsCode": "// Consolidar dados para analise de calibracao\nconst dadosOpp = $('Processar Webhook').first().json;\nconst dadosCall = $input.first().json;\n\n// Extrair analise da IA (se existir)\nlet analiseIA = null;\nlet probabilidadePrevista = null;\nlet statusPrevisto = null;\n\nif (dadosCall.analise_json) {\n  try {\n    analiseIA = typeof dadosCall.analise_json === 'string' \n      ? JSON.parse(dadosCall.analise_json) \n      : dadosCall.analise_json;\n    \n    probabilidadePrevista = analiseIA.analise_geral?.probabilidade_fechamento || null;\n    statusPrevisto = analiseIA.analise_geral?.status || null;\n  } catch (e) {\n    // Falha ao parsear\n  }\n}\n\n// Calcular se previsao foi correta\nconst resultadoReal = dadosOpp.parsed.resultado;\nlet previsaoCorreta = null;\nlet desvio = null;\n\nif (probabilidadePrevista !== null) {\n  if (resultadoReal === 'ganho') {\n    previsaoCorreta = probabilidadePrevista >= 50;\n    desvio = 100 - probabilidadePrevista; // Quanto errou (deveria ser 100%)\n  } else {\n    previsaoCorreta = probabilidadePrevista < 50;\n    desvio = probabilidadePrevista; // Quanto errou (deveria ser 0%)\n  }\n}\n\nreturn [{\n  json: {\n    ...dadosOpp,\n    call_data: {\n      id: dadosCall.call_recording_id,\n      tipo: dadosCall.tipo,\n      data: dadosCall.call_date,\n      client_id: dadosCall.client_id,\n      client_nome: dadosCall.client_nome\n    },\n    previsao_ia: {\n      probabilidade: probabilidadePrevista,\n      status: statusPrevisto,\n      analise_completa: analiseIA\n    },\n    calibracao: {\n      resultado_real: resultadoReal,\n      previsao_correta: previsaoCorreta,\n      desvio_percentual: desvio\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 100],
      "id": "consolidar-para-calibracao",
      "name": "Consolidar para Calibracao"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE call_recordings\nSET analise_json = analise_json || $1::jsonb\nWHERE id = '{{ $json.call_data.id }}'\nRETURNING id, analise_json;",
        "options": {
          "queryParams": "={{ [\n  JSON.stringify({\n    feedback_loop: {\n      resultado_real: $json.calibracao.resultado_real,\n      valor_oportunidade: $json.parsed.valor,\n      motivo_perda: $json.parsed.motivo_perda,\n      previsao_correta: $json.calibracao.previsao_correta,\n      desvio_percentual: $json.calibracao.desvio_percentual,\n      data_feedback: new Date().toISOString()\n    }\n  })\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1240, 100],
      "id": "atualizar-resultado-real",
      "name": "Atualizar Resultado Real no Supabase",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "check-perdido",
              "leftValue": "={{ $json.calibracao.resultado_real }}",
              "rightValue": "perdido",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1480, 100],
      "id": "check-foi-perdido",
      "name": "Foi Perdido?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO churn_reasons (\n  client_id,\n  call_recording_id,\n  motivo_principal,\n  valor_contrato,\n  recuperavel\n) VALUES (\n  '{{ $json.call_data.client_id }}',\n  '{{ $json.call_data.id }}',\n  '{{ $json.parsed.motivo_perda || \"Nao informado\" }}',\n  {{ $json.parsed.valor || 0 }},\n  TRUE\n)\nRETURNING id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1720, 0],
      "id": "registrar-perda",
      "name": "Registrar em churn_reasons",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer pit-fe627027-b9cb-4ea3-aaa4-149459e66a03"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"WhatsApp\",\n  \"contactId\": \"Ql1qBRN8GTemuG0BlM0F\",\n  \"message\": \"ðŸ“Š *FEEDBACK LOOP - CALIBRACAO IA*\\n\\nðŸ“‹ *Cliente:* {{ $json.call_data.client_nome }}\\nðŸ’° *Valor:* R$ {{ $json.parsed.valor || 0 }}\\n\\nðŸŽ¯ *Resultado:* {{ $json.calibracao.resultado_real === 'ganho' ? 'âœ… GANHO' : 'âŒ PERDIDO' }}\\n\\nðŸ¤– *Previsao IA:*\\n- Probabilidade: {{ $json.previsao_ia.probabilidade || 'N/A' }}%\\n- Status: {{ $json.previsao_ia.status || 'N/A' }}\\n\\nðŸ“ˆ *Calibracao:*\\n- Previsao correta? {{ $json.calibracao.previsao_correta === true ? 'âœ… SIM' : $json.calibracao.previsao_correta === false ? 'âŒ NAO' : 'âš ï¸ N/A' }}\\n- Desvio: {{ $json.calibracao.desvio_percentual !== null ? $json.calibracao.desvio_percentual + '%' : 'N/A' }}\\n\\n{{ $json.calibracao.resultado_real === 'perdido' && $json.parsed.motivo_perda ? '\\nðŸ’¬ *Motivo da Perda:* ' + $json.parsed.motivo_perda : '' }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1960, 100],
      "id": "notificar-feedback",
      "name": "Notificar CS - Feedback Loop"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: true,\n  message: 'Feedback loop processado',\n  resultado: $json.calibracao.resultado_real,\n  previsao_correta: $json.calibracao.previsao_correta\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2200, 100],
      "id": "webhook-response-success",
      "name": "Webhook Response Success"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: false,\n  error: 'Resultado invalido ou nao identificado',\n  received: $json\n}) }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [520, 400],
      "id": "webhook-response-invalid",
      "name": "Webhook Response Invalid"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: false,\n  error: 'Call de diagnostico nao encontrada para este contato',\n  contact_id: $('Processar Webhook').first().json.parsed.contact_id\n}) }}",
        "options": {
          "responseCode": 404
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1000, 300],
      "id": "webhook-response-no-call",
      "name": "Webhook Response No Call"
    },
    {
      "parameters": {
        "content": "## Feedback Loop Oportunidade\n\n**Funcao**: Quando uma oportunidade e marcada como GANHA ou PERDIDA no GHL, atualiza o resultado_real na call de diagnostico original para calibrar as previsoes da IA.\n\n### Fluxo:\n1. Recebe webhook do GHL (opp_won ou opp_lost)\n2. Busca call de diagnostico do contato no Supabase\n3. Compara previsao da IA com resultado real\n4. Atualiza analise_json com feedback_loop\n5. Se perdido, registra em churn_reasons\n6. Notifica CS com metricas de calibracao\n\n### Configurar no GHL:\n1. Settings > Workflows > Triggers\n2. Opportunity Status Changed\n3. Webhook URL: https://n8n.mottivme.com.br/webhook/ghl-opp-closed\n\n### Metricas Geradas:\n- Previsao correta? (true/false)\n- Desvio percentual\n- Motivo de perda (se aplicavel)\n\n### Status: DRAFT (v1.0)",
        "height": 480,
        "width": 360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-200, -180],
      "id": "sticky-instrucoes",
      "name": "Instrucoes"
    },
    {
      "parameters": {
        "content": "## Para Analise Futura\n\n### Query para Dashboard de Calibracao:\n```sql\nSELECT \n  COUNT(*) as total,\n  SUM(CASE WHEN (analise_json->'feedback_loop'->>'previsao_correta')::boolean THEN 1 ELSE 0 END) as corretas,\n  AVG((analise_json->'feedback_loop'->>'desvio_percentual')::numeric) as desvio_medio\nFROM call_recordings\nWHERE analise_json->'feedback_loop' IS NOT NULL;\n```\n\n### Metricas para Acompanhar:\n- Taxa de acerto da IA\n- Desvio medio das previsoes\n- Motivos de perda mais comuns",
        "height": 280,
        "width": 340,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [2200, -180],
      "id": "sticky-analise",
      "name": "Analise Futura"
    }
  ],
  "connections": {
    "Webhook - Oportunidade Fechada": {
      "main": [
        [
          {
            "node": "Processar Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Webhook": {
      "main": [
        [
          {
            "node": "Resultado Valido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resultado Valido?": {
      "main": [
        [
          {
            "node": "Buscar Call de Diagnostico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Webhook Response Invalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Call de Diagnostico": {
      "main": [
        [
          {
            "node": "Call Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Existe?": {
      "main": [
        [
          {
            "node": "Consolidar para Calibracao",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Webhook Response No Call",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidar para Calibracao": {
      "main": [
        [
          {
            "node": "Atualizar Resultado Real no Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Resultado Real no Supabase": {
      "main": [
        [
          {
            "node": "Foi Perdido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Foi Perdido?": {
      "main": [
        [
          {
            "node": "Registrar em churn_reasons",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notificar CS - Feedback Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar em churn_reasons": {
      "main": [
        [
          {
            "node": "Notificar CS - Feedback Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notificar CS - Feedback Loop": {
      "main": [
        [
          {
            "node": "Webhook Response Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "pinData": {},
  "versionId": "1.0.0",
  "triggerCount": 1,
  "tags": [
    {
      "name": "AI Factory",
      "createdAt": "2025-12-17T00:00:00.000Z",
      "updatedAt": "2025-12-17T00:00:00.000Z"
    },
    {
      "name": "Feedback Loop",
      "createdAt": "2025-12-17T00:00:00.000Z",
      "updatedAt": "2025-12-17T00:00:00.000Z"
    }
  ]
}
